<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › dc395x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dc395x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * dc395x.c</span>
<span class="cm"> *</span>
<span class="cm"> * Device Driver for Tekram DC395(U/UW/F), DC315(U)</span>
<span class="cm"> * PCI SCSI Bus Master Host Adapter</span>
<span class="cm"> * (SCSI chip set used Tekram ASIC TRM-S1040)</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *  C.L. Huang &lt;ching@tekram.com.tw&gt;</span>
<span class="cm"> *  Erich Chen &lt;erich@tekram.com.tw&gt;</span>
<span class="cm"> *  (C) Copyright 1995-1999 Tekram Technology Co., Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> *  Kurt Garloff &lt;garloff@suse.de&gt;</span>
<span class="cm"> *  (C) 1999-2000 Kurt Garloff</span>
<span class="cm"> *</span>
<span class="cm"> *  Oliver Neukum &lt;oliver@neukum.name&gt;</span>
<span class="cm"> *  Ali Akcaagac &lt;aliakc@web.de&gt;</span>
<span class="cm"> *  Jamie Lenehan &lt;lenehan@twibble.org&gt;</span>
<span class="cm"> *  (C) 2003</span>
<span class="cm"> *</span>
<span class="cm"> * License: GNU GPL</span>
<span class="cm"> *</span>
<span class="cm"> *************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * 3. The name of the author may not be used to endorse or promote products</span>
<span class="cm"> *    derived from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&#39;&#39; AND ANY EXPRESS OR</span>
<span class="cm"> * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
<span class="cm"> * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<span class="cm"> * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="cm"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm"> * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> ************************************************************************</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;	</span><span class="cm">/* needed for scsicam_bios_param */</span><span class="cp"></span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &quot;dc395x.h&quot;</span>

<span class="cp">#define DC395X_NAME	&quot;dc395x&quot;</span>
<span class="cp">#define DC395X_BANNER	&quot;Tekram DC395(U/UW/F), DC315(U) - ASIC TRM-S1040&quot;</span>
<span class="cp">#define DC395X_VERSION	&quot;v2.05, 2004/03/08&quot;</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">                                  Features</span>
<span class="cm"> ---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Set to disable parts of the driver</span>
<span class="cm"> */</span>
<span class="cm">/*#define DC395x_NO_DISCONNECT*/</span>
<span class="cm">/*#define DC395x_NO_TAGQ*/</span>
<span class="cm">/*#define DC395x_NO_SYNC*/</span>
<span class="cm">/*#define DC395x_NO_WIDE*/</span>

<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">                                  Debugging</span>
<span class="cm"> ---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Types of debugging that can be enabled and disabled</span>
<span class="cm"> */</span>
<span class="cp">#define DBG_KG		0x0001</span>
<span class="cp">#define DBG_0		0x0002</span>
<span class="cp">#define DBG_1		0x0004</span>
<span class="cp">#define DBG_SG		0x0020</span>
<span class="cp">#define DBG_FIFO	0x0040</span>
<span class="cp">#define DBG_PIO		0x0080</span>


<span class="cm">/*</span>
<span class="cm"> * Set set of things to output debugging for.</span>
<span class="cm"> * Undefine to remove all debugging</span>
<span class="cm"> */</span>
<span class="cm">/*#define DEBUG_MASK (DBG_0|DBG_1|DBG_SG|DBG_FIFO|DBG_PIO)*/</span>
<span class="cm">/*#define  DEBUG_MASK	DBG_0*/</span>


<span class="cm">/*</span>
<span class="cm"> * Output a kernel mesage at the specified level and append the</span>
<span class="cm"> * driver name and a &quot;: &quot; to the start of the message</span>
<span class="cm"> */</span>
<span class="cp">#define dprintkl(level, format, arg...)  \</span>
<span class="cp">    printk(level DC395X_NAME &quot;: &quot; format , ## arg)</span>


<span class="cp">#ifdef DEBUG_MASK</span>
<span class="cm">/*</span>
<span class="cm"> * print a debug message - this is formated with KERN_DEBUG, then the</span>
<span class="cm"> * driver name followed by a &quot;: &quot; and then the message is output. </span>
<span class="cm"> * This also checks that the specified debug level is enabled before</span>
<span class="cm"> * outputing the message</span>
<span class="cm"> */</span>
<span class="cp">#define dprintkdbg(type, format, arg...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if ((type) &amp; (DEBUG_MASK)) \</span>
<span class="cp">			dprintkl(KERN_DEBUG , format , ## arg); \</span>
<span class="cp">	} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * Check if the specified type of debugging is enabled</span>
<span class="cm"> */</span>
<span class="cp">#define debug_enabled(type)	((DEBUG_MASK) &amp; (type))</span>

<span class="cp">#else</span>
<span class="cm">/*</span>
<span class="cm"> * No debugging. Do nothing</span>
<span class="cm"> */</span>
<span class="cp">#define dprintkdbg(type, format, arg...) \</span>
<span class="cp">	do {} while (0)</span>
<span class="cp">#define debug_enabled(type)	(0)</span>

<span class="cp">#endif</span>


<span class="cp">#ifndef PCI_VENDOR_ID_TEKRAM</span>
<span class="cp">#define PCI_VENDOR_ID_TEKRAM                    0x1DE1	</span><span class="cm">/* Vendor ID    */</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_TEKRAM_TRMS1040</span>
<span class="cp">#define PCI_DEVICE_ID_TEKRAM_TRMS1040           0x0391	</span><span class="cm">/* Device ID    */</span><span class="cp"></span>
<span class="cp">#endif</span>


<span class="cp">#define DC395x_LOCK_IO(dev,flags)		spin_lock_irqsave(((struct Scsi_Host *)dev)-&gt;host_lock, flags)</span>
<span class="cp">#define DC395x_UNLOCK_IO(dev,flags)		spin_unlock_irqrestore(((struct Scsi_Host *)dev)-&gt;host_lock, flags)</span>

<span class="cp">#define DC395x_read8(acb,address)		(u8)(inb(acb-&gt;io_port_base + (address)))</span>
<span class="cp">#define DC395x_read16(acb,address)		(u16)(inw(acb-&gt;io_port_base + (address)))</span>
<span class="cp">#define DC395x_read32(acb,address)		(u32)(inl(acb-&gt;io_port_base + (address)))</span>
<span class="cp">#define DC395x_write8(acb,address,value)	outb((value), acb-&gt;io_port_base + (address))</span>
<span class="cp">#define DC395x_write16(acb,address,value)	outw((value), acb-&gt;io_port_base + (address))</span>
<span class="cp">#define DC395x_write32(acb,address,value)	outl((value), acb-&gt;io_port_base + (address))</span>

<span class="cm">/* cmd-&gt;result */</span>
<span class="cp">#define RES_TARGET		0x000000FF	</span><span class="cm">/* Target State */</span><span class="cp"></span>
<span class="cp">#define RES_TARGET_LNX  STATUS_MASK	</span><span class="cm">/* Only official ... */</span><span class="cp"></span>
<span class="cp">#define RES_ENDMSG		0x0000FF00	</span><span class="cm">/* End Message */</span><span class="cp"></span>
<span class="cp">#define RES_DID			0x00FF0000	</span><span class="cm">/* DID_ codes */</span><span class="cp"></span>
<span class="cp">#define RES_DRV			0xFF000000	</span><span class="cm">/* DRIVER_ codes */</span><span class="cp"></span>

<span class="cp">#define MK_RES(drv,did,msg,tgt) ((int)(drv)&lt;&lt;24 | (int)(did)&lt;&lt;16 | (int)(msg)&lt;&lt;8 | (int)(tgt))</span>
<span class="cp">#define MK_RES_LNX(drv,did,msg,tgt) ((int)(drv)&lt;&lt;24 | (int)(did)&lt;&lt;16 | (int)(msg)&lt;&lt;8 | (int)(tgt)&lt;&lt;1)</span>

<span class="cp">#define SET_RES_TARGET(who,tgt) { who &amp;= ~RES_TARGET; who |= (int)(tgt); }</span>
<span class="cp">#define SET_RES_TARGET_LNX(who,tgt) { who &amp;= ~RES_TARGET_LNX; who |= (int)(tgt) &lt;&lt; 1; }</span>
<span class="cp">#define SET_RES_MSG(who,msg) { who &amp;= ~RES_ENDMSG; who |= (int)(msg) &lt;&lt; 8; }</span>
<span class="cp">#define SET_RES_DID(who,did) { who &amp;= ~RES_DID; who |= (int)(did) &lt;&lt; 16; }</span>
<span class="cp">#define SET_RES_DRV(who,drv) { who &amp;= ~RES_DRV; who |= (int)(drv) &lt;&lt; 24; }</span>

<span class="cp">#define TAG_NONE 255</span>

<span class="cm">/*</span>
<span class="cm"> * srb-&gt;segement_x is the hw sg list. It is always allocated as a</span>
<span class="cm"> * DC395x_MAX_SG_LISTENTRY entries in a linear block which does not</span>
<span class="cm"> * cross a page boundy.</span>
<span class="cm"> */</span>
<span class="cp">#define SEGMENTX_LEN	(sizeof(struct SGentry)*DC395x_MAX_SG_LISTENTRY)</span>


<span class="k">struct</span> <span class="n">SGentry</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>		<span class="cm">/* bus! address */</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The SEEPROM structure for TRM_S1040 */</span>
<span class="k">struct</span> <span class="n">NVRamTarget</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">cfg0</span><span class="p">;</span>		<span class="cm">/* Target configuration byte 0  */</span>
	<span class="n">u8</span> <span class="n">period</span><span class="p">;</span>		<span class="cm">/* Target period                */</span>
	<span class="n">u8</span> <span class="n">cfg2</span><span class="p">;</span>		<span class="cm">/* Target configuration byte 2  */</span>
	<span class="n">u8</span> <span class="n">cfg3</span><span class="p">;</span>		<span class="cm">/* Target configuration byte 3  */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">NvRamType</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">sub_vendor_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* 0,1  Sub Vendor ID   */</span>
	<span class="n">u8</span> <span class="n">sub_sys_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* 2,3  Sub System ID   */</span>
	<span class="n">u8</span> <span class="n">sub_class</span><span class="p">;</span>		<span class="cm">/* 4    Sub Class       */</span>
	<span class="n">u8</span> <span class="n">vendor_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* 5,6  Vendor ID       */</span>
	<span class="n">u8</span> <span class="n">device_id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* 7,8  Device ID       */</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">;</span>		<span class="cm">/* 9    Reserved        */</span>
	<span class="k">struct</span> <span class="n">NVRamTarget</span> <span class="n">target</span><span class="p">[</span><span class="n">DC395x_MAX_SCSI_ID</span><span class="p">];</span>
						<span class="cm">/** 10,11,12,13</span>
<span class="cm">						 ** 14,15,16,17</span>
<span class="cm">						 ** ....</span>
<span class="cm">						 ** ....</span>
<span class="cm">						 ** 70,71,72,73</span>
<span class="cm">						 */</span>
	<span class="n">u8</span> <span class="n">scsi_id</span><span class="p">;</span>		<span class="cm">/* 74 Host Adapter SCSI ID      */</span>
	<span class="n">u8</span> <span class="n">channel_cfg</span><span class="p">;</span>		<span class="cm">/* 75 Channel configuration     */</span>
	<span class="n">u8</span> <span class="n">delay_time</span><span class="p">;</span>		<span class="cm">/* 76 Power on delay time       */</span>
	<span class="n">u8</span> <span class="n">max_tag</span><span class="p">;</span>		<span class="cm">/* 77 Maximum tags              */</span>
	<span class="n">u8</span> <span class="n">reserved0</span><span class="p">;</span>		<span class="cm">/* 78  */</span>
	<span class="n">u8</span> <span class="n">boot_target</span><span class="p">;</span>		<span class="cm">/* 79  */</span>
	<span class="n">u8</span> <span class="n">boot_lun</span><span class="p">;</span>		<span class="cm">/* 80  */</span>
	<span class="n">u8</span> <span class="n">reserved1</span><span class="p">;</span>		<span class="cm">/* 81  */</span>
	<span class="n">u16</span> <span class="n">reserved2</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>	<span class="cm">/* 82,..125 */</span>
	<span class="n">u16</span> <span class="n">cksum</span><span class="p">;</span>		<span class="cm">/* 126,127 */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>		<span class="cm">/* next/prev ptrs for srb lists */</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">SGentry</span> <span class="o">*</span><span class="n">segment_x</span><span class="p">;</span>	<span class="cm">/* Linear array of hw sg entries (up to 64 entries) */</span>
	<span class="n">dma_addr_t</span> <span class="n">sg_bus_addr</span><span class="p">;</span>	        <span class="cm">/* Bus address of sg list (ie, of segment_x) */</span>

	<span class="n">u8</span> <span class="n">sg_count</span><span class="p">;</span>			<span class="cm">/* No of HW sg entries for this request */</span>
	<span class="n">u8</span> <span class="n">sg_index</span><span class="p">;</span>			<span class="cm">/* Index of HW sg entry for this request */</span>
	<span class="kt">size_t</span> <span class="n">total_xfer_length</span><span class="p">;</span>	<span class="cm">/* Total number of bytes remaining to be transferred */</span>
	<span class="kt">size_t</span> <span class="n">request_length</span><span class="p">;</span>		<span class="cm">/* Total number of bytes in this request */</span>
	<span class="cm">/*</span>
<span class="cm">	 * The sense buffer handling function, request_sense, uses</span>
<span class="cm">	 * the first hw sg entry (segment_x[0]) and the transfer</span>
<span class="cm">	 * length (total_xfer_length). While doing this it stores the</span>
<span class="cm">	 * original values into the last sg hw list</span>
<span class="cm">	 * (srb-&gt;segment_x[DC395x_MAX_SG_LISTENTRY - 1] and the</span>
<span class="cm">	 * total_xfer_length in xferred. These values are restored in</span>
<span class="cm">	 * pci_unmap_srb_sense. This is the only place xferred is used.</span>
<span class="cm">	 */</span>
	<span class="kt">size_t</span> <span class="n">xferred</span><span class="p">;</span>		        <span class="cm">/* Saved copy of total_xfer_length */</span>

	<span class="n">u16</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">msgin_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">msgout_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">u8</span> <span class="n">adapter_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">target_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">msg_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">end_message</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">tag_number</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retry_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">scsi_phase</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>		<span class="cm">/* next/prev ptrs for the dcb list */</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">srb_going_list</span><span class="p">;</span>	<span class="cm">/* head of going srb list */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">srb_waiting_list</span><span class="p">;</span>	<span class="cm">/* head of waiting srb list */</span>

	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">active_srb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag_mask</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">max_command</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">target_id</span><span class="p">;</span>		<span class="cm">/* SCSI Target ID  (SCSI Only) */</span>
	<span class="n">u8</span> <span class="n">target_lun</span><span class="p">;</span>		<span class="cm">/* SCSI Log.  Unit (SCSI Only) */</span>
	<span class="n">u8</span> <span class="n">identify_msg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_mode</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">inquiry7</span><span class="p">;</span>		<span class="cm">/* To store Inquiry flags */</span>
	<span class="n">u8</span> <span class="n">sync_mode</span><span class="p">;</span>		<span class="cm">/* 0:async mode */</span>
	<span class="n">u8</span> <span class="n">min_nego_period</span><span class="p">;</span>	<span class="cm">/* for nego. */</span>
	<span class="n">u8</span> <span class="n">sync_period</span><span class="p">;</span>		<span class="cm">/* for reg.  */</span>

	<span class="n">u8</span> <span class="n">sync_offset</span><span class="p">;</span>		<span class="cm">/* for reg. and nego.(low nibble) */</span>
	<span class="n">u8</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">init_tcq_flag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_host</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port_len</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dcb_list</span><span class="p">;</span>		<span class="cm">/* head of going dcb list */</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb_run_robin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">active_dcb</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">srb_free_list</span><span class="p">;</span>		<span class="cm">/* head of free srb list */</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">tmp_srb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">waiting_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">selto_timer</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">srb_count</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">sel_timeout</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_level</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tag_max_num</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">acb_flag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gmode2</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lun_chk</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan_devices</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hostid_bit</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">dcb_map</span><span class="p">[</span><span class="n">DC395x_MAX_SCSI_ID</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">children</span><span class="p">[</span><span class="n">DC395x_MAX_SCSI_ID</span><span class="p">][</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">msg_len</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="n">srb_array</span><span class="p">[</span><span class="n">DC395x_MAX_SRB_CNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="n">srb</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">NvRamType</span> <span class="n">eeprom</span><span class="p">;</span>	<span class="cm">/* eeprom settings for this adapter */</span>
<span class="p">};</span>


<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">                            Forward declarations</span>
<span class="cm"> ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">data_out_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">data_in_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">command_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">status_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">msgout_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">msgin_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">data_out_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">data_in_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">command_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">status_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">msgout_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">msgin_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nop0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nop1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> 
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_basic_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cleanup_after_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_scsi_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">data_io_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="n">u16</span> <span class="n">io_dir</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">start_scsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">enable_msgout_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">build_srb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">doing_srb_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">did_code</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">force</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scsi_reset_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pci_unmap_srb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pci_unmap_srb_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">srb_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">request_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_xfer_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">waiting_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">);</span>


<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">                                 Static Data</span>
<span class="cm"> ---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">current_sync_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dc395x_scsi_phase0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">data_out_phase0</span><span class="p">,</span><span class="cm">/* phase:0 */</span>
	<span class="n">data_in_phase0</span><span class="p">,</span>	<span class="cm">/* phase:1 */</span>
	<span class="n">command_phase0</span><span class="p">,</span>	<span class="cm">/* phase:2 */</span>
	<span class="n">status_phase0</span><span class="p">,</span>	<span class="cm">/* phase:3 */</span>
	<span class="n">nop0</span><span class="p">,</span>		<span class="cm">/* phase:4 PH_BUS_FREE .. initial phase */</span>
	<span class="n">nop0</span><span class="p">,</span>		<span class="cm">/* phase:5 PH_BUS_FREE .. initial phase */</span>
	<span class="n">msgout_phase0</span><span class="p">,</span>	<span class="cm">/* phase:6 */</span>
	<span class="n">msgin_phase0</span><span class="p">,</span>	<span class="cm">/* phase:7 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dc395x_scsi_phase1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">data_out_phase1</span><span class="p">,</span><span class="cm">/* phase:0 */</span>
	<span class="n">data_in_phase1</span><span class="p">,</span>	<span class="cm">/* phase:1 */</span>
	<span class="n">command_phase1</span><span class="p">,</span>	<span class="cm">/* phase:2 */</span>
	<span class="n">status_phase1</span><span class="p">,</span>	<span class="cm">/* phase:3 */</span>
	<span class="n">nop1</span><span class="p">,</span>		<span class="cm">/* phase:4 PH_BUS_FREE .. initial phase */</span>
	<span class="n">nop1</span><span class="p">,</span>		<span class="cm">/* phase:5 PH_BUS_FREE .. initial phase */</span>
	<span class="n">msgout_phase1</span><span class="p">,</span>	<span class="cm">/* phase:6 */</span>
	<span class="n">msgin_phase1</span><span class="p">,</span>	<span class="cm">/* phase:7 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *Fast20:	000	 50ns, 20.0 MHz</span>
<span class="cm"> *		001	 75ns, 13.3 MHz</span>
<span class="cm"> *		010	100ns, 10.0 MHz</span>
<span class="cm"> *		011	125ns,  8.0 MHz</span>
<span class="cm"> *		100	150ns,  6.6 MHz</span>
<span class="cm"> *		101	175ns,  5.7 MHz</span>
<span class="cm"> *		110	200ns,  5.0 MHz</span>
<span class="cm"> *		111	250ns,  4.0 MHz</span>
<span class="cm"> *</span>
<span class="cm"> *Fast40(LVDS):	000	 25ns, 40.0 MHz</span>
<span class="cm"> *		001	 50ns, 20.0 MHz</span>
<span class="cm"> *		010	 75ns, 13.3 MHz</span>
<span class="cm"> *		011	100ns, 10.0 MHz</span>
<span class="cm"> *		100	125ns,  8.0 MHz</span>
<span class="cm"> *		101	150ns,  6.6 MHz</span>
<span class="cm"> *		110	175ns,  5.7 MHz</span>
<span class="cm"> *		111	200ns,  5.0 MHz</span>
<span class="cm"> */</span>
<span class="cm">/*static u8	clock_period[] = {12,19,25,31,37,44,50,62};*/</span>

<span class="cm">/* real period:48ns,76ns,100ns,124ns,148ns,176ns,200ns,248ns */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">clock_period</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">62</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">clock_speed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">40</span> <span class="p">};</span>


<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm">                                Configuration</span>
<span class="cm">  ---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Module/boot parameters currently effect *all* instances of the</span>
<span class="cm"> * card in the system.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Command line parameters are stored in a structure below.</span>
<span class="cm"> * These are the index&#39;s into the structure for the various</span>
<span class="cm"> * command line options.</span>
<span class="cm"> */</span>
<span class="cp">#define CFG_ADAPTER_ID		0</span>
<span class="cp">#define CFG_MAX_SPEED		1</span>
<span class="cp">#define CFG_DEV_MODE		2</span>
<span class="cp">#define CFG_ADAPTER_MODE	3</span>
<span class="cp">#define CFG_TAGS		4</span>
<span class="cp">#define CFG_RESET_DELAY		5</span>

<span class="cp">#define CFG_NUM			6	</span><span class="cm">/* number of configuration items */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * Value used to indicate that a command line override</span>
<span class="cm"> * hasn&#39;t been used to modify the value.</span>
<span class="cm"> */</span>
<span class="cp">#define CFG_PARAM_UNSET -1</span>


<span class="cm">/*</span>
<span class="cm"> * Hold command line parameters.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ParameterData</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>		<span class="cm">/* value of this setting */</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">;</span>		<span class="cm">/* minimum value */</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>		<span class="cm">/* maximum value */</span>
	<span class="kt">int</span> <span class="n">def</span><span class="p">;</span>		<span class="cm">/* default value */</span>
	<span class="kt">int</span> <span class="n">safe</span><span class="p">;</span>		<span class="cm">/* safe value */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ParameterData</span> <span class="n">__devinitdata</span> <span class="n">cfg_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="cm">/* adapter id */</span>
		<span class="n">CFG_PARAM_UNSET</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">15</span><span class="p">,</span>
		<span class="mi">7</span><span class="p">,</span>
		<span class="mi">7</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* max speed */</span>
		<span class="n">CFG_PARAM_UNSET</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span>
		  <span class="mi">7</span><span class="p">,</span>
		  <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* 13.3Mhz */</span>
		  <span class="mi">4</span><span class="p">,</span>	<span class="cm">/*  6.7Hmz */</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* dev mode */</span>
		<span class="n">CFG_PARAM_UNSET</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mh">0x3f</span><span class="p">,</span>
		<span class="n">NTC_DO_PARITY_CHK</span> <span class="o">|</span> <span class="n">NTC_DO_DISCONNECT</span> <span class="o">|</span> <span class="n">NTC_DO_SYNC_NEGO</span> <span class="o">|</span>
			<span class="n">NTC_DO_WIDE_NEGO</span> <span class="o">|</span> <span class="n">NTC_DO_TAG_QUEUEING</span> <span class="o">|</span>
			<span class="n">NTC_DO_SEND_START</span><span class="p">,</span>
		<span class="n">NTC_DO_PARITY_CHK</span> <span class="o">|</span> <span class="n">NTC_DO_SEND_START</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* adapter mode */</span>
		<span class="n">CFG_PARAM_UNSET</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mh">0x2f</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_SCSI_MULTI_LUN</span>
			<span class="n">NAC_SCANLUN</span> <span class="o">|</span>
<span class="cp">#endif</span>
		<span class="n">NAC_GT2DRIVES</span> <span class="o">|</span> <span class="n">NAC_GREATER_1G</span> <span class="o">|</span> <span class="n">NAC_POWERON_SCSI_RESET</span>
			<span class="cm">/*| NAC_ACTIVE_NEG*/</span><span class="p">,</span>
		<span class="n">NAC_GT2DRIVES</span> <span class="o">|</span> <span class="n">NAC_GREATER_1G</span> <span class="o">|</span> <span class="n">NAC_POWERON_SCSI_RESET</span> <span class="o">|</span> <span class="mh">0x08</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* tags */</span>
		<span class="n">CFG_PARAM_UNSET</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">5</span><span class="p">,</span>
		<span class="mi">3</span><span class="p">,</span>	<span class="cm">/* 16 tags (??) */</span>
		<span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* reset delay */</span>
		<span class="n">CFG_PARAM_UNSET</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">180</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>	<span class="cm">/* 1 second */</span>
		<span class="mi">10</span><span class="p">,</span>	<span class="cm">/* 10 seconds */</span>
	<span class="p">}</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Safe settings. If set to zero the BIOS/default values with</span>
<span class="cm"> * command line overrides will be used. If set to 1 then safe and</span>
<span class="cm"> * slow settings will be used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_safe_settings</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">safe</span><span class="p">,</span> <span class="n">use_safe_settings</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">safe</span><span class="p">,</span> <span class="s">&quot;Use safe and slow settings only. Default: false&quot;</span><span class="p">);</span>


<span class="n">module_param_named</span><span class="p">(</span><span class="n">adapter_id</span><span class="p">,</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_ADAPTER_ID</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adapter_id</span><span class="p">,</span> <span class="s">&quot;Adapter SCSI ID. Default 7 (0-15)&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">max_speed</span><span class="p">,</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_MAX_SPEED</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_speed</span><span class="p">,</span> <span class="s">&quot;Maximum bus speed. Default 1 (0-7) Speeds: 0=20, 1=13.3, 2=10, 3=8, 4=6.7, 5=5.8, 6=5, 7=4 Mhz&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">dev_mode</span><span class="p">,</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_DEV_MODE</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dev_mode</span><span class="p">,</span> <span class="s">&quot;Device mode.&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">adapter_mode</span><span class="p">,</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_ADAPTER_MODE</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adapter_mode</span><span class="p">,</span> <span class="s">&quot;Adapter mode.&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_TAGS</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="s">&quot;Number of tags (1&lt;&lt;x). Default 3 (0-5)&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">reset_delay</span><span class="p">,</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_RESET_DELAY</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reset_delay</span><span class="p">,</span> <span class="s">&quot;Reset delay in seconds. Default 1 (0-180)&quot;</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * set_safe_settings - if the use_safe_settings option is set then</span>
<span class="cm"> * set all values to the safe and slow values.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">set_safe_settings</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_safe_settings</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Using safe settings.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CFG_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">cfg_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">safe</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * fix_settings - reset any boot parameters which are out of range</span>
<span class="cm"> * back to the default values.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">fix_settings</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span>
		<span class="s">&quot;setup: AdapterId=%08x MaxSpeed=%08x DevMode=%08x &quot;</span>
		<span class="s">&quot;AdapterMode=%08x Tags=%08x ResetDelay=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_ADAPTER_ID</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
		<span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_MAX_SPEED</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
		<span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_DEV_MODE</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
		<span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_ADAPTER_MODE</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
		<span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_TAGS</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
		<span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_RESET_DELAY</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CFG_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min</span>
		    <span class="o">||</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max</span><span class="p">)</span>
			<span class="n">cfg_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">def</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Mapping from the eeprom delay index value (index into this array)</span>
<span class="cm"> * to the number of actual seconds that the delay should be for.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">__devinitdata</span> <span class="n">eeprom_index_to_delay_map</span><span class="p">[]</span> <span class="o">=</span> 
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span> <span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * eeprom_index_to_delay - Take the eeprom delay setting and convert it</span>
<span class="cm"> * into a number of seconds.</span>
<span class="cm"> *</span>
<span class="cm"> * @eeprom: The eeprom structure in which we find the delay index to map.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">eeprom_index_to_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">delay_time</span> <span class="o">=</span> <span class="n">eeprom_index_to_delay_map</span><span class="p">[</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">delay_time</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * delay_to_eeprom_index - Take a delay in seconds and return the</span>
<span class="cm"> * closest eeprom index which will delay for at least that amount of</span>
<span class="cm"> * seconds.</span>
<span class="cm"> *</span>
<span class="cm"> * @delay: The delay, in seconds, to find the eeprom index for.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">delay_to_eeprom_index</span><span class="p">(</span><span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">eeprom_index_to_delay_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">delay</span><span class="p">)</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * eeprom_override - Override the eeprom settings, in the provided</span>
<span class="cm"> * eeprom structure, with values that have been set on the command</span>
<span class="cm"> * line.</span>
<span class="cm"> *</span>
<span class="cm"> * @eeprom: The eeprom data to override with command line options.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">eeprom_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Adapter Settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_ADAPTER_ID</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">CFG_PARAM_UNSET</span><span class="p">)</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_ADAPTER_ID</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_ADAPTER_MODE</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">CFG_PARAM_UNSET</span><span class="p">)</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">channel_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_ADAPTER_MODE</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_RESET_DELAY</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">CFG_PARAM_UNSET</span><span class="p">)</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">delay_time</span> <span class="o">=</span> <span class="n">delay_to_eeprom_index</span><span class="p">(</span>
					<span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_RESET_DELAY</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_TAGS</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">CFG_PARAM_UNSET</span><span class="p">)</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">max_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_TAGS</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>

	<span class="cm">/* Device Settings */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="n">DC395x_MAX_SCSI_ID</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_DEV_MODE</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">CFG_PARAM_UNSET</span><span class="p">)</span>
			<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">cfg0</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_DEV_MODE</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_MAX_SPEED</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">CFG_PARAM_UNSET</span><span class="p">)</span>
			<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">period</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_MAX_SPEED</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*---------------------------------------------------------------------------</span>
<span class="cm"> ---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">list_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="nf">dcb_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">use_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span><span class="o">*</span> <span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span><span class="o">*</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* find supplied dcb and then select the next one */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">use_next</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="cm">/* if no next one take the head one (ie, wraparound) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next</span><span class="p">)</span>
        	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
        		<span class="n">next</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        		<span class="k">break</span><span class="p">;</span>
        	<span class="p">}</span>

	<span class="k">return</span> <span class="n">next</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">tag_number</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">tag_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">tag_number</span><span class="p">);</span>	<span class="cm">/* free tag mask */</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">tag_number</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Find cmd in SRB list */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="nf">find_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="nf">srb_get_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_free_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">srb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_get_free: srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">srb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">srb_free_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_free_insert: srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_free_list</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">srb_waiting_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_waiting_insert: (0x%p) &lt;%02i-%i&gt; srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">srb_waiting_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_waiting_append: (0x%p) &lt;%02i-%i&gt; srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">srb_going_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_going_append: (0x%p) &lt;%02i-%i&gt; srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">srb_going_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_going_remove: (0x%p) &lt;%02i-%i&gt; srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">srb_waiting_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_waiting_remove: (0x%p) &lt;%02i-%i&gt; srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">srb_going_to_waiting_move</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span>
		<span class="s">&quot;srb_going_to_waiting_move: (0x%p) &lt;%02i-%i&gt; srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">srb_waiting_to_going_move</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span>
		<span class="s">&quot;srb_waiting_to_going_move: (0x%p) &lt;%02i-%i&gt; srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Sets the timer to wake us up */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">waiting_set_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">waiting_timeout</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">acb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">to</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">-</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
		    <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">-</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">to</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Send the next command from the waiting list to the bus */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">waiting_process_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">dcb_list_head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RESET_DETECT</span> <span class="o">+</span> <span class="n">RESET_DONE</span> <span class="o">+</span> <span class="n">RESET_DEV</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">dcb_list_head</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find the starting dcb. Need to find it again in the list</span>
<span class="cm">	 * since the list may have changed since we set the ptr to it</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">dcb_list_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span> <span class="o">==</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_run_robin</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">dcb</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This can happen! */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dcb_list_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_run_robin</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Loop over the dcb, but we start somewhere (potentially) in</span>
<span class="cm">	 * the middle of the loop so we need to manully do this.</span>
<span class="cm">	 */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">waiting_list_head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">;</span>

		<span class="cm">/* Make sure, the next another device gets scheduled ... */</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_run_robin</span> <span class="o">=</span> <span class="n">dcb_get_next</span><span class="p">(</span><span class="n">dcb_list_head</span><span class="p">,</span>
						  <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_run_robin</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">waiting_list_head</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">pos</span><span class="o">-&gt;</span><span class="n">max_command</span> <span class="o">&lt;=</span> <span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* move to next dcb */</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="n">dcb_get_next</span><span class="p">(</span><span class="n">dcb_list_head</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">srb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">waiting_list_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ScsiReqBlk</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

			<span class="cm">/* Try to send to the bus */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start_scsi</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">srb</span><span class="p">))</span>
				<span class="n">srb_waiting_to_going_move</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">waiting_set_timer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">50</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Wake up waiting queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">waiting_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span>
		<span class="s">&quot;waiting_timeout: Queue woken up by timer. acb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>
	<span class="n">DC395x_LOCK_IO</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">waiting_process_next</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">DC395x_UNLOCK_IO</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Get the DCB for a given ID/LUN combination */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="nf">find_dcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">lun</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/* Send SCSI Request Block (srb) to adapter (acb) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_srb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">max_command</span> <span class="o">&lt;=</span> <span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RESET_DETECT</span> <span class="o">+</span> <span class="n">RESET_DONE</span> <span class="o">+</span> <span class="n">RESET_DEV</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">srb_waiting_append</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">waiting_process_next</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start_scsi</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">))</span>
		<span class="n">srb_going_append</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">srb_waiting_insert</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">waiting_set_timer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Prepare SRB for being sent to Device DCB w/ command *cmd */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_srb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;build_srb: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">dcb</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">tag_number</span> <span class="o">=</span> <span class="n">TAG_NONE</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_phase</span> <span class="o">=</span> <span class="n">PH_BUS_FREE</span><span class="p">;</span>	<span class="cm">/* initial phase */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">end_message</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">PCI_DMA_NONE</span> <span class="o">||</span> <span class="o">!</span><span class="n">nseg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span>
			<span class="s">&quot;build_srb: [0] len=%d buf=%p use_sg=%d !MAP=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bufflen</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
			   <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">reqlen</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">SGentry</span> <span class="o">*</span><span class="n">sgp</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">;</span>

		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>

		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span>
			   <span class="s">&quot;build_srb: [n] len=%d buf=%p use_sg=%d segs=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">reqlen</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
			   <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">);</span>

		<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">busaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">seglen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="n">sgp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">busaddr</span><span class="p">;</span>
			<span class="n">sgp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">seglen</span><span class="p">;</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">+=</span> <span class="n">seglen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sgp</span> <span class="o">+=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * adjust last page if too big as it is allocated</span>
<span class="cm">		 * on even page boundaries</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">&gt;</span> <span class="n">reqlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sgp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">-</span> <span class="n">reqlen</span><span class="p">);</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">=</span> <span class="n">reqlen</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Fixup for WIDE padding - make sure length is even */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span> <span class="o">&amp;&amp;</span>
		    <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sgp</span><span class="o">-&gt;</span><span class="n">length</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_bus_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">,</span>
				            	<span class="n">SEGMENTX_LEN</span><span class="p">,</span>
				            	<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_SG</span><span class="p">,</span> <span class="s">&quot;build_srb: [n] map sg %p-&gt;%08x(%05x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_bus_addr</span><span class="p">,</span> <span class="n">SEGMENTX_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">request_length</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * dc395x_queue_command - queue scsi command passed from the mid</span>
<span class="cm"> * layer, invoke &#39;done&#39; on completion</span>
<span class="cm"> *</span>
<span class="cm"> * @cmd: pointer to scsi command object</span>
<span class="cm"> * @done: function pointer to be invoked on completion</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the adapter (host) is busy, else returns 0. One</span>
<span class="cm"> * reason for an adapter to be busy is that the number</span>
<span class="cm"> * of outstanding queued commands is already equal to</span>
<span class="cm"> * struct Scsi_Host::can_queue .</span>
<span class="cm"> *</span>
<span class="cm"> * Required: if struct Scsi_Host::can_queue is ever non-zero</span>
<span class="cm"> *           then this function is required.</span>
<span class="cm"> *</span>
<span class="cm"> * Locks: struct Scsi_Host::host_lock held on entry (with &quot;irqsave&quot;)</span>
<span class="cm"> *        and is expected to be held on return.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dc395x_queue_command_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;queue_command: (0x%p) &lt;%02i-%i&gt; cmnd=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Assume BAD_TARGET; will be cleared later */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* ignore invalid targets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">||</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&gt;=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">||</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&gt;</span><span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">complete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* does the specified lun on the specified device exist */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;queue_command: Ignore target &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">complete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* do we have a DCB for the device */</span>
	<span class="n">dcb</span> <span class="o">=</span> <span class="n">find_dcb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* should never happen */</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;queue_command: No such device &lt;%02i-%i&gt;&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">complete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set callback and clear result in the command */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">srb</span> <span class="o">=</span> <span class="n">srb_get_free</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Return 1 since we are unable to queue this command at this</span>
<span class="cm">		 * point in time.</span>
<span class="cm">		 */</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;queue_command: No free srb&#39;s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">build_srb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* append to waiting queue */</span>
		<span class="n">srb_waiting_append</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">waiting_process_next</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* process immediately */</span>
		<span class="n">send_srb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;queue_command: (0x%p) done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">complete:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Complete the command immediatey, and then return 0 to</span>
<span class="cm">	 * indicate that we have handled the command. This is usually</span>
<span class="cm">	 * done when the commad is for things like non existent</span>
<span class="cm">	 * devices.</span>
<span class="cm">	 */</span>
	<span class="n">done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">dc395x_queue_command</span><span class="p">)</span>

<span class="cm">/*</span>
<span class="cm"> * Return the disk geometry for the given SCSI device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dc395x_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_DC395x_TRMS1040_TRADMAP</span>
	<span class="kt">int</span> <span class="n">heads</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">cylinders</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>

	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;dc395x_bios_param..............</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cylinders</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">gmode2</span> <span class="o">&amp;</span> <span class="n">NAC_GREATER_1G</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cylinders</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">cylinders</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">scsicam_bios_param</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_register_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pstat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcb</span><span class="p">)</span>
		<span class="n">dcb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span> <span class="o">&amp;&amp;</span> <span class="n">dcb</span><span class="p">)</span>
		<span class="n">srb</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;dump: srb=%p cmd=%p OOOPS!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">srb</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;dump: srb=%p cmd=%p &quot;</span>
				 <span class="s">&quot;cmnd=0x%02x &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">srb</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			       	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  sglist=%p cnt=%i idx=%i len=%zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span><span class="p">,</span>
		       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  state=0x%04x status=0x%02x phase=0x%02x (%sconn.)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_phase</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;dump: SCSI{status=0x%04x fifocnt=0x%02x &quot;</span>
		<span class="s">&quot;signals=0x%02x irqstat=0x%02x sync=0x%02x target=0x%02x &quot;</span>
		<span class="s">&quot;rselid=0x%02x ctr=0x%08x irqen=0x%02x config=0x%04x &quot;</span>
		<span class="s">&quot;config2=0x%02x cmd=0x%02x selto=0x%02x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_STATUS</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_SIGNAL</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTSTATUS</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_SYNC</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_TARGETID</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_IDMSG</span><span class="p">),</span>
		<span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTEN</span><span class="p">),</span>
		<span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG0</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG2</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_TIMEOUT</span><span class="p">));</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;dump: DMA{cmd=0x%04x fifocnt=0x%02x fstat=0x%02x &quot;</span>
		<span class="s">&quot;irqstat=0x%02x irqen=0x%02x cfg=0x%04x tctr=0x%08x &quot;</span>
		<span class="s">&quot;ctctr=0x%08x addr=0x%08x:0x%08x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_COMMAND</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOCNT</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOSTAT</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_STATUS</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_INTEN</span><span class="p">),</span>
		<span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONFIG</span><span class="p">),</span>
		<span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_XCNT</span><span class="p">),</span>
		<span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CXCNT</span><span class="p">),</span>
		<span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_XHIGHADDR</span><span class="p">),</span>
		<span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_XLOWADDR</span><span class="p">));</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;dump: gen{gctrl=0x%02x gstat=0x%02x gtmr=0x%02x} &quot;</span>
		<span class="s">&quot;pci{status=0x%04x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_GEN_STATUS</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_GEN_TIMER</span><span class="p">),</span>
		<span class="n">pstat</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clear_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">txt</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if debug_enabled(DBG_FIFO)</span>
	<span class="n">u8</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_SIGNAL</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">fifocnt</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fifocnt</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_FIFO</span><span class="p">,</span>
			<span class="s">&quot;clear_fifo: (%i bytes) on phase %02x in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fifocnt</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">txt</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_CLRFIFO</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_dev_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;reset_dev_param: acb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">period_index</span><span class="p">;</span>

		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SYNC_NEGO_DONE</span> <span class="o">+</span> <span class="n">WIDE_NEGO_DONE</span><span class="p">);</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">].</span><span class="n">cfg0</span><span class="p">;</span>
		<span class="n">period_index</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">].</span><span class="n">period</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">=</span> <span class="n">clock_period</span><span class="p">[</span><span class="n">period_index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_WIDE_NEGO</span><span class="p">)</span>
		    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">HCC_WIDE_CARD</span><span class="p">))</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIDE_NEGO_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * perform a hard reset on the SCSI bus</span>
<span class="cm"> * @cmd - some command for this host (for fetching hooks)</span>
<span class="cm"> * Returns: SUCCESS (0x2002) on success, else FAILED (0x2003).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__dc395x_eh_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span>
		<span class="s">&quot;eh_bus_reset: (0%p) target=&lt;%02i-%i&gt; cmd=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * disable interrupt    </span>
<span class="cm">	 */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_INTEN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTEN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_RSTMODULE</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONTROL</span><span class="p">,</span> <span class="n">DMARESETMODULE</span><span class="p">);</span>

	<span class="n">reset_scsi_bus</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="cm">/* We may be in serious trouble. Wait some seconds */</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span>
	    <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
	    <span class="n">HZ</span> <span class="o">*</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">delay_time</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * re-enable interrupt      </span>
<span class="cm">	 */</span>
	<span class="cm">/* Clear SCSI FIFO          */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONTROL</span><span class="p">,</span> <span class="n">CLRXFIFO</span><span class="p">);</span>
	<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;eh_bus_reset&quot;</span><span class="p">);</span>
	<span class="cm">/* Delete pending IRQ */</span>
	<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTSTATUS</span><span class="p">);</span>
	<span class="n">set_basic_config</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>

	<span class="n">reset_dev_param</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">doing_srb_done</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">DID_RESET</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* RESET_DETECT, RESET_DONE ,RESET_DEV */</span>
	<span class="n">waiting_process_next</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dc395x_eh_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__dc395x_eh_bus_reset</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * abort an errant SCSI command</span>
<span class="cm"> * @cmd - command to be aborted</span>
<span class="cm"> * Returns: SUCCESS (0x2002) on success, else FAILED (0x2003).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dc395x_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Look into our command queues: If it has not been sent already,</span>
<span class="cm">	 * we remove it and return success. Otherwise fail.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;eh_abort: (0x%p) target=&lt;%02i-%i&gt; cmd=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">find_dcb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;eh_abort: No such device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">srb</span> <span class="o">=</span> <span class="n">find_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srb_waiting_remove</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">pci_unmap_srb_sense</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">pci_unmap_srb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">free_tag</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">srb_free_insert</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;eh_abort: Command was waiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">srb</span> <span class="o">=</span> <span class="n">find_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;eh_abort: Command in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* XXX: Should abort the command here */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;eh_abort: Command not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* SDTR */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_sdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span> <span class="o">+</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span>
			<span class="s">&quot;build_sdtr: msgout_buf BUSY (%i: %02x %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_SYNC_NEGO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="n">SYNC_NEGO_OFFSET</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">MSG_EXTENDED</span><span class="p">;</span>	<span class="cm">/* (01h) */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* length */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">EXTENDED_SDTR</span><span class="p">;</span>	<span class="cm">/* (01h) */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span><span class="p">;</span>	<span class="cm">/* Transfer period (in 4ns) */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">;</span>	<span class="cm">/* Transfer period (max. REQ/ACK dist) */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_DO_SYNC_NEGO</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* WDTR */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_wdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">wide</span> <span class="o">=</span> <span class="p">((</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_WIDE_NEGO</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">HCC_WIDE_CARD</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span> <span class="o">+</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span>
			<span class="s">&quot;build_wdtr: msgout_buf BUSY (%i: %02x %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">MSG_EXTENDED</span><span class="p">;</span>	<span class="cm">/* (01h) */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* length */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">EXTENDED_WDTR</span><span class="p">;</span>	<span class="cm">/* (03h) */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">wide</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_DO_WIDE_NEGO</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* Timer to work around chip flaw: When selecting and the bus is </span>
<span class="c"> * busy, we sometimes miss a Selection timeout IRQ */</span>
<span class="c">void selection_timeout_missed(unsigned long ptr);</span>
<span class="c">/* Sets the timer to wake us up */</span>
<span class="c">static void selto_timer(struct AdapterCtlBlk *acb)</span>
<span class="c">{</span>
<span class="c">	if (timer_pending(&amp;acb-&gt;selto_timer))</span>
<span class="c">		return;</span>
<span class="c">	acb-&gt;selto_timer.function = selection_timeout_missed;</span>
<span class="c">	acb-&gt;selto_timer.data = (unsigned long) acb;</span>
<span class="c">	if (time_before</span>
<span class="c">	    (jiffies + HZ, acb-&gt;scsi_host-&gt;last_reset + HZ / 2))</span>
<span class="c">		acb-&gt;selto_timer.expires =</span>
<span class="c">		    acb-&gt;scsi_host-&gt;last_reset + HZ / 2 + 1;</span>
<span class="c">	else</span>
<span class="c">		acb-&gt;selto_timer.expires = jiffies + HZ + 1;</span>
<span class="c">	add_timer(&amp;acb-&gt;selto_timer);</span>
<span class="c">}</span>


<span class="c">void selection_timeout_missed(unsigned long ptr)</span>
<span class="c">{</span>
<span class="c">	unsigned long flags;</span>
<span class="c">	struct AdapterCtlBlk *acb = (struct AdapterCtlBlk *)ptr;</span>
<span class="c">	struct ScsiReqBlk *srb;</span>
<span class="c">	dprintkl(KERN_DEBUG, &quot;Chip forgot to produce SelTO IRQ!\n&quot;);</span>
<span class="c">	if (!acb-&gt;active_dcb || !acb-&gt;active_dcb-&gt;active_srb) {</span>
<span class="c">		dprintkl(KERN_DEBUG, &quot;... but no cmd pending? Oops!\n&quot;);</span>
<span class="c">		return;</span>
<span class="c">	}</span>
<span class="c">	DC395x_LOCK_IO(acb-&gt;scsi_host, flags);</span>
<span class="c">	srb = acb-&gt;active_dcb-&gt;active_srb;</span>
<span class="c">	disconnect(acb);</span>
<span class="c">	DC395x_UNLOCK_IO(acb-&gt;scsi_host, flags);</span>
<span class="c">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="n">u8</span> <span class="nf">start_scsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span><span class="o">*</span> <span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span><span class="o">*</span> <span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span><span class="o">*</span> <span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">s_stat2</span><span class="p">,</span> <span class="n">return_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">s_stat</span><span class="p">,</span> <span class="n">scsicommand</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">identify_message</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;start_scsi: (0x%p) &lt;%02i-%i&gt; srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">tag_number</span> <span class="o">=</span> <span class="n">TAG_NONE</span><span class="p">;</span>	<span class="cm">/* acb-&gt;tag_max_num: had error read in eeprom */</span>

	<span class="n">s_stat</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_SIGNAL</span><span class="p">);</span>
	<span class="n">s_stat2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s_stat2</span> <span class="o">=</span> <span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_STATUS</span><span class="p">);</span>
<span class="cp">#if 1</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s_stat</span> <span class="o">&amp;</span> <span class="mh">0x20</span> <span class="cm">/* s_stat2 &amp; 0x02000 */</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;start_scsi: (0x%p) BUSY %02x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s_stat</span><span class="p">,</span> <span class="n">s_stat2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Try anyway?</span>
<span class="cm">		 *</span>
<span class="cm">		 * We could, BUT: Sometimes the TRM_S1040 misses to produce a Selection</span>
<span class="cm">		 * Timeout, a Disconnect or a Reselection IRQ, so we would be screwed!</span>
<span class="cm">		 * (This is likely to be a bug in the hardware. Obviously, most people</span>
<span class="cm">		 *  only have one initiator per SCSI bus.)</span>
<span class="cm">		 * Instead let this fail and have the timer make sure the command is </span>
<span class="cm">		 * tried again after a short time</span>
<span class="cm">		 */</span>
		<span class="cm">/*selto_timer (acb); */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;start_scsi: (0x%p) Attempt to start a&quot;</span>
			<span class="s">&quot;command while another command (0x%p) is active.&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span> <span class="o">?</span>
			    <span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSIINTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;start_scsi: (0x%p) Failed (busy)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Allow starting of SCSI commands half a second before we allow the mid-level</span>
<span class="cm">	 * to queue them again after a reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">-</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;start_scsi: Refuse cmds (reset wait)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Flush FIFO */</span>
	<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;start_scsi&quot;</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_HOSTID</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_TARGETID</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_SYNC</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_OFFSET</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_phase</span> <span class="o">=</span> <span class="n">PH_BUS_FREE</span><span class="p">;</span>	<span class="cm">/* initial phase */</span>

	<span class="n">identify_message</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">identify_msg</span><span class="p">;</span>
	<span class="cm">/*DC395x_TRM_write8(TRM_S1040_SCSI_IDMSG, identify_message); */</span>
	<span class="cm">/* Don&#39;t allow disconnection for AUTO_REQSENSE: Cont.All.Cond.! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">)</span>
		<span class="n">identify_message</span> <span class="o">&amp;=</span> <span class="mh">0xBF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">)</span>
	     <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span><span class="p">)</span>
	     <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGO_ENABLE</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGO_DONE</span><span class="p">))</span>
		<span class="o">||</span> <span class="p">((</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_ENABLE</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_DONE</span><span class="p">)))</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">identify_message</span><span class="p">;</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsicommand</span> <span class="o">=</span> <span class="n">SCMD_SEL_ATNSTOP</span><span class="p">;</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_MSGOUT</span><span class="p">;</span>
<span class="cp">#ifndef SYNC_FIRST</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGO_ENABLE</span>
		    <span class="o">&amp;&amp;</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">inquiry7</span> <span class="o">&amp;</span> <span class="n">SCSI_INQ_WBUS16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">build_wdtr</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">no_cmd</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_ENABLE</span>
		    <span class="o">&amp;&amp;</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">inquiry7</span> <span class="o">&amp;</span> <span class="n">SCSI_INQ_SYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">build_sdtr</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">no_cmd</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGO_ENABLE</span>
		    <span class="o">&amp;&amp;</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">inquiry7</span> <span class="o">&amp;</span> <span class="n">SCSI_INQ_WBUS16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">build_wdtr</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">no_cmd</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Send identify message */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="n">identify_message</span><span class="p">);</span>

	<span class="n">scsicommand</span> <span class="o">=</span> <span class="n">SCMD_SEL_ATN</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_START_</span><span class="p">;</span>
<span class="cp">#ifndef DC395x_NO_TAGQ</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">EN_TAG_QUEUEING</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">identify_message</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Send Tag message */</span>
		<span class="n">u32</span> <span class="n">tag_mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">tag_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tag_mask</span> <span class="o">&amp;</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">tag_mask</span>
		       <span class="o">&amp;&amp;</span> <span class="n">tag_number</span> <span class="o">&lt;</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">max_command</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tag_mask</span> <span class="o">=</span> <span class="n">tag_mask</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tag_number</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag_number</span> <span class="o">&gt;=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">max_command</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;start_scsi: (0x%p) &quot;</span>
				<span class="s">&quot;Out of tags target=&lt;%02i-%i&gt;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_READY</span><span class="p">;</span>
			<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span>
				       <span class="n">DO_HWRESELECT</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Send Tag id */</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="n">MSG_SIMPLE_QTAG</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="n">tag_number</span><span class="p">);</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">tag_mask</span> <span class="o">|=</span> <span class="n">tag_mask</span><span class="p">;</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">tag_number</span> <span class="o">=</span> <span class="n">tag_number</span><span class="p">;</span>
		<span class="n">scsicommand</span> <span class="o">=</span> <span class="n">SCMD_SEL_ATN3</span><span class="p">;</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_START_</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cm">/*polling:*/</span>
	<span class="cm">/* Send CDB ..command block ......... */</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;start_scsi: (0x%p) &lt;%02i-%i&gt; cmnd=0x%02x tag=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">tag_number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="n">REQUEST_SENSE</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="nl">no_cmd:</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span>
		       <span class="n">DO_HWRESELECT</span> <span class="o">|</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSIINTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* </span>
<span class="cm">		 * If start_scsi return 1:</span>
<span class="cm">		 * we caught an interrupt (must be reset or reselection ... )</span>
<span class="cm">		 * : Let&#39;s process it first!</span>
<span class="cm">		 */</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;start_scsi: (0x%p) &lt;%02i-%i&gt; Failed - busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_READY</span><span class="p">;</span>
		<span class="n">free_tag</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">return_code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* This IRQ should NOT get lost, as we did not acknowledge it */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* </span>
<span class="cm">		 * If start_scsi returns 0:</span>
<span class="cm">		 * we know that the SCSI processor is free</span>
<span class="cm">		 */</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_phase</span> <span class="o">=</span> <span class="n">PH_BUS_FREE</span><span class="p">;</span>	<span class="cm">/* initial phase */</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span> <span class="o">=</span> <span class="n">srb</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span> <span class="o">=</span> <span class="n">dcb</span><span class="p">;</span>
		<span class="n">return_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* it&#39;s important for atn stop */</span>
		<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span>
			       <span class="n">DO_DATALATCH</span> <span class="o">|</span> <span class="n">DO_HWRESELECT</span><span class="p">);</span>
		<span class="cm">/* SCSI command */</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">scsicommand</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">return_code</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define DC395x_ENABLE_MSGOUT \</span>
<span class="cp"> DC395x_write16 (acb, TRM_S1040_SCSI_CONTROL, DO_SETATN); \</span>
<span class="cp"> srb-&gt;state |= SRB_MSGOUT</span>


<span class="cm">/* abort command */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enable_msgout_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABORT</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_MSGIN</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_MSGOUT</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * dc395x_handle_interrupt - Handle an interrupt that has been confirmed to</span>
<span class="cm"> *                           have been triggered for this card.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb:	 a pointer to the adpter control block</span>
<span class="cm"> * @scsi_status: the status return when we checked the card</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dc395x_handle_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">scsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scsi_intstatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dc395x_statev</span><span class="p">)(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="p">,</span> 
			      <span class="n">u16</span> <span class="o">*</span><span class="p">);</span>

	<span class="n">DC395x_LOCK_IO</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* This acknowledges the IRQ */</span>
	<span class="n">scsi_intstatus</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTSTATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="mh">0x2007</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x2002</span><span class="p">)</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
			<span class="s">&quot;COP after COP completed? %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_intstatus</span> <span class="o">&amp;</span> <span class="n">INT_SELTIMEOUT</span><span class="p">)</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;handle_interrupt: Selection timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*dprintkl(KERN_DEBUG, &quot;handle_interrupt: intstatus = 0x%02x &quot;, scsi_intstatus); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">selto_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">selto_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_intstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_SELTIMEOUT</span> <span class="o">|</span> <span class="n">INT_DISCONNECT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">disconnect</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>	<span class="cm">/* bus free interrupt  */</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_intstatus</span> <span class="o">&amp;</span> <span class="n">INT_RESELECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reselect</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_intstatus</span> <span class="o">&amp;</span> <span class="n">INT_SELECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Host does not support target mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_intstatus</span> <span class="o">&amp;</span> <span class="n">INT_SCSIRESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_reset_detect</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_intstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_BUSSERVICE</span> <span class="o">|</span> <span class="n">INT_CMDDONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dcb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
				<span class="s">&quot;Oops: BusService (%04x %02x) w/o ActiveDCB!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">scsi_status</span><span class="p">,</span> <span class="n">scsi_intstatus</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">srb</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">ABORT_DEV_</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;MsgOut Abort Device.....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">enable_msgout_abort</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* software sequential machine */</span>
		<span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_phase</span><span class="p">;</span>

		<span class="cm">/* </span>
<span class="cm">		 * 62037 or 62137</span>
<span class="cm">		 * call  dc395x_scsi_phase0[]... &quot;phase entry&quot;</span>
<span class="cm">		 * handle every phase before start transfer</span>
<span class="cm">		 */</span>
		<span class="cm">/* data_out_phase0,	phase:0 */</span>
		<span class="cm">/* data_in_phase0,	phase:1 */</span>
		<span class="cm">/* command_phase0,	phase:2 */</span>
		<span class="cm">/* status_phase0,	phase:3 */</span>
		<span class="cm">/* nop0,		phase:4 PH_BUS_FREE .. initial phase */</span>
		<span class="cm">/* nop0,		phase:5 PH_BUS_FREE .. initial phase */</span>
		<span class="cm">/* msgout_phase0,	phase:6 */</span>
		<span class="cm">/* msgin_phase0,	phase:7 */</span>
		<span class="n">dc395x_statev</span> <span class="o">=</span> <span class="n">dc395x_scsi_phase0</span><span class="p">[</span><span class="n">phase</span><span class="p">];</span>
		<span class="n">dc395x_statev</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scsi_status</span><span class="p">);</span>

		<span class="cm">/* </span>
<span class="cm">		 * if there were any exception occurred scsi_status</span>
<span class="cm">		 * will be modify to bus free phase new scsi_status</span>
<span class="cm">		 * transfer out from ... previous dc395x_statev</span>
<span class="cm">		 */</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_phase</span> <span class="o">=</span> <span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">PHASEMASK</span><span class="p">;</span>
		<span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">PHASEMASK</span><span class="p">;</span>

		<span class="cm">/* </span>
<span class="cm">		 * call  dc395x_scsi_phase1[]... &quot;phase entry&quot; handle</span>
<span class="cm">		 * every phase to do transfer</span>
<span class="cm">		 */</span>
		<span class="cm">/* data_out_phase1,	phase:0 */</span>
		<span class="cm">/* data_in_phase1,	phase:1 */</span>
		<span class="cm">/* command_phase1,	phase:2 */</span>
		<span class="cm">/* status_phase1,	phase:3 */</span>
		<span class="cm">/* nop1,		phase:4 PH_BUS_FREE .. initial phase */</span>
		<span class="cm">/* nop1,		phase:5 PH_BUS_FREE .. initial phase */</span>
		<span class="cm">/* msgout_phase1,	phase:6 */</span>
		<span class="cm">/* msgin_phase1,	phase:7 */</span>
		<span class="n">dc395x_statev</span> <span class="o">=</span> <span class="n">dc395x_scsi_phase1</span><span class="p">[</span><span class="n">phase</span><span class="p">];</span>
		<span class="n">dc395x_statev</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scsi_status</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="nl">out_unlock:</span>
	<span class="n">DC395x_UNLOCK_IO</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dc395x_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scsi_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dma_status</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for pending interrupt</span>
<span class="cm">	 */</span>
	<span class="n">scsi_status</span> <span class="o">=</span> <span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_STATUS</span><span class="p">);</span>
	<span class="n">dma_status</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SCSIINTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* interrupt pending - let&#39;s process it! */</span>
		<span class="n">dc395x_handle_interrupt</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">scsi_status</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma_status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Error from the DMA engine */</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Interrupt from DMA engine: 0x%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_status</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		dprintkl(KERN_INFO, &quot;This means DMA error! Try to handle ...\n&quot;);</span>
<span class="c">		if (acb-&gt;active_dcb) {</span>
<span class="c">			acb-&gt;active_dcb-&gt; flag |= ABORT_DEV_;</span>
<span class="c">			if (acb-&gt;active_dcb-&gt;active_srb)</span>
<span class="c">				enable_msgout_abort(acb, acb-&gt;active_dcb-&gt;active_srb);</span>
<span class="c">		}</span>
<span class="c">		DC395x_write8(acb, TRM_S1040_DMA_CONTROL, ABORTXFER | CLRXFIFO);</span>
<span class="cp">#else</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Ignoring DMA error (probably a bad thing) ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">acb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgout_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgout_phase0: (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRB_UNEXPECT_RESEL</span> <span class="o">+</span> <span class="n">SRB_ABORT_SENT</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pscsi_status</span> <span class="o">=</span> <span class="n">PH_BUS_FREE</span><span class="p">;</span>	<span class="cm">/*.. initial phase */</span>

	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_MSGOUT</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgout_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgout_phase1: (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;msgout_phase1&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_MSGOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_MSGOUT</span><span class="p">;</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
			<span class="s">&quot;msgout_phase1: (0x%p) Phase unexpected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>	<span class="cm">/* So what ? */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgout_phase1: (0x%p) NOP msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="n">MSG_NOP</span><span class="p">);</span>
		<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">SCMD_FIFO_OUT</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MSG_ABORT</span><span class="p">)</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_ABORT_SENT</span><span class="p">;</span>

	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">SCMD_FIFO_OUT</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">command_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;command_phase0: (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">command_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;command_phase1: (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;command_phase1&quot;</span><span class="p">);</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_CLRATN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="n">REQUEST_SENSE</span><span class="p">);</span>
		<span class="n">dcb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="p">;</span>
		<span class="cm">/* target id */</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_COMMAND</span><span class="p">;</span>
	<span class="cm">/* it&#39;s important for atn stop */</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>
	<span class="cm">/* SCSI command */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">SCMD_FIFO_OUT</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Verify that the remaining space in the hw sg lists is the same as</span>
<span class="cm"> * the count of remaining bytes in srb-&gt;total_xfer_length</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sg_verify_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_SG</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">SGentry</span> <span class="o">*</span><span class="n">psge</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">;</span> <span class="n">psge</span><span class="o">++</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">psge</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">)</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_SG</span><span class="p">,</span>
			       <span class="s">&quot;Inconsistent SRB S/G lengths (Tot=%i, Count=%i) !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>			       
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Compute the next Scatter Gather list index and adjust its length</span>
<span class="cm"> * and address if necessary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sg_update_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">left</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xferred</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">-</span> <span class="n">left</span><span class="p">;</span> <span class="cm">/* bytes transferred */</span>
	<span class="k">struct</span> <span class="n">SGentry</span> <span class="o">*</span><span class="n">psge</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span> <span class="o">+</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span><span class="p">;</span>

	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span>
		<span class="s">&quot;sg_update_list: Transferred %i of %i bytes, %i remain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">xferred</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xferred</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* nothing to update since we did not transfer any data */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_verify_length</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>	<span class="cm">/* update remaining count */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xferred</span> <span class="o">&gt;=</span> <span class="n">psge</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Complete SG entries done */</span>
			<span class="n">xferred</span> <span class="o">-=</span> <span class="n">psge</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Partial SG entry done */</span>
			<span class="n">psge</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="n">xferred</span><span class="p">;</span>
			<span class="n">psge</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+=</span> <span class="n">xferred</span><span class="p">;</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
			<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span>
					    <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_bus_addr</span><span class="p">,</span>
					    <span class="n">SEGMENTX_LEN</span><span class="p">,</span>
					    <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">psge</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sg_verify_length</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * We have transferred a single byte (PIO mode?) and need to update</span>
<span class="cm"> * the count of bytes remaining (total_xfer_length) and update the sg</span>
<span class="cm"> * entry to either point to next byte in the current sg entry, or of</span>
<span class="cm"> * already at the end to point to the start of the next sg entry</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sg_subtract_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sg_update_list</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * cleanup_after_transfer</span>
<span class="cm"> * </span>
<span class="cm"> * Makes sure, DMA and SCSI engine are empty, after the transfer has finished</span>
<span class="cm"> * KG: Currently called from  StatusPhase1 ()</span>
<span class="cm"> * Should probably also be called from other places</span>
<span class="cm"> * Best might be to call it in DataXXPhase0, if new phase will differ </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_after_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*DC395x_write8 (TRM_S1040_DMA_STATUS, FORCEDMACOMP); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_COMMAND</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* read */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
			<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;cleanup/in&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONTROL</span><span class="p">,</span> <span class="n">CLRXFIFO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* write */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONTROL</span><span class="p">,</span> <span class="n">CLRXFIFO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
			<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;cleanup/out&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Those no of bytes will be transferred w/ PIO through the SCSI FIFO</span>
<span class="cm"> * Seems to be needed for unknown reasons; could be a hardware bug :-(</span>
<span class="cm"> */</span>
<span class="cp">#define DC395x_LASTPIO 4</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">data_out_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scsi_status</span> <span class="o">=</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">d_left_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;data_out_phase0: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * KG: We need to drain the buffers before we draw any conclusions!</span>
<span class="cm">	 * This means telling the DMA to push the rest into SCSI, telling</span>
<span class="cm">	 * SCSI to push the rest to the bus.</span>
<span class="cm">	 * However, the device might have been the one to stop us (phase</span>
<span class="cm">	 * change), and the data in transit just needs to be accounted so</span>
<span class="cm">	 * it can be retransmitted.)</span>
<span class="cm">	 */</span>
	<span class="cm">/* </span>
<span class="cm">	 * KG: Stop DMA engine pushing more data into the SCSI FIFO</span>
<span class="cm">	 * If we need more data, the DMA SG list will be freshly set up, anyway</span>
<span class="cm">	 */</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_PIO</span><span class="p">,</span> <span class="s">&quot;data_out_phase0: &quot;</span>
		<span class="s">&quot;DMA{fifocnt=0x%02x fifostat=0x%02x} &quot;</span>
		<span class="s">&quot;SCSI{fifocnt=0x%02x cnt=0x%06x status=0x%04x} total=0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOCNT</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOSTAT</span><span class="p">),</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">),</span>
		<span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">),</span> <span class="n">scsi_status</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONTROL</span><span class="p">,</span> <span class="n">STOPDMAXFER</span> <span class="o">|</span> <span class="n">CLRXFIFO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_XFERPAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">PARITYERROR</span><span class="p">)</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">PARITY_ERROR</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * KG: Right, we can&#39;t just rely on the SCSI_COUNTER, because this</span>
<span class="cm">		 * is the no of bytes it got from the DMA engine not the no it </span>
<span class="cm">		 * transferred successfully to the device. (And the difference could</span>
<span class="cm">		 * be as much as the FIFO size, I guess ...)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SCSIXFERDONE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * when data transfer from DMA FIFO to SCSI FIFO</span>
<span class="cm">			 * if there was some data left in SCSI FIFO</span>
<span class="cm">			 */</span>
			<span class="n">d_left_counter</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">)</span> <span class="o">&amp;</span>
				  <span class="mh">0x1F</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span>
				<span class="n">d_left_counter</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;data_out_phase0: FIFO contains %i %s</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;SCSI{fifocnt=0x%02x cnt=0x%08x} &quot;</span>
				<span class="s">&quot;DMA{fifocnt=0x%04x cnt=0x%02x ctr=0x%08x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">),</span>
				<span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;words&quot;</span> <span class="o">:</span> <span class="s">&quot;bytes&quot;</span><span class="p">,</span>
				<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">),</span>
				<span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">),</span>
				<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOCNT</span><span class="p">),</span>
				<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOSTAT</span><span class="p">),</span>
				<span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CXCNT</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * calculate all the residue data that not yet tranfered</span>
<span class="cm">		 * SCSI transfer counter + left in SCSI FIFO data</span>
<span class="cm">		 *</span>
<span class="cm">		 * .....TRM_S1040_SCSI_COUNTER (24bits)</span>
<span class="cm">		 * The counter always decrement by one for every SCSI byte transfer.</span>
<span class="cm">		 * .....TRM_S1040_SCSI_FIFOCNT ( 5bits)</span>
<span class="cm">		 * The counter is SCSI FIFO offset counter (in units of bytes or! words)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">&gt;</span> <span class="n">DC395x_LASTPIO</span><span class="p">)</span>
			<span class="n">d_left_counter</span> <span class="o">+=</span>
			    <span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">);</span>

		<span class="cm">/* Is this a good idea? */</span>
		<span class="cm">/*clear_fifo(acb, &quot;DOP1&quot;); */</span>
		<span class="cm">/* KG: What is this supposed to be useful for? WIDE padding stuff? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d_left_counter</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span>
		    <span class="o">&amp;&amp;</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d_left_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span>
				<span class="s">&quot;data_out_phase0: Discard 1 byte (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">scsi_status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * KG: Oops again. Same thinko as above: The SCSI might have been</span>
<span class="cm">		 * faster than the DMA engine, so that it ran out of data.</span>
<span class="cm">		 * In that case, we have to do just nothing! </span>
<span class="cm">		 * But: Why the interrupt: No phase change. No XFERCNT_2_ZERO. Or?</span>
<span class="cm">		 */</span>
		<span class="cm">/*</span>
<span class="cm">		 * KG: This is nonsense: We have been WRITING data to the bus</span>
<span class="cm">		 * If the SCSI engine has no bytes left, how should the DMA engine?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d_left_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * if transfer not yet complete</span>
<span class="cm">			 * there were some data residue in SCSI FIFO or</span>
<span class="cm">			 * SCSI transfer counter not empty</span>
<span class="cm">			 */</span>
			<span class="kt">long</span> <span class="n">oldxferred</span> <span class="o">=</span>
			    <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">-</span> <span class="n">d_left_counter</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sg_update_list</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">d_left_counter</span><span class="p">);</span>
			<span class="cm">/* KG: Most ugly hack! Apparently, this works around a chip bug */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span><span class="p">].</span><span class="n">length</span> <span class="o">==</span>
			     <span class="n">diff</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">))</span>
			    <span class="o">||</span> <span class="p">((</span><span class="n">oldxferred</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">diff</span><span class="p">))</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;data_out_phase0: &quot;</span>
					<span class="s">&quot;Work around chip bug (%i)?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="p">);</span>
				<span class="n">d_left_counter</span> <span class="o">=</span>
				    <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">-</span> <span class="n">diff</span><span class="p">;</span>
				<span class="n">sg_update_list</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">d_left_counter</span><span class="p">);</span>
				<span class="cm">/*srb-&gt;total_xfer_length -= diff; */</span>
				<span class="cm">/*srb-&gt;virt_addr += diff; */</span>
				<span class="cm">/*if (srb-&gt;cmd-&gt;use_sg) */</span>
				<span class="cm">/*      srb-&gt;sg_index++; */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pscsi_status</span> <span class="o">&amp;</span> <span class="n">PHASEMASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PH_DATA_OUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cleanup_after_transfer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">data_out_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;data_out_phase1: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;data_out_phase1&quot;</span><span class="p">);</span>
	<span class="cm">/* do prepare before transfer when data out phase */</span>
	<span class="n">data_io_transfer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">,</span> <span class="n">XFERDATAOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">data_in_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">scsi_status</span> <span class="o">=</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">;</span>

	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;data_in_phase0: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * KG: DataIn is much more tricky than DataOut. When the device is finished</span>
<span class="cm">	 * and switches to another phase, the SCSI engine should be finished too.</span>
<span class="cm">	 * But: There might still be bytes left in its FIFO to be fetched by the DMA</span>
<span class="cm">	 * engine and transferred to memory.</span>
<span class="cm">	 * We should wait for the FIFOs to be emptied by that (is there any way to </span>
<span class="cm">	 * enforce this?) and then stop the DMA engine, because it might think, that</span>
<span class="cm">	 * there are more bytes to follow. Yes, the device might disconnect prior to</span>
<span class="cm">	 * having all bytes transferred! </span>
<span class="cm">	 * Also we should make sure that all data from the DMA engine buffer&#39;s really</span>
<span class="cm">	 * made its way to the system memory! Some documentation on this would not</span>
<span class="cm">	 * seem to be a bad idea, actually.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_XFERPAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">d_left_counter</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc</span><span class="p">,</span> <span class="n">fc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">PARITYERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;data_in_phase0: (0x%p) &quot;</span>
				<span class="s">&quot;Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">PARITY_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * KG: We should wait for the DMA FIFO to be empty ...</span>
<span class="cm">		 * but: it would be better to wait first for the SCSI FIFO and then the</span>
<span class="cm">		 * the DMA FIFO to become empty? How do we know, that the device not already</span>
<span class="cm">		 * sent data to the FIFO in a MsgIn phase, eg.?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			int ctr = 6000000;</span>
<span class="c">			dprintkl(KERN_DEBUG,</span>
<span class="c">				&quot;DIP0: Wait for DMA FIFO to flush ...\n&quot;);</span>
<span class="c">			/*DC395x_write8  (TRM_S1040_DMA_CONTROL, STOPDMAXFER); */</span>
<span class="c">			/*DC395x_write32 (TRM_S1040_SCSI_COUNTER, 7); */</span>
<span class="c">			/*DC395x_write8  (TRM_S1040_SCSI_COMMAND, SCMD_DMA_IN); */</span>
<span class="c">			while (!</span>
<span class="c">			       (DC395x_read16(acb, TRM_S1040_DMA_FIFOSTAT) &amp;</span>
<span class="c">				0x80) &amp;&amp; --ctr);</span>
<span class="c">			if (ctr &lt; 6000000 - 1)</span>
<span class="c">				dprintkl(KERN_DEBUG</span>
<span class="c">				       &quot;DIP0: Had to wait for DMA ...\n&quot;);</span>
<span class="c">			if (!ctr)</span>
<span class="c">				dprintkl(KERN_ERR,</span>
<span class="c">				       &quot;Deadlock in DIP0 waiting for DMA FIFO empty!!\n&quot;);</span>
<span class="c">			/*DC395x_write32 (TRM_S1040_SCSI_COUNTER, 0); */</span>
<span class="cp">#endif</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;data_in_phase0: &quot;</span>
				<span class="s">&quot;DMA{fifocnt=0x%02x fifostat=0x%02x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOCNT</span><span class="p">),</span>
				<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOSTAT</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/* Now: Check remainig data: The SCSI counters should tell us ... */</span>
		<span class="n">sc</span> <span class="o">=</span> <span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">);</span>
		<span class="n">fc</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">);</span>
		<span class="n">d_left_counter</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">+</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span>
		       <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
			   <span class="mi">0</span><span class="p">));</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;data_in_phase0: &quot;</span>
			<span class="s">&quot;SCSI{fifocnt=0x%02x%s ctr=0x%08x} &quot;</span>
			<span class="s">&quot;DMA{fifocnt=0x%02x fifostat=0x%02x ctr=0x%08x} &quot;</span>
			<span class="s">&quot;Remain{totxfer=%i scsi_fifo+ctr=%i}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fc</span><span class="p">,</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;words&quot;</span> <span class="o">:</span> <span class="s">&quot;bytes&quot;</span><span class="p">,</span>
			<span class="n">sc</span><span class="p">,</span>
			<span class="n">fc</span><span class="p">,</span>
			<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_FIFOSTAT</span><span class="p">),</span>
			<span class="n">DC395x_read32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CXCNT</span><span class="p">),</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">,</span> <span class="n">d_left_counter</span><span class="p">);</span>
<span class="cp">#if DC395x_LASTPIO</span>
		<span class="cm">/* KG: Less than or equal to 4 bytes can not be transferred via DMA, it seems. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d_left_counter</span>
		    <span class="o">&amp;&amp;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">&lt;=</span> <span class="n">DC395x_LASTPIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">left_io</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">;</span>

			<span class="cm">/*u32 addr = (srb-&gt;segment_x[srb-&gt;sg_index].address); */</span>
			<span class="cm">/*sg_update_list (srb, d_left_counter); */</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_PIO</span><span class="p">,</span> <span class="s">&quot;data_in_phase0: PIO (%i %s) &quot;</span>
				   <span class="s">&quot;for remaining %i bytes:&quot;</span><span class="p">,</span>
				<span class="n">fc</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span>
				<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span> <span class="o">?</span>
				    <span class="s">&quot;words&quot;</span> <span class="o">:</span> <span class="s">&quot;bytes&quot;</span><span class="p">,</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span>
				<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG2</span><span class="p">,</span>
					      <span class="n">CFG2_WIDEFIFO</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">left_io</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">virt</span><span class="p">,</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">left_io</span><span class="p">;</span>
				<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">request_length</span> <span class="o">-</span> <span class="n">left_io</span><span class="p">;</span>

				<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
				<span class="cm">/* Assumption: it&#39;s inside one page as it&#39;s at most 4 bytes and</span>
<span class="cm">				   I just assume it&#39;s on a 4-byte boundary */</span>
				<span class="n">base</span> <span class="o">=</span> <span class="n">scsi_kmap_atomic_sg</span><span class="p">(</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">),</span>
							   <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">virt</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

				<span class="n">left_io</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>

				<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>
					<span class="n">byte</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">);</span>
					<span class="o">*</span><span class="n">virt</span><span class="o">++</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_PIO</span><span class="p">))</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

					<span class="n">d_left_counter</span><span class="o">--</span><span class="p">;</span>
					<span class="n">sg_subtract_one</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

					<span class="n">len</span><span class="o">--</span><span class="p">;</span>

					<span class="n">fc</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFOCNT</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">left_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">WARN_ON</span><span class="p">((</span><span class="n">fc</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="o">!</span><span class="n">d_left_counter</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Read the last byte ... */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">u8</span> <span class="n">byte</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">);</span>

						<span class="o">*</span><span class="n">virt</span><span class="o">++</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
						<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="o">--</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_PIO</span><span class="p">))</span>
							<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">scsi_kunmap_atomic_sg</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
				<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/*printk(&quot; %08x&quot;, *(u32*)(bus_to_virt (addr))); */</span>
			<span class="cm">/*srb-&gt;total_xfer_length = 0; */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_PIO</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* DC395x_LASTPIO */</span><span class="cp"></span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/*</span>
<span class="c">		 * KG: This was in DATAOUT. Does it also belong here?</span>
<span class="c">		 * Nobody seems to know what counter and fifo_cnt count exactly ...</span>
<span class="c">		 */</span>
<span class="c">		if (!(scsi_status &amp; SCSIXFERDONE)) {</span>
<span class="c">			/*</span>
<span class="c">			 * when data transfer from DMA FIFO to SCSI FIFO</span>
<span class="c">			 * if there was some data left in SCSI FIFO</span>
<span class="c">			 */</span>
<span class="c">			d_left_counter =</span>
<span class="c">			    (u32)(DC395x_read8(acb, TRM_S1040_SCSI_FIFOCNT) &amp;</span>
<span class="c">				  0x1F);</span>
<span class="c">			if (srb-&gt;dcb-&gt;sync_period &amp; WIDE_SYNC)</span>
<span class="c">				d_left_counter &lt;&lt;= 1;</span>
<span class="c">			/*</span>
<span class="c">			 * if WIDE scsi SCSI FIFOCNT unit is word !!!</span>
<span class="c">			 * so need to *= 2</span>
<span class="c">			 * KG: Seems to be correct ...</span>
<span class="c">			 */</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="cm">/* KG: This should not be needed any more! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d_left_counter</span> <span class="o">==</span> <span class="mi">0</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SCSIXFERCNT_2_ZERO</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			int ctr = 6000000;</span>
<span class="c">			u8 TempDMAstatus;</span>
<span class="c">			do {</span>
<span class="c">				TempDMAstatus =</span>
<span class="c">				    DC395x_read8(acb, TRM_S1040_DMA_STATUS);</span>
<span class="c">			} while (!(TempDMAstatus &amp; DMAXFERCOMP) &amp;&amp; --ctr);</span>
<span class="c">			if (!ctr)</span>
<span class="c">				dprintkl(KERN_ERR,</span>
<span class="c">				       &quot;Deadlock in DataInPhase0 waiting for DMA!!\n&quot;);</span>
<span class="c">			srb-&gt;total_xfer_length = 0;</span>
<span class="cp">#endif</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">=</span> <span class="n">d_left_counter</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* phase changed */</span>
			<span class="cm">/*</span>
<span class="cm">			 * parsing the case:</span>
<span class="cm">			 * when a transfer not yet complete </span>
<span class="cm">			 * but be disconnected by target</span>
<span class="cm">			 * if transfer not yet complete</span>
<span class="cm">			 * there were some data residue in SCSI FIFO or</span>
<span class="cm">			 * SCSI transfer counter not empty</span>
<span class="cm">			 */</span>
			<span class="n">sg_update_list</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">d_left_counter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* KG: The target may decide to disconnect: Empty FIFO before! */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pscsi_status</span> <span class="o">&amp;</span> <span class="n">PHASEMASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PH_DATA_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cleanup_after_transfer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">data_in_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;data_in_phase1: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">data_io_transfer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">,</span> <span class="n">XFERDATAIN</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">data_io_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> 
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="n">u16</span> <span class="n">io_dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bval</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span>
		<span class="s">&quot;data_io_transfer: (0x%p) &lt;%02i-%i&gt; %c len=%i, sg=(%i/%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
		<span class="p">((</span><span class="n">io_dir</span> <span class="o">&amp;</span> <span class="n">DMACMD_DIR</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;r&#39;</span> <span class="o">:</span> <span class="sc">&#39;w&#39;</span><span class="p">),</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span> <span class="o">==</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">tmp_srb</span><span class="p">)</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;data_io_transfer: Using tmp_srb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span> <span class="o">&gt;=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* can&#39;t happen? out of bounds error */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">&gt;</span> <span class="n">DC395x_LASTPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">dma_status</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_STATUS</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * KG: What should we do: Use SCSI Cmd 0x90/0x92?</span>
<span class="cm">		 * Maybe, even ABORTXFER would be appropriate</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_status</span> <span class="o">&amp;</span> <span class="n">XFERPENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;data_io_transfer: Xfer pending! &quot;</span>
				<span class="s">&quot;Expect trouble!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dump_register_info</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONTROL</span><span class="p">,</span> <span class="n">CLRXFIFO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* clear_fifo(acb, &quot;IO&quot;); */</span>
		<span class="cm">/* </span>
<span class="cm">		 * load what physical address of Scatter/Gather list table</span>
<span class="cm">		 * want to be transfer</span>
<span class="cm">		 */</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_DATA_XFER</span><span class="p">;</span>
		<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_XHIGHADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* with S/G */</span>
			<span class="n">io_dir</span> <span class="o">|=</span> <span class="n">DMACMD_SG</span><span class="p">;</span>
			<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_XLOWADDR</span><span class="p">,</span>
				       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_bus_addr</span> <span class="o">+</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">SGentry</span><span class="p">)</span> <span class="o">*</span>
				       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span><span class="p">);</span>
			<span class="cm">/* load how many bytes in the sg list table */</span>
			<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_XCNT</span><span class="p">,</span>
				       <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">-</span>
					      <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* without S/G */</span>
			<span class="n">io_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMACMD_SG</span><span class="p">;</span>
			<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_XLOWADDR</span><span class="p">,</span>
				       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">);</span>
			<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_XCNT</span><span class="p">,</span>
				       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* load total transfer length (24bits) max value 16Mbyte */</span>
		<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">,</span>
			       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">);</span>
		<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io_dir</span> <span class="o">&amp;</span> <span class="n">DMACMD_DIR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* read */</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span>
				      <span class="n">SCMD_DMA_IN</span><span class="p">);</span>
			<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_COMMAND</span><span class="p">,</span> <span class="n">io_dir</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_COMMAND</span><span class="p">,</span> <span class="n">io_dir</span><span class="p">);</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span>
				      <span class="n">SCMD_DMA_OUT</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="cp">#if DC395x_LASTPIO</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* The last four bytes: Do PIO */</span>
		<span class="cm">/* </span>
<span class="cm">		 * load what physical address of Scatter/Gather list table</span>
<span class="cm">		 * want to be transfer</span>
<span class="cm">		 */</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_DATA_XFER</span><span class="p">;</span>
		<span class="cm">/* load total transfer length (24bits) max value 16Mbyte */</span>
		<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">,</span>
			       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">);</span>
		<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io_dir</span> <span class="o">&amp;</span> <span class="n">DMACMD_DIR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* read */</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span>
				      <span class="n">SCMD_FIFO_IN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* write */</span>
			<span class="kt">int</span> <span class="n">ln</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">;</span>
			<span class="kt">size_t</span> <span class="n">left_io</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span>
				<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG2</span><span class="p">,</span>
				     <span class="n">CFG2_WIDEFIFO</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">left_io</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">virt</span><span class="p">,</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">left_io</span><span class="p">;</span>
				<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">request_length</span> <span class="o">-</span> <span class="n">left_io</span><span class="p">;</span>

				<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
				<span class="cm">/* Again, max 4 bytes */</span>
				<span class="n">base</span> <span class="o">=</span> <span class="n">scsi_kmap_atomic_sg</span><span class="p">(</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">),</span>
							   <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">virt</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

				<span class="n">left_io</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>

				<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_PIO</span><span class="p">))</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">virt</span><span class="p">);</span>

					<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="o">*</span><span class="n">virt</span><span class="o">++</span><span class="p">);</span>

					<span class="n">sg_subtract_one</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">scsi_kunmap_atomic_sg</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
				<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ln</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_PIO</span><span class="p">))</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot; |00&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/*DC395x_write32(acb, TRM_S1040_SCSI_COUNTER, ln); */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_PIO</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span>
					  <span class="n">SCMD_FIFO_OUT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* DC395x_LASTPIO */</span><span class="cp"></span>
	<span class="k">else</span> <span class="p">{</span>		<span class="cm">/* xfer pad */</span>
		<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="n">H_OVER_UNDER_RUN</span><span class="p">;</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">OVER_RUN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * KG: despite the fact that we are using 16 bits I/O ops</span>
<span class="cm">		 * the SCSI FIFO is only 8 bits according to the docs</span>
<span class="cm">		 * (we can set bit 1 in 0x8f to serialize FIFO access ...)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG2</span><span class="p">,</span>
				      <span class="n">CFG2_WIDEFIFO</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io_dir</span> <span class="o">&amp;</span> <span class="n">DMACMD_DIR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">);</span>
				<span class="n">data2</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Danger, Robinson: If you find KGs</span>
<span class="cm">				 * scattered over the wide disk, the driver</span>
<span class="cm">				 * or chip is to blame :-( */</span>
				<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="sc">&#39;K&#39;</span><span class="p">);</span>
				<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* Danger, Robinson: If you find a collection of Ks on your disk</span>
<span class="cm">			 * something broke :-( */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io_dir</span> <span class="o">&amp;</span> <span class="n">DMACMD_DIR</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">,</span> <span class="sc">&#39;K&#39;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_XFERPAD</span><span class="p">;</span>
		<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
		<span class="cm">/* SCSI command */</span>
		<span class="n">bval</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_dir</span> <span class="o">&amp;</span> <span class="n">DMACMD_DIR</span><span class="p">)</span> <span class="o">?</span> <span class="n">SCMD_FIFO_IN</span> <span class="o">:</span> <span class="n">SCMD_FIFO_OUT</span><span class="p">;</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">bval</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">status_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;status_phase0: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">end_message</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">);</span>	<span class="cm">/* get message */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_COMPLETED</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pscsi_status</span> <span class="o">=</span> <span class="n">PH_BUS_FREE</span><span class="p">;</span>	<span class="cm">/*.. initial phase */</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">SCMD_MSGACCEPT</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">status_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;status_phase1: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_STATUS</span><span class="p">;</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">SCMD_COMP</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Check if the message is complete */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">msgin_completed</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span> <span class="n">msgbuf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msgbuf</span> <span class="o">==</span> <span class="n">EXTENDED_MESSAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">msgbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msgbuf</span> <span class="o">&gt;=</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">msgbuf</span> <span class="o">&lt;=</span> <span class="mh">0x2f</span><span class="p">)</span>	<span class="cm">/* two byte messages */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* reject_msg */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">msgin_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MESSAGE_REJECT</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_MSGIN</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_MSGOUT</span><span class="p">;</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;msgin_reject: 0x%02x &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="nf">msgin_qtag</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_qtag: (0x%p) tag=%i srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">tag_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tag</span><span class="p">)))</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
			<span class="s">&quot;msgin_qtag: tag_mask=0x%08x does not reserve tag %i!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">tag_mask</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mingx0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">tag_number</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srb</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mingx0</span><span class="p">;</span>

	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_qtag: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">ABORT_DEV_</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*srb-&gt;state = SRB_ABORT_SENT; */</span>
		<span class="n">enable_msgout_abort</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_DISCONNECT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mingx0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_DATA_XFER</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span> <span class="o">=</span> <span class="n">srb</span><span class="p">;</span>
	<span class="cm">/* How can we make the DORS happy? */</span>
	<span class="k">return</span> <span class="n">srb</span><span class="p">;</span>

      <span class="nl">mingx0:</span>
	<span class="n">srb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">tmp_srb</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_UNEXPECT_RESEL</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span> <span class="o">=</span> <span class="n">srb</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_ABORT_TAG</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;msgin_qtag: Unknown tag %i - abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">srb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">reprogram_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_TARGETID</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_SYNC</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_OFFSET</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">);</span>
	<span class="n">set_xfer_rate</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* set async transfer mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgin_set_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="p">;</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;msgin_set_async: No sync transfers &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>

	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SYNC_NEGO_ENABLE</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">|=</span> <span class="n">SYNC_NEGO_DONE</span><span class="p">;</span>
	<span class="cm">/*dcb-&gt;sync_period &amp;= 0; */</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 200ns &lt;=&gt; 5 MHz */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_DO_SYNC_NEGO</span><span class="p">;</span>
	<span class="n">reprogram_regs</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGO_ENABLE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGO_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">build_wdtr</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_set_async(rej): Try WDTR anyway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* set sync transfer mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgin_set_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fact</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;msgin_set_sync: &lt;%02i&gt; Sync: %ins &quot;</span>
		<span class="s">&quot;(%02i.%01i MHz) Offset %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">250</span> <span class="o">/</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
		<span class="p">((</span><span class="mi">250</span> <span class="o">%</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_SYNC_NEGO</span><span class="p">))</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">)</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">bval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">clock_period</span><span class="p">[</span><span class="n">bval</span><span class="p">]</span>
			    <span class="o">||</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">&gt;</span>
			    <span class="n">clock_period</span><span class="p">[</span><span class="n">bval</span><span class="p">]))</span>
		<span class="n">bval</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">clock_period</span><span class="p">[</span><span class="n">bval</span><span class="p">])</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span>
			<span class="s">&quot;msgin_set_sync: Increase sync nego period to %ins</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">clock_period</span><span class="p">[</span><span class="n">bval</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock_period</span><span class="p">[</span><span class="n">bval</span><span class="p">];</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;=</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">|=</span> <span class="n">ALT_SYNC</span> <span class="o">|</span> <span class="n">bval</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">)</span>
		<span class="n">fact</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fact</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>

	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span>
		<span class="s">&quot;Target %02i: %s Sync: %ins Offset %i (%02i.%01i MB/s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="p">(</span><span class="n">fact</span> <span class="o">==</span> <span class="mi">500</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Wide16&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">,</span>
		<span class="p">(</span><span class="n">fact</span> <span class="o">/</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span><span class="p">),</span>
		<span class="p">((</span><span class="n">fact</span> <span class="o">%</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_DO_SYNC_NEGO</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Reply with corrected SDTR Message */</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;msgin_set_sync: answer w/%ins %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">|=</span> <span class="n">SYNC_NEGO_DONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGO_ENABLE</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGO_DONE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">build_wdtr</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_set_sync: Also try WDTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_DO_SYNC_NEGO</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">|=</span> <span class="n">SYNC_NEGO_DONE</span> <span class="o">|</span> <span class="n">SYNC_NEGO_ENABLE</span><span class="p">;</span>

	<span class="n">reprogram_regs</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">msgin_set_nowide</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;msgin_set_nowide: &lt;%02i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>

	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIDE_SYNC</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WIDE_NEGO_ENABLE</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">|=</span> <span class="n">WIDE_NEGO_DONE</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_DO_WIDE_NEGO</span><span class="p">;</span>
	<span class="n">reprogram_regs</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_ENABLE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">build_sdtr</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_set_nowide: Rejected. Try SDTR anyway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgin_set_wide</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wide</span> <span class="o">=</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_WIDE_NEGO</span>
		   <span class="o">&amp;&amp;</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">HCC_WIDE_CARD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;msgin_set_wide: &lt;%02i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wide</span><span class="p">)</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">wide</span><span class="p">;</span>
	<span class="cm">/* Completed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_DO_WIDE_NEGO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
			<span class="s">&quot;msgin_set_wide: Wide nego initiated &lt;%02i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_DO_WIDE_NEGO</span><span class="p">;</span>
		<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WIDE_NEGO_ENABLE</span> <span class="o">|</span> <span class="n">WIDE_NEGO_DONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">|=</span> <span class="n">WIDE_SYNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIDE_SYNC</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_DO_WIDE_NEGO</span><span class="p">;</span>
	<span class="cm">/*dcb-&gt;sync_mode &amp;= ~(WIDE_NEGO_ENABLE+WIDE_NEGO_DONE); */</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span>
		<span class="s">&quot;msgin_set_wide: Wide (%i bit) negotiated &lt;%02i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>
	<span class="n">reprogram_regs</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_ENABLE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_NEGO_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">build_sdtr</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_set_wide: Also try SDTR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * extended message codes:</span>
<span class="cm"> *</span>
<span class="cm"> *	code	description</span>
<span class="cm"> *</span>
<span class="cm"> *	02h	Reserved</span>
<span class="cm"> *	00h	MODIFY DATA  POINTER</span>
<span class="cm"> *	01h	SYNCHRONOUS DATA TRANSFER REQUEST</span>
<span class="cm"> *	03h	WIDE DATA TRANSFER REQUEST</span>
<span class="cm"> *   04h - 7Fh	Reserved</span>
<span class="cm"> *   80h - FFh	Vendor specific</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgin_phase0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_phase0: (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_FIFO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msgin_completed</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Now eval the msg */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DISCONNECT</span>:
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_DISCONNECT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SIMPLE_QUEUE_TAG</span>:
		<span class="k">case</span> <span class="n">HEAD_OF_QUEUE_TAG</span>:
		<span class="k">case</span> <span class="n">ORDERED_QUEUE_TAG</span>:
			<span class="n">srb</span> <span class="o">=</span>
			    <span class="n">msgin_qtag</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span>
					      <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MESSAGE_REJECT</span>:
			<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span>
				       <span class="n">DO_CLRATN</span> <span class="o">|</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>
			<span class="cm">/* A sync nego message was rejected ! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_DO_SYNC_NEGO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msgin_set_async</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* A wide nego message was rejected ! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_DO_WIDE_NEGO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msgin_set_nowide</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">enable_msgout_abort</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="cm">/*srb-&gt;state |= SRB_ABORT_SENT */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EXTENDED_MESSAGE</span>:
			<span class="cm">/* SDTR */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
			    <span class="o">&amp;&amp;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">EXTENDED_SDTR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msgin_set_sync</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* WDTR */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
			    <span class="o">&amp;&amp;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">EXTENDED_WDTR</span>
			    <span class="o">&amp;&amp;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* sanity check ... */</span>
				<span class="n">msgin_set_wide</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msgin_reject</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MSG_IGNOREWIDE</span>:
			<span class="cm">/* Discard  wide residual */</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_phase0: Ignore Wide Residual!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">COMMAND_COMPLETE</span>:
			<span class="cm">/* nothing has to be done */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SAVE_POINTERS</span>:
			<span class="cm">/*</span>
<span class="cm">			 * SAVE POINTER may be ignored as we have the struct</span>
<span class="cm">			 * ScsiReqBlk* associated with the scsi command.</span>
<span class="cm">			 */</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_phase0: (0x%p) &quot;</span>
				<span class="s">&quot;SAVE POINTER rem=%i Ignore</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESTORE_POINTERS</span>:
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_phase0: RESTORE POINTER. Ignore</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ABORT</span>:
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_phase0: (0x%p) &quot;</span>
				<span class="s">&quot;&lt;%02i-%i&gt; ABORT msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span>
				<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">ABORT_DEV_</span><span class="p">;</span>
			<span class="n">enable_msgout_abort</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* reject unknown messages */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IDENTIFY_BASE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_phase0: Identify msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">identify_msg</span><span class="p">;</span>
				<span class="n">DC395x_ENABLE_MSGOUT</span><span class="p">;</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_MSGOUT</span><span class="p">;</span>
				<span class="cm">/*break; */</span>
			<span class="p">}</span>
			<span class="n">msgin_reject</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Clear counter and MsgIn state */</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_MSGIN</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pscsi_status</span> <span class="o">=</span> <span class="n">PH_BUS_FREE</span><span class="p">;</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important ... you know! */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">SCMD_MSGACCEPT</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">msgin_phase1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;msgin_phase1: (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;msgin_phase1&quot;</span><span class="p">);</span>
	<span class="n">DC395x_write32</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COUNTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_MSGIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_DISCONNECT</span><span class="p">;</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SRB_MSGIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
	<span class="cm">/* SCSI command */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">SCMD_FIFO_IN</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">nop0</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">nop1</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">pscsi_status</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_xfer_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set all lun device&#39;s  period, offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">identify_msg</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current_sync_offset</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">==</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span><span class="p">;</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">;</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span><span class="p">;</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;disconnect: No such device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="cm">/* Suspend queue for a while */</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span>
		    <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
		    <span class="n">HZ</span> <span class="o">*</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">delay_time</span><span class="p">;</span>
		<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;disconnectEx&quot;</span><span class="p">);</span>
		<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_HWRESELECT</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">srb</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;disconnect: (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_phase</span> <span class="o">=</span> <span class="n">PH_BUS_FREE</span><span class="p">;</span>	<span class="cm">/* initial phase */</span>
	<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;disconnect&quot;</span><span class="p">);</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_HWRESELECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_UNEXPECT_RESEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span>
			<span class="s">&quot;disconnect: Unexpected reselection &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">waiting_process_next</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_ABORT_SENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ABORT_DEV_</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;disconnect: SRB_ABORT_SENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">doing_srb_done</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">DID_ABORT</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">waiting_process_next</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRB_START_</span> <span class="o">+</span> <span class="n">SRB_MSGOUT</span><span class="p">))</span>
		    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span>
			 <span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SRB_DISCONNECT</span> <span class="o">+</span> <span class="n">SRB_COMPLETED</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Selection time out </span>
<span class="cm">			 * SRB_START_ || SRB_MSGOUT || (!SRB_DISCONNECT &amp;&amp; !SRB_COMPLETED)</span>
<span class="cm">			 */</span>
			<span class="cm">/* Unexp. Disc / Sel Timeout */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SRB_START_</span>
			    <span class="o">&amp;&amp;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SRB_MSGOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_READY</span><span class="p">;</span>
				<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
					<span class="s">&quot;disconnect: (0x%p) Unexpected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="n">SCSI_STAT_SEL_TIMEOUT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">disc1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Normal selection timeout */</span>
				<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;disconnect: (0x%p) &quot;</span>
					<span class="s">&quot;&lt;%02i-%i&gt; SelTO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
					<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">DC395x_MAX_RETRIES</span>
				    <span class="o">||</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span>
					    <span class="n">SCSI_STAT_SEL_TIMEOUT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">disc1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">free_tag</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
				<span class="n">srb_going_to_waiting_move</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
				<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span>
					<span class="s">&quot;disconnect: (0x%p) Retry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="n">waiting_set_timer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">20</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">bval</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_SIGNAL</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * SRB_DISCONNECT (This is what we expect!)</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;disconnect: SCSI bus stat &quot;</span>
					<span class="s">&quot; 0x%02x: ACK set! Other controllers?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bval</span><span class="p">);</span>
				<span class="cm">/* It could come from another initiator, therefore don&#39;t do much ! */</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">waiting_process_next</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_COMPLETED</span><span class="p">)</span> <span class="p">{</span>
		      <span class="nl">disc1:</span>
			<span class="cm">/*</span>
<span class="cm">			 ** SRB_COMPLETED</span>
<span class="cm">			 */</span>
			<span class="n">free_tag</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_FREE</span><span class="p">;</span>
			<span class="n">srb_done</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">reselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rsel_tar_lun_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">arblostflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;reselect: acb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>

	<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;reselect&quot;</span><span class="p">);</span>
	<span class="cm">/*DC395x_write16(acb, TRM_S1040_SCSI_CONTROL, DO_HWRESELECT | DO_DATALATCH); */</span>
	<span class="cm">/* Read Reselected Target ID and LUN */</span>
	<span class="n">rsel_tar_lun_id</span> <span class="o">=</span> <span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_TARGETID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Arbitration lost but Reselection win */</span>
		<span class="n">srb</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;reselect: Arb lost Resel won, &quot;</span>
				<span class="s">&quot;but active_srb == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Why the if ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;reselect: (0x%p) &lt;%02i-%i&gt; &quot;</span>
				<span class="s">&quot;Arb lost but Resel win rsel=%i stat=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span>
				<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">rsel_tar_lun_id</span><span class="p">,</span>
				<span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_STATUS</span><span class="p">));</span>
			<span class="n">arblostflag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/*srb-&gt;state |= SRB_DISCONNECT; */</span>

			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_READY</span><span class="p">;</span>
			<span class="n">free_tag</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">srb_going_to_waiting_move</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">waiting_set_timer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">20</span><span class="p">);</span>

			<span class="cm">/* return; */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Read Reselected Target Id and LUN */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rsel_tar_lun_id</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IDENTIFY_BASE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)))</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;reselect: Expects identify msg. &quot;</span>
			<span class="s">&quot;Got %i!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rsel_tar_lun_id</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">rsel_tar_lun_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsel_tar_lun_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">dcb</span> <span class="o">=</span> <span class="n">find_dcb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;reselect: From non existent device &quot;</span>
			<span class="s">&quot;&lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>	<span class="cm">/* it&#39;s important for atn stop */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span> <span class="o">=</span> <span class="n">dcb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_DISCONNECT</span><span class="p">))</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;reselect: in spite of forbidden &quot;</span>
			<span class="s">&quot;disconnection? &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">EN_TAG_QUEUEING</span> <span class="cm">/*&amp;&amp; !arblostflag */</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">tmp_srb</span><span class="p">;</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span> <span class="o">=</span> <span class="n">srb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* There can be only one! */</span>
		<span class="n">srb</span> <span class="o">=</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SRB_DISCONNECT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * abort command</span>
<span class="cm">			 */</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
				<span class="s">&quot;reselect: w/o disconnected cmds &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
			<span class="n">srb</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">tmp_srb</span><span class="p">;</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_UNEXPECT_RESEL</span><span class="p">;</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span> <span class="o">=</span> <span class="n">srb</span><span class="p">;</span>
			<span class="n">enable_msgout_abort</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">ABORT_DEV_</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*srb-&gt;state = SRB_ABORT_SENT; */</span>
				<span class="n">enable_msgout_abort</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_DATA_XFER</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_phase</span> <span class="o">=</span> <span class="n">PH_BUS_FREE</span><span class="p">;</span>	<span class="cm">/* initial phase */</span>

	<span class="cm">/* Program HA ID, target ID, period and offset */</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;reselect: select &lt;%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_HOSTID</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>	<span class="cm">/* host   ID */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_TARGETID</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>		<span class="cm">/* target ID */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_OFFSET</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">);</span>		<span class="cm">/* offset    */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_SYNC</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span><span class="p">);</span>		<span class="cm">/* sync period, wide */</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_DATALATCH</span><span class="p">);</span>		<span class="cm">/* it&#39;s important for atn stop */</span>
	<span class="cm">/* SCSI command */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_COMMAND</span><span class="p">,</span> <span class="n">SCMD_MSGACCEPT</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">tagq_blacklist</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef DC395x_NO_TAGQ</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	u8 i;</span>
<span class="c">	for (i = 0; i &lt; BADDEVCNT; i++)</span>
<span class="c">		if (memcmp(name, DC395x_baddevname1[i], 28) == 0)</span>
<span class="c">			return 1;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">disc_tagq_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiInqData</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check for SCSI format (ANSI and Response data format) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">Vers</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">RDF</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">SCSI_INQ_CMDQUEUE</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_TAG_QUEUEING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="cm">/*(dcb-&gt;dev_mode &amp; NTC_DO_DISCONNECT) */</span>
		    <span class="cm">/* ((dcb-&gt;dev_type == TYPE_DISK) </span>
<span class="cm">		       || (dcb-&gt;dev_type == TYPE_MOD)) &amp;&amp; */</span>
		    <span class="o">!</span><span class="n">tagq_blacklist</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">max_command</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">max_command</span> <span class="o">=</span>
				    <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">tag_max_num</span><span class="p">;</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">|=</span> <span class="n">EN_TAG_QUEUEING</span><span class="p">;</span>
			<span class="cm">/*dcb-&gt;tag_mask = 0; */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">max_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiInqData</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bval1</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">DevType</span> <span class="o">&amp;</span> <span class="n">SCSI_DEVTYPE</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">bval1</span><span class="p">;</span>
	<span class="cm">/* if (bval1 == TYPE_DISK || bval1 == TYPE_MOD) */</span>
	<span class="n">disc_tagq_set</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* unmap mapped pci regions from SRB */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_unmap_srb</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">!=</span> <span class="n">PCI_DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unmap DC395x SG list */</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_SG</span><span class="p">,</span> <span class="s">&quot;pci_unmap_srb: list=%08x(%05x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_bus_addr</span><span class="p">,</span> <span class="n">SEGMENTX_LEN</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_bus_addr</span><span class="p">,</span>
				 <span class="n">SEGMENTX_LEN</span><span class="p">,</span>
				 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_SG</span><span class="p">,</span> <span class="s">&quot;pci_unmap_srb: segs=%i buffer=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="cm">/* unmap the sg segments */</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* unmap mapped pci sense buffer from SRB */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_unmap_srb_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Unmap sense buffer */</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_SG</span><span class="p">,</span> <span class="s">&quot;pci_unmap_srb_sense: buffer=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">);</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">,</span>
			 <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="cm">/* Restore SG stuff */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">xferred</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span>
	    <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="n">DC395x_MAX_SG_LISTENTRY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
	    <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="n">DC395x_MAX_SG_LISTENTRY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Complete execution of a SCSI command</span>
<span class="cm"> * Signal completion to the generic SCSI driver  </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">srb_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tempcnt</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ckc_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;srb_done: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_SG</span><span class="p">,</span> <span class="s">&quot;srb_done: srb=%p sg=%i(%i/%i) buf=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">srb</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">,</span>
		   <span class="n">scsi_sgtalbe</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">AUTO_REQSENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_done: AUTO_REQSENSE1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_unmap_srb_sense</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 ** target status..........................</span>
<span class="cm">		 */</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AUTO_REQSENSE</span><span class="p">;</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">NOT_READY</span>:
				<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
				     <span class="s">&quot;ReqSense: NOT_READY cmnd=0x%02x &lt;%02i-%i&gt; stat=%i scan=%i &quot;</span><span class="p">,</span>
				     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span>
				     <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">UNIT_ATTENTION</span>:
				<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
				     <span class="s">&quot;ReqSense: UNIT_ATTENTION cmnd=0x%02x &lt;%02i-%i&gt; stat=%i scan=%i &quot;</span><span class="p">,</span>
				     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span>
				     <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ILLEGAL_REQUEST</span>:
				<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
				     <span class="s">&quot;ReqSense: ILLEGAL_REQUEST cmnd=0x%02x &lt;%02i-%i&gt; stat=%i scan=%i &quot;</span><span class="p">,</span>
				     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span>
				     <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MEDIUM_ERROR</span>:
				<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
				     <span class="s">&quot;ReqSense: MEDIUM_ERROR cmnd=0x%02x &lt;%02i-%i&gt; stat=%i scan=%i &quot;</span><span class="p">,</span>
				     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span>
				     <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HARDWARE_ERROR</span>:
				<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
				     <span class="s">&quot;ReqSense: HARDWARE_ERROR cmnd=0x%02x &lt;%02i-%i&gt; stat=%i scan=%i &quot;</span><span class="p">,</span>
				     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span>
				     <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sense=0x%02x ASC=0x%02x ASCQ=0x%02x &quot;</span>
					<span class="s">&quot;(0x%08x 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
					<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)),</span>
					<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)));</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sense=0x%02x No ASC/ASCQ (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
					<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">ckc_e</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_done: AUTO_REQSENSE2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span>
		    <span class="o">&amp;&amp;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">&gt;=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
			    <span class="n">MK_RES_LNX</span><span class="p">(</span><span class="n">DRIVER_SENSE</span><span class="p">,</span> <span class="n">DID_OK</span><span class="p">,</span>
				       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">end_message</span><span class="p">,</span> <span class="n">CHECK_CONDITION</span><span class="p">);</span>
		<span class="cm">/*SET_RES_DID(cmd-&gt;result,DID_OK) */</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
			    <span class="n">MK_RES_LNX</span><span class="p">(</span><span class="n">DRIVER_SENSE</span><span class="p">,</span> <span class="n">DID_OK</span><span class="p">,</span>
				       <span class="n">srb</span><span class="o">-&gt;</span><span class="n">end_message</span><span class="p">,</span> <span class="n">CHECK_CONDITION</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">ckc_e</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*************************************************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * target status..........................</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status_byte</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">request_sense</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status_byte</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">QUEUE_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tempcnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">);</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;QUEUE_FULL for dev &lt;%02i-%i&gt; with %i cmnds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span> <span class="n">tempcnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">tempcnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">max_command</span> <span class="o">=</span> <span class="n">tempcnt</span><span class="p">;</span>
			<span class="n">free_tag</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">srb_going_to_waiting_move</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">waiting_set_timer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">20</span><span class="p">);</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SCSI_STAT_SEL_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="n">H_SEL_TIMEOUT</span><span class="p">;</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DID_ERROR</span><span class="p">);</span>
			<span class="n">SET_RES_MSG</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">end_message</span><span class="p">);</span>
			<span class="n">SET_RES_TARGET</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 ** process initiator status..........................</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">H_OVER_UNDER_RUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DID_OK</span><span class="p">);</span>
			<span class="n">SET_RES_MSG</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">end_message</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PARITY_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DID_PARITY</span><span class="p">);</span>
			<span class="n">SET_RES_MSG</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">end_message</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* No error */</span>

			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">SET_RES_DID</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">DID_OK</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">PCI_DMA_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
		<span class="n">pci_dma_sync_sg_for_cpu</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
					<span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">dir</span><span class="p">);</span>

	<span class="n">ckc_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* Check Error Conditions */</span>
      <span class="nl">ckc_e:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ScsiInqData</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scatterlist</span><span class="o">*</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ScsiInqData</span><span class="p">);</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">scsi_kmap_atomic_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ScsiInqData</span> <span class="o">*</span><span class="p">)(</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ckc_only</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">RES_DID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		    <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span>
		    <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">!=</span> <span class="n">PCI_DMA_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">ptr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">Vers</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">inquiry7</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">;</span>

	<span class="cm">/*if( srb-&gt;cmd-&gt;cmnd[0] == INQUIRY &amp;&amp; */</span>
	<span class="cm">/*  (host_byte(cmd-&gt;result) == DID_OK || status_byte(cmd-&gt;result) &amp; CHECK_CONDITION) ) */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">==</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		     <span class="o">||</span> <span class="n">status_byte</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">CHECK_CONDITION</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">init_tcq_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">add_dev</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
				<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">init_tcq_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">scsi_kunmap_atomic_sg</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Here is the info for Doug Gilbert&#39;s sg3 ... */</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">);</span>
	<span class="cm">/* This may be interpreted by sb. or not ... */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">this_residual</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">buffers_residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">)</span>
			<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_KG</span><span class="p">,</span> <span class="s">&quot;srb_done: (0x%p) &lt;%02i-%i&gt; &quot;</span>
				<span class="s">&quot;cmnd=0x%02x Missed %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">srb_going_remove</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="cm">/* Add to free list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span> <span class="o">==</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">tmp_srb</span><span class="p">)</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;srb_done: ERROR! Completed cmd with tmp_srb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;srb_done: (0x%p) done result=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
		<span class="n">srb_free_insert</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_unmap_srb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">waiting_process_next</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* abort all cmds in our queues */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">doing_srb_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">did_flag</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;doing_srb_done: pids &quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

			<span class="n">p</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">MK_RES</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">did_flag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;G:%p(%02i-%i) &quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
			       <span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">srb_going_remove</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">free_tag</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">srb_free_insert</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
			<span class="n">pci_unmap_srb_sense</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">pci_unmap_srb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* For new EH, we normally don&#39;t need to give commands back,</span>
<span class="cm">				 * as they all complete or all time out */</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">))</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> 
			       <span class="s">&quot;How could the ML send cmnds to the Going queue? &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">tag_mask</span><span class="p">)</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
			       <span class="s">&quot;tag_mask for &lt;%02i-%i&gt; should be empty, is %08x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span>
			       <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">tag_mask</span><span class="p">);</span>

		<span class="cm">/* Waiting queue */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">MK_RES</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">did_flag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;W:%p&lt;%02i-%i&gt;&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			       <span class="n">p</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">srb_waiting_remove</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">srb_free_insert</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
			<span class="n">pci_unmap_srb_sense</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">pci_unmap_srb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* For new EH, we normally don&#39;t need to give commands back,</span>
<span class="cm">				 * as they all complete or all time out */</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">))</span>
			<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;ML queued %i cmnds again to &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">),</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span>
			     <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ABORT_DEV_</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_scsi_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;reset_scsi_bus: acb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flag</span> <span class="o">|=</span> <span class="n">RESET_DEV</span><span class="p">;</span>	<span class="cm">/* RESET_DETECT, RESET_DONE, RESET_DEV */</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_RSTSCSI</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_SCSIRESET</span><span class="p">))</span>
		<span class="cm">/* nothing */</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_basic_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wval</span><span class="p">;</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_TIMEOUT</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">sel_timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">HCC_PARITY</span><span class="p">)</span>
		<span class="n">bval</span> <span class="o">=</span> <span class="n">PHASELATCH</span> <span class="o">|</span> <span class="n">INITIATOR</span> <span class="o">|</span> <span class="n">BLOCKRST</span> <span class="o">|</span> <span class="n">PARITYCHECK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bval</span> <span class="o">=</span> <span class="n">PHASELATCH</span> <span class="o">|</span> <span class="n">INITIATOR</span> <span class="o">|</span> <span class="n">BLOCKRST</span><span class="p">;</span>

	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG0</span><span class="p">,</span> <span class="n">bval</span><span class="p">);</span>

	<span class="cm">/* program configuration 1: Act_Neg (+ Act_Neg_Enh? + Fast_Filter? + DataDis?) */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>	<span class="cm">/* was 0x13: default */</span>
	<span class="cm">/* program Host ID                  */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_HOSTID</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>
	<span class="cm">/* set ansynchronous transfer       */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_OFFSET</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* Turn LED control off */</span>
	<span class="n">wval</span> <span class="o">=</span> <span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">,</span> <span class="n">wval</span><span class="p">);</span>
	<span class="cm">/* DMA config          */</span>
	<span class="n">wval</span> <span class="o">=</span> <span class="n">DC395x_read16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_FIFO_CTRL</span><span class="p">;</span>
	<span class="n">wval</span> <span class="o">|=</span>
	    <span class="n">DMA_FIFO_HALF_HALF</span> <span class="o">|</span> <span class="n">DMA_ENHANCE</span> <span class="cm">/*| DMA_MEM_MULTI_READ */</span> <span class="p">;</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONFIG</span><span class="p">,</span> <span class="n">wval</span><span class="p">);</span>
	<span class="cm">/* Clear pending interrupt status */</span>
	<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTSTATUS</span><span class="p">);</span>
	<span class="cm">/* Enable SCSI interrupt    */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTEN</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_INTEN</span><span class="p">,</span> <span class="n">EN_SCSIINTR</span> <span class="o">|</span> <span class="n">EN_DMAXFERERROR</span>
		      <span class="cm">/*| EN_DMAXFERABORT | EN_DMAXFERCOMP | EN_FORCEDMACOMP */</span>
		      <span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">scsi_reset_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;scsi_reset_detect: acb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>
	<span class="cm">/* delay half a second */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">);</span>

	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_RSTMODULE</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONTROL</span><span class="p">,</span> <span class="n">DMARESETMODULE</span><span class="p">);</span>
	<span class="cm">/*DC395x_write8(acb, TRM_S1040_DMA_CONTROL,STOPDMAXFER); */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="cm">/* Maybe we locked up the bus? Then lets wait even longer ... */</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span>
	    <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
	    <span class="n">HZ</span> <span class="o">*</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">delay_time</span><span class="p">;</span>

	<span class="n">clear_fifo</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="s">&quot;scsi_reset_detect&quot;</span><span class="p">);</span>
	<span class="n">set_basic_config</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="cm">/*1.25 */</span>
	<span class="cm">/*DC395x_write16(acb, TRM_S1040_SCSI_CONTROL, DO_HWRESELECT); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flag</span> <span class="o">&amp;</span> <span class="n">RESET_DEV</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* RESET_DETECT, RESET_DONE, RESET_DEV */</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flag</span> <span class="o">|=</span> <span class="n">RESET_DONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flag</span> <span class="o">|=</span> <span class="n">RESET_DETECT</span><span class="p">;</span>
		<span class="n">reset_dev_param</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
		<span class="n">doing_srb_done</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">DID_RESET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/*DC395x_RecoverSRB( acb ); */</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">waiting_process_next</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">request_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;request_sense: (0x%p) &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">AUTO_REQSENSE</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">target_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* KG: Can this prevent crap sense data ? */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>

	<span class="cm">/* Save some data */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="n">DC395x_MAX_SG_LISTENTRY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span>
	    <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="n">DC395x_MAX_SG_LISTENTRY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
	    <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">xferred</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span><span class="p">;</span>
	<span class="cm">/* srb-&gt;segment_x : a one entry of S/G list table */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">total_xfer_length</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
	<span class="cm">/* Map sense buffer */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span>
	    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
			   <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_SG</span><span class="p">,</span> <span class="s">&quot;request_sense: map buffer %p-&gt;%08x(%05x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">segment_x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span><span class="p">,</span>
	       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_scsi</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Should only happen, if sb. else grabs the bus */</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
			<span class="s">&quot;request_sense: (0x%p) failed &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
		<span class="n">srb_going_to_waiting_move</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">waiting_set_timer</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * device_alloc - Allocate a new device instance. This create the</span>
<span class="cm"> * devices instance and sets up all the data items. The adapter</span>
<span class="cm"> * instance is required to obtain confiuration information for this</span>
<span class="cm"> * device. This does *not* add this device to the adapters device</span>
<span class="cm"> * list.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter to obtain configuration information from.</span>
<span class="cm"> * @target: The target for the new device.</span>
<span class="cm"> * @lun: The lun for the new device.</span>
<span class="cm"> *</span>
<span class="cm"> * Return the new device if successful or NULL on failure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="nf">device_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">target</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">period_index</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">period</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;device_alloc: &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">acb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">);</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">active_srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">tag_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">max_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
<span class="cp">#ifndef DC395x_NO_DISCONNECT</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">identify_msg</span> <span class="o">=</span>
	    <span class="n">IDENTIFY</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_DISCONNECT</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">identify_msg</span> <span class="o">=</span> <span class="n">IDENTIFY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">cfg0</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">inquiry7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">=</span> <span class="n">clock_period</span><span class="p">[</span><span class="n">period_index</span><span class="p">];</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifndef DC395x_NO_WIDE</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_WIDE_NEGO</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">HCC_WIDE_CARD</span><span class="p">))</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">|=</span> <span class="n">WIDE_NEGO_ENABLE</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DC395x_NO_SYNC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_SYNC_NEGO</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="o">||</span> <span class="n">current_sync_offset</span><span class="p">)</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">|=</span> <span class="n">SYNC_NEGO_ENABLE</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy settings */</span>
		<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">==</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> 
		       <span class="s">&quot;device_alloc: &lt;%02i-%i&gt; copy from &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sync_mode</span><span class="p">;</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sync_period</span><span class="p">;</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">min_nego_period</span><span class="p">;</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">;</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">inquiry7</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">inquiry7</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dcb</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * adapter_add_device - Adds the device instance to the adaptor instance.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter device to be updated</span>
<span class="cm"> * @dcb: A newly created and initialised device instance to add.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* backpointer to adapter */</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">acb</span> <span class="o">=</span> <span class="n">acb</span><span class="p">;</span>
	
	<span class="cm">/* set run_robin to this device if it is currently empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">))</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_run_robin</span> <span class="o">=</span> <span class="n">dcb</span><span class="p">;</span>

	<span class="cm">/* add device to list */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">);</span>

	<span class="cm">/* update device maps */</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">[</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">][</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcb</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * adapter_remove_device - Removes the device instance from the adaptor</span>
<span class="cm"> * instance. The device instance is not check in any way or freed by this. </span>
<span class="cm"> * The caller is expected to take care of that. This will simply remove the</span>
<span class="cm"> * device from the adapters data strcutures.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter device to be updated</span>
<span class="cm"> * @dcb: A device that has previously been added to the adapter.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_remove_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;adapter_remove_device: &lt;%02i-%i&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>

	<span class="cm">/* fix up any pointers to this device that we have in the adapter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span> <span class="o">==</span> <span class="n">dcb</span><span class="p">)</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_run_robin</span> <span class="o">==</span> <span class="n">dcb</span><span class="p">)</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_run_robin</span> <span class="o">=</span> <span class="n">dcb_get_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>

	<span class="cm">/* unlink from list */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* clear map and children */</span>	
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">[</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">][</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">acb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * adapter_remove_and_free_device - Removes a single device from the adapter</span>
<span class="cm"> * and then frees the device information.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter device to be updated</span>
<span class="cm"> * @dcb: A device that has previously been added to the adapter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_remove_and_free_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;adapter_remove_and_free_device: &lt;%02i-%i&gt; &quot;</span>
		           <span class="s">&quot;Won&#39;t remove because of %i active requests.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span>
			   <span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter_remove_device</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dcb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * adapter_remove_and_free_all_devices - Removes and frees all of the</span>
<span class="cm"> * devices associated with the specified adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter from which all devices should be removed.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_remove_and_free_all_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span><span class="o">*</span> <span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;adapter_remove_and_free_all_devices: num=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">));</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">adapter_remove_and_free_device</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * dc395x_slave_alloc - Called by the scsi mid layer to tell us about a new</span>
<span class="cm"> * scsi device that we need to deal with. We allocate a new device and then</span>
<span class="cm"> * insert that device into the adapters device list.</span>
<span class="cm"> *</span>
<span class="cm"> * @scsi_device: The new scsi device that we need to handle.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dc395x_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">scsi_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)</span><span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>

	<span class="n">dcb</span> <span class="o">=</span> <span class="n">device_alloc</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">adapter_add_device</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * dc395x_slave_destroy - Called by the scsi mid layer to tell us about a</span>
<span class="cm"> * device that is going away.</span>
<span class="cm"> *</span>
<span class="cm"> * @scsi_device: The new scsi device that we need to handle.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dc395x_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">scsi_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)</span><span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span> <span class="o">=</span> <span class="n">find_dcb</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="p">)</span>
		<span class="n">adapter_remove_and_free_device</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>
<span class="p">}</span>




<span class="cm">/**</span>
<span class="cm"> * trms1040_wait_30us: wait for 30 us</span>
<span class="cm"> *</span>
<span class="cm"> * Waits for 30us (using the chip by the looks of it..)</span>
<span class="cm"> *</span>
<span class="cm"> * @io_port: base I/O address</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">trms1040_wait_30us</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ScsiPortStallExecution(30); wait 30 us */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_TIMER</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GTIMEOUT</span><span class="p">))</span>
		<span class="cm">/* nothing */</span> <span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * trms1040_write_cmd - write the secified command and address to</span>
<span class="cm"> * chip</span>
<span class="cm"> *</span>
<span class="cm"> * @io_port:	base I/O address</span>
<span class="cm"> * @cmd:	SB + op code (command) to send</span>
<span class="cm"> * @addr:	address to send</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">trms1040_write_cmd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">send_data</span><span class="p">;</span>

	<span class="cm">/* program SB + OP code */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_data</span> <span class="o">=</span> <span class="n">NVR_SELECT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>	<span class="cm">/* Start from bit 2 */</span>
			<span class="n">send_data</span> <span class="o">|=</span> <span class="n">NVR_BITOUT</span><span class="p">;</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">send_data</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">send_data</span> <span class="o">|</span> <span class="n">NVR_CLOCK</span><span class="p">),</span>
		     <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_data</span> <span class="o">=</span> <span class="n">NVR_SELECT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>	<span class="cm">/* Start from bit 6 */</span>
			<span class="n">send_data</span> <span class="o">|=</span> <span class="n">NVR_BITOUT</span><span class="p">;</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">send_data</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">send_data</span> <span class="o">|</span> <span class="n">NVR_CLOCK</span><span class="p">),</span>
		     <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">NVR_SELECT</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
	<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * trms1040_set_data - store a single byte in the eeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Called from write all to write a single byte into the SSEEPROM</span>
<span class="cm"> * Which is done one bit at a time.</span>
<span class="cm"> *</span>
<span class="cm"> * @io_port:	base I/O address</span>
<span class="cm"> * @addr:	offset into EEPROM</span>
<span class="cm"> * @byte:	bytes to write</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">trms1040_set_data</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">send_data</span><span class="p">;</span>

	<span class="cm">/* Send write command &amp; address */</span>
	<span class="n">trms1040_write_cmd</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* Write data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">byte</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_data</span> <span class="o">=</span> <span class="n">NVR_SELECT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* Start from bit 7 */</span>
			<span class="n">send_data</span> <span class="o">|=</span> <span class="n">NVR_BITOUT</span><span class="p">;</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">send_data</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">send_data</span> <span class="o">|</span> <span class="n">NVR_CLOCK</span><span class="p">),</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">NVR_SELECT</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
	<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>

	<span class="cm">/* Disable chip select */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
	<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">NVR_SELECT</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
	<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>

	<span class="cm">/* Wait for write ready */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">NVR_SELECT</span> <span class="o">|</span> <span class="n">NVR_CLOCK</span><span class="p">),</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">NVR_SELECT</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVR_BITIN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Disable chip select */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * trms1040_write_all - write 128 bytes to the eeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Write the supplied 128 bytes to the chips SEEPROM</span>
<span class="cm"> *</span>
<span class="cm"> * @eeprom:	the data to write</span>
<span class="cm"> * @io_port:	the base io port</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">trms1040_write_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">b_eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* Enable SEEPROM */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">)</span> <span class="o">|</span> <span class="n">EN_EEPROM</span><span class="p">),</span>
	     <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">);</span>

	<span class="cm">/* write enable */</span>
	<span class="n">trms1040_write_cmd</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
	<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>

	<span class="cm">/* write */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">b_eeprom</span><span class="o">++</span><span class="p">)</span>
		<span class="n">trms1040_set_data</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">b_eeprom</span><span class="p">);</span>

	<span class="cm">/* write disable */</span>
	<span class="n">trms1040_write_cmd</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
	<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>

	<span class="cm">/* Disable SEEPROM */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EN_EEPROM</span><span class="p">),</span>
	     <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * trms1040_get_data - get a single byte from the eeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Called from read all to read a single byte into the SSEEPROM</span>
<span class="cm"> * Which is done one bit at a time.</span>
<span class="cm"> *</span>
<span class="cm"> * @io_port:	base I/O address</span>
<span class="cm"> * @addr:	offset into SEEPROM</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the byte read.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">__devinit</span> <span class="nf">trms1040_get_data</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">read_byte</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Send read command &amp; address */</span>
	<span class="n">trms1040_write_cmd</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* read data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">NVR_SELECT</span> <span class="o">|</span> <span class="n">NVR_CLOCK</span><span class="p">),</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">NVR_SELECT</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>

		<span class="cm">/* Get data bit while falling edge */</span>
		<span class="n">read_byte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_byte</span> <span class="o">&amp;</span> <span class="n">NVR_BITIN</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">trms1040_wait_30us</span><span class="p">(</span><span class="n">io_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable chip select */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_NVRAM</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * trms1040_read_all - read all bytes from the eeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Read the 128 bytes from the SEEPROM.</span>
<span class="cm"> *</span>
<span class="cm"> * @eeprom:	where to store the data</span>
<span class="cm"> * @io_port:	the base io port</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">trms1040_read_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">b_eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* Enable SEEPROM */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">)</span> <span class="o">|</span> <span class="n">EN_EEPROM</span><span class="p">),</span>
	     <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">);</span>

	<span class="cm">/* read details */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="n">b_eeprom</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">b_eeprom</span> <span class="o">=</span> <span class="n">trms1040_get_data</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* Disable SEEPROM */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EN_EEPROM</span><span class="p">),</span>
	     <span class="n">io_port</span> <span class="o">+</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * check_eeprom - get and check contents of the eeprom</span>
<span class="cm"> *</span>
<span class="cm"> * Read seeprom 128 bytes into the memory provider in eeprom.</span>
<span class="cm"> * Checks the checksum and if it&#39;s not correct it uses a set of default</span>
<span class="cm"> * values.</span>
<span class="cm"> *</span>
<span class="cm"> * @eeprom:	caller allocated strcuture to read the eeprom data into</span>
<span class="cm"> * @io_port:	io port to read from</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">check_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">w_eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cksum</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">d_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">d_eeprom</span><span class="p">;</span>

	<span class="n">trms1040_read_all</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">io_port</span><span class="p">);</span>	<span class="cm">/* read eeprom */</span>

	<span class="n">cksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">w_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w_eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">eeprom</span><span class="p">;</span> <span class="n">w_addr</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span>
	     <span class="n">w_addr</span><span class="o">++</span><span class="p">,</span> <span class="n">w_eeprom</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cksum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">w_eeprom</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cksum</span> <span class="o">!=</span> <span class="mh">0x1234</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Checksum is wrong.</span>
<span class="cm">		 * Load a set of defaults into the eeprom buffer</span>
<span class="cm">		 */</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span>
			<span class="s">&quot;EEProm checksum error: using default values and options.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">sub_vendor_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">PCI_VENDOR_ID_TEKRAM</span><span class="p">;</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">sub_vendor_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">PCI_VENDOR_ID_TEKRAM</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">sub_sys_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">PCI_DEVICE_ID_TEKRAM_TRMS1040</span><span class="p">;</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">sub_sys_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">PCI_DEVICE_ID_TEKRAM_TRMS1040</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">sub_class</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">PCI_VENDOR_ID_TEKRAM</span><span class="p">;</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">PCI_VENDOR_ID_TEKRAM</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">PCI_DEVICE_ID_TEKRAM_TRMS1040</span><span class="p">;</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">PCI_DEVICE_ID_TEKRAM_TRMS1040</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">d_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d_eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">;</span>
		     <span class="n">d_addr</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">d_addr</span><span class="o">++</span><span class="p">,</span> <span class="n">d_eeprom</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">d_eeprom</span> <span class="o">=</span> <span class="mh">0x00000077</span><span class="p">;</span>	<span class="cm">/* cfg3,cfg2,period,cfg0 */</span>

		<span class="o">*</span><span class="n">d_eeprom</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x04000F07</span><span class="p">;</span>	<span class="cm">/* max_tag,delay_time,channel_cfg,scsi_id */</span>
		<span class="o">*</span><span class="n">d_eeprom</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00000015</span><span class="p">;</span>	<span class="cm">/* reserved1,boot_lun,boot_target,reserved0 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">d_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d_addr</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">d_addr</span><span class="o">++</span><span class="p">,</span> <span class="n">d_eeprom</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">d_eeprom</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

		<span class="cm">/* Now load defaults (maybe set by boot/module params) */</span>
		<span class="n">set_safe_settings</span><span class="p">();</span>
		<span class="n">fix_settings</span><span class="p">();</span>
		<span class="n">eeprom_override</span><span class="p">(</span><span class="n">eeprom</span><span class="p">);</span>

		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">cksum</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">w_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w_eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">eeprom</span><span class="p">;</span>
		     <span class="n">w_addr</span> <span class="o">&lt;</span> <span class="mi">63</span><span class="p">;</span> <span class="n">w_addr</span><span class="o">++</span><span class="p">,</span> <span class="n">w_eeprom</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cksum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">w_eeprom</span><span class="p">;</span>

		<span class="o">*</span><span class="n">w_eeprom</span> <span class="o">=</span> <span class="mh">0x1234</span> <span class="o">-</span> <span class="n">cksum</span><span class="p">;</span>
		<span class="n">trms1040_write_all</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">io_port</span><span class="p">);</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">delay_time</span> <span class="o">=</span> <span class="n">cfg_data</span><span class="p">[</span><span class="n">CFG_RESET_DELAY</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_safe_settings</span><span class="p">();</span>
		<span class="n">eeprom_index_to_delay</span><span class="p">(</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">eeprom_override</span><span class="p">(</span><span class="n">eeprom</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * print_eeprom_settings - output the eeprom settings</span>
<span class="cm"> * to the kernel log so people can see what they were.</span>
<span class="cm"> *</span>
<span class="cm"> * @eeprom: The eeprom data strucutre to show details for.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">print_eeprom_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Used settings: AdapterID=%02i, Speed=%i(%02i.%01iMHz), dev_mode=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">,</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">period</span><span class="p">,</span>
		<span class="n">clock_speed</span><span class="p">[</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">period</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
		<span class="n">clock_speed</span><span class="p">[</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">period</span><span class="p">]</span> <span class="o">%</span> <span class="mi">10</span><span class="p">,</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cfg0</span><span class="p">);</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;               AdaptMode=0x%02x, Tags=%i(%02i), DelayReset=%is</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">channel_cfg</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">max_tag</span><span class="p">,</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">max_tag</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">delay_time</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Free SG tables */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_sg_tables_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">srbs_per_page</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="o">/</span><span class="n">SEGMENTX_LEN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DC395x_MAX_SRB_CNT</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">srbs_per_page</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_x</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Allocate SG tables; as we have to pci_map them, an SG list (struct SGentry*)</span>
<span class="cm"> * should never cross a page boundary */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">adapter_sg_tables_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">mem_needed</span> <span class="o">=</span> <span class="p">(</span><span class="n">DC395x_MAX_SRB_CNT</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
	                            <span class="o">*</span><span class="n">SEGMENTX_LEN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_needed</span><span class="o">+</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">srbs_per_page</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="o">/</span><span class="n">SEGMENTX_LEN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">srb_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SGentry</span> <span class="o">*</span><span class="n">uninitialized_var</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DC395x_MAX_SRB_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;Allocate %i pages for SG tables</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pages</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter_sg_tables_free</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">,</span> <span class="s">&quot;Allocate %li bytes at %p for SG segments %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">srb_idx</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">srbs_per_page</span> <span class="o">&amp;&amp;</span> <span class="n">srb_idx</span> <span class="o">&lt;</span> <span class="n">DC395x_MAX_SRB_CNT</span><span class="p">)</span>
			<span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_array</span><span class="p">[</span><span class="n">srb_idx</span><span class="o">++</span><span class="p">].</span><span class="n">segment_x</span> <span class="o">=</span>
			    <span class="n">ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">*</span> <span class="n">DC395x_MAX_SG_LISTENTRY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">srbs_per_page</span><span class="p">)</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">.</span><span class="n">segment_x</span> <span class="o">=</span>
		    <span class="n">ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">DC395x_MAX_SG_LISTENTRY</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;No space for tmsrb SG table reserved?!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * adapter_print_config - print adapter connection and termination</span>
<span class="cm"> * config</span>
<span class="cm"> *</span>
<span class="cm"> * The io port in the adapter needs to have been set before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter to print the information for.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">adapter_print_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bval</span><span class="p">;</span>

	<span class="n">bval</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_GEN_STATUS</span><span class="p">);</span>
	<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;%sConnectors: &quot;</span><span class="p">,</span>
		<span class="p">((</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">WIDESCSI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;(Wide) &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">CON5068</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ext%s &quot;</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">EXT68HIGH</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;68&quot;</span> <span class="o">:</span> <span class="s">&quot;50&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">CON68</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;int68%s &quot;</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">INT68HIGH</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;(50)&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">CON50</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;int50 &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CON5068</span> <span class="o">|</span> <span class="n">CON50</span> <span class="o">|</span> <span class="n">CON68</span><span class="p">))</span> <span class="o">==</span>
	    <span class="mi">0</span> <span class="cm">/*(CON5068 | CON50 | CON68) */</span> <span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Oops! (All 3?) &quot;</span><span class="p">);</span>
	<span class="n">bval</span> <span class="o">=</span> <span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_GEN_CONTROL</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Termination: &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">DIS_TERM</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">AUTOTERM</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Auto &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">LOW8TERM</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Low &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&amp;</span> <span class="n">UP8TERM</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;High &quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * adapter_init_params - Initialize the various parameters in the</span>
<span class="cm"> * adapter structure. Note that the pointer to the scsi_host is set</span>
<span class="cm"> * early (when this instance is created) and the io_port and irq</span>
<span class="cm"> * values are set later after they have been reserved. This just gets</span>
<span class="cm"> * everything set to a good starting position.</span>
<span class="cm"> *</span>
<span class="cm"> * The eeprom structure in the adapter needs to have been set before</span>
<span class="cm"> * calling this function.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter to initialize.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">adapter_init_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* NOTE: acb-&gt;scsi_host is set at scsi_host/acb creation time */</span>
	<span class="cm">/* NOTE: acb-&gt;io_port_base is set at port registration time */</span>
	<span class="cm">/* NOTE: acb-&gt;io_port_len is set at port registration time */</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">);</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_run_robin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">active_dcb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_free_list</span><span class="p">);</span>
	<span class="cm">/*  temp SRB for Q tag used or abort command used  */</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">tmp_srb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">selto_timer</span><span class="p">);</span>

	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_count</span> <span class="o">=</span> <span class="n">DC395x_MAX_SRB_CNT</span><span class="p">;</span>

	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">sel_timeout</span> <span class="o">=</span> <span class="n">DC395x_SEL_TIMEOUT</span><span class="p">;</span>	<span class="cm">/* timeout=250ms */</span>
	<span class="cm">/* NOTE: acb-&gt;irq_level is set at IRQ registration time */</span>

	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">tag_max_num</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">max_tag</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">tag_max_num</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">tag_max_num</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">acb_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* RESET_DETECT, RESET_DONE, RESET_DEV */</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">gmode2</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">channel_cfg</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* NOTE: actually set in adapter_init_chip */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">channel_cfg</span> <span class="o">&amp;</span> <span class="n">NAC_SCANLUN</span><span class="p">)</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">lun_chk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">scan_devices</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">hostid_bit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DC395x_MAX_SCSI_ID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="cm">/* link static array of srbs into the srb free list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">srb_free_insert</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * adapter_init_host - Initialize the scsi host instance based on</span>
<span class="cm"> * values that we have already stored in the adapter instance. There&#39;s</span>
<span class="cm"> * some mention that a lot of these are deprecated, so we won&#39;t use</span>
<span class="cm"> * them (we&#39;ll use the ones in the adapter instance) but we&#39;ll fill</span>
<span class="cm"> * them in in case something else needs them.</span>
<span class="cm"> *</span>
<span class="cm"> * The eeprom structure, irq and io ports in the adapter need to have</span>
<span class="cm"> * been set before calling this function.</span>
<span class="cm"> *</span>
<span class="cm"> * @host: The scsi host instance to fill in the values for.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">adapter_init_scsi_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>
        
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">DC395x_MAX_CMD_QUEUE</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">DC395x_MAX_CMD_PER_LUN</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_base</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_len</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_base</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="o">--</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SCSI_MULTI_LUN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">channel_cfg</span> <span class="o">&amp;</span> <span class="n">NAC_SCANLUN</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * adapter_init_chip - Get the chip into a know state and figure out</span>
<span class="cm"> * some of the settings that apply to this adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * The io port in the adapter needs to have been set before calling</span>
<span class="cm"> * this function. The config will be configured correctly on return.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter which we are to init.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">adapter_init_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">NvRamType</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>
        
        <span class="cm">/* Mask all the interrupt */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_INTEN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTEN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Reset SCSI module */</span>
	<span class="n">DC395x_write16</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_RSTMODULE</span><span class="p">);</span>

	<span class="cm">/* Reset PCI/DMA module */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_CONTROL</span><span class="p">,</span> <span class="n">DMARESETMODULE</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* program configuration 0 */</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">HCC_AUTOTERM</span> <span class="o">|</span> <span class="n">HCC_PARITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_GEN_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WIDESCSI</span><span class="p">)</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">HCC_WIDE_CARD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">channel_cfg</span> <span class="o">&amp;</span> <span class="n">NAC_POWERON_SCSI_RESET</span><span class="p">)</span>
		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">|=</span> <span class="n">HCC_SCSI_RESET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">HCC_SCSI_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Performing initial SCSI bus reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONTROL</span><span class="p">,</span> <span class="n">DO_RSTSCSI</span><span class="p">);</span>

		<span class="cm">/*while (!( DC395x_read8(acb, TRM_S1040_SCSI_INTSTATUS) &amp; INT_SCSIRESET )); */</span>
		<span class="cm">/*spin_unlock_irq (&amp;io_request_lock); */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span>
		    <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
		    <span class="n">HZ</span> <span class="o">*</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">delay_time</span><span class="p">;</span>

		<span class="cm">/*spin_lock_irq (&amp;io_request_lock); */</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * init_adapter - Grab the resource for the card, setup the adapter</span>
<span class="cm"> * information, set the card into a known state, create the various</span>
<span class="cm"> * tables etc etc. This basically gets all adapter information all up</span>
<span class="cm"> * to date, initialised and gets the chip in sync with it.</span>
<span class="cm"> *</span>
<span class="cm"> * @host:	This hosts adapter structure</span>
<span class="cm"> * @io_port:	The base I/O port</span>
<span class="cm"> * @irq:	IRQ</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if the initialization succeeds, any other value on</span>
<span class="cm"> * failure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">adapter_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">io_port_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">io_port</span><span class="p">,</span> <span class="n">io_port_len</span><span class="p">,</span> <span class="n">DC395X_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to reserve IO region 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io_port</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* store port base to indicate we have registered it */</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_base</span> <span class="o">=</span> <span class="n">io_port</span><span class="p">;</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_len</span> <span class="o">=</span> <span class="n">io_port_len</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dc395x_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DC395X_NAME</span><span class="p">,</span> <span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
	    	<span class="cm">/* release the region we just claimed */</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Failed to register IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* store irq to indicate we have registered it */</span>
	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">irq_level</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* get eeprom configuration information and command line settings etc */</span>
	<span class="n">check_eeprom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">io_port</span><span class="p">);</span>
 	<span class="n">print_eeprom_settings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">);</span>

	<span class="cm">/* setup adapter control block */</span>	
	<span class="n">adapter_init_params</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	
	<span class="cm">/* display card connectors/termination settings */</span>
 	<span class="n">adapter_print_config</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter_sg_tables_alloc</span><span class="p">(</span><span class="n">acb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;Memory allocation for SG tables failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter_init_scsi_host</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
	<span class="n">adapter_init_chip</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">set_basic_config</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>

	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span>
		<span class="s">&quot;adapter_init: acb=%p, pdcb_map=%p psrb_array=%p &quot;</span>
		<span class="s">&quot;size{acb=0x%04x dcb=0x%04x srb=0x%04x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">acb</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">srb_array</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">DeviceCtlBlk</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ScsiReqBlk</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_base</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_base</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_len</span><span class="p">);</span>
	<span class="n">adapter_sg_tables_free</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * adapter_uninit_chip - cleanly shut down the scsi controller chip,</span>
<span class="cm"> * stopping all operations and disabling interrupt generation on the</span>
<span class="cm"> * card.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter which we are to shutdown.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_uninit_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable interrupts */</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_DMA_INTEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DC395x_write8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* reset the scsi bus */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">HCC_SCSI_RESET</span><span class="p">)</span>
		<span class="n">reset_scsi_bus</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>

	<span class="cm">/* clear any pending interrupt state */</span>
	<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_INTSTATUS</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * adapter_uninit - Shut down the chip and release any resources that</span>
<span class="cm"> * we had allocated. Once this returns the adapter should not be used</span>
<span class="cm"> * anymore.</span>
<span class="cm"> *</span>
<span class="cm"> * @acb: The adapter which we are to un-initialize.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adapter_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">DC395x_LOCK_IO</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* remove timers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">selto_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">selto_timer</span><span class="p">);</span>

	<span class="n">adapter_uninit_chip</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">adapter_remove_and_free_all_devices</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">DC395x_UNLOCK_IO</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_base</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_base</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_len</span><span class="p">);</span>

	<span class="n">adapter_sg_tables_free</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#undef SPRINTF</span>
<span class="cp">#define SPRINTF(args...) pos += sprintf(pos, args)</span>

<span class="cp">#undef YESNO</span>
<span class="cp">#define YESNO(YN) \</span>
<span class="cp"> if (YN) SPRINTF(&quot; Yes &quot;);\</span>
<span class="cp"> else SPRINTF(&quot; No  &quot;)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dc395x_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spd</span><span class="p">,</span> <span class="n">spd1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">DeviceCtlBlk</span> <span class="o">*</span><span class="n">dcb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inout</span><span class="p">)</span>		<span class="cm">/* Has data been written to the file ? */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="n">DC395X_BANNER</span> <span class="s">&quot; PCI SCSI Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot; Driver Version &quot;</span> <span class="n">DC395X_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">DC395x_LOCK_IO</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;SCSI Host Nr %i, &quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DC395U/UW/F DC315/U %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">HCC_WIDE_CARD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Wide&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;io_port_base 0x%04lx, &quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">io_port_base</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;irq_level 0x%04x, &quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">irq_level</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot; SelTimeout %ims</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1638</span> <span class="o">*</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">sel_timeout</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;MaxID %i, MaxLUN %i, &quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;AdapterID %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span><span class="p">);</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;tag_max_num %i&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">tag_max_num</span><span class="p">);</span>
	<span class="cm">/*SPRINTF(&quot;, DMA_Status %i\n&quot;, DC395x_read8(acb, TRM_S1040_DMA_STATUS)); */</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;, FilterCfg 0x%02x&quot;</span><span class="p">,</span>
		<span class="n">DC395x_read8</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">TRM_S1040_SCSI_CONFIG1</span><span class="p">));</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;, DelayReset %is</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">delay_time</span><span class="p">);</span>
	<span class="cm">/*SPRINTF(&quot;\n&quot;); */</span>

	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;Nr of DCBs: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">));</span>
	<span class="n">SPRINTF</span>
	    <span class="p">(</span><span class="s">&quot;Map of attached LUNs: %02x %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	     <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	     <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">SPRINTF</span>
	    <span class="p">(</span><span class="s">&quot;                      %02x %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
	     <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
	     <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_map</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>

	<span class="n">SPRINTF</span>
	    <span class="p">(</span><span class="s">&quot;Un ID LUN Prty Sync Wide DsCn SndS TagQ nego_period SyncFreq SyncOffs MaxCmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nego_period</span><span class="p">;</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;%02i %02i  %02i &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span>
			<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">);</span>
		<span class="n">YESNO</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_PARITY_CHK</span><span class="p">);</span>
		<span class="n">YESNO</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">);</span>
		<span class="n">YESNO</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="n">WIDE_SYNC</span><span class="p">);</span>
		<span class="n">YESNO</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_DISCONNECT</span><span class="p">);</span>
		<span class="n">YESNO</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">dev_mode</span> <span class="o">&amp;</span> <span class="n">NTC_DO_SEND_START</span><span class="p">);</span>
		<span class="n">YESNO</span><span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">EN_TAG_QUEUEING</span><span class="p">);</span>
		<span class="n">nego_period</span> <span class="o">=</span> <span class="n">clock_period</span><span class="p">[</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_period</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span><span class="p">)</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;  %03i ns &quot;</span><span class="p">,</span> <span class="n">nego_period</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot; (%03i ns)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">min_nego_period</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spd</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="n">nego_period</span><span class="p">);</span>
			<span class="n">spd1</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">%</span> <span class="p">(</span><span class="n">nego_period</span><span class="p">);</span>
			<span class="n">spd1</span> <span class="o">=</span> <span class="p">(</span><span class="n">spd1</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">nego_period</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nego_period</span><span class="p">);</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;   %2i.%1i M     %02i &quot;</span><span class="p">,</span> <span class="n">spd</span><span class="p">,</span> <span class="n">spd1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">sync_offset</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;                 &quot;</span><span class="p">);</span>

		<span class="cm">/* Add more info ... */</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;     %02i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">max_command</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">waiting_timer</span><span class="p">))</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;Waiting queue timer running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ScsiReqBlk</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">))</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DCB (%02i-%i): Waiting: %i:&quot;</span><span class="p">,</span>
				<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span>
				<span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">));</span>
                <span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot; %p&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">))</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">DCB (%02i-%i): Going  : %i:&quot;</span><span class="p">,</span>
				<span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">,</span> <span class="n">dcb</span><span class="o">-&gt;</span><span class="n">target_lun</span><span class="p">,</span>
				<span class="n">list_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">));</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot; %p&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_waiting_list</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">srb_going_list</span><span class="p">))</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_enabled</span><span class="p">(</span><span class="n">DBG_1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;DCB list for ACB %p:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">dcb_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;%p -&gt; &quot;</span><span class="p">,</span> <span class="n">dcb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;END</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">DC395x_UNLOCK_IO</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">buffer</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">buffer</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">buffer</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">dc395x_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>                 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>              <span class="o">=</span> <span class="n">DC395X_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span>              <span class="o">=</span> <span class="n">dc395x_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>                   <span class="o">=</span> <span class="n">DC395X_BANNER</span> <span class="s">&quot; &quot;</span> <span class="n">DC395X_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>           <span class="o">=</span> <span class="n">dc395x_queue_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>             <span class="o">=</span> <span class="n">dc395x_bios_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>            <span class="o">=</span> <span class="n">dc395x_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>          <span class="o">=</span> <span class="n">dc395x_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>              <span class="o">=</span> <span class="n">DC395x_MAX_CAN_QUEUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>                <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>           <span class="o">=</span> <span class="n">DC395x_MAX_SG_TABLESIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>            <span class="o">=</span> <span class="n">DC395x_MAX_CMD_PER_LUN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>       <span class="o">=</span> <span class="n">dc395x_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>   <span class="o">=</span> <span class="n">dc395x_eh_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>         <span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * banner_display - Display banner on first instance of driver</span>
<span class="cm"> * initialized.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">banner_display</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">banner_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">banner_done</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DC395X_BANNER</span><span class="p">,</span> <span class="n">DC395X_VERSION</span><span class="p">);</span>
		<span class="n">banner_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * dc395x_init_one - Initialise a single instance of the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * The PCI layer will call this once for each instance of the adapter</span>
<span class="cm"> * that it finds in the system. The pci_dev strcuture indicates which</span>
<span class="cm"> * instance we are being called from.</span>
<span class="cm"> * </span>
<span class="cm"> * @dev: The PCI device to initialize.</span>
<span class="cm"> * @id: Looks like a pointer to the entry in our pci device table</span>
<span class="cm"> * that was actually matched by the PCI subsystem.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or an error code (-ve) on failure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dc395x_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_port_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_port_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;Init one instance (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">banner_display</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;PCI Enable device failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">io_port_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_IO_MASK</span><span class="p">;</span>
	<span class="n">io_port_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;IO_PORT=0x%04lx, IRQ=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io_port_base</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* allocate scsi host information (includes out adapter) */</span>
	<span class="n">scsi_host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc395x_driver_template</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;scsi_host_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
 	<span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span><span class="o">*</span><span class="p">)</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
 	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="n">scsi_host</span><span class="p">;</span>
 	<span class="n">acb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* initialise the adapter and everything we need */</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">adapter_init</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="n">io_port_base</span><span class="p">,</span> <span class="n">io_port_len</span><span class="p">,</span> <span class="n">irq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;adapter init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* get the scsi mid level to scan for new devices on the bus */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_add_host</span><span class="p">(</span><span class="n">scsi_host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintkl</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;scsi_add_host failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">scsi_host</span><span class="p">);</span>
	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">scsi_host</span><span class="p">);</span>
        	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">adapter_uninit</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_host</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">scsi_host</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * dc395x_remove_one - Called to remove a single instance of the</span>
<span class="cm"> * adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * @dev: The PCI device to initialize.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">dc395x_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">AdapterCtlBlk</span> <span class="o">*</span><span class="p">)(</span><span class="n">scsi_host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>

	<span class="n">dprintkdbg</span><span class="p">(</span><span class="n">DBG_0</span><span class="p">,</span> <span class="s">&quot;dc395x_remove_one: acb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">acb</span><span class="p">);</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">scsi_host</span><span class="p">);</span>
	<span class="n">adapter_uninit</span><span class="p">(</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">scsi_host</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">dc395x_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_TEKRAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_TEKRAM_TRMS1040</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{}</span>			<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">dc395x_pci_table</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">dc395x_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="n">DC395X_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">dc395x_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">dc395x_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">dc395x_remove_one</span><span class="p">),</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * dc395x_module_init - Module initialization function</span>
<span class="cm"> *</span>
<span class="cm"> * Used by both module and built-in driver to initialise this driver.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dc395x_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc395x_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * dc395x_module_exit - Module cleanup function.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dc395x_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc395x_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">dc395x_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dc395x_module_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;C.L. Huang / Erich Chen / Kurt Garloff&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SCSI host adapter driver for Tekram TRM-S1040 based adapters: Tekram DC395 and DC315 series&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
