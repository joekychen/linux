<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › lpfc › lpfc_mbox.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lpfc_mbox.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex Linux Device Driver for         *</span>
<span class="cm"> * Fibre Channel Host Bus Adapters.                                *</span>
<span class="cm"> * Copyright (C) 2004-2009 Emulex.  All rights reserved.           *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> * Portions Copyright (C) 2004-2005 Christoph Hellwig              *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fs.h&gt;</span>

<span class="cp">#include &quot;lpfc_hw4.h&quot;</span>
<span class="cp">#include &quot;lpfc_hw.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli4.h&quot;</span>
<span class="cp">#include &quot;lpfc_nl.h&quot;</span>
<span class="cp">#include &quot;lpfc_disc.h&quot;</span>
<span class="cp">#include &quot;lpfc_scsi.h&quot;</span>
<span class="cp">#include &quot;lpfc.h&quot;</span>
<span class="cp">#include &quot;lpfc_logmsg.h&quot;</span>
<span class="cp">#include &quot;lpfc_crtn.h&quot;</span>
<span class="cp">#include &quot;lpfc_compat.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_dump_static_vport - Dump HBA&#39;s static vport information.</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> * @offset: offset for dumping vport info.</span>
<span class="cm"> *</span>
<span class="cm"> * The dump mailbox command provides a method for the device driver to obtain</span>
<span class="cm"> * various types of information from the HBA device.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for dumping list of static</span>
<span class="cm"> * vports to be created.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_dump_static_vport</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">,</span>
		<span class="kt">uint16_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>

	<span class="cm">/* Setup to dump vport info region */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_DUMP_MEMORY</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DMP_NV_PARAMS</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">entry_index</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">region_id</span> <span class="o">=</span> <span class="n">DMP_REGION_VPORT</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>

	<span class="cm">/* For SLI3 HBAs data is embedded in mailbox */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">!=</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">cv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">word_cnt</span> <span class="o">=</span> <span class="n">DMP_RSP_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For SLI4 HBAs driver need to allocate memory */</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span> <span class="o">||</span> <span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
			<span class="s">&quot;2605 lpfc_dump_static_vport: memory&quot;</span>
			<span class="s">&quot; allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LPFC_BPL_SIZE</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="cm">/* save address for completion */</span>
	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mp</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">sli4_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">static_vport_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_down_link - Bring down HBAs link.</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares a mailbox command to bring down HBA link.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_down_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_DOWN_LINK</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_dump_mem - Prepare a mailbox command for reading a region.</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> * @offset: offset into the region.</span>
<span class="cm"> * @region_id: config region id.</span>
<span class="cm"> *</span>
<span class="cm"> * The dump mailbox command provides a method for the device driver to obtain</span>
<span class="cm"> * various types of information from the HBA device.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for dumping HBA&#39;s config region.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_dump_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">offset</span><span class="p">,</span>
		<span class="kt">uint16_t</span> <span class="n">region_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>

	<span class="cm">/* Setup to dump VPD region */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_DUMP_MEMORY</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">cv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DMP_NV_PARAMS</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">entry_index</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">region_id</span> <span class="o">=</span> <span class="n">region_id</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">word_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">DMP_RSP_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">co</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">resp_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_dump_wakeup_param - Prepare mailbox command for retrieving wakeup params</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This function create a dump memory mailbox command to dump wake up</span>
<span class="cm"> * parameters.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">lpfc_dump_wakeup_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="cm">/* Save context so that we can restore after memset */</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>

	<span class="cm">/* Setup to dump VPD region */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_DUMP_MEMORY</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">cv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DMP_NV_PARAMS</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">entry_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">region_id</span> <span class="o">=</span> <span class="n">WAKE_UP_PARMS_REGION_ID</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">word_cnt</span> <span class="o">=</span> <span class="n">WAKE_UP_PARMS_WORD_SIZE</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">co</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">resp_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_read_nv - Prepare a mailbox command for reading HBA&#39;s NVRAM param</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The read NVRAM mailbox command returns the HBA&#39;s non-volatile parameters</span>
<span class="cm"> * that are used as defaults when the Fibre Channel link is brought on-line.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for reading information stored</span>
<span class="cm"> * in the HBA&#39;s NVRAM. Specifically, the HBA&#39;s WWNN and WWPN.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_read_nv</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_READ_NV</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_config_async - Prepare a mailbox command for enabling HBA async event</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> * @ring: ring number for the asynchronous event to be configured.</span>
<span class="cm"> *</span>
<span class="cm"> * The asynchronous event enable mailbox command is used to enable the</span>
<span class="cm"> * asynchronous event posting via the ASYNC_STATUS_CN IOCB response and</span>
<span class="cm"> * specifies the default ring to which events are posted.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for enabling HBA asynchronous</span>
<span class="cm"> * event support on a IOCB ring.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_config_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_ASYNCEVT_ENABLE</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgAsyncEvent</span><span class="p">.</span><span class="n">ring</span> <span class="o">=</span> <span class="n">ring</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_heart_beat - Prepare a mailbox command for heart beat</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The heart beat mailbox command is used to detect an unresponsive HBA, which</span>
<span class="cm"> * is defined as any device where no error attention is sent and both mailbox</span>
<span class="cm"> * and rings are not processed.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for issuing a heart beat in the</span>
<span class="cm"> * form of mailbox command to the HBA. The timely completion of the heart</span>
<span class="cm"> * beat mailbox command indicates the health of the HBA.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_heart_beat</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_HEARTBEAT</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_read_topology - Prepare a mailbox command for reading HBA topology</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> * @mp: DMA buffer memory for reading the link attention information into.</span>
<span class="cm"> *</span>
<span class="cm"> * The read topology mailbox command is issued to read the link topology</span>
<span class="cm"> * information indicated by the HBA port when the Link Event bit of the Host</span>
<span class="cm"> * Attention (HSTATT) register is set to 1 (For SLI-3) or when an FC Link</span>
<span class="cm"> * Attention ACQE is received from the port (For SLI-4). A Link Event</span>
<span class="cm"> * Attention occurs based on an exception detected at the Fibre Channel link</span>
<span class="cm"> * interface.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for reading HBA link topology</span>
<span class="cm"> * information. A DMA memory has been set aside and address passed to the</span>
<span class="cm"> * HBA through @mp for the HBA to DMA link attention information into the</span>
<span class="cm"> * memory as part of the execution of the mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * Return codes</span>
<span class="cm"> *    0 - Success (currently always return 0)</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_read_topology</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span><span class="p">;</span>

	<span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_READ_TOPOLOGY</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varReadTop</span><span class="p">.</span><span class="n">lilpBde64</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">LPFC_ALPA_MAP_SIZE</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varReadTop</span><span class="p">.</span><span class="n">lilpBde64</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varReadTop</span><span class="p">.</span><span class="n">lilpBde64</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="cm">/* Save address for later completion and set the owner to host so that</span>
<span class="cm">	 * the FW knows this mailbox is available for processing.</span>
<span class="cm">	 */</span>
	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_clear_la - Prepare a mailbox command for clearing HBA link attention</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The clear link attention mailbox command is issued to clear the link event</span>
<span class="cm"> * attention condition indicated by the Link Event bit of the Host Attention</span>
<span class="cm"> * (HSTATT) register. The link event attention condition is cleared only if</span>
<span class="cm"> * the event tag specified matches that of the current link event counter.</span>
<span class="cm"> * The current event tag is read using the read link attention event mailbox</span>
<span class="cm"> * command.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for clearing HBA link attention</span>
<span class="cm"> * information.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_clear_la</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varClearLA</span><span class="p">.</span><span class="n">eventTag</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_eventTag</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_CLEAR_LA</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_config_link - Prepare a mailbox command for configuring link on a HBA</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The configure link mailbox command is used before the initialize link</span>
<span class="cm"> * mailbox command to override default value and to configure link-oriented</span>
<span class="cm"> * parameters such as DID address and various timers. Typically, this</span>
<span class="cm"> * command would be used after an F_Port login to set the returned DID address</span>
<span class="cm"> * and the fabric timeout values. This command is not valid before a configure</span>
<span class="cm"> * port command has configured the HBA port.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for configuring link on a HBA.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_config_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span>  <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="cm">/* NEW_FEATURE</span>
<span class="cm">	 * SLI-2, Coalescing Response Feature.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_cr_delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">cr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">ci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">cr_delay</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_cr_delay</span><span class="p">;</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">cr_count</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_cr_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">myId</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">edtov</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_edtov</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">arbtov</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_arbtov</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">ratov</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">rttov</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_rttov</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">altov</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_altov</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">crtov</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_crtov</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">citov</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_citov</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_ack0</span><span class="p">)</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgLnk</span><span class="p">.</span><span class="n">ack0_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_CONFIG_LINK</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_config_msi - Prepare a mailbox command for configuring msi-x</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The configure MSI-X mailbox command is used to configure the HBA&#39;s SLI-3</span>
<span class="cm"> * MSI-X multi-message interrupt vector association to interrupt attention</span>
<span class="cm"> * conditions.</span>
<span class="cm"> *</span>
<span class="cm"> * Return codes</span>
<span class="cm"> *    0 - Success</span>
<span class="cm"> *    -EINVAL - Failure</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_config_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">attentionConditions</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_use_msi</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0475 Not configured for supporting MSI-X &quot;</span>
				<span class="s">&quot;cfg_use_msi: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_use_msi</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0476 HBA not supporting SLI-3 or later &quot;</span>
				<span class="s">&quot;SLI Revision: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear mailbox command fields */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * SLI-3, Message Signaled Interrupt Fearure.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Multi-message attention configuration */</span>
	<span class="n">attentionConditions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">HA_R0ATT</span> <span class="o">|</span> <span class="n">HA_R1ATT</span> <span class="o">|</span> <span class="n">HA_R2ATT</span> <span class="o">|</span> <span class="n">HA_ERATT</span> <span class="o">|</span>
				  <span class="n">HA_LATT</span> <span class="o">|</span> <span class="n">HA_MBATT</span><span class="p">);</span>
	<span class="n">attentionConditions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">attentionConditions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">attentionConditions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">attentionConditions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">attentionConditions</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up message number to HA bit association</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef __BIG_ENDIAN_BITFIELD</span>
	<span class="cm">/* RA0 (FCP Ring) */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">messageNumberByHA</span><span class="p">[</span><span class="n">HA_R0_POS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* RA1 (Other Protocol Extra Ring) */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">messageNumberByHA</span><span class="p">[</span><span class="n">HA_R1_POS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else   </span><span class="cm">/*  __LITTLE_ENDIAN_BITFIELD */</span><span class="cp"></span>
	<span class="cm">/* RA0 (FCP Ring) */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">messageNumberByHA</span><span class="p">[</span><span class="n">HA_R0_POS</span><span class="o">^</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* RA1 (Other Protocol Extra Ring) */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">messageNumberByHA</span><span class="p">[</span><span class="n">HA_R1_POS</span><span class="o">^</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* Multi-message interrupt autoclear configuration*/</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">autoClearHA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">attentionConditions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">autoClearHA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">attentionConditions</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* For now, HBA autoclear does not work reliably, disable it */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">autoClearHA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgMSI</span><span class="p">.</span><span class="n">autoClearHA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set command and owner bit */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_CONFIG_MSI</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_init_link - Prepare a mailbox command for initialize link on a HBA</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> * @topology: the link topology for the link to be initialized to.</span>
<span class="cm"> * @linkspeed: the link speed for the link to be initialized to.</span>
<span class="cm"> *</span>
<span class="cm"> * The initialize link mailbox command is used to initialize the Fibre</span>
<span class="cm"> * Channel link. This command must follow a configure port command that</span>
<span class="cm"> * establishes the mode of operation.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for initializing link on a HBA</span>
<span class="cm"> * with the specified link topology and speed.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_init_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span>
	       <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">topology</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">linkspeed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lpfc_vpd_t</span> <span class="o">*</span><span class="n">vpd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">topology</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLAGS_TOPOLOGY_MODE_LOOP_PT</span>:
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">=</span> <span class="n">FLAGS_TOPOLOGY_MODE_LOOP</span><span class="p">;</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">|=</span> <span class="n">FLAGS_TOPOLOGY_FAILOVER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLAGS_TOPOLOGY_MODE_PT_PT</span>:
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">=</span> <span class="n">FLAGS_TOPOLOGY_MODE_PT_PT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLAGS_TOPOLOGY_MODE_LOOP</span>:
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">=</span> <span class="n">FLAGS_TOPOLOGY_MODE_LOOP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLAGS_TOPOLOGY_MODE_PT_LOOP</span>:
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">=</span> <span class="n">FLAGS_TOPOLOGY_MODE_PT_PT</span><span class="p">;</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">|=</span> <span class="n">FLAGS_TOPOLOGY_FAILOVER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLAGS_LOCAL_LB</span>:
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">=</span> <span class="n">FLAGS_LOCAL_LB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable asynchronous ABTS responses from firmware */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">|=</span> <span class="n">FLAGS_IMED_ABORT</span><span class="p">;</span>

	<span class="cm">/* NEW_FEATURE</span>
<span class="cm">	 * Setting up the link speed</span>
<span class="cm">	 */</span>
	<span class="n">vpd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">.</span><span class="n">feaLevelHigh</span> <span class="o">&gt;=</span> <span class="mh">0x02</span><span class="p">){</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">linkspeed</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">LPFC_USER_LINK_SPEED_1G</span>:
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">|=</span> <span class="n">FLAGS_LINK_SPEED</span><span class="p">;</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">LINK_SPEED_1G</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_USER_LINK_SPEED_2G</span>:
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">|=</span>	<span class="n">FLAGS_LINK_SPEED</span><span class="p">;</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">LINK_SPEED_2G</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_USER_LINK_SPEED_4G</span>:
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">|=</span>	<span class="n">FLAGS_LINK_SPEED</span><span class="p">;</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">LINK_SPEED_4G</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_USER_LINK_SPEED_8G</span>:
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">|=</span>	<span class="n">FLAGS_LINK_SPEED</span><span class="p">;</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">LINK_SPEED_8G</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_USER_LINK_SPEED_10G</span>:
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">|=</span>	<span class="n">FLAGS_LINK_SPEED</span><span class="p">;</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">LINK_SPEED_10G</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_USER_LINK_SPEED_16G</span>:
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">|=</span>	<span class="n">FLAGS_LINK_SPEED</span><span class="p">;</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">LINK_SPEED_16G</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_USER_LINK_SPEED_AUTO</span>:
		<span class="nl">default:</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">LINK_SPEED_AUTO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">LINK_SPEED_AUTO</span><span class="p">;</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">uint8_t</span><span class="p">)</span><span class="n">MBX_INIT_LINK</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">fabric_AL_PA</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_pref_ALPA</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_read_sparam - Prepare a mailbox command for reading HBA parameters</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> * @vpi: virtual N_Port identifier.</span>
<span class="cm"> *</span>
<span class="cm"> * The read service parameter mailbox command is used to read the HBA port</span>
<span class="cm"> * service parameters. The service parameters are read into the buffer</span>
<span class="cm"> * specified directly by a BDE in the mailbox command. These service</span>
<span class="cm"> * parameters may then be used to build the payload of an N_Port/F_POrt</span>
<span class="cm"> * login request and reply (LOGI/ACC).</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for reading HBA port service</span>
<span class="cm"> * parameters. The DMA memory is allocated in this function and the addresses</span>
<span class="cm"> * are populated into the mailbox command for the HBA to DMA the service</span>
<span class="cm"> * parameters into.</span>
<span class="cm"> *</span>
<span class="cm"> * Return codes</span>
<span class="cm"> *    0 - Success</span>
<span class="cm"> *    1 - DMA memory allocation failed</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_read_sparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span><span class="p">;</span>

	<span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>

	<span class="cm">/* Get a buffer to hold the HBAs Service Parameters */</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span> <span class="o">||</span> <span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_READ_SPARM64</span><span class="p">;</span>
		<span class="cm">/* READ_SPARAM: no buffers */</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
			        <span class="s">&quot;0301 READ_SPARAM: no buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_READ_SPARM64</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRdSparm</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sp64</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_parm</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRdSparm</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sp64</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRdSparm</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sp64</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&gt;=</span> <span class="n">LPFC_SLI_REV3</span><span class="p">)</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRdSparm</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vpi</span><span class="p">];</span>

	<span class="cm">/* save address for completion */</span>
	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_unreg_did - Prepare a mailbox command for unregistering DID</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @vpi: virtual N_Port identifier.</span>
<span class="cm"> * @did: remote port identifier.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The unregister DID mailbox command is used to unregister an N_Port/F_Port</span>
<span class="cm"> * login for an unknown RPI by specifying the DID of a remote port. This</span>
<span class="cm"> * command frees an RPI context in the HBA port. This has the effect of</span>
<span class="cm"> * performing an implicit N_Port/F_Port logout.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for unregistering a remote</span>
<span class="cm"> * N_Port/F_Port (DID) login.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_unreg_did</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">vpi</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">did</span><span class="p">,</span>
	       <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varUnregDID</span><span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">did</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varUnregDID</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">vpi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vpi</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">))</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varUnregDID</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vpi</span><span class="p">];</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_UNREG_D_ID</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_read_config - Prepare a mailbox command for reading HBA configuration</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The read configuration mailbox command is used to read the HBA port</span>
<span class="cm"> * configuration parameters. This mailbox command provides a method for</span>
<span class="cm"> * seeing any parameters that may have changed via various configuration</span>
<span class="cm"> * mailbox commands.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for reading out HBA configuration</span>
<span class="cm"> * parameters.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_READ_CONFIG</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_read_lnk_stat - Prepare a mailbox command for reading HBA link stats</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The read link status mailbox command is used to read the link status from</span>
<span class="cm"> * the HBA. Link status includes all link-related error counters. These</span>
<span class="cm"> * counters are maintained by the HBA and originated in the link hardware</span>
<span class="cm"> * unit. Note that all of these counters wrap.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for reading out HBA link status.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_read_lnk_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_READ_LNK_STAT</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_reg_rpi - Prepare a mailbox command for registering remote login</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @vpi: virtual N_Port identifier.</span>
<span class="cm"> * @did: remote port identifier.</span>
<span class="cm"> * @param: pointer to memory holding the server parameters.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> * @rpi: the rpi to use in the registration (usually only used for SLI4.</span>
<span class="cm"> *</span>
<span class="cm"> * The registration login mailbox command is used to register an N_Port or</span>
<span class="cm"> * F_Port login. This registration allows the HBA to cache the remote N_Port</span>
<span class="cm"> * service parameters internally and thereby make the appropriate FC-2</span>
<span class="cm"> * decisions. The remote port service parameters are handed off by the driver</span>
<span class="cm"> * to the HBA using a descriptor entry that directly identifies a buffer in</span>
<span class="cm"> * host memory. In exchange, the HBA returns an RPI identifier.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for registering remote port login.</span>
<span class="cm"> * The function allocates DMA buffer for passing the service parameters to the</span>
<span class="cm"> * HBA with the mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * Return codes</span>
<span class="cm"> *    0 - Success</span>
<span class="cm"> *    1 - DMA memory allocation failed</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_reg_rpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">vpi</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">did</span><span class="p">,</span>
	     <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">sparam</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegLogin</span><span class="p">.</span><span class="n">rpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegLogin</span><span class="p">.</span><span class="n">rpi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">rpi_ids</span><span class="p">[</span><span class="n">rpi</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&gt;=</span> <span class="n">LPFC_SLI_REV3</span><span class="p">)</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegLogin</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vpi</span><span class="p">];</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegLogin</span><span class="p">.</span><span class="n">did</span> <span class="o">=</span> <span class="n">did</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="cm">/* Get a buffer to hold NPorts Service Parameters */</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span> <span class="o">||</span> <span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_REG_LOGIN64</span><span class="p">;</span>
		<span class="cm">/* REG_LOGIN: no buffers */</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
				<span class="s">&quot;0302 REG_LOGIN: no buffers, VPI:%d DID:x%x, &quot;</span>
				<span class="s">&quot;rpi x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">rpi</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">sparam</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="cm">/* Copy param&#39;s into a new buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sparam</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_parm</span><span class="p">));</span>

	<span class="cm">/* save address for completion */</span>
	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mp</span><span class="p">;</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_REG_LOGIN64</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegLogin</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sp64</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_parm</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegLogin</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sp64</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegLogin</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sp64</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_unreg_login - Prepare a mailbox command for unregistering remote login</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @vpi: virtual N_Port identifier.</span>
<span class="cm"> * @rpi: remote port identifier</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The unregistration login mailbox command is used to unregister an N_Port</span>
<span class="cm"> * or F_Port login. This command frees an RPI context in the HBA. It has the</span>
<span class="cm"> * effect of performing an implicit N_Port/F_Port logout.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for unregistering remote port</span>
<span class="cm"> * login.</span>
<span class="cm"> *</span>
<span class="cm"> * For SLI4 ports, the rpi passed to this function must be the physical</span>
<span class="cm"> * rpi value, not the logical index.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_unreg_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">vpi</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">rpi</span><span class="p">,</span>
		 <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varUnregLogin</span><span class="p">.</span><span class="n">rpi</span> <span class="o">=</span> <span class="n">rpi</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varUnregLogin</span><span class="p">.</span><span class="n">rsvd1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&gt;=</span> <span class="n">LPFC_SLI_REV3</span><span class="p">)</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varUnregLogin</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vpi</span><span class="p">];</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_UNREG_LOGIN</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_unreg_all_rpis - unregister all RPIs for a vport on SLI4 HBA.</span>
<span class="cm"> * @vport: pointer to a vport object.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine sends mailbox command to unregister all active RPIs for</span>
<span class="cm"> * a vport.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_sli4_unreg_all_rpis</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>  <span class="o">*</span><span class="n">phba</span>  <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span>     <span class="o">*</span><span class="n">mbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mbox</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For SLI4 functions, the rpi field is overloaded for</span>
<span class="cm">		 * the vport context unreg all.  This routine passes</span>
<span class="cm">		 * 0 for the rpi field in lpfc_unreg_login for compatibility</span>
<span class="cm">		 * with SLI3 and then overrides the rpi field with the</span>
<span class="cm">		 * expected value for SLI4.</span>
<span class="cm">		 */</span>
		<span class="n">lpfc_unreg_login</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">],</span>
				 <span class="n">mbox</span><span class="p">);</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">varUnregLogin</span><span class="p">.</span><span class="n">rsvd1</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_sli_def_mbox_cmpl</span><span class="p">;</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">MBX_NOWAIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_NOT_FINISHED</span><span class="p">)</span>
			<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_reg_vpi - Prepare a mailbox command for registering vport identifier</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @vpi: virtual N_Port identifier.</span>
<span class="cm"> * @sid: Fibre Channel S_ID (N_Port_ID assigned to a virtual N_Port).</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The registration vport identifier mailbox command is used to activate a</span>
<span class="cm"> * virtual N_Port after it has acquired an N_Port_ID. The HBA validates the</span>
<span class="cm"> * N_Port_ID against the information in the selected virtual N_Port context</span>
<span class="cm"> * block and marks it active to allow normal processing of IOCB commands and</span>
<span class="cm"> * received unsolicited exchanges.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for registering a virtual N_Port.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_reg_vpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the re-reg VPI bit for f/w to update the MAC address.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_VPORT_NEEDS_REG_VPI</span><span class="p">))</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">upd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">];</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">vfi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">vfi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vfi</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">vfi</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vfi</span> <span class="o">+</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">vfi_base</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">wwn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_portname</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegVpi</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_REG_VPI</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_unreg_vpi - Prepare a mailbox command for unregistering vport id</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @vpi: virtual N_Port identifier.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The unregistration vport identifier mailbox command is used to inactivate</span>
<span class="cm"> * a virtual N_Port. The driver must have logged out and unregistered all</span>
<span class="cm"> * remote N_Ports to abort any activity on the virtual N_Port. The HBA will</span>
<span class="cm"> * unregisters any default RPIs associated with the specified vpi, aborting</span>
<span class="cm"> * any active exchanges. The HBA will post the mailbox response after making</span>
<span class="cm"> * the virtual N_Port inactive.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for unregistering a virtual</span>
<span class="cm"> * N_Port.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_unreg_vpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV3</span><span class="p">)</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varUnregVpi</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vpi</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&gt;=</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varUnregVpi</span><span class="p">.</span><span class="n">sli4_vpi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vpi</span><span class="p">];</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_UNREG_VPI</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_config_pcb_setup - Set up IOCB rings in the Port Control Block (PCB)</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine sets up and initializes the IOCB rings in the Port Control</span>
<span class="cm"> * Block (PCB).</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_config_pcb_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span><span class="p">;</span>
	<span class="n">PCB_t</span> <span class="o">*</span><span class="n">pcbp</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pdma_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">iocbCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">maxRing</span> <span class="o">=</span> <span class="p">(</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">num_rings</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">psli</span><span class="o">-&gt;</span><span class="n">num_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">pring</span><span class="o">-&gt;</span><span class="n">sizeCiocb</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="n">SLI3_IOCB_CMD_SIZE</span><span class="o">:</span>
							<span class="n">SLI2_IOCB_CMD_SIZE</span><span class="p">;</span>
		<span class="n">pring</span><span class="o">-&gt;</span><span class="n">sizeRiocb</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="n">SLI3_IOCB_RSP_SIZE</span><span class="o">:</span>
							<span class="n">SLI2_IOCB_RSP_SIZE</span><span class="p">;</span>
		<span class="cm">/* A ring MUST have both cmd and rsp entries defined to be</span>
<span class="cm">		   valid */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pring</span><span class="o">-&gt;</span><span class="n">numCiocb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pring</span><span class="o">-&gt;</span><span class="n">numRiocb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdEntries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspEntries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdAddrHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspAddrHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdAddrLow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspAddrLow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pring</span><span class="o">-&gt;</span><span class="n">cmdringaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">pring</span><span class="o">-&gt;</span><span class="n">rspringaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Command ring setup for ring */</span>
		<span class="n">pring</span><span class="o">-&gt;</span><span class="n">cmdringaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">IOCBs</span><span class="p">[</span><span class="n">iocbCnt</span><span class="p">];</span>
		<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdEntries</span> <span class="o">=</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">numCiocb</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">IOCBs</span><span class="p">[</span><span class="n">iocbCnt</span><span class="p">]</span> <span class="o">-</span>
			 <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">virt</span><span class="p">;</span>
		<span class="n">pdma_addr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">phys</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdAddrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>
		<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdAddrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>
		<span class="n">iocbCnt</span> <span class="o">+=</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">numCiocb</span><span class="p">;</span>

		<span class="cm">/* Response ring setup for ring */</span>
		<span class="n">pring</span><span class="o">-&gt;</span><span class="n">rspringaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">IOCBs</span><span class="p">[</span><span class="n">iocbCnt</span><span class="p">];</span>

		<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspEntries</span> <span class="o">=</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">numRiocb</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">IOCBs</span><span class="p">[</span><span class="n">iocbCnt</span><span class="p">]</span> <span class="o">-</span>
			 <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">virt</span><span class="p">;</span>
		<span class="n">pdma_addr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">phys</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspAddrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>
		<span class="n">pcbp</span><span class="o">-&gt;</span><span class="n">rdsc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rspAddrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>
		<span class="n">iocbCnt</span> <span class="o">+=</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">numRiocb</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_read_rev - Prepare a mailbox command for reading HBA revision</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The read revision mailbox command is used to read the revision levels of</span>
<span class="cm"> * the HBA components. These components include hardware units, resident</span>
<span class="cm"> * firmware, and available firmware. HBAs that supports SLI-3 mode of</span>
<span class="cm"> * operation provide different response information depending on the version</span>
<span class="cm"> * requested by the driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for reading HBA revision</span>
<span class="cm"> * information.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_read_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRdRev</span><span class="p">.</span><span class="n">cv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRdRev</span><span class="p">.</span><span class="n">v3req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Request SLI3 info */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_READ_REV</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">lpfc_sli4_swap_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mqe</span> <span class="o">*</span><span class="n">mqe</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>  <span class="n">MBX_READ_REV</span>:
		 <span class="n">mqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">;</span>
		<span class="n">lpfc_sli_pcimem_bcopy</span><span class="p">(</span><span class="n">mqe</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">read_rev</span><span class="p">.</span><span class="n">fw_name</span><span class="p">,</span>
				 <span class="n">mqe</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">read_rev</span><span class="p">.</span><span class="n">fw_name</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">lpfc_sli_pcimem_bcopy</span><span class="p">(</span><span class="n">mqe</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">read_rev</span><span class="p">.</span><span class="n">ulp_fw_name</span><span class="p">,</span>
				 <span class="n">mqe</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">read_rev</span><span class="p">.</span><span class="n">ulp_fw_name</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_build_hbq_profile2 - Set up the HBQ Selection Profile 2</span>
<span class="cm"> * @hbqmb: pointer to the HBQ configuration data structure in mailbox command.</span>
<span class="cm"> * @hbq_desc: pointer to the HBQ selection profile descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * The Host Buffer Queue (HBQ) Selection Profile 2 specifies that the HBA</span>
<span class="cm"> * tests the incoming frames&#39; R_CTL/TYPE fields with works 10:15 and performs</span>
<span class="cm"> * the Sequence Length Test using the fields in the Selection Profile 2</span>
<span class="cm"> * extension in words 20:31.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_build_hbq_profile2</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_hbq_var</span> <span class="o">*</span><span class="n">hbqmb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_hbq_init</span>  <span class="o">*</span><span class="n">hbq_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile2</span><span class="p">.</span><span class="n">seqlenbcnt</span> <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">seqlenbcnt</span><span class="p">;</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile2</span><span class="p">.</span><span class="n">maxlen</span>     <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">;</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile2</span><span class="p">.</span><span class="n">seqlenoff</span>  <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">seqlenoff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_build_hbq_profile3 - Set up the HBQ Selection Profile 3</span>
<span class="cm"> * @hbqmb: pointer to the HBQ configuration data structure in mailbox command.</span>
<span class="cm"> * @hbq_desc: pointer to the HBQ selection profile descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * The Host Buffer Queue (HBQ) Selection Profile 3 specifies that the HBA</span>
<span class="cm"> * tests the incoming frame&#39;s R_CTL/TYPE fields with words 10:15 and performs</span>
<span class="cm"> * the Sequence Length Test and Byte Field Test using the fields in the</span>
<span class="cm"> * Selection Profile 3 extension in words 20:31.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_build_hbq_profile3</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_hbq_var</span> <span class="o">*</span><span class="n">hbqmb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_hbq_init</span>  <span class="o">*</span><span class="n">hbq_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile3</span><span class="p">.</span><span class="n">seqlenbcnt</span> <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">seqlenbcnt</span><span class="p">;</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile3</span><span class="p">.</span><span class="n">maxlen</span>     <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">;</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile3</span><span class="p">.</span><span class="n">cmdcodeoff</span> <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">cmdcodeoff</span><span class="p">;</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile3</span><span class="p">.</span><span class="n">seqlenoff</span>  <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">seqlenoff</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile3</span><span class="p">.</span><span class="n">cmdmatch</span><span class="p">,</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">cmdmatch</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile3</span><span class="p">.</span><span class="n">cmdmatch</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_build_hbq_profile5 - Set up the HBQ Selection Profile 5</span>
<span class="cm"> * @hbqmb: pointer to the HBQ configuration data structure in mailbox command.</span>
<span class="cm"> * @hbq_desc: pointer to the HBQ selection profile descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * The Host Buffer Queue (HBQ) Selection Profile 5 specifies a header HBQ. The</span>
<span class="cm"> * HBA tests the initial frame of an incoming sequence using the frame&#39;s</span>
<span class="cm"> * R_CTL/TYPE fields with words 10:15 and performs the Sequence Length Test</span>
<span class="cm"> * and Byte Field Test using the fields in the Selection Profile 5 extension</span>
<span class="cm"> * words 20:31.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_build_hbq_profile5</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_hbq_var</span> <span class="o">*</span><span class="n">hbqmb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_hbq_init</span>  <span class="o">*</span><span class="n">hbq_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile5</span><span class="p">.</span><span class="n">seqlenbcnt</span> <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">seqlenbcnt</span><span class="p">;</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile5</span><span class="p">.</span><span class="n">maxlen</span>     <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">;</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile5</span><span class="p">.</span><span class="n">cmdcodeoff</span> <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">cmdcodeoff</span><span class="p">;</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile5</span><span class="p">.</span><span class="n">seqlenoff</span>  <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">seqlenoff</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile5</span><span class="p">.</span><span class="n">cmdmatch</span><span class="p">,</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">cmdmatch</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profiles</span><span class="p">.</span><span class="n">profile5</span><span class="p">.</span><span class="n">cmdmatch</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_config_hbq - Prepare a mailbox command for configuring an HBQ</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @id: HBQ identifier.</span>
<span class="cm"> * @hbq_desc: pointer to the HBA descriptor data structure.</span>
<span class="cm"> * @hbq_entry_index: index of the HBQ entry data structures.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The configure HBQ (Host Buffer Queue) mailbox command is used to configure</span>
<span class="cm"> * an HBQ. The configuration binds events that require buffers to a particular</span>
<span class="cm"> * ring and HBQ based on a selection profile.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for configuring an HBQ.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_config_hbq</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">lpfc_hbq_init</span> <span class="o">*</span><span class="n">hbq_desc</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">hbq_entry_index</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_hbq_var</span> <span class="o">*</span><span class="n">hbqmb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgHbq</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">hbqId</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">;</span>   <span class="cm">/* # entries in HBQ */</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">recvNotify</span> <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">rn</span><span class="p">;</span>             <span class="cm">/* Receive</span>
<span class="cm">						       * Notification */</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">numMask</span>    <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">mask_count</span><span class="p">;</span>     <span class="cm">/* # R_CTL/TYPE masks</span>
<span class="cm">						       * # in words 0-19 */</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">profile</span>    <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">;</span>	      <span class="cm">/* Selection profile:</span>
<span class="cm">						       * 0 = all,</span>
<span class="cm">						       * 7 = logentry */</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">ringMask</span>   <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">ring_mask</span><span class="p">;</span>      <span class="cm">/* Binds HBQ to a ring</span>
<span class="cm">						       * e.g. Ring0=b0001,</span>
<span class="cm">						       * ring2=b0100 */</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">headerLen</span>  <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">headerLen</span><span class="p">;</span>      <span class="cm">/* 0 if not profile 4</span>
<span class="cm">						       * or 5 */</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">logEntry</span>   <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">logEntry</span><span class="p">;</span>       <span class="cm">/* Set to 1 if this</span>
<span class="cm">						       * HBQ will be used</span>
<span class="cm">						       * for LogEntry</span>
<span class="cm">						       * buffers */</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">hbqaddrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbqslimp</span><span class="p">.</span><span class="n">phys</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">hbq_entry_index</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hbq_entry</span><span class="p">);</span>
	<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">hbqaddrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbqslimp</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_CONFIG_HBQ</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>

				<span class="cm">/* Copy info for profiles 2,3,5. Other</span>
<span class="cm">				 * profiles this area is reserved</span>
<span class="cm">				 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">profile</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">lpfc_build_hbq_profile2</span><span class="p">(</span><span class="n">hbqmb</span><span class="p">,</span> <span class="n">hbq_desc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">profile</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">lpfc_build_hbq_profile3</span><span class="p">(</span><span class="n">hbqmb</span><span class="p">,</span> <span class="n">hbq_desc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">profile</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">lpfc_build_hbq_profile5</span><span class="p">(</span><span class="n">hbqmb</span><span class="p">,</span> <span class="n">hbq_desc</span><span class="p">);</span>

	<span class="cm">/* Return if no rctl / type masks for this HBQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">mask_count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Otherwise we setup specific rctl / type masks for this HBQ */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">mask_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">hbqMasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmatch</span> <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">hbqMasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmatch</span><span class="p">;</span>
		<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">hbqMasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmask</span>  <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">hbqMasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmask</span><span class="p">;</span>
		<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">hbqMasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rctlmatch</span> <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">hbqMasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rctlmatch</span><span class="p">;</span>
		<span class="n">hbqmb</span><span class="o">-&gt;</span><span class="n">hbqMasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rctlmask</span>  <span class="o">=</span> <span class="n">hbq_desc</span><span class="o">-&gt;</span><span class="n">hbqMasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rctlmask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_config_ring - Prepare a mailbox command for configuring an IOCB ring</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @ring:</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The configure ring mailbox command is used to configure an IOCB ring. This</span>
<span class="cm"> * configuration binds from one to six of HBA RC_CTL/TYPE mask entries to the</span>
<span class="cm"> * ring. This is used to map incoming sequences to a particular ring whose</span>
<span class="cm"> * RC_CTL/TYPE mask entry matches that of the sequence. The driver should not</span>
<span class="cm"> * attempt to configure a ring whose number is greater than the number</span>
<span class="cm"> * specified in the Port Control Block (PCB). It is an error to issue the</span>
<span class="cm"> * configure ring command more than once with the same ring number. The HBA</span>
<span class="cm"> * returns an error if the driver attempts this.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for configuring IOCB ring.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_config_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ring</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">ring</span> <span class="o">=</span> <span class="n">ring</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">maxOrigXchg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">maxRespXchg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">recvNotify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="n">pring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">numMask</span> <span class="o">=</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">num_mask</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_CONFIG_RING</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>

	<span class="cm">/* Is this ring configured for a specific profile */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pring</span><span class="o">-&gt;</span><span class="n">prt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">profile</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">prt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">profile</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Otherwise we setup specific rctl / type masks for this ring */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">num_mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">rrRegs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rval</span> <span class="o">=</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">prt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rctl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">rrRegs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">FC_RCTL_ELS_REQ</span><span class="p">)</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">rrRegs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">rrRegs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmask</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">rrRegs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tval</span> <span class="o">=</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">prt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgRing</span><span class="p">.</span><span class="n">rrRegs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_config_port - Prepare a mailbox command for configuring port</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The configure port mailbox command is used to identify the Port Control</span>
<span class="cm"> * Block (PCB) in the driver memory. After this command is issued, the</span>
<span class="cm"> * driver must not access the mailbox in the HBA without first resetting</span>
<span class="cm"> * the HBA. The HBA may copy the PCB information to internal storage for</span>
<span class="cm"> * subsequent use; the driver can not change the PCB information unless it</span>
<span class="cm"> * resets the HBA.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for configuring port.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mb_slim</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAILBOX_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">MBslimaddr</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pdma_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bar_low</span><span class="p">,</span> <span class="n">bar_high</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hgp</span> <span class="n">hgp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pgp_offset</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_CONFIG_PORT</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">pcbLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PCB_t</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">pdma_addr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">phys</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">pcbLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">pcbHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>

	<span class="cm">/* Always Host Group Pointer is in SLIM */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">hps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If HBA supports SLI=3 ask for it */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV3</span> <span class="o">&amp;&amp;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">sli3Feat</span><span class="p">.</span><span class="n">cerbm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_enable_bg</span><span class="p">)</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">cbg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* configure BlockGuard */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_enable_dss</span><span class="p">)</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">cdss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Configure Security */</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">cerbm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Request HBQs */</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">ccrp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Command Ring Polling */</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">max_hbq</span> <span class="o">=</span> <span class="n">lpfc_sli_hbq_count</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vpi</span> <span class="o">&amp;&amp;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_enable_npiv</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">sli3Feat</span><span class="p">.</span><span class="n">cmv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">max_vpi</span> <span class="o">=</span> <span class="n">LPFC_MAX_VPI</span><span class="p">;</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">cmv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">max_vpi</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">=</span> <span class="n">LPFC_SLI_REV2</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">sli_mode</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span><span class="p">;</span>

	<span class="cm">/* If this is an SLI3 port, configure async status notification. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV3</span><span class="p">)</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">casabt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Now setup pcb */</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_NATIVE_SLI2</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">FEATURE_INITIAL_SLI2</span><span class="p">;</span>

	<span class="cm">/* Setup Mailbox pointers */</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">mailBoxSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAILBOX_EXT_SIZE</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">pdma_addr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">phys</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">mbAddrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">mbAddrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup Host Group ring pointer.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For efficiency reasons, the ring get/put pointers can be</span>
<span class="cm">	 * placed in adapter memory (SLIM) rather than in host memory.</span>
<span class="cm">	 * This allows firmware to avoid PCI reads/writes when updating</span>
<span class="cm">	 * and checking pointers.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The firmware recognizes the use of SLIM memory by comparing</span>
<span class="cm">	 * the address of the get/put pointers structure with that of</span>
<span class="cm">	 * the SLIM BAR (BAR0).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Caution: be sure to use the PCI config space value of BAR0/BAR1</span>
<span class="cm">	 * (the hardware&#39;s view of the base address), not the OS&#39;s</span>
<span class="cm">	 * value of pci_resource_start() as the OS value may be a cookie</span>
<span class="cm">	 * for ioremap/iomap.</span>
<span class="cm">	 */</span>


	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar_low</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar_high</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up HGP - Port Memory</span>
<span class="cm">	 *</span>
<span class="cm">	 * The port expects the host get/put pointers to reside in memory</span>
<span class="cm">	 * following the &quot;non-diagnostic&quot; mode mailbox (32 words, 0x80 bytes)</span>
<span class="cm">	 * area of SLIM.  In SLI-2 mode, there&#39;s an additional 16 reserved</span>
<span class="cm">	 * words (0x40 bytes).  This area is not reserved if HBQs are</span>
<span class="cm">	 * configured in SLI-3.</span>
<span class="cm">	 *</span>
<span class="cm">	 * CR0Put    - SLI2(no HBQs) = 0xc0, With HBQs = 0x80</span>
<span class="cm">	 * RR0Get                      0xc4              0x84</span>
<span class="cm">	 * CR1Put                      0xc8              0x88</span>
<span class="cm">	 * RR1Get                      0xcc              0x8c</span>
<span class="cm">	 * CR2Put                      0xd0              0x90</span>
<span class="cm">	 * RR2Get                      0xd4              0x94</span>
<span class="cm">	 * CR3Put                      0xd8              0x98</span>
<span class="cm">	 * RR3Get                      0xdc              0x9c</span>
<span class="cm">	 *</span>
<span class="cm">	 * Reserved                    0xa0-0xbf</span>
<span class="cm">	 *    If HBQs configured:</span>
<span class="cm">	 *                         HBQ 0 Put ptr  0xc0</span>
<span class="cm">	 *                         HBQ 1 Put ptr  0xc4</span>
<span class="cm">	 *                         HBQ 2 Put ptr  0xc8</span>
<span class="cm">	 *                         ......</span>
<span class="cm">	 *                         HBQ(M-1)Put Pointer 0xc0+(M-1)*4</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_hostmem_hgp</span> <span class="o">&amp;&amp;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">host_gp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">us</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbq_put</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">us</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">host</span> <span class="o">-</span>
			<span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">virt</span><span class="p">;</span>
		<span class="n">pdma_addr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">phys</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">hgpAddrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">hgpAddrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Always Host Group Pointer is in SLIM */</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">hps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">host_gp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mb_slim</span><span class="o">-&gt;</span><span class="n">us</span><span class="p">.</span><span class="n">s3</span><span class="p">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbq_put</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mb_slim</span><span class="o">-&gt;</span><span class="n">us</span><span class="p">.</span><span class="n">s3</span><span class="p">.</span><span class="n">hbq_put</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">host_gp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mb_slim</span><span class="o">-&gt;</span><span class="n">us</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbq_put</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* mask off BAR0&#39;s flag bits 0 - 3 */</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">hgpAddrLow</span> <span class="o">=</span> <span class="p">(</span><span class="n">bar_low</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">host_gp</span> <span class="o">-</span>
			<span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">MBslimaddr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bar_low</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">hgpAddrHigh</span> <span class="o">=</span> <span class="n">bar_high</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">hgpAddrHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* write HGP data to SLIM at the required longword offset */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hgp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hgp</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">num_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_memcpy_to_slim</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">host_gp</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hgp</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">host_gp</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Setup Port Group offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">pgp_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli2_slim</span><span class="p">,</span>
				      <span class="n">mbx</span><span class="p">.</span><span class="n">us</span><span class="p">.</span><span class="n">s3_pgp</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pgp_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli2_slim</span><span class="p">,</span> <span class="n">mbx</span><span class="p">.</span><span class="n">us</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="n">pdma_addr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">phys</span> <span class="o">+</span> <span class="n">pgp_offset</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">pgpAddrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">pgpAddrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">pdma_addr</span><span class="p">);</span>

	<span class="cm">/* Use callback routine to setp rings in the pcb */</span>
	<span class="n">lpfc_config_pcb_setup</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="cm">/* special handling for LC HBAs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_is_LC_HBA</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">hbainit</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

		<span class="n">lpfc_hba_init</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">hbainit</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varCfgPort</span><span class="p">.</span><span class="n">hbainit</span><span class="p">,</span> <span class="n">hbainit</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Swap PCB if needed */</span>
	<span class="n">lpfc_sli_pcimem_bcopy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PCB_t</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_kill_board - Prepare a mailbox command for killing board</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pmb: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * The kill board mailbox command is used to tell firmware to perform a</span>
<span class="cm"> * graceful shutdown of a channel on a specified board to prepare for reset.</span>
<span class="cm"> * When the kill board mailbox command is received, the ER3 bit is set to 1</span>
<span class="cm"> * in the Host Status register and the ER Attention bit is set to 1 in the</span>
<span class="cm"> * Host Attention register of the HBA function that received the kill board</span>
<span class="cm"> * command.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine prepares the mailbox command for killing the board in</span>
<span class="cm"> * preparation for a graceful shutdown.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_kill_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">pmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_KILL_BOARD</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mbox_put - Put a mailbox cmd into the tail of driver&#39;s mailbox queue</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mbq: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * Driver maintains a internal mailbox command queue implemented as a linked</span>
<span class="cm"> * list. When a mailbox command is issued, it shall be put into the mailbox</span>
<span class="cm"> * command queue such that they shall be processed orderly as HBA can process</span>
<span class="cm"> * one mailbox command at a time.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_mbox_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span> <span class="n">mbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span><span class="p">;</span>

	<span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbq</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">mboxq</span><span class="p">);</span>

	<span class="n">psli</span><span class="o">-&gt;</span><span class="n">mboxq_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mbox_get - Remove a mailbox cmd from the head of driver&#39;s mailbox queue</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Driver maintains a internal mailbox command queue implemented as a linked</span>
<span class="cm"> * list. When a mailbox command is issued, it shall be put into the mailbox</span>
<span class="cm"> * command queue such that they shall be processed orderly as HBA can process</span>
<span class="cm"> * one mailbox command at a time. After HBA finished processing a mailbox</span>
<span class="cm"> * command, the driver will remove a pending mailbox command from the head of</span>
<span class="cm"> * the mailbox command queue and send to the HBA for processing.</span>
<span class="cm"> *</span>
<span class="cm"> * Return codes</span>
<span class="cm"> *    pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> **/</span>
<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span>
<span class="nf">lpfc_mbox_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>

	<span class="n">list_remove_head</span><span class="p">((</span><span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">mboxq</span><span class="p">),</span> <span class="n">mbq</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbq</span><span class="p">)</span>
		<span class="n">psli</span><span class="o">-&gt;</span><span class="n">mboxq_cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mbq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __lpfc_mbox_cmpl_put - Put mailbox cmd into mailbox cmd complete list</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mbq: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine put the completed mailbox command into the mailbox command</span>
<span class="cm"> * complete list. This is the unlocked version of the routine. The mailbox</span>
<span class="cm"> * complete list is used by the driver worker thread to process mailbox</span>
<span class="cm"> * complete callback functions outside the driver interrupt handler.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">__lpfc_mbox_cmpl_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbq</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">mboxq_cmpl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mbox_cmpl_put - Put mailbox command into mailbox command complete list</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mbq: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine put the completed mailbox command into the mailbox command</span>
<span class="cm"> * complete list. This is the locked version of the routine. The mailbox</span>
<span class="cm"> * complete list is used by the driver worker thread to process mailbox</span>
<span class="cm"> * complete callback functions outside the driver interrupt handler.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_mbox_cmpl_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflag</span><span class="p">;</span>

	<span class="cm">/* This function expects to be called from interrupt context */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">iflag</span><span class="p">);</span>
	<span class="n">__lpfc_mbox_cmpl_put</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mbq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">iflag</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mbox_cmd_check - Check the validality of a mailbox command</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mboxq: pointer to the driver internal queue element for mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is to check whether a mailbox command is valid to be issued.</span>
<span class="cm"> * This check will be performed by both the mailbox issue API when a client</span>
<span class="cm"> * is to issue a mailbox command to the mailbox transport.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 - pass the check, -ENODEV - fail the check</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_mbox_cmd_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mboxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Mailbox command that have a completion handler must also have a</span>
<span class="cm">	 * vport specified.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">&amp;&amp;</span> <span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">!=</span> <span class="n">lpfc_sli_def_mbox_cmpl</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">!=</span> <span class="n">lpfc_sli_wake_mbox_wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_MBOX</span> <span class="o">|</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
					<span class="s">&quot;1814 Mbox x%x failed, no vport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxCommand</span><span class="p">);</span>
			<span class="n">dump_stack</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mbox_dev_check - Check the device state for issuing a mailbox command</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is to check whether the HBA device is ready for posting a</span>
<span class="cm"> * mailbox command. It is used by the mailbox transport API at the time the</span>
<span class="cm"> * to post a mailbox command to the device.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 - pass the check, -ENODEV - fail the check</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_mbox_dev_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If the PCI channel is in offline state, do not issue mbox */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* If the HBA is in error state, do not issue mbox */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">LPFC_HBA_ERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mbox_tmo_val - Retrieve mailbox command timeout value</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @cmd: mailbox command code.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine retrieves the proper timeout value according to the mailbox</span>
<span class="cm"> * command code.</span>
<span class="cm"> *</span>
<span class="cm"> * Return codes</span>
<span class="cm"> *    Timeout value to be used for the given mailbox command</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_mbox_tmo_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mboxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">subsys</span><span class="p">,</span> <span class="n">opcode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBX_WRITE_NV</span>:	<span class="cm">/* 0x03 */</span>
	<span class="k">case</span> <span class="n">MBX_UPDATE_CFG</span>:	<span class="cm">/* 0x1B */</span>
	<span class="k">case</span> <span class="n">MBX_DOWN_LOAD</span>:	<span class="cm">/* 0x1C */</span>
	<span class="k">case</span> <span class="n">MBX_DEL_LD_ENTRY</span>:	<span class="cm">/* 0x1D */</span>
	<span class="k">case</span> <span class="n">MBX_LOAD_AREA</span>:	<span class="cm">/* 0x81 */</span>
	<span class="k">case</span> <span class="n">MBX_WRITE_WWN</span>:     <span class="cm">/* 0x98 */</span>
	<span class="k">case</span> <span class="n">MBX_LOAD_EXP_ROM</span>:	<span class="cm">/* 0x9C */</span>
		<span class="k">return</span> <span class="n">LPFC_MBOX_TMO_FLASH_CMD</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBX_SLI4_CONFIG</span>:	<span class="cm">/* 0x9b */</span>
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">lpfc_sli_config_mbox_subsys_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mboxq</span><span class="p">);</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">lpfc_sli_config_mbox_opcode_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mboxq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsys</span> <span class="o">==</span> <span class="n">LPFC_MBOX_SUBSYSTEM_COMMON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_READ_OBJECT</span>:
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_WRITE_OBJECT</span>:
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_READ_OBJECT_LIST</span>:
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_DELETE_OBJECT</span>:
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_GET_FUNCTION_CONFIG</span>:
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_GET_PROFILE_LIST</span>:
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_SET_ACT_PROFILE</span>:
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_SET_PROFILE_CONFIG</span>:
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_GET_FACTORY_PROFILE_CONFIG</span>:
				<span class="k">return</span> <span class="n">LPFC_MBOX_SLI4_CONFIG_EXTENDED_TMO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsys</span> <span class="o">==</span> <span class="n">LPFC_MBOX_SUBSYSTEM_FCOE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_FCOE_SET_FCLINK_SETTINGS</span>:
				<span class="k">return</span> <span class="n">LPFC_MBOX_SLI4_CONFIG_EXTENDED_TMO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">LPFC_MBOX_SLI4_CONFIG_TMO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">LPFC_MBOX_TMO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_mbx_sge_set - Set a sge entry in non-embedded mailbox command</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command.</span>
<span class="cm"> * @sgentry: sge entry index.</span>
<span class="cm"> * @phyaddr: physical address for the sge</span>
<span class="cm"> * @length: Length of the sge.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine sets up an entry in the non-embedded mailbox command at the sge</span>
<span class="cm"> * index location.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_sli4_mbx_sge_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sgentry</span><span class="p">,</span>
		      <span class="n">dma_addr_t</span> <span class="n">phyaddr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_nembed_cmd</span> <span class="o">*</span><span class="n">nembed_sge</span><span class="p">;</span>

	<span class="n">nembed_sge</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbx_nembed_cmd</span> <span class="o">*</span><span class="p">)</span>
				<span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">nembed_cmd</span><span class="p">;</span>
	<span class="n">nembed_sge</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sgentry</span><span class="p">].</span><span class="n">pa_lo</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">phyaddr</span><span class="p">);</span>
	<span class="n">nembed_sge</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sgentry</span><span class="p">].</span><span class="n">pa_hi</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">phyaddr</span><span class="p">);</span>
	<span class="n">nembed_sge</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sgentry</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_mbx_sge_get - Get a sge entry from non-embedded mailbox command</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command.</span>
<span class="cm"> * @sgentry: sge entry index.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine gets an entry from the non-embedded mailbox command at the sge</span>
<span class="cm"> * index location.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_sli4_mbx_sge_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sgentry</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">lpfc_mbx_sge</span> <span class="o">*</span><span class="n">sge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_nembed_cmd</span> <span class="o">*</span><span class="n">nembed_sge</span><span class="p">;</span>

	<span class="n">nembed_sge</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbx_nembed_cmd</span> <span class="o">*</span><span class="p">)</span>
				<span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">nembed_cmd</span><span class="p">;</span>
	<span class="n">sge</span><span class="o">-&gt;</span><span class="n">pa_lo</span> <span class="o">=</span> <span class="n">nembed_sge</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sgentry</span><span class="p">].</span><span class="n">pa_lo</span><span class="p">;</span>
	<span class="n">sge</span><span class="o">-&gt;</span><span class="n">pa_hi</span> <span class="o">=</span> <span class="n">nembed_sge</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sgentry</span><span class="p">].</span><span class="n">pa_hi</span><span class="p">;</span>
	<span class="n">sge</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">nembed_sge</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="n">sgentry</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_mbox_cmd_free - Free a sli4 mailbox command</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine frees SLI4 specific mailbox command for sending IOCTL command.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_sli4_mbox_cmd_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_sli4_config</span> <span class="o">*</span><span class="n">sli4_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_sge</span> <span class="n">sge</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phyaddr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sgecount</span><span class="p">,</span> <span class="n">sgentry</span><span class="p">;</span>

	<span class="n">sli4_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sli4_config</span><span class="p">;</span>

	<span class="cm">/* For embedded mbox command, just free the mbox command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_emb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sli4_cfg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_mhdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For non-embedded mbox command, we need to free the pages first */</span>
	<span class="n">sgecount</span> <span class="o">=</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_sge_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sli4_cfg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_mhdr</span><span class="p">);</span>
	<span class="cm">/* There is nothing we can do if there is no sge address array */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Each non-embedded DMA memory was allocated in the length of a page */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">sgentry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sgentry</span> <span class="o">&lt;</span> <span class="n">sgecount</span><span class="p">;</span> <span class="n">sgentry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_sli4_mbx_sge_get</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">sgentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sge</span><span class="p">);</span>
		<span class="n">phyaddr</span> <span class="o">=</span> <span class="n">getPaddr</span><span class="p">(</span><span class="n">sge</span><span class="p">.</span><span class="n">pa_hi</span><span class="p">,</span> <span class="n">sge</span><span class="p">.</span><span class="n">pa_lo</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SLI4_PAGE_SIZE</span><span class="p">,</span>
				  <span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">sgentry</span><span class="p">],</span> <span class="n">phyaddr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Free the sge address array memory */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="p">);</span>
	<span class="cm">/* Finally, free the mailbox command itself */</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_config - Initialize the  SLI4 Config Mailbox command</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command.</span>
<span class="cm"> * @subsystem: The sli4 config sub mailbox subsystem.</span>
<span class="cm"> * @opcode: The sli4 config sub mailbox command opcode.</span>
<span class="cm"> * @length: Length of the sli4 config mailbox command (including sub-header).</span>
<span class="cm"> *</span>
<span class="cm"> * This routine sets up the header fields of SLI4 specific mailbox command</span>
<span class="cm"> * for sending IOCTL command.</span>
<span class="cm"> *</span>
<span class="cm"> * Return: the actual length of the mbox command allocated (mostly useful</span>
<span class="cm"> *         for none embedded mailbox command).</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_sli4_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span>
		 <span class="kt">uint8_t</span> <span class="n">subsystem</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">,</span> <span class="n">bool</span> <span class="n">emb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_sli4_config</span> <span class="o">*</span><span class="n">sli4_config</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span> <span class="o">*</span><span class="n">cfg_shdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">alloc_len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">resid_len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pagen</span><span class="p">,</span> <span class="n">pcount</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">viraddr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phyaddr</span><span class="p">;</span>

	<span class="cm">/* Set up SLI4 mailbox command header fields */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_SLI4_CONFIG</span><span class="p">);</span>

	<span class="cm">/* Set up SLI4 ioctl command header fields */</span>
	<span class="n">sli4_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sli4_config</span><span class="p">;</span>

	<span class="cm">/* Setup for the embedded mbox command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set up main header fields */</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_emb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sli4_config</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_mhdr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sli4_config</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_mhdr</span><span class="p">.</span><span class="n">payload_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="cm">/* Set up sub-header fields following main header */</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_opcode</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sli4_config</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_shdr</span><span class="p">.</span><span class="n">request</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_subsystem</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sli4_config</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_shdr</span><span class="p">.</span><span class="n">request</span><span class="p">,</span> <span class="n">subsystem</span><span class="p">);</span>
		<span class="n">sli4_config</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_shdr</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">request_length</span> <span class="o">=</span>
			<span class="n">length</span> <span class="o">-</span> <span class="n">LPFC_MBX_CMD_HDR_LENGTH</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup for the non-embedded mbox command */</span>
	<span class="n">pcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">SLI4_PAGE_ALIGN</span><span class="p">(</span><span class="n">length</span><span class="p">))</span><span class="o">/</span><span class="n">SLI4_PAGE_SIZE</span><span class="p">;</span>
	<span class="n">pcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcount</span> <span class="o">&gt;</span> <span class="n">LPFC_SLI4_MBX_SGE_MAX_PAGES</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">LPFC_SLI4_MBX_SGE_MAX_PAGES</span> <span class="o">:</span> <span class="n">pcount</span><span class="p">;</span>
	<span class="cm">/* Allocate record for keeping SGE virtual addresses */</span>
	<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbx_nembed_sge_virt</span><span class="p">),</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
				<span class="s">&quot;2527 Failed to allocate non-embedded SGE &quot;</span>
				<span class="s">&quot;array.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pagen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alloc_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pagen</span> <span class="o">&lt;</span> <span class="n">pcount</span><span class="p">;</span> <span class="n">pagen</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The DMA memory is always allocated in the length of a</span>
<span class="cm">		 * page even though the last SGE might not fill up to a</span>
<span class="cm">		 * page, this is used as a priori size of SLI4_PAGE_SIZE for</span>
<span class="cm">		 * the later DMA memory free.</span>
<span class="cm">		 */</span>
		<span class="n">viraddr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SLI4_PAGE_SIZE</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">phyaddr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="cm">/* In case of malloc fails, proceed with whatever we have */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">viraddr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">viraddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SLI4_PAGE_SIZE</span><span class="p">);</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">pagen</span><span class="p">]</span> <span class="o">=</span> <span class="n">viraddr</span><span class="p">;</span>
		<span class="cm">/* Keep the first page for later sub-header construction */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pagen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cfg_shdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span> <span class="o">*</span><span class="p">)</span><span class="n">viraddr</span><span class="p">;</span>
		<span class="n">resid_len</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">alloc_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resid_len</span> <span class="o">&gt;</span> <span class="n">SLI4_PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_sli4_mbx_sge_set</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">pagen</span><span class="p">,</span> <span class="n">phyaddr</span><span class="p">,</span>
					      <span class="n">SLI4_PAGE_SIZE</span><span class="p">);</span>
			<span class="n">alloc_len</span> <span class="o">+=</span> <span class="n">SLI4_PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lpfc_sli4_mbx_sge_set</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">pagen</span><span class="p">,</span> <span class="n">phyaddr</span><span class="p">,</span>
					      <span class="n">resid_len</span><span class="p">);</span>
			<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set up main header fields in mailbox command */</span>
	<span class="n">sli4_config</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_mhdr</span><span class="p">.</span><span class="n">payload_length</span> <span class="o">=</span> <span class="n">alloc_len</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_sge_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sli4_config</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_mhdr</span><span class="p">,</span> <span class="n">pagen</span><span class="p">);</span>

	<span class="cm">/* Set up sub-header fields into the first page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pagen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_opcode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_shdr</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_subsystem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_shdr</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="n">subsystem</span><span class="p">);</span>
		<span class="n">cfg_shdr</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">request_length</span> <span class="o">=</span>
				<span class="n">alloc_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span>  <span class="n">lpfc_sli4_cfg_shdr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* The sub-header is in DMA memory, which needs endian converstion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_shdr</span><span class="p">)</span>
		<span class="n">lpfc_sli_pcimem_bcopy</span><span class="p">(</span><span class="n">cfg_shdr</span><span class="p">,</span> <span class="n">cfg_shdr</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span>  <span class="n">lpfc_sli4_cfg_shdr</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">alloc_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_mbox_rsrc_extent - Initialize the opcode resource extent.</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mbox: pointer to an allocated lpfc mbox resource.</span>
<span class="cm"> * @exts_count: the number of extents, if required, to allocate.</span>
<span class="cm"> * @rsrc_type: the resource extent type.</span>
<span class="cm"> * @emb: true if LPFC_SLI4_MBX_EMBED. false if LPFC_SLI4_MBX_NEMBED.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine completes the subcommand header for SLI4 resource extent</span>
<span class="cm"> * mailbox commands.  It is called after lpfc_sli4_config.  The caller must</span>
<span class="cm"> * pass an allocated mailbox and the attributes required to initialize the</span>
<span class="cm"> * mailbox correctly.</span>
<span class="cm"> *</span>
<span class="cm"> * Return: the actual length of the mbox command allocated.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_sli4_mbox_rsrc_extent</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span>
			   <span class="kt">uint16_t</span> <span class="n">exts_count</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rsrc_type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">emb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_nembed_rsrc_extent</span> <span class="o">*</span><span class="n">n_rsrc_extnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">virtaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Set up SLI4 ioctl command header fields */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emb</span> <span class="o">==</span> <span class="n">LPFC_SLI4_MBX_NEMBED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get the first SGE entry from the non-embedded DMA memory */</span>
		<span class="n">virtaddr</span> <span class="o">=</span> <span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">virtaddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">n_rsrc_extnt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbx_nembed_rsrc_extent</span> <span class="o">*</span><span class="p">)</span> <span class="n">virtaddr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The resource type is common to all extent Opcodes and resides in the</span>
<span class="cm">	 * same position.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emb</span> <span class="o">==</span> <span class="n">LPFC_SLI4_MBX_EMBED</span><span class="p">)</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_alloc_rsrc_extents_type</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">alloc_rsrc_extents</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
		       <span class="n">rsrc_type</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* This is DMA data.  Byteswap is required. */</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_alloc_rsrc_extents_type</span><span class="p">,</span>
		       <span class="n">n_rsrc_extnt</span><span class="p">,</span> <span class="n">rsrc_type</span><span class="p">);</span>
		<span class="n">lpfc_sli_pcimem_bcopy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n_rsrc_extnt</span><span class="o">-&gt;</span><span class="n">word4</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">n_rsrc_extnt</span><span class="o">-&gt;</span><span class="n">word4</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Complete the initialization for the particular Opcode. */</span>
	<span class="n">opcode</span> <span class="o">=</span> <span class="n">lpfc_sli_config_mbox_opcode_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_ALLOC_RSRC_EXTENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">emb</span> <span class="o">==</span> <span class="n">LPFC_SLI4_MBX_EMBED</span><span class="p">)</span>
			<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_alloc_rsrc_extents_cnt</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">alloc_rsrc_extents</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
			       <span class="n">exts_count</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_alloc_rsrc_extents_cnt</span><span class="p">,</span>
			       <span class="n">n_rsrc_extnt</span><span class="p">,</span> <span class="n">exts_count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_GET_ALLOC_RSRC_EXTENT</span>:
	<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_GET_RSRC_EXTENT_INFO</span>:
	<span class="k">case</span> <span class="n">LPFC_MBOX_OPCODE_DEALLOC_RSRC_EXTENT</span>:
		<span class="cm">/* Initialization is complete.*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
				<span class="s">&quot;2929 Resource Extent Opcode x%x is &quot;</span>
				<span class="s">&quot;unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli_config_mbox_subsys_get - Get subsystem from a sli_config mbox cmd</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command queue entry.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine gets the subsystem from a SLI4 specific SLI_CONFIG mailbox</span>
<span class="cm"> * command. If the mailbox command is not MBX_SLI4_CONFIG (0x9B) or if the</span>
<span class="cm"> * sub-header is not present, subsystem LPFC_MBOX_SUBSYSTEM_NA (0x0) shall</span>
<span class="cm"> * be returned.</span>
<span class="cm"> **/</span>
<span class="kt">uint8_t</span>
<span class="nf">lpfc_sli_config_mbox_subsys_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_sli4_config</span> <span class="o">*</span><span class="n">sli4_cfg</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span> <span class="o">*</span><span class="n">cfg_shdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxCommand</span> <span class="o">!=</span> <span class="n">MBX_SLI4_CONFIG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">LPFC_MBOX_SUBSYSTEM_NA</span><span class="p">;</span>
	<span class="n">sli4_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sli4_config</span><span class="p">;</span>

	<span class="cm">/* For embedded mbox command, get opcode from embedded sub-header*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_emb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sli4_cfg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_mhdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfg_shdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sli4_config</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_shdr</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_subsystem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_shdr</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* For non-embedded mbox command, get opcode from first dma page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">LPFC_MBOX_SUBSYSTEM_NA</span><span class="p">;</span>
	<span class="n">cfg_shdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span> <span class="o">*</span><span class="p">)</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_subsystem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_shdr</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli_config_mbox_opcode_get - Get opcode from a sli_config mbox cmd</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command queue entry.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine gets the opcode from a SLI4 specific SLI_CONFIG mailbox</span>
<span class="cm"> * command. If the mailbox command is not MBX_SLI4_CONFIG (0x9B) or if</span>
<span class="cm"> * the sub-header is not present, opcode LPFC_MBOX_OPCODE_NA (0x0) be</span>
<span class="cm"> * returned.</span>
<span class="cm"> **/</span>
<span class="kt">uint8_t</span>
<span class="nf">lpfc_sli_config_mbox_opcode_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_sli4_config</span> <span class="o">*</span><span class="n">sli4_cfg</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span> <span class="o">*</span><span class="n">cfg_shdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxCommand</span> <span class="o">!=</span> <span class="n">MBX_SLI4_CONFIG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">LPFC_MBOX_OPCODE_NA</span><span class="p">;</span>
	<span class="n">sli4_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sli4_config</span><span class="p">;</span>

	<span class="cm">/* For embedded mbox command, get opcode from embedded sub-header*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_emb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sli4_cfg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_mhdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfg_shdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sli4_config</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_shdr</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_opcode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_shdr</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* For non-embedded mbox command, get opcode from first dma page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">LPFC_MBOX_OPCODE_NA</span><span class="p">;</span>
	<span class="n">cfg_shdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span> <span class="o">*</span><span class="p">)</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_opcode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_shdr</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_mbx_read_fcf_rec - Allocate and construct read fcf mbox cmd</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @fcf_index: index to fcf table.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine routine allocates and constructs non-embedded mailbox command</span>
<span class="cm"> * for reading a FCF table entry referred by @fcf_index.</span>
<span class="cm"> *</span>
<span class="cm"> * Return: pointer to the mailbox command constructed if successful, otherwise</span>
<span class="cm"> * NULL.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_sli4_mbx_read_fcf_rec</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mboxq</span><span class="p">,</span>
			   <span class="kt">uint16_t</span> <span class="n">fcf_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">virt_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">bytep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_sge</span> <span class="n">sge</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">alloc_len</span><span class="p">,</span> <span class="n">req_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_read_fcf_tbl</span> <span class="o">*</span><span class="n">read_fcf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mboxq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">req_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcf_record</span><span class="p">)</span> <span class="o">+</span>
		  <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>

	<span class="cm">/* Set up READ_FCF SLI4_CONFIG mailbox-ioctl command */</span>
	<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">lpfc_sli4_config</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mboxq</span><span class="p">,</span> <span class="n">LPFC_MBOX_SUBSYSTEM_FCOE</span><span class="p">,</span>
			<span class="n">LPFC_MBOX_OPCODE_FCOE_READ_FCF_TABLE</span><span class="p">,</span> <span class="n">req_len</span><span class="p">,</span>
			<span class="n">LPFC_SLI4_MBX_NEMBED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_len</span> <span class="o">&lt;</span> <span class="n">req_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
				<span class="s">&quot;0291 Allocated DMA memory size (x%x) is &quot;</span>
				<span class="s">&quot;less than the requested DMA memory &quot;</span>
				<span class="s">&quot;size (x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">,</span> <span class="n">req_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the first SGE entry from the non-embedded DMA memory. This</span>
<span class="cm">	 * routine only uses a single SGE.</span>
<span class="cm">	 */</span>
	<span class="n">lpfc_sli4_mbx_sge_get</span><span class="p">(</span><span class="n">mboxq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sge</span><span class="p">);</span>
	<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">getPaddr</span><span class="p">(</span><span class="n">sge</span><span class="p">.</span><span class="n">pa_hi</span><span class="p">,</span> <span class="n">sge</span><span class="p">.</span><span class="n">pa_lo</span><span class="p">);</span>
	<span class="n">virt_addr</span> <span class="o">=</span> <span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">sge_array</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">read_fcf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbx_read_fcf_tbl</span> <span class="o">*</span><span class="p">)</span><span class="n">virt_addr</span><span class="p">;</span>

	<span class="cm">/* Set up command fields */</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_read_fcf_tbl_indx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_fcf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">request</span><span class="p">,</span> <span class="n">fcf_index</span><span class="p">);</span>
	<span class="cm">/* Perform necessary endian conversion */</span>
	<span class="n">bytep</span> <span class="o">=</span> <span class="n">virt_addr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span><span class="p">);</span>
	<span class="n">lpfc_sli_pcimem_bcopy</span><span class="p">(</span><span class="n">bytep</span><span class="p">,</span> <span class="n">bytep</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_request_features: Configure SLI4 REQUEST_FEATURES mailbox</span>
<span class="cm"> * @mboxq: pointer to lpfc mbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine sets up the mailbox for an SLI4 REQUEST_FEATURES</span>
<span class="cm"> * mailbox command.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_request_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mboxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set up SLI4 mailbox command header fields */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mboxq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_SLI4_REQ_FTRS</span><span class="p">);</span>

	<span class="cm">/* Set up host requested features. */</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_rq_ftr_rq_fcpi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">req_ftrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_rq_ftr_rq_perfh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">req_ftrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable DIF (block guard) only if configured to do so. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_enable_bg</span><span class="p">)</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_rq_ftr_rq_dif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">req_ftrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable NPIV only if configured to do so. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vpi</span> <span class="o">&amp;&amp;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_enable_npiv</span><span class="p">)</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_rq_ftr_rq_npiv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">req_ftrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_init_vfi - Initialize the INIT_VFI mailbox command</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> * @vport: Vport associated with the VF.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine initializes @mbox to all zeros and then fills in the mailbox</span>
<span class="cm"> * fields from @vport. INIT_VFI configures virtual fabrics identified by VFI</span>
<span class="cm"> * in the context of an FCF. The driver issues this command to setup a VFI</span>
<span class="cm"> * before issuing a FLOGI to login to the VSAN. The driver should also issue a</span>
<span class="cm"> * REG_VFI after a successful VSAN login.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_init_vfi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_init_vfi</span> <span class="o">*</span><span class="n">init_vfi</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
	<span class="n">init_vfi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">init_vfi</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_INIT_VFI</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_init_vfi_vr</span><span class="p">,</span> <span class="n">init_vfi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_init_vfi_vt</span><span class="p">,</span> <span class="n">init_vfi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_init_vfi_vp</span><span class="p">,</span> <span class="n">init_vfi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_init_vfi_vfi</span><span class="p">,</span> <span class="n">init_vfi</span><span class="p">,</span>
	       <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">vfi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vfi</span><span class="p">]);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_init_vfi_vpi</span><span class="p">,</span> <span class="n">init_vfi</span><span class="p">,</span>
	       <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">]);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_init_vfi_fcfi</span><span class="p">,</span> <span class="n">init_vfi</span><span class="p">,</span>
	       <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fcf</span><span class="p">.</span><span class="n">fcfi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_reg_vfi - Initialize the REG_VFI mailbox command</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> * @vport: vport associated with the VF.</span>
<span class="cm"> * @phys: BDE DMA bus address used to send the service parameters to the HBA.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine initializes @mbox to all zeros and then fills in the mailbox</span>
<span class="cm"> * fields from @vport, and uses @buf as a DMAable buffer to send the vport&#39;s</span>
<span class="cm"> * fc service parameters to the HBA for this VFI. REG_VFI configures virtual</span>
<span class="cm"> * fabrics identified by VFI in the context of an FCF.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_reg_vfi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">phys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_reg_vfi</span> <span class="o">*</span><span class="n">reg_vfi</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">reg_vfi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">reg_vfi</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_REG_VFI</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_vfi_vp</span><span class="p">,</span> <span class="n">reg_vfi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_vfi_vfi</span><span class="p">,</span> <span class="n">reg_vfi</span><span class="p">,</span>
	       <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">vfi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vfi</span><span class="p">]);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_vfi_fcfi</span><span class="p">,</span> <span class="n">reg_vfi</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fcf</span><span class="p">.</span><span class="n">fcfi</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_vfi_vpi</span><span class="p">,</span> <span class="n">reg_vfi</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">]);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">wwn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_portname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
	<span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">wwn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">wwn</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_edtov</span><span class="p">;</span>
	<span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span><span class="p">;</span>
	<span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">bde</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">bde</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">bde</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">);</span>
	<span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">bde</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_vfi_nport_id</span><span class="p">,</span> <span class="n">reg_vfi</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">);</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
			<span class="s">&quot;3134 Register VFI, mydid:x%x, fcfi:%d, &quot;</span>
			<span class="s">&quot; vfi:%d, vpi:%d, fc_pname:%x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">,</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fcf</span><span class="p">.</span><span class="n">fcfi</span><span class="p">,</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">vfi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vfi</span><span class="p">],</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">],</span>
			<span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reg_vfi</span><span class="o">-&gt;</span><span class="n">wwn</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_init_vpi - Initialize the INIT_VPI mailbox command</span>
<span class="cm"> * @phba: pointer to the hba structure to init the VPI for.</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> * @vpi: VPI to be initialized.</span>
<span class="cm"> *</span>
<span class="cm"> * The INIT_VPI mailbox command supports virtual N_Ports. The driver uses the</span>
<span class="cm"> * command to activate a virtual N_Port. The HBA assigns a MAC address to use</span>
<span class="cm"> * with the virtual N Port.  The SLI Host issues this command before issuing a</span>
<span class="cm"> * FDISC to connect to the Fabric. The SLI Host should issue a REG_VPI after a</span>
<span class="cm"> * successful virtual NPort login.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_init_vpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">vpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_INIT_VPI</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_init_vpi_vpi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">init_vpi</span><span class="p">,</span>
	       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">vpi</span><span class="p">]);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_init_vpi_vfi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">init_vpi</span><span class="p">,</span>
	       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">vfi_ids</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">vfi</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_unreg_vfi - Initialize the UNREG_VFI mailbox command</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> * @vport: vport associated with the VF.</span>
<span class="cm"> *</span>
<span class="cm"> * The UNREG_VFI mailbox command causes the SLI Host to put a virtual fabric</span>
<span class="cm"> * (logical NPort) into the inactive state. The SLI Host must have logged out</span>
<span class="cm"> * and unregistered all remote N_Ports to abort any activity on the virtual</span>
<span class="cm"> * fabric. The SLI Port posts the mailbox response after marking the virtual</span>
<span class="cm"> * fabric inactive.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_unreg_vfi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_UNREG_VFI</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_unreg_vfi_vfi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">unreg_vfi</span><span class="p">,</span>
	       <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">vfi_ids</span><span class="p">[</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vfi</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_dump_cfg_rg23 - Dump sli4 port config region 23</span>
<span class="cm"> * @phba: pointer to the hba structure containing.</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> *</span>
<span class="cm"> * This function create a SLI4 dump mailbox command to dump configure</span>
<span class="cm"> * region 23.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_sli4_dump_cfg_rg23</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span> <span class="o">||</span> <span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="cm">/* dump config region 23 failed to allocate memory */</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
			<span class="s">&quot;2569 lpfc dump config region 23: memory&quot;</span>
			<span class="s">&quot; allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LPFC_BPL_SIZE</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/* save address for completion */</span>
	<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mp</span><span class="p">;</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_DUMP_MEMORY</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DMP_NV_PARAMS</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">region_id</span> <span class="o">=</span> <span class="n">DMP_REGION_23</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">sli4_length</span> <span class="o">=</span> <span class="n">DMP_RGN23_SIZE</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_reg_fcfi - Initialize the REG_FCFI mailbox command</span>
<span class="cm"> * @phba: pointer to the hba structure containing the FCF index and RQ ID.</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> *</span>
<span class="cm"> * The REG_FCFI mailbox command supports Fibre Channel Forwarders (FCFs). The</span>
<span class="cm"> * SLI Host uses the command to activate an FCF after it has acquired FCF</span>
<span class="cm"> * information via a READ_FCF mailbox command. This mailbox command also is used</span>
<span class="cm"> * to indicate where received unsolicited frames from this FCF will be sent. By</span>
<span class="cm"> * default this routine will set up the FCF to forward all unsolicited frames</span>
<span class="cm"> * the the RQ ID passed in the @phba. This can be overridden by the caller for</span>
<span class="cm"> * more complicated setups.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_reg_fcfi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_reg_fcfi</span> <span class="o">*</span><span class="n">reg_fcfi</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">reg_fcfi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">reg_fcfi</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_REG_FCFI</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_fcfi_rq_id0</span><span class="p">,</span> <span class="n">reg_fcfi</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_fcfi_rq_id1</span><span class="p">,</span> <span class="n">reg_fcfi</span><span class="p">,</span> <span class="n">REG_FCF_INVALID_QID</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_fcfi_rq_id2</span><span class="p">,</span> <span class="n">reg_fcfi</span><span class="p">,</span> <span class="n">REG_FCF_INVALID_QID</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_fcfi_rq_id3</span><span class="p">,</span> <span class="n">reg_fcfi</span><span class="p">,</span> <span class="n">REG_FCF_INVALID_QID</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_fcfi_info_index</span><span class="p">,</span> <span class="n">reg_fcfi</span><span class="p">,</span>
	       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fcf</span><span class="p">.</span><span class="n">current_rec</span><span class="p">.</span><span class="n">fcf_indx</span><span class="p">);</span>
	<span class="cm">/* reg_fcf addr mode is bit wise inverted value of fcf addr_mode */</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_fcfi_mam</span><span class="p">,</span> <span class="n">reg_fcfi</span><span class="p">,</span> <span class="p">(</span><span class="o">~</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fcf</span><span class="p">.</span><span class="n">addr_mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fcf</span><span class="p">.</span><span class="n">current_rec</span><span class="p">.</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="n">LPFC_FCOE_NULL_VID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_fcfi_vv</span><span class="p">,</span> <span class="n">reg_fcfi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_reg_fcfi_vlan_tag</span><span class="p">,</span> <span class="n">reg_fcfi</span><span class="p">,</span>
		       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fcf</span><span class="p">.</span><span class="n">current_rec</span><span class="p">.</span><span class="n">vlan_id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_unreg_fcfi - Initialize the UNREG_FCFI mailbox command</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> * @fcfi: FCFI to be unregistered.</span>
<span class="cm"> *</span>
<span class="cm"> * The UNREG_FCFI mailbox command supports Fibre Channel Forwarders (FCFs).</span>
<span class="cm"> * The SLI Host uses the command to inactivate an FCFI.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_unreg_fcfi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">fcfi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_UNREG_FCFI</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_unreg_fcfi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">unreg_fcfi</span><span class="p">,</span> <span class="n">fcfi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_resume_rpi - Initialize the RESUME_RPI mailbox command</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> * @ndlp: The nodelist structure that describes the RPI to resume.</span>
<span class="cm"> *</span>
<span class="cm"> * The RESUME_RPI mailbox command is used to restart I/O to an RPI after a</span>
<span class="cm"> * link event.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_resume_rpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_resume_rpi</span> <span class="o">*</span><span class="n">resume_rpi</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">resume_rpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">resume_rpi</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_RESUME_RPI</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_resume_rpi_index</span><span class="p">,</span> <span class="n">resume_rpi</span><span class="p">,</span>
	       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">rpi_ids</span><span class="p">[</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">]);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_resume_rpi_ii</span><span class="p">,</span> <span class="n">resume_rpi</span><span class="p">,</span> <span class="n">RESUME_INDEX_RPI</span><span class="p">);</span>
	<span class="n">resume_rpi</span><span class="o">-&gt;</span><span class="n">event_tag</span> <span class="o">=</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_eventTag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_supported_pages - Initialize the PORT_CAPABILITIES supported pages</span>
<span class="cm"> *                        mailbox command.</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> *</span>
<span class="cm"> * The PORT_CAPABILITIES supported pages mailbox command is issued to</span>
<span class="cm"> * retrieve the particular feature pages supported by the port.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_supported_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_supp_pages</span> <span class="o">*</span><span class="n">supp_pages</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">supp_pages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">supp_pages</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_PORT_CAPABILITIES</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">cpn</span><span class="p">,</span> <span class="n">supp_pages</span><span class="p">,</span> <span class="n">LPFC_SUPP_PAGES</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_pc_sli4_params - Initialize the PORT_CAPABILITIES SLI4 Params mbox cmd.</span>
<span class="cm"> * @mbox: pointer to lpfc mbox command to initialize.</span>
<span class="cm"> *</span>
<span class="cm"> * The PORT_CAPABILITIES SLI4 parameters mailbox command is issued to</span>
<span class="cm"> * retrieve the particular SLI4 features supported by the port.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_pc_sli4_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfcMboxq</span> <span class="o">*</span><span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_pc_sli4_params</span> <span class="o">*</span><span class="n">sli4_params</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mbox</span><span class="p">));</span>
	<span class="n">sli4_params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sli4_params</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mqe_command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">,</span> <span class="n">MBX_PORT_CAPABILITIES</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">cpn</span><span class="p">,</span> <span class="n">sli4_params</span><span class="p">,</span> <span class="n">LPFC_SLI4_PARAMETERS</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
