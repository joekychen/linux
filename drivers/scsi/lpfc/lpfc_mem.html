<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › lpfc › lpfc_mem.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lpfc_mem.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex Linux Device Driver for         *</span>
<span class="cm"> * Fibre Channel Host Bus Adapters.                                *</span>
<span class="cm"> * Copyright (C) 2004-2009 Emulex.  All rights reserved.           *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> * Portions Copyright (C) 2004-2005 Christoph Hellwig              *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>

<span class="cp">#include &quot;lpfc_hw4.h&quot;</span>
<span class="cp">#include &quot;lpfc_hw.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli4.h&quot;</span>
<span class="cp">#include &quot;lpfc_nl.h&quot;</span>
<span class="cp">#include &quot;lpfc_disc.h&quot;</span>
<span class="cp">#include &quot;lpfc_scsi.h&quot;</span>
<span class="cp">#include &quot;lpfc.h&quot;</span>
<span class="cp">#include &quot;lpfc_crtn.h&quot;</span>

<span class="cp">#define LPFC_MBUF_POOL_SIZE     64      </span><span class="cm">/* max elements in MBUF safety pool */</span><span class="cp"></span>
<span class="cp">#define LPFC_MEM_POOL_SIZE      64      </span><span class="cm">/* max elem in non-DMA safety pool */</span><span class="cp"></span>


<span class="cm">/**</span>
<span class="cm"> * lpfc_mem_alloc - create and allocate all PCI and memory pools</span>
<span class="cm"> * @phba: HBA to allocate pools for</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Creates and allocates PCI pools lpfc_scsi_dma_buf_pool,</span>
<span class="cm"> * lpfc_mbuf_pool, lpfc_hrb_pool.  Creates and allocates kmalloc-backed mempools</span>
<span class="cm"> * for LPFC_MBOXQ_t and lpfc_nodelist.  Also allocates the VPI bitmask.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: Not interrupt-safe.  Must be called with no locks held.  If any</span>
<span class="cm"> * allocation fails, frees all successfully allocated memory before returning.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *   0 on success</span>
<span class="cm"> *   -ENOMEM on failure (if any memory allocations fail)</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_mem_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dma_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_safety_pool</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_scsi_dma_buf_pool</span> <span class="o">=</span>
			<span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;lpfc_scsi_dma_buf_pool&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_sg_dma_buf_size</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_sg_dma_buf_size</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_scsi_dma_buf_pool</span> <span class="o">=</span>
			<span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;lpfc_scsi_dma_buf_pool&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_sg_dma_buf_size</span><span class="p">,</span>
				<span class="n">align</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_scsi_dma_buf_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;lpfc_mbuf_pool&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
							<span class="n">LPFC_BPL_SIZE</span><span class="p">,</span>
							<span class="n">align</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_dma_buf_pool</span><span class="p">;</span>

	<span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">)</span> <span class="o">*</span>
					 <span class="n">LPFC_MBUF_POOL_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_lpfc_mbuf_pool</span><span class="p">;</span>

	<span class="n">pool</span><span class="o">-&gt;</span><span class="n">max_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LPFC_MBUF_POOL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span><span class="p">,</span>
				       <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_free_mbuf_pool</span><span class="p">;</span>
		<span class="n">pool</span><span class="o">-&gt;</span><span class="n">max_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span> <span class="o">=</span> <span class="n">mempool_create_kmalloc_pool</span><span class="p">(</span><span class="n">LPFC_MEM_POOL_SIZE</span><span class="p">,</span>
							 <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_mbuf_pool</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">nlp_mem_pool</span> <span class="o">=</span> <span class="n">mempool_create_kmalloc_pool</span><span class="p">(</span><span class="n">LPFC_MEM_POOL_SIZE</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_nodelist</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">nlp_mem_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_mbox_pool</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">rrq_pool</span> <span class="o">=</span>
			<span class="n">mempool_create_kmalloc_pool</span><span class="p">(</span><span class="n">LPFC_MEM_POOL_SIZE</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_node_rrq</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">rrq_pool</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_free_nlp_mem_pool</span><span class="p">;</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;lpfc_hrb_pool&quot;</span><span class="p">,</span>
					      <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					      <span class="n">LPFC_HDR_BUF_SIZE</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_free_rrq_mem_pool</span><span class="p">;</span>

		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_drb_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;lpfc_drb_pool&quot;</span><span class="p">,</span>
					      <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					      <span class="n">LPFC_DATA_BUF_SIZE</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_drb_pool</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_free_hrb_pool</span><span class="p">;</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hbq_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hbq_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;lpfc_hbq_pool&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">LPFC_BPL_SIZE</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hbq_pool</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_free_nlp_mem_pool</span><span class="p">;</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_drb_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">fail_free_hrb_pool:</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">fail_free_rrq_mem_pool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">rrq_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">rrq_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">fail_free_nlp_mem_pool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">nlp_mem_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">nlp_mem_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">fail_free_mbox_pool:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">fail_free_mbuf_pool:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt</span><span class="p">,</span>
						 <span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">);</span>
 <span class="nl">fail_free_lpfc_mbuf_pool:</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">fail_free_dma_buf_pool:</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_scsi_dma_buf_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_scsi_dma_buf_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mem_free - Frees memory allocated by lpfc_mem_alloc</span>
<span class="cm"> * @phba: HBA to free memory for</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Free the memory allocated by lpfc_mem_alloc routine. This</span>
<span class="cm"> * routine is a the counterpart of lpfc_mem_alloc.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: None</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_mem_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dma_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_safety_pool</span><span class="p">;</span>

	<span class="cm">/* Free HBQ pools */</span>
	<span class="n">lpfc_sli_hbqbuf_free_all</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_drb_pool</span><span class="p">)</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_drb_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_drb_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span><span class="p">)</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hbq_pool</span><span class="p">)</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hbq_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hbq_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free NLP memory pool */</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">nlp_mem_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">nlp_mem_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free mbox memory pool */</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free MBUF memory pool */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt</span><span class="p">,</span>
			      <span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">);</span>

	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free DMA buffer memory pool */</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_scsi_dma_buf_pool</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_scsi_dma_buf_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mem_free_all - Frees all PCI and driver memory</span>
<span class="cm"> * @phba: HBA to free memory for</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Free memory from PCI and driver memory pools and also those</span>
<span class="cm"> * used : lpfc_scsi_dma_buf_pool, lpfc_mbuf_pool, lpfc_hrb_pool. Frees</span>
<span class="cm"> * kmalloc-backed mempools for LPFC_MBOXQ_t and lpfc_nodelist. Also frees</span>
<span class="cm"> * the VPI bitmask.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: None</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_mem_free_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbox</span><span class="p">,</span> <span class="o">*</span><span class="n">next_mbox</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span>   <span class="o">*</span><span class="n">mp</span><span class="p">;</span>

	<span class="cm">/* Free memory used in mailbox queue back to mailbox memory pool */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">next_mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">mboxq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Free memory used in mailbox cmpl list back to mailbox memory pool */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">next_mbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">mboxq_cmpl</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Free the active mailbox command back to the mailbox memory pool */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">psli</span><span class="o">-&gt;</span><span class="n">sli_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LPFC_SLI_MBOX_ACTIVE</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">mbox_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mbox</span> <span class="o">=</span> <span class="n">psli</span><span class="o">-&gt;</span><span class="n">mbox_active</span><span class="p">;</span>
		<span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="n">psli</span><span class="o">-&gt;</span><span class="n">mbox_active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free and destroy all the allocated memory pools */</span>
	<span class="n">lpfc_mem_free</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="cm">/* Free the iocb lookup array */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">iocbq_lookup</span><span class="p">);</span>
	<span class="n">psli</span><span class="o">-&gt;</span><span class="n">iocbq_lookup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mbuf_alloc - Allocate an mbuf from the lpfc_mbuf_pool PCI pool</span>
<span class="cm"> * @phba: HBA which owns the pool to allocate from</span>
<span class="cm"> * @mem_flags: indicates if this is a priority (MEM_PRI) allocation</span>
<span class="cm"> * @handle: used to return the DMA-mapped address of the mbuf</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Allocates a DMA-mapped buffer from the lpfc_mbuf_pool PCI pool.</span>
<span class="cm"> * Allocates from generic pci_pool_alloc function first and if that fails and</span>
<span class="cm"> * mem_flags has MEM_PRI set (the only defined flag), returns an mbuf from the</span>
<span class="cm"> * HBA&#39;s pool.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: Not interrupt-safe.  Must be called with no locks held.  Takes</span>
<span class="cm"> * phba-&gt;hbalock.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *   pointer to the allocated mbuf on success</span>
<span class="cm"> *   NULL on failure</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">lpfc_mbuf_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mem_flags</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dma_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_safety_pool</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mem_flags</span> <span class="o">&amp;</span> <span class="n">MEM_PRI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span><span class="p">].</span><span class="n">virt</span><span class="p">;</span>
		<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span><span class="p">].</span><span class="n">phys</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __lpfc_mbuf_free - Free an mbuf from the lpfc_mbuf_pool PCI pool (locked)</span>
<span class="cm"> * @phba: HBA which owns the pool to return to</span>
<span class="cm"> * @virt: mbuf to free</span>
<span class="cm"> * @dma: the DMA-mapped address of the lpfc_mbuf_pool to be freed</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Returns an mbuf lpfc_mbuf_pool to the lpfc_mbuf_safety_pool if</span>
<span class="cm"> * it is below its max_count, frees the mbuf otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: Must be called with phba-&gt;hbalock held to synchronize access to</span>
<span class="cm"> * lpfc_mbuf_safety_pool.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: None</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">__lpfc_mbuf_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">virt</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dma_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_safety_pool</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span> <span class="o">&lt;</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">max_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span><span class="p">].</span><span class="n">virt</span> <span class="o">=</span> <span class="n">virt</span><span class="p">;</span>
		<span class="n">pool</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span><span class="p">].</span><span class="n">phys</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
		<span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_mbuf_pool</span><span class="p">,</span> <span class="n">virt</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mbuf_free - Free an mbuf from the lpfc_mbuf_pool PCI pool (unlocked)</span>
<span class="cm"> * @phba: HBA which owns the pool to return to</span>
<span class="cm"> * @virt: mbuf to free</span>
<span class="cm"> * @dma: the DMA-mapped address of the lpfc_mbuf_pool to be freed</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Returns an mbuf lpfc_mbuf_pool to the lpfc_mbuf_safety_pool if</span>
<span class="cm"> * it is below its max_count, frees the mbuf otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: Takes phba-&gt;hbalock.  Can be called with or without other locks held.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: None</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_mbuf_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span> <span class="n">phba</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">virt</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="n">__lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">virt</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_els_hbq_alloc - Allocate an HBQ buffer</span>
<span class="cm"> * @phba: HBA to allocate HBQ buffer for</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Allocates a DMA-mapped HBQ buffer from the lpfc_hrb_pool PCI</span>
<span class="cm"> * pool along a non-DMA-mapped container for it.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: Not interrupt-safe.  Must be called with no locks held.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *   pointer to HBQ on success</span>
<span class="cm"> *   NULL on failure</span>
<span class="cm"> **/</span>
<span class="k">struct</span> <span class="n">hbq_dmabuf</span> <span class="o">*</span>
<span class="nf">lpfc_els_hbq_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hbq_dmabuf</span> <span class="o">*</span><span class="n">hbqbp</span><span class="p">;</span>

	<span class="n">hbqbp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hbq_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hbqbp</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hbqbp</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hbq_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">hbqbp</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hbqbp</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hbqbp</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hbqbp</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">LPFC_BPL_SIZE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hbqbp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_els_hbq_free - Frees an HBQ buffer allocated with lpfc_els_hbq_alloc</span>
<span class="cm"> * @phba: HBA buffer was allocated for</span>
<span class="cm"> * @hbqbp: HBQ container returned by lpfc_els_hbq_alloc</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Frees both the container and the DMA-mapped buffer returned by</span>
<span class="cm"> * lpfc_els_hbq_alloc.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: Can be called with or without locks held.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: None</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_els_hbq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hbq_dmabuf</span> <span class="o">*</span><span class="n">hbqbp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hbq_pool</span><span class="p">,</span> <span class="n">hbqbp</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="n">hbqbp</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hbqbp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_rb_alloc - Allocate an SLI4 Receive buffer</span>
<span class="cm"> * @phba: HBA to allocate a receive buffer for</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Allocates a DMA-mapped receive buffer from the lpfc_hrb_pool PCI</span>
<span class="cm"> * pool along a non-DMA-mapped container for it.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: Not interrupt-safe.  Must be called with no locks held.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *   pointer to HBQ on success</span>
<span class="cm"> *   NULL on failure</span>
<span class="cm"> **/</span>
<span class="k">struct</span> <span class="n">hbq_dmabuf</span> <span class="o">*</span>
<span class="nf">lpfc_sli4_rb_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hbq_dmabuf</span> <span class="o">*</span><span class="n">dma_buf</span><span class="p">;</span>

	<span class="n">dma_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hbq_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dma_buf</span><span class="o">-&gt;</span><span class="n">hbuf</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">dma_buf</span><span class="o">-&gt;</span><span class="n">hbuf</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_buf</span><span class="o">-&gt;</span><span class="n">hbuf</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dma_buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_buf</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_drb_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">dma_buf</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_buf</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span><span class="p">,</span> <span class="n">dma_buf</span><span class="o">-&gt;</span><span class="n">hbuf</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span>
			      <span class="n">dma_buf</span><span class="o">-&gt;</span><span class="n">hbuf</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dma_buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_buf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">LPFC_BPL_SIZE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dma_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_rb_free - Frees a receive buffer</span>
<span class="cm"> * @phba: HBA buffer was allocated for</span>
<span class="cm"> * @dmab: DMA Buffer container returned by lpfc_sli4_hbq_alloc</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Frees both the container and the DMA-mapped buffers returned by</span>
<span class="cm"> * lpfc_sli4_rb_alloc.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: Can be called with or without locks held.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: None</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_sli4_rb_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hbq_dmabuf</span> <span class="o">*</span><span class="n">dmab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_hrb_pool</span><span class="p">,</span> <span class="n">dmab</span><span class="o">-&gt;</span><span class="n">hbuf</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="n">dmab</span><span class="o">-&gt;</span><span class="n">hbuf</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_drb_pool</span><span class="p">,</span> <span class="n">dmab</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="n">dmab</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dmab</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_in_buf_free - Free a DMA buffer</span>
<span class="cm"> * @phba: HBA buffer is associated with</span>
<span class="cm"> * @mp: Buffer to free</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Frees the given DMA buffer in the appropriate way given if the</span>
<span class="cm"> * HBA is running in SLI3 mode with HBQs enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes: Takes phba-&gt;hbalock.  Can be called with or without other locks held.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: None</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_in_buf_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hbq_dmabuf</span> <span class="o">*</span><span class="n">hbq_entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check whether HBQ is still in use */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbq_in_use</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hbq_entry</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hbq_dmabuf</span><span class="p">,</span> <span class="n">dbuf</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hbq_entry</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hbq_entry</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbqs</span><span class="p">[</span><span class="n">LPFC_ELS_HBQ</span><span class="p">].</span><span class="n">hbq_free_buffer</span><span class="p">)</span>
				<span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">hbq_entry</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lpfc_sli_free_hbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">hbq_entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
