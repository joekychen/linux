<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › lpfc › lpfc_nportdisc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lpfc_nportdisc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre> <span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex Linux Device Driver for         *</span>
<span class="cm"> * Fibre Channel Host Bus Adapters.                                *</span>
<span class="cm"> * Copyright (C) 2004-2012 Emulex.  All rights reserved.           *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> * Portions Copyright (C) 2004-2005 Christoph Hellwig              *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>

<span class="cp">#include &quot;lpfc_hw4.h&quot;</span>
<span class="cp">#include &quot;lpfc_hw.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli4.h&quot;</span>
<span class="cp">#include &quot;lpfc_nl.h&quot;</span>
<span class="cp">#include &quot;lpfc_disc.h&quot;</span>
<span class="cp">#include &quot;lpfc_scsi.h&quot;</span>
<span class="cp">#include &quot;lpfc.h&quot;</span>
<span class="cp">#include &quot;lpfc_logmsg.h&quot;</span>
<span class="cp">#include &quot;lpfc_crtn.h&quot;</span>
<span class="cp">#include &quot;lpfc_vport.h&quot;</span>
<span class="cp">#include &quot;lpfc_debugfs.h&quot;</span>


<span class="cm">/* Called to verify a rcv&#39;ed ADISC was intended for us. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_check_adisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">lpfc_name</span> <span class="o">*</span><span class="n">nn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_name</span> <span class="o">*</span><span class="n">pn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* First, we MUST have a RPI registered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_RPI_REGISTERED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Compare the ADISC rsp WWNN / WWPN matches our internal node</span>
<span class="cm">	 * table entry for that node.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_nodename</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_portname</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* we match, return success */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">lpfc_check_sparm</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">class</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flogi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="n">hsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">hsp_value</span><span class="p">,</span> <span class="n">ssp_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The receive data field size and buffer-to-buffer receive data field</span>
<span class="cm">	 * size entries are 16 bits but are represented as two 8-bit fields in</span>
<span class="cm">	 * the driver data structure to account for rsvd bits and other control</span>
<span class="cm">	 * bits.  Reconstruct and compare the fields as a 16-bit values before</span>
<span class="cm">	 * correcting the byte values.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flogi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hsp_value</span> <span class="o">=</span> <span class="p">((</span><span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span><span class="p">);</span>
			<span class="n">ssp_value</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssp_value</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad_service_param</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssp_value</span> <span class="o">&gt;</span> <span class="n">hsp_value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span> <span class="o">=</span>
					<span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span><span class="p">;</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span> <span class="o">=</span>
					<span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">CLASS1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad_service_param</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flogi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hsp_value</span> <span class="o">=</span> <span class="p">((</span><span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span><span class="p">);</span>
			<span class="n">ssp_value</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssp_value</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad_service_param</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssp_value</span> <span class="o">&gt;</span> <span class="n">hsp_value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span> <span class="o">=</span>
					<span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span><span class="p">;</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span> <span class="o">=</span>
					<span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">CLASS2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad_service_param</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flogi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hsp_value</span> <span class="o">=</span> <span class="p">((</span><span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span><span class="p">);</span>
			<span class="n">ssp_value</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssp_value</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">bad_service_param</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssp_value</span> <span class="o">&gt;</span> <span class="n">hsp_value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span> <span class="o">=</span>
					<span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">rcvDataSizeLsb</span><span class="p">;</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span> <span class="o">=</span>
					<span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">rcvDataSizeMsb</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">CLASS3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad_service_param</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Preserve the upper four bits of the MSB from the PLOGI response.</span>
<span class="cm">	 * These bits contain the Buffer-to-Buffer State Change Number</span>
<span class="cm">	 * from the target and need to be passed to the FW.</span>
<span class="cm">	 */</span>
	<span class="n">hsp_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeMsb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeLsb</span><span class="p">;</span>
	<span class="n">ssp_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeMsb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeLsb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssp_value</span> <span class="o">&gt;</span> <span class="n">hsp_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeLsb</span> <span class="o">=</span> <span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeLsb</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeMsb</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeMsb</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span>
				       <span class="p">(</span><span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeMsb</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_nodename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_portname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">portName</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">bad_service_param:</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0207 Device %x &quot;</span>
			 <span class="s">&quot;(%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x) sent &quot;</span>
			 <span class="s">&quot;invalid service parameters.  Ignoring device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span>
			 <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			 <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			 <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			 <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">lpfc_check_elscmpl_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">,</span> <span class="o">*</span><span class="n">prsp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">void</span>     <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">IOCB_t</span>   <span class="o">*</span><span class="n">irsp</span><span class="p">;</span>

	<span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">pcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>

	<span class="cm">/* For lpfc_els_abort, context2 could be zero&#39;ed to delay</span>
<span class="cm">	 * freeing associated memory till after ABTS completes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prsp</span> <span class="o">=</span>  <span class="n">list_get_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">,</span>
				       <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prsp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">prsp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Force ulpStatus error since we are returning NULL ptr */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">=</span> <span class="n">IOSTAT_LOCAL_REJECT</span><span class="p">;</span>
			<span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">IOERR_SLI_ABORTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Free resources / clean up outstanding I/Os</span>
<span class="cm"> * associated with a LPFC_NODELIST entry. This</span>
<span class="cm"> * routine effectively results in a &quot;software abort&quot;.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">lpfc_els_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">completions</span><span class="p">);</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">txcmplq_completions</span><span class="p">);</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">abort_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span>  <span class="o">*</span><span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">LPFC_ELS_RING</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="o">*</span><span class="n">next_iocb</span><span class="p">;</span>

	<span class="cm">/* Abort outstanding I/O on NPort &lt;nlp_DID&gt; */</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;2819 Abort outstanding I/O on NPort x%x &quot;</span>
			 <span class="s">&quot;Data: x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">);</span>

	<span class="n">lpfc_fabric_abort_nport</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>

	<span class="cm">/* First check the txq */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">next_iocb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pring</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check to see if iocb matches the nport we are looking for */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_check_sli_ndlp</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* It matches, so deque and call compl with anp error */</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completions</span><span class="p">);</span>
			<span class="n">pring</span><span class="o">-&gt;</span><span class="n">txq_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Next check the txcmplq */</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pring</span><span class="o">-&gt;</span><span class="n">txcmplq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txcmplq_completions</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">next_iocb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txcmplq_completions</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check to see if iocb matches the nport we are looking for */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_check_sli_ndlp</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">iocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">))</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">dlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abort_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txcmplq_completions</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pring</span><span class="o">-&gt;</span><span class="n">txcmplq</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">next_iocb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abort_list</span><span class="p">,</span> <span class="n">dlist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">dlist</span><span class="p">);</span>
			<span class="n">lpfc_sli_issue_abort_iotag</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">iocb</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Cancel all the IOCBs from the completions list */</span>
	<span class="n">lpfc_sli_cancel_iocbs</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">completions</span><span class="p">,</span> <span class="n">IOSTAT_LOCAL_REJECT</span><span class="p">,</span>
			      <span class="n">IOERR_SLI_ABORTED</span><span class="p">);</span>

	<span class="n">lpfc_cancel_retry_delay_tmo</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_rcv_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>   <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>    <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">icmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbox</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ls_rjt</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ls_rjt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&lt;=</span> <span class="n">LPFC_FDISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Before responding to PLOGI, check for pt2pt mode.</span>
<span class="cm">		 * If we are pt2pt, with an outstanding FLOGI, abort</span>
<span class="cm">		 * the FLOGI and resend it first.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_PT2PT</span><span class="p">)</span> <span class="p">{</span>
			 <span class="n">lpfc_els_abort_flogi</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_PT2PT_PLOGI</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* If the other side is supposed to initiate</span>
<span class="cm">				 * the PLOGI anyway, just ACC it now and</span>
<span class="cm">				 * move on with discovery.</span>
<span class="cm">				 */</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_edtov</span> <span class="o">=</span> <span class="n">FF_DEF_EDTOV</span><span class="p">;</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">=</span> <span class="n">FF_DEF_RATOV</span><span class="p">;</span>
				<span class="cm">/* Start discovery - this should just do</span>
<span class="cm">				   CLEAR_LA */</span>
				<span class="n">lpfc_disc_start</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">lpfc_initial_flogi</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_LOGICAL_BSY</span><span class="p">;</span>
			<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_NOTHING_MORE</span><span class="p">;</span>
			<span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span>
					    <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">lp</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">portName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
				 <span class="s">&quot;0140 PLOGI Reject: invalid nname</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_UNABLE_TPC</span><span class="p">;</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_INVALID_PNAME</span><span class="p">;</span>
		<span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
				 <span class="s">&quot;0141 PLOGI Reject: invalid pname</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_UNABLE_TPC</span><span class="p">;</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_INVALID_NNAME</span><span class="p">;</span>
		<span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lpfc_check_sparm</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">CLASS3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Reject this request because invalid parameters */</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_UNABLE_TPC</span><span class="p">;</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_SPARM_OPTIONS</span><span class="p">;</span>
		<span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">icmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>

	<span class="cm">/* PLOGI chkparm OK */</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
			 <span class="s">&quot;0114 PLOGI chkparm OK Data: x%x x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_fcp_class</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_fcp_info</span> <span class="o">|=</span> <span class="n">CLASS2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_fcp_info</span> <span class="o">|=</span> <span class="n">CLASS3</span><span class="p">;</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls4</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS4</span><span class="p">;</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_maxframe</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeMsb</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeLsb</span><span class="p">;</span>

	<span class="cm">/* no need to reg_login if we are already in one of these states */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>  <span class="n">NLP_STE_NPR_NODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_ADISC</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="n">NLP_STE_REG_LOGIN_ISSUE</span>:
	<span class="k">case</span>  <span class="n">NLP_STE_PRLI_ISSUE</span>:
	<span class="k">case</span>  <span class="n">NLP_STE_UNMAPPED_NODE</span>:
	<span class="k">case</span>  <span class="n">NLP_STE_MAPPED_NODE</span>:
		<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for Nport to NPort pt2pt protocol */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_PT2PT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_PT2PT_PLOGI</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* rcv&#39;ed PLOGI decides what our NPortId will be */</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span> <span class="o">=</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rcvels</span><span class="p">.</span><span class="n">parmRo</span><span class="p">;</span>
		<span class="n">mbox</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbox</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">lpfc_config_link</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_sli_def_mbox_cmpl</span><span class="p">;</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">MBX_NOWAIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_NOT_FINISHED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * For SLI4, the VFI/VPI are registered AFTER the</span>
<span class="cm">		 * Nport with the higher WWPN sends us a PLOGI with</span>
<span class="cm">		 * our assigned NPortId.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
			<span class="n">lpfc_issue_reg_vfi</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

		<span class="n">lpfc_can_disctmo</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mbox</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbox</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Registering an existing RPI behaves differently for SLI3 vs SLI4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">lpfc_unreg_rpi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_reg_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rcvels</span><span class="p">.</span><span class="n">remoteID</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">sp</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ACC PLOGI rsp command needs to execute first,</span>
<span class="cm">	 * queue this mbox command to be processed later.</span>
<span class="cm">	 */</span>
	<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_mbx_cmpl_reg_login</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * mbox-&gt;context2 = lpfc_nlp_get(ndlp) deferred until mailbox</span>
<span class="cm">	 * command issued in lpfc_cmpl_els_acc().</span>
<span class="cm">	 */</span>
	<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NLP_ACC_REGLOGIN</span> <span class="o">|</span> <span class="n">NLP_RCV_PLOGI</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is an outstanding PLOGI issued, abort it before</span>
<span class="cm">	 * sending ACC rsp for received PLOGI. If pending plogi</span>
<span class="cm">	 * is not canceled here, the plogi will be rejected by</span>
<span class="cm">	 * remote port and will be retried. On a configuration with</span>
<span class="cm">	 * single discovery thread, this will cause a huge delay in</span>
<span class="cm">	 * discovery. Also this will cause multiple state machines</span>
<span class="cm">	 * running in parallel for this node.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span> <span class="o">==</span> <span class="n">NLP_STE_PLOGI_ISSUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* software abort outstanding PLOGI */</span>
		<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">LPFC_NPIV_PORT</span> <span class="o">&amp;&amp;</span>
	     <span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_restrict_login</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* In order to preserve RPIs, we want to cleanup</span>
<span class="cm">		 * the default RPI the firmware created to rcv</span>
<span class="cm">		 * this ELS request. The only way to do this is</span>
<span class="cm">		 * to register, then unregister the RPI.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_RM_DFLT_RPI</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_INVALID_CMD</span><span class="p">;</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_NOTHING_MORE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span>
			<span class="n">ndlp</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_UNABLE_TPC</span><span class="p">;</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_OUT_OF_RESOURCE</span><span class="p">;</span>
	<span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_mbx_cmpl_resume_rpi - Resume RPI completion routine</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @mboxq: pointer to mailbox object</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is invoked to issue a completion to a rcv&#39;ed</span>
<span class="cm"> * ADISC or PDISC after the paused RPI has been resumed.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_mbx_cmpl_resume_rpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mboxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">elsiocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">elsiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span><span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="n">ndlp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="p">)</span> <span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="n">vport</span> <span class="o">=</span> <span class="n">mboxq</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">elsiocb</span><span class="o">-&gt;</span><span class="n">drvrTimeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ELS_CMD_ADISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_els_rsp_adisc_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">elsiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">,</span> <span class="n">elsiocb</span><span class="p">,</span>
			<span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">elsiocb</span><span class="p">);</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">mboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_rcv_padisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>   <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span>  <span class="o">*</span><span class="n">elsiocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serv_parm</span>   <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_name</span>   <span class="o">*</span><span class="n">pnn</span><span class="p">,</span> <span class="o">*</span><span class="n">ppn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ls_rjt</span> <span class="n">stat</span><span class="p">;</span>
	<span class="n">ADISC</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">icmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">pcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="o">*</span><span class="n">lp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ELS_CMD_ADISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADISC</span> <span class="o">*</span><span class="p">)</span> <span class="n">lp</span><span class="p">;</span>
		<span class="n">pnn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">;</span>
		<span class="n">ppn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">portName</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="p">)</span> <span class="n">lp</span><span class="p">;</span>
		<span class="n">pnn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">;</span>
		<span class="n">ppn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">portName</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">icmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">lpfc_check_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">pnn</span><span class="p">,</span> <span class="n">ppn</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * As soon as  we send ACC, the remote NPort can</span>
<span class="cm">		 * start sending us data. Thus, for SLI4 we must</span>
<span class="cm">		 * resume the RPI before the ACC goes out.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">elsiocb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">elsiocb</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* Save info from cmd IOCB used in rsp */</span>
				<span class="n">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">elsiocb</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">cmdiocb</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span><span class="p">));</span>

				<span class="cm">/* Save the ELS cmd */</span>
				<span class="n">elsiocb</span><span class="o">-&gt;</span><span class="n">drvrTimeout</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

				<span class="n">lpfc_sli4_resume_rpi</span><span class="p">(</span><span class="n">ndlp</span><span class="p">,</span>
					<span class="n">lpfc_mbx_cmpl_resume_rpi</span><span class="p">,</span> <span class="n">elsiocb</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ELS_CMD_ADISC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_els_rsp_adisc_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span>
				<span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">out:</span>
		<span class="cm">/* If we are authenticated, move to the proper state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_TARGET</span><span class="p">)</span>
			<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_MAPPED_NODE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_UNMAPPED_NODE</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Reject this request because invalid parameters */</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsvd0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_UNABLE_TPC</span><span class="p">;</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_SPARM_OPTIONS</span><span class="p">;</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">vendorUnique</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* 1 sec timeout */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_delayfunc</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_DELAY_TMO</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_last_elscmd</span> <span class="o">=</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">;</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_rcv_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">els_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>    <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span><span class="n">vports</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">active_vlink_present</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="cm">/* Put ndlp in NPR state with 1 sec timeout for plogi, ACC logo */</span>
	<span class="cm">/* Only call LOGO ACC for first LOGO, this avoids sending unnecessary</span>
<span class="cm">	 * PLOGIs during LOGO storms from a device.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_LOGO_ACC</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">els_cmd</span> <span class="o">==</span> <span class="n">ELS_CMD_PRLO</span><span class="p">)</span>
		<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_PRLO</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_ACC</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span> <span class="o">==</span> <span class="n">Fabric_DID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&lt;=</span> <span class="n">LPFC_FDISC</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">lpfc_linkdown_port</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">|=</span> <span class="n">FC_VPORT_LOGO_RCVD</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">vports</span> <span class="o">=</span> <span class="n">lpfc_create_vport_work_array</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vports</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vports</span> <span class="o">&amp;&amp;</span> <span class="n">vports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">vports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span>
					<span class="n">FC_VPORT_LOGO_RCVD</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">vports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&gt;</span> <span class="n">LPFC_FDISC</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">active_vlink_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">lpfc_destroy_vport_work_array</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vports</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">active_vlink_present</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If there are other active VLinks present,</span>
<span class="cm">			 * re-instantiate the Vlink using FDISC.</span>
<span class="cm">			 */</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_delayfunc</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_DELAY_TMO</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_last_elscmd</span> <span class="o">=</span> <span class="n">ELS_CMD_FDISC</span><span class="p">;</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="n">LPFC_FDISC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_LOGO_RCVD_DID_CHNG</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">lpfc_retry_pport_discovery</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FABRIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_TARGET</span><span class="p">)</span> <span class="o">||</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_INITIATOR</span><span class="p">)))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span> <span class="o">==</span> <span class="n">NLP_STE_ADISC_ISSUE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Only try to re-login if this is NOT a Fabric Node */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_delayfunc</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_DELAY_TMO</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_last_elscmd</span> <span class="o">=</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_NPR_ADISC</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="cm">/* The driver has to wait until the ACC completes before it continues</span>
<span class="cm">	 * processing the LOGO.  The action will resume in</span>
<span class="cm">	 * lpfc_cmpl_els_logo_acc routine. Since part of processing includes an</span>
<span class="cm">	 * unreg_login, the driver waits so the ACC does not get aborted.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_rcv_prli</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">PRLI</span> <span class="o">*</span><span class="n">npr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">roles</span><span class="p">;</span>

	<span class="n">pcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">npr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRLI</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">lp</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_FCP_TARGET</span> <span class="o">|</span> <span class="n">NLP_FCP_INITIATOR</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_fcp_info</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_FCP_2_DEVICE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npr</span><span class="o">-&gt;</span><span class="n">prliType</span> <span class="o">==</span> <span class="n">PRLI_FCP_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npr</span><span class="o">-&gt;</span><span class="n">initiatorFunc</span><span class="p">)</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">|=</span> <span class="n">NLP_FCP_INITIATOR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npr</span><span class="o">-&gt;</span><span class="n">targetFunc</span><span class="p">)</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">|=</span> <span class="n">NLP_FCP_TARGET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npr</span><span class="o">-&gt;</span><span class="n">Retry</span><span class="p">)</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_fcp_info</span> <span class="o">|=</span> <span class="n">NLP_FCP_2_DEVICE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We need to update the rport role values */</span>
		<span class="n">roles</span> <span class="o">=</span> <span class="n">FC_RPORT_ROLE_UNKNOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_INITIATOR</span><span class="p">)</span>
			<span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_INITIATOR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_TARGET</span><span class="p">)</span>
			<span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_TARGET</span><span class="p">;</span>

		<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_RPORT</span><span class="p">,</span>
			<span class="s">&quot;rport rolechg:   role:x%x did:x%x flg:x%x&quot;</span><span class="p">,</span>
			<span class="n">roles</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">);</span>

		<span class="n">fc_remote_port_rolechg</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span> <span class="n">roles</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_disc_set_adisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_RPI_REGISTERED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_NPR_ADISC</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_PT2PT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check config parameter use-adisc or FCP-2 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_use_adisc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_MODE</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_fcp_info</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_2_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_TARGET</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_NPR_ADISC</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_NPR_ADISC</span><span class="p">;</span>
	<span class="n">lpfc_unreg_rpi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_release_rpi - Release a RPI by issuing unreg_login mailbox cmd.</span>
<span class="cm"> * @phba : Pointer to lpfc_hba structure.</span>
<span class="cm"> * @vport: Pointer to lpfc_vport structure.</span>
<span class="cm"> * @rpi  : rpi to be release.</span>
<span class="cm"> *</span>
<span class="cm"> * This function will send a unreg_login mailbox command to the firmware</span>
<span class="cm"> * to release a rpi.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_release_rpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
		<span class="kt">uint16_t</span> <span class="n">rpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pmb</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmb</span><span class="p">)</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
			<span class="s">&quot;2796 mailbox memory allocation failed </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_unreg_login</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">rpi</span><span class="p">,</span> <span class="n">pmb</span><span class="p">);</span>
		<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_sli_def_mbox_cmpl</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmb</span><span class="p">,</span> <span class="n">MBX_NOWAIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_NOT_FINISHED</span><span class="p">)</span>
			<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_disc_illegal</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
		  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">rpi</span><span class="p">;</span>

	<span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="cm">/* Release the RPI if reglogin completing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">&amp;</span> <span class="n">FC_UNLOADING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">evt</span> <span class="o">==</span> <span class="n">NLP_EVT_CMPL_REG_LOGIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="o">!</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
		<span class="n">rpi</span> <span class="o">=</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">lpfc_release_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="p">,</span> <span class="n">rpi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0271 Illegal State Transition: node x%x &quot;</span>
			 <span class="s">&quot;event x%x, state x%x Data: x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_plogi_illegal</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
		  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This transition is only legal if we previously</span>
<span class="cm">	 * rcv&#39;ed a PLOGI. Since we don&#39;t want 2 discovery threads</span>
<span class="cm">	 * working on the same NPortID, do nothing for this thread</span>
<span class="cm">	 * to stop it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_RCV_PLOGI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0272 Illegal State Transition: node x%x &quot;</span>
			 <span class="s">&quot;event x%x, state x%x Data: x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Start of Discovery State Machine routines */</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_plogi_unused_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_rcv_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_els_unused_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lpfc_issue_els_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_logo_unused_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>  <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_LOGO_ACC</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_ACC</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_logo_unused_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_rm_unused_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_recov_unused_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_plogi_plogi_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>   <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">pcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">lp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ls_rjt</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_cmp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ls_rjt</span><span class="p">));</span>

	<span class="cm">/* For a PLOGI, we only accept if our portname is less</span>
<span class="cm">	 * than the remote portname.</span>
<span class="cm">	 */</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_stat</span><span class="p">.</span><span class="n">elsLogiCol</span><span class="o">++</span><span class="p">;</span>
	<span class="n">port_cmp</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_portname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">portName</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port_cmp</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reject this request because the remote node will accept</span>
<span class="cm">		   ours */</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_UNABLE_TPC</span><span class="p">;</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_CMD_IN_PROGRESS</span><span class="p">;</span>
		<span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_rcv_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_NPR_2B_DISC</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="cm">/* Check if there are more PLOGIs to be sent */</span>
			<span class="n">lpfc_more_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
				<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_NDISC_ACTIVE</span><span class="p">;</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
				<span class="n">lpfc_can_disctmo</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
				<span class="n">lpfc_end_rscn</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* If our portname was less */</span>

	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prli_plogi_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ls_rjt</span>     <span class="n">stat</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ls_rjt</span><span class="p">));</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_LOGICAL_BSY</span><span class="p">;</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_NOTHING_MORE</span><span class="p">;</span>
	<span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_logo_plogi_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

				<span class="cm">/* software abort outstanding PLOGI */</span>
	<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="n">lpfc_rcv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ELS_CMD_LOGO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_els_plogi_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>  <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* software abort outstanding PLOGI */</span>
	<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evt</span> <span class="o">==</span> <span class="n">NLP_EVT_RCV_LOGO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_ACC</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_issue_els_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Put ndlp in npr state set plogi timer for 1 sec */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_delayfunc</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_DELAY_TMO</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_last_elscmd</span> <span class="o">=</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">;</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_PLOGI_ISSUE</span><span class="p">;</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_plogi_plogi_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>    <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span>  <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">,</span> <span class="o">*</span><span class="n">prsp</span><span class="p">,</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbox</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">rspiocb</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">rsp_iocb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_ACC_REGLOGIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Recovery from PLOGI collision logic */</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>

	<span class="n">prsp</span> <span class="o">=</span> <span class="n">list_get_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">prsp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">lp</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>

	<span class="cm">/* Some switches have FDMI servers returning 0 for WWN */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span> <span class="o">!=</span> <span class="n">FDMI_DID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">portName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">wwn_to_u64</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
				 <span class="s">&quot;0142 PLOGI RSP: Invalid WWN.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_check_sparm</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">CLASS3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* PLOGI chkparm OK */</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
			 <span class="s">&quot;0121 PLOGI chkparm OK Data: x%x x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_fcp_class</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">classValid</span><span class="p">))</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_fcp_info</span> <span class="o">|=</span> <span class="n">CLASS2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_fcp_info</span> <span class="o">|=</span> <span class="n">CLASS3</span><span class="p">;</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls1</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls2</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls3</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cls4</span><span class="p">.</span><span class="n">classValid</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_class_sup</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS4</span><span class="p">;</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_maxframe</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeMsb</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span><span class="n">bbRcvSizeLsb</span><span class="p">;</span>

	<span class="n">mbox</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbox</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
			<span class="s">&quot;0133 PLOGI: no memory for reg_login &quot;</span>
			<span class="s">&quot;Data: x%x x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">,</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lpfc_unreg_rpi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_reg_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">elsreq64</span><span class="p">.</span><span class="n">remoteID</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">sp</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NameServer_DID</span>:
			<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_mbx_cmpl_ns_reg_login</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FDMI_DID</span>:
			<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_mbx_cmpl_fdmi_reg_login</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_REG_LOGIN_SEND</span><span class="p">;</span>
			<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_mbx_cmpl_reg_login</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="n">lpfc_nlp_get</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">MBX_NOWAIT</span><span class="p">)</span>
		    <span class="o">!=</span> <span class="n">MBX_NOT_FINISHED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span>
					   <span class="n">NLP_STE_REG_LOGIN_ISSUE</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_REG_LOGIN_SEND</span><span class="p">)</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_REG_LOGIN_SEND</span><span class="p">;</span>
		<span class="cm">/* decrement node reference count to the failed mbox</span>
<span class="cm">		 * command</span>
<span class="cm">		 */</span>
		<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
		<span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
		<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>

		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
				 <span class="s">&quot;0134 PLOGI: cannot issue reg_login &quot;</span>
				 <span class="s">&quot;Data: x%x x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">,</span>
				 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>

		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
				 <span class="s">&quot;0135 PLOGI: cannot format reg_login &quot;</span>
				 <span class="s">&quot;Data: x%x x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">,</span>
				 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">);</span>
	<span class="p">}</span>


<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span> <span class="o">==</span> <span class="n">NameServer_DID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
				 <span class="s">&quot;0261 Cannot Register NameServer login</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_DEFER_RM</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_logo_plogi_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_reglogin_plogi_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">rpi</span><span class="p">;</span>

	<span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="cm">/* Release the RPI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">&amp;</span> <span class="n">FC_UNLOADING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpi</span> <span class="o">=</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">lpfc_release_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="p">,</span> <span class="n">rpi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_rm_plogi_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_NODEV_REMOVE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* software abort outstanding PLOGI */</span>
		<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

		<span class="n">lpfc_drop_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_recov_plogi_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			      <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>  <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t do anything that will mess up processing of the</span>
<span class="cm">	 * previous RSCN.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_DEFERRED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>

	<span class="cm">/* software abort outstanding PLOGI */</span>
	<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_PLOGI_ISSUE</span><span class="p">;</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_NODEV_REMOVE</span> <span class="o">|</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_plogi_adisc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>   <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">;</span>

	<span class="cm">/* software abort outstanding ADISC */</span>
	<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_rcv_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_NPR_2B_DISC</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span><span class="p">)</span>
				<span class="n">lpfc_more_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_ADISC_ISSUE</span><span class="p">;</span>
	<span class="n">lpfc_issue_els_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_PLOGI_ISSUE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prli_adisc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_els_rsp_prli_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_logo_adisc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* software abort outstanding ADISC */</span>
	<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="n">lpfc_rcv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ELS_CMD_LOGO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_padisc_adisc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_padisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prlo_adisc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* Treat like rcv logo */</span>
	<span class="n">lpfc_rcv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ELS_CMD_PRLO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_adisc_adisc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>  <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span><span class="p">;</span>
	<span class="n">ADISC</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">rspiocb</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">rsp_iocb</span><span class="p">;</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADISC</span> <span class="o">*</span><span class="p">)</span><span class="n">lpfc_check_elscmpl_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">rspiocb</span><span class="p">);</span>
	<span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">lpfc_check_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">nodeName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">portName</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* 1 sec timeout */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_delayfunc</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_DELAY_TMO</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_last_elscmd</span> <span class="o">=</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_nodename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_portname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>

		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_ADISC_ISSUE</span><span class="p">;</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
		<span class="n">lpfc_unreg_rpi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_resume_rpi</span><span class="p">(</span><span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Stay in state and retry. */</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_ADISC_ISSUE</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_TARGET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_ADISC_ISSUE</span><span class="p">;</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_MAPPED_NODE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_ADISC_ISSUE</span><span class="p">;</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_UNMAPPED_NODE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_rm_adisc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_NODEV_REMOVE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* software abort outstanding ADISC */</span>
		<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

		<span class="n">lpfc_drop_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_recov_adisc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			      <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>  <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t do anything that will mess up processing of the</span>
<span class="cm">	 * previous RSCN.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_DEFERRED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>

	<span class="cm">/* software abort outstanding ADISC */</span>
	<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_ADISC_ISSUE</span><span class="p">;</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_NODEV_REMOVE</span> <span class="o">|</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">lpfc_disc_set_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_plogi_reglogin_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			      <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prli_reglogin_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_els_rsp_prli_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_logo_reglogin_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span>	  <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span>	  <span class="o">*</span><span class="n">nextmb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* cleanup any ndlp on mbox q waiting for reglogin cmpl */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mb</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">mbox_active</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxCommand</span> <span class="o">==</span> <span class="n">MBX_REG_LOGIN64</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">ndlp</span> <span class="o">==</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="p">)</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_sli_def_mbox_cmpl</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">nextmb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">mboxq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxCommand</span> <span class="o">==</span> <span class="n">MBX_REG_LOGIN64</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">ndlp</span> <span class="o">==</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="p">)</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">mboxq_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">mempool_free</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>

	<span class="n">lpfc_rcv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ELS_CMD_LOGO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_padisc_reglogin_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			       <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_padisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prlo_reglogin_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_PRLO</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_reglogin_reglogin_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
				  <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">did</span>  <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RegLogin failed */</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				<span class="s">&quot;0246 RegLogin failed Data: x%x x%x x%x x%x &quot;</span>
				 <span class="s">&quot;x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">did</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxStatus</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="p">,</span>
				 <span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegLogin</span><span class="p">.</span><span class="n">vpi</span><span class="p">,</span>
				 <span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRegLogin</span><span class="p">.</span><span class="n">rpi</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If RegLogin failed due to lack of HBA resources do not</span>
<span class="cm">		 * retry discovery.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxStatus</span> <span class="o">==</span> <span class="n">MBXERR_RPI_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_REG_LOGIN_ISSUE</span><span class="p">;</span>
			<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Put ndlp in npr state set plogi timer for 1 sec */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_delayfunc</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_DELAY_TMO</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_last_elscmd</span> <span class="o">=</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">;</span>

		<span class="n">lpfc_issue_els_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_REG_LOGIN_ISSUE</span><span class="p">;</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SLI4 ports have preallocated logical rpis. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_RPI_REGISTERED</span><span class="p">;</span>

	<span class="cm">/* Only if we are not a fabric nport do we issue PRLI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FABRIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_REG_LOGIN_ISSUE</span><span class="p">;</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_PRLI_ISSUE</span><span class="p">);</span>
		<span class="n">lpfc_issue_els_prli</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_REG_LOGIN_ISSUE</span><span class="p">;</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_UNMAPPED_NODE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_rm_reglogin_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			      <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_NODEV_REMOVE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_drop_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_recov_reglogin_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t do anything that will mess up processing of the</span>
<span class="cm">	 * previous RSCN.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_DEFERRED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_REG_LOGIN_ISSUE</span><span class="p">;</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_IGNR_REG_CMPL</span><span class="p">;</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_NODEV_REMOVE</span> <span class="o">|</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">lpfc_disc_set_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_plogi_prli_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prli_prli_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_els_rsp_prli_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_logo_prli_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* Software abort outstanding PRLI before sending acc */</span>
	<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="n">lpfc_rcv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ELS_CMD_LOGO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_padisc_prli_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_padisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine is envoked when we rcv a PRLO request from a nport</span>
<span class="cm"> * we are logged into.  We should send back a PRLO rsp setting the</span>
<span class="cm"> * appropriate bits.</span>
<span class="cm"> * NEXT STATE = PRLI_ISSUE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prlo_prli_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_PRLO</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_prli_prli_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span><span class="p">;</span>
	<span class="n">PRLI</span> <span class="o">*</span><span class="n">npr</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">rspiocb</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">rsp_iocb</span><span class="p">;</span>
	<span class="n">npr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRLI</span> <span class="o">*</span><span class="p">)</span><span class="n">lpfc_check_elscmpl_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">rspiocb</span><span class="p">);</span>

	<span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">LPFC_NPIV_PORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_restrict_login</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_PRLI_ISSUE</span><span class="p">;</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_UNMAPPED_NODE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check out PRLI rsp */</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_FCP_TARGET</span> <span class="o">|</span> <span class="n">NLP_FCP_INITIATOR</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_fcp_info</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_FCP_2_DEVICE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">npr</span><span class="o">-&gt;</span><span class="n">acceptRspCode</span> <span class="o">==</span> <span class="n">PRLI_REQ_EXECUTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">npr</span><span class="o">-&gt;</span><span class="n">prliType</span> <span class="o">==</span> <span class="n">PRLI_FCP_TYPE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npr</span><span class="o">-&gt;</span><span class="n">initiatorFunc</span><span class="p">)</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">|=</span> <span class="n">NLP_FCP_INITIATOR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npr</span><span class="o">-&gt;</span><span class="n">targetFunc</span><span class="p">)</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">|=</span> <span class="n">NLP_FCP_TARGET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npr</span><span class="o">-&gt;</span><span class="n">Retry</span><span class="p">)</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_fcp_info</span> <span class="o">|=</span> <span class="n">NLP_FCP_2_DEVICE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_TARGET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">LPFC_NPIV_PORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_restrict_login</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">out:</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_TARGET_REMOVE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">lpfc_issue_els_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_PRLI_ISSUE</span><span class="p">;</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_PRLI_ISSUE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_TARGET</span><span class="p">)</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_MAPPED_NODE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_UNMAPPED_NODE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*! lpfc_device_rm_prli_issue</span>
<span class="cm"> *</span>
<span class="cm"> * \pre</span>
<span class="cm"> * \post</span>
<span class="cm"> * \param   phba</span>
<span class="cm"> * \param   ndlp</span>
<span class="cm"> * \param   arg</span>
<span class="cm"> * \param   evt</span>
<span class="cm"> * \return  uint32_t</span>
<span class="cm"> *</span>
<span class="cm"> * \b Description:</span>
<span class="cm"> *    This routine is envoked when we a request to remove a nport we are in the</span>
<span class="cm"> *    process of PRLIing. We should software abort outstanding prli, unreg</span>
<span class="cm"> *    login, send a logout. We will change node state to UNUSED_NODE, put it</span>
<span class="cm"> *    on plogi list so it can be freed when LOGO completes.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_rm_prli_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_NODEV_REMOVE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* software abort outstanding PLOGI */</span>
		<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

		<span class="n">lpfc_drop_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*! lpfc_device_recov_prli_issue</span>
<span class="cm"> *</span>
<span class="cm"> * \pre</span>
<span class="cm"> * \post</span>
<span class="cm"> * \param   phba</span>
<span class="cm"> * \param   ndlp</span>
<span class="cm"> * \param   arg</span>
<span class="cm"> * \param   evt</span>
<span class="cm"> * \return  uint32_t</span>
<span class="cm"> *</span>
<span class="cm"> * \b Description:</span>
<span class="cm"> *    The routine is envoked when the state of a device is unknown, like</span>
<span class="cm"> *    during a link down. We should remove the nodelist entry from the</span>
<span class="cm"> *    unmapped list, issue a UNREG_LOGIN, do a software abort of the</span>
<span class="cm"> *    outstanding PRLI command, then free the node entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_recov_prli_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>  <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t do anything that will mess up processing of the</span>
<span class="cm">	 * previous RSCN.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_DEFERRED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>

	<span class="cm">/* software abort outstanding PRLI */</span>
	<span class="n">lpfc_els_abort</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_PRLI_ISSUE</span><span class="p">;</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_NODEV_REMOVE</span> <span class="o">|</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">lpfc_disc_set_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_plogi_unmap_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prli_unmap_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_prli</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="n">lpfc_els_rsp_prli_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_logo_unmap_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ELS_CMD_LOGO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_padisc_unmap_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_padisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prlo_unmap_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_PRLO</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_recov_unmap_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_UNMAPPED_NODE</span><span class="p">;</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_NODEV_REMOVE</span> <span class="o">|</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">lpfc_disc_set_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_plogi_mapped_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prli_mapped_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_els_rsp_prli_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_logo_mapped_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ELS_CMD_LOGO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_padisc_mapped_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_padisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prlo_mapped_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>  <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* flush the target */</span>
	<span class="n">lpfc_sli_abort_iocb</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">ring</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">fcp_ring</span><span class="p">],</span>
			    <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_sid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LPFC_CTX_TGT</span><span class="p">);</span>

	<span class="cm">/* Treat like rcv logo */</span>
	<span class="n">lpfc_rcv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ELS_CMD_PRLO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_recov_mapped_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
			      <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_MAPPED_NODE</span><span class="p">;</span>
	<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_NODEV_REMOVE</span> <span class="o">|</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">lpfc_disc_set_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_plogi_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span>  <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* Ignore PLOGI if we have an outstanding LOGO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NLP_LOGO_SND</span> <span class="o">|</span> <span class="n">NLP_LOGO_ACC</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_rcv_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_cancel_retry_delay_tmo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_NPR_ADISC</span> <span class="o">|</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* send PLOGI immediately, move to PLOGI issue state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_DELAY_TMO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">;</span>
			<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_PLOGI_ISSUE</span><span class="p">);</span>
			<span class="n">lpfc_issue_els_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prli_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>  <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ls_rjt</span>     <span class="n">stat</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ls_rjt</span><span class="p">));</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCode</span> <span class="o">=</span> <span class="n">LSRJT_UNABLE_TPC</span><span class="p">;</span>
	<span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">lsRjtRsnCodeExp</span> <span class="o">=</span> <span class="n">LSEXP_NOTHING_MORE</span><span class="p">;</span>
	<span class="n">lpfc_els_rsp_reject</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">lsRjtError</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_DELAY_TMO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_ADISC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_NPR_ADISC</span><span class="p">;</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_ADISC_ISSUE</span><span class="p">);</span>
			<span class="n">lpfc_issue_els_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">;</span>
			<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_PLOGI_ISSUE</span><span class="p">);</span>
			<span class="n">lpfc_issue_els_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_logo_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ELS_CMD_LOGO</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_padisc_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">lpfc_rcv_padisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Do not start discovery if discovery is about to start</span>
<span class="cm">	 * or discovery in progress for this node. Starting discovery</span>
<span class="cm">	 * here will affect the counting of discovery threads.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_DELAY_TMO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_ADISC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_NPR_ADISC</span><span class="p">;</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">;</span>
			<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_ADISC_ISSUE</span><span class="p">);</span>
			<span class="n">lpfc_issue_els_adisc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_prev_state</span> <span class="o">=</span> <span class="n">NLP_STE_NPR_NODE</span><span class="p">;</span>
			<span class="n">lpfc_nlp_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">NLP_STE_PLOGI_ISSUE</span><span class="p">);</span>
			<span class="n">lpfc_issue_els_plogi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_rcv_prlo_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_LOGO_ACC</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">lpfc_els_rsp_acc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ELS_CMD_ACC</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_DELAY_TMO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_delayfunc</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_DELAY_TMO</span><span class="p">;</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_NPR_ADISC</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_last_elscmd</span> <span class="o">=</span> <span class="n">ELS_CMD_PLOGI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NLP_NPR_ADISC</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_plogi_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">rspiocb</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">rsp_iocb</span><span class="p">;</span>

	<span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_DEFER_RM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_prli_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">rspiocb</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">rsp_iocb</span><span class="p">;</span>

	<span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NODEV_REMOVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_drop_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_logo_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span> <span class="o">==</span> <span class="n">Fabric_DID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FC_FABRIC</span> <span class="o">|</span> <span class="n">FC_PUBLIC_LOOP</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lpfc_unreg_rpi</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_adisc_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span><span class="p">;</span>

	<span class="n">cmdiocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">rspiocb</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">rsp_iocb</span><span class="p">;</span>

	<span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NODEV_REMOVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_drop_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_cmpl_reglogin_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span>    <span class="o">*</span><span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SLI4 ports have preallocated logical rpis. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_RPI_REGISTERED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NODEV_REMOVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_drop_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_rm_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">|=</span> <span class="n">NLP_NODEV_REMOVE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_drop_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NLP_STE_FREED_NODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_device_recov_npr_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t do anything that will mess up processing of the</span>
<span class="cm">	 * previous RSCN.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_DEFERRED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>

	<span class="n">lpfc_cancel_retry_delay_tmo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NLP_NODEV_REMOVE</span> <span class="o">|</span> <span class="n">NLP_NPR_2B_DISC</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This next section defines the NPort Discovery State Machine */</span>

<span class="cm">/* There are 4 different double linked lists nodelist entries can reside on.</span>
<span class="cm"> * The plogi list and adisc list are used when Link Up discovery or RSCN</span>
<span class="cm"> * processing is needed. Each list holds the nodes that we will send PLOGI</span>
<span class="cm"> * or ADISC on. These lists will keep track of what nodes will be effected</span>
<span class="cm"> * by an RSCN, or a Link Up (Typically, all nodes are effected on Link Up).</span>
<span class="cm"> * The unmapped_list will contain all nodes that we have successfully logged</span>
<span class="cm"> * into at the Fibre Channel level. The mapped_list will contain all nodes</span>
<span class="cm"> * that are mapped FCP targets.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * The bind list is a list of undiscovered (potentially non-existent) nodes</span>
<span class="cm"> * that we have saved binding information on. This information is used when</span>
<span class="cm"> * nodes transition from the unmapped to the mapped list.</span>
<span class="cm"> */</span>
<span class="cm">/* For UNUSED_NODE state, the node has just been allocated .</span>
<span class="cm"> * For PLOGI_ISSUE and REG_LOGIN_ISSUE, the node is on</span>
<span class="cm"> * the PLOGI list. For REG_LOGIN_COMPL, the node is taken off the PLOGI list</span>
<span class="cm"> * and put on the unmapped list. For ADISC processing, the node is taken off</span>
<span class="cm"> * the ADISC list and placed on either the mapped or unmapped list (depending</span>
<span class="cm"> * on its previous state). Once on the unmapped list, a PRLI is issued and the</span>
<span class="cm"> * state changed to PRLI_ISSUE. When the PRLI completion occurs, the state is</span>
<span class="cm"> * changed to UNMAPPED_NODE. If the completion indicates a mapped</span>
<span class="cm"> * node, the node is taken off the unmapped list. The binding list is checked</span>
<span class="cm"> * for a valid binding, or a binding is automatically assigned. If binding</span>
<span class="cm"> * assignment is unsuccessful, the node is left on the unmapped list. If</span>
<span class="cm"> * binding assignment is successful, the associated binding list entry (if</span>
<span class="cm"> * any) is removed, and the node is placed on the mapped list.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * For a Link Down, all nodes on the ADISC, PLOGI, unmapped or mapped</span>
<span class="cm"> * lists will receive a DEVICE_RECOVERY event. If the linkdown or devloss timers</span>
<span class="cm"> * expire, all effected nodes will receive a DEVICE_RM event.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * For a Link Up or RSCN, all nodes will move from the mapped / unmapped lists</span>
<span class="cm"> * to either the ADISC or PLOGI list.  After a Nameserver query or ALPA loopmap</span>
<span class="cm"> * check, additional nodes may be added or removed (via DEVICE_RM) to / from</span>
<span class="cm"> * the PLOGI or ADISC lists. Once the PLOGI and ADISC lists are populated,</span>
<span class="cm"> * we will first process the ADISC list.  32 entries are processed initially and</span>
<span class="cm"> * ADISC is initited for each one.  Completions / Events for each node are</span>
<span class="cm"> * funnelled thru the state machine.  As each node finishes ADISC processing, it</span>
<span class="cm"> * starts ADISC for any nodes waiting for ADISC processing. If no nodes are</span>
<span class="cm"> * waiting, and the ADISC list count is identically 0, then we are done. For</span>
<span class="cm"> * Link Up discovery, since all nodes on the PLOGI list are UNREG_LOGIN&#39;ed, we</span>
<span class="cm"> * can issue a CLEAR_LA and reenable Link Events. Next we will process the PLOGI</span>
<span class="cm"> * list.  32 entries are processed initially and PLOGI is initited for each one.</span>
<span class="cm"> * Completions / Events for each node are funnelled thru the state machine.  As</span>
<span class="cm"> * each node finishes PLOGI processing, it starts PLOGI for any nodes waiting</span>
<span class="cm"> * for PLOGI processing. If no nodes are waiting, and the PLOGI list count is</span>
<span class="cm"> * indentically 0, then we are done. We have now completed discovery / RSCN</span>
<span class="cm"> * handling. Upon completion, ALL nodes should be on either the mapped or</span>
<span class="cm"> * unmapped lists.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="p">(</span><span class="o">*</span><span class="n">lpfc_disc_action</span><span class="p">[</span><span class="n">NLP_STE_MAX_STATE</span> <span class="o">*</span> <span class="n">NLP_EVT_MAX_EVENT</span><span class="p">])</span>
     <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Action routine                  Event       Current State  */</span>
	<span class="n">lpfc_rcv_plogi_unused_node</span><span class="p">,</span>	<span class="cm">/* RCV_PLOGI   UNUSED_NODE    */</span>
	<span class="n">lpfc_rcv_els_unused_node</span><span class="p">,</span>	<span class="cm">/* RCV_PRLI        */</span>
	<span class="n">lpfc_rcv_logo_unused_node</span><span class="p">,</span>	<span class="cm">/* RCV_LOGO        */</span>
	<span class="n">lpfc_rcv_els_unused_node</span><span class="p">,</span>	<span class="cm">/* RCV_ADISC       */</span>
	<span class="n">lpfc_rcv_els_unused_node</span><span class="p">,</span>	<span class="cm">/* RCV_PDISC       */</span>
	<span class="n">lpfc_rcv_els_unused_node</span><span class="p">,</span>	<span class="cm">/* RCV_PRLO        */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PLOGI      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PRLI       */</span>
	<span class="n">lpfc_cmpl_logo_unused_node</span><span class="p">,</span>	<span class="cm">/* CMPL_LOGO       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_ADISC      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_REG_LOGIN  */</span>
	<span class="n">lpfc_device_rm_unused_node</span><span class="p">,</span>	<span class="cm">/* DEVICE_RM       */</span>
	<span class="n">lpfc_device_recov_unused_node</span><span class="p">,</span>	<span class="cm">/* DEVICE_RECOVERY */</span>

	<span class="n">lpfc_rcv_plogi_plogi_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PLOGI   PLOGI_ISSUE    */</span>
	<span class="n">lpfc_rcv_prli_plogi_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PRLI        */</span>
	<span class="n">lpfc_rcv_logo_plogi_issue</span><span class="p">,</span>	<span class="cm">/* RCV_LOGO        */</span>
	<span class="n">lpfc_rcv_els_plogi_issue</span><span class="p">,</span>	<span class="cm">/* RCV_ADISC       */</span>
	<span class="n">lpfc_rcv_els_plogi_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PDISC       */</span>
	<span class="n">lpfc_rcv_els_plogi_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PRLO        */</span>
	<span class="n">lpfc_cmpl_plogi_plogi_issue</span><span class="p">,</span>	<span class="cm">/* CMPL_PLOGI      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PRLI       */</span>
	<span class="n">lpfc_cmpl_logo_plogi_issue</span><span class="p">,</span>	<span class="cm">/* CMPL_LOGO       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_ADISC      */</span>
	<span class="n">lpfc_cmpl_reglogin_plogi_issue</span><span class="p">,</span><span class="cm">/* CMPL_REG_LOGIN  */</span>
	<span class="n">lpfc_device_rm_plogi_issue</span><span class="p">,</span>	<span class="cm">/* DEVICE_RM       */</span>
	<span class="n">lpfc_device_recov_plogi_issue</span><span class="p">,</span>	<span class="cm">/* DEVICE_RECOVERY */</span>

	<span class="n">lpfc_rcv_plogi_adisc_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PLOGI   ADISC_ISSUE    */</span>
	<span class="n">lpfc_rcv_prli_adisc_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PRLI        */</span>
	<span class="n">lpfc_rcv_logo_adisc_issue</span><span class="p">,</span>	<span class="cm">/* RCV_LOGO        */</span>
	<span class="n">lpfc_rcv_padisc_adisc_issue</span><span class="p">,</span>	<span class="cm">/* RCV_ADISC       */</span>
	<span class="n">lpfc_rcv_padisc_adisc_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PDISC       */</span>
	<span class="n">lpfc_rcv_prlo_adisc_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PRLO        */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PLOGI      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PRLI       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_LOGO       */</span>
	<span class="n">lpfc_cmpl_adisc_adisc_issue</span><span class="p">,</span>	<span class="cm">/* CMPL_ADISC      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_REG_LOGIN  */</span>
	<span class="n">lpfc_device_rm_adisc_issue</span><span class="p">,</span>	<span class="cm">/* DEVICE_RM       */</span>
	<span class="n">lpfc_device_recov_adisc_issue</span><span class="p">,</span>	<span class="cm">/* DEVICE_RECOVERY */</span>

	<span class="n">lpfc_rcv_plogi_reglogin_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PLOGI  REG_LOGIN_ISSUE */</span>
	<span class="n">lpfc_rcv_prli_reglogin_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PLOGI       */</span>
	<span class="n">lpfc_rcv_logo_reglogin_issue</span><span class="p">,</span>	<span class="cm">/* RCV_LOGO        */</span>
	<span class="n">lpfc_rcv_padisc_reglogin_issue</span><span class="p">,</span>	<span class="cm">/* RCV_ADISC       */</span>
	<span class="n">lpfc_rcv_padisc_reglogin_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PDISC       */</span>
	<span class="n">lpfc_rcv_prlo_reglogin_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PRLO        */</span>
	<span class="n">lpfc_cmpl_plogi_illegal</span><span class="p">,</span>	<span class="cm">/* CMPL_PLOGI      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PRLI       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_LOGO       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_ADISC      */</span>
	<span class="n">lpfc_cmpl_reglogin_reglogin_issue</span><span class="p">,</span><span class="cm">/* CMPL_REG_LOGIN  */</span>
	<span class="n">lpfc_device_rm_reglogin_issue</span><span class="p">,</span>	<span class="cm">/* DEVICE_RM       */</span>
	<span class="n">lpfc_device_recov_reglogin_issue</span><span class="p">,</span><span class="cm">/* DEVICE_RECOVERY */</span>

	<span class="n">lpfc_rcv_plogi_prli_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PLOGI   PRLI_ISSUE     */</span>
	<span class="n">lpfc_rcv_prli_prli_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PRLI        */</span>
	<span class="n">lpfc_rcv_logo_prli_issue</span><span class="p">,</span>	<span class="cm">/* RCV_LOGO        */</span>
	<span class="n">lpfc_rcv_padisc_prli_issue</span><span class="p">,</span>	<span class="cm">/* RCV_ADISC       */</span>
	<span class="n">lpfc_rcv_padisc_prli_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PDISC       */</span>
	<span class="n">lpfc_rcv_prlo_prli_issue</span><span class="p">,</span>	<span class="cm">/* RCV_PRLO        */</span>
	<span class="n">lpfc_cmpl_plogi_illegal</span><span class="p">,</span>	<span class="cm">/* CMPL_PLOGI      */</span>
	<span class="n">lpfc_cmpl_prli_prli_issue</span><span class="p">,</span>	<span class="cm">/* CMPL_PRLI       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_LOGO       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_ADISC      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_REG_LOGIN  */</span>
	<span class="n">lpfc_device_rm_prli_issue</span><span class="p">,</span>	<span class="cm">/* DEVICE_RM       */</span>
	<span class="n">lpfc_device_recov_prli_issue</span><span class="p">,</span>	<span class="cm">/* DEVICE_RECOVERY */</span>

	<span class="n">lpfc_rcv_plogi_unmap_node</span><span class="p">,</span>	<span class="cm">/* RCV_PLOGI   UNMAPPED_NODE  */</span>
	<span class="n">lpfc_rcv_prli_unmap_node</span><span class="p">,</span>	<span class="cm">/* RCV_PRLI        */</span>
	<span class="n">lpfc_rcv_logo_unmap_node</span><span class="p">,</span>	<span class="cm">/* RCV_LOGO        */</span>
	<span class="n">lpfc_rcv_padisc_unmap_node</span><span class="p">,</span>	<span class="cm">/* RCV_ADISC       */</span>
	<span class="n">lpfc_rcv_padisc_unmap_node</span><span class="p">,</span>	<span class="cm">/* RCV_PDISC       */</span>
	<span class="n">lpfc_rcv_prlo_unmap_node</span><span class="p">,</span>	<span class="cm">/* RCV_PRLO        */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PLOGI      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PRLI       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_LOGO       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_ADISC      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_REG_LOGIN  */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* DEVICE_RM       */</span>
	<span class="n">lpfc_device_recov_unmap_node</span><span class="p">,</span>	<span class="cm">/* DEVICE_RECOVERY */</span>

	<span class="n">lpfc_rcv_plogi_mapped_node</span><span class="p">,</span>	<span class="cm">/* RCV_PLOGI   MAPPED_NODE    */</span>
	<span class="n">lpfc_rcv_prli_mapped_node</span><span class="p">,</span>	<span class="cm">/* RCV_PRLI        */</span>
	<span class="n">lpfc_rcv_logo_mapped_node</span><span class="p">,</span>	<span class="cm">/* RCV_LOGO        */</span>
	<span class="n">lpfc_rcv_padisc_mapped_node</span><span class="p">,</span>	<span class="cm">/* RCV_ADISC       */</span>
	<span class="n">lpfc_rcv_padisc_mapped_node</span><span class="p">,</span>	<span class="cm">/* RCV_PDISC       */</span>
	<span class="n">lpfc_rcv_prlo_mapped_node</span><span class="p">,</span>	<span class="cm">/* RCV_PRLO        */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PLOGI      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_PRLI       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_LOGO       */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_ADISC      */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* CMPL_REG_LOGIN  */</span>
	<span class="n">lpfc_disc_illegal</span><span class="p">,</span>		<span class="cm">/* DEVICE_RM       */</span>
	<span class="n">lpfc_device_recov_mapped_node</span><span class="p">,</span>	<span class="cm">/* DEVICE_RECOVERY */</span>

	<span class="n">lpfc_rcv_plogi_npr_node</span><span class="p">,</span>        <span class="cm">/* RCV_PLOGI   NPR_NODE    */</span>
	<span class="n">lpfc_rcv_prli_npr_node</span><span class="p">,</span>         <span class="cm">/* RCV_PRLI        */</span>
	<span class="n">lpfc_rcv_logo_npr_node</span><span class="p">,</span>         <span class="cm">/* RCV_LOGO        */</span>
	<span class="n">lpfc_rcv_padisc_npr_node</span><span class="p">,</span>       <span class="cm">/* RCV_ADISC       */</span>
	<span class="n">lpfc_rcv_padisc_npr_node</span><span class="p">,</span>       <span class="cm">/* RCV_PDISC       */</span>
	<span class="n">lpfc_rcv_prlo_npr_node</span><span class="p">,</span>         <span class="cm">/* RCV_PRLO        */</span>
	<span class="n">lpfc_cmpl_plogi_npr_node</span><span class="p">,</span>	<span class="cm">/* CMPL_PLOGI      */</span>
	<span class="n">lpfc_cmpl_prli_npr_node</span><span class="p">,</span>	<span class="cm">/* CMPL_PRLI       */</span>
	<span class="n">lpfc_cmpl_logo_npr_node</span><span class="p">,</span>        <span class="cm">/* CMPL_LOGO       */</span>
	<span class="n">lpfc_cmpl_adisc_npr_node</span><span class="p">,</span>       <span class="cm">/* CMPL_ADISC      */</span>
	<span class="n">lpfc_cmpl_reglogin_npr_node</span><span class="p">,</span>    <span class="cm">/* CMPL_REG_LOGIN  */</span>
	<span class="n">lpfc_device_rm_npr_node</span><span class="p">,</span>        <span class="cm">/* DEVICE_RM       */</span>
	<span class="n">lpfc_device_recov_npr_node</span><span class="p">,</span>     <span class="cm">/* DEVICE_RECOVERY */</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">lpfc_disc_state_machine</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">cur_state</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">uint32_t</span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span>
			 <span class="kt">uint32_t</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">got_ndlp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_nlp_get</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span>
		<span class="n">got_ndlp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cur_state</span> <span class="o">=</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">;</span>

	<span class="cm">/* DSM in event &lt;evt&gt; on NPort &lt;nlp_DID&gt; in state &lt;cur_state&gt; */</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0211 DSM in event x%x on NPort x%x in &quot;</span>
			 <span class="s">&quot;state %d Data: x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">evt</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">cur_state</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">);</span>

	<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_DSM</span><span class="p">,</span>
		 <span class="s">&quot;DSM in:          evt:%d ste:%d did:x%x&quot;</span><span class="p">,</span>
		<span class="n">evt</span><span class="p">,</span> <span class="n">cur_state</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">);</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">lpfc_disc_action</span><span class="p">[(</span><span class="n">cur_state</span> <span class="o">*</span> <span class="n">NLP_EVT_MAX_EVENT</span><span class="p">)</span> <span class="o">+</span> <span class="n">evt</span><span class="p">];</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">evt</span><span class="p">);</span>

	<span class="cm">/* DSM out state &lt;rc&gt; on NPort &lt;nlp_DID&gt; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">got_ndlp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0212 DSM out state %d on NPort x%x Data: x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">rc</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">);</span>

		<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_DSM</span><span class="p">,</span>
			<span class="s">&quot;DSM out:         ste:%d did:x%x flg:x%x&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">);</span>
		<span class="cm">/* Decrement the ndlp reference count held for this function */</span>
		<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			<span class="s">&quot;0213 DSM out state %d on NPort free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

		<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_DSM</span><span class="p">,</span>
			<span class="s">&quot;DSM out:         ste:%d did:x%x flg:x%x&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
