<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › lpfc › lpfc_ct.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lpfc_ct.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex Linux Device Driver for         *</span>
<span class="cm"> * Fibre Channel Host Bus Adapters.                                *</span>
<span class="cm"> * Copyright (C) 2004-2010 Emulex.  All rights reserved.           *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *******************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Fibre Channel SCSI LAN Device Driver CT support: FC Generic Services FC-GS</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fs.h&gt;</span>

<span class="cp">#include &quot;lpfc_hw4.h&quot;</span>
<span class="cp">#include &quot;lpfc_hw.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli4.h&quot;</span>
<span class="cp">#include &quot;lpfc_nl.h&quot;</span>
<span class="cp">#include &quot;lpfc_disc.h&quot;</span>
<span class="cp">#include &quot;lpfc_scsi.h&quot;</span>
<span class="cp">#include &quot;lpfc.h&quot;</span>
<span class="cp">#include &quot;lpfc_logmsg.h&quot;</span>
<span class="cp">#include &quot;lpfc_crtn.h&quot;</span>
<span class="cp">#include &quot;lpfc_version.h&quot;</span>
<span class="cp">#include &quot;lpfc_vport.h&quot;</span>
<span class="cp">#include &quot;lpfc_debugfs.h&quot;</span>

<span class="cm">/* FDMI Port Speed definitions */</span>
<span class="cp">#define HBA_PORTSPEED_1GBIT		0x0001	</span><span class="cm">/* 1 GBit/sec */</span><span class="cp"></span>
<span class="cp">#define HBA_PORTSPEED_2GBIT		0x0002	</span><span class="cm">/* 2 GBit/sec */</span><span class="cp"></span>
<span class="cp">#define HBA_PORTSPEED_4GBIT		0x0008	</span><span class="cm">/* 4 GBit/sec */</span><span class="cp"></span>
<span class="cp">#define HBA_PORTSPEED_10GBIT		0x0004	</span><span class="cm">/* 10 GBit/sec */</span><span class="cp"></span>
<span class="cp">#define HBA_PORTSPEED_8GBIT		0x0010	</span><span class="cm">/* 8 GBit/sec */</span><span class="cp"></span>
<span class="cp">#define HBA_PORTSPEED_16GBIT		0x0020	</span><span class="cm">/* 16 GBit/sec */</span><span class="cp"></span>
<span class="cp">#define HBA_PORTSPEED_UNKNOWN		0x0800	</span><span class="cm">/* Unknown */</span><span class="cp"></span>

<span class="cp">#define FOURBYTES	4</span>


<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lpfc_release_version</span> <span class="o">=</span> <span class="n">LPFC_DRIVER_VERSION</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_ct_ignore_hbq_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">piocbq</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
				<span class="s">&quot;0146 Ignoring unsolicited CT No HBQ &quot;</span>
				<span class="s">&quot;status = x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpStatus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
			<span class="s">&quot;0145 Ignoring unsolicted CT HBQ Size:%d &quot;</span>
			<span class="s">&quot;status = x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">size</span><span class="p">,</span> <span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpStatus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_ct_unsol_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">piocbq</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lpfc_ct_ignore_hbq_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">piocbq</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">lpfc_ct_unsol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">piocbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">icmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">iocbq</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bdeBuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_bsg_ct_unsol_event</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">piocbq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_NEED_BUFFER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_sli_hbqbuf_add_hbqs</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_ELS_HBQ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_LOCAL_REJECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">IOERR_RCV_BUFFER_WAITING</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Not enough posted buffers; Try posting more buffers */</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_stat</span><span class="p">.</span><span class="n">NoRcvBuf</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">))</span>
			<span class="n">lpfc_post_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If there are no BDEs associated with this IOCB,</span>
<span class="cm">	 * there is nothing to do.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iocbq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">bdeBuf</span> <span class="o">=</span> <span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
			<span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">size</span>  <span class="o">=</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
			<span class="n">lpfc_ct_unsol_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">piocbq</span><span class="p">,</span> <span class="n">bdeBuf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">lpfc_in_buf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bdeBuf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bdeBuf</span> <span class="o">=</span> <span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">context3</span><span class="p">;</span>
				<span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">context3</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">size</span>  <span class="o">=</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">unsli3</span><span class="p">.</span><span class="n">rcvsli3</span><span class="p">.</span><span class="n">bde2</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
				<span class="n">lpfc_ct_unsol_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">piocbq</span><span class="p">,</span> <span class="n">bdeBuf</span><span class="p">,</span>
						     <span class="n">size</span><span class="p">);</span>
				<span class="n">lpfc_in_buf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bdeBuf</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iocbq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">icmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">lpfc_ct_unsol_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">iocbq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">paddr</span> <span class="o">=</span> <span class="n">getPaddr</span><span class="p">(</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrHigh</span><span class="p">,</span>
						 <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrLow</span><span class="p">);</span>
				<span class="n">mp</span> <span class="o">=</span> <span class="n">lpfc_sli_ringpostbuf_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span>
							      <span class="n">paddr</span><span class="p">);</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
				<span class="n">lpfc_ct_unsol_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">iocbq</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
				<span class="n">lpfc_in_buf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">lpfc_post_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_ct_abort_unsol_event - Default handle for sli4 unsol abort</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @pring: Pointer to the driver internal I/O ring.</span>
<span class="cm"> * @piocbq: Pointer to the IOCBQ.</span>
<span class="cm"> *</span>
<span class="cm"> * This function serves as the default handler for the sli4 unsolicited</span>
<span class="cm"> * abort event. It shall be invoked when there is no application interface</span>
<span class="cm"> * registered unsolicited abort handler. This handler does nothing but</span>
<span class="cm"> * just simply releases the dma buffer used by the unsol abort event.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_sli4_ct_abort_unsol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">piocbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">icmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bdeBuf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Forward abort event to any process registered to receive ct event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_bsg_ct_unsol_event</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">piocbq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* If there is no BDE associated with IOCB, there is nothing to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">bdeBuf</span> <span class="o">=</span> <span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">size</span>  <span class="o">=</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
	<span class="n">lpfc_ct_unsol_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">piocbq</span><span class="p">,</span> <span class="n">bdeBuf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">lpfc_in_buf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bdeBuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_free_ct_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mlast</span><span class="p">,</span> <span class="o">*</span><span class="n">next_mlast</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mlast</span><span class="p">,</span> <span class="n">next_mlast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlist</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mlast</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mlast</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlast</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mlast</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mlist</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mlist</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mlist</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span>
<span class="nf">lpfc_alloc_ct_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmdcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span><span class="p">,</span>
		  <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We get chunks of FCELSSIZE */</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">FCELSSIZE</span> <span class="o">?</span> <span class="n">FCELSSIZE</span><span class="o">:</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate buffer for rsp payload */</span>
		<span class="n">mp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mlist</span><span class="p">)</span>
				<span class="n">lpfc_free_ct_rsp</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mlist</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">==</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_GID_FT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">cmdcode</span> <span class="o">==</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_GFF_ID</span><span class="p">))</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">MEM_PRI</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mlist</span><span class="p">)</span>
				<span class="n">lpfc_free_ct_rsp</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mlist</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Queue it to a linked list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlist</span><span class="p">)</span>
			<span class="n">mlist</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlist</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64I</span><span class="p">;</span>
		<span class="cm">/* build buffer ptr list for IOCB */</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">)</span> <span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">)</span> <span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">entries</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mlist</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">lpfc_ct_free_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">ctiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">buf_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">ndlp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">ndlp</span><span class="p">);</span>
		<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
		<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">buf_ptr</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">buf_ptr</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf_ptr</span><span class="p">);</span>
		<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_free_ct_rsp</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">);</span>
		<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context3</span><span class="p">;</span>
		<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">buf_ptr</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">buf_ptr</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf_ptr</span><span class="p">);</span>
		<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ctiocb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_gen_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">inp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span><span class="p">,</span>
	     <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cmpl</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">),</span>
	     <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">usr_flg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">num_entry</span><span class="p">,</span>
	     <span class="kt">uint32_t</span> <span class="n">tmo</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>  <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">icmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">geniocb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Allocate buffer for  command iocb */</span>
	<span class="n">geniocb</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">geniocb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">icmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">ulpIoTag32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BLP_64</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_entry</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usr_flg</span><span class="p">)</span>
		<span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">context3</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">context3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">bmp</span><span class="p">;</span>

	<span class="cm">/* Save for completion so we can release these resources */</span>
	<span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">inp</span><span class="p">;</span>
	<span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">outp</span><span class="p">;</span>
	<span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_nlp_get</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>

	<span class="cm">/* Fill in payload, bp points to frame payload */</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpCommand</span> <span class="o">=</span> <span class="n">CMD_GEN_REQUEST64_CR</span><span class="p">;</span>

	<span class="cm">/* Fill in rest of iocb */</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Fctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">SI</span> <span class="o">|</span> <span class="n">LA</span><span class="p">);</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Dfctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Rctl</span> <span class="o">=</span> <span class="n">FC_RCTL_DD_UNSOL_CTL</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">FC_TYPE_CT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmo</span><span class="p">)</span> <span class="p">{</span>
		 <span class="cm">/* FC spec states we need 3 * ratov for CT requests */</span>
		<span class="n">tmo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpTimeout</span> <span class="o">=</span> <span class="n">tmo</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpLe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpClass</span> <span class="o">=</span> <span class="n">CLASS3</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">rpi_ids</span><span class="p">[</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI3_NPIV_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For GEN_REQUEST64_CR, use the RPI */</span>
		<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpCt_h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpCt_l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Issue GEN REQ IOCB for NPORT &lt;did&gt; */</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
			 <span class="s">&quot;0119 Issue GEN REQ IOCB to NPORT x%x &quot;</span>
			 <span class="s">&quot;Data: x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpIoTag</span><span class="p">,</span>
			 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="p">);</span>
	<span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">iocb_cmpl</span> <span class="o">=</span> <span class="n">cmpl</span><span class="p">;</span>
	<span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">drvrTimeout</span> <span class="o">=</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpTimeout</span> <span class="o">+</span> <span class="n">LPFC_DRVR_TIMEOUT</span><span class="p">;</span>
	<span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
	<span class="n">geniocb</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_ELS_RING</span><span class="p">,</span> <span class="n">geniocb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IOCB_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">geniocb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_ct_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">inmp</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span>
	    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cmpl</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">),</span>
	    <span class="kt">uint32_t</span> <span class="n">rsp_size</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>  <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmdcode</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">inmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span><span class="o">-&gt;</span>
		<span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">;</span>

	<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>			<span class="cm">/* Skip past ct request */</span>

	<span class="cm">/* Put buffer(s) for ct rsp in bpl */</span>
	<span class="n">outmp</span> <span class="o">=</span> <span class="n">lpfc_alloc_ct_rsp</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdcode</span><span class="p">,</span> <span class="n">bpl</span><span class="p">,</span> <span class="n">rsp_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">outmp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Form the CT IOCB.  The total number of BDEs in this IOCB</span>
<span class="cm">	 * is the single command plus response count from</span>
<span class="cm">	 * lpfc_alloc_ct_rsp.</span>
<span class="cm">	 */</span>
	<span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">lpfc_gen_req</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">bmp</span><span class="p">,</span> <span class="n">inmp</span><span class="p">,</span> <span class="n">outmp</span><span class="p">,</span> <span class="n">cmpl</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="n">cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_free_ct_rsp</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">outmp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span>
<span class="nf">lpfc_find_vport_by_did</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">did</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport_curr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vport_curr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">listentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vport_curr</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vport_curr</span><span class="o">-&gt;</span><span class="n">fc_myDID</span> <span class="o">==</span> <span class="n">did</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">vport_curr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_ns_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">Size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>  <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">Response</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mlast</span><span class="p">,</span> <span class="o">*</span><span class="n">next_mp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">ctptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Response</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">gid</span><span class="p">.</span><span class="n">PortType</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">Did</span><span class="p">,</span> <span class="n">CTentry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>

	<span class="n">lpfc_set_disctmo</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_ns_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">next_mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlast</span> <span class="o">=</span> <span class="n">mp</span><span class="p">;</span>

		<span class="n">Cnt</span> <span class="o">=</span> <span class="n">Size</span>  <span class="o">&gt;</span> <span class="n">FCELSSIZE</span> <span class="o">?</span> <span class="n">FCELSSIZE</span> <span class="o">:</span> <span class="n">Size</span><span class="p">;</span>

		<span class="n">Size</span> <span class="o">-=</span> <span class="n">Cnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mlast</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">Cnt</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* subtract length of CT header */</span>

		<span class="cm">/* Loop through entire NameServer list of DIDs */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">Cnt</span> <span class="o">&gt;=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Get next DID from NameServer List */</span>
			<span class="n">CTentry</span> <span class="o">=</span> <span class="o">*</span><span class="n">ctptr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">Did</span> <span class="o">=</span> <span class="p">((</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">CTentry</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">Mask_DID</span><span class="p">);</span>

			<span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Check for rscn processing or not</span>
<span class="cm">			 * To conserve rpi&#39;s, filter out addresses for other</span>
<span class="cm">			 * vports on the same physical HBAs.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Did</span> <span class="o">!=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">lpfc_find_vport_by_did</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">Did</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
			     <span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_peer_port_login</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">!=</span> <span class="n">LPFC_NPIV_PORT</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">&amp;</span> <span class="n">FC_CT_RFF_ID</span><span class="p">))</span> <span class="o">||</span>
				    <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_restrict_login</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_setup_disc_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">Did</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span> <span class="o">&amp;&amp;</span> <span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
						<span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
						<span class="s">&quot;Parse GID_FTrsp: &quot;</span>
						<span class="s">&quot;did:x%x flg:x%x x%x&quot;</span><span class="p">,</span>
						<span class="n">Did</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">,</span>
						<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">);</span>

						<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
							<span class="n">KERN_INFO</span><span class="p">,</span>
							<span class="n">LOG_DISCOVERY</span><span class="p">,</span>
							<span class="s">&quot;0238 Process &quot;</span>
							<span class="s">&quot;x%x NameServer Rsp&quot;</span>
							<span class="s">&quot;Data: x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">Did</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">,</span>
							<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
							<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
						<span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
						<span class="s">&quot;Skip1 GID_FTrsp: &quot;</span>
						<span class="s">&quot;did:x%x flg:x%x cnt:%d&quot;</span><span class="p">,</span>
						<span class="n">Did</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
						<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>

						<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
							<span class="n">KERN_INFO</span><span class="p">,</span>
							<span class="n">LOG_DISCOVERY</span><span class="p">,</span>
							<span class="s">&quot;0239 Skip x%x &quot;</span>
							<span class="s">&quot;NameServer Rsp Data: &quot;</span>
							<span class="s">&quot;x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">Did</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
							<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>
					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_MODE</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">lpfc_rscn_payload_check</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">Did</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
						<span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
						<span class="s">&quot;Query GID_FTrsp: &quot;</span>
						<span class="s">&quot;did:x%x flg:x%x cnt:%d&quot;</span><span class="p">,</span>
						<span class="n">Did</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
						<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>

						<span class="cm">/* This NPortID was previously</span>
<span class="cm">						 * a FCP target, * Don&#39;t even</span>
<span class="cm">						 * bother to send GFF_ID.</span>
<span class="cm">						 */</span>
						<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
							<span class="n">Did</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span> <span class="o">&amp;&amp;</span>
						    <span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span>
						     <span class="n">NLP_FCP_TARGET</span><span class="p">))</span>
							<span class="n">lpfc_setup_disc_node</span>
								<span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">Did</span><span class="p">);</span>
						<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lpfc_ns_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
							<span class="n">SLI_CTNS_GFF_ID</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="n">Did</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
							<span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span><span class="o">++</span><span class="p">;</span>
						<span class="k">else</span>
							<span class="n">lpfc_setup_disc_node</span>
								<span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">Did</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
						<span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
						<span class="s">&quot;Skip2 GID_FTrsp: &quot;</span>
						<span class="s">&quot;did:x%x flg:x%x cnt:%d&quot;</span><span class="p">,</span>
						<span class="n">Did</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
						<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>

						<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
							<span class="n">KERN_INFO</span><span class="p">,</span>
							<span class="n">LOG_DISCOVERY</span><span class="p">,</span>
							<span class="s">&quot;0245 Skip x%x &quot;</span>
							<span class="s">&quot;NameServer Rsp Data: &quot;</span>
							<span class="s">&quot;x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">Did</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
							<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CTentry</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_LAST_ENTRY</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">nsout1</span><span class="p">;</span>
			<span class="n">Cnt</span> <span class="o">-=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ctptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">}</span>

<span class="nl">nsout1:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct_cmd_gid_ft</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTrsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* First save ndlp, before we overwrite it */</span>
	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">ndlp</span><span class="p">;</span>

	<span class="cm">/* we pass cmdiocb to state machine which needs rspiocb as well */</span>
	<span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">rsp_iocb</span> <span class="o">=</span> <span class="n">rspiocb</span><span class="p">;</span>

	<span class="n">outp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="n">bmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context3</span><span class="p">;</span>
	<span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>

	<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
		 <span class="s">&quot;GID_FT cmpl:     status:x%x/x%x rtry:%d&quot;</span><span class="p">,</span>
		<span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_ns_retry</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t bother processing response if vport is being torn down. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">&amp;</span> <span class="n">FC_UNLOADING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_MODE</span><span class="p">)</span>
			<span class="n">lpfc_els_flush_rscn</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_els_chk_latt</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				 <span class="s">&quot;0216 Link event during NS query</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_MODE</span><span class="p">)</span>
			<span class="n">lpfc_els_flush_rscn</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_error_lost_link</span><span class="p">(</span><span class="n">irsp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				 <span class="s">&quot;0226 NS query failed due to link event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_MODE</span><span class="p">)</span>
			<span class="n">lpfc_els_flush_rscn</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check for retry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_ns_retry</span> <span class="o">&lt;</span> <span class="n">LPFC_MAX_NS_RETRY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">!=</span> <span class="n">IOSTAT_LOCAL_REJECT</span> <span class="o">||</span>
			    <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">IOERR_NO_RESOURCES</span><span class="p">)</span>
				<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_ns_retry</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* CT command is being retried */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_ns_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">SLI_CTNS_GID_FT</span><span class="p">,</span>
					 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_ns_retry</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_MODE</span><span class="p">)</span>
			<span class="n">lpfc_els_flush_rscn</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
				 <span class="s">&quot;0257 GID_FT Query error: 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_ns_retry</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Good status, continue checking */</span>
		<span class="n">CTrsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">outp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">==</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_RESPONSE_FS_ACC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
					 <span class="s">&quot;0208 NameServer Rsp Data: x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">);</span>
			<span class="n">lpfc_ns_rsp</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">outp</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">==</span>
			   <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_RESPONSE_FS_RJT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* NameServer Rsp Error */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span> <span class="n">SLI_CT_UNABLE_TO_PERFORM_REQ</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">Explanation</span> <span class="o">==</span> <span class="n">SLI_CT_NO_FC4_TYPES</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
					<span class="n">LOG_DISCOVERY</span><span class="p">,</span>
					<span class="s">&quot;0269 No NameServer Entries &quot;</span>
					<span class="s">&quot;Data: x%x x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">Explanation</span><span class="p">,</span>
					<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">);</span>

				<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
				<span class="s">&quot;GID_FT no entry  cmd:x%x rsn:x%x exp:x%x&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">Explanation</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
					<span class="n">LOG_DISCOVERY</span><span class="p">,</span>
					<span class="s">&quot;0240 NameServer Rsp Error &quot;</span>
					<span class="s">&quot;Data: x%x x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">Explanation</span><span class="p">,</span>
					<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">);</span>

				<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
				<span class="s">&quot;GID_FT rsp err1  cmd:x%x rsn:x%x exp:x%x&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">Explanation</span><span class="p">);</span>
			<span class="p">}</span>


		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* NameServer Rsp Error */</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
					<span class="s">&quot;0241 NameServer Rsp Error &quot;</span>
					<span class="s">&quot;Data: x%x x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">Explanation</span><span class="p">,</span>
					<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">);</span>

			<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
				<span class="s">&quot;GID_FT rsp err2  cmd:x%x rsn:x%x exp:x%x&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">Explanation</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Link up / RSCN discovery */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The driver has cycled through all Nports in the RSCN payload.</span>
<span class="cm">		 * Complete the handling by cleaning up and marking the</span>
<span class="cm">		 * current driver state.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&gt;=</span> <span class="n">LPFC_DISC_AUTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_MODE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lpfc_els_flush_rscn</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
				<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">|=</span> <span class="n">FC_RSCN_MODE</span><span class="p">;</span> <span class="cm">/* RSCN still */</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">lpfc_els_flush_rscn</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lpfc_disc_start</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">ndlp</span> <span class="o">=</span> <span class="n">ndlp</span><span class="p">;</span> <span class="cm">/* Now restore ndlp for free */</span>
	<span class="n">lpfc_ct_free_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct_cmd_gff_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">inp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTrsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">did</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">retry</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">fbits</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>

	<span class="n">did</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">inp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">gff</span><span class="p">.</span><span class="n">PortId</span><span class="p">;</span>
	<span class="n">did</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">did</span><span class="p">);</span>

	<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
		<span class="s">&quot;GFF_ID cmpl:     status:x%x/x%x did:x%x&quot;</span><span class="p">,</span>
		<span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">did</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Good status, continue checking */</span>
		<span class="n">CTrsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">outp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="n">fbits</span> <span class="o">=</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">gff_acc</span><span class="p">.</span><span class="n">fbits</span><span class="p">[</span><span class="n">FCP_TYPE_FEATURE_OFFSET</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">==</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_RESPONSE_FS_ACC</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fbits</span> <span class="o">&amp;</span> <span class="n">FC4_FEATURE_INIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">fbits</span> <span class="o">&amp;</span> <span class="n">FC4_FEATURE_TARGET</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span>
						 <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
						 <span class="s">&quot;0270 Skip x%x GFF &quot;</span>
						 <span class="s">&quot;NameServer Rsp Data: (init) &quot;</span>
						 <span class="s">&quot;x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">fbits</span><span class="p">,</span>
						 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Check for retry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="n">LPFC_MAX_NS_RETRY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_LOCAL_REJECT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">IOERR_NO_RESOURCES</span>:
					<span class="cm">/* We don&#39;t increment the retry</span>
<span class="cm">					 * count for this case.</span>
<span class="cm">					 */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">IOERR_LINK_DOWN</span>:
				<span class="k">case</span> <span class="n">IOERR_SLI_ABORTED</span>:
				<span class="k">case</span> <span class="n">IOERR_SLI_DOWN</span>:
					<span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">retry</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">retry</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* CT command is being retried */</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_ns_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">SLI_CTNS_GFF_ID</span><span class="p">,</span>
					 <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">,</span> <span class="n">did</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* success */</span>
					<span class="n">lpfc_ct_free_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				 <span class="s">&quot;0267 NameServer GFF Rsp &quot;</span>
				 <span class="s">&quot;x%x Error (%d %d) Data: x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">did</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* This is a target port, unregistered port, or the GFF_ID failed */</span>
	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_setup_disc_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">did</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span> <span class="o">&amp;&amp;</span> <span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				 <span class="s">&quot;0242 Process x%x GFF &quot;</span>
				 <span class="s">&quot;NameServer Rsp Data: x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">did</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
				 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				 <span class="s">&quot;0243 Skip x%x GFF &quot;</span>
				 <span class="s">&quot;NameServer Rsp Data: x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span>
				 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="cm">/* Link up / RSCN discovery */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span><span class="p">)</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The driver has cycled through all Nports in the RSCN payload.</span>
<span class="cm">		 * Complete the handling by cleaning up and marking the</span>
<span class="cm">		 * current driver state.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&gt;=</span> <span class="n">LPFC_DISC_AUTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_RSCN_MODE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lpfc_els_flush_rscn</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
				<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">|=</span> <span class="n">FC_RSCN_MODE</span><span class="p">;</span> <span class="cm">/* RSCN still */</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">lpfc_els_flush_rscn</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">lpfc_disc_start</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lpfc_ct_free_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">inp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTrsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmdcode</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">retry</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">latt</span><span class="p">;</span>

	<span class="cm">/* First save ndlp, before we overwrite it */</span>
	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">ndlp</span><span class="p">;</span>

	<span class="cm">/* we pass cmdiocb to state machine which needs rspiocb as well */</span>
	<span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">rsp_iocb</span> <span class="o">=</span> <span class="n">rspiocb</span><span class="p">;</span>

	<span class="n">inp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="n">outp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>

	<span class="n">cmdcode</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(((</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">inp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span><span class="o">-&gt;</span>
					<span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">);</span>
	<span class="n">CTrsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">outp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="n">latt</span> <span class="o">=</span> <span class="n">lpfc_els_chk_latt</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="cm">/* RFT request completes status &lt;ulpStatus&gt; CmdRsp &lt;CmdRsp&gt; */</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0209 CT Request completes, latt %d, &quot;</span>
			 <span class="s">&quot;ulpStatus x%x CmdRsp x%x, Context x%x, Tag x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">latt</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">,</span>
			 <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">,</span>
			 <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpContext</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpIoTag</span><span class="p">);</span>

	<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
		<span class="s">&quot;CT cmd cmpl:     status:x%x/x%x cmd:x%x&quot;</span><span class="p">,</span>
		<span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">cmdcode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				 <span class="s">&quot;0268 NS cmd %x Error (%d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cmdcode</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_LOCAL_REJECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">IOERR_SLI_DOWN</span><span class="p">)</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">IOERR_SLI_ABORTED</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">retry</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&gt;=</span> <span class="n">LPFC_MAX_NS_RETRY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">retry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				 <span class="s">&quot;0250 Retrying NS cmd %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmdcode</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_ns_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cmdcode</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">ndlp</span> <span class="o">=</span> <span class="n">ndlp</span><span class="p">;</span> <span class="cm">/* Now restore ndlp for free */</span>
	<span class="n">lpfc_ct_free_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct_cmd_rft_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTrsp</span><span class="p">;</span>

		<span class="n">outp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
		<span class="n">CTrsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">outp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">==</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_RESPONSE_FS_ACC</span><span class="p">))</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">|=</span> <span class="n">FC_CT_RFT_ID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_cmpl_ct</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">rspiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct_cmd_rnn_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTrsp</span><span class="p">;</span>

		<span class="n">outp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
		<span class="n">CTrsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">outp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">==</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_RESPONSE_FS_ACC</span><span class="p">))</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">|=</span> <span class="n">FC_CT_RNN_ID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_cmpl_ct</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">rspiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct_cmd_rspn_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTrsp</span><span class="p">;</span>

		<span class="n">outp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
		<span class="n">CTrsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">outp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">==</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_RESPONSE_FS_ACC</span><span class="p">))</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">|=</span> <span class="n">FC_CT_RSPN_ID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_cmpl_ct</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">rspiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct_cmd_rsnn_nn</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTrsp</span><span class="p">;</span>

		<span class="n">outp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
		<span class="n">CTrsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">outp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">==</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_RESPONSE_FS_ACC</span><span class="p">))</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">|=</span> <span class="n">FC_CT_RSNN_NN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_cmpl_ct</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">rspiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct_cmd_da_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
 <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>

	<span class="cm">/* even if it fails we will act as though it succeeded. */</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lpfc_cmpl_ct</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">rspiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct_cmd_rff_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTrsp</span><span class="p">;</span>

		<span class="n">outp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
		<span class="n">CTrsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">outp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">==</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_RESPONSE_FS_ACC</span><span class="p">))</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">|=</span> <span class="n">FC_CT_RFF_ID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_cmpl_ct</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">,</span> <span class="n">rspiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">lpfc_vport_symbolic_port_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbol</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">wwn</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		     <span class="s">&quot;Emulex PPN-%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x&quot;</span><span class="p">,</span>
		     <span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wwn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wwn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wwn</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		     <span class="n">wwn</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">wwn</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">wwn</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">wwn</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">LPFC_PHYSICAL_PORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">symbol</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot; VPort-%d&quot;</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strlen</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">symbolic_name</span><span class="p">))</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">symbol</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot; VName-%s&quot;</span><span class="p">,</span>
			      <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">symbolic_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">lpfc_vport_symbolic_node_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbol</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">fwrev</span><span class="p">[</span><span class="n">FW_REV_STR_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">lpfc_decode_firmware_rev</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">,</span> <span class="n">fwrev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;Emulex %s FV%s DV%s&quot;</span><span class="p">,</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="n">fwrev</span><span class="p">,</span> <span class="n">lpfc_release_version</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lpfc_ns_cmd</span>
<span class="cm"> * Description:</span>
<span class="cm"> *    Issue Cmd to NameServer</span>
<span class="cm"> *       SLI_CTNS_GID_FT</span>
<span class="cm"> *       LI_CTNS_RFT_ID</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">lpfc_ns_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmdcode</span><span class="p">,</span>
	    <span class="kt">uint8_t</span> <span class="n">retry</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span> <span class="n">ndlp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">bmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CtReq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cmpl</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rsp_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="kt">size_t</span>   <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">NameServer_DID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span> <span class="o">||</span> <span class="o">!</span><span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span> <span class="o">!=</span> <span class="n">NLP_STE_UNMAPPED_NODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ns_cmd_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill in BDEs for command */</span>
	<span class="cm">/* Allocate buffer for command payload */</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ns_cmd_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">MEM_PRI</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ns_cmd_free_mp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate buffer for Buffer ptr list */</span>
	<span class="n">bmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ns_cmd_free_mpvirt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">MEM_PRI</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ns_cmd_free_bmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NameServer Req */</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="p">,</span><span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0236 NameServer Req Data: x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">cmdcode</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>

	<span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span><span class="p">));</span>
	<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">==</span> <span class="n">SLI_CTNS_GID_FT</span><span class="p">)</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">GID_REQUEST_SZ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">==</span> <span class="n">SLI_CTNS_GFF_ID</span><span class="p">)</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">GFF_REQUEST_SZ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">==</span> <span class="n">SLI_CTNS_RFT_ID</span><span class="p">)</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">RFT_REQUEST_SZ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">==</span> <span class="n">SLI_CTNS_RNN_ID</span><span class="p">)</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">RNN_REQUEST_SZ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">==</span> <span class="n">SLI_CTNS_RSPN_ID</span><span class="p">)</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">RSPN_REQUEST_SZ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">==</span> <span class="n">SLI_CTNS_RSNN_NN</span><span class="p">)</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">RSNN_REQUEST_SZ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">==</span> <span class="n">SLI_CTNS_DA_ID</span><span class="p">)</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">DA_ID_REQUEST_SZ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">==</span> <span class="n">SLI_CTNS_RFF_ID</span><span class="p">)</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">RFF_REQUEST_SZ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>

	<span class="n">CtReq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">CtReq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span><span class="p">));</span>
	<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">RevisionId</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Revision</span> <span class="o">=</span> <span class="n">SLI_CT_REVISION</span><span class="p">;</span>
	<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">RevisionId</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">InId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">FsType</span> <span class="o">=</span> <span class="n">SLI_CT_DIRECTORY_SERVICE</span><span class="p">;</span>
	<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">FsSubType</span> <span class="o">=</span> <span class="n">SLI_CT_DIRECTORY_NAME_SERVER</span><span class="p">;</span>
	<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmdcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLI_CTNS_GID_FT</span>:
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_GID_FT</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">gid</span><span class="p">.</span><span class="n">Fc4Type</span> <span class="o">=</span> <span class="n">SLI_CTPT_FCP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&lt;</span> <span class="n">LPFC_NS_QRY</span><span class="p">)</span>
			<span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="n">LPFC_NS_QRY</span><span class="p">;</span>
		<span class="n">lpfc_set_disctmo</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="n">cmpl</span> <span class="o">=</span> <span class="n">lpfc_cmpl_ct_cmd_gid_ft</span><span class="p">;</span>
		<span class="n">rsp_size</span> <span class="o">=</span> <span class="n">FC_MAX_NS_RSP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_CTNS_GFF_ID</span>:
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
			<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_GFF_ID</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">gff</span><span class="p">.</span><span class="n">PortId</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="n">cmpl</span> <span class="o">=</span> <span class="n">lpfc_cmpl_ct_cmd_gff_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_CTNS_RFT_ID</span>:
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_CT_RFT_ID</span><span class="p">;</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_RFT_ID</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rft</span><span class="p">.</span><span class="n">PortId</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rft</span><span class="p">.</span><span class="n">fcpReg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmpl</span> <span class="o">=</span> <span class="n">lpfc_cmpl_ct_cmd_rft_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_CTNS_RNN_ID</span>:
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_CT_RNN_ID</span><span class="p">;</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_RNN_ID</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rnn</span><span class="p">.</span><span class="n">PortId</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rnn</span><span class="p">.</span><span class="n">wwnn</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodename</span><span class="p">,</span>
		       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
		<span class="n">cmpl</span> <span class="o">=</span> <span class="n">lpfc_cmpl_ct_cmd_rnn_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_CTNS_RSPN_ID</span>:
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_CT_RSPN_ID</span><span class="p">;</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_RSPN_ID</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rspn</span><span class="p">.</span><span class="n">PortId</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rspn</span><span class="p">.</span><span class="n">symbname</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rspn</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
			<span class="n">lpfc_vport_symbolic_port_name</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
			<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rspn</span><span class="p">.</span><span class="n">symbname</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">cmpl</span> <span class="o">=</span> <span class="n">lpfc_cmpl_ct_cmd_rspn_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLI_CTNS_RSNN_NN</span>:
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_CT_RSNN_NN</span><span class="p">;</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_RSNN_NN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rsnn</span><span class="p">.</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodename</span><span class="p">,</span>
		       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rsnn</span><span class="p">.</span><span class="n">symbname</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rsnn</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
			<span class="n">lpfc_vport_symbolic_node_name</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span>
			<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rsnn</span><span class="p">.</span><span class="n">symbname</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">cmpl</span> <span class="o">=</span> <span class="n">lpfc_cmpl_ct_cmd_rsnn_nn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLI_CTNS_DA_ID</span>:
		<span class="cm">/* Implement DA_ID Nameserver request */</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
			<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_DA_ID</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">da_id</span><span class="p">.</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">);</span>
		<span class="n">cmpl</span> <span class="o">=</span> <span class="n">lpfc_cmpl_ct_cmd_da_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLI_CTNS_RFF_ID</span>:
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_CT_RFF_ID</span><span class="p">;</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
		    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CTNS_RFF_ID</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rff</span><span class="p">.</span><span class="n">PortId</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rff</span><span class="p">.</span><span class="n">fbits</span> <span class="o">=</span> <span class="n">FC4_FEATURE_INIT</span><span class="p">;</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">rff</span><span class="p">.</span><span class="n">type_code</span> <span class="o">=</span> <span class="n">FC_TYPE_FCP</span><span class="p">;</span>
		<span class="n">cmpl</span> <span class="o">=</span> <span class="n">lpfc_cmpl_ct_cmd_rff_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* The lpfc_ct_cmd/lpfc_get_req shall increment ndlp reference count</span>
<span class="cm">	 * to hold ndlp reference for the corresponding callback function.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_ct_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">bmp</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmpl</span><span class="p">,</span> <span class="n">rsp_size</span><span class="p">,</span> <span class="n">retry</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* On success, The cmpl function will free the buffers */</span>
		<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
			<span class="s">&quot;Issue CT cmd:    cmd:x%x did:x%x&quot;</span><span class="p">,</span>
			<span class="n">cmdcode</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span><span class="o">=</span><span class="mi">6</span><span class="p">;</span>

	<span class="cm">/* Decrement ndlp reference count to release ndlp reference held</span>
<span class="cm">	 * for the failed command&#39;s callback function.</span>
<span class="cm">	 */</span>
	<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
<span class="nl">ns_cmd_free_bmp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bmp</span><span class="p">);</span>
<span class="nl">ns_cmd_free_mpvirt:</span>
	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
<span class="nl">ns_cmd_free_mp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="nl">ns_cmd_exit:</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0266 Issue NameServer Req x%x err %d Data: x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">cmdcode</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_rscn_id_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_cmpl_ct_cmd_fdmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span> <span class="n">rspiocb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">inp</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">outp</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTrsp</span> <span class="o">=</span> <span class="n">outp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CTcmd</span> <span class="o">=</span> <span class="n">inp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">fdmi_cmd</span> <span class="o">=</span> <span class="n">CTcmd</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">fdmi_rsp</span> <span class="o">=</span> <span class="n">CTrsp</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">cmdiocb</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">irsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">latt</span><span class="p">;</span>

	<span class="n">latt</span> <span class="o">=</span> <span class="n">lpfc_els_chk_latt</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">LPFC_DISC_TRC_CT</span><span class="p">,</span>
		<span class="s">&quot;FDMI cmpl:       status:x%x/x%x latt:%d&quot;</span><span class="p">,</span>
		<span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">latt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">latt</span> <span class="o">||</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				 <span class="s">&quot;0229 FDMI cmd %04x failed, latt = %d &quot;</span>
				 <span class="s">&quot;ulpStatus: x%x, rid x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fdmi_cmd</span><span class="p">),</span> <span class="n">latt</span><span class="p">,</span> <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">,</span>
				 <span class="n">irsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">lpfc_ct_free_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FDMI_DID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span> <span class="o">||</span> <span class="o">!</span><span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fdmi_rsp</span> <span class="o">==</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_CT_RESPONSE_FS_RJT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* FDMI rsp failed */</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
				 <span class="s">&quot;0220 FDMI rsp failed Data: x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fdmi_cmd</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fdmi_cmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLI_MGMT_RHBA</span>:
		<span class="n">lpfc_fdmi_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">SLI_MGMT_RPA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_MGMT_RPA</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_MGMT_DHBA</span>:
		<span class="n">lpfc_fdmi_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">SLI_MGMT_DPRT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_MGMT_DPRT</span>:
		<span class="n">lpfc_fdmi_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">SLI_MGMT_RHBA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">fail_out:</span>
	<span class="n">lpfc_ct_free_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">lpfc_fdmi_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmdcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="o">*</span><span class="n">bmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">CtReq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">REG_HBA</span> <span class="o">*</span><span class="n">rh</span><span class="p">;</span>
	<span class="n">PORT_ENTRY</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>
	<span class="n">REG_PORT_ATTRIBUTE</span> <span class="o">*</span><span class="n">pab</span><span class="p">;</span>
	<span class="n">ATTRIBUTE_BLOCK</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>
	<span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="n">ae</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cmpl</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">);</span>


	<span class="cm">/* fill in BDEs for command */</span>
	<span class="cm">/* Allocate buffer for command payload */</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fdmi_cmd_exit</span><span class="p">;</span>

	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fdmi_cmd_free_mp</span><span class="p">;</span>

	<span class="cm">/* Allocate buffer for Buffer ptr list */</span>
	<span class="n">bmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fdmi_cmd_free_mpvirt</span><span class="p">;</span>

	<span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fdmi_cmd_free_bmp</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/* FDMI request */</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0218 FDMI Request Data: x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="p">,</span> <span class="n">cmdcode</span><span class="p">);</span>
	<span class="n">CtReq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">CtReq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span><span class="p">));</span>
	<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">RevisionId</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Revision</span> <span class="o">=</span> <span class="n">SLI_CT_REVISION</span><span class="p">;</span>
	<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">RevisionId</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">InId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">FsType</span> <span class="o">=</span> <span class="n">SLI_CT_MANAGEMENT_SERVICE</span><span class="p">;</span>
	<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">FsSubType</span> <span class="o">=</span> <span class="n">SLI_CT_FDMI_Subtypes</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmdcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLI_MGMT_RHBA</span>:
		<span class="p">{</span>
			<span class="n">lpfc_vpd_t</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">incr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
			    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_MGMT_RHBA</span><span class="p">);</span>
			<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_HBA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortID</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">hi</span><span class="p">.</span><span class="n">PortName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span>
			       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
			<span class="cm">/* One entry (port) per adapter */</span>
			<span class="n">rh</span><span class="o">-&gt;</span><span class="n">rpl</span><span class="p">.</span><span class="n">EntryCnt</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">rpl</span><span class="p">.</span><span class="n">pe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span>
			       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>

			<span class="cm">/* point to the HBA attribute block */</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">)</span> <span class="o">+</span> <span class="n">FOURBYTES</span><span class="p">;</span>
			<span class="n">ab</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_BLOCK</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Point to the beginning of the first HBA attribute</span>
<span class="cm">			   entry */</span>
			<span class="cm">/* #1 HBA attribute entry */</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span><span class="p">;</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">NODE_NAME</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span>  <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span>
						<span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">NodeName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">nodeName</span><span class="p">,</span>
			       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">);</span>

			<span class="cm">/* #2 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">MANUFACTURER</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">Manufacturer</span><span class="p">,</span> <span class="s">&quot;Emulex Corporation&quot;</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">Manufacturer</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

			<span class="cm">/* #3 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SERIAL_NUMBER</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SerialNumber</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

			<span class="cm">/* #4 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">MODEL</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">Model</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

			<span class="cm">/* #5 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">MODEL_DESCRIPTION</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ModelDescription</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ModelDesc</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ModelDescription</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

			<span class="cm">/* #6 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">HARDWARE_VERSION</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
			<span class="cm">/* Convert JEDEC ID to ascii for hardware version */</span>
			<span class="n">incr</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">.</span><span class="n">biuRev</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">incr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">)</span>
					<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">HardwareVersion</span><span class="p">[</span><span class="mi">7</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span><span class="p">)((</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="mh">0x30</span> <span class="o">+</span>
						   <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">j</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">HardwareVersion</span><span class="p">[</span><span class="mi">7</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span><span class="p">)((</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="mh">0x61</span> <span class="o">+</span>
						   <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">10</span><span class="p">));</span>
				<span class="n">incr</span> <span class="o">=</span> <span class="p">(</span><span class="n">incr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

			<span class="cm">/* #7 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">DriverVersion</span><span class="p">,</span> <span class="n">lpfc_release_version</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">DriverVersion</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

			<span class="cm">/* #8 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">OPTION_ROM_VERSION</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">OptionROMVersion</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">OptionROMVersion</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">OptionROMVersion</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

			<span class="cm">/* #9 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FIRMWARE_VERSION</span><span class="p">);</span>
			<span class="n">lpfc_decode_firmware_rev</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">FirmwareVersion</span><span class="p">,</span>
				<span class="mi">1</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">FirmwareVersion</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

			<span class="cm">/* #10 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">OS_NAME_VERSION</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">OsNameVersion</span><span class="p">,</span> <span class="s">&quot;%s %s %s&quot;</span><span class="p">,</span>
				<span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sysname</span><span class="p">,</span>
				<span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">,</span>
				<span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">OsNameVersion</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

			<span class="cm">/* #11 HBA attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">rh</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">MAX_CT_PAYLOAD_LEN</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">MaxCTPayloadLen</span> <span class="o">=</span> <span class="p">(</span><span class="mi">65</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">);</span>
			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

			<span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">EntryCnt</span><span class="p">);</span>
			<span class="cm">/* Total size */</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">GID_REQUEST_SZ</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_MGMT_RPA</span>:
		<span class="p">{</span>
			<span class="n">lpfc_vpd_t</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="n">hsp</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">vp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">;</span>

			<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span>
			    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_MGMT_RPA</span><span class="p">);</span>
			<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pab</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_PORT_ATTRIBUTE</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortID</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">)</span> <span class="o">+</span> <span class="n">FOURBYTES</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pab</span><span class="o">-&gt;</span><span class="n">PortName</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span>
			       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
			<span class="n">pab</span><span class="o">-&gt;</span><span class="n">ab</span><span class="p">.</span><span class="n">EntryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* #1 Port attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pab</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SUPPORTED_FC4_TYPES</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SupportFC4Types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SupportFC4Types</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pab</span><span class="o">-&gt;</span><span class="n">ab</span><span class="p">.</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>

			<span class="cm">/* #2 Port attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pab</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SUPPORTED_SPEED</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SupportSpeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lmt</span> <span class="o">&amp;</span> <span class="n">LMT_16Gb</span><span class="p">)</span>
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SupportSpeed</span> <span class="o">|=</span> <span class="n">HBA_PORTSPEED_16GBIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lmt</span> <span class="o">&amp;</span> <span class="n">LMT_10Gb</span><span class="p">)</span>
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SupportSpeed</span> <span class="o">|=</span> <span class="n">HBA_PORTSPEED_10GBIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lmt</span> <span class="o">&amp;</span> <span class="n">LMT_8Gb</span><span class="p">)</span>
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SupportSpeed</span> <span class="o">|=</span> <span class="n">HBA_PORTSPEED_8GBIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lmt</span> <span class="o">&amp;</span> <span class="n">LMT_4Gb</span><span class="p">)</span>
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SupportSpeed</span> <span class="o">|=</span> <span class="n">HBA_PORTSPEED_4GBIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lmt</span> <span class="o">&amp;</span> <span class="n">LMT_2Gb</span><span class="p">)</span>
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SupportSpeed</span> <span class="o">|=</span> <span class="n">HBA_PORTSPEED_2GBIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lmt</span> <span class="o">&amp;</span> <span class="n">LMT_1Gb</span><span class="p">)</span>
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">SupportSpeed</span> <span class="o">|=</span> <span class="n">HBA_PORTSPEED_1GBIT</span><span class="p">;</span>

			<span class="n">pab</span><span class="o">-&gt;</span><span class="n">ab</span><span class="p">.</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

			<span class="cm">/* #3 Port attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pab</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">PORT_SPEED</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_linkspeed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">LPFC_LINK_SPEED_1GHZ</span>:
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortSpeed</span> <span class="o">=</span> <span class="n">HBA_PORTSPEED_1GBIT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPFC_LINK_SPEED_2GHZ</span>:
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortSpeed</span> <span class="o">=</span> <span class="n">HBA_PORTSPEED_2GBIT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPFC_LINK_SPEED_4GHZ</span>:
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortSpeed</span> <span class="o">=</span> <span class="n">HBA_PORTSPEED_4GBIT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPFC_LINK_SPEED_8GHZ</span>:
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortSpeed</span> <span class="o">=</span> <span class="n">HBA_PORTSPEED_8GBIT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPFC_LINK_SPEED_10GHZ</span>:
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortSpeed</span> <span class="o">=</span> <span class="n">HBA_PORTSPEED_10GBIT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPFC_LINK_SPEED_16GHZ</span>:
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortSpeed</span> <span class="o">=</span> <span class="n">HBA_PORTSPEED_16GBIT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortSpeed</span> <span class="o">=</span> <span class="n">HBA_PORTSPEED_UNKNOWN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pab</span><span class="o">-&gt;</span><span class="n">ab</span><span class="p">.</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

			<span class="cm">/* #4 Port attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pab</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">MAX_FRAME_SIZE</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">hsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_parm</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">MaxFrameSize</span> <span class="o">=</span>
			    <span class="p">(((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span>
			      <span class="n">bbRcvSizeMsb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">hsp</span><span class="o">-&gt;</span><span class="n">cmn</span><span class="p">.</span>
			    <span class="n">bbRcvSizeLsb</span><span class="p">;</span>
			<span class="n">pab</span><span class="o">-&gt;</span><span class="n">ab</span><span class="p">.</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

			<span class="cm">/* #5 Port attribute entry */</span>
			<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pab</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">OS_DEVICE_NAME</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">OsDeviceName</span><span class="p">,</span> <span class="n">LPFC_DRIVER_NAME</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">OsDeviceName</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">pab</span><span class="o">-&gt;</span><span class="n">ab</span><span class="p">.</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_fdmi_on</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* #6 Port attribute entry */</span>
				<span class="n">ae</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTRIBUTE_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pab</span> <span class="o">+</span>
							  <span class="n">size</span><span class="p">);</span>
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrType</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">HOST_NAME</span><span class="p">);</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">HostName</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
					<span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ae</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">HostName</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">ae</span><span class="o">-&gt;</span><span class="n">ad</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">AttrLen</span> <span class="o">=</span>
				    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">pab</span><span class="o">-&gt;</span><span class="n">ab</span><span class="p">.</span><span class="n">EntryCnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">size</span> <span class="o">+=</span> <span class="n">FOURBYTES</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pab</span><span class="o">-&gt;</span><span class="n">ab</span><span class="p">.</span><span class="n">EntryCnt</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">pab</span><span class="o">-&gt;</span><span class="n">ab</span><span class="p">.</span><span class="n">EntryCnt</span><span class="p">);</span>
			<span class="cm">/* Total size */</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">GID_REQUEST_SZ</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_MGMT_DHBA</span>:
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_MGMT_DHBA</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pe</span> <span class="o">=</span> <span class="p">(</span><span class="n">PORT_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortID</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">PortName</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span>
		       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">GID_REQUEST_SZ</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLI_MGMT_DPRT</span>:
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">SLI_MGMT_DPRT</span><span class="p">);</span>
		<span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pe</span> <span class="o">=</span> <span class="p">(</span><span class="n">PORT_ENTRY</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CtReq</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">PortID</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">PortName</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span>
		       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">GID_REQUEST_SZ</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>

	<span class="n">cmpl</span> <span class="o">=</span> <span class="n">lpfc_cmpl_ct_cmd_fdmi</span><span class="p">;</span>

	<span class="cm">/* The lpfc_ct_cmd/lpfc_get_req shall increment ndlp reference count</span>
<span class="cm">	 * to hold ndlp reference for the corresponding callback function.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_ct_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">bmp</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">cmpl</span><span class="p">,</span> <span class="n">FC_MAX_NS_RSP</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Decrement ndlp reference count to release ndlp reference held</span>
<span class="cm">	 * for the failed command&#39;s callback function.</span>
<span class="cm">	 */</span>
	<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
<span class="nl">fdmi_cmd_free_bmp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bmp</span><span class="p">);</span>
<span class="nl">fdmi_cmd_free_mpvirt:</span>
	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
<span class="nl">fdmi_cmd_free_mp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="nl">fdmi_cmd_exit:</span>
	<span class="cm">/* Issue FDMI request failed */</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_DISCOVERY</span><span class="p">,</span>
			 <span class="s">&quot;0244 Issue FDMI request failed Data: x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">cmdcode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_delayed_disc_tmo - Timeout handler for delayed discovery timer.</span>
<span class="cm"> * @ptr - Context object of the timer.</span>
<span class="cm"> *</span>
<span class="cm"> * This function set the WORKER_DELAYED_DISC_TMO flag and wake up</span>
<span class="cm"> * the worker thread.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_delayed_disc_tmo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">tmo_posted</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflag</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">work_port_lock</span><span class="p">,</span> <span class="n">iflag</span><span class="p">);</span>
	<span class="n">tmo_posted</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">work_port_events</span> <span class="o">&amp;</span> <span class="n">WORKER_DELAYED_DISC_TMO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmo_posted</span><span class="p">)</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">work_port_events</span> <span class="o">|=</span> <span class="n">WORKER_DELAYED_DISC_TMO</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">work_port_lock</span><span class="p">,</span> <span class="n">iflag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmo_posted</span><span class="p">)</span>
		<span class="n">lpfc_worker_wake_up</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_delayed_disc_timeout_handler - Function called by worker thread to</span>
<span class="cm"> *      handle delayed discovery.</span>
<span class="cm"> * @vport: pointer to a host virtual N_Port data structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This function start nport discovery of the vport.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_delayed_disc_timeout_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_DISC_DELAYED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_DISC_DELAYED</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">lpfc_do_scr_ns_plogi</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">lpfc_fdmi_tmo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">tmo_posted</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iflag</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">work_port_lock</span><span class="p">,</span> <span class="n">iflag</span><span class="p">);</span>
	<span class="n">tmo_posted</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">work_port_events</span> <span class="o">&amp;</span> <span class="n">WORKER_FDMI_TMO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmo_posted</span><span class="p">)</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">work_port_events</span> <span class="o">|=</span> <span class="n">WORKER_FDMI_TMO</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">work_port_lock</span><span class="p">,</span> <span class="n">iflag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmo_posted</span><span class="p">)</span>
		<span class="n">lpfc_worker_wake_up</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">lpfc_fdmi_timeout_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>

	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FDMI_DID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span> <span class="o">&amp;&amp;</span> <span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">lpfc_fdmi_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">SLI_MGMT_DHBA</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_fdmitmo</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">60</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">lpfc_decode_firmware_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fwrevision</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="n">lpfc_vpd_t</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">str</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">fwname</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">fwrevision</span><span class="p">,</span> <span class="n">FW_REV_STR_SIZE</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">.</span><span class="n">opFwName</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">.</span><span class="n">rBit</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">sli_flag</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI_ACTIVE</span><span class="p">)</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">.</span><span class="n">sli2FwRev</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rev</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">.</span><span class="n">sli1FwRev</span><span class="p">;</span>

		<span class="n">b1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x0000f000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x00000f00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">b3</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x000000c0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">b4</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x00000030</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">b4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;N&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;X&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b4</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">sli_flag</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI_ACTIVE</span><span class="p">)</span>
			<span class="n">fwname</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">.</span><span class="n">sli2FwName</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fwname</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">.</span><span class="n">sli1FwName</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fwname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="n">fwname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">fwname</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">fwrevision</span><span class="p">,</span> <span class="s">&quot;%d.%d%d (%s)&quot;</span><span class="p">,</span>
					<span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">fwrevision</span><span class="p">,</span> <span class="s">&quot;%d.%d%d&quot;</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span>
					<span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">fwrevision</span><span class="p">,</span> <span class="s">&quot;%d.%d%d%c%d (%s)&quot;</span><span class="p">,</span>
					<span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>
					<span class="n">b4</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">fwrevision</span><span class="p">,</span> <span class="s">&quot;%d.%d%d%c%d&quot;</span><span class="p">,</span>
					<span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">.</span><span class="n">smFwRev</span><span class="p">;</span>

		<span class="n">b1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x00f00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">b3</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x000f0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">c</span>  <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">b4</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">fwrevision</span><span class="p">,</span> <span class="s">&quot;%d.%d%d%c%d&quot;</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
