<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › lpfc › lpfc_debugfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lpfc_debugfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex Linux Device Driver for         *</span>
<span class="cm"> * Fibre Channel Host Bus Adapters.                                *</span>
<span class="cm"> * Copyright (C) 2007-2012 Emulex.  All rights reserved.           *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>

<span class="cp">#include &quot;lpfc_hw4.h&quot;</span>
<span class="cp">#include &quot;lpfc_hw.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli4.h&quot;</span>
<span class="cp">#include &quot;lpfc_nl.h&quot;</span>
<span class="cp">#include &quot;lpfc_disc.h&quot;</span>
<span class="cp">#include &quot;lpfc_scsi.h&quot;</span>
<span class="cp">#include &quot;lpfc.h&quot;</span>
<span class="cp">#include &quot;lpfc_logmsg.h&quot;</span>
<span class="cp">#include &quot;lpfc_crtn.h&quot;</span>
<span class="cp">#include &quot;lpfc_vport.h&quot;</span>
<span class="cp">#include &quot;lpfc_version.h&quot;</span>
<span class="cp">#include &quot;lpfc_compat.h&quot;</span>
<span class="cp">#include &quot;lpfc_debugfs.h&quot;</span>
<span class="cp">#include &quot;lpfc_bsg.h&quot;</span>

<span class="cp">#ifdef CONFIG_SCSI_LPFC_DEBUG_FS</span>
<span class="cm">/*</span>
<span class="cm"> * debugfs interface</span>
<span class="cm"> *</span>
<span class="cm"> * To access this interface the user should:</span>
<span class="cm"> * # mount -t debugfs none /sys/kernel/debug</span>
<span class="cm"> *</span>
<span class="cm"> * The lpfc debugfs directory hierarchy is:</span>
<span class="cm"> * /sys/kernel/debug/lpfc/fnX/vportY</span>
<span class="cm"> * where X is the lpfc hba function unique_id</span>
<span class="cm"> * where Y is the vport VPI on that hba</span>
<span class="cm"> *</span>
<span class="cm"> * Debugging services available per vport:</span>
<span class="cm"> * discovery_trace</span>
<span class="cm"> * This is an ACSII readable file that contains a trace of the last</span>
<span class="cm"> * lpfc_debugfs_max_disc_trc events that happened on a specific vport.</span>
<span class="cm"> * See lpfc_debugfs.h for different categories of  discovery events.</span>
<span class="cm"> * To enable the discovery trace, the following module parameters must be set:</span>
<span class="cm"> * lpfc_debugfs_enable=1         Turns on lpfc debugfs filesystem support</span>
<span class="cm"> * lpfc_debugfs_max_disc_trc=X   Where X is the event trace depth for</span>
<span class="cm"> *                               EACH vport. X MUST also be a power of 2.</span>
<span class="cm"> * lpfc_debugfs_mask_disc_trc=Y  Where Y is an event mask as defined in</span>
<span class="cm"> *                               lpfc_debugfs.h .</span>
<span class="cm"> *</span>
<span class="cm"> * slow_ring_trace</span>
<span class="cm"> * This is an ACSII readable file that contains a trace of the last</span>
<span class="cm"> * lpfc_debugfs_max_slow_ring_trc events that happened on a specific HBA.</span>
<span class="cm"> * To enable the slow ring trace, the following module parameters must be set:</span>
<span class="cm"> * lpfc_debugfs_enable=1         Turns on lpfc debugfs filesystem support</span>
<span class="cm"> * lpfc_debugfs_max_slow_ring_trc=X   Where X is the event trace depth for</span>
<span class="cm"> *                               the HBA. X MUST also be a power of 2.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lpfc_debugfs_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lpfc_debugfs_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lpfc_debugfs_enable</span><span class="p">,</span> <span class="s">&quot;Enable debugfs services&quot;</span><span class="p">);</span>

<span class="cm">/* This MUST be a power of 2 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">,</span>
	<span class="s">&quot;Set debugfs discovery trace depth&quot;</span><span class="p">);</span>

<span class="cm">/* This MUST be a power of 2 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">,</span>
	<span class="s">&quot;Set debugfs slow ring trace depth&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lpfc_debugfs_mask_disc_trc</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lpfc_debugfs_mask_disc_trc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lpfc_debugfs_mask_disc_trc</span><span class="p">,</span>
	<span class="s">&quot;Set debugfs discovery trace mask&quot;</span><span class="p">);</span>

<span class="cp">#include &lt;linux/debugfs.h&gt;</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">lpfc_debugfs_seq_trc_cnt</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lpfc_debugfs_start_time</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>

<span class="cm">/* iDiag */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lpfc_idiag</span> <span class="n">idiag</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_disc_trc_data - Dump discovery logging to a buffer</span>
<span class="cm"> * @vport: The vport to gather the log info from.</span>
<span class="cm"> * @buf: The buffer to dump log into.</span>
<span class="cm"> * @size: The maximum amount of data to process.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine gathers the lpfc discovery debugfs data from the @vport and</span>
<span class="cm"> * dumps it to @buf up to @size number of bytes. It will start at the next entry</span>
<span class="cm"> * in the log and process the log until the end of the buffer. Then it will</span>
<span class="cm"> * gather from the beginning of the log and process until the current entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * Discovery logging will be disabled while while this routine dumps the log.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> * This routine returns the amount of bytes that were dumped into @buf and will</span>
<span class="cm"> * not exceed @size.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_disc_trc_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">enable</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ms</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_debugfs_trc</span> <span class="o">*</span><span class="n">dtp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_DEBUG_TRC_ENTRY_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">enable</span> <span class="o">=</span> <span class="n">lpfc_debugfs_enable</span><span class="p">;</span>
	<span class="n">lpfc_debugfs_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc_cnt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">lpfc_debugfs_max_disc_trc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtp</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ms</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">jif</span> <span class="o">-</span> <span class="n">lpfc_debugfs_start_time</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
			<span class="n">LPFC_DEBUG_TRC_ENTRY_SIZE</span><span class="p">,</span> <span class="s">&quot;%010d:%010d ms:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">seq_cnt</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
			<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtp</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ms</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">jif</span> <span class="o">-</span> <span class="n">lpfc_debugfs_start_time</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
			<span class="n">LPFC_DEBUG_TRC_ENTRY_SIZE</span><span class="p">,</span> <span class="s">&quot;%010d:%010d ms:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">seq_cnt</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
			<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lpfc_debugfs_enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_slow_ring_trc_data - Dump slow ring logging to a buffer</span>
<span class="cm"> * @phba: The HBA to gather the log info from.</span>
<span class="cm"> * @buf: The buffer to dump log into.</span>
<span class="cm"> * @size: The maximum amount of data to process.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine gathers the lpfc slow ring debugfs data from the @phba and</span>
<span class="cm"> * dumps it to @buf up to @size number of bytes. It will start at the next entry</span>
<span class="cm"> * in the log and process the log until the end of the buffer. Then it will</span>
<span class="cm"> * gather from the beginning of the log and process until the current entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * Slow ring logging will be disabled while while this routine dumps the log.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> * This routine returns the amount of bytes that were dumped into @buf and will</span>
<span class="cm"> * not exceed @size.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_slow_ring_trc_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">enable</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ms</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_debugfs_trc</span> <span class="o">*</span><span class="n">dtp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_DEBUG_TRC_ENTRY_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">enable</span> <span class="o">=</span> <span class="n">lpfc_debugfs_enable</span><span class="p">;</span>
	<span class="n">lpfc_debugfs_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc_cnt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">lpfc_debugfs_max_slow_ring_trc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtp</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ms</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">jif</span> <span class="o">-</span> <span class="n">lpfc_debugfs_start_time</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
			<span class="n">LPFC_DEBUG_TRC_ENTRY_SIZE</span><span class="p">,</span> <span class="s">&quot;%010d:%010d ms:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">seq_cnt</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
			<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtp</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ms</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">jif</span> <span class="o">-</span> <span class="n">lpfc_debugfs_start_time</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
			<span class="n">LPFC_DEBUG_TRC_ENTRY_SIZE</span><span class="p">,</span> <span class="s">&quot;%010d:%010d ms:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">seq_cnt</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
			<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">,</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lpfc_debugfs_enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lpfc_debugfs_last_hbq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_hbqinfo_data - Dump host buffer queue info to a buffer</span>
<span class="cm"> * @phba: The HBA to gather host buffer info from.</span>
<span class="cm"> * @buf: The buffer to dump log into.</span>
<span class="cm"> * @size: The maximum amount of data to process.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine dumps the host buffer queue info from the @phba to @buf up to</span>
<span class="cm"> * @size number of bytes. A header that describes the current hbq state will be</span>
<span class="cm"> * dumped to @buf first and then info on each hbq entry will be dumped to @buf</span>
<span class="cm"> * until @size bytes have been dumped or all the hbq info has been dumped.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * This routine will rotate through each configured HBQ each time called.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> * This routine returns the amount of bytes that were dumped into @buf and will</span>
<span class="cm"> * not exceed @size.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_hbqinfo_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">posted</span><span class="p">,</span> <span class="n">low</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">phys</span><span class="p">,</span> <span class="n">raw_index</span><span class="p">,</span> <span class="n">getidx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hbq_init</span> <span class="o">*</span><span class="n">hip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hbq_s</span> <span class="o">*</span><span class="n">hbqs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hbq_entry</span> <span class="o">*</span><span class="n">hbqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">d_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hbq_dmabuf</span> <span class="o">*</span><span class="n">hbq_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">LPFC_HBQINFO_SIZE</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>

	<span class="cm">/* toggle between multiple hbqs, if any */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">lpfc_sli_hbq_count</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">lpfc_debugfs_last_hbq</span><span class="o">++</span><span class="p">;</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">lpfc_debugfs_last_hbq</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">lpfc_debugfs_last_hbq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">lpfc_debugfs_last_hbq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">lpfc_debugfs_last_hbq</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;HBQ %d Info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">hbqs</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbqs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">posted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">hbq_buffer_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">posted</span><span class="o">++</span><span class="p">;</span>

	<span class="n">hip</span> <span class="o">=</span>  <span class="n">lpfc_hbq_defs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;idx:%d prof:%d rn:%d bufcnt:%d icnt:%d acnt:%d posted %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hip</span><span class="o">-&gt;</span><span class="n">hbq_index</span><span class="p">,</span> <span class="n">hip</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">,</span> <span class="n">hip</span><span class="o">-&gt;</span><span class="n">rn</span><span class="p">,</span>
		<span class="n">hip</span><span class="o">-&gt;</span><span class="n">buffer_count</span><span class="p">,</span> <span class="n">hip</span><span class="o">-&gt;</span><span class="n">init_count</span><span class="p">,</span> <span class="n">hip</span><span class="o">-&gt;</span><span class="n">add_count</span><span class="p">,</span> <span class="n">posted</span><span class="p">);</span>

	<span class="n">raw_index</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbq_get</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">getidx</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">raw_index</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;entrys:%d bufcnt:%d Put:%d nPut:%d localGet:%d hbaGet:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span> <span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">buffer_count</span><span class="p">,</span> <span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">hbqPutIdx</span><span class="p">,</span>
		<span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">next_hbqPutIdx</span><span class="p">,</span> <span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">local_hbqGetIdx</span><span class="p">,</span> <span class="n">getidx</span><span class="p">);</span>

	<span class="n">hbqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hbq_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hbq_virt</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;%03d: %08x %04x %05x &quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hbqe</span><span class="o">-&gt;</span><span class="n">bde</span><span class="p">.</span><span class="n">addrLow</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hbqe</span><span class="o">-&gt;</span><span class="n">bde</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hbqe</span><span class="o">-&gt;</span><span class="n">buffer_tag</span><span class="p">));</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* First calculate if slot has an associated posted buffer */</span>
		<span class="n">low</span> <span class="o">=</span> <span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">hbqPutIdx</span> <span class="o">-</span> <span class="n">posted</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">hbqPutIdx</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">low</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Unused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">skipit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">hbqPutIdx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="o">+</span><span class="n">low</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;Unused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">skipit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Get the Buffer info for the posted buffer */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hbqs</span><span class="o">-&gt;</span><span class="n">hbq_buffer_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hbq_buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">d_buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hbq_dmabuf</span><span class="p">,</span> <span class="n">dbuf</span><span class="p">);</span>
			<span class="n">phys</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">hbq_buf</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">phys</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phys</span> <span class="o">==</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hbqe</span><span class="o">-&gt;</span><span class="n">bde</span><span class="p">.</span><span class="n">addrLow</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
					<span class="s">&quot;Buf%d: %p %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">hbq_buf</span><span class="o">-&gt;</span><span class="n">dbuf</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="n">hbq_buf</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;No DMAinfo?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">skipit:</span>
		<span class="n">hbqe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">LPFC_HBQINFO_SIZE</span> <span class="o">-</span> <span class="mi">54</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lpfc_debugfs_last_hba_slim_off</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_dumpHBASlim_data - Dump HBA SLIM info to a buffer</span>
<span class="cm"> * @phba: The HBA to gather SLIM info from.</span>
<span class="cm"> * @buf: The buffer to dump log into.</span>
<span class="cm"> * @size: The maximum amount of data to process.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine dumps the current contents of HBA SLIM for the HBA associated</span>
<span class="cm"> * with @phba to @buf up to @size bytes of data. This is the raw HBA SLIM data.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * This routine will only dump up to 1024 bytes of data each time called and</span>
<span class="cm"> * should be called multiple times to dump the entire HBA SLIM.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> * This routine returns the amount of bytes that were dumped into @buf and will</span>
<span class="cm"> * not exceed @size.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_dumpHBASlim_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;HBA SLIM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">lpfc_memcpy_from_slim</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">MBslimaddr</span> <span class="o">+</span> <span class="n">lpfc_debugfs_last_hba_slim_off</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">lpfc_debugfs_last_hba_slim_off</span><span class="p">;</span>

	<span class="cm">/* Set it up for the next time */</span>
	<span class="n">lpfc_debugfs_last_hba_slim_off</span> <span class="o">+=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_debugfs_last_hba_slim_off</span> <span class="o">&gt;=</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">lpfc_debugfs_last_hba_slim_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;%08x: %08x %08x %08x %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span>
		<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">7</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_dumpHostSlim_data - Dump host SLIM info to a buffer</span>
<span class="cm"> * @phba: The HBA to gather Host SLIM info from.</span>
<span class="cm"> * @buf: The buffer to dump log into.</span>
<span class="cm"> * @size: The maximum amount of data to process.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine dumps the current contents of host SLIM for the host associated</span>
<span class="cm"> * with @phba to @buf up to @size bytes of data. The dump will contain the</span>
<span class="cm"> * Mailbox, PCB, Rings, and Registers that are located in host memory.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> * This routine returns the amount of bytes that were dumped into @buf and will</span>
<span class="cm"> * not exceed @size.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_dumpHostSlim_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">word0</span><span class="p">,</span> <span class="n">word1</span><span class="p">,</span> <span class="n">word2</span><span class="p">,</span> <span class="n">word3</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_pgp</span> <span class="o">*</span><span class="n">pgpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;SLIM Mailbox</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slim2p</span><span class="p">.</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;%08x: %08x %08x %08x %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span>
		<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">7</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;SLIM PCB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PCB_t</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;%08x: %08x %08x %08x %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span>
		<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">7</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pgpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">port_gp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				 <span class="s">&quot;Ring %d: CMD GetInx:%d (Max:%d Next:%d &quot;</span>
				 <span class="s">&quot;Local:%d flg:x%x)  RSP PutInx:%d Max:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="p">,</span> <span class="n">pgpp</span><span class="o">-&gt;</span><span class="n">cmdGetInx</span><span class="p">,</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">numCiocb</span><span class="p">,</span>
				 <span class="n">pring</span><span class="o">-&gt;</span><span class="n">next_cmdidx</span><span class="p">,</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">local_getidx</span><span class="p">,</span>
				 <span class="n">pring</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">,</span> <span class="n">pgpp</span><span class="o">-&gt;</span><span class="n">rspPutInx</span><span class="p">,</span> <span class="n">pring</span><span class="o">-&gt;</span><span class="n">numRiocb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;=</span> <span class="n">LPFC_SLI_REV3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">word0</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">HAregaddr</span><span class="p">);</span>
		<span class="n">word1</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">CAregaddr</span><span class="p">);</span>
		<span class="n">word2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">HSregaddr</span><span class="p">);</span>
		<span class="n">word3</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;HA:%08x CA:%08x HS:%08x &quot;</span>
				 <span class="s">&quot;HC:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">word0</span><span class="p">,</span> <span class="n">word1</span><span class="p">,</span> <span class="n">word2</span><span class="p">,</span> <span class="n">word3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_nodelist_data - Dump target node list to a buffer</span>
<span class="cm"> * @vport: The vport to gather target node info from.</span>
<span class="cm"> * @buf: The buffer to dump log into.</span>
<span class="cm"> * @size: The maximum amount of data to process.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine dumps the current target node list associated with @vport to</span>
<span class="cm"> * @buf up to @size bytes of data. Each node entry in the dump will contain a</span>
<span class="cm"> * node state, DID, WWPN, WWNN, RPI, flags, type, and other useful fields.</span>
<span class="cm"> *</span>
<span class="cm"> * Return Value:</span>
<span class="cm"> * This routine returns the amount of bytes that were dumped into @buf and will</span>
<span class="cm"> * not exceed @size.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_nodelist_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">statep</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPFC_NODELIST_SIZE</span> <span class="o">/</span> <span class="n">LPFC_NODELIST_ENTRY_SIZE</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ndlp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodes</span><span class="p">,</span> <span class="n">nlp_listp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Missing Nodelist Entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NLP_STE_UNUSED_NODE</span>:
			<span class="n">statep</span> <span class="o">=</span> <span class="s">&quot;UNUSED&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NLP_STE_PLOGI_ISSUE</span>:
			<span class="n">statep</span> <span class="o">=</span> <span class="s">&quot;PLOGI &quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NLP_STE_ADISC_ISSUE</span>:
			<span class="n">statep</span> <span class="o">=</span> <span class="s">&quot;ADISC &quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NLP_STE_REG_LOGIN_ISSUE</span>:
			<span class="n">statep</span> <span class="o">=</span> <span class="s">&quot;REGLOG&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NLP_STE_PRLI_ISSUE</span>:
			<span class="n">statep</span> <span class="o">=</span> <span class="s">&quot;PRLI  &quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NLP_STE_UNMAPPED_NODE</span>:
			<span class="n">statep</span> <span class="o">=</span> <span class="s">&quot;UNMAP &quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NLP_STE_MAPPED_NODE</span>:
			<span class="n">statep</span> <span class="o">=</span> <span class="s">&quot;MAPPED&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NLP_STE_NPR_NODE</span>:
			<span class="n">statep</span> <span class="o">=</span> <span class="s">&quot;NPR   &quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">statep</span> <span class="o">=</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s DID:x%06x &quot;</span><span class="p">,</span>
			<span class="n">statep</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">);</span>
		<span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_portname</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;WWPN %02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x &quot;</span><span class="p">,</span>
			<span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span>
			<span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">7</span><span class="p">));</span>
		<span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_nodename</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;WWNN %02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x &quot;</span><span class="p">,</span>
			<span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span>
			<span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="mi">7</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;RPI:%03d flag:x%08x &quot;</span><span class="p">,</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;UNKNOWN_TYPE &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FC_NODE</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;FC_NODE &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FABRIC</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;FABRIC &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_TARGET</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;FCP_TGT sid:%d &quot;</span><span class="p">,</span>
				<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_sid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_type</span> <span class="o">&amp;</span> <span class="n">NLP_FCP_INITIATOR</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;FCP_INITIATOR &quot;</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;usgmap:%x &quot;</span><span class="p">,</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_usg_map</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;refcnt:%x&quot;</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">.</span><span class="n">refcount</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">+=</span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_disc_trc - Store discovery trace log</span>
<span class="cm"> * @vport: The vport to associate this trace string with for retrieval.</span>
<span class="cm"> * @mask: Log entry classification.</span>
<span class="cm"> * @fmt: Format string to be displayed when dumping the log.</span>
<span class="cm"> * @data1: 1st data parameter to be applied to @fmt.</span>
<span class="cm"> * @data2: 2nd data parameter to be applied to @fmt.</span>
<span class="cm"> * @data3: 3rd data parameter to be applied to @fmt.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is used by the driver code to add a debugfs log entry to the</span>
<span class="cm"> * discovery trace buffer associated with @vport. Only entries with a @mask that</span>
<span class="cm"> * match the current debugfs discovery mask will be saved. Entries that do not</span>
<span class="cm"> * match will be thrown away. @fmt, @data1, @data2, and @data3 are used like</span>
<span class="cm"> * printf when displaying the log.</span>
<span class="cm"> **/</span>
<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lpfc_debugfs_disc_trc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">data1</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data2</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data3</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_LPFC_DEBUG_FS</span>
	<span class="k">struct</span> <span class="n">lpfc_debugfs_trc</span> <span class="o">*</span><span class="n">dtp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpfc_debugfs_mask_disc_trc</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_debugfs_enable</span> <span class="o">||</span> <span class="o">!</span><span class="n">lpfc_debugfs_max_disc_trc</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">vport</span> <span class="o">||</span> <span class="o">!</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc_cnt</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">lpfc_debugfs_max_disc_trc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dtp</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data3</span> <span class="o">=</span> <span class="n">data3</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">seq_cnt</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpfc_debugfs_seq_trc_cnt</span><span class="p">);</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">jif</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_slow_ring_trc - Store slow ring trace log</span>
<span class="cm"> * @phba: The phba to associate this trace string with for retrieval.</span>
<span class="cm"> * @fmt: Format string to be displayed when dumping the log.</span>
<span class="cm"> * @data1: 1st data parameter to be applied to @fmt.</span>
<span class="cm"> * @data2: 2nd data parameter to be applied to @fmt.</span>
<span class="cm"> * @data3: 3rd data parameter to be applied to @fmt.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is used by the driver code to add a debugfs log entry to the</span>
<span class="cm"> * discovery trace buffer associated with @vport. @fmt, @data1, @data2, and</span>
<span class="cm"> * @data3 are used like printf when displaying the log.</span>
<span class="cm"> **/</span>
<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lpfc_debugfs_slow_ring_trc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
	<span class="kt">uint32_t</span> <span class="n">data1</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data2</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data3</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_LPFC_DEBUG_FS</span>
	<span class="k">struct</span> <span class="n">lpfc_debugfs_trc</span> <span class="o">*</span><span class="n">dtp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_debugfs_enable</span> <span class="o">||</span> <span class="o">!</span><span class="n">lpfc_debugfs_max_slow_ring_trc</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">phba</span> <span class="o">||</span> <span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc_cnt</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">lpfc_debugfs_max_slow_ring_trc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dtp</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">data3</span> <span class="o">=</span> <span class="n">data3</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">seq_cnt</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpfc_debugfs_seq_trc_cnt</span><span class="p">);</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">jif</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_LPFC_DEBUG_FS</span>
<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_disc_trc_open - Open the discovery trace log</span>
<span class="cm"> * @inode: The inode pointer that contains a vport pointer.</span>
<span class="cm"> * @file: The file pointer to attach the log output.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is the entry point for the debugfs open file operation. It gets</span>
<span class="cm"> * the vport from the i_private field in @inode, allocates the necessary buffer</span>
<span class="cm"> * for the log, fills the buffer from the in-memory log for this vport, and then</span>
<span class="cm"> * returns a pointer to that log in the private_data field in @file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero if successful. On error it will return an negative</span>
<span class="cm"> * error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_disc_trc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">debug</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Round to page boundary */</span>
	<span class="n">size</span> <span class="o">=</span>  <span class="p">(</span><span class="n">lpfc_debugfs_max_disc_trc</span> <span class="o">*</span> <span class="n">LPFC_DEBUG_TRC_ENTRY_SIZE</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_debugfs_disc_trc_data</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_slow_ring_trc_open - Open the Slow Ring trace log</span>
<span class="cm"> * @inode: The inode pointer that contains a vport pointer.</span>
<span class="cm"> * @file: The file pointer to attach the log output.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is the entry point for the debugfs open file operation. It gets</span>
<span class="cm"> * the vport from the i_private field in @inode, allocates the necessary buffer</span>
<span class="cm"> * for the log, fills the buffer from the in-memory log for this vport, and then</span>
<span class="cm"> * returns a pointer to that log in the private_data field in @file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero if successful. On error it will return an negative</span>
<span class="cm"> * error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_slow_ring_trc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">debug</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Round to page boundary */</span>
	<span class="n">size</span> <span class="o">=</span>  <span class="p">(</span><span class="n">lpfc_debugfs_max_slow_ring_trc</span> <span class="o">*</span> <span class="n">LPFC_DEBUG_TRC_ENTRY_SIZE</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_debugfs_slow_ring_trc_data</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_hbqinfo_open - Open the hbqinfo debugfs buffer</span>
<span class="cm"> * @inode: The inode pointer that contains a vport pointer.</span>
<span class="cm"> * @file: The file pointer to attach the log output.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is the entry point for the debugfs open file operation. It gets</span>
<span class="cm"> * the vport from the i_private field in @inode, allocates the necessary buffer</span>
<span class="cm"> * for the log, fills the buffer from the in-memory log for this vport, and then</span>
<span class="cm"> * returns a pointer to that log in the private_data field in @file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero if successful. On error it will return an negative</span>
<span class="cm"> * error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_hbqinfo_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">debug</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Round to page boundary */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_HBQINFO_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_debugfs_hbqinfo_data</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
		<span class="n">LPFC_HBQINFO_SIZE</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_dumpHBASlim_open - Open the Dump HBA SLIM debugfs buffer</span>
<span class="cm"> * @inode: The inode pointer that contains a vport pointer.</span>
<span class="cm"> * @file: The file pointer to attach the log output.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is the entry point for the debugfs open file operation. It gets</span>
<span class="cm"> * the vport from the i_private field in @inode, allocates the necessary buffer</span>
<span class="cm"> * for the log, fills the buffer from the in-memory log for this vport, and then</span>
<span class="cm"> * returns a pointer to that log in the private_data field in @file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero if successful. On error it will return an negative</span>
<span class="cm"> * error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_dumpHBASlim_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">debug</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Round to page boundary */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_DUMPHBASLIM_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_debugfs_dumpHBASlim_data</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
		<span class="n">LPFC_DUMPHBASLIM_SIZE</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_dumpHostSlim_open - Open the Dump Host SLIM debugfs buffer</span>
<span class="cm"> * @inode: The inode pointer that contains a vport pointer.</span>
<span class="cm"> * @file: The file pointer to attach the log output.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is the entry point for the debugfs open file operation. It gets</span>
<span class="cm"> * the vport from the i_private field in @inode, allocates the necessary buffer</span>
<span class="cm"> * for the log, fills the buffer from the in-memory log for this vport, and then</span>
<span class="cm"> * returns a pointer to that log in the private_data field in @file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero if successful. On error it will return an negative</span>
<span class="cm"> * error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_dumpHostSlim_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">debug</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Round to page boundary */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_DUMPHOSTSLIM_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_debugfs_dumpHostSlim_data</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
		<span class="n">LPFC_DUMPHOSTSLIM_SIZE</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_dumpData_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_dump_buf_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">debug</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Round to page boundary */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;9059 BLKGRD:  %s: _dump_buf_data=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">_dump_buf_data</span><span class="p">);</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">_dump_buf_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">_dump_buf_data_order</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_dumpDif_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_dump_buf_dif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">debug</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Round to page boundary */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>	<span class="s">&quot;9060 BLKGRD: %s: _dump_buf_dif=0x%p file=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">_dump_buf_dif</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">_dump_buf_dif</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">_dump_buf_dif_order</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_debugfs_dumpDataDif_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		  <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The Data/DIF buffers only save one failing IO</span>
<span class="cm">	 * The write op is used as a reset mechanism after an IO has</span>
<span class="cm">	 * already been saved to the next one can be saved</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_dump_buf_lock</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">_dump_buf_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">_dump_buf_data_order</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">_dump_buf_dif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">_dump_buf_dif_order</span><span class="p">));</span>

	<span class="n">_dump_buf_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_dump_buf_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_debugfs_dif_err_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dent</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">uint64_t</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeGuard</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_wgrd_cnt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeApp</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_wapp_cnt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeRef</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_wref_cnt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readGuard</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_rgrd_cnt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readApp</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_rapp_cnt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readRef</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_rref_cnt</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrNPortID</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_nportid</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrWWPN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_wwpn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrLBA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_lba</span> <span class="o">==</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_lba</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
			 <span class="s">&quot;0547 Unknown debugfs error injection entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_debugfs_dif_err_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dent</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dstbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">uint64_t</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dstbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="n">nbytes</span> <span class="o">:</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">dstbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrLBA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;o&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;f&#39;</span><span class="p">))</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">kstrtoull</span><span class="p">(</span><span class="n">dstbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeGuard</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_wgrd_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeApp</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_wapp_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeRef</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_wref_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readGuard</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_rgrd_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readApp</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_rapp_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readRef</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_rref_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrLBA</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_lba</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_t</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrNPortID</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_nportid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">Mask_DID</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dent</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrWWPN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
			 <span class="s">&quot;0548 Unknown debugfs error injection entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_dif_err_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_nodelist_open - Open the nodelist debugfs file</span>
<span class="cm"> * @inode: The inode pointer that contains a vport pointer.</span>
<span class="cm"> * @file: The file pointer to attach the log output.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is the entry point for the debugfs open file operation. It gets</span>
<span class="cm"> * the vport from the i_private field in @inode, allocates the necessary buffer</span>
<span class="cm"> * for the log, fills the buffer from the in-memory log for this vport, and then</span>
<span class="cm"> * returns a pointer to that log in the private_data field in @file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero if successful. On error it will return an negative</span>
<span class="cm"> * error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_nodelist_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">debug</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Round to page boundary */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_NODELIST_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_debugfs_nodelist_data</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
		<span class="n">LPFC_NODELIST_SIZE</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_lseek - Seek through a debugfs file</span>
<span class="cm"> * @file: The file pointer to seek through.</span>
<span class="cm"> * @off: The offset to seek to or the amount to seek by.</span>
<span class="cm"> * @whence: Indicates how to seek.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is the entry point for the debugfs lseek file operation. The</span>
<span class="cm"> * @whence parameter indicates whether @off is the offset to directly seek to,</span>
<span class="cm"> * or if it is a value to seek forward or reverse by. This function figures out</span>
<span class="cm"> * what the new offset of the debugfs file will be and assigns that value to the</span>
<span class="cm"> * f_pos field of @file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the new offset if successful and returns a negative</span>
<span class="cm"> * error if unable to process the seek.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">loff_t</span>
<span class="nf">lpfc_debugfs_lseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whence</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">whence</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_read - Read a debugfs file</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the data to.</span>
<span class="cm"> * @nbytes: The number of bytes to read.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads data from from the buffer indicated in the private_data</span>
<span class="cm"> * field of @file. It will start reading at @ppos and copy up to @nbytes of</span>
<span class="cm"> * data to @buf.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_debugfs_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		  <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="n">debug</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_release - Release the buffer used to store debugfs file data</span>
<span class="cm"> * @inode: The inode pointer that contains a vport pointer. (unused)</span>
<span class="cm"> * @file: The file pointer that contains the buffer to release.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine frees the buffer that was allocated when the debugfs file was</span>
<span class="cm"> * opened.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_debugfs_dumpDataDif_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------</span>
<span class="cm"> * iDiag debugfs file access methods</span>
<span class="cm"> * ---------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * All access methods are through the proper SLI4 PCI function&#39;s debugfs</span>
<span class="cm"> * iDiag directory:</span>
<span class="cm"> *</span>
<span class="cm"> *     /sys/kernel/debug/lpfc/fn&lt;#&gt;/iDiag</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_cmd_get - Get and parse idiag debugfs comands from user space</span>
<span class="cm"> * @buf: The pointer to the user space buffer.</span>
<span class="cm"> * @nbytes: The number of bytes in the user space buffer.</span>
<span class="cm"> * @idiag_cmd: pointer to the idiag command struct.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine reads data from debugfs user space buffer and parses the</span>
<span class="cm"> * buffer for getting the idiag command and arguments. The while space in</span>
<span class="cm"> * between the set of data is used as the parsing separator.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine returns 0 when successful, it returns proper error code</span>
<span class="cm"> * back to the user space in error conditions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lpfc_idiag_cmd_get</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">lpfc_idiag_cmd</span> <span class="o">*</span><span class="n">idiag_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">mybuf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">,</span> <span class="o">*</span><span class="n">step_str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bsize</span><span class="p">;</span>

	<span class="cm">/* Protect copy from user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mybuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mybuf</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">idiag_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">idiag_cmd</span><span class="p">));</span>
	<span class="n">bsize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mybuf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">mybuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bsize</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mybuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">step_str</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbuf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s"> &quot;</span><span class="p">);</span>

	<span class="cm">/* The opcode must present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">step_str</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">idiag_cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">step_str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idiag_cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LPFC_IDIAG_CMD_DATA_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">step_str</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbuf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s"> &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">step_str</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">idiag_cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">step_str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_open - idiag open debugfs</span>
<span class="cm"> * @inode: The inode pointer that contains a pointer to phba.</span>
<span class="cm"> * @file: The file pointer to attach the file operation.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is the entry point for the debugfs open file operation. It</span>
<span class="cm"> * gets the reference to phba from the i_private field in @inode, it then</span>
<span class="cm"> * allocates buffer for the file operation, performs the necessary PCI config</span>
<span class="cm"> * space read into the allocated buffer according to the idiag user command</span>
<span class="cm"> * setup, and then returns a pointer to buffer in the private_data field in</span>
<span class="cm"> * @file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero if successful. On error it will return an</span>
<span class="cm"> * negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>

	<span class="n">debug</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">debug</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_release - Release idiag access file operation</span>
<span class="cm"> * @inode: The inode pointer that contains a vport pointer. (unused)</span>
<span class="cm"> * @file: The file pointer that contains the buffer to release.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is the generic release routine for the idiag access file</span>
<span class="cm"> * operation, it frees the buffer that was allocated when the debugfs file</span>
<span class="cm"> * was opened.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* Free the buffers to the file operation */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_cmd_release - Release idiag cmd access file operation</span>
<span class="cm"> * @inode: The inode pointer that contains a vport pointer. (unused)</span>
<span class="cm"> * @file: The file pointer that contains the buffer to release.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine frees the buffer that was allocated when the debugfs file</span>
<span class="cm"> * was opened. It also reset the fields in the idiag command struct in the</span>
<span class="cm"> * case of command for write operation.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns zero.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_cmd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_OP_WR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_WR</span>:
		<span class="k">case</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_ST</span>:
		<span class="k">case</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_CL</span>:
		<span class="k">case</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_WR</span>:
		<span class="k">case</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_ST</span>:
		<span class="k">case</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_CL</span>:
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Free the buffers to the file operation */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_pcicfg_read - idiag debugfs read pcicfg</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the data to.</span>
<span class="cm"> * @nbytes: The number of bytes to read.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads data from the @phba pci config space according to the</span>
<span class="cm"> * idiag command, and copies to user @buf. Depending on the PCI config space</span>
<span class="cm"> * read command setup, it does either a single register read of a byte</span>
<span class="cm"> * (8 bits), a word (16 bits), or a dword (32 bits) or browsing through all</span>
<span class="cm"> * registers from the 4K extended PCI config space.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_pcicfg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
		       <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset_label</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">LPFC_PCI_CFG_RD_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">u32val</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">u16val</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">u8val</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is a user read operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_RD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_PCI_CFG_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbuffer</span> <span class="o">=</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">where</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_PCICFG_WHERE_INDX</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_PCICFG_COUNT_INDX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read single PCI config space register */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIZE_U8</span>: <span class="cm">/* byte (8 bits) */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u8val</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_CFG_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;%03x: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">u8val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIZE_U16</span>: <span class="cm">/* word (16 bits) */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u16val</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_CFG_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;%03x: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">u16val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIZE_U32</span>: <span class="cm">/* double word (32 bits) */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u32val</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_CFG_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;%03x: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">u32val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_PCI_CFG_BROWSE</span>: <span class="cm">/* browse all */</span>
		<span class="k">goto</span> <span class="n">pcicfg_browse</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* illegal count */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

<span class="nl">pcicfg_browse:</span>

	<span class="cm">/* Browse all PCI config space registers */</span>
	<span class="n">offset_label</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">offset_label</span><span class="p">;</span>

	<span class="cm">/* Read PCI config space */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_CFG_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;%03x: &quot;</span><span class="p">,</span> <span class="n">offset_label</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u32val</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_CFG_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;%08x &quot;</span><span class="p">,</span> <span class="n">u32val</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">LPFC_PCI_CFG_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_PCI_CFG_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">index</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">index</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_CFG_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">index</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">offset_label</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_CFG_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\n</span><span class="s">%03x: &quot;</span><span class="p">,</span> <span class="n">offset_label</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set up the offset for next portion of pci cfg read */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">+=</span> <span class="n">LPFC_PCI_CFG_RD_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">&gt;=</span> <span class="n">LPFC_PCI_CFG_SIZE</span><span class="p">)</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_pcicfg_write - Syntax check and set up idiag pcicfg commands</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the user data from.</span>
<span class="cm"> * @nbytes: The number of bytes to get.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine get the debugfs idiag command struct from user space and</span>
<span class="cm"> * then perform the syntax check for PCI config space read or write command</span>
<span class="cm"> * accordingly. In the case of PCI config space read command, it sets up</span>
<span class="cm"> * the command in the idiag command struct for the debugfs read operation.</span>
<span class="cm"> * In the case of PCI config space write operation, it executes the write</span>
<span class="cm"> * operation into the PCI config space accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * It returns the @nbytges passing in from debugfs user space when successful.</span>
<span class="cm"> * In case of error conditions, it returns proper error code back to the user</span>
<span class="cm"> * space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_pcicfg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">where</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">u32val</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">u16val</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">u8val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* This is a user write operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_WR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_cmd_get</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sanity check on PCI config read command line arguments */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_PCI_CFG_RD_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="cm">/* Read command from PCI config space, set up command fields */</span>
		<span class="n">where</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_PCICFG_WHERE_INDX</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_PCICFG_COUNT_INDX</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">LPFC_PCI_CFG_BROWSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="cm">/* Starting offset to browse */</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="n">where</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&gt;</span> <span class="n">LPFC_PCI_CFG_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&gt;</span> <span class="n">LPFC_PCI_CFG_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&gt;</span> <span class="n">LPFC_PCI_CFG_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_WR</span> <span class="o">||</span>
		   <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_ST</span> <span class="o">||</span>
		   <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_CL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sanity check on PCI config write command line arguments */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_PCI_CFG_WR_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="cm">/* Write command to PCI config space, read-modify-write */</span>
		<span class="n">where</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_PCICFG_WHERE_INDX</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_PCICFG_COUNT_INDX</span><span class="p">];</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_PCICFG_VALUE_INDX</span><span class="p">];</span>
		<span class="cm">/* Sanity checks */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&gt;</span> <span class="n">LPFC_PCI_CFG_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_WR</span><span class="p">)</span>
				<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
						      <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_ST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u8val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u8val</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
					<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
							      <span class="n">u8val</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_CL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u8val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u8val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="o">~</span><span class="n">value</span><span class="p">);</span>
					<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
							      <span class="n">u8val</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&gt;</span> <span class="n">LPFC_PCI_CFG_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_WR</span><span class="p">)</span>
				<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
						      <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_ST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u16val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u16val</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
					<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
							      <span class="n">u16val</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_CL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u16val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u16val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="o">~</span><span class="n">value</span><span class="p">);</span>
					<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
							      <span class="n">u16val</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">&gt;</span> <span class="n">LPFC_PCI_CFG_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_WR</span><span class="p">)</span>
				<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_ST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">u32val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u32val</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
					<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
							       <span class="n">u32val</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_PCICFG_CL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">u32val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u32val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">value</span><span class="p">;</span>
					<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
							       <span class="n">u32val</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* All other opecodes are illegal for now */</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="nl">error_out:</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_baracc_read - idiag debugfs pci bar access read</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the data to.</span>
<span class="cm"> * @nbytes: The number of bytes to read.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads data from the @phba pci bar memory mapped space</span>
<span class="cm"> * according to the idiag command, and copies to user @buf.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_baracc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
		       <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset_label</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset_run</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bar_num</span><span class="p">,</span> <span class="n">acc_range</span><span class="p">,</span> <span class="n">bar_size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_mapped_bar</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">if_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">u32val</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is a user read operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_RD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_PCI_BAR_RD_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbuffer</span> <span class="o">=</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_BARACC_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bar_num</span>   <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_BAR_NUM_INDX</span><span class="p">];</span>
		<span class="n">offset</span>    <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_OFF_SET_INDX</span><span class="p">];</span>
		<span class="n">acc_range</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_ACC_MOD_INDX</span><span class="p">];</span>
		<span class="n">bar_size</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_BAR_SZE_INDX</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acc_range</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">if_type</span> <span class="o">=</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_sli_intf_if_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sli_intf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">LPFC_SLI_INTF_IF_TYPE_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">==</span> <span class="n">IDIAG_BARACC_BAR_0</span><span class="p">)</span>
			<span class="n">mem_mapped_bar</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">==</span> <span class="n">IDIAG_BARACC_BAR_1</span><span class="p">)</span>
			<span class="n">mem_mapped_bar</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">ctrl_regs_memmap_p</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">==</span> <span class="n">IDIAG_BARACC_BAR_2</span><span class="p">)</span>
			<span class="n">mem_mapped_bar</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">drbl_regs_memmap_p</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">LPFC_SLI_INTF_IF_TYPE_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">==</span> <span class="n">IDIAG_BARACC_BAR_0</span><span class="p">)</span>
			<span class="n">mem_mapped_bar</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read single PCI bar space register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acc_range</span> <span class="o">==</span> <span class="n">SINGLE_WORD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset_run</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">u32val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset_run</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_BAR_RD_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;%05x: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset_run</span><span class="p">,</span> <span class="n">u32val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">baracc_browse</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

<span class="nl">baracc_browse:</span>

	<span class="cm">/* Browse all PCI bar space registers */</span>
	<span class="n">offset_label</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span><span class="p">;</span>
	<span class="n">offset_run</span> <span class="o">=</span> <span class="n">offset_label</span><span class="p">;</span>

	<span class="cm">/* Read PCI bar memory mapped space */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_BAR_RD_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;%05x: &quot;</span><span class="p">,</span> <span class="n">offset_label</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">LPFC_PCI_BAR_RD_SIZE</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset_run</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_PCI_BAR_RD_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;%08x &quot;</span><span class="p">,</span> <span class="n">u32val</span><span class="p">);</span>
		<span class="n">offset_run</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acc_range</span> <span class="o">==</span> <span class="n">LPFC_PCI_BAR_BROWSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset_run</span> <span class="o">&gt;=</span> <span class="n">bar_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_PCI_BAR_RD_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset_run</span> <span class="o">&gt;=</span> <span class="n">offset</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">acc_range</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_PCI_BAR_RD_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">index</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">index</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_PCI_BAR_RD_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">index</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">offset_label</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_PCI_BAR_RD_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\n</span><span class="s">%05x: &quot;</span><span class="p">,</span> <span class="n">offset_label</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set up the offset for next portion of pci bar read */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">+=</span> <span class="n">LPFC_PCI_BAR_RD_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acc_range</span> <span class="o">==</span> <span class="n">LPFC_PCI_BAR_BROWSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">&gt;=</span> <span class="n">bar_size</span><span class="p">)</span>
				<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset_run</span> <span class="o">&gt;=</span> <span class="n">offset</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">acc_range</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span>
				<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acc_range</span> <span class="o">==</span> <span class="n">LPFC_PCI_BAR_BROWSE</span><span class="p">)</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_baracc_write - Syntax check and set up idiag bar access commands</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the user data from.</span>
<span class="cm"> * @nbytes: The number of bytes to get.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine get the debugfs idiag command struct from user space and</span>
<span class="cm"> * then perform the syntax check for PCI bar memory mapped space read or</span>
<span class="cm"> * write command accordingly. In the case of PCI bar memory mapped space</span>
<span class="cm"> * read command, it sets up the command in the idiag command struct for</span>
<span class="cm"> * the debugfs read operation. In the case of PCI bar memorpy mapped space</span>
<span class="cm"> * write operation, it executes the write operation into the PCI bar memory</span>
<span class="cm"> * mapped space accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * It returns the @nbytges passing in from debugfs user space when successful.</span>
<span class="cm"> * In case of error conditions, it returns proper error code back to the user</span>
<span class="cm"> * space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_baracc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bar_num</span><span class="p">,</span> <span class="n">bar_size</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">acc_range</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_mapped_bar</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">if_type</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">u32val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* This is a user write operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_WR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_cmd_get</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">if_type</span> <span class="o">=</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_sli_intf_if_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sli_intf</span><span class="p">);</span>
	<span class="n">bar_num</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_BAR_NUM_INDX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">LPFC_SLI_INTF_IF_TYPE_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bar_num</span> <span class="o">!=</span> <span class="n">IDIAG_BARACC_BAR_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">bar_num</span> <span class="o">!=</span> <span class="n">IDIAG_BARACC_BAR_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">bar_num</span> <span class="o">!=</span> <span class="n">IDIAG_BARACC_BAR_2</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">LPFC_SLI_INTF_IF_TYPE_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">!=</span> <span class="n">IDIAG_BARACC_BAR_0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">LPFC_SLI_INTF_IF_TYPE_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">==</span> <span class="n">IDIAG_BARACC_BAR_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_BAR_SZE_INDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">LPFC_PCI_IF0_BAR0_SIZE</span><span class="p">;</span>
			<span class="n">mem_mapped_bar</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">==</span> <span class="n">IDIAG_BARACC_BAR_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_BAR_SZE_INDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">LPFC_PCI_IF0_BAR1_SIZE</span><span class="p">;</span>
			<span class="n">mem_mapped_bar</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">ctrl_regs_memmap_p</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">==</span> <span class="n">IDIAG_BARACC_BAR_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_BAR_SZE_INDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">LPFC_PCI_IF0_BAR2_SIZE</span><span class="p">;</span>
			<span class="n">mem_mapped_bar</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">drbl_regs_memmap_p</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">if_type</span> <span class="o">==</span> <span class="n">LPFC_SLI_INTF_IF_TYPE_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">==</span> <span class="n">IDIAG_BARACC_BAR_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_BAR_SZE_INDX</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">LPFC_PCI_IF2_BAR0_SIZE</span><span class="p">;</span>
			<span class="n">mem_mapped_bar</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_OFF_SET_INDX</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="n">bar_size</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_BAR_SZE_INDX</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_BARACC_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sanity check on PCI config read command line arguments */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_PCI_BAR_RD_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="n">acc_range</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_ACC_MOD_INDX</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acc_range</span> <span class="o">==</span> <span class="n">LPFC_PCI_BAR_BROWSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">bar_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="cm">/* Starting offset to browse */</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acc_range</span> <span class="o">&gt;</span> <span class="n">SINGLE_WORD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">acc_range</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bar_size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="cm">/* Starting offset to browse */</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acc_range</span> <span class="o">!=</span> <span class="n">SINGLE_WORD</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_BARACC_WR</span> <span class="o">||</span>
		   <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_BARACC_ST</span> <span class="o">||</span>
		   <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_BARACC_CL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Sanity check on PCI bar write command line arguments */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_PCI_BAR_WR_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="cm">/* Write command to PCI bar space, read-modify-write */</span>
		<span class="n">acc_range</span> <span class="o">=</span> <span class="n">SINGLE_WORD</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_BARACC_REG_VAL_INDX</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_BARACC_WR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_BARACC_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">u32val</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">u32val</span><span class="p">,</span> <span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_BARACC_CL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">u32val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">value</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">u32val</span><span class="p">,</span> <span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">mem_mapped_bar</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* All other opecodes are illegal for now */</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="nl">error_out:</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_queinfo_read - idiag debugfs read queue information</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the data to.</span>
<span class="cm"> * @nbytes: The number of bytes to read.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads data from the @phba SLI4 PCI function queue information,</span>
<span class="cm"> * and copies to user @buf.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_queinfo_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
			<span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcp_qidx</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbuffer</span> <span class="o">=</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get slow-path event queue information */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Slow-path EQ information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">EQID[%02d], &quot;</span>
			<span class="s">&quot;QE-COUNT[%04d], QE-SIZE[%04d], &quot;</span>
			<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get fast-path event queue information */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Fast-path EQ information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">fcp_qidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fcp_qidx</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_fcp_eq_count</span><span class="p">;</span>
		     <span class="n">fcp_qidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\t</span><span class="s">EQID[%02d], &quot;</span>
				<span class="s">&quot;QE-COUNT[%04d], QE-SIZE[%04d], &quot;</span>
				<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Get mailbox complete queue information */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Slow-path MBX CQ information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Associated EQID[%02d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="o">-&gt;</span><span class="n">assoc_qid</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">CQID[%02d], &quot;</span>
			<span class="s">&quot;QE-COUNT[%04d], QE-SIZE[%04d], &quot;</span>
			<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get slow-path complete queue information */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Slow-path ELS CQ information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Associated EQID[%02d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="o">-&gt;</span><span class="n">assoc_qid</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">CQID [%02d], &quot;</span>
			<span class="s">&quot;QE-COUNT[%04d], QE-SIZE[%04d], &quot;</span>
			<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get fast-path complete queue information */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Fast-path FCP CQ information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fcp_qidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Associated EQID[%02d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">assoc_qid</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\t</span><span class="s">CQID[%02d], &quot;</span>
				<span class="s">&quot;QE-COUNT[%04d], QE-SIZE[%04d], &quot;</span>
				<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">fcp_qidx</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_fcp_eq_count</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
				<span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get mailbox queue information */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Slow-path MBX MQ information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Associated CQID[%02d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="o">-&gt;</span><span class="n">assoc_qid</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">WQID[%02d], &quot;</span>
			<span class="s">&quot;QE-COUNT[%04d], QE-SIZE[%04d], &quot;</span>
			<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get slow-path work queue information */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Slow-path ELS WQ information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Associated CQID[%02d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="o">-&gt;</span><span class="n">assoc_qid</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">WQID[%02d], &quot;</span>
			<span class="s">&quot;QE-COUNT[%04d], QE-SIZE[%04d], &quot;</span>
			<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get fast-path work queue information */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Fast-path FCP WQ information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">fcp_qidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fcp_qidx</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_fcp_wq_count</span><span class="p">;</span>
		     <span class="n">fcp_qidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Associated CQID[%02d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">assoc_qid</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\t</span><span class="s">WQID[%02d], &quot;</span>
				<span class="s">&quot;QE-COUNT[%04d], WQE-SIZE[%04d], &quot;</span>
				<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">fcp_qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
				<span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get receive queue information */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Slow-path RQ information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span> <span class="o">&amp;&amp;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Associated CQID[%02d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="o">-&gt;</span><span class="n">assoc_qid</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">HQID[%02d], &quot;</span>
			<span class="s">&quot;QE-COUNT[%04d], QE-SIZE[%04d], &quot;</span>
			<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_INFO_GET_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">DQID[%02d], &quot;</span>
			<span class="s">&quot;QE-COUNT[%04d], QE-SIZE[%04d], &quot;</span>
			<span class="s">&quot;HOST-INDEX[%04d], PORT-INDEX[%04d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span><span class="o">-&gt;</span><span class="n">entry_count</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span><span class="o">-&gt;</span><span class="n">host_index</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span><span class="o">-&gt;</span><span class="n">hba_index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_que_param_check - queue access command parameter sanity check</span>
<span class="cm"> * @q: The pointer to queue structure.</span>
<span class="cm"> * @index: The index into a queue entry.</span>
<span class="cm"> * @count: The number of queue entries to access.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * The routine performs sanity check on device queue access method commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns -EINVAL when fails the sanity check, otherwise, it</span>
<span class="cm"> * returns 0.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_que_param_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Only support single entry read or browsing */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">LPFC_QUE_ACC_BROWSE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_queacc_read_qe - read a single entry from the given queue index</span>
<span class="cm"> * @pbuffer: The pointer to buffer to copy the read data into.</span>
<span class="cm"> * @pque: The pointer to the queue to be read.</span>
<span class="cm"> * @index: The index into the queue entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads out a single entry from the given queue&#39;s index location</span>
<span class="cm"> * and copies it into the buffer provided.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns 0 when it fails, otherwise, it returns the length of</span>
<span class="cm"> * the data read into the buffer provided.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_queacc_read_qe</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_queue</span> <span class="o">*</span><span class="n">pque</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">esize</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">pentry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuffer</span> <span class="o">||</span> <span class="o">!</span><span class="n">pque</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">esize</span> <span class="o">=</span> <span class="n">pque</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;QE-INDEX[%04d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pentry</span> <span class="o">=</span> <span class="n">pque</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">esize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;%08x &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pentry</span><span class="p">);</span>
		<span class="n">pentry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="n">esize</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))))</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_QUE_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_QUE_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_queacc_read - idiag debugfs read port queue</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the data to.</span>
<span class="cm"> * @nbytes: The number of bytes to read.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads data from the @phba device queue memory according to the</span>
<span class="cm"> * idiag command, and copies to user @buf. Depending on the queue dump read</span>
<span class="cm"> * command setup, it does either a single queue entry read or browing through</span>
<span class="cm"> * all entries of the queue.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_queacc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
		       <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">last_index</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_queue</span> <span class="o">*</span><span class="n">pque</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is a user read operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_RD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_QUE_ACC_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbuffer</span> <span class="o">=</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_QUEACC_INDEX_INDX</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_QUEACC_COUNT_INDX</span><span class="p">];</span>
		<span class="n">pque</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_queue</span> <span class="o">*</span><span class="p">)</span><span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Browse the queue starting from index */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">LPFC_QUE_ACC_BROWSE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">que_browse</span><span class="p">;</span>

	<span class="cm">/* Read a single entry from the queue */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_queacc_read_qe</span><span class="p">(</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pque</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

<span class="nl">que_browse:</span>

	<span class="cm">/* Browse all entries from the queue */</span>
	<span class="n">last_index</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">last_index</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">LPFC_QUE_ACC_SIZE</span> <span class="o">-</span> <span class="n">pque</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_queacc_read_qe</span><span class="p">(</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pque</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">pque</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up the offset for next portion of pci cfg read */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">pque</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_queacc_write - Syntax check and set up idiag queacc commands</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the user data from.</span>
<span class="cm"> * @nbytes: The number of bytes to get.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine get the debugfs idiag command struct from user space and then</span>
<span class="cm"> * perform the syntax check for port queue read (dump) or write (set) command</span>
<span class="cm"> * accordingly. In the case of port queue read command, it sets up the command</span>
<span class="cm"> * in the idiag command struct for the following debugfs read operation. In</span>
<span class="cm"> * the case of port queue write operation, it executes the write operation</span>
<span class="cm"> * into the port queue entry accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * It returns the @nbytges passing in from debugfs user space when successful.</span>
<span class="cm"> * In case of error conditions, it returns proper error code back to the user</span>
<span class="cm"> * space.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_queacc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">qidx</span><span class="p">,</span> <span class="n">quetp</span><span class="p">,</span> <span class="n">queid</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">pentry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_queue</span> <span class="o">*</span><span class="n">pque</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* This is a user write operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_WR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_cmd_get</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Get and sanity check on command feilds */</span>
	<span class="n">quetp</span>  <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_QUEACC_QUETP_INDX</span><span class="p">];</span>
	<span class="n">queid</span>  <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_QUEACC_QUEID_INDX</span><span class="p">];</span>
	<span class="n">index</span>  <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_QUEACC_INDEX_INDX</span><span class="p">];</span>
	<span class="n">count</span>  <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_QUEACC_COUNT_INDX</span><span class="p">];</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_QUEACC_OFFST_INDX</span><span class="p">];</span>
	<span class="n">value</span>  <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_QUEACC_VALUE_INDX</span><span class="p">];</span>

	<span class="cm">/* Sanity check on command line arguments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_WR</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_ST</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_CL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_QUE_ACC_WR_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_QUE_ACC_RD_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">quetp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LPFC_IDIAG_EQ</span>:
		<span class="cm">/* Slow-path event queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span> <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sanity check */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sp_eq</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Fast-path event queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">qidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qidx</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_fcp_eq_count</span><span class="p">;</span> <span class="n">qidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">qidx</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span>
				    <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Sanity check */</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
						<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">qidx</span><span class="p">],</span>
						<span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
					<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span>
						<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fp_eq</span><span class="p">[</span><span class="n">qidx</span><span class="p">];</span>
					<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_IDIAG_CQ</span>:
		<span class="cm">/* MBX complete queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span> <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sanity check */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_cq</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* ELS complete queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span> <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sanity check */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_cq</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* FCP complete queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">qidx</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span>
				    <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Sanity check */</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
						<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">qidx</span><span class="p">],</span>
						<span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
					<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span>
						<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_cq</span><span class="p">[</span><span class="n">qidx</span><span class="p">];</span>
					<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">qidx</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_fcp_eq_count</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_IDIAG_MQ</span>:
		<span class="cm">/* MBX work queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span> <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sanity check */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">mbx_wq</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_IDIAG_WQ</span>:
		<span class="cm">/* ELS work queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span> <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sanity check */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">els_wq</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* FCP work queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">qidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qidx</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_fcp_wq_count</span><span class="p">;</span> <span class="n">qidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">qidx</span><span class="p">])</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">qidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span>
				    <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Sanity check */</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
						<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">qidx</span><span class="p">],</span>
						<span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
					<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span>
						<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">fcp_wq</span><span class="p">[</span><span class="n">qidx</span><span class="p">];</span>
					<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_IDIAG_RQ</span>:
		<span class="cm">/* HDR queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span> <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sanity check */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">hdr_rq</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* DAT queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">==</span> <span class="n">queid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sanity check */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_que_param_check</span><span class="p">(</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">dat_rq</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pass_check</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">pass_check:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">LPFC_QUE_ACC_BROWSE</span><span class="p">)</span>
			<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_WR</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_ST</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_CL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Additional sanity checks on write operation */</span>
		<span class="n">pque</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_queue</span> <span class="o">*</span><span class="p">)</span><span class="n">idiag</span><span class="p">.</span><span class="n">ptr_private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">pque</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="n">pentry</span> <span class="o">=</span> <span class="n">pque</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
		<span class="n">pentry</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_WR</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pentry</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_ST</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pentry</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_QUEACC_CL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">pentry</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>

<span class="nl">error_out:</span>
	<span class="cm">/* Clean out command structure on command error out */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_drbacc_read_reg - idiag debugfs read a doorbell register</span>
<span class="cm"> * @phba: The pointer to hba structure.</span>
<span class="cm"> * @pbuffer: The pointer to the buffer to copy the data to.</span>
<span class="cm"> * @len: The lenght of bytes to copied.</span>
<span class="cm"> * @drbregid: The id to doorbell registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads a doorbell register and copies its content to the</span>
<span class="cm"> * user buffer pointed to by @pbuffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was copied into @pbuffer.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_drbacc_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">drbregid</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">drbregid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LPFC_DRB_EQCQ</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_DRB_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;EQCQ-DRB-REG: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">EQCQDBregaddr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_DRB_MQ</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_DRB_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;MQ-DRB-REG:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">MQDBregaddr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_DRB_WQ</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_DRB_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;WQ-DRB-REG:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">WQDBregaddr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_DRB_RQ</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_DRB_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;RQ-DRB-REG:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">RQDBregaddr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_drbacc_read - idiag debugfs read port doorbell</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the data to.</span>
<span class="cm"> * @nbytes: The number of bytes to read.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads data from the @phba device doorbell register according</span>
<span class="cm"> * to the idiag command, and copies to user @buf. Depending on the doorbell</span>
<span class="cm"> * register read command setup, it does either a single doorbell register</span>
<span class="cm"> * read or dump all doorbell registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_drbacc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
		       <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">drb_reg_id</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is a user read operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_RD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_DRB_ACC_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbuffer</span> <span class="o">=</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_RD</span><span class="p">)</span>
		<span class="n">drb_reg_id</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_DRBACC_REGID_INDX</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drb_reg_id</span> <span class="o">==</span> <span class="n">LPFC_DRB_ACC_ALL</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">LPFC_DRB_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_drbacc_read_reg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
							 <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_drbacc_read_reg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
						 <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">drb_reg_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_drbacc_write - Syntax check and set up idiag drbacc commands</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the user data from.</span>
<span class="cm"> * @nbytes: The number of bytes to get.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine get the debugfs idiag command struct from user space and then</span>
<span class="cm"> * perform the syntax check for port doorbell register read (dump) or write</span>
<span class="cm"> * (set) command accordingly. In the case of port queue read command, it sets</span>
<span class="cm"> * up the command in the idiag command struct for the following debugfs read</span>
<span class="cm"> * operation. In the case of port doorbell register write operation, it</span>
<span class="cm"> * executes the write operation into the port doorbell register accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * It returns the @nbytges passing in from debugfs user space when successful.</span>
<span class="cm"> * In case of error conditions, it returns proper error code back to the user</span>
<span class="cm"> * space.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_drbacc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">drb_reg_id</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">reg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">drb_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* This is a user write operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_WR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_cmd_get</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Sanity check on command line arguments */</span>
	<span class="n">drb_reg_id</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_DRBACC_REGID_INDX</span><span class="p">];</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_DRBACC_VALUE_INDX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_WR</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_ST</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_CL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_DRB_ACC_WR_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drb_reg_id</span> <span class="o">&gt;</span> <span class="n">LPFC_DRB_MAX</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_DRB_ACC_RD_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">drb_reg_id</span> <span class="o">&gt;</span> <span class="n">LPFC_DRB_MAX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">drb_reg_id</span> <span class="o">!=</span> <span class="n">LPFC_DRB_ACC_ALL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="cm">/* Perform the write access operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_WR</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_ST</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_CL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">drb_reg_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LPFC_DRB_EQCQ</span>:
			<span class="n">drb_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">EQCQDBregaddr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_DRB_MQ</span>:
			<span class="n">drb_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">MQDBregaddr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_DRB_WQ</span>:
			<span class="n">drb_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">WQDBregaddr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_DRB_RQ</span>:
			<span class="n">drb_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">RQDBregaddr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_WR</span><span class="p">)</span>
			<span class="n">reg_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">drb_reg</span><span class="p">);</span>
			<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_DRBACC_CL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">drb_reg</span><span class="p">);</span>
			<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">drb_reg</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">drb_reg</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>

<span class="nl">error_out:</span>
	<span class="cm">/* Clean out command structure on command error out */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_ctlacc_read_reg - idiag debugfs read a control registers</span>
<span class="cm"> * @phba: The pointer to hba structure.</span>
<span class="cm"> * @pbuffer: The pointer to the buffer to copy the data to.</span>
<span class="cm"> * @len: The lenght of bytes to copied.</span>
<span class="cm"> * @drbregid: The id to doorbell registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads a control register and copies its content to the</span>
<span class="cm"> * user buffer pointed to by @pbuffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was copied into @pbuffer.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_ctlacc_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ctlregid</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctlregid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LPFC_CTL_PORT_SEM</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_CTL_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Port SemReg:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
				      <span class="n">LPFC_CTL_PORT_SEM_OFFSET</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_CTL_PORT_STA</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_CTL_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Port StaReg:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
				      <span class="n">LPFC_CTL_PORT_STA_OFFSET</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_CTL_PORT_CTL</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_CTL_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Port CtlReg:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
				      <span class="n">LPFC_CTL_PORT_CTL_OFFSET</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_CTL_PORT_ER1</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_CTL_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Port Er1Reg:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
				      <span class="n">LPFC_CTL_PORT_ER1_OFFSET</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_CTL_PORT_ER2</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_CTL_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Port Er2Reg:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
				      <span class="n">LPFC_CTL_PORT_ER2_OFFSET</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_CTL_PDEV_CTL</span>:
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_CTL_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;PDev CtlReg:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
				      <span class="n">LPFC_CTL_PDEV_CTL_OFFSET</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_ctlacc_read - idiag debugfs read port and device control register</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the data to.</span>
<span class="cm"> * @nbytes: The number of bytes to read.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads data from the @phba port and device registers according</span>
<span class="cm"> * to the idiag command, and copies to user @buf.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_ctlacc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
		       <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ctl_reg_id</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is a user read operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_RD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_CTL_ACC_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbuffer</span> <span class="o">=</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_RD</span><span class="p">)</span>
		<span class="n">ctl_reg_id</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_CTLACC_REGID_INDX</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl_reg_id</span> <span class="o">==</span> <span class="n">LPFC_CTL_ACC_ALL</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">LPFC_CTL_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_ctlacc_read_reg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
							 <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_ctlacc_read_reg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
						 <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ctl_reg_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_ctlacc_write - Syntax check and set up idiag ctlacc commands</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the user data from.</span>
<span class="cm"> * @nbytes: The number of bytes to get.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine get the debugfs idiag command struct from user space and then</span>
<span class="cm"> * perform the syntax check for port and device control register read (dump)</span>
<span class="cm"> * or write (set) command accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * It returns the @nbytges passing in from debugfs user space when successful.</span>
<span class="cm"> * In case of error conditions, it returns proper error code back to the user</span>
<span class="cm"> * space.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_ctlacc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ctl_reg_id</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">reg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ctl_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* This is a user write operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_WR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_cmd_get</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Sanity check on command line arguments */</span>
	<span class="n">ctl_reg_id</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_CTLACC_REGID_INDX</span><span class="p">];</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_CTLACC_VALUE_INDX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_WR</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_ST</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_CL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_CTL_ACC_WR_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctl_reg_id</span> <span class="o">&gt;</span> <span class="n">LPFC_CTL_MAX</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_CTL_ACC_RD_CMD_ARG</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctl_reg_id</span> <span class="o">&gt;</span> <span class="n">LPFC_CTL_MAX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ctl_reg_id</span> <span class="o">!=</span> <span class="n">LPFC_CTL_ACC_ALL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="cm">/* Perform the write access operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_WR</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_ST</span> <span class="o">||</span>
	    <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_CL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctl_reg_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LPFC_CTL_PORT_SEM</span>:
			<span class="n">ctl_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
					<span class="n">LPFC_CTL_PORT_SEM_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_CTL_PORT_STA</span>:
			<span class="n">ctl_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
					<span class="n">LPFC_CTL_PORT_STA_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_CTL_PORT_CTL</span>:
			<span class="n">ctl_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
					<span class="n">LPFC_CTL_PORT_CTL_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_CTL_PORT_ER1</span>:
			<span class="n">ctl_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
					<span class="n">LPFC_CTL_PORT_ER1_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_CTL_PORT_ER2</span>:
			<span class="n">ctl_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
					<span class="n">LPFC_CTL_PORT_ER2_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPFC_CTL_PDEV_CTL</span>:
			<span class="n">ctl_reg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">conf_regs_memmap_p</span> <span class="o">+</span>
					<span class="n">LPFC_CTL_PDEV_CTL_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_WR</span><span class="p">)</span>
			<span class="n">reg_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctl_reg</span><span class="p">);</span>
			<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_CTLACC_CL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctl_reg</span><span class="p">);</span>
			<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">ctl_reg</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">ctl_reg</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>

<span class="nl">error_out:</span>
	<span class="cm">/* Clean out command structure on command error out */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_mbxacc_get_setup - idiag debugfs get mailbox access setup</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @pbuffer: Pointer to data buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine gets the driver mailbox access debugfs setup information.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_mbxacc_get_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbx_dump_map</span><span class="p">,</span> <span class="n">mbx_dump_cnt</span><span class="p">,</span> <span class="n">mbx_word_cnt</span><span class="p">,</span> <span class="n">mbx_mbox_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mbx_mbox_cmd</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_MBCMD_INDX</span><span class="p">];</span>
	<span class="n">mbx_dump_map</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_DPMAP_INDX</span><span class="p">];</span>
	<span class="n">mbx_dump_cnt</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_DPCNT_INDX</span><span class="p">];</span>
	<span class="n">mbx_word_cnt</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_WDCNT_INDX</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_MBX_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;mbx_dump_map: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbx_dump_map</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_MBX_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;mbx_dump_cnt: %04d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbx_dump_cnt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_MBX_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;mbx_word_cnt: %04d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbx_word_cnt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_MBX_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;mbx_mbox_cmd: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbx_mbox_cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_mbxacc_read - idiag debugfs read on mailbox access</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the data to.</span>
<span class="cm"> * @nbytes: The number of bytes to read.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads data from the @phba driver mailbox access debugfs setup</span>
<span class="cm"> * information.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_mbxacc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
		       <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is a user read operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_RD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_MBX_ACC_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbuffer</span> <span class="o">=</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">LPFC_IDIAG_CMD_MBXACC_DP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">LPFC_IDIAG_BSG_MBXACC_DP</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_mbxacc_get_setup</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_mbxacc_write - Syntax check and set up idiag mbxacc commands</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the user data from.</span>
<span class="cm"> * @nbytes: The number of bytes to get.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine get the debugfs idiag command struct from user space and then</span>
<span class="cm"> * perform the syntax check for driver mailbox command (dump) and sets up the</span>
<span class="cm"> * necessary states in the idiag command struct accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * It returns the @nbytges passing in from debugfs user space when successful.</span>
<span class="cm"> * In case of error conditions, it returns proper error code back to the user</span>
<span class="cm"> * space.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_mbxacc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbx_dump_map</span><span class="p">,</span> <span class="n">mbx_dump_cnt</span><span class="p">,</span> <span class="n">mbx_word_cnt</span><span class="p">,</span> <span class="n">mbx_mbox_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* This is a user write operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_WR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_cmd_get</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Sanity check on command line arguments */</span>
	<span class="n">mbx_mbox_cmd</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_MBCMD_INDX</span><span class="p">];</span>
	<span class="n">mbx_dump_map</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_DPMAP_INDX</span><span class="p">];</span>
	<span class="n">mbx_dump_cnt</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_DPCNT_INDX</span><span class="p">];</span>
	<span class="n">mbx_word_cnt</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_WDCNT_INDX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_CMD_MBXACC_DP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_MBX_DMP_MBX_ALL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LPFC_MBX_DMP_MBX_ALL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mbx_dump_map</span> <span class="o">!=</span> <span class="n">LPFC_MBX_DMP_ALL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbx_word_cnt</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">LPFC_IDIAG_BSG_MBXACC_DP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_BSG_DMP_MBX_ALL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LPFC_BSG_DMP_MBX_ALL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mbx_dump_map</span> <span class="o">!=</span> <span class="n">LPFC_MBX_DMP_ALL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbx_word_cnt</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">BSG_MBOX_SIZE</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbx_mbox_cmd</span> <span class="o">!=</span> <span class="mh">0x9b</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mbx_word_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_MBX_DMP_ARG</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbx_mbox_cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="cm">/* condition for stop mailbox dump */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbx_dump_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reset_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>

<span class="nl">reset_out:</span>
	<span class="cm">/* Clean out command structure on command error out */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>

<span class="nl">error_out:</span>
	<span class="cm">/* Clean out command structure on command error out */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_extacc_avail_get - get the available extents information</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pbuffer: pointer to internal buffer.</span>
<span class="cm"> * @len: length into the internal buffer data has been copied.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is to get the available extent information.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * overall lenth of the data read into the internal buffer.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_extacc_avail_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">Available Extents Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">Port Available VPI extents: &quot;</span><span class="p">);</span>
	<span class="n">lpfc_sli4_get_avail_extnt_rsrc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_RSC_TYPE_FCOE_VPI</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">ext_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_size</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Count %3d, Size %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">Port Available VFI extents: &quot;</span><span class="p">);</span>
	<span class="n">lpfc_sli4_get_avail_extnt_rsrc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_RSC_TYPE_FCOE_VFI</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">ext_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_size</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Count %3d, Size %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">Port Available RPI extents: &quot;</span><span class="p">);</span>
	<span class="n">lpfc_sli4_get_avail_extnt_rsrc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_RSC_TYPE_FCOE_RPI</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">ext_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_size</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Count %3d, Size %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">Port Available XRI extents: &quot;</span><span class="p">);</span>
	<span class="n">lpfc_sli4_get_avail_extnt_rsrc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_RSC_TYPE_FCOE_XRI</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">ext_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_size</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;Count %3d, Size %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_extacc_alloc_get - get the allocated extents information</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pbuffer: pointer to internal buffer.</span>
<span class="cm"> * @len: length into the internal buffer data has been copied.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is to get the allocated extent information.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * overall lenth of the data read into the internal buffer.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_extacc_alloc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">Allocated Extents Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">Host Allocated VPI extents: &quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_get_allocated_extnts</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_RSC_TYPE_FCOE_VPI</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ext_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Port %d Extent %3d, Size %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">brd_no</span><span class="p">,</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;N/A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">Host Allocated VFI extents: &quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_get_allocated_extnts</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_RSC_TYPE_FCOE_VFI</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ext_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Port %d Extent %3d, Size %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">brd_no</span><span class="p">,</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;N/A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">Host Allocated RPI extents: &quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_get_allocated_extnts</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_RSC_TYPE_FCOE_RPI</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ext_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Port %d Extent %3d, Size %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">brd_no</span><span class="p">,</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;N/A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">Host Allocated XRI extents: &quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_get_allocated_extnts</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_RSC_TYPE_FCOE_XRI</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ext_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;Port %d Extent %3d, Size %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">brd_no</span><span class="p">,</span> <span class="n">ext_cnt</span><span class="p">,</span> <span class="n">ext_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;N/A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_extacc_drivr_get - get driver extent information</span>
<span class="cm"> * @phba: pointer to lpfc hba data structure.</span>
<span class="cm"> * @pbuffer: pointer to internal buffer.</span>
<span class="cm"> * @len: length into the internal buffer data has been copied.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine is to get the driver extent information.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * overall lenth of the data read into the internal buffer.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_idiag_extacc_drivr_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_rsrc_blks</span> <span class="o">*</span><span class="n">rsrc_blks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">Driver Extents Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">VPI extents:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rsrc_blks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_vpi_blk_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Block %3d: Start %4d, Count %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">index</span><span class="p">,</span> <span class="n">rsrc_blks</span><span class="o">-&gt;</span><span class="n">rsrc_start</span><span class="p">,</span>
				<span class="n">rsrc_blks</span><span class="o">-&gt;</span><span class="n">rsrc_size</span><span class="p">);</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">VFI extents:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rsrc_blks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lpfc_vfi_blk_list</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Block %3d: Start %4d, Count %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">index</span><span class="p">,</span> <span class="n">rsrc_blks</span><span class="o">-&gt;</span><span class="n">rsrc_start</span><span class="p">,</span>
				<span class="n">rsrc_blks</span><span class="o">-&gt;</span><span class="n">rsrc_size</span><span class="p">);</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">RPI extents:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rsrc_blks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lpfc_rpi_blk_list</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Block %3d: Start %4d, Count %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">index</span><span class="p">,</span> <span class="n">rsrc_blks</span><span class="o">-&gt;</span><span class="n">rsrc_start</span><span class="p">,</span>
				<span class="n">rsrc_blks</span><span class="o">-&gt;</span><span class="n">rsrc_size</span><span class="p">);</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">XRI extents:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rsrc_blks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lpfc_xri_blk_list</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">pbuffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Block %3d: Start %4d, Count %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">index</span><span class="p">,</span> <span class="n">rsrc_blks</span><span class="o">-&gt;</span><span class="n">rsrc_start</span><span class="p">,</span>
				<span class="n">rsrc_blks</span><span class="o">-&gt;</span><span class="n">rsrc_size</span><span class="p">);</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_extacc_write - Syntax check and set up idiag extacc commands</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the user data from.</span>
<span class="cm"> * @nbytes: The number of bytes to get.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine get the debugfs idiag command struct from user space and then</span>
<span class="cm"> * perform the syntax check for extent information access commands and sets</span>
<span class="cm"> * up the necessary states in the idiag command struct accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * It returns the @nbytges passing in from debugfs user space when successful.</span>
<span class="cm"> * In case of error conditions, it returns proper error code back to the user</span>
<span class="cm"> * space.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_extacc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ext_map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* This is a user write operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_WR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_idiag_cmd_get</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ext_map</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_EXTACC_EXMAP_INDX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">LPFC_IDIAG_CMD_EXTACC_RD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">LPFC_EXT_ACC_CMD_ARG</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ext_map</span> <span class="o">&amp;</span> <span class="n">LPFC_EXT_ACC_ALL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="nl">error_out:</span>
	<span class="cm">/* Clean out command structure on command error out */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_idiag_extacc_read - idiag debugfs read access to extent information</span>
<span class="cm"> * @file: The file pointer to read from.</span>
<span class="cm"> * @buf: The buffer to copy the data to.</span>
<span class="cm"> * @nbytes: The number of bytes to read.</span>
<span class="cm"> * @ppos: The position in the file to start reading from.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine reads data from the proper extent information according to</span>
<span class="cm"> * the idiag command, and copies to user @buf.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> * This function returns the amount of data that was read (this could be less</span>
<span class="cm"> * than @nbytes if the end of the file was reached) or a negative error value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">lpfc_idiag_extacc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span>
		       <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_debug</span> <span class="o">*</span><span class="n">debug</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ext_map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is a user read operation */</span>
	<span class="n">debug</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">LPFC_IDIAG_OP_RD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">LPFC_EXT_ACC_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pbuffer</span> <span class="o">=</span> <span class="n">debug</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">LPFC_IDIAG_CMD_EXTACC_RD</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ext_map</span> <span class="o">=</span> <span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_EXTACC_EXMAP_INDX</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_map</span> <span class="o">&amp;</span> <span class="n">LPFC_EXT_ACC_AVAIL</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_extacc_avail_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_map</span> <span class="o">&amp;</span> <span class="n">LPFC_EXT_ACC_ALLOC</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_extacc_alloc_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_map</span> <span class="o">&amp;</span> <span class="n">LPFC_EXT_ACC_DRIVR</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">lpfc_idiag_extacc_drivr_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#undef lpfc_debugfs_op_disc_trc</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_debugfs_op_disc_trc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_disc_trc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_debugfs_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_debugfs_op_nodelist</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_debugfs_op_nodelist</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_nodelist_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_debugfs_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_debugfs_op_hbqinfo</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_debugfs_op_hbqinfo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_hbqinfo_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_debugfs_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_debugfs_op_dumpHBASlim</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_debugfs_op_dumpHBASlim</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_dumpHBASlim_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_debugfs_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_debugfs_op_dumpHostSlim</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_debugfs_op_dumpHostSlim</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_dumpHostSlim_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_debugfs_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_debugfs_op_dumpData</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_debugfs_op_dumpData</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_dumpData_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">lpfc_debugfs_dumpDataDif_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_debugfs_dumpDataDif_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_debugfs_op_dumpDif</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_debugfs_op_dumpDif</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_dumpDif_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">lpfc_debugfs_dumpDataDif_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_debugfs_dumpDataDif_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_debugfs_op_dif_err</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_debugfs_op_dif_err</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">lpfc_debugfs_dif_err_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">lpfc_debugfs_dif_err_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">lpfc_debugfs_dif_err_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_debugfs_op_slow_ring_trc</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_debugfs_op_slow_ring_trc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_slow_ring_trc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_debugfs_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_debugfs_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">lpfc_debugfs_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">lpfc_debugfs_hba_count</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * File operations for the iDiag debugfs</span>
<span class="cm"> */</span>
<span class="cp">#undef lpfc_idiag_op_pciCfg</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_idiag_op_pciCfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_idiag_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_idiag_pcicfg_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>        <span class="n">lpfc_idiag_pcicfg_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_idiag_cmd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_idiag_op_barAcc</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_idiag_op_barAcc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_idiag_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_idiag_baracc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>        <span class="n">lpfc_idiag_baracc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_idiag_cmd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_idiag_op_queInfo</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_idiag_op_queInfo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_idiag_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_idiag_queinfo_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_idiag_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_idiag_op_queAcc</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_idiag_op_queAcc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_idiag_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_idiag_queacc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>        <span class="n">lpfc_idiag_queacc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_idiag_cmd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_idiag_op_drbAcc</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_idiag_op_drbAcc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_idiag_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_idiag_drbacc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>        <span class="n">lpfc_idiag_drbacc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_idiag_cmd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_idiag_op_ctlAcc</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_idiag_op_ctlAcc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_idiag_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_idiag_ctlacc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>        <span class="n">lpfc_idiag_ctlacc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_idiag_cmd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_idiag_op_mbxAcc</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_idiag_op_mbxAcc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_idiag_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_idiag_mbxacc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>        <span class="n">lpfc_idiag_mbxacc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_idiag_cmd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#undef lpfc_idiag_op_extAcc</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lpfc_idiag_op_extAcc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">lpfc_idiag_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>       <span class="n">lpfc_debugfs_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>         <span class="n">lpfc_idiag_extacc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>        <span class="n">lpfc_idiag_extacc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>      <span class="n">lpfc_idiag_cmd_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="cm">/* lpfc_idiag_mbxacc_dump_bsg_mbox - idiag debugfs dump bsg mailbox command</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @dmabuf: Pointer to a DMA buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine dump a bsg pass-through non-embedded mailbox command with</span>
<span class="cm"> * external buffer.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_idiag_mbxacc_dump_bsg_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nemb_type</span> <span class="n">nemb_tp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">mbox_type</span> <span class="n">mbox_tp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dma_type</span> <span class="n">dma_tp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">sta_type</span> <span class="n">sta_tp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ext_buf</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_LPFC_DEBUG_FS</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbx_mbox_cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">mbx_dump_map</span><span class="p">,</span> <span class="o">*</span><span class="n">mbx_dump_cnt</span><span class="p">,</span> <span class="o">*</span><span class="n">mbx_word_cnt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">line_buf</span><span class="p">[</span><span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">do_dump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">pword</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">LPFC_IDIAG_BSG_MBXACC_DP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mbx_mbox_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_MBCMD_INDX</span><span class="p">];</span>
	<span class="n">mbx_dump_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_DPMAP_INDX</span><span class="p">];</span>
	<span class="n">mbx_dump_cnt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_DPCNT_INDX</span><span class="p">];</span>
	<span class="n">mbx_word_cnt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_WDCNT_INDX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_MBX_DMP_ALL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">mbx_word_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mbx_mbox_cmd</span> <span class="o">!=</span> <span class="mh">0x9B</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mbox_tp</span> <span class="o">==</span> <span class="n">mbox_rd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dma_tp</span> <span class="o">==</span> <span class="n">dma_mbox</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_BSG_DMP_MBX_RD_MBX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_dump</span> <span class="o">|=</span> <span class="n">LPFC_BSG_DMP_MBX_RD_MBX</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Read mbox command (x%x), &quot;</span>
			       <span class="s">&quot;nemb:0x%x, extbuf_cnt:%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sta_tp</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="n">ext_buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mbox_tp</span> <span class="o">==</span> <span class="n">mbox_rd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dma_tp</span> <span class="o">==</span> <span class="n">dma_ebuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_BSG_DMP_MBX_RD_BUF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_dump</span> <span class="o">|=</span> <span class="n">LPFC_BSG_DMP_MBX_RD_BUF</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Read mbox buffer (x%x), &quot;</span>
			       <span class="s">&quot;nemb:0x%x, extbuf_seq:%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sta_tp</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="n">ext_buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mbox_tp</span> <span class="o">==</span> <span class="n">mbox_wr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dma_tp</span> <span class="o">==</span> <span class="n">dma_mbox</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_BSG_DMP_MBX_WR_MBX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_dump</span> <span class="o">|=</span> <span class="n">LPFC_BSG_DMP_MBX_WR_MBX</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Write mbox command (x%x), &quot;</span>
			       <span class="s">&quot;nemb:0x%x, extbuf_cnt:%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sta_tp</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="n">ext_buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mbox_tp</span> <span class="o">==</span> <span class="n">mbox_wr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dma_tp</span> <span class="o">==</span> <span class="n">dma_ebuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_BSG_DMP_MBX_WR_BUF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_dump</span> <span class="o">|=</span> <span class="n">LPFC_BSG_DMP_MBX_WR_BUF</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Write mbox buffer (x%x), &quot;</span>
			       <span class="s">&quot;nemb:0x%x, extbuf_seq:%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sta_tp</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="n">ext_buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* dump buffer content */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pword</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">mbx_word_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line_buf</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">line_buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
						<span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
						<span class="s">&quot;%03d: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">line_buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
					<span class="s">&quot;%08x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">*</span><span class="n">pword</span><span class="p">);</span>
			<span class="n">pword</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line_buf</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_cnt</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clean out command structure on reaching dump count */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* lpfc_idiag_mbxacc_dump_issue_mbox - idiag debugfs dump issue mailbox command</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @dmabuf: Pointer to a DMA buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This routine dump a pass-through non-embedded mailbox command from issue</span>
<span class="cm"> * mailbox command.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_idiag_mbxacc_dump_issue_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">pmbox</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_LPFC_DEBUG_FS</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbx_dump_map</span><span class="p">,</span> <span class="o">*</span><span class="n">mbx_dump_cnt</span><span class="p">,</span> <span class="o">*</span><span class="n">mbx_word_cnt</span><span class="p">,</span> <span class="o">*</span><span class="n">mbx_mbox_cmd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">line_buf</span><span class="p">[</span><span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">pword</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pbyte</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">LPFC_IDIAG_CMD_MBXACC_DP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mbx_mbox_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_MBCMD_INDX</span><span class="p">];</span>
	<span class="n">mbx_dump_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_DPMAP_INDX</span><span class="p">];</span>
	<span class="n">mbx_dump_cnt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_DPCNT_INDX</span><span class="p">];</span>
	<span class="n">mbx_word_cnt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idiag</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">IDIAG_MBXACC_WDCNT_INDX</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_MBX_DMP_MBX_ALL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">mbx_word_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">mbx_mbox_cmd</span> <span class="o">!=</span> <span class="n">LPFC_MBX_ALL_CMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">mbx_mbox_cmd</span> <span class="o">!=</span> <span class="n">pmbox</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* dump buffer content */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_MBX_DMP_MBX_WORD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Mailbox command:0x%x dump by word:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pmbox</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">);</span>
		<span class="n">pword</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pmbox</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">mbx_word_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line_buf</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">line_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">line_buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
						<span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
						<span class="s">&quot;%03d: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">line_buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
					<span class="s">&quot;%08x &quot;</span><span class="p">,</span>
					<span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">*</span><span class="n">pword</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">pword</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line_buf</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_map</span> <span class="o">&amp;</span> <span class="n">LPFC_MBX_DMP_MBX_BYTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Mailbox command:0x%x dump by byte:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pmbox</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">);</span>
		<span class="n">pbyte</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pmbox</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">mbx_word_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line_buf</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">line_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">line_buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
						<span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
						<span class="s">&quot;%03d: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">line_buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
						<span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="o">-</span><span class="n">len</span><span class="p">,</span>
						<span class="s">&quot;%02x&quot;</span><span class="p">,</span>
						<span class="p">((</span><span class="kt">uint8_t</span><span class="p">)</span><span class="o">*</span><span class="n">pbyte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
				<span class="n">pbyte</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">line_buf</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					<span class="n">LPFC_MBX_ACC_LBUF_SZ</span><span class="o">-</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line_buf</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_cnt</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* Clean out command structure on reaching dump count */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mbx_dump_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_initialize - Initialize debugfs for a vport</span>
<span class="cm"> * @vport: The vport pointer to initialize.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * When Debugfs is configured this routine sets up the lpfc debugfs file system.</span>
<span class="cm"> * If not already created, this routine will create the lpfc directory, and</span>
<span class="cm"> * lpfcX directory (for this HBA), and vportX directory for this vport. It will</span>
<span class="cm"> * also create each file used to access lpfc specific debugfs information.</span>
<span class="cm"> **/</span>
<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lpfc_debugfs_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_LPFC_DEBUG_FS</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">num</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_debugfs_enable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Setup lpfc root directory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_debugfs_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;lpfc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpfc_debugfs_hba_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;0408 Cannot create debugfs root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_debugfs_start_time</span><span class="p">)</span>
		<span class="n">lpfc_debugfs_start_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Setup funcX directory for specific HBA PCI function */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;fn%d&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">brd_no</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span> <span class="o">=</span>
			<span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lpfc_debugfs_root</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;0412 Cannot create debugfs hba</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpfc_debugfs_hba_count</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debugfs_vport_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Setup hbqinfo */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;hbqinfo&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_hbqinfo</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
				 <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_hbqinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_hbqinfo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0411 Cannot create debugfs hbqinfo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Setup dumpHBASlim */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;dumpHBASlim&quot;</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHBASlim</span> <span class="o">=</span>
				<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
					<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
					<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dumpHBASlim</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHBASlim</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
						 <span class="s">&quot;0413 Cannot create debugfs &quot;</span>
						<span class="s">&quot;dumpHBASlim</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHBASlim</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Setup dumpHostSlim */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;dumpHostSlim&quot;</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHostSlim</span> <span class="o">=</span>
				<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
					<span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
					<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dumpHostSlim</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHostSlim</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
						 <span class="s">&quot;0414 Cannot create debugfs &quot;</span>
						 <span class="s">&quot;dumpHostSlim</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHBASlim</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Setup dumpData */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;dumpData&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpData</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
				 <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dumpData</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpData</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0800 Cannot create debugfs dumpData</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Setup dumpDif */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;dumpDif&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpDif</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
				 <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dumpDif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpDif</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0801 Cannot create debugfs dumpDif</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Setup DIF Error Injections */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;InjErrLBA&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrLBA</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
			<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dif_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrLBA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0807 Cannot create debugfs InjErrLBA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">lpfc_injerr_lba</span> <span class="o">=</span> <span class="n">LPFC_INJERR_LBA_OFF</span><span class="p">;</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;InjErrNPortID&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrNPortID</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
			<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dif_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrNPortID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0809 Cannot create debugfs InjErrNPortID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;InjErrWWPN&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrWWPN</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
			<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dif_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrWWPN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0810 Cannot create debugfs InjErrWWPN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;writeGuardInjErr&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeGuard</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
			<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dif_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeGuard</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0802 Cannot create debugfs writeGuard</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;writeAppInjErr&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeApp</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
			<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dif_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeApp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0803 Cannot create debugfs writeApp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;writeRefInjErr&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeRef</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
			<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dif_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeRef</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0804 Cannot create debugfs writeRef</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;readGuardInjErr&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readGuard</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
			<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dif_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readGuard</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0808 Cannot create debugfs readGuard</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;readAppInjErr&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readApp</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
			<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dif_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readApp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0805 Cannot create debugfs readApp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;readRefInjErr&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readRef</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
			<span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_dif_err</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readRef</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				<span class="s">&quot;0806 Cannot create debugfs readApp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Setup slow ring trace */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num</span> <span class="o">=</span> <span class="n">lpfc_debugfs_max_slow_ring_trc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&amp;</span> <span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Change to be a power of 2 */</span>
				<span class="n">num</span> <span class="o">=</span> <span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">lpfc_debugfs_max_slow_ring_trc</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;lpfc_debugfs_max_disc_trc changed to &quot;</span>
				       <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;slow_ring_trace&quot;</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_slow_ring_trc</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">,</span>
				 <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_slow_ring_trc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_slow_ring_trc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;0415 Cannot create debugfs &quot;</span>
					 <span class="s">&quot;slow_ring_trace</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span>
				<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_debugfs_trc</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
						 <span class="s">&quot;0416 Cannot create debugfs &quot;</span>
						 <span class="s">&quot;slow_ring buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_debugfs_trc</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">lpfc_debugfs_max_slow_ring_trc</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;vport%d&quot;</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_debugfs_root</span> <span class="o">=</span>
			<span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;0417 Can&#39;t create debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debugfs_vport_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">lpfc_debugfs_max_disc_trc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&amp;</span> <span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Change to be a power of 2 */</span>
			<span class="n">num</span> <span class="o">=</span> <span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">lpfc_debugfs_max_disc_trc</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;lpfc_debugfs_max_disc_trc changed to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_debugfs_trc</span><span class="p">)</span> <span class="o">*</span> <span class="n">lpfc_debugfs_max_disc_trc</span><span class="p">),</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				 <span class="s">&quot;0418 Cannot create debugfs disc trace &quot;</span>
				 <span class="s">&quot;buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;discovery_trace&quot;</span><span class="p">);</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_disc_trc</span> <span class="o">=</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_debugfs_root</span><span class="p">,</span>
				 <span class="n">vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_disc_trc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_disc_trc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				 <span class="s">&quot;0419 Cannot create debugfs &quot;</span>
				 <span class="s">&quot;discovery_trace</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;nodelist&quot;</span><span class="p">);</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_nodelist</span> <span class="o">=</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_debugfs_root</span><span class="p">,</span>
				 <span class="n">vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_debugfs_op_nodelist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_nodelist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
				 <span class="s">&quot;2985 Can&#39;t create debugfs nodelist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * iDiag debugfs root entry points for SLI4 device only</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;iDiag&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span> <span class="o">=</span>
			<span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;2922 Can&#39;t create idiag debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Initialize iDiag data structure */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idiag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idiag</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* iDiag read PCI config space */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;pciCfg&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_pci_cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_pci_cfg</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_idiag_op_pciCfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_pci_cfg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;2923 Can&#39;t create idiag debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* iDiag PCI BAR access */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;barAcc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_bar_acc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_bar_acc</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_idiag_op_barAcc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_bar_acc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					<span class="s">&quot;3056 Can&#39;t create idiag debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idiag</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">last_rd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* iDiag get PCI function queue information */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;queInfo&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_info</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_idiag_op_queInfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;2924 Can&#39;t create idiag debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* iDiag access PCI function queue */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;queAcc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_acc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_acc</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_idiag_op_queAcc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_acc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;2926 Can&#39;t create idiag debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* iDiag access PCI function doorbell registers */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;drbAcc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_drb_acc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_drb_acc</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_idiag_op_drbAcc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_drb_acc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;2927 Can&#39;t create idiag debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* iDiag access PCI function control registers */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;ctlAcc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ctl_acc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ctl_acc</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_idiag_op_ctlAcc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ctl_acc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					 <span class="s">&quot;2981 Can&#39;t create idiag debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* iDiag access mbox commands */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;mbxAcc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_mbx_acc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_mbx_acc</span> <span class="o">=</span>
			<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpfc_idiag_op_mbxAcc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_mbx_acc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
					<span class="s">&quot;2980 Can&#39;t create idiag debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* iDiag extents access commands */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">extents_in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;extAcc&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ext_acc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ext_acc</span> <span class="o">=</span>
				<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
						    <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span>
						    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">lpfc_idiag_op_extAcc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ext_acc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
						<span class="s">&quot;2986 Cant create &quot;</span>
						<span class="s">&quot;idiag debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">debug_failed</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">debug_failed:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debugfs_terminate -  Tear down debugfs infrastructure for this vport</span>
<span class="cm"> * @vport: The vport pointer to remove from debugfs.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * When Debugfs is configured this routine removes debugfs file system elements</span>
<span class="cm"> * that are specific to this vport. It also checks to see if there are any</span>
<span class="cm"> * users left for the debugfs directories associated with the HBA and driver. If</span>
<span class="cm"> * this is the last user of the HBA directory or driver directory then it will</span>
<span class="cm"> * remove those from the debugfs infrastructure as well.</span>
<span class="cm"> **/</span>
<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lpfc_debugfs_terminate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCSI_LPFC_DEBUG_FS</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc</span><span class="p">);</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">disc_trc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_disc_trc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_disc_trc</span><span class="p">);</span> <span class="cm">/* discovery_trace */</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_disc_trc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_nodelist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_nodelist</span><span class="p">);</span> <span class="cm">/* nodelist */</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">debug_nodelist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_debugfs_root</span><span class="p">);</span> <span class="cm">/* vportX */</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_debugfs_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debugfs_vport_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debugfs_vport_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_hbqinfo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_hbqinfo</span><span class="p">);</span> <span class="cm">/* hbqinfo */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_hbqinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHBASlim</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHBASlim</span><span class="p">);</span> <span class="cm">/* HBASlim */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHBASlim</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHostSlim</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHostSlim</span><span class="p">);</span> <span class="cm">/* HostSlim */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpHostSlim</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpData</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpData</span><span class="p">);</span> <span class="cm">/* dumpData */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpDif</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpDif</span><span class="p">);</span> <span class="cm">/* dumpDif */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_dumpDif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrLBA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrLBA</span><span class="p">);</span> <span class="cm">/* InjErrLBA */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrLBA</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrNPortID</span><span class="p">)</span> <span class="p">{</span>	 <span class="cm">/* InjErrNPortID */</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrNPortID</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrNPortID</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrWWPN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrWWPN</span><span class="p">);</span> <span class="cm">/* InjErrWWPN */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_InjErrWWPN</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeGuard</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeGuard</span><span class="p">);</span> <span class="cm">/* writeGuard */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeGuard</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeApp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeApp</span><span class="p">);</span> <span class="cm">/* writeApp */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeApp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeRef</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeRef</span><span class="p">);</span> <span class="cm">/* writeRef */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_writeRef</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readGuard</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readGuard</span><span class="p">);</span> <span class="cm">/* readGuard */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readGuard</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readApp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readApp</span><span class="p">);</span> <span class="cm">/* readApp */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readApp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readRef</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readRef</span><span class="p">);</span> <span class="cm">/* readRef */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_readRef</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">slow_ring_trc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_slow_ring_trc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* slow_ring_trace */</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_slow_ring_trc</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">debug_slow_ring_trc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * iDiag release</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ext_acc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* iDiag extAcc */</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ext_acc</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ext_acc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_mbx_acc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* iDiag mbxAcc */</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_mbx_acc</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_mbx_acc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ctl_acc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* iDiag ctlAcc */</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ctl_acc</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_ctl_acc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_drb_acc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* iDiag drbAcc */</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_drb_acc</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_drb_acc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_acc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* iDiag queAcc */</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_acc</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_acc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_info</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* iDiag queInfo */</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_info</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_que_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_bar_acc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* iDiag barAcc */</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_bar_acc</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_bar_acc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_pci_cfg</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* iDiag pciCfg */</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_pci_cfg</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_pci_cfg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Finally remove the iDiag debugfs root */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* iDiag root */</span>
				<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">idiag_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span><span class="p">);</span> <span class="cm">/* fnX */</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">hba_debugfs_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpfc_debugfs_hba_count</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpfc_debugfs_hba_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">lpfc_debugfs_root</span><span class="p">);</span> <span class="cm">/* lpfc */</span>
			<span class="n">lpfc_debugfs_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Driver debug utility routines outside of debugfs. The debug utility</span>
<span class="cm"> * routines implemented here is intended to be used in the instrumented</span>
<span class="cm"> * debug driver for debugging host or port issues.</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_debug_dump_all_queues - dump all the queues with a hba</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> *</span>
<span class="cm"> * This function dumps entries of all the queues asociated with the @phba.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_debug_dump_all_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fcp_wqidx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dump Work Queues (WQs)</span>
<span class="cm">	 */</span>
	<span class="n">lpfc_debug_dump_mbx_wq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">lpfc_debug_dump_els_wq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fcp_wqidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fcp_wqidx</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_fcp_wq_count</span><span class="p">;</span> <span class="n">fcp_wqidx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lpfc_debug_dump_fcp_wq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">fcp_wqidx</span><span class="p">);</span>

	<span class="n">lpfc_debug_dump_hdr_rq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">lpfc_debug_dump_dat_rq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Dump Complete Queues (CQs)</span>
<span class="cm">	 */</span>
	<span class="n">lpfc_debug_dump_mbx_cq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">lpfc_debug_dump_els_cq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fcp_wqidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fcp_wqidx</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_fcp_wq_count</span><span class="p">;</span> <span class="n">fcp_wqidx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lpfc_debug_dump_fcp_cq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">fcp_wqidx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dump Event Queues (EQs)</span>
<span class="cm">	 */</span>
	<span class="n">lpfc_debug_dump_sp_eq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fcp_wqidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fcp_wqidx</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_fcp_wq_count</span><span class="p">;</span> <span class="n">fcp_wqidx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lpfc_debug_dump_fcp_eq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">fcp_wqidx</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
