<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › lpfc › lpfc_vport.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lpfc_vport.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex Linux Device Driver for         *</span>
<span class="cm"> * Fibre Channel Host Bus Adapters.                                *</span>
<span class="cm"> * Copyright (C) 2004-2008 Emulex.  All rights reserved.           *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> * Portions Copyright (C) 2004-2005 Christoph Hellwig              *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>
<span class="cp">#include &quot;lpfc_hw4.h&quot;</span>
<span class="cp">#include &quot;lpfc_hw.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli4.h&quot;</span>
<span class="cp">#include &quot;lpfc_nl.h&quot;</span>
<span class="cp">#include &quot;lpfc_disc.h&quot;</span>
<span class="cp">#include &quot;lpfc_scsi.h&quot;</span>
<span class="cp">#include &quot;lpfc.h&quot;</span>
<span class="cp">#include &quot;lpfc_logmsg.h&quot;</span>
<span class="cp">#include &quot;lpfc_crtn.h&quot;</span>
<span class="cp">#include &quot;lpfc_version.h&quot;</span>
<span class="cp">#include &quot;lpfc_vport.h&quot;</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lpfc_vport_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">fc_vport_state</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_vport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_vport</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * When the transport defines fc_vport_set state we will replace</span>
<span class="cm">		 * this code with the following line</span>
<span class="cm">		 */</span>
		<span class="cm">/* fc_vport_set_state(fc_vport, new_state); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">!=</span> <span class="n">FC_VPORT_INITIALIZING</span><span class="p">)</span>
			<span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">vport_last_state</span> <span class="o">=</span> <span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">vport_state</span><span class="p">;</span>
		<span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">vport_state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for all the error states we will set the invternal state to FAILED */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_VPORT_NO_FABRIC_SUPP</span>:
	<span class="k">case</span> <span class="n">FC_VPORT_NO_FABRIC_RSCS</span>:
	<span class="k">case</span> <span class="n">FC_VPORT_FABRIC_LOGOUT</span>:
	<span class="k">case</span> <span class="n">FC_VPORT_FABRIC_REJ_WWN</span>:
	<span class="k">case</span> <span class="n">FC_VPORT_FAILED</span>:
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="n">LPFC_VPORT_FAILED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_VPORT_LINKDOWN</span>:
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="n">LPFC_VPORT_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* do nothing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_alloc_vpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vpi</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="cm">/* Start at bit 1 because vpi zero is reserved for the physical port */</span>
	<span class="n">vpi</span> <span class="o">=</span> <span class="n">find_next_zero_bit</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_bmask</span><span class="p">,</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vpi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">&gt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vpi</span><span class="p">)</span>
		<span class="n">vpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">vpi</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_bmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">max_cfg_param</span><span class="p">.</span><span class="n">vpi_used</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vpi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_free_vpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vpi</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_bmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">max_cfg_param</span><span class="p">.</span><span class="n">vpi_used</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_vport_sparm</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">rc</span><span class="p">;</span>

	<span class="n">pmb</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_read_sparam</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmb</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab buffer pointer and clear context1 so we can use</span>
<span class="cm">	 * lpfc_sli_issue_box_wait</span>
<span class="cm">	 */</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmb</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span> <span class="o">|</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
					 <span class="s">&quot;1830 Signal aborted mbxCmd x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">);</span>
			<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">MBX_TIMEOUT</span><span class="p">)</span>
				<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_INIT</span> <span class="o">|</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
					 <span class="s">&quot;1818 VPort failed init, mbxCmd x%x &quot;</span>
					 <span class="s">&quot;READ_SPARM mbxStatus x%x, rc = x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxStatus</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">MBX_TIMEOUT</span><span class="p">)</span>
				<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">serv_parm</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">nodeName</span><span class="p">,</span>
	       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_portname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span>
	       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">));</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_valid_wwn_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_name</span> <span class="o">*</span><span class="n">wwn</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name_type</span><span class="p">)</span>
<span class="p">{</span>
				<span class="cm">/* ensure that IEEE format 1 addresses</span>
<span class="cm">				 * contain zeros in bits 59-48</span>
<span class="cm">				 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	      <span class="p">((</span><span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
			<span class="s">&quot;1822 Invalid %s: %02x:%02x:%02x:%02x:&quot;</span>
			<span class="s">&quot;%02x:%02x:%02x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name_type</span><span class="p">,</span>
			<span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			<span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">wwn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_unique_wwpn</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">new_vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">listentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span> <span class="o">==</span> <span class="n">new_vport</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* If they match, return not unique */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">new_vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_name</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_discovery_wait - Wait for driver discovery to quiesce</span>
<span class="cm"> * @vport: The virtual port for which this call is being executed.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver calls this routine specifically from lpfc_vport_delete</span>
<span class="cm"> * to enforce a synchronous execution of vport</span>
<span class="cm"> * delete relative to discovery activities.  The</span>
<span class="cm"> * lpfc_vport_delete routine should not return until it</span>
<span class="cm"> * can reasonably guarantee that discovery has quiesced.</span>
<span class="cm"> * Post FDISC LOGO, the driver must wait until its SAN teardown is</span>
<span class="cm"> * complete and all resources recovered before allowing</span>
<span class="cm"> * cleanup.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine does not require any locks held.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lpfc_discovery_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">wait_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait_time_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_time</span><span class="p">;</span>

	<span class="n">wait_flags</span> <span class="o">=</span> <span class="n">FC_RSCN_MODE</span> <span class="o">|</span> <span class="n">FC_RSCN_DISCOVERY</span> <span class="o">|</span> <span class="n">FC_NLP_MORE</span> <span class="o">|</span>
		     <span class="n">FC_RSCN_DEFERRED</span> <span class="o">|</span> <span class="n">FC_NDISC_ACTIVE</span> <span class="o">|</span> <span class="n">FC_DISC_TMO</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The time constraint on this loop is a balance between the</span>
<span class="cm">	 * fabric RA_TOV value and dev_loss tmo.  The driver&#39;s</span>
<span class="cm">	 * devloss_tmo is 10 giving this loop a 3x multiplier minimally.</span>
<span class="cm">	 */</span>
	<span class="n">wait_time_max</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">wait_time_max</span> <span class="o">+=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">start_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait_time_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>    <span class="o">||</span>
		    <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">wait_flags</span><span class="p">)</span>  <span class="o">||</span>
		    <span class="p">((</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&gt;</span> <span class="n">LPFC_VPORT_FAILED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&lt;</span> <span class="n">LPFC_VPORT_READY</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
					<span class="s">&quot;1833 Vport discovery quiesce Wait:&quot;</span>
					<span class="s">&quot; state x%x fc_flags x%x&quot;</span>
					<span class="s">&quot; num_nodes x%x, waiting 1000 msecs&quot;</span>
					<span class="s">&quot; total wait msecs x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
					<span class="n">vport</span><span class="o">-&gt;</span><span class="n">num_disc_nodes</span><span class="p">,</span>
					<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">));</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Base case.  Wait variants satisfied.  Break out */</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
					 <span class="s">&quot;1834 Vport discovery quiesced:&quot;</span>
					 <span class="s">&quot; state x%x fc_flags x%x&quot;</span>
					 <span class="s">&quot; wait msecs x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
					 <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span>
						<span class="o">-</span> <span class="n">start_time</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait_time_max</span><span class="p">))</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
				<span class="s">&quot;1835 Vport discovery quiesce failed:&quot;</span>
				<span class="s">&quot; state x%x fc_flags x%x wait msecs x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span><span class="p">,</span>
				<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">lpfc_vport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">pport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">pport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vpi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_ERROR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_enable_npiv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
				<span class="s">&quot;1808 Create VPORT failed: &quot;</span>
				<span class="s">&quot;NPIV is not enabled: SLImode:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_INVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vpi</span> <span class="o">=</span> <span class="n">lpfc_alloc_vpi</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
				<span class="s">&quot;1809 Create VPORT failed: &quot;</span>
				<span class="s">&quot;Max VPORTs (%d) exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vpi</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_NORESOURCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assign an unused board number */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instance</span> <span class="o">=</span> <span class="n">lpfc_get_instance</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
				<span class="s">&quot;1810 Create VPORT failed: Cannot get &quot;</span>
				<span class="s">&quot;instance number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lpfc_free_vpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vpi</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_NORESOURCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vport</span> <span class="o">=</span> <span class="n">lpfc_create_port</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
				<span class="s">&quot;1811 Create VPORT failed: vpi x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vpi</span><span class="p">);</span>
		<span class="n">lpfc_free_vpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vpi</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_NORESOURCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">vpi</span><span class="p">;</span>
	<span class="n">lpfc_debugfs_initialize</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">lpfc_vport_sparm</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
					 <span class="s">&quot;1831 Create VPORT Interrupted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_ERROR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
					 <span class="s">&quot;1813 Create VPORT failed. &quot;</span>
					 <span class="s">&quot;Cannot get sparam</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_NORESOURCES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lpfc_free_vpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vpi</span><span class="p">);</span>
		<span class="n">destroy_port</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">u64_to_wwn</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">node_name</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodename</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">);</span>
	<span class="n">u64_to_wwn</span><span class="p">(</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_portname</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_portname</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">nodeName</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodename</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">wwn</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_valid_wwn_format</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">nodeName</span><span class="p">,</span> <span class="s">&quot;WWNN&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">lpfc_valid_wwn_format</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">.</span><span class="n">portName</span><span class="p">,</span> <span class="s">&quot;WWPN&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
				 <span class="s">&quot;1821 Create VPORT failed. &quot;</span>
				 <span class="s">&quot;Invalid WWN format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lpfc_free_vpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vpi</span><span class="p">);</span>
		<span class="n">destroy_port</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_INVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_unique_wwpn</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
				 <span class="s">&quot;1823 Create VPORT failed. &quot;</span>
				 <span class="s">&quot;Duplicate WWN on HBA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lpfc_free_vpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vpi</span><span class="p">);</span>
		<span class="n">destroy_port</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_INVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create binary sysfs attribute for vport */</span>
	<span class="n">lpfc_alloc_sysfs_attr</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span><span class="p">)</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_vport</span> <span class="o">=</span> <span class="n">fc_vport</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In SLI4, the vpi must be activated before it can be used</span>
<span class="cm">	 * by the port.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_VFI_REGISTERED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_init_vpi</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
					<span class="s">&quot;1838 Failed to INIT_VPI on vpi %d &quot;</span>
					<span class="s">&quot;status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_NORESOURCES</span><span class="p">;</span>
			<span class="n">lpfc_free_vpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vpi</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Driver cannot INIT_VPI now. Set the flags to</span>
<span class="cm">		 * init_vpi when reg_vfi complete.</span>
<span class="cm">		 */</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">|=</span> <span class="n">FC_VPORT_NEEDS_INIT_VPI</span><span class="p">;</span>
		<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_LINKDOWN</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&lt;</span> <span class="n">LPFC_LINK_UP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&lt;</span> <span class="n">LPFC_FABRIC_CFG_LINK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_topology</span> <span class="o">==</span> <span class="n">LPFC_TOPOLOGY_LOOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_LINKDOWN</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_DISABLED</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use the Physical nodes Fabric NDLP to determine if the link is</span>
<span class="cm">	 * up and ready to FDISC.</span>
<span class="cm">	 */</span>
	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">Fabric_DID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span> <span class="o">&amp;&amp;</span> <span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span> <span class="o">==</span> <span class="n">NLP_STE_UNMAPPED_NODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_flag</span> <span class="o">&amp;</span> <span class="n">LS_NPIV_FAB_SUPPORTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_set_disctmo</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
			<span class="n">lpfc_initial_fdisc</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_NO_FABRIC_SUPP</span><span class="p">);</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
					 <span class="s">&quot;0262 No NPIV Fabric support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">VPORT_OK</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
			<span class="s">&quot;1825 Vport Created.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">lpfc_host_attrib_init</span><span class="p">(</span><span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
<span class="nl">error_out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">disable_vport</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span><span class="p">)</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">next_ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">Fabric_DID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span> <span class="o">&amp;&amp;</span> <span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">LPFC_LINK_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">unreg_vpi_cmpl</span> <span class="o">=</span> <span class="n">VPORT_INVAL</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_issue_els_npiv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">))</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">unreg_vpi_cmpl</span> <span class="o">==</span> <span class="n">VPORT_INVAL</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="p">)</span>
				<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lpfc_sli_host_down</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="cm">/* Mark all nodes for discovery so we can remove them by</span>
<span class="cm">	 * calling lpfc_cleanup_rpis(vport, 1)</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ndlp</span><span class="p">,</span> <span class="n">next_ndlp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodes</span><span class="p">,</span> <span class="n">nlp_listp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span> <span class="o">==</span> <span class="n">NLP_STE_UNUSED_NODE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">lpfc_disc_state_machine</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">NLP_EVT_DEVICE_RECOVERY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lpfc_cleanup_rpis</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">lpfc_stop_vport_timers</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="n">lpfc_unreg_all_rpis</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="n">lpfc_unreg_default_rpis</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Completion of unreg_vpi (lpfc_mbx_cmpl_unreg_vpi) does the</span>
<span class="cm">	 * scsi_host_put() to release the vport.</span>
<span class="cm">	 */</span>
	<span class="n">lpfc_mbx_unreg_vpi</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">|=</span> <span class="n">FC_VPORT_NEEDS_INIT_VPI</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_DISABLED</span><span class="p">);</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
			 <span class="s">&quot;1826 Vport Disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">VPORT_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">enable_vport</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span><span class="p">)</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&lt;</span> <span class="n">LPFC_LINK_UP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_topology</span> <span class="o">==</span> <span class="n">LPFC_TOPOLOGY_LOOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_LINKDOWN</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">VPORT_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">|=</span> <span class="n">FC_LOADING</span><span class="p">;</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">|=</span> <span class="n">FC_VPORT_NEEDS_REG_VPI</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="cm">/* Use the Physical nodes Fabric NDLP to determine if the link is</span>
<span class="cm">	 * up and ready to FDISC.</span>
<span class="cm">	 */</span>
	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">Fabric_DID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span> <span class="o">&amp;&amp;</span> <span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span> <span class="o">==</span> <span class="n">NLP_STE_UNMAPPED_NODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_flag</span> <span class="o">&amp;</span> <span class="n">LS_NPIV_FAB_SUPPORTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_set_disctmo</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
			<span class="n">lpfc_initial_fdisc</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_NO_FABRIC_SUPP</span><span class="p">);</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
					 <span class="s">&quot;0264 No NPIV Fabric support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_vport_set_state</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
			 <span class="s">&quot;1827 Vport Enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">VPORT_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">lpfc_vport_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">,</span> <span class="n">bool</span> <span class="n">disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">disable_vport</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">enable_vport</span><span class="p">(</span><span class="n">fc_vport</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">lpfc_vport_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_vport</span> <span class="o">*</span><span class="n">fc_vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">)</span> <span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span><span class="p">)</span><span class="n">fc_vport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span>   <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">LPFC_PHYSICAL_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
				 <span class="s">&quot;1812 vport_delete failed: Cannot delete &quot;</span>
				 <span class="s">&quot;physical host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">VPORT_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the vport is a static vport fail the deletion. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vport_flag</span> <span class="o">&amp;</span> <span class="n">STATIC_VPORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">&amp;</span> <span class="n">FC_UNLOADING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
				 <span class="s">&quot;1837 vport_delete failed: Cannot delete &quot;</span>
				 <span class="s">&quot;static vport.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">VPORT_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">|=</span> <span class="n">FC_UNLOADING</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we are not unloading the driver then prevent the vport_delete</span>
<span class="cm">	 * from happening until after this vport&#39;s discovery is finished.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">&amp;</span> <span class="n">FC_UNLOADING</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">check_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">check_count</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&gt;</span> <span class="n">LPFC_VPORT_FAILED</span> <span class="o">&amp;&amp;</span>
		       <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&lt;</span> <span class="n">LPFC_VPORT_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&gt;</span> <span class="n">LPFC_VPORT_FAILED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vport</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">&lt;</span> <span class="n">LPFC_VPORT_READY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is a bit of a mess.  We want to ensure the shost doesn&#39;t get</span>
<span class="cm">	 * torn down until we&#39;re done with the embedded lpfc_vport structure.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Beyond holding a reference for this function, we also need a</span>
<span class="cm">	 * reference for outstanding I/O requests we schedule during delete</span>
<span class="cm">	 * processing.  But once we scsi_remove_host() we can no longer obtain</span>
<span class="cm">	 * a reference through scsi_host_get().</span>
<span class="cm">	 *</span>
<span class="cm">	 * So we take two references here.  We release one reference at the</span>
<span class="cm">	 * bottom of the function -- after delinking the vport.  And we</span>
<span class="cm">	 * release the other at the completion of the unreg_vpi that get&#39;s</span>
<span class="cm">	 * initiated after we&#39;ve disposed of all other resources associated</span>
<span class="cm">	 * with the port.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">shost</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">VPORT_INVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">shost</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">VPORT_INVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_free_sysfs_attr</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">lpfc_debugfs_terminate</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="cm">/* Remove FC host and then SCSI host with the vport */</span>
	<span class="n">fc_remove_host</span><span class="p">(</span><span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vport</span><span class="p">));</span>

	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">Fabric_DID</span><span class="p">);</span>

	<span class="cm">/* In case of driver unload, we shall not perform fabric logo as the</span>
<span class="cm">	 * worker thread already stopped at this stage and, in this case, we</span>
<span class="cm">	 * can safely skip the fabric logo.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">&amp;</span> <span class="n">FC_UNLOADING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span> <span class="o">&amp;&amp;</span> <span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span> <span class="o">==</span> <span class="n">NLP_STE_UNMAPPED_NODE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">LPFC_LINK_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First look for the Fabric ndlp */</span>
			<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">Fabric_DID</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">skip_logo</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_enable_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span>
							<span class="n">NLP_STE_UNUSED_NODE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">skip_logo</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Remove ndlp from vport npld list */</span>
			<span class="n">lpfc_dequeue_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>

			<span class="cm">/* Indicate free memory when release */</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ndlp_lock</span><span class="p">);</span>
			<span class="n">NLP_SET_FREE_REQ</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ndlp_lock</span><span class="p">);</span>
			<span class="cm">/* Kick off release ndlp when it can be safely done */</span>
			<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">skip_logo</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Otherwise, we will perform fabric logo as needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span> <span class="o">&amp;&amp;</span> <span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span> <span class="o">==</span> <span class="n">NLP_STE_UNMAPPED_NODE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&gt;=</span> <span class="n">LPFC_LINK_UP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_topology</span> <span class="o">!=</span> <span class="n">LPFC_TOPOLOGY_LOOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">cfg_enable_da_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_ns_cmd</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">SLI_CTNS_DA_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">ct_flags</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="p">)</span>
					<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
						<span class="n">LOG_VPORT</span><span class="p">,</span>
						<span class="s">&quot;1829 CT command failed to &quot;</span>
						<span class="s">&quot;delete objects on fabric</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* First look for the Fabric ndlp */</span>
		<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">Fabric_DID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Cannot find existing Fabric ndlp, allocate one */</span>
			<span class="n">ndlp</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">nlp_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">skip_logo</span><span class="p">;</span>
			<span class="n">lpfc_nlp_init</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span> <span class="n">Fabric_DID</span><span class="p">);</span>
			<span class="cm">/* Indicate free memory when release */</span>
			<span class="n">NLP_SET_FREE_REQ</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_enable_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span>
						<span class="n">NLP_STE_UNUSED_NODE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">skip_logo</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Remove ndlp from vport list */</span>
			<span class="n">lpfc_dequeue_node</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ndlp_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NLP_CHK_FREE_REQ</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span>
				<span class="cm">/* Indicate free memory when release */</span>
				<span class="n">NLP_SET_FREE_REQ</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Skip this if ndlp is already in free mode */</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ndlp_lock</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">skip_logo</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ndlp_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the vpi is not registered, then a valid FDISC doesn&#39;t</span>
<span class="cm">		 * exist and there is no need for a ELS LOGO.  Just cleanup</span>
<span class="cm">		 * the ndlp.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi_state</span> <span class="o">&amp;</span> <span class="n">LPFC_VPI_REGISTERED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">skip_logo</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vport</span><span class="o">-&gt;</span><span class="n">unreg_vpi_cmpl</span> <span class="o">=</span> <span class="n">VPORT_INVAL</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_issue_els_npiv_logo</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">))</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">unreg_vpi_cmpl</span> <span class="o">==</span> <span class="n">VPORT_INVAL</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="p">)</span>
				<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">&amp;</span> <span class="n">FC_UNLOADING</span><span class="p">))</span>
		<span class="n">lpfc_discovery_wait</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

<span class="nl">skip_logo:</span>
	<span class="n">lpfc_cleanup</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="n">lpfc_sli_host_down</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="n">lpfc_stop_vport_timers</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">&amp;</span> <span class="n">FC_UNLOADING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_unreg_all_rpis</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="n">lpfc_unreg_default_rpis</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Completion of unreg_vpi (lpfc_mbx_cmpl_unreg_vpi)</span>
<span class="cm">		 * does the scsi_host_put() to release the vport.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_mbx_unreg_vpi</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span>
			<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">lpfc_free_vpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">);</span>
	<span class="n">vport</span><span class="o">-&gt;</span><span class="n">work_port_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">listentry</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
			 <span class="s">&quot;1828 Vport Deleted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">VPORT_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span>
<span class="nf">lpfc_create_vport_work_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">port_iterator</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span><span class="n">vports</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vports</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vports</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">),</span>
			 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vports</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port_iterator</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">,</span> <span class="n">listentry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_iterator</span><span class="o">-&gt;</span><span class="n">load_flag</span> <span class="o">&amp;</span> <span class="n">FC_UNLOADING</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">port_iterator</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">port_iterator</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_VPORT</span><span class="p">,</span>
					 <span class="s">&quot;1801 Create vport work array FAILED: &quot;</span>
					 <span class="s">&quot;cannot do scsi_host_get</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vports</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_iterator</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vports</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">lpfc_destroy_vport_work_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span><span class="n">vports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vports</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vports</span> <span class="o">&amp;&amp;</span> <span class="n">vports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vports</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vports</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * lpfc_vport_reset_stat_data - Reset the statistical data for the vport</span>
<span class="cm"> * @vport: Pointer to vport object.</span>
<span class="cm"> *</span>
<span class="cm"> * This function resets the statistical data for the vport. This function</span>
<span class="cm"> * is called with the host_lock held</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_vport_reset_stat_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">next_ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ndlp</span><span class="p">,</span> <span class="n">next_ndlp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodes</span><span class="p">,</span> <span class="n">nlp_listp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">lat_data</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">lat_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LPFC_MAX_BUCKET_COUNT</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_scsicmd_bkt</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * lpfc_alloc_bucket - Allocate data buffer required for statistical data</span>
<span class="cm"> * @vport: Pointer to vport object.</span>
<span class="cm"> *</span>
<span class="cm"> * This function allocates data buffer required for all the FC</span>
<span class="cm"> * nodes of the vport to collect statistical data.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_alloc_bucket</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">next_ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ndlp</span><span class="p">,</span> <span class="n">next_ndlp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodes</span><span class="p">,</span> <span class="n">nlp_listp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">lat_data</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">lat_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_state</span> <span class="o">==</span> <span class="n">NLP_STE_MAPPED_NODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">lat_data</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">LPFC_MAX_BUCKET_COUNT</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_scsicmd_bkt</span><span class="p">),</span>
					 <span class="n">GFP_ATOMIC</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">lat_data</span><span class="p">)</span>
				<span class="n">lpfc_printf_vlog</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_NODE</span><span class="p">,</span>
					<span class="s">&quot;0287 lpfc_alloc_bucket failed to &quot;</span>
					<span class="s">&quot;allocate statistical data buffer DID &quot;</span>
					<span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_free_bucket - Free data buffer required for statistical data</span>
<span class="cm"> * @vport: Pointer to vport object.</span>
<span class="cm"> *</span>
<span class="cm"> * Th function frees statistical data buffer of all the FC</span>
<span class="cm"> * nodes of the vport.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_free_bucket</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">next_ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ndlp</span><span class="p">,</span> <span class="n">next_ndlp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_nodes</span><span class="p">,</span> <span class="n">nlp_listp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">lat_data</span><span class="p">);</span>
		<span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">lat_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
