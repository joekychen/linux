<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › lpfc › lpfc_bsg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lpfc_bsg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm"> * This file is part of the Emulex Linux Device Driver for         *</span>
<span class="cm"> * Fibre Channel Host Bus Adapters.                                *</span>
<span class="cm"> * Copyright (C) 2009-2012 Emulex.  All rights reserved.           *</span>
<span class="cm"> * EMULEX and SLI are trademarks of Emulex.                        *</span>
<span class="cm"> * www.emulex.com                                                  *</span>
<span class="cm"> *                                                                 *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or   *</span>
<span class="cm"> * modify it under the terms of version 2 of the GNU General       *</span>
<span class="cm"> * Public License as published by the Free Software Foundation.    *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful. *</span>
<span class="cm"> * ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND          *</span>
<span class="cm"> * WARRANTIES, INCLUDING ANY IMPLIED WARRANTY OF MERCHANTABILITY,  *</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT, ARE      *</span>
<span class="cm"> * DISCLAIMED, EXCEPT TO THE EXTENT THAT SUCH DISCLAIMERS ARE HELD *</span>
<span class="cm"> * TO BE LEGALLY INVALID.  See the GNU General Public License for  *</span>
<span class="cm"> * more details, a copy of which can be found in the file COPYING  *</span>
<span class="cm"> * included with this package.                                     *</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_bsg_fc.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fs.h&gt;</span>

<span class="cp">#include &quot;lpfc_hw4.h&quot;</span>
<span class="cp">#include &quot;lpfc_hw.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli.h&quot;</span>
<span class="cp">#include &quot;lpfc_sli4.h&quot;</span>
<span class="cp">#include &quot;lpfc_nl.h&quot;</span>
<span class="cp">#include &quot;lpfc_bsg.h&quot;</span>
<span class="cp">#include &quot;lpfc_disc.h&quot;</span>
<span class="cp">#include &quot;lpfc_scsi.h&quot;</span>
<span class="cp">#include &quot;lpfc.h&quot;</span>
<span class="cp">#include &quot;lpfc_logmsg.h&quot;</span>
<span class="cp">#include &quot;lpfc_crtn.h&quot;</span>
<span class="cp">#include &quot;lpfc_debugfs.h&quot;</span>
<span class="cp">#include &quot;lpfc_vport.h&quot;</span>
<span class="cp">#include &quot;lpfc_version.h&quot;</span>

<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">kref</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wq</span><span class="p">;</span>

	<span class="cm">/* Event type and waiter identifiers */</span>
	<span class="kt">uint32_t</span> <span class="n">type_mask</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reg_id</span><span class="p">;</span>

	<span class="cm">/* next two flags are here for the auto-delete logic */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait_time_stamp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">waiting</span><span class="p">;</span>

	<span class="cm">/* seen and not seen events */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">events_to_get</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">events_to_see</span><span class="p">;</span>

	<span class="cm">/* job waiting for this event to finish */</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">set_job</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lpfc_bsg_iocb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocbq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>

	<span class="cm">/* job waiting for this iocb to finish */</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">set_job</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lpfc_bsg_mbox</span> <span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuffers</span><span class="p">;</span> <span class="cm">/* for BIU diags */</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span> <span class="cm">/* extended mailbox data */</span>
	<span class="kt">uint32_t</span> <span class="n">mbOffset</span><span class="p">;</span> <span class="cm">/* from app */</span>
	<span class="kt">uint32_t</span> <span class="n">inExtWLen</span><span class="p">;</span> <span class="cm">/* from app */</span>
	<span class="kt">uint32_t</span> <span class="n">outExtWLen</span><span class="p">;</span> <span class="cm">/* from app */</span>

	<span class="cm">/* job waiting for this mbox command to finish */</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">set_job</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define MENLO_DID 0x0000FC0E</span>

<span class="k">struct</span> <span class="n">lpfc_bsg_menlo</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocbq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span><span class="p">;</span>

	<span class="cm">/* job waiting for this iocb to finish */</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">set_job</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define TYPE_EVT 	1</span>
<span class="cp">#define TYPE_IOCB	2</span>
<span class="cp">#define TYPE_MBOX	3</span>
<span class="cp">#define TYPE_MENLO	4</span>
<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lpfc_bsg_iocb</span> <span class="n">iocb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lpfc_bsg_mbox</span> <span class="n">mbox</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lpfc_bsg_menlo</span> <span class="n">menlo</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">context_un</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">event_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">immed_dat</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define BUF_SZ_4K 4096</span>
<span class="cp">#define SLI_CT_ELX_LOOPBACK 0x10</span>

<span class="k">enum</span> <span class="n">ELX_LOOPBACK_CMD</span> <span class="p">{</span>
	<span class="n">ELX_LOOPBACK_XRI_SETUP</span><span class="p">,</span>
	<span class="n">ELX_LOOPBACK_DATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define ELX_LOOPBACK_HEADER_SZ \</span>
<span class="cp">	(size_t)(&amp;((struct lpfc_sli_ct_request *)NULL)-&gt;un)</span>

<span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_send_mgmt_cmd_cmp - lpfc_bsg_send_mgmt_cmd&#39;s completion handler</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @cmdiocbq: Pointer to command iocb.</span>
<span class="cm"> * @rspiocbq: Pointer to response iocb.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the completion handler for iocbs issued using</span>
<span class="cm"> * lpfc_bsg_send_mgmt_cmd function. This function is called by the</span>
<span class="cm"> * ring event handler function without any lock held. This function</span>
<span class="cm"> * can be called from both worker thread context and interrupt</span>
<span class="cm"> * context. This function also can be called from another thread which</span>
<span class="cm"> * cleans up the SLI layer objects.</span>
<span class="cm"> * This function copies the contents of the response iocb to the</span>
<span class="cm"> * response iocb memory object provided by the caller of</span>
<span class="cm"> * lpfc_sli_issue_iocb_wait and then wakes up the thread which</span>
<span class="cm"> * sleeps for the iocb completion.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_send_mgmt_cmd_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_iocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iocb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">job</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">set_job</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* so timeout handler does not reply */</span>

	<span class="n">bmp</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>

	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_LOCAL_REJECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IOERR_SEQUENCE_TIMEOUT</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IOERR_INVALID_RPI</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>
	<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bmp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* complete the job back to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_send_mgmt_cmd - send a CT command from a bsg request</span>
<span class="cm"> * @job: fc_bsg_job to handle</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_send_mgmt_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_rport_data</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">pnode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_nseg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reply_nseg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numbde</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">busaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">creg_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocb_stat</span><span class="p">;</span>

	<span class="cm">/* in case no data is transferred */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* allocate our bsg tracking structure */</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2733 Failed allocation of dd_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_dd_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_nlp_get</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_ndlp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_ndlp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_flag</span> <span class="o">&amp;</span> <span class="n">NLP_ELS_SND_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_bmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdiocbq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_bmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_cmdiocbq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">request_nseg</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				  <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sgel</span><span class="p">,</span> <span class="n">request_nseg</span><span class="p">,</span> <span class="n">numbde</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64</span><span class="p">;</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply_nseg</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sgel</span><span class="p">,</span> <span class="n">reply_nseg</span><span class="p">,</span> <span class="n">numbde</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64I</span><span class="p">;</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">ulpIoTag32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BLP_64</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">request_nseg</span> <span class="o">+</span> <span class="n">reply_nseg</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpCommand</span> <span class="o">=</span> <span class="n">CMD_GEN_REQUEST64_CR</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Fctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">SI</span> <span class="o">|</span> <span class="n">LA</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Dfctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Rctl</span> <span class="o">=</span> <span class="n">FC_RCTL_DD_UNSOL_CTL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">FC_TYPE_CT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpLe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpClass</span> <span class="o">=</span> <span class="n">CLASS3</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">rpi_ids</span><span class="p">[</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">];</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpOwner</span> <span class="o">=</span> <span class="n">OWN_CHIP</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context3</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_flag</span> <span class="o">|=</span> <span class="n">LPFC_IO_LIBDFC</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpTimeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_cmpl</span> <span class="o">=</span> <span class="n">lpfc_bsg_send_mgmt_cmd_cmp</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="n">ndlp</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_IOCB</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">cmdiocbq</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">bmp</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_poll</span> <span class="o">&amp;</span> <span class="n">DISABLE_FCP_RING_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">creg_val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span> <span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_cmdiocbq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">creg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HC_R0INT_ENA</span> <span class="o">&lt;&lt;</span> <span class="n">LPFC_FCP_RING</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">creg_val</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="p">}</span>

	<span class="n">iocb_stat</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_ELS_RING</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iocb_stat</span> <span class="o">==</span> <span class="n">IOCB_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* done for now */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iocb_stat</span> <span class="o">==</span> <span class="n">IOCB_BUSY</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>


	<span class="cm">/* iocb failed so cleanup */</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

<span class="nl">free_cmdiocbq:</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>
<span class="nl">free_bmp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bmp</span><span class="p">);</span>
<span class="nl">free_ndlp:</span>
	<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
<span class="nl">no_ndlp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>
<span class="nl">no_dd_data:</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_rport_els_cmp - lpfc_bsg_rport_els&#39;s completion handler</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @cmdiocbq: Pointer to command iocb.</span>
<span class="cm"> * @rspiocbq: Pointer to response iocb.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the completion handler for iocbs issued using</span>
<span class="cm"> * lpfc_bsg_rport_els_cmp function. This function is called by the</span>
<span class="cm"> * ring event handler function without any lock held. This function</span>
<span class="cm"> * can be called from both worker thread context and interrupt</span>
<span class="cm"> * context. This function also can be called from other thread which</span>
<span class="cm"> * cleans up the SLI layer objects.</span>
<span class="cm"> * This function copies the contents of the response iocb to the</span>
<span class="cm"> * response iocb memory object provided by the caller of</span>
<span class="cm"> * lpfc_sli_issue_iocb_wait and then wakes up the thread which</span>
<span class="cm"> * sleeps for the iocb completion.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_rport_els_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">pbuflist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_ctels_reply</span> <span class="o">*</span><span class="n">els_reply</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">rjt_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="cm">/* normal completion and timeout crossed paths, already done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_flag</span> <span class="o">|=</span> <span class="n">LPFC_IO_WAKE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">&amp;&amp;</span> <span class="n">rspiocbq</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCB_t</span><span class="p">));</span>

	<span class="n">job</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">set_job</span><span class="p">;</span>
	<span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">cmdiocbq</span><span class="p">;</span>
	<span class="n">rspiocbq</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">rspiocbq</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">ndlp</span><span class="p">;</span>

	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_SUCCESS</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">elsreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_LS_RJT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_ctels_reply</span><span class="p">);</span>
		<span class="cm">/* LS_RJT data returned in word 4 */</span>
		<span class="n">rjt_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">els_reply</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_data</span><span class="p">.</span><span class="n">ctels_reply</span><span class="p">;</span>
		<span class="n">els_reply</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">FC_CTELS_STATUS_REJECT</span><span class="p">;</span>
		<span class="n">els_reply</span><span class="o">-&gt;</span><span class="n">rjt_data</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">rjt_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">els_reply</span><span class="o">-&gt;</span><span class="n">rjt_data</span><span class="p">.</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">rjt_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">els_reply</span><span class="o">-&gt;</span><span class="n">rjt_data</span><span class="p">.</span><span class="n">reason_explanation</span> <span class="o">=</span> <span class="n">rjt_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">els_reply</span><span class="o">-&gt;</span><span class="n">rjt_data</span><span class="p">.</span><span class="n">vendor_unique</span> <span class="o">=</span> <span class="n">rjt_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">pbuflist</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context3</span><span class="p">;</span>
	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pbuflist</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">pbuflist</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rspiocbq</span><span class="p">);</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>
	<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* complete the job back to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_rport_els - send an ELS command from a bsg request</span>
<span class="cm"> * @job: fc_bsg_job to handle</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_rport_els</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_rport_data</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">pnode</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">elscmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cmdsize</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rspsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocbq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">rpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">pcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">prsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">pbuflist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_nseg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reply_nseg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numbde</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">busaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">creg_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* in case no data is transferred */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* allocate our bsg tracking structure */</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2735 Failed allocation of dd_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_dd_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_nlp_get</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_dd_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">elscmd</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">r_els</span><span class="p">.</span><span class="n">els_code</span><span class="p">;</span>
	<span class="n">cmdsize</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
	<span class="n">rspsize</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
	<span class="n">rspiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rspiocbq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_dd_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">rpi</span> <span class="o">=</span> <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">;</span>

	<span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">lpfc_prep_els_iocb</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmdsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ndlp</span><span class="p">,</span>
				      <span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_DID</span><span class="p">,</span> <span class="n">elscmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdiocbq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_rspiocbq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prep els iocb set context1 to the ndlp, context2 to the command</span>
<span class="cm">	 * dmabuf, context3 holds the data dmabuf</span>
<span class="cm">	 */</span>
	<span class="n">pcmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="n">prsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">pcmd</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pcmd</span><span class="p">);</span>
	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">prsp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">prsp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">prsp</span><span class="p">);</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pbuflist</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context3</span><span class="p">;</span>
	<span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">pbuflist</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="n">request_nseg</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				  <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sgel</span><span class="p">,</span> <span class="n">request_nseg</span><span class="p">,</span> <span class="n">numbde</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64</span><span class="p">;</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply_nseg</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sgel</span><span class="p">,</span> <span class="n">reply_nseg</span><span class="p">,</span> <span class="n">numbde</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64I</span><span class="p">;</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">elsreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">request_nseg</span> <span class="o">+</span> <span class="n">reply_nseg</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">rpi_ids</span><span class="p">[</span><span class="n">rpi</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">rpi</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_flag</span> <span class="o">|=</span> <span class="n">LPFC_IO_LIBDFC</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_cmpl</span> <span class="o">=</span> <span class="n">lpfc_bsg_rport_els_cmp</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">ndlp</span> <span class="o">=</span> <span class="n">ndlp</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="n">rspiocbq</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_IOCB</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">cmdiocbq</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">rspiocbq</span> <span class="o">=</span> <span class="n">rspiocbq</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">bmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">ndlp</span> <span class="o">=</span> <span class="n">ndlp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_poll</span> <span class="o">&amp;</span> <span class="n">DISABLE_FCP_RING_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">creg_val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">linkdown_err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">creg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HC_R0INT_ENA</span> <span class="o">&lt;&lt;</span> <span class="n">LPFC_FCP_RING</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">creg_val</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_ELS_RING</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IOCB_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* done for now */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IOCB_BUSY</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">linkdown_err:</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pbuflist</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">pbuflist</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>

<span class="nl">free_rspiocbq:</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rspiocbq</span><span class="p">);</span>

<span class="nl">free_dd_data:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>

<span class="nl">no_dd_data:</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_event_free - frees an allocated event structure</span>
<span class="cm"> * @kref: Pointer to a kref.</span>
<span class="cm"> *</span>
<span class="cm"> * Called from kref_put. Back cast the kref into an event structure address.</span>
<span class="cm"> * Free any events to get, delete associated nodes, free any events to see,</span>
<span class="cm"> * free any data then free the event itself.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_event_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_bsg_event</span><span class="p">,</span>
						  <span class="n">kref</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">event_data</span> <span class="o">*</span><span class="n">ed</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ed</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ed</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ed</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ed</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_event_ref - increments the kref for an event</span>
<span class="cm"> * @evt: Pointer to an event structure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_event_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_event_unref - Uses kref_put to free an event structure</span>
<span class="cm"> * @evt: Pointer to an event structure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_event_unref</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">lpfc_bsg_event_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_event_new - allocate and initialize a event structure</span>
<span class="cm"> * @ev_mask: Mask of events.</span>
<span class="cm"> * @ev_reg_id: Event reg id.</span>
<span class="cm"> * @ev_req_id: Event request id.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span>
<span class="nf">lpfc_bsg_event_new</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">ev_mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ev_reg_id</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ev_req_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">evt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evt</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">);</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">type_mask</span> <span class="o">=</span> <span class="n">ev_mask</span><span class="p">;</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">ev_req_id</span><span class="p">;</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">reg_id</span> <span class="o">=</span> <span class="n">ev_reg_id</span><span class="p">;</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">wait_time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">evt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * diag_cmd_data_free - Frees an lpfc dma buffer extension</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @mlist: Pointer to an lpfc dma buffer extension.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">diag_cmd_data_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="n">mlist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="n">mlast</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">curr</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">mlist</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_is_link_up</span><span class="p">(</span><span class="n">phba</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_flag</span> <span class="o">&amp;</span> <span class="n">LS_LOOPBACK_MODE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcidev</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlist</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlast</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="p">,</span> <span class="n">dma</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlast</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">mlast</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					  <span class="n">mlast</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span>
					  <span class="n">mlast</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mlast</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_ct_unsol_event - process an unsolicited CT command</span>
<span class="cm"> * @phba:</span>
<span class="cm"> * @pring:</span>
<span class="cm"> * @piocbq:</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called when an unsolicited CT command is received.  It</span>
<span class="cm"> * forwards the event to any processes registered to receive CT events.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_bsg_ct_unsol_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">piocbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">evt_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_data</span> <span class="o">*</span><span class="n">evt_dat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">iocbq</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bde</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bdeBuf1</span> <span class="o">=</span> <span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bdeBuf2</span> <span class="o">=</span> <span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">context3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hbq_entry</span> <span class="o">*</span><span class="n">hbqe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">ct_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpBdeCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_ct_unsol_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">LPFC_HBA_ERROR</span> <span class="o">||</span>
		<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">sli_flag</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI_ACTIVE</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">error_ct_unsol_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">)</span>
		<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">bdeBuf1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">getPaddr</span><span class="p">(</span><span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addrHigh</span><span class="p">,</span>
				    <span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addrLow</span><span class="p">);</span>
		<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">lpfc_sli_ringpostbuf_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmabuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_ct_unsol_exit</span><span class="p">;</span>
	<span class="n">ct_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">evt_req_id</span> <span class="o">=</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">FsType</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ct_req</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">))</span>
		<span class="n">lpfc_sli_ringpostbuf_put</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_waiters</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">type_mask</span> <span class="o">&amp;</span> <span class="n">FC_REG_CT_EVENT</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">evt</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">!=</span> <span class="n">evt_req_id</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">lpfc_bsg_event_ref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">evt_dat</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">evt_dat</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evt_dat</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2614 Memory allocation failed for &quot;</span>
					<span class="s">&quot;CT event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* take accumulated byte count from the last iocbq */</span>
			<span class="n">iocbq</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">iocbq</span><span class="p">),</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">unsli3</span><span class="p">.</span><span class="n">rcvsli3</span><span class="p">.</span><span class="n">acc_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iocbq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpBdeCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span>
					<span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2615 Memory allocation failed for &quot;</span>
					<span class="s">&quot;CT event data, size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">evt_dat</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_ct_unsol_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iocbq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bdeBuf1</span> <span class="o">=</span> <span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
				<span class="n">bdeBuf2</span> <span class="o">=</span> <span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">context3</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpBdeCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span>
				    <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">hbqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hbq_entry</span> <span class="o">*</span><span class="p">)</span>
						  <span class="o">&amp;</span><span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
						<span class="n">size</span> <span class="o">=</span> <span class="n">hbqe</span><span class="o">-&gt;</span><span class="n">bde</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
						<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">bdeBuf1</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">hbqe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hbq_entry</span> <span class="o">*</span><span class="p">)</span>
							<span class="o">&amp;</span><span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">unsli3</span><span class="p">.</span>
							<span class="n">sli3Words</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
						<span class="n">size</span> <span class="o">=</span> <span class="n">hbqe</span><span class="o">-&gt;</span><span class="n">bde</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
						<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">bdeBuf2</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
						<span class="n">size</span> <span class="o">=</span> <span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">size</span> <span class="o">=</span> <span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
					<span class="n">bde</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">getPaddr</span><span class="p">(</span><span class="n">bde</span><span class="o">-&gt;</span><span class="n">addrHigh</span><span class="p">,</span>
							    <span class="n">bde</span><span class="o">-&gt;</span><span class="n">addrLow</span><span class="p">);</span>
					<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">lpfc_sli_ringpostbuf_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
							<span class="n">pring</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmabuf</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span>
						<span class="n">LOG_LIBDFC</span><span class="p">,</span> <span class="s">&quot;2616 No dmabuf &quot;</span>
						<span class="s">&quot;found for iocbq 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">iocbq</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">evt_dat</span><span class="p">);</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span>
						<span class="n">flags</span><span class="p">);</span>
					<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">error_ct_unsol_exit</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				       <span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">evt_req_id</span> <span class="o">!=</span> <span class="n">SLI_CT_ELX_LOOPBACK</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span>
				      <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">lpfc_sli_ringpostbuf_put</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span>
								 <span class="n">dmabuf</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">ELX_LOOPBACK_DATA</span>:
						<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span>
						    <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
							<span class="n">diag_cmd_data_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
							<span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabufext</span>
							 <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">ELX_LOOPBACK_XRI_SETUP</span>:
						<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span>
							<span class="n">LPFC_SLI_REV2</span><span class="p">)</span> <span class="o">||</span>
							<span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span>
							<span class="n">LPFC_SLI3_HBQ_ENABLED</span>
							<span class="p">))</span> <span class="p">{</span>
							<span class="n">lpfc_in_buf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
									<span class="n">dmabuf</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">lpfc_post_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
									 <span class="n">pring</span><span class="p">,</span>
									 <span class="mi">1</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="nl">default:</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span>
						      <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">))</span>
							<span class="n">lpfc_post_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
									 <span class="n">pring</span><span class="p">,</span>
									 <span class="mi">1</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctx_idx</span><span class="p">;</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctx_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctx_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">64</span><span class="p">;</span>
			<span class="cm">/* Provide warning for over-run of the ct_ctx array */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
			    <span class="n">UNSOL_VALID</span><span class="p">)</span>
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
						<span class="s">&quot;2717 CT context array entry &quot;</span>
						<span class="s">&quot;[%d] over-run: oxid:x%x, &quot;</span>
						<span class="s">&quot;sid:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctx_idx</span><span class="p">,</span>
						<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span>
						    <span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span><span class="p">].</span><span class="n">oxid</span><span class="p">,</span>
						<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span>
						    <span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span><span class="p">].</span><span class="n">SID</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span><span class="p">].</span><span class="n">rxid</span> <span class="o">=</span>
				<span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpContext</span><span class="p">;</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span><span class="p">].</span><span class="n">oxid</span> <span class="o">=</span>
				<span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">unsli3</span><span class="p">.</span><span class="n">rcvsli3</span><span class="p">.</span><span class="n">ox_id</span><span class="p">;</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span><span class="p">].</span><span class="n">SID</span> <span class="o">=</span>
				<span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">rcvels</span><span class="p">.</span><span class="n">remoteID</span><span class="p">;</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UNSOL_VALID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span> <span class="o">=</span> <span class="n">piocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">.</span><span class="n">ulpContext</span><span class="p">;</span>

		<span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FC_REG_CT_EVENT</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evt_req_id</span> <span class="o">==</span> <span class="n">SLI_CT_ELX_LOOPBACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
			<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_move</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">);</span>
		<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>

		<span class="n">job</span> <span class="o">=</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">set_job</span><span class="p">;</span>
		<span class="n">evt</span><span class="o">-&gt;</span><span class="n">set_job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="cm">/* make error code available to userspace */</span>
			<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/* complete the job back to userspace */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">error_ct_unsol_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">))</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">evt_req_id</span> <span class="o">==</span> <span class="n">SLI_CT_ELX_LOOPBACK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_hba_set_event - process a SET_EVENT bsg vendor command</span>
<span class="cm"> * @job: SET_EVENT fc_bsg_job</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_hba_set_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">set_ct_event</span> <span class="o">*</span><span class="n">event_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ev_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">set_ct_event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2612 Received SET_CT_EVENT below minimum &quot;</span>
				<span class="s">&quot;size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2734 Failed allocation of dd_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">set_ct_event</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>
	<span class="n">ev_mask</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">event_req</span><span class="o">-&gt;</span><span class="n">type_mask</span> <span class="o">&amp;</span>
				<span class="n">FC_REG_EVENT_MASK</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_waiters</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">reg_id</span> <span class="o">==</span> <span class="n">event_req</span><span class="o">-&gt;</span><span class="n">ev_reg_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_bsg_event_ref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
			<span class="n">evt</span><span class="o">-&gt;</span><span class="n">wait_time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_waiters</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no event waiting struct yet - first call */</span>
		<span class="n">evt</span> <span class="o">=</span> <span class="n">lpfc_bsg_event_new</span><span class="p">(</span><span class="n">ev_mask</span><span class="p">,</span> <span class="n">event_req</span><span class="o">-&gt;</span><span class="n">ev_reg_id</span><span class="p">,</span>
					<span class="n">event_req</span><span class="o">-&gt;</span><span class="n">ev_req_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2617 Failed allocation of event &quot;</span>
					<span class="s">&quot;waiter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_waiters</span><span class="p">);</span>
		<span class="n">lpfc_bsg_event_ref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
		<span class="n">evt</span><span class="o">-&gt;</span><span class="n">wait_time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_EVT</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span><span class="p">;</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">set_job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span> <span class="cm">/* for unsolicited command */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span> <span class="cm">/* for fc transport timeout callback*/</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* call job done later */</span>

<span class="nl">job_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd_data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>

	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_hba_get_event - process a GET_EVENT bsg vendor command</span>
<span class="cm"> * @job: GET_EVENT fc_bsg_job</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_hba_get_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">get_ct_event</span> <span class="o">*</span><span class="n">event_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">get_ct_event_reply</span> <span class="o">*</span><span class="n">event_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_data</span> <span class="o">*</span><span class="n">evt_dat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">get_ct_event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2613 Received GET_CT_EVENT request below &quot;</span>
				<span class="s">&quot;minimum size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">get_ct_event</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>

	<span class="n">event_reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">get_ct_event_reply</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_data</span><span class="p">.</span><span class="n">vendor_reply</span><span class="p">.</span><span class="n">vendor_rsp</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_waiters</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">reg_id</span> <span class="o">==</span> <span class="n">event_req</span><span class="o">-&gt;</span><span class="n">ev_reg_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">lpfc_bsg_event_ref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
			<span class="n">evt</span><span class="o">-&gt;</span><span class="n">wait_time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">evt_dat</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">event_data</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* The app may continue to ask for event data until it gets</span>
<span class="cm">	 * an error indicating that there isn&#39;t anymore</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evt_dat</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2618 Truncated event data at %d &quot;</span>
				<span class="s">&quot;bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">event_reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">event_reply</span><span class="o">-&gt;</span><span class="n">immed_data</span> <span class="o">=</span> <span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">immed_dat</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
					    <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
					    <span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">evt_dat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">evt_dat</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">evt_dat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">job_error:</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_issue_ct_rsp_cmp - lpfc_issue_ct_rsp&#39;s completion handler</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @cmdiocbq: Pointer to command iocb.</span>
<span class="cm"> * @rspiocbq: Pointer to response iocb.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the completion handler for iocbs issued using</span>
<span class="cm"> * lpfc_issue_ct_rsp_cmp function. This function is called by the</span>
<span class="cm"> * ring event handler function without any lock held. This function</span>
<span class="cm"> * can be called from both worker thread context and interrupt</span>
<span class="cm"> * context. This function also can be called from other thread which</span>
<span class="cm"> * cleans up the SLI layer objects.</span>
<span class="cm"> * This function copy the contents of the response iocb to the</span>
<span class="cm"> * response iocb memory object provided by the caller of</span>
<span class="cm"> * lpfc_sli_issue_iocb_wait and then wakes up the thread which</span>
<span class="cm"> * sleeps for the iocb completion.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_issue_ct_rsp_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">;</span>
	<span class="cm">/* normal completion and timeout crossed paths, already done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">job</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">set_job</span><span class="p">;</span>
	<span class="n">bmp</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">bmp</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">ndlp</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">ndlp</span><span class="p">;</span>

	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_LOCAL_REJECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IOERR_SEQUENCE_TIMEOUT</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IOERR_INVALID_RPI</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>
	<span class="n">lpfc_nlp_put</span><span class="p">(</span><span class="n">ndlp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bmp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* complete the job back to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_issue_ct_rsp - issue a ct response</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @job: Pointer to the job object.</span>
<span class="cm"> * @tag: tag index value into the ports context exchange array.</span>
<span class="cm"> * @bmp: Pointer to a dma buffer descriptor.</span>
<span class="cm"> * @num_entry: Number of enties in the bde.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_issue_ct_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">tag</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">icmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">ctiocb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_nodelist</span> <span class="o">*</span><span class="n">ndlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">creg_val</span><span class="p">;</span>

	<span class="cm">/* allocate our bsg tracking structure */</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2736 Failed allocation of dd_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_dd_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate buffer for  command iocb */</span>
	<span class="n">ctiocb</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctiocb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_ctiocb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">icmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">ulpIoTag32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BLP_64</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_entry</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span><span class="p">));</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Fctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">LS</span> <span class="o">|</span> <span class="n">LA</span><span class="p">);</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Dfctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Rctl</span> <span class="o">=</span> <span class="n">FC_RCTL_DD_SOL_CTL</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">FC_TYPE_CT</span><span class="p">;</span>

	<span class="cm">/* Fill in rest of iocb */</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpCommand</span> <span class="o">=</span> <span class="n">CMD_XMIT_SEQUENCE64_CX</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpLe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpClass</span> <span class="o">=</span> <span class="n">CLASS3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Do not issue unsol response if oxid not marked as valid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNSOL_VALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">IOCB_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">issue_ct_rsp_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">rxid</span><span class="p">;</span>
		<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">unsli3</span><span class="p">.</span><span class="n">rcvsli3</span><span class="p">.</span><span class="n">ox_id</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">oxid</span><span class="p">;</span>
		<span class="n">ndlp</span> <span class="o">=</span> <span class="n">lpfc_findnode_did</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">SID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
				 <span class="s">&quot;2721 ndlp null for oxid %x SID %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span><span class="p">,</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">SID</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">IOCB_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">issue_ct_rsp_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if the ndlp is active */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndlp</span> <span class="o">||</span> <span class="o">!</span><span class="n">NLP_CHK_NODE_ACT</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">IOCB_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">issue_ct_rsp_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get a refernece count so the ndlp doesn&#39;t go away while</span>
<span class="cm">		 * we respond</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_nlp_get</span><span class="p">(</span><span class="n">ndlp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">IOCB_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">issue_ct_rsp_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">rpi_ids</span><span class="p">[</span><span class="n">ndlp</span><span class="o">-&gt;</span><span class="n">nlp_rpi</span><span class="p">];</span>

		<span class="cm">/* The exchange is done, mark the entry as invalid */</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ctx</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UNSOL_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)</span> <span class="n">tag</span><span class="p">;</span>

	<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpTimeout</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Xmit CT response on exchange &lt;xid&gt; */</span>
	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_ELS</span><span class="p">,</span>
		<span class="s">&quot;2722 Xmit CT response on exchange x%x Data: x%x x%x x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span><span class="p">,</span> <span class="n">icmd</span><span class="o">-&gt;</span><span class="n">ulpIoTag</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">);</span>

	<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">iocb_cmpl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">iocb_flag</span> <span class="o">|=</span> <span class="n">LPFC_IO_LIBDFC</span><span class="p">;</span>
	<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>
	<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context3</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">;</span>

	<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">iocb_cmpl</span> <span class="o">=</span> <span class="n">lpfc_issue_ct_rsp_cmp</span><span class="p">;</span>
	<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ctiocb</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="n">ndlp</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_IOCB</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">ctiocb</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">rspiocbq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">bmp</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">.</span><span class="n">ndlp</span> <span class="o">=</span> <span class="n">ndlp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cfg_poll</span> <span class="o">&amp;</span> <span class="n">DISABLE_FCP_RING_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpfc_readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">creg_val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">IOCB_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">issue_ct_rsp_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">creg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HC_R0INT_ENA</span> <span class="o">&lt;&lt;</span> <span class="n">LPFC_FCP_RING</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">creg_val</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">HCregaddr</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_ELS_RING</span><span class="p">,</span> <span class="n">ctiocb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IOCB_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* done for now */</span>

<span class="nl">issue_ct_rsp_exit:</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ctiocb</span><span class="p">);</span>
<span class="nl">no_ctiocb:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>
<span class="nl">no_dd_data:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_send_mgmt_rsp - process a SEND_MGMT_RESP bsg vendor command</span>
<span class="cm"> * @job: SEND_MGMT_RESP fc_bsg_job</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_send_mgmt_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">send_mgmt_resp</span> <span class="o">*</span><span class="n">mgmt_resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">send_mgmt_resp</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_nseg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numbde</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">busaddr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">mgmt_resp</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reqbfrcnt</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* in case no data is transferred */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reqbfrcnt</span> <span class="o">||</span> <span class="p">(</span><span class="n">reqbfrcnt</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="n">BUF_SZ_4K</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_mgmt_rsp_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_mgmt_rsp_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_mgmt_rsp_free_bmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">request_nseg</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				  <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sgel</span><span class="p">,</span> <span class="n">request_nseg</span><span class="p">,</span> <span class="n">numbde</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64</span><span class="p">;</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_issue_ct_rsp</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">bmp</span><span class="p">,</span> <span class="n">request_nseg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IOCB_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* done for now */</span>

	<span class="cm">/* TBD need to handle a timeout */</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
			  <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

<span class="nl">send_mgmt_rsp_free_bmp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bmp</span><span class="p">);</span>
<span class="nl">send_mgmt_rsp_exit:</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_diag_mode_enter - process preparing into device diag loopback mode</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is responsible for preparing driver for diag loopback</span>
<span class="cm"> * on device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_diag_mode_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span><span class="n">vports</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psli</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">LPFC_FCP_RING</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pring</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">LPFC_HBA_ERROR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">sli_flag</span> <span class="o">&amp;</span> <span class="n">LPFC_BLOCK_MGMT_IO</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">sli_flag</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI_ACTIVE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">vports</span> <span class="o">=</span> <span class="n">lpfc_create_vport_work_array</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vports</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vpi</span> <span class="o">&amp;&amp;</span> <span class="n">vports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">lpfc_destroy_vport_work_array</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vports</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
		<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pring</span><span class="o">-&gt;</span><span class="n">txcmplq_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span>  <span class="cm">/* wait up to 5 seconds */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_diag_mode_exit - exit process from device diag loopback mode</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is responsible for driver exit processing of setting up</span>
<span class="cm"> * diag loopback mode on device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_diag_mode_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">**</span><span class="n">vports</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vports</span> <span class="o">=</span> <span class="n">lpfc_create_vport_work_array</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vports</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">max_vpi</span> <span class="o">&amp;&amp;</span> <span class="n">vports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">vports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">lpfc_destroy_vport_work_array</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">vports</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shost</span> <span class="o">=</span> <span class="n">lpfc_shost_from_vport</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
		<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli3_bsg_diag_loopback_mode - process an sli3 bsg vendor command</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @job: LPFC_BSG_VENDOR_DIAG_MODE</span>
<span class="cm"> *</span>
<span class="cm"> * This function is responsible for placing an sli3  port into diagnostic</span>
<span class="cm"> * loopback mode in order to perform a diagnostic loopback test.</span>
<span class="cm"> * All new scsi requests are blocked, a small delay is used to allow the</span>
<span class="cm"> * scsi requests to complete then the link is brought down. If the link is</span>
<span class="cm"> * is placed in loopback mode then scsi requests are again allowed</span>
<span class="cm"> * so the scsi mid-layer doesn&#39;t give up on the port.</span>
<span class="cm"> * All of this is done in-line.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_sli3_bsg_diag_loopback_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">diag_mode_set</span> <span class="o">*</span><span class="n">loopback_mode</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">link_flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mbxstatus</span> <span class="o">=</span> <span class="n">MBX_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* no data to return just the return code */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">diag_mode_set</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2738 Received DIAG MODE request size:%d &quot;</span>
				<span class="s">&quot;below the minimum size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">diag_mode_set</span><span class="p">)));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_diag_mode_enter</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>

	<span class="cm">/* bring the link to diagnostic mode */</span>
	<span class="n">loopback_mode</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">diag_mode_set</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>
	<span class="n">link_flags</span> <span class="o">=</span> <span class="n">loopback_mode</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">loopback_mode</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">pmboxq</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmboxq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">loopback_mode_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pmboxq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
	<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_DOWN_LINK</span><span class="p">;</span>
	<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>

	<span class="n">mbxstatus</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">LPFC_MBOX_TMO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mbxstatus</span> <span class="o">==</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* wait for link down before proceeding */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">!=</span> <span class="n">LPFC_LINK_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">loopback_mode_exit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pmboxq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_flags</span> <span class="o">==</span> <span class="n">INTERNAL_LOOP_BACK</span><span class="p">)</span>
			<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">=</span> <span class="n">FLAGS_LOCAL_LB</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">varInitLnk</span><span class="p">.</span><span class="n">link_flags</span> <span class="o">=</span>
				<span class="n">FLAGS_TOPOLOGY_MODE_LOOP</span><span class="p">;</span>

		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxCommand</span> <span class="o">=</span> <span class="n">MBX_INIT_LINK</span><span class="p">;</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>

		<span class="n">mbxstatus</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span>
						     <span class="n">LPFC_MBOX_TMO</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">mbxstatus</span> <span class="o">!=</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_flag</span> <span class="o">|=</span> <span class="n">LS_LOOPBACK_MODE</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
			<span class="cm">/* wait for the link attention interrupt */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">!=</span> <span class="n">LPFC_HBA_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">loopback_mode_exit:</span>
	<span class="n">lpfc_bsg_diag_mode_exit</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let SLI layer release mboxq if mbox command completed after timeout.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmboxq</span> <span class="o">&amp;&amp;</span> <span class="n">mbxstatus</span> <span class="o">!=</span> <span class="n">MBX_TIMEOUT</span><span class="p">)</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>

<span class="nl">job_error:</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* complete the job back to userspace if no error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_bsg_set_link_diag_state - set sli4 link diag state</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @diag: Flag for set link to diag or nomral operation state.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is responsible for issuing a sli4 mailbox command for setting</span>
<span class="cm"> * link to either diag state or normal operation state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_sli4_bsg_set_link_diag_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">diag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_set_link_diag_state</span> <span class="o">*</span><span class="n">link_diag_state</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">req_len</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mbxstatus</span> <span class="o">=</span> <span class="n">MBX_SUCCESS</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pmboxq</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmboxq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">req_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbx_set_link_diag_state</span><span class="p">)</span> <span class="o">-</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli4_cfg_mhdr</span><span class="p">));</span>
	<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">lpfc_sli4_config</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">LPFC_MBOX_SUBSYSTEM_FCOE</span><span class="p">,</span>
				<span class="n">LPFC_MBOX_OPCODE_FCOE_LINK_DIAG_STATE</span><span class="p">,</span>
				<span class="n">req_len</span><span class="p">,</span> <span class="n">LPFC_SLI4_MBX_EMBED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_len</span> <span class="o">!=</span> <span class="n">req_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">link_diag_state_set_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;3128 Set link to diagnostic state:x%x (x%x/x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">diag</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lnk_info</span><span class="p">.</span><span class="n">lnk_tp</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lnk_info</span><span class="p">.</span><span class="n">lnk_no</span><span class="p">);</span>

	<span class="n">link_diag_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">link_diag_state</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_set_diag_state_link_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_diag_state</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
	       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lnk_info</span><span class="p">.</span><span class="n">lnk_no</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_set_diag_state_link_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_diag_state</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
	       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lnk_info</span><span class="p">.</span><span class="n">lnk_tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_set_diag_state_diag</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">link_diag_state</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_set_diag_state_diag</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">link_diag_state</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mbxstatus</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">LPFC_MBOX_TMO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mbxstatus</span> <span class="o">==</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">link_diag_state_set_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmboxq</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mbxstatus</span> <span class="o">!=</span> <span class="n">MBX_TIMEOUT</span><span class="p">))</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_bsg_set_internal_loopback - set sli4 internal loopback diagnostic</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is responsible for issuing a sli4 mailbox command for setting</span>
<span class="cm"> * up internal loopback diagnostic.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_sli4_bsg_set_internal_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">req_len</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_set_link_diag_loopback</span> <span class="o">*</span><span class="n">link_diag_loopback</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mbxstatus</span> <span class="o">=</span> <span class="n">MBX_SUCCESS</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pmboxq</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmboxq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">req_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbx_set_link_diag_loopback</span><span class="p">)</span> <span class="o">-</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli4_cfg_mhdr</span><span class="p">));</span>
	<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">lpfc_sli4_config</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">LPFC_MBOX_SUBSYSTEM_FCOE</span><span class="p">,</span>
				<span class="n">LPFC_MBOX_OPCODE_FCOE_LINK_DIAG_LOOPBACK</span><span class="p">,</span>
				<span class="n">req_len</span><span class="p">,</span> <span class="n">LPFC_SLI4_MBX_EMBED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_len</span> <span class="o">!=</span> <span class="n">req_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">link_diag_loopback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">link_diag_loopback</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_set_diag_state_link_num</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">link_diag_loopback</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lnk_info</span><span class="p">.</span><span class="n">lnk_no</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_set_diag_state_link_type</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">link_diag_loopback</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lnk_info</span><span class="p">.</span><span class="n">lnk_tp</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_set_diag_lpbk_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_diag_loopback</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
	       <span class="n">LPFC_DIAG_LOOPBACK_TYPE_INTERNAL</span><span class="p">);</span>

	<span class="n">mbxstatus</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">LPFC_MBOX_TMO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mbxstatus</span> <span class="o">!=</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3127 Failed setup loopback mode mailbox &quot;</span>
				<span class="s">&quot;command, rc:x%x, status:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbxstatus</span><span class="p">,</span>
				<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmboxq</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mbxstatus</span> <span class="o">!=</span> <span class="n">MBX_TIMEOUT</span><span class="p">))</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_diag_fcport_reg_setup - setup port registrations for diagnostic</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> *</span>
<span class="cm"> * This function set up SLI4 FC port registrations for diagnostic run, which</span>
<span class="cm"> * includes all the rpis, vfi, and also vpi.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_sli4_diag_fcport_reg_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_VFI_REGISTERED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3136 Port still had vfi registered: &quot;</span>
				<span class="s">&quot;mydid:x%x, fcfi:%d, vfi:%d, vpi:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fcf</span><span class="p">.</span><span class="n">fcfi</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">vfi_ids</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">vfi</span><span class="p">],</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">vpi_ids</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_issue_reg_vfi</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_bsg_diag_loopback_mode - process an sli4 bsg vendor command</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @job: LPFC_BSG_VENDOR_DIAG_MODE</span>
<span class="cm"> *</span>
<span class="cm"> * This function is responsible for placing an sli4 port into diagnostic</span>
<span class="cm"> * loopback mode in order to perform a diagnostic loopback test.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_sli4_bsg_diag_loopback_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">diag_mode_set</span> <span class="o">*</span><span class="n">loopback_mode</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">link_flags</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* no data to return just the return code */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">diag_mode_set</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3011 Received DIAG MODE request size:%d &quot;</span>
				<span class="s">&quot;below the minimum size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">diag_mode_set</span><span class="p">)));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_diag_mode_enter</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>

	<span class="cm">/* indicate we are in loobpack diagnostic mode */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_flag</span> <span class="o">|=</span> <span class="n">LS_LOOPBACK_MODE</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>

	<span class="cm">/* reset port to start frome scratch */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_selective_reset</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>

	<span class="cm">/* bring the link to diagnostic mode */</span>
	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;3129 Bring link to diagnostic state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">loopback_mode</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">diag_mode_set</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>
	<span class="n">link_flags</span> <span class="o">=</span> <span class="n">loopback_mode</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">loopback_mode</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_bsg_set_link_diag_state</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3130 Failed to bring link to diagnostic &quot;</span>
				<span class="s">&quot;state, rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">loopback_mode_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wait for link down before proceeding */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">!=</span> <span class="n">LPFC_LINK_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;3131 Timeout waiting for link to &quot;</span>
					<span class="s">&quot;diagnostic mode, timeout:%d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">timeout</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">loopback_mode_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set up loopback mode */</span>
	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;3132 Set up loopback mode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_flags</span> <span class="o">==</span> <span class="n">INTERNAL_LOOP_BACK</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_bsg_set_internal_loopback</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link_flags</span> <span class="o">==</span> <span class="n">EXTERNAL_LOOP_BACK</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_hba_init_link_fc_topology</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
						    <span class="n">FLAGS_TOPOLOGY_MODE_PT_PT</span><span class="p">,</span>
						    <span class="n">MBX_NOWAIT</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3141 Loopback mode:x%x not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">link_flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">loopback_mode_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait for the link attention interrupt */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">&lt;</span> <span class="n">LPFC_LINK_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;3137 Timeout waiting for link up &quot;</span>
					<span class="s">&quot;in loopback mode, timeout:%d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">timeout</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* port resource registration setup for loopback diagnostic */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set up a none zero myDID for loopback test */</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_diag_fcport_reg_setup</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">loopback_mode_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait for the port ready */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">!=</span> <span class="n">LPFC_HBA_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;3133 Timeout waiting for port &quot;</span>
					<span class="s">&quot;loopback mode ready, timeout:%d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">timeout</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">loopback_mode_exit:</span>
	<span class="cm">/* clear loopback diagnostic mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LS_LOOPBACK_MODE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lpfc_bsg_diag_mode_exit</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

<span class="nl">job_error:</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* complete the job back to userspace if no error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_diag_loopback_mode - bsg vendor command for diag loopback mode</span>
<span class="cm"> * @job: LPFC_BSG_VENDOR_DIAG_MODE</span>
<span class="cm"> *</span>
<span class="cm"> * This function is responsible for responding to check and dispatch bsg diag</span>
<span class="cm"> * command from the user to proper driver action routines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_diag_loopback_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli3_bsg_diag_loopback_mode</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_sli_intf_if_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sli_intf</span><span class="p">)</span> <span class="o">==</span>
		 <span class="n">LPFC_SLI_INTF_IF_TYPE_2</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_bsg_diag_loopback_mode</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_bsg_diag_mode_end - sli4 bsg vendor command for ending diag mode</span>
<span class="cm"> * @job: LPFC_BSG_VENDOR_DIAG_MODE_END</span>
<span class="cm"> *</span>
<span class="cm"> * This function is responsible for responding to check and dispatch bsg diag</span>
<span class="cm"> * command from the user to proper driver action routines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_sli4_bsg_diag_mode_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diag_mode_set</span> <span class="o">*</span><span class="n">loopback_mode_end_cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_sli_intf_if_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sli_intf</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">LPFC_SLI_INTF_IF_TYPE_2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* clear loopback diagnostic mode */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LS_LOOPBACK_MODE</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">loopback_mode_end_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">diag_mode_set</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">loopback_mode_end_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_bsg_set_link_diag_state</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3139 Failed to bring link to diagnostic &quot;</span>
				<span class="s">&quot;state, rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">loopback_mode_end_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wait for link down before proceeding */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">!=</span> <span class="n">LPFC_LINK_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;3140 Timeout waiting for link to &quot;</span>
					<span class="s">&quot;diagnostic mode_end, timeout:%d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">timeout</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
			<span class="cm">/* there is nothing much we can do here */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset port resource registrations */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_selective_reset</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">loopback_mode_end_exit:</span>
	<span class="cm">/* make return code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* complete the job back to userspace if no error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_sli4_bsg_link_diag_test - sli4 bsg vendor command for diag link test</span>
<span class="cm"> * @job: LPFC_BSG_VENDOR_DIAG_LINK_TEST</span>
<span class="cm"> *</span>
<span class="cm"> * This function is to perform SLI4 diag link test request from the user</span>
<span class="cm"> * applicaiton.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_sli4_bsg_link_diag_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sli4_link_diag</span> <span class="o">*</span><span class="n">link_diag_test_cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">req_len</span><span class="p">,</span> <span class="n">alloc_len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_run_link_diag_test</span> <span class="o">*</span><span class="n">run_link_diag_test</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span> <span class="o">*</span><span class="n">shdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">shdr_status</span><span class="p">,</span> <span class="n">shdr_add_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diag_status</span> <span class="o">*</span><span class="n">diag_status_reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mbxstatus</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_sli_intf_if_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sli_intf</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">LPFC_SLI_INTF_IF_TYPE_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sli4_link_diag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3013 Received LINK DIAG TEST request &quot;</span>
				<span class="s">&quot; size:%d below the minimum size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sli4_link_diag</span><span class="p">)));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_diag_mode_enter</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>

	<span class="n">link_diag_test_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sli4_link_diag</span> <span class="o">*</span><span class="p">)</span>
			 <span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">link_diag_test_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_bsg_set_link_diag_state</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>

	<span class="n">pmboxq</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmboxq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">link_diag_test_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req_len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbx_set_link_diag_state</span><span class="p">)</span> <span class="o">-</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli4_cfg_mhdr</span><span class="p">));</span>
	<span class="n">alloc_len</span> <span class="o">=</span> <span class="n">lpfc_sli4_config</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">LPFC_MBOX_SUBSYSTEM_FCOE</span><span class="p">,</span>
				     <span class="n">LPFC_MBOX_OPCODE_FCOE_LINK_DIAG_STATE</span><span class="p">,</span>
				     <span class="n">req_len</span><span class="p">,</span> <span class="n">LPFC_SLI4_MBX_EMBED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alloc_len</span> <span class="o">!=</span> <span class="n">req_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">link_diag_test_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">run_link_diag_test</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">link_diag_test</span><span class="p">;</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_run_diag_test_link_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">run_link_diag_test</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
	       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lnk_info</span><span class="p">.</span><span class="n">lnk_no</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_run_diag_test_link_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">run_link_diag_test</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
	       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">lnk_info</span><span class="p">.</span><span class="n">lnk_tp</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_run_diag_test_test_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">run_link_diag_test</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
	       <span class="n">link_diag_test_cmd</span><span class="o">-&gt;</span><span class="n">test_id</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_run_diag_test_loops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">run_link_diag_test</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
	       <span class="n">link_diag_test_cmd</span><span class="o">-&gt;</span><span class="n">loops</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_run_diag_test_test_ver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">run_link_diag_test</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
	       <span class="n">link_diag_test_cmd</span><span class="o">-&gt;</span><span class="n">test_version</span><span class="p">);</span>
	<span class="n">bf_set</span><span class="p">(</span><span class="n">lpfc_mbx_run_diag_test_err_act</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">run_link_diag_test</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
	       <span class="n">link_diag_test_cmd</span><span class="o">-&gt;</span><span class="n">error_action</span><span class="p">);</span>

	<span class="n">mbxstatus</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">MBX_POLL</span><span class="p">);</span>

	<span class="n">shdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">lpfc_sli4_cfg_shdr</span> <span class="o">*</span><span class="p">)</span>
		<span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sli4_config</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_shdr</span><span class="p">;</span>
	<span class="n">shdr_status</span> <span class="o">=</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">);</span>
	<span class="n">shdr_add_status</span> <span class="o">=</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_add_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shdr_status</span> <span class="o">||</span> <span class="n">shdr_add_status</span> <span class="o">||</span> <span class="n">mbxstatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3010 Run link diag test mailbox failed with &quot;</span>
				<span class="s">&quot;mbx_status x%x status x%x, add_status x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mbxstatus</span><span class="p">,</span> <span class="n">shdr_status</span><span class="p">,</span> <span class="n">shdr_add_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">diag_status_reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">diag_status</span> <span class="o">*</span><span class="p">)</span>
			    <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_data</span><span class="p">.</span><span class="n">vendor_reply</span><span class="p">.</span><span class="n">vendor_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">diag_status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3012 Received Run link diag test reply &quot;</span>
				<span class="s">&quot;below minimum size (%d): reply_len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">diag_status</span><span class="p">)),</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_len</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">diag_status_reply</span><span class="o">-&gt;</span><span class="n">mbox_status</span> <span class="o">=</span> <span class="n">mbxstatus</span><span class="p">;</span>
	<span class="n">diag_status_reply</span><span class="o">-&gt;</span><span class="n">shdr_status</span> <span class="o">=</span> <span class="n">shdr_status</span><span class="p">;</span>
	<span class="n">diag_status_reply</span><span class="o">-&gt;</span><span class="n">shdr_add_status</span> <span class="o">=</span> <span class="n">shdr_add_status</span><span class="p">;</span>

<span class="nl">link_diag_test_exit:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_bsg_set_link_diag_state</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmboxq</span><span class="p">)</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>

	<span class="n">lpfc_bsg_diag_mode_exit</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

<span class="nl">job_error:</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* complete the job back to userspace if no error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfcdiag_loop_self_reg - obtains a remote port login id</span>
<span class="cm"> * @phba: Pointer to HBA context object</span>
<span class="cm"> * @rpi: Pointer to a remote port login id</span>
<span class="cm"> *</span>
<span class="cm"> * This function obtains a remote port login id so the diag loopback test</span>
<span class="cm"> * can send and receive its own unsolicited CT command.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lpfcdiag_loop_self_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">rpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbox</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mbox</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbox</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">lpfc_reg_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">,</span>
				<span class="n">mbox</span><span class="p">,</span> <span class="o">*</span><span class="n">rpi</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">rpi</span> <span class="o">=</span> <span class="n">lpfc_sli4_alloc_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">lpfc_reg_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_myDID</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">fc_sparam</span><span class="p">,</span>
				<span class="n">mbox</span><span class="p">,</span> <span class="o">*</span><span class="n">rpi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
			<span class="n">lpfc_sli4_free_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="o">*</span><span class="n">rpi</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmabuff</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">LPFC_MBOX_TMO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dmabuff</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">dmabuff</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dmabuff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MBX_TIMEOUT</span><span class="p">)</span>
			<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
			<span class="n">lpfc_sli4_free_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="o">*</span><span class="n">rpi</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpi</span> <span class="o">=</span> <span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dmabuff</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">dmabuff</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dmabuff</span><span class="p">);</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfcdiag_loop_self_unreg - unregs from the rpi</span>
<span class="cm"> * @phba: Pointer to HBA context object</span>
<span class="cm"> * @rpi: Remote port login id</span>
<span class="cm"> *</span>
<span class="cm"> * This function unregisters the rpi obtained in lpfcdiag_loop_self_reg</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lpfcdiag_loop_self_unreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">mbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Allocate mboxq structure */</span>
	<span class="n">mbox</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">lpfc_unreg_login</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rpi</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lpfc_unreg_login</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span>
				 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">rpi_ids</span><span class="p">[</span><span class="n">rpi</span><span class="p">],</span> <span class="n">mbox</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">LPFC_MBOX_TMO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MBX_TIMEOUT</span><span class="p">)</span>
			<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">mbox</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">lpfc_sli4_free_rpi</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rpi</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfcdiag_loop_get_xri - obtains the transmit and receive ids</span>
<span class="cm"> * @phba: Pointer to HBA context object</span>
<span class="cm"> * @rpi: Remote port login id</span>
<span class="cm"> * @txxri: Pointer to transmit exchange id</span>
<span class="cm"> * @rxxri: Pointer to response exchabge id</span>
<span class="cm"> *</span>
<span class="cm"> * This function obtains the transmit and receive ids required to send</span>
<span class="cm"> * an unsolicited ct command with a payload. A special lpfc FsType and CmdRsp</span>
<span class="cm"> * flags are used to the unsolicted response handler is able to process</span>
<span class="cm"> * the ct command sent on the same port.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lpfcdiag_loop_get_xri</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rpi</span><span class="p">,</span>
			 <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">txxri</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">rxxri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">,</span> <span class="o">*</span><span class="n">rspiocbq</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">ctreq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">time_left</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocb_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="o">*</span><span class="n">txxri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rxxri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">evt</span> <span class="o">=</span> <span class="n">lpfc_bsg_event_new</span><span class="p">(</span><span class="n">FC_REG_CT_EVENT</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				<span class="n">SLI_CT_ELX_LOOPBACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_waiters</span><span class="p">);</span>
	<span class="n">lpfc_bsg_event_ref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">rspiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmabuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">bpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bpl</span><span class="p">));</span>
			<span class="n">ctreq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="p">)(</span><span class="n">bpl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bpl</span><span class="p">)));</span>
			<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bpl</span><span class="p">)));</span>
			<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">ELX_LOOPBACK_HEADER_SZ</span><span class="p">;</span>
			<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdiocbq</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">rspiocbq</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">dmabuf</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">bpl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ctreq</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		<span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_get_xri_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ctreq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ELX_LOOPBACK_HEADER_SZ</span><span class="p">);</span>

	<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">RevisionId</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Revision</span> <span class="o">=</span> <span class="n">SLI_CT_REVISION</span><span class="p">;</span>
	<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">RevisionId</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">InId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">FsType</span> <span class="o">=</span> <span class="n">SLI_CT_ELX_LOOPBACK</span><span class="p">;</span>
	<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">FsSubType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span> <span class="n">ELX_LOOPBACK_XRI_SETUP</span><span class="p">;</span>
	<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BLP_64</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bpl</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Fctl</span> <span class="o">=</span> <span class="n">LA</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Dfctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Rctl</span> <span class="o">=</span> <span class="n">FC_RCTL_DD_UNSOL_CTL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">FC_TYPE_CT</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpCommand</span> <span class="o">=</span> <span class="n">CMD_XMIT_SEQUENCE64_CR</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpLe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpClass</span> <span class="o">=</span> <span class="n">CLASS3</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">rpi</span><span class="p">;</span>

	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_flag</span> <span class="o">|=</span> <span class="n">LPFC_IO_LIBDFC</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>

	<span class="n">iocb_stat</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_iocb_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_ELS_RING</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">,</span>
				<span class="n">rspiocbq</span><span class="p">,</span>
				<span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">LPFC_DRVR_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iocb_stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_get_xri_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">txxri</span> <span class="o">=</span>  <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpContext</span><span class="p">;</span>

	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">wait_time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">time_left</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span>
		<span class="n">evt</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">),</span>
		<span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LPFC_DRVR_TIMEOUT</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">))</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_left</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINTR</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_move</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="o">*</span><span class="n">rxxri</span> <span class="o">=</span> <span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
				     <span class="n">typeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_data</span><span class="p">),</span>
				     <span class="n">node</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">immed_dat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_get_xri_exit:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span> <span class="cm">/* release ref */</span>
	<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span> <span class="cm">/* delete */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmabuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span>
			<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dmabuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdiocbq</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">iocb_stat</span> <span class="o">!=</span> <span class="n">IOCB_TIMEDOUT</span><span class="p">))</span>
		<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspiocbq</span><span class="p">)</span>
		<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rspiocbq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_dma_page_alloc - allocate a bsg mbox page sized dma buffers</span>
<span class="cm"> * @phba: Pointer to HBA context object</span>
<span class="cm"> *</span>
<span class="cm"> * This function allocates BSG_MBOX_SIZE (4KB) page size dma buffer and.</span>
<span class="cm"> * retruns the pointer to the buffer.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span>
<span class="nf">lpfc_bsg_dma_page_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>

	<span class="cm">/* allocate dma buffer struct */</span>
	<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmabuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/* now, allocate dma buffer */</span>
	<span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSG_MBOX_SIZE</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dmabuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BSG_MBOX_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dmabuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_dma_page_free - free a bsg mbox page sized dma buffer</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @dmabuf: Pointer to the bsg mbox page sized dma buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine just simply frees a dma buffer and its associated buffer</span>
<span class="cm"> * descriptor referred by @dmabuf.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_dma_page_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmabuf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSG_MBOX_SIZE</span><span class="p">,</span>
				  <span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dmabuf</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_dma_page_list_free - free a list of bsg mbox page sized dma buffers</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @dmabuf_list: Pointer to a list of bsg mbox page sized dma buffer descs.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine just simply frees all dma buffers and their associated buffer</span>
<span class="cm"> * descriptors referred by @dmabuf_list.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_dma_page_list_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">dmabuf_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">,</span> <span class="o">*</span><span class="n">next_dmabuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">dmabuf_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dmabuf</span><span class="p">,</span> <span class="n">next_dmabuf</span><span class="p">,</span> <span class="n">dmabuf_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">lpfc_bsg_dma_page_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * diag_cmd_data_alloc - fills in a bde struct with dma buffers</span>
<span class="cm"> * @phba: Pointer to HBA context object</span>
<span class="cm"> * @bpl: Pointer to 64 bit bde structure</span>
<span class="cm"> * @size: Number of bytes to process</span>
<span class="cm"> * @nocopydata: Flag to copy user data into the allocated buffer</span>
<span class="cm"> *</span>
<span class="cm"> * This function allocates page size buffers and populates an lpfc_dmabufext.</span>
<span class="cm"> * If allowed the user data pointed to with indataptr is copied into the kernel</span>
<span class="cm"> * memory. The chained list of page size buffers is returned.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span>
<span class="nf">diag_cmd_data_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">nocopydata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="n">mlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="n">dmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>

	<span class="n">pcidev</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We get chunks of 4K */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">BUF_SZ_4K</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">BUF_SZ_4K</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

		<span class="cm">/* allocate struct lpfc_dmabufext buffer header */</span>
		<span class="n">dmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabufext</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmp</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>

		<span class="cm">/* Queue it to a linked list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlist</span><span class="p">)</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlist</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mlist</span> <span class="o">=</span> <span class="n">dmp</span><span class="p">;</span>

		<span class="cm">/* allocate buffer */</span>
		<span class="n">dmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">cnt</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="p">(</span><span class="n">dmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">phys</span><span class="p">),</span>
						   <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">dmp</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nocopydata</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				<span class="n">dmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">LPFC_BPL_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64I</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* build buffer ptr list for IOCB */</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">dmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">phys</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">dmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">phys</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlist</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mlist</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">diag_cmd_data_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mlist</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfcdiag_loop_post_rxbufs - post the receive buffers for an unsol CT cmd</span>
<span class="cm"> * @phba: Pointer to HBA context object</span>
<span class="cm"> * @rxxri: Receive exchange id</span>
<span class="cm"> * @len: Number of data bytes</span>
<span class="cm"> *</span>
<span class="cm"> * This function allocates and posts a data buffer of sufficient size to receive</span>
<span class="cm"> * an unsolicted CT command.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lpfcdiag_loop_post_rxbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rxxri</span><span class="p">,</span>
			     <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">LPFC_ELS_RING</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">curr</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">rxbmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">rxbpl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">num_bde</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="n">rxbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocb_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">rxbmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxbmp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxbmp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxbmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxbmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxbmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">rxbpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">rxbmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
			<span class="n">rxbuffer</span> <span class="o">=</span> <span class="n">diag_cmd_data_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rxbpl</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdiocbq</span> <span class="o">||</span> <span class="o">!</span><span class="n">rxbmp</span> <span class="o">||</span> <span class="o">!</span><span class="n">rxbpl</span> <span class="o">||</span> <span class="o">!</span><span class="n">rxbuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_post_rxbufs_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Queue buffers for the receive exchange */</span>
	<span class="n">num_bde</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">rxbuffer</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span>
	<span class="n">dmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxbuffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli3_options</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI3_HBQ_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buffer_tag</span> <span class="o">=</span> <span class="n">lpfc_sli_get_buffer_tag</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">quexri64cx</span><span class="p">.</span><span class="n">buff</span><span class="p">.</span><span class="n">bde</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span>
				<span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">quexri64cx</span><span class="p">.</span><span class="n">buff</span><span class="p">.</span><span class="n">bde</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span>
				<span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">quexri64cx</span><span class="p">.</span><span class="n">buff</span><span class="p">.</span><span class="n">bde</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span>
				<span class="p">((</span><span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="p">)</span><span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">quexri64cx</span><span class="p">.</span><span class="n">buff</span><span class="p">.</span><span class="n">buffer_tag</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buffer_tag</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpCommand</span> <span class="o">=</span> <span class="n">CMD_QUE_XRI64_CX</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpPU</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpLe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">unsli3</span><span class="p">.</span><span class="n">que_xri64cx_ext_words</span><span class="p">.</span><span class="n">ebde_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">cont64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span>
				<span class="p">((</span><span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="p">)</span><span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">=</span> <span class="o">++</span><span class="n">i</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="n">num_bde</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpCommand</span> <span class="o">=</span> <span class="n">CMD_QUE_XRI_BUF64_CX</span><span class="p">;</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpLe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpClass</span> <span class="o">=</span> <span class="n">CLASS3</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">rxxri</span><span class="p">;</span>

		<span class="n">iocb_stat</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_ELS_RING</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iocb_stat</span> <span class="o">==</span> <span class="n">IOCB_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diag_cmd_data_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="p">)</span><span class="n">mp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">diag_cmd_data_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
					  <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="p">)</span><span class="n">mp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">dmp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_post_rxbufs_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lpfc_sli_ringpostbuf_put</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">mp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">lpfc_sli_ringpostbuf_put</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">mp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">mp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* The iocb was freed by lpfc_sli_issue_iocb */</span>
		<span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdiocbq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dmp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_post_rxbufs_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>

<span class="nl">err_post_rxbufs_exit:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxbmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxbmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span>
			<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rxbmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">rxbmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rxbmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdiocbq</span><span class="p">)</span>
		<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_diag_loopback_run - run loopback on a port by issue ct cmd to itself</span>
<span class="cm"> * @job: LPFC_BSG_VENDOR_DIAG_TEST fc_bsg_job</span>
<span class="cm"> *</span>
<span class="cm"> * This function receives a user data buffer to be transmitted and received on</span>
<span class="cm"> * the same port, the link must be up and in loopback mode prior</span>
<span class="cm"> * to being called.</span>
<span class="cm"> * 1. A kernel buffer is allocated to copy the user data into.</span>
<span class="cm"> * 2. The port registers with &quot;itself&quot;.</span>
<span class="cm"> * 3. The transmit and receive exchange ids are obtained.</span>
<span class="cm"> * 4. The receive exchange id is posted.</span>
<span class="cm"> * 5. A new els loopback event is created.</span>
<span class="cm"> * 6. The command and response iocbs are allocated.</span>
<span class="cm"> * 7. The cmd iocb FsType is set to elx loopback and the CmdRsp to looppback.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is meant to be called n times while the port is in loopback</span>
<span class="cm"> * so it is the apps responsibility to issue a reset to take the port out</span>
<span class="cm"> * of loopback mode.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_diag_loopback_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">diag_mode_test</span> <span class="o">*</span><span class="n">diag_mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_data</span> <span class="o">*</span><span class="n">evdat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli</span> <span class="o">*</span><span class="n">psli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">full_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">segment_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">segment_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">current_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">rpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">,</span> <span class="o">*</span><span class="n">rspiocbq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ct_request</span> <span class="o">*</span><span class="n">ctreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">txbmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">txbpl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="n">txbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span>  <span class="o">*</span><span class="n">curr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">txxri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rxxri</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">num_bde</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_databuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">time_left</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocb_stat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dataout</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">total_mem</span><span class="p">;</span>

	<span class="cm">/* in case no data is returned return just the return code */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">diag_mode_test</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2739 Received DIAG TEST request below minimum &quot;</span>
				<span class="s">&quot;size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span> <span class="o">!=</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">diag_mode</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">diag_mode_test</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">==</span> <span class="n">LPFC_HBA_ERROR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">sli_flag</span> <span class="o">&amp;</span> <span class="n">LPFC_BLOCK_MGMT_IO</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">psli</span><span class="o">-&gt;</span><span class="n">sli_flag</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI_ACTIVE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpfc_is_link_up</span><span class="p">(</span><span class="n">phba</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_flag</span> <span class="o">&amp;</span> <span class="n">LS_LOOPBACK_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
	<span class="n">full_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">ELX_LOOPBACK_HEADER_SZ</span><span class="p">;</span> <span class="cm">/* plus the header */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">80</span> <span class="o">*</span> <span class="n">BUF_SZ_4K</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">full_size</span> <span class="o">&gt;=</span> <span class="n">BUF_SZ_4K</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocate memory for ioctl data. If buffer is bigger than 64k,</span>
<span class="cm">		 * then we allocate 64k and re-use that buffer over and over to</span>
<span class="cm">		 * xfer the whole block. This is because Linux kernel has a</span>
<span class="cm">		 * problem allocating more than 120k of kernel space memory. Saw</span>
<span class="cm">		 * problem with GET_FCPTARGETMAPPING...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>
			<span class="n">total_mem</span> <span class="o">=</span> <span class="n">full_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">total_mem</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* Allocate memory for ioctl data */</span>
		<span class="n">total_mem</span> <span class="o">=</span> <span class="n">BUF_SZ_4K</span><span class="p">;</span>

	<span class="n">dataout</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">total_mem</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dataout</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">dataout</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">ELX_LOOPBACK_HEADER_SZ</span><span class="p">;</span>
	<span class="n">sg_copy_to_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
				<span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfcdiag_loop_self_reg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rpi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfcdiag_loop_get_xri</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rpi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txxri</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxxri</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfcdiag_loop_self_unreg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rpi</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfcdiag_loop_post_rxbufs</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rxxri</span><span class="p">,</span> <span class="n">full_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfcdiag_loop_self_unreg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rpi</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">evt</span> <span class="o">=</span> <span class="n">lpfc_bsg_event_new</span><span class="p">(</span><span class="n">FC_REG_CT_EVENT</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
				<span class="n">SLI_CT_ELX_LOOPBACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfcdiag_loop_self_unreg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rpi</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_waiters</span><span class="p">);</span>
	<span class="n">lpfc_bsg_event_ref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">rspiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">txbmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txbmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">txbpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
			<span class="n">txbuffer</span> <span class="o">=</span> <span class="n">diag_cmd_data_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
							<span class="n">txbpl</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdiocbq</span> <span class="o">||</span> <span class="o">!</span><span class="n">txbmp</span> <span class="o">||</span> <span class="o">!</span><span class="n">txbpl</span> <span class="o">||</span> <span class="o">!</span><span class="n">txbuffer</span> <span class="o">||</span> <span class="o">!</span><span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rspiocbq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span>
		<span class="n">rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txbuffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">segment_len</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">lpfc_dmabufext</span> <span class="o">*</span><span class="p">)</span><span class="n">curr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctreq</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ctreq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ELX_LOOPBACK_HEADER_SZ</span><span class="p">);</span>
			<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">RevisionId</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Revision</span> <span class="o">=</span> <span class="n">SLI_CT_REVISION</span><span class="p">;</span>
			<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">RevisionId</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">InId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">FsType</span> <span class="o">=</span> <span class="n">SLI_CT_ELX_LOOPBACK</span><span class="p">;</span>
			<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">FsSubType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">CmdRsp</span> <span class="o">=</span> <span class="n">ELX_LOOPBACK_DATA</span><span class="p">;</span>
			<span class="n">ctreq</span><span class="o">-&gt;</span><span class="n">CommandResponse</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">Size</span>   <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">segment_offset</span> <span class="o">=</span> <span class="n">ELX_LOOPBACK_HEADER_SZ</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">segment_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">segment_offset</span> <span class="o">&gt;=</span> <span class="n">segment_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">+</span> <span class="n">segment_offset</span><span class="p">,</span>
			<span class="n">ptr</span> <span class="o">+</span> <span class="n">current_offset</span><span class="p">,</span>
			<span class="n">segment_len</span> <span class="o">-</span> <span class="n">segment_offset</span><span class="p">);</span>

		<span class="n">current_offset</span> <span class="o">+=</span> <span class="n">segment_len</span> <span class="o">-</span> <span class="n">segment_offset</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">current_offset</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>

	<span class="cm">/* Build the XMIT_SEQUENCE iocb */</span>
	<span class="n">num_bde</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">txbuffer</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BLP_64</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_bde</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span><span class="p">));</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Fctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">LS</span> <span class="o">|</span> <span class="n">LA</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Dfctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Rctl</span> <span class="o">=</span> <span class="n">FC_RCTL_DD_UNSOL_CTL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">FC_TYPE_CT</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpCommand</span> <span class="o">=</span> <span class="n">CMD_XMIT_SEQUENCE64_CX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpLe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpClass</span> <span class="o">=</span> <span class="n">CLASS3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">txxri</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">xseq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">ulpIoTag32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">rpi_ids</span><span class="p">[</span><span class="n">rpi</span><span class="p">];</span>
		<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context3</span> <span class="o">=</span> <span class="n">txbmp</span><span class="p">;</span>
		<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">sli4_xritag</span> <span class="o">=</span> <span class="n">NO_XRI</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">unsli3</span><span class="p">.</span><span class="n">rcvsli3</span><span class="p">.</span><span class="n">ox_id</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_flag</span> <span class="o">|=</span> <span class="n">LPFC_IO_LIBDFC</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>
	<span class="n">iocb_stat</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_iocb_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_ELS_RING</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">,</span>
					     <span class="n">rspiocbq</span><span class="p">,</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
					     <span class="n">LPFC_DRVR_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">iocb_stat</span> <span class="o">!=</span> <span class="n">IOCB_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">&lt;</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					   <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">!=</span> <span class="n">IOCB_SUCCESS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3126 Failed loopback test issue iocb: &quot;</span>
				<span class="s">&quot;iocb_stat:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iocb_stat</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_loopback_test_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">time_left</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span>
		<span class="n">evt</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">),</span>
		<span class="p">((</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_ratov</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LPFC_DRVR_TIMEOUT</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_left</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINTR</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;3125 Not receiving unsolicited event, &quot;</span>
				<span class="s">&quot;rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_move</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_see</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">);</span>
		<span class="n">evdat</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">events_to_get</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
				   <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">evdat</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rx_databuf</span> <span class="o">=</span> <span class="n">evdat</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evdat</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">full_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;1603 Loopback test did not receive expected &quot;</span>
				<span class="s">&quot;data length. actual length 0x%x expected &quot;</span>
				<span class="s">&quot;length 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">evdat</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">full_size</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx_databuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">IOCB_SUCCESS</span><span class="p">;</span>
			<span class="cm">/* skip over elx loopback header */</span>
			<span class="n">rx_databuf</span> <span class="o">+=</span> <span class="n">ELX_LOOPBACK_HEADER_SZ</span><span class="p">;</span>
			<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
				<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
						    <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
						    <span class="n">rx_databuf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">err_loopback_test_exit:</span>
	<span class="n">lpfcdiag_loop_self_unreg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rpi</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span> <span class="cm">/* release ref */</span>
	<span class="n">lpfc_bsg_event_unref</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span> <span class="cm">/* delete */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdiocbq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rspiocbq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rspiocbq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txbmp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txbpl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txbuffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">diag_cmd_data_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">txbuffer</span><span class="p">);</span>
			<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">txbmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">txbmp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">loopback_test_exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dataout</span><span class="p">);</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* complete the job back to userspace if no error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IOCB_SUCCESS</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_get_dfc_rev - process a GET_DFC_REV bsg vendor command</span>
<span class="cm"> * @job: GET_DFC_REV fc_bsg_job</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_get_dfc_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">get_mgmt_rev</span> <span class="o">*</span><span class="n">event_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">get_mgmt_rev_reply</span> <span class="o">*</span><span class="n">event_reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">get_mgmt_rev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2740 Received GET_DFC_REV request below &quot;</span>
				<span class="s">&quot;minimum size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">get_mgmt_rev</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>

	<span class="n">event_reply</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">get_mgmt_rev_reply</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_data</span><span class="p">.</span><span class="n">vendor_reply</span><span class="p">.</span><span class="n">vendor_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">get_mgmt_rev_reply</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2741 Received GET_DFC_REV reply below &quot;</span>
				<span class="s">&quot;minimum size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event_reply</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">a_Major</span> <span class="o">=</span> <span class="n">MANAGEMENT_MAJOR_REV</span><span class="p">;</span>
	<span class="n">event_reply</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">a_Minor</span> <span class="o">=</span> <span class="n">MANAGEMENT_MINOR_REV</span><span class="p">;</span>
<span class="nl">job_error:</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_issue_mbox_cmpl - lpfc_bsg_issue_mbox mbox completion handler</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @pmboxq: Pointer to mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This is completion handler function for mailbox commands issued from</span>
<span class="cm"> * lpfc_bsg_issue_mbox function. This function is called by the</span>
<span class="cm"> * mailbox event handler function with no lock held. This function</span>
<span class="cm"> * will wake up thread waiting on the wait queue pointed by context1</span>
<span class="cm"> * of the mailbox.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">lpfc_bsg_issue_mbox_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">,</span> <span class="o">*</span><span class="n">pmb_buf</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="cm">/* job already timed out? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The outgoing buffer is readily referred from the dma buffer,</span>
<span class="cm">	 * just need to get header part from mailboxq structure.</span>
<span class="cm">	 */</span>
	<span class="n">pmb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">pmb_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pmb_buf</span><span class="p">,</span> <span class="n">pmb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>

	<span class="n">job</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">set_job</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
					    <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
					    <span class="n">pmb_buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="cm">/* need to hold the lock until we set job-&gt;dd_data to NULL</span>
<span class="cm">		 * to hold off the timeout handler returning to the mid-layer</span>
<span class="cm">		 * while we are still processing the job.</span>
<span class="cm">		 */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mempool_free</span><span class="p">(</span><span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="n">lpfc_bsg_dma_page_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">dmabuffers</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_check_cmd_access - test for a supported mailbox command</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @mb: Pointer to a mailbox object.</span>
<span class="cm"> * @vport: Pointer to a vport object.</span>
<span class="cm"> *</span>
<span class="cm"> * Some commands require the port to be offline, some may not be called from</span>
<span class="cm"> * the application.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lpfc_bsg_check_cmd_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* return negative error values for bsg job */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Offline only */</span>
	<span class="k">case</span> <span class="n">MBX_INIT_LINK</span>:
	<span class="k">case</span> <span class="n">MBX_DOWN_LINK</span>:
	<span class="k">case</span> <span class="n">MBX_CONFIG_LINK</span>:
	<span class="k">case</span> <span class="n">MBX_CONFIG_RING</span>:
	<span class="k">case</span> <span class="n">MBX_RESET_RING</span>:
	<span class="k">case</span> <span class="n">MBX_UNREG_LOGIN</span>:
	<span class="k">case</span> <span class="n">MBX_CLEAR_LA</span>:
	<span class="k">case</span> <span class="n">MBX_DUMP_CONTEXT</span>:
	<span class="k">case</span> <span class="n">MBX_RUN_DIAGS</span>:
	<span class="k">case</span> <span class="n">MBX_RESTART</span>:
	<span class="k">case</span> <span class="n">MBX_SET_MASK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_OFFLINE_MODE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2743 Command 0x%x is illegal in on-line &quot;</span>
				<span class="s">&quot;state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">MBX_WRITE_NV</span>:
	<span class="k">case</span> <span class="n">MBX_WRITE_VPARMS</span>:
	<span class="k">case</span> <span class="n">MBX_LOAD_SM</span>:
	<span class="k">case</span> <span class="n">MBX_READ_NV</span>:
	<span class="k">case</span> <span class="n">MBX_READ_CONFIG</span>:
	<span class="k">case</span> <span class="n">MBX_READ_RCONFIG</span>:
	<span class="k">case</span> <span class="n">MBX_READ_STATUS</span>:
	<span class="k">case</span> <span class="n">MBX_READ_XRI</span>:
	<span class="k">case</span> <span class="n">MBX_READ_REV</span>:
	<span class="k">case</span> <span class="n">MBX_READ_LNK_STAT</span>:
	<span class="k">case</span> <span class="n">MBX_DUMP_MEMORY</span>:
	<span class="k">case</span> <span class="n">MBX_DOWN_LOAD</span>:
	<span class="k">case</span> <span class="n">MBX_UPDATE_CFG</span>:
	<span class="k">case</span> <span class="n">MBX_KILL_BOARD</span>:
	<span class="k">case</span> <span class="n">MBX_LOAD_AREA</span>:
	<span class="k">case</span> <span class="n">MBX_LOAD_EXP_ROM</span>:
	<span class="k">case</span> <span class="n">MBX_BEACON</span>:
	<span class="k">case</span> <span class="n">MBX_DEL_LD_ENTRY</span>:
	<span class="k">case</span> <span class="n">MBX_SET_DEBUG</span>:
	<span class="k">case</span> <span class="n">MBX_WRITE_WWN</span>:
	<span class="k">case</span> <span class="n">MBX_SLI4_CONFIG</span>:
	<span class="k">case</span> <span class="n">MBX_READ_EVENT_LOG</span>:
	<span class="k">case</span> <span class="n">MBX_READ_EVENT_LOG_STATUS</span>:
	<span class="k">case</span> <span class="n">MBX_WRITE_EVENT_LOG</span>:
	<span class="k">case</span> <span class="n">MBX_PORT_CAPABILITIES</span>:
	<span class="k">case</span> <span class="n">MBX_PORT_IOV_CONTROL</span>:
	<span class="k">case</span> <span class="n">MBX_RUN_BIU_DIAG64</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBX_SET_VARIABLE</span>:
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_INIT</span><span class="p">,</span>
			<span class="s">&quot;1226 mbox: set_variable 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SETVAR_MLOMNT</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">wait_4_mlo_maint_flg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SETVAR_MLORST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">link_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LS_LOOPBACK_MODE</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fc_topology</span> <span class="o">=</span> <span class="n">LPFC_TOPOLOGY_PT_PT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MBX_READ_SPARM64</span>:
	<span class="k">case</span> <span class="n">MBX_READ_TOPOLOGY</span>:
	<span class="k">case</span> <span class="n">MBX_REG_LOGIN</span>:
	<span class="k">case</span> <span class="n">MBX_REG_LOGIN64</span>:
	<span class="k">case</span> <span class="n">MBX_CONFIG_PORT</span>:
	<span class="k">case</span> <span class="n">MBX_RUN_BIU_DIAG</span>:
	<span class="nl">default:</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;2742 Unknown Command 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ok */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_mbox_ext_cleanup - clean up context of multi-buffer mbox session</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> *</span>
<span class="cm"> * This is routine clean up and reset BSG handling of multi-buffer mbox</span>
<span class="cm"> * command session.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_mbox_ext_session_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPFC_BSG_MBOX_IDLE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* free all memory, including dma buffers */</span>
	<span class="n">lpfc_bsg_dma_page_list_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">ext_dmabuf_list</span><span class="p">);</span>
	<span class="n">lpfc_bsg_dma_page_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbx_dmabuf</span><span class="p">);</span>
	<span class="cm">/* multi-buffer write mailbox command pass-through complete */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbox_ext_buf_ctx</span><span class="p">));</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">ext_dmabuf_list</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_issue_mbox_ext_handle_job - job handler for multi-buffer mbox cmpl</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @pmboxq: Pointer to mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This is routine handles BSG job for mailbox commands completions with</span>
<span class="cm"> * multiple external buffers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span>
<span class="nf">lpfc_bsg_issue_mbox_ext_handle_job</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">,</span> <span class="o">*</span><span class="n">pmb_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="n">sli_cfg_mbx</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pmbx</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="cm">/* has the job already timed out? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_done_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The outgoing buffer is readily referred from the dma buffer,</span>
<span class="cm">	 * just need to get header part from mailboxq structure.</span>
<span class="cm">	 */</span>
	<span class="n">pmb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">pmb_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="cm">/* Copy the byte swapped response mailbox back to the user */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pmb_buf</span><span class="p">,</span> <span class="n">pmb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
	<span class="cm">/* if there is any non-embedded extended data copy that too */</span>
	<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbx_dmabuf</span><span class="p">;</span>
	<span class="n">sli_cfg_mbx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_emb</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span><span class="n">sli_config_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pmbx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="cm">/* byte swap the extended data following the mailbox command */</span>
		<span class="n">lpfc_sli_pcimem_bcopy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmbx</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">)],</span>
			<span class="o">&amp;</span><span class="n">pmbx</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">)],</span>
			<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span><span class="n">mse</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">job</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">set_job</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
					    <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
					    <span class="n">pmb_buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="cm">/* result for successful */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* need to hold the lock util we set job-&gt;dd_data to NULL</span>
<span class="cm">		 * to hold off the timeout handler from midlayer to take</span>
<span class="cm">		 * any action.</span>
<span class="cm">		 */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2937 SLI_CONFIG ext-buffer maibox command &quot;</span>
				<span class="s">&quot;(x%x/x%x) complete bsg job done, bsize:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mboxType</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">lpfc_idiag_mbxacc_dump_bsg_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span><span class="p">,</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mboxType</span><span class="p">,</span>
					<span class="n">dma_ebuf</span><span class="p">,</span> <span class="n">sta_pos_addr</span><span class="p">,</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbx_dmabuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">job_done_out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">job</span><span class="p">)</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2938 SLI_CONFIG ext-buffer maibox &quot;</span>
				<span class="s">&quot;command (x%x/x%x) failure, rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mboxType</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="cm">/* state change */</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPFC_BSG_MBOX_DONE</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">job</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_issue_read_mbox_ext_cmpl - compl handler for multi-buffer read mbox</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @pmboxq: Pointer to mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This is completion handler function for mailbox read commands with multiple</span>
<span class="cm"> * external buffers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_issue_read_mbox_ext_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>

	<span class="cm">/* handle the BSG job with mailbox command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPFC_BSG_MBOX_ABTS</span><span class="p">)</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span> <span class="o">=</span> <span class="n">MBXERR_ERROR</span><span class="p">;</span>

	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;2939 SLI_CONFIG ext-buffer rd maibox command &quot;</span>
			<span class="s">&quot;complete, ctxState:x%x, mbxStatus:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span><span class="p">);</span>

	<span class="n">job</span> <span class="o">=</span> <span class="n">lpfc_bsg_issue_mbox_ext_handle_job</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span> <span class="o">||</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">numBuf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">lpfc_bsg_mbox_ext_session_reset</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="cm">/* free base driver mailbox structure memory */</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>

	<span class="cm">/* complete the bsg job if we have it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_issue_write_mbox_ext_cmpl - cmpl handler for multi-buffer write mbox</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @pmboxq: Pointer to mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * This is completion handler function for mailbox write commands with multiple</span>
<span class="cm"> * external buffers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_issue_write_mbox_ext_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>

	<span class="cm">/* handle the BSG job with the mailbox command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPFC_BSG_MBOX_ABTS</span><span class="p">)</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span> <span class="o">=</span> <span class="n">MBXERR_ERROR</span><span class="p">;</span>

	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;2940 SLI_CONFIG ext-buffer wr maibox command &quot;</span>
			<span class="s">&quot;complete, ctxState:x%x, mbxStatus:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">.</span><span class="n">mbxStatus</span><span class="p">);</span>

	<span class="n">job</span> <span class="o">=</span> <span class="n">lpfc_bsg_issue_mbox_ext_handle_job</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">);</span>

	<span class="cm">/* free all memory, including dma buffers */</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="n">lpfc_bsg_mbox_ext_session_reset</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="cm">/* complete the bsg job if we have it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_sli_cfg_dma_desc_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nemb_type</span> <span class="n">nemb_tp</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">mbx_dmabuf</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">ext_dmabuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="n">sli_cfg_mbx</span><span class="p">;</span>

	<span class="cm">/* pointer to the start of mailbox command */</span>
	<span class="n">sli_cfg_mbx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="p">)</span><span class="n">mbx_dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nemb_tp</span> <span class="o">==</span> <span class="n">nemb_mse</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
				<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_hi</span> <span class="o">=</span>
				<span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mbx_dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
			<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
				<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_lo</span> <span class="o">=</span>
				<span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mbx_dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2943 SLI_CONFIG(mse)[%d], &quot;</span>
					<span class="s">&quot;bufLen:%d, addrHi:x%x, addrLo:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">index</span><span class="p">,</span>
					<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
					<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buf_len</span><span class="p">,</span>
					<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
					<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_hi</span><span class="p">,</span>
					<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
					<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_lo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
				<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_hi</span> <span class="o">=</span>
				<span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">ext_dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
				<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_lo</span> <span class="o">=</span>
				<span class="n">putPaddrLow</span><span class="p">(</span><span class="n">ext_dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2944 SLI_CONFIG(mse)[%d], &quot;</span>
					<span class="s">&quot;bufLen:%d, addrHi:x%x, addrLo:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">index</span><span class="p">,</span>
					<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
					<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buf_len</span><span class="p">,</span>
					<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
					<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_hi</span><span class="p">,</span>
					<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
					<span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_lo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span>
				<span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_hi</span> <span class="o">=</span>
				<span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">mbx_dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
			<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span>
				<span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_lo</span> <span class="o">=</span>
				<span class="n">putPaddrLow</span><span class="p">(</span><span class="n">mbx_dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;3007 SLI_CONFIG(hbd)[%d], &quot;</span>
					<span class="s">&quot;bufLen:%d, addrHi:x%x, addrLo:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">index</span><span class="p">,</span>
				<span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_sli_config_ecmn_hbd_len</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span>
				<span class="n">sli_config_emb1_subsys</span><span class="p">.</span><span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span>
				<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span>
				<span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_hi</span><span class="p">,</span>
				<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span>
				<span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_lo</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span>
				<span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_hi</span> <span class="o">=</span>
				<span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">ext_dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span>
				<span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_lo</span> <span class="o">=</span>
				<span class="n">putPaddrLow</span><span class="p">(</span><span class="n">ext_dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;3008 SLI_CONFIG(hbd)[%d], &quot;</span>
					<span class="s">&quot;bufLen:%d, addrHi:x%x, addrLo:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">index</span><span class="p">,</span>
				<span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_sli_config_ecmn_hbd_len</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span>
				<span class="n">sli_config_emb1_subsys</span><span class="p">.</span><span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span>
				<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span>
				<span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_hi</span><span class="p">,</span>
				<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span>
				<span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pa_lo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_sli_cfg_mse_read_cmd_ext - sli_config non-embedded mailbox cmd read</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @mb: Pointer to a BSG mailbox object.</span>
<span class="cm"> * @nemb_tp: Enumerate of non-embedded mailbox command type.</span>
<span class="cm"> * @dmabuff: Pointer to a DMA buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine performs SLI_CONFIG (0x9B) read mailbox command operation with</span>
<span class="cm"> * non-embedded external bufffers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_sli_cfg_read_cmd_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">nemb_type</span> <span class="n">nemb_tp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="n">sli_cfg_mbx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="n">mbox_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">curr_dmabuf</span><span class="p">,</span> <span class="o">*</span><span class="n">next_dmabuf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ext_buf_cnt</span><span class="p">,</span> <span class="n">ext_buf_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">ext_dmabuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pmbx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mbox_req</span> <span class="o">=</span>
	   <span class="p">(</span><span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>

	<span class="cm">/* pointer to the start of mailbox command */</span>
	<span class="n">sli_cfg_mbx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nemb_tp</span> <span class="o">==</span> <span class="n">nemb_mse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext_buf_cnt</span> <span class="o">=</span> <span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_mse_cnt</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span><span class="n">sli_config_hdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_buf_cnt</span> <span class="o">&gt;</span> <span class="n">LPFC_MBX_SLI_CONFIG_MAX_MSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2945 Handled SLI_CONFIG(mse) rd, &quot;</span>
					<span class="s">&quot;ext_buf_cnt(%d) out of range(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ext_buf_cnt</span><span class="p">,</span>
					<span class="n">LPFC_MBX_SLI_CONFIG_MAX_MSE</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2941 Handled SLI_CONFIG(mse) rd, &quot;</span>
				<span class="s">&quot;ext_buf_cnt:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_buf_cnt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* sanity check on interface type for support */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_sli_intf_if_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sli_intf</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">LPFC_SLI_INTF_IF_TYPE_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* nemb_tp == nemb_hbd */</span>
		<span class="n">ext_buf_cnt</span> <span class="o">=</span> <span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span><span class="n">hbd_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_buf_cnt</span> <span class="o">&gt;</span> <span class="n">LPFC_MBX_SLI_CONFIG_MAX_HBD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2946 Handled SLI_CONFIG(hbd) rd, &quot;</span>
					<span class="s">&quot;ext_buf_cnt(%d) out of range(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ext_buf_cnt</span><span class="p">,</span>
					<span class="n">LPFC_MBX_SLI_CONFIG_MAX_HBD</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2942 Handled SLI_CONFIG(hbd) rd, &quot;</span>
				<span class="s">&quot;ext_buf_cnt:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_buf_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* before dma descriptor setup */</span>
	<span class="n">lpfc_idiag_mbxacc_dump_bsg_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="n">mbox_rd</span><span class="p">,</span> <span class="n">dma_mbox</span><span class="p">,</span>
					<span class="n">sta_pre_addr</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">,</span> <span class="n">ext_buf_cnt</span><span class="p">);</span>

	<span class="cm">/* reject non-embedded mailbox command with none external buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_buf_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ext_buf_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* additional external read buffers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ext_buf_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext_dmabuf</span> <span class="o">=</span> <span class="n">lpfc_bsg_dma_page_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext_dmabuf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext_dmabuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">ext_dmabuf_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* bsg tracking structure */</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* mailbox command structure for base driver */</span>
	<span class="n">pmboxq</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmboxq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="cm">/* for the first external buffer */</span>
	<span class="n">lpfc_bsg_sli_cfg_dma_desc_setup</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>

	<span class="cm">/* for the rest of external buffer descriptors if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_buf_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext_buf_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">curr_dmabuf</span><span class="p">,</span> <span class="n">next_dmabuf</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">ext_dmabuf_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_bsg_sli_cfg_dma_desc_setup</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span>
						<span class="n">ext_buf_index</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">,</span>
						<span class="n">curr_dmabuf</span><span class="p">);</span>
			<span class="n">ext_buf_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* after dma descriptor setup */</span>
	<span class="n">lpfc_idiag_mbxacc_dump_bsg_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="n">mbox_rd</span><span class="p">,</span> <span class="n">dma_mbox</span><span class="p">,</span>
					<span class="n">sta_pos_addr</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">,</span> <span class="n">ext_buf_cnt</span><span class="p">);</span>

	<span class="cm">/* construct base driver mbox command */</span>
	<span class="n">pmb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">pmbx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="n">pmbx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmb</span><span class="p">));</span>
	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>

	<span class="cm">/* multi-buffer handling context */</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span> <span class="o">=</span> <span class="n">nemb_tp</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mboxType</span> <span class="o">=</span> <span class="n">mbox_rd</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">numBuf</span> <span class="o">=</span> <span class="n">ext_buf_cnt</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbxTag</span> <span class="o">=</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extMboxTag</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span> <span class="o">=</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbx_dmabuf</span> <span class="o">=</span> <span class="n">dmabuf</span><span class="p">;</span>

	<span class="cm">/* callback for multi-buffer read mailbox command */</span>
	<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_bsg_issue_read_mbox_ext_cmpl</span><span class="p">;</span>

	<span class="cm">/* context fields to callback function */</span>
	<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_MBOX</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">pmboxq</span> <span class="o">=</span> <span class="n">pmboxq</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">mb</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAILBOX_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pmbx</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>

	<span class="cm">/* state change */</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPFC_BSG_MBOX_PORT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Non-embedded mailbox subcommand data gets byte swapped here because</span>
<span class="cm">	 * the lower level driver code only does the first 64 mailbox words.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_emb</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span><span class="n">sli_config_hdr</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">nemb_tp</span> <span class="o">==</span> <span class="n">nemb_mse</span><span class="p">))</span>
		<span class="n">lpfc_sli_pcimem_bcopy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmbx</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">)],</span>
			<span class="o">&amp;</span><span class="n">pmbx</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">)],</span>
				<span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
					<span class="n">mse</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf_len</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">MBX_NOWAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2947 Issued SLI_CONFIG ext-buffer &quot;</span>
				<span class="s">&quot;maibox command, rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SLI_CONFIG_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;2948 Failed to issue SLI_CONFIG ext-buffer &quot;</span>
			<span class="s">&quot;maibox command, rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>

<span class="nl">job_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmboxq</span><span class="p">)</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="n">lpfc_bsg_dma_page_list_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">ext_dmabuf_list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPFC_BSG_MBOX_IDLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_sli_cfg_write_cmd_ext - sli_config non-embedded mailbox cmd write</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @mb: Pointer to a BSG mailbox object.</span>
<span class="cm"> * @dmabuff: Pointer to a DMA buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine performs SLI_CONFIG (0x9B) write mailbox command operation with</span>
<span class="cm"> * non-embedded external bufffers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_sli_cfg_write_cmd_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">nemb_type</span> <span class="n">nemb_tp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="n">mbox_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="n">sli_cfg_mbx</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ext_buf_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">mbx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SLI_CONFIG_NOT_HANDLED</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mbox_req</span> <span class="o">=</span>
	   <span class="p">(</span><span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>

	<span class="cm">/* pointer to the start of mailbox command */</span>
	<span class="n">sli_cfg_mbx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nemb_tp</span> <span class="o">==</span> <span class="n">nemb_mse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext_buf_cnt</span> <span class="o">=</span> <span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_mse_cnt</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span><span class="n">sli_config_hdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_buf_cnt</span> <span class="o">&gt;</span> <span class="n">LPFC_MBX_SLI_CONFIG_MAX_MSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2953 Failed SLI_CONFIG(mse) wr, &quot;</span>
					<span class="s">&quot;ext_buf_cnt(%d) out of range(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ext_buf_cnt</span><span class="p">,</span>
					<span class="n">LPFC_MBX_SLI_CONFIG_MAX_MSE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2949 Handled SLI_CONFIG(mse) wr, &quot;</span>
				<span class="s">&quot;ext_buf_cnt:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_buf_cnt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* sanity check on interface type for support */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_sli_intf_if_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli4_hba</span><span class="p">.</span><span class="n">sli_intf</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">LPFC_SLI_INTF_IF_TYPE_2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="cm">/* nemb_tp == nemb_hbd */</span>
		<span class="n">ext_buf_cnt</span> <span class="o">=</span> <span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span><span class="n">hbd_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_buf_cnt</span> <span class="o">&gt;</span> <span class="n">LPFC_MBX_SLI_CONFIG_MAX_HBD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2954 Failed SLI_CONFIG(hbd) wr, &quot;</span>
					<span class="s">&quot;ext_buf_cnt(%d) out of range(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ext_buf_cnt</span><span class="p">,</span>
					<span class="n">LPFC_MBX_SLI_CONFIG_MAX_HBD</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2950 Handled SLI_CONFIG(hbd) wr, &quot;</span>
				<span class="s">&quot;ext_buf_cnt:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_buf_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* before dma buffer descriptor setup */</span>
	<span class="n">lpfc_idiag_mbxacc_dump_bsg_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="n">mbox_wr</span><span class="p">,</span> <span class="n">dma_mbox</span><span class="p">,</span>
					<span class="n">sta_pre_addr</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">,</span> <span class="n">ext_buf_cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_buf_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* for the first external buffer */</span>
	<span class="n">lpfc_bsg_sli_cfg_dma_desc_setup</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>

	<span class="cm">/* after dma descriptor setup */</span>
	<span class="n">lpfc_idiag_mbxacc_dump_bsg_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="n">mbox_wr</span><span class="p">,</span> <span class="n">dma_mbox</span><span class="p">,</span>
					<span class="n">sta_pos_addr</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">,</span> <span class="n">ext_buf_cnt</span><span class="p">);</span>

	<span class="cm">/* log for looking forward */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ext_buf_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nemb_tp</span> <span class="o">==</span> <span class="n">nemb_mse</span><span class="p">)</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2951 SLI_CONFIG(mse), buf[%d]-length:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span>
				<span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2952 SLI_CONFIG(hbd), buf[%d]-length:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_sli_config_ecmn_hbd_len</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span>
				<span class="n">hbd</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="cm">/* multi-buffer handling context */</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span> <span class="o">=</span> <span class="n">nemb_tp</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mboxType</span> <span class="o">=</span> <span class="n">mbox_wr</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">numBuf</span> <span class="o">=</span> <span class="n">ext_buf_cnt</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbxTag</span> <span class="o">=</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extMboxTag</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span> <span class="o">=</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbx_dmabuf</span> <span class="o">=</span> <span class="n">dmabuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_buf_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* bsg tracking structure */</span>
		<span class="n">dd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* mailbox command structure for base driver */</span>
		<span class="n">pmboxq</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmboxq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
		<span class="n">pmb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
		<span class="n">mbx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="n">mbx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmb</span><span class="p">));</span>
		<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>

		<span class="cm">/* callback for multi-buffer read mailbox command */</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_bsg_issue_write_mbox_ext_cmpl</span><span class="p">;</span>

		<span class="cm">/* context fields to callback function */</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_MBOX</span><span class="p">;</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">pmboxq</span> <span class="o">=</span> <span class="n">pmboxq</span><span class="p">;</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">mb</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAILBOX_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mbx</span><span class="p">;</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>

		<span class="cm">/* state change */</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPFC_BSG_MBOX_PORT</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">MBX_NOWAIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2955 Issued SLI_CONFIG ext-buffer &quot;</span>
					<span class="s">&quot;maibox command, rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">SLI_CONFIG_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2956 Failed to issue SLI_CONFIG ext-buffer &quot;</span>
				<span class="s">&quot;maibox command, rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wait for additoinal external buffers */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SLI_CONFIG_HANDLED</span><span class="p">;</span>

<span class="nl">job_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmboxq</span><span class="p">)</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_handle_sli_cfg_mbox - handle sli-cfg mailbox cmd with ext buffer</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @mb: Pointer to a BSG mailbox object.</span>
<span class="cm"> * @dmabuff: Pointer to a DMA buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine handles SLI_CONFIG (0x9B) mailbox command with non-embedded</span>
<span class="cm"> * external bufffers, including both 0x9B with non-embedded MSEs and 0x9B</span>
<span class="cm"> * with embedded sussystem 0x1 and opcodes with external HBDs.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_handle_sli_cfg_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="n">sli_cfg_mbx</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">subsys</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SLI_CONFIG_NOT_HANDLED</span><span class="p">;</span>

	<span class="cm">/* state change on new multi-buffer pass-through mailbox command */</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPFC_BSG_MBOX_HOST</span><span class="p">;</span>

	<span class="n">sli_cfg_mbx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_emb</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span><span class="n">sli_config_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_emb0_subcmnd_subsys</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">);</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_emb0_subcmnd_opcode</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsys</span> <span class="o">==</span> <span class="n">SLI_CONFIG_SUBSYS_FCOE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FCOE_OPCODE_READ_FCF</span>:
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
						<span class="s">&quot;2957 Handled SLI_CONFIG &quot;</span>
						<span class="s">&quot;subsys_fcoe, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">opcode</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_sli_cfg_read_cmd_ext</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
							<span class="n">nemb_mse</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FCOE_OPCODE_ADD_FCF</span>:
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
						<span class="s">&quot;2958 Handled SLI_CONFIG &quot;</span>
						<span class="s">&quot;subsys_fcoe, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">opcode</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_sli_cfg_write_cmd_ext</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
							<span class="n">nemb_mse</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
						<span class="s">&quot;2959 Reject SLI_CONFIG &quot;</span>
						<span class="s">&quot;subsys_fcoe, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">opcode</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">subsys</span> <span class="o">==</span> <span class="n">SLI_CONFIG_SUBSYS_COMN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">COMN_OPCODE_GET_CNTL_ADDL_ATTRIBUTES</span>:
			<span class="k">case</span> <span class="n">COMN_OPCODE_GET_CNTL_ATTRIBUTES</span>:
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
						<span class="s">&quot;3106 Handled SLI_CONFIG &quot;</span>
						<span class="s">&quot;subsys_comn, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">opcode</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_sli_cfg_read_cmd_ext</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
							<span class="n">nemb_mse</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
						<span class="s">&quot;3107 Reject SLI_CONFIG &quot;</span>
						<span class="s">&quot;subsys_comn, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">opcode</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2977 Reject SLI_CONFIG &quot;</span>
					<span class="s">&quot;subsys:x%d, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">subsys</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_emb1_subcmnd_subsys</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">);</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_emb1_subcmnd_opcode</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsys</span> <span class="o">==</span> <span class="n">SLI_CONFIG_SUBSYS_COMN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">COMN_OPCODE_READ_OBJECT</span>:
			<span class="k">case</span> <span class="n">COMN_OPCODE_READ_OBJECT_LIST</span>:
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
						<span class="s">&quot;2960 Handled SLI_CONFIG &quot;</span>
						<span class="s">&quot;subsys_comn, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">opcode</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_sli_cfg_read_cmd_ext</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
							<span class="n">nemb_hbd</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">COMN_OPCODE_WRITE_OBJECT</span>:
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
						<span class="s">&quot;2961 Handled SLI_CONFIG &quot;</span>
						<span class="s">&quot;subsys_comn, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">opcode</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_sli_cfg_write_cmd_ext</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
							<span class="n">nemb_hbd</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
						<span class="s">&quot;2962 Not handled SLI_CONFIG &quot;</span>
						<span class="s">&quot;subsys_comn, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">opcode</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">SLI_CONFIG_NOT_HANDLED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2978 Not handled SLI_CONFIG &quot;</span>
					<span class="s">&quot;subsys:x%d, opcode:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">subsys</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">SLI_CONFIG_NOT_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* state reset on not handled new multi-buffer mailbox command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SLI_CONFIG_HANDLED</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPFC_BSG_MBOX_IDLE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_mbox_ext_abort_req - request to abort mbox command with ext buffers</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is for requesting to abort a pass-through mailbox command with</span>
<span class="cm"> * multiple external buffers due to error condition.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_mbox_ext_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPFC_BSG_MBOX_PORT</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPFC_BSG_MBOX_ABTS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lpfc_bsg_mbox_ext_session_reset</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_read_ebuf_get - get the next mailbox read external buffer</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @dmabuf: Pointer to a DMA buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine extracts the next mailbox read external buffer back to</span>
<span class="cm"> * user space through BSG.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_read_ebuf_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="n">sli_cfg_mbx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span><span class="o">++</span><span class="p">;</span>

	<span class="n">sli_cfg_mbx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbx_dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span> <span class="o">==</span> <span class="n">nemb_mse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_sli_config_mse_len</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb0_subsys</span><span class="p">.</span><span class="n">mse</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2963 SLI_CONFIG (mse) ext-buffer rd get &quot;</span>
				<span class="s">&quot;buffer[%d], size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">bsg_bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_sli_config_ecmn_hbd_len</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sli_cfg_mbx</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">sli_config_emb1_subsys</span><span class="p">.</span><span class="n">hbd</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2964 SLI_CONFIG (hbd) ext-buffer rd get &quot;</span>
				<span class="s">&quot;buffer[%d], size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">ext_dmabuf_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">ext_dmabuf_list</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/* after dma buffer descriptor setup */</span>
	<span class="n">lpfc_idiag_mbxacc_dump_bsg_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span><span class="p">,</span>
					<span class="n">mbox_rd</span><span class="p">,</span> <span class="n">dma_ebuf</span><span class="p">,</span> <span class="n">sta_pos_addr</span><span class="p">,</span>
					<span class="n">dmabuf</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">pbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
		<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				    <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
				    <span class="n">pbuf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">lpfc_bsg_dma_page_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">numBuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2965 SLI_CONFIG (hbd) ext-buffer rd mbox &quot;</span>
				<span class="s">&quot;command session done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lpfc_bsg_mbox_ext_session_reset</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SLI_CONFIG_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_write_ebuf_set - set the next mailbox write external buffer</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @dmabuf: Pointer to a DMA buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine sets up the next mailbox read external buffer obtained</span>
<span class="cm"> * from user space through BSG.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_write_ebuf_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="n">sli_cfg_mbx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nemb_type</span> <span class="n">nemb_tp</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nemb_tp</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span><span class="p">;</span>

	<span class="n">sli_cfg_mbx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_sli_config_mbox</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbx_dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>

	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
	<span class="n">sg_copy_to_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
			  <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
			  <span class="n">pbuf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span> <span class="o">==</span> <span class="n">nemb_mse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2966 SLI_CONFIG (mse) ext-buffer wr set &quot;</span>
				<span class="s">&quot;buffer[%d], size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2967 SLI_CONFIG (hbd) ext-buffer wr set &quot;</span>
				<span class="s">&quot;buffer[%d], size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* set up external buffer descriptor and add to external buffer list */</span>
	<span class="n">lpfc_bsg_sli_cfg_dma_desc_setup</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">nemb_tp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbx_dmabuf</span><span class="p">,</span>
					<span class="n">dmabuf</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">ext_dmabuf_list</span><span class="p">);</span>

	<span class="cm">/* after write dma buffer */</span>
	<span class="n">lpfc_idiag_mbxacc_dump_bsg_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">nembType</span><span class="p">,</span>
					<span class="n">mbox_wr</span><span class="p">,</span> <span class="n">dma_ebuf</span><span class="p">,</span> <span class="n">sta_pos_addr</span><span class="p">,</span>
					<span class="n">dmabuf</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">numBuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2968 SLI_CONFIG ext-buffer wr all %d &quot;</span>
				<span class="s">&quot;ebuffers received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">numBuf</span><span class="p">);</span>
		<span class="cm">/* mailbox command structure for base driver */</span>
		<span class="n">pmboxq</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmboxq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>
		<span class="n">pbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbx_dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
		<span class="n">pmb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmb</span><span class="p">));</span>
		<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>

		<span class="cm">/* callback for multi-buffer write mailbox command */</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_bsg_issue_write_mbox_ext_cmpl</span><span class="p">;</span>

		<span class="cm">/* context fields to callback function */</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_MBOX</span><span class="p">;</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">pmboxq</span> <span class="o">=</span> <span class="n">pmboxq</span><span class="p">;</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">mb</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAILBOX_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pbuf</span><span class="p">;</span>
		<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>

		<span class="cm">/* state change */</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPFC_BSG_MBOX_PORT</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">MBX_NOWAIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2969 Issued SLI_CONFIG ext-buffer &quot;</span>
					<span class="s">&quot;maibox command, rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">SLI_CONFIG_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2970 Failed to issue SLI_CONFIG ext-buffer &quot;</span>
				<span class="s">&quot;maibox command, rc:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wait for additoinal external buffers */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SLI_CONFIG_HANDLED</span><span class="p">;</span>

<span class="nl">job_error:</span>
	<span class="n">lpfc_bsg_dma_page_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_handle_sli_cfg_ebuf - handle ext buffer with sli-cfg mailbox cmd</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @mb: Pointer to a BSG mailbox object.</span>
<span class="cm"> * @dmabuff: Pointer to a DMA buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine handles the external buffer with SLI_CONFIG (0x9B) mailbox</span>
<span class="cm"> * command with multiple non-embedded external buffers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_handle_sli_cfg_ebuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;2971 SLI_CONFIG buffer (type:x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mboxType</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mboxType</span> <span class="o">==</span> <span class="n">mbox_rd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LPFC_BSG_MBOX_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2972 SLI_CONFIG rd buffer state &quot;</span>
					<span class="s">&quot;mismatch:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
			<span class="n">lpfc_bsg_mbox_ext_abort</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_read_ebuf_get</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">SLI_CONFIG_HANDLED</span><span class="p">)</span>
			<span class="n">lpfc_bsg_dma_page_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* phba-&gt;mbox_ext_buf_ctx.mboxType == mbox_wr */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LPFC_BSG_MBOX_HOST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2973 SLI_CONFIG wr buffer state &quot;</span>
					<span class="s">&quot;mismatch:x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
			<span class="n">lpfc_bsg_mbox_ext_abort</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_write_ebuf_set</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_handle_sli_cfg_ext - handle sli-cfg mailbox with external buffer</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @mb: Pointer to a BSG mailbox object.</span>
<span class="cm"> * @dmabuff: Pointer to a DMA buffer descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine checkes and handles non-embedded multi-buffer SLI_CONFIG</span>
<span class="cm"> * (0x9B) mailbox commands and external buffers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_handle_sli_cfg_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="n">mbox_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SLI_CONFIG_NOT_HANDLED</span><span class="p">;</span>

	<span class="n">mbox_req</span> <span class="o">=</span>
	   <span class="p">(</span><span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>

	<span class="cm">/* mbox command with/without single external buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extMboxTag</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* mbox command and first external buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPFC_BSG_MBOX_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
					<span class="s">&quot;2974 SLI_CONFIG mailbox: tag:%d, &quot;</span>
					<span class="s">&quot;seq:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extMboxTag</span><span class="p">,</span>
					<span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_handle_sli_cfg_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">sli_cfg_ext_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * handle additional external buffers</span>
<span class="cm">	 */</span>

	<span class="cm">/* check broken pipe conditions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extMboxTag</span> <span class="o">!=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbxTag</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sli_cfg_ext_error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span> <span class="o">&gt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">numBuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sli_cfg_ext_error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span> <span class="o">!=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sli_cfg_ext_error</span><span class="p">;</span>

	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;2975 SLI_CONFIG mailbox external buffer: &quot;</span>
			<span class="s">&quot;extSta:x%x, tag:%d, seq:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extMboxTag</span><span class="p">,</span>
			<span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_handle_sli_cfg_ebuf</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">sli_cfg_ext_error:</span>
	<span class="cm">/* all other cases, broken pipe */</span>
	<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
			<span class="s">&quot;2976 SLI_CONFIG mailbox broken pipe: &quot;</span>
			<span class="s">&quot;ctxSta:x%x, ctxNumBuf:%d &quot;</span>
			<span class="s">&quot;ctxTag:%d, ctxSeq:%d, tag:%d, seq:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">numBuf</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">mbxTag</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">seqNum</span><span class="p">,</span>
			<span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extMboxTag</span><span class="p">,</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span><span class="p">);</span>

	<span class="n">lpfc_bsg_mbox_ext_session_reset</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_issue_mbox - issues a mailbox command on behalf of an app</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @mb: Pointer to a mailbox object.</span>
<span class="cm"> * @vport: Pointer to a vport object.</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate a tracking object, mailbox command memory, get a mailbox</span>
<span class="cm"> * from the mailbox pool, copy the caller mailbox command.</span>
<span class="cm"> *</span>
<span class="cm"> * If offline and the sli is active we need to poll for the command (port is</span>
<span class="cm"> * being reset) and com-plete the job, otherwise issue the mailbox command and</span>
<span class="cm"> * let our completion handler finish the command.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">lpfc_bsg_issue_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LPFC_MBOXQ_t</span> <span class="o">*</span><span class="n">pmboxq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* internal mailbox queue */</span>
	<span class="n">MAILBOX_t</span> <span class="o">*</span><span class="n">pmb</span><span class="p">;</span> <span class="cm">/* shortcut to the pmboxq mailbox */</span>
	<span class="cm">/* a 4k buffer to hold the mb and extended data from/to the bsg */</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pmbx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* bsg data tracking structure */</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="n">mbox_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">READ_EVENT_LOG_VAR</span> <span class="o">*</span><span class="n">rdEventLog</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">transmit_length</span><span class="p">,</span> <span class="n">receive_length</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_sli4_config</span> <span class="o">*</span><span class="n">sli4_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_mbx_nembed_cmd</span> <span class="o">*</span><span class="n">nembed_sge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mbox_header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bde</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>


	<span class="cm">/* in case no data is transferred */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* sanity check to protect driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span> <span class="o">&gt;</span> <span class="n">BSG_MBOX_SIZE</span> <span class="o">||</span>
	    <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span> <span class="o">&gt;</span> <span class="n">BSG_MBOX_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t allow mailbox commands to be sent when blocked or when in</span>
<span class="cm">	 * the middle of discovery</span>
<span class="cm">	 */</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">sli_flag</span> <span class="o">&amp;</span> <span class="n">LPFC_BLOCK_MGMT_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mbox_req</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>

	<span class="cm">/* check if requested extended data lengths are valid */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">inExtWLen</span> <span class="o">&gt;</span> <span class="n">BSG_MBOX_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">outExtWLen</span> <span class="o">&gt;</span> <span class="n">BSG_MBOX_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmabuf</span> <span class="o">=</span> <span class="n">lpfc_bsg_dma_page_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmabuf</span> <span class="o">||</span> <span class="o">!</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the mailbox command or external buffer from BSG */</span>
	<span class="n">pmbx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
	<span class="n">sg_copy_to_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
			  <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">pmbx</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Handle possible SLI_CONFIG with non-embedded payloads */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_handle_sli_cfg_ext</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">SLI_CONFIG_HANDLED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">job_cont</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
		<span class="cm">/* SLI_CONFIG_NOT_HANDLED for other mailbox commands */</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_check_cmd_access</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="p">(</span><span class="n">MAILBOX_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pmbx</span><span class="p">,</span> <span class="n">vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span> <span class="cm">/* must be negative */</span>

	<span class="cm">/* allocate our bsg tracking structure */</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2727 Failed allocation of dd_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pmboxq</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmboxq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LPFC_MBOXQ_t</span><span class="p">));</span>

	<span class="n">pmb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pmb</span><span class="p">,</span> <span class="n">pmbx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmb</span><span class="p">));</span>
	<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxOwner</span> <span class="o">=</span> <span class="n">OWN_HOST</span><span class="p">;</span>
	<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">vport</span><span class="p">;</span>

	<span class="cm">/* If HBA encountered an error attention, allow only DUMP</span>
<span class="cm">	 * or RESTART mailbox commands until the HBA is restarted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">!=</span> <span class="n">MBX_DUMP_MEMORY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">!=</span> <span class="n">MBX_RESTART</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">!=</span> <span class="n">MBX_WRITE_VPARMS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">!=</span> <span class="n">MBX_WRITE_WWN</span><span class="p">)</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_MBOX</span><span class="p">,</span>
				<span class="s">&quot;2797 mbox: Issued mailbox cmd &quot;</span>
				<span class="s">&quot;0x%x while in stopped state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span><span class="p">);</span>

	<span class="cm">/* extended mailbox commands will need an extended buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">inExtWLen</span> <span class="o">||</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">outExtWLen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">from</span> <span class="o">=</span> <span class="n">pmbx</span><span class="p">;</span>
		<span class="n">ext</span> <span class="o">=</span> <span class="n">from</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">);</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="n">ext</span><span class="p">;</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">in_ext_byte_len</span> <span class="o">=</span>
			<span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">inExtWLen</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">out_ext_byte_len</span> <span class="o">=</span>
			<span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">outExtWLen</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">mbox_offset_word</span> <span class="o">=</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">mbOffset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* biu diag will need a kernel buffer to transfer the data</span>
<span class="cm">	 * allocate our own buffer and setup the mailbox command to</span>
<span class="cm">	 * use ours</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">==</span> <span class="n">MBX_RUN_BIU_DIAG64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">transmit_length</span> <span class="o">=</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">receive_length</span> <span class="o">=</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="cm">/* transmit length cannot be greater than receive length or</span>
<span class="cm">		 * mailbox extension size</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">transmit_length</span> <span class="o">&gt;</span> <span class="n">receive_length</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">transmit_length</span> <span class="o">&gt;</span> <span class="n">BSG_MBOX_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varBIUdiag</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">xmit_bde64</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span>
			<span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
		<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varBIUdiag</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">xmit_bde64</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span>
			<span class="n">putPaddrLow</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>

		<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varBIUdiag</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">rcv_bde64</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span>
			<span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">)</span>
			  <span class="o">+</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varBIUdiag</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">xmit_bde64</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">);</span>
		<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varBIUdiag</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">rcv_bde64</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span>
			<span class="n">putPaddrLow</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">)</span>
			  <span class="o">+</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varBIUdiag</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">xmit_bde64</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">==</span> <span class="n">MBX_READ_EVENT_LOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdEventLog</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varRdEventLog</span><span class="p">;</span>
		<span class="n">receive_length</span> <span class="o">=</span> <span class="n">rdEventLog</span><span class="o">-&gt;</span><span class="n">rcv_bde64</span><span class="p">.</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_event_log</span><span class="p">,</span> <span class="n">rdEventLog</span><span class="p">);</span>

		<span class="cm">/* receive length cannot be greater than mailbox</span>
<span class="cm">		 * extension size</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">receive_length</span> <span class="o">&gt;</span> <span class="n">BSG_MBOX_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* mode zero uses a bde like biu diags command */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span>
							<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
			<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span>
							<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli_rev</span> <span class="o">==</span> <span class="n">LPFC_SLI_REV4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Let type 4 (well known data) through because the data is</span>
<span class="cm">		 * returned in varwords[4-8]</span>
<span class="cm">		 * otherwise check the recieve length and fetch the buffer addr</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">==</span> <span class="n">MBX_DUMP_MEMORY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varDmp</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">DMP_WELL_KNOWN</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* rebuild the command for sli4 using our own buffers</span>
<span class="cm">			* like we do for biu diags</span>
<span class="cm">			*/</span>
			<span class="n">receive_length</span> <span class="o">=</span> <span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="cm">/* receive length cannot be greater than mailbox</span>
<span class="cm">			 * extension size</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">receive_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span>
						<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
			<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span>
						<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">==</span> <span class="n">MBX_UPDATE_CFG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varUpdateCfg</span><span class="p">.</span><span class="n">co</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bde</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

			<span class="cm">/* bde size cannot be greater than mailbox ext size */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bde</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">&gt;</span>
			    <span class="n">BSG_MBOX_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bde</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span>
						<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
			<span class="n">bde</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span>
						<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">mbxCommand</span> <span class="o">==</span> <span class="n">MBX_SLI4_CONFIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Handling non-embedded SLI_CONFIG mailbox command */</span>
			<span class="n">sli4_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mqe</span><span class="p">.</span><span class="n">un</span><span class="p">.</span><span class="n">sli4_config</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf_get</span><span class="p">(</span><span class="n">lpfc_mbox_hdr_emb</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">sli4_config</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">cfg_mhdr</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* rebuild the command for sli4 using our</span>
<span class="cm">				 * own buffers like we do for biu diags</span>
<span class="cm">				 */</span>
				<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mbox_header</span> <span class="o">*</span><span class="p">)</span>
						<span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">nembed_sge</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_mbx_nembed_cmd</span> <span class="o">*</span><span class="p">)</span>
						<span class="o">&amp;</span><span class="n">pmb</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">varWords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">receive_length</span> <span class="o">=</span> <span class="n">nembed_sge</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>

				<span class="cm">/* receive length cannot be greater than</span>
<span class="cm">				 * mailbox extension size</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">receive_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">receive_length</span> <span class="o">&gt;</span>
				     <span class="n">BSG_MBOX_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">nembed_sge</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pa_hi</span> <span class="o">=</span>
						<span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span>
						   <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
				<span class="n">nembed_sge</span><span class="o">-&gt;</span><span class="n">sge</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pa_lo</span> <span class="o">=</span>
						<span class="n">putPaddrLow</span><span class="p">(</span><span class="n">dmabuf</span><span class="o">-&gt;</span><span class="n">phys</span>
						   <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAILBOX_t</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">dmabuffers</span> <span class="o">=</span> <span class="n">dmabuf</span><span class="p">;</span>

	<span class="cm">/* setup wake call as IOCB callback */</span>
	<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">mbox_cmpl</span> <span class="o">=</span> <span class="n">lpfc_bsg_issue_mbox_cmpl</span><span class="p">;</span>

	<span class="cm">/* setup context field to pass wait_queue pointer to wake function */</span>
	<span class="n">pmboxq</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_MBOX</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">pmboxq</span> <span class="o">=</span> <span class="n">pmboxq</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">mb</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAILBOX_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pmbx</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">mbOffset</span> <span class="o">=</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">mbOffset</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">inExtWLen</span> <span class="o">=</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">inExtWLen</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">.</span><span class="n">outExtWLen</span> <span class="o">=</span> <span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">outExtWLen</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vport</span><span class="o">-&gt;</span><span class="n">fc_flag</span> <span class="o">&amp;</span> <span class="n">FC_OFFLINE_MODE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">sli_flag</span> <span class="o">&amp;</span> <span class="n">LPFC_SLI_ACTIVE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">MBX_POLL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_TIMEOUT</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ETIME</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* job finished, copy the data */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pmbx</span><span class="p">,</span> <span class="n">pmb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmb</span><span class="p">));</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
					    <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
					    <span class="n">pmbx</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="cm">/* not waiting mbox already done */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">job_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pmboxq</span><span class="p">,</span> <span class="n">MBX_NOWAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">MBX_BUSY</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* job started */</span>

<span class="nl">job_done:</span>
	<span class="cm">/* common exit for error or job completed inline */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmboxq</span><span class="p">)</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">pmboxq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_mem_pool</span><span class="p">);</span>
	<span class="n">lpfc_bsg_dma_page_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>

<span class="nl">job_cont:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_mbox_cmd - process an fc bsg LPFC_BSG_VENDOR_MBOX command</span>
<span class="cm"> * @job: MBOX fc_bsg_job for LPFC_BSG_VENDOR_MBOX.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_mbox_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="n">mbox_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* mix-and-match backward compatibility */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dfc_mbox_req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2737 Mix-and-match backward compability &quot;</span>
				<span class="s">&quot;between MBOX_REQ old size:%d and &quot;</span>
				<span class="s">&quot;new request size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">-</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)),</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dfc_mbox_req</span><span class="p">));</span>
		<span class="n">mbox_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dfc_mbox_req</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>
		<span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extMboxTag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mbox_req</span><span class="o">-&gt;</span><span class="n">extSeqNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_issue_mbox</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* job done */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="cm">/* job submitted, will complete later*/</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* return zero, no error */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* some error occurred */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_menlo_cmd_cmp - lpfc_menlo_cmd completion handler</span>
<span class="cm"> * @phba: Pointer to HBA context object.</span>
<span class="cm"> * @cmdiocbq: Pointer to command iocb.</span>
<span class="cm"> * @rspiocbq: Pointer to response iocb.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the completion handler for iocbs issued using</span>
<span class="cm"> * lpfc_menlo_cmd function. This function is called by the</span>
<span class="cm"> * ring event handler function without any lock held. This function</span>
<span class="cm"> * can be called from both worker thread context and interrupt</span>
<span class="cm"> * context. This function also can be called from another thread which</span>
<span class="cm"> * cleans up the SLI layer objects.</span>
<span class="cm"> * This function copies the contents of the response iocb to the</span>
<span class="cm"> * response iocb memory object provided by the caller of</span>
<span class="cm"> * lpfc_sli_issue_iocb_wait and then wakes up the thread which</span>
<span class="cm"> * sleeps for the iocb completion.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lpfc_bsg_menlo_cmd_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">rspiocbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_menlo</span> <span class="o">*</span><span class="n">menlo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">menlo_response</span> <span class="o">*</span><span class="n">menlo_resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">menlo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">menlo</span><span class="p">;</span>
	<span class="n">job</span> <span class="o">=</span> <span class="n">menlo</span><span class="o">-&gt;</span><span class="n">set_job</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* so timeout handler does not reply */</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_flag</span> <span class="o">|=</span> <span class="n">LPFC_IO_WAKE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">&amp;&amp;</span> <span class="n">rspiocbq</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="p">)</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCB_t</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>

	<span class="n">bmp</span> <span class="o">=</span> <span class="n">menlo</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">;</span>
	<span class="n">rspiocbq</span> <span class="o">=</span> <span class="n">menlo</span><span class="o">-&gt;</span><span class="n">rspiocbq</span><span class="p">;</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>

	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="cm">/* always return the xri, this would be used in the case</span>
<span class="cm">	 * of a menlo download to allow the data to be sent as a continuation</span>
<span class="cm">	 * of the exchange.</span>
<span class="cm">	 */</span>
	<span class="n">menlo_resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">menlo_response</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_data</span><span class="p">.</span><span class="n">vendor_reply</span><span class="p">.</span><span class="n">vendor_rsp</span><span class="p">;</span>
	<span class="n">menlo_resp</span><span class="o">-&gt;</span><span class="n">xri</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpContext</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">ulpStatus</span> <span class="o">==</span> <span class="n">IOSTAT_LOCAL_REJECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IOERR_SEQUENCE_TIMEOUT</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IOERR_INVALID_RPI</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
			<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span><span class="p">;</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rspiocbq</span><span class="p">);</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bmp</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* complete the job back to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_menlo_cmd - send an ioctl for menlo hardware</span>
<span class="cm"> * @job: fc_bsg_job to handle</span>
<span class="cm"> *</span>
<span class="cm"> * This function issues a gen request 64 CR ioctl for all menlo cmd requests,</span>
<span class="cm"> * all the command completions will return the xri for the command.</span>
<span class="cm"> * For menlo data requests a gen request 64 CX is used to continue the exchange</span>
<span class="cm"> * supplied in the menlo request header xri field.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_menlo_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocbq</span><span class="p">,</span> <span class="o">*</span><span class="n">rspiocbq</span><span class="p">;</span>
	<span class="n">IOCB_t</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">menlo_command</span> <span class="o">*</span><span class="n">menlo_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">menlo_response</span> <span class="o">*</span><span class="n">menlo_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_dmabuf</span> <span class="o">*</span><span class="n">bmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_nseg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reply_nseg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numbde</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">busaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="n">bpl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* in case no data is returned return just the return code */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_len</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">menlo_command</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2784 Received MENLO_CMD request below &quot;</span>
				<span class="s">&quot;minimum size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_dd_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">menlo_response</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2785 Received MENLO_CMD reply below &quot;</span>
				<span class="s">&quot;minimum size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_dd_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">menlo_flag</span> <span class="o">&amp;</span> <span class="n">HBA_MENLO_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2786 Adapter does not support menlo &quot;</span>
				<span class="s">&quot;commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_dd_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">menlo_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">menlo_command</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">;</span>

	<span class="n">menlo_resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">menlo_response</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_data</span><span class="p">.</span><span class="n">vendor_reply</span><span class="p">.</span><span class="n">vendor_rsp</span><span class="p">;</span>

	<span class="cm">/* allocate our bsg tracking structure */</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lpfc_printf_log</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">LOG_LIBDFC</span><span class="p">,</span>
				<span class="s">&quot;2787 Failed allocation of dd_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_dd_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_dmabuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_dd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdiocbq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_bmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rspiocbq</span> <span class="o">=</span> <span class="n">lpfc_sli_get_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rspiocbq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_cmdiocbq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rspiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>

	<span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">=</span> <span class="n">lpfc_mbuf_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_rspiocbq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span> <span class="o">*</span><span class="p">)</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">request_nseg</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				  <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sgel</span><span class="p">,</span> <span class="n">request_nseg</span><span class="p">,</span> <span class="n">numbde</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64</span><span class="p">;</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply_nseg</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span> <span class="n">sgel</span><span class="p">,</span> <span class="n">reply_nseg</span><span class="p">,</span> <span class="n">numbde</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BDE_64I</span><span class="p">;</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgel</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bpl</span><span class="o">-&gt;</span><span class="n">tus</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrLow</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">-&gt;</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">busaddr</span><span class="p">));</span>
		<span class="n">bpl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">ulpIoTag32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">putPaddrHigh</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">putPaddrLow</span><span class="p">(</span><span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeFlags</span> <span class="o">=</span> <span class="n">BUFF_TYPE_BLP_64</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">bdl</span><span class="p">.</span><span class="n">bdeSize</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">request_nseg</span> <span class="o">+</span> <span class="n">reply_nseg</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ulp_bde64</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Fctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">SI</span> <span class="o">|</span> <span class="n">LA</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Dfctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Rctl</span> <span class="o">=</span> <span class="n">FC_RCTL_DD_UNSOL_CMD</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">genreq64</span><span class="p">.</span><span class="n">w5</span><span class="p">.</span><span class="n">hcsw</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">MENLO_TRANSPORT_TYPE</span><span class="p">;</span> <span class="cm">/* 0xfe */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpBdeCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpClass</span> <span class="o">=</span> <span class="n">CLASS3</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpOwner</span> <span class="o">=</span> <span class="n">OWN_CHIP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpLe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Limited Edition */</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_flag</span> <span class="o">|=</span> <span class="n">LPFC_IO_LIBDFC</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pport</span><span class="p">;</span>
	<span class="cm">/* We want the firmware to timeout before we do */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpTimeout</span> <span class="o">=</span> <span class="n">MENLO_TIMEOUT</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context3</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="n">rspiocbq</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">iocb_cmpl</span> <span class="o">=</span> <span class="n">lpfc_bsg_menlo_cmd_cmp</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context1</span> <span class="o">=</span> <span class="n">dd_data</span><span class="p">;</span>
	<span class="n">cmdiocbq</span><span class="o">-&gt;</span><span class="n">context2</span> <span class="o">=</span> <span class="n">rspiocbq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">menlo_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">LPFC_BSG_VENDOR_MENLO_CMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpCommand</span> <span class="o">=</span> <span class="n">CMD_GEN_REQUEST64_CR</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpPU</span> <span class="o">=</span> <span class="n">MENLO_PU</span><span class="p">;</span> <span class="cm">/* 3 */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">MENLO_DID</span><span class="p">;</span> <span class="cm">/* 0x0000FC0E */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">MENLO_CONTEXT</span><span class="p">;</span> <span class="cm">/* 0 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpCommand</span> <span class="o">=</span> <span class="n">CMD_GEN_REQUEST64_CX</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpPU</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">ulpWord</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ulpContext</span> <span class="o">=</span> <span class="n">menlo_cmd</span><span class="o">-&gt;</span><span class="n">xri</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_MENLO</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">menlo</span><span class="p">.</span><span class="n">cmdiocbq</span> <span class="o">=</span> <span class="n">cmdiocbq</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">menlo</span><span class="p">.</span><span class="n">rspiocbq</span> <span class="o">=</span> <span class="n">rspiocbq</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">menlo</span><span class="p">.</span><span class="n">set_job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
	<span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">menlo</span><span class="p">.</span><span class="n">bmp</span> <span class="o">=</span> <span class="n">bmp</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli_issue_iocb</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">LPFC_ELS_RING</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">,</span>
		<span class="n">MENLO_TIMEOUT</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IOCB_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* done for now */</span>

	<span class="cm">/* iocb failed so cleanup */</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
		     <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">lpfc_mbuf_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">,</span> <span class="n">bmp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

<span class="nl">free_rspiocbq:</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">rspiocbq</span><span class="p">);</span>
<span class="nl">free_cmdiocbq:</span>
	<span class="n">lpfc_sli_release_iocbq</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cmdiocbq</span><span class="p">);</span>
<span class="nl">free_bmp:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bmp</span><span class="p">);</span>
<span class="nl">free_dd:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd_data</span><span class="p">);</span>
<span class="nl">no_dd_data:</span>
	<span class="cm">/* make error code available to userspace */</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_hst_vendor - process a vendor-specific fc_bsg_job</span>
<span class="cm"> * @job: fc_bsg_job to handle</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lpfc_bsg_hst_vendor</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">command</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_vendor</span><span class="p">.</span><span class="n">vendor_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_SET_CT_EVENT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_hba_set_event</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_GET_CT_EVENT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_hba_get_event</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_SEND_MGMT_RESP</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_send_mgmt_rsp</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_DIAG_MODE</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_diag_loopback_mode</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_DIAG_MODE_END</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_bsg_diag_mode_end</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_DIAG_RUN_LOOPBACK</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_diag_loopback_run</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_LINK_DIAG_TEST</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_sli4_bsg_link_diag_test</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_GET_MGMT_REV</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_get_dfc_rev</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_MBOX</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_mbox_cmd</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_MENLO_CMD</span>:
	<span class="k">case</span> <span class="n">LPFC_BSG_VENDOR_MENLO_DATA</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_menlo_cmd</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* make error code available to userspace */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_request - handle a bsg request from the FC transport</span>
<span class="cm"> * @job: fc_bsg_job to handle</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_bsg_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">msgcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">msgcode</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">msgcode</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">msgcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_BSG_HST_VENDOR</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_hst_vendor</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_BSG_RPT_ELS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_rport_els</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FC_BSG_RPT_CT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">lpfc_bsg_send_mgmt_cmd</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* make error code available to userspace */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lpfc_bsg_timeout - handle timeout of a bsg request from the FC transport</span>
<span class="cm"> * @job: fc_bsg_job that has timed out</span>
<span class="cm"> *</span>
<span class="cm"> * This function just aborts the job&#39;s IOCB.  The aborted IOCB will return to</span>
<span class="cm"> * the waiting function which will handle passing the error back to userspace</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">lpfc_bsg_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lpfc_vport</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">vport</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_iocbq</span> <span class="o">*</span><span class="n">cmdiocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_iocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_mbox</span> <span class="o">*</span><span class="n">mbox</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_bsg_menlo</span> <span class="o">*</span><span class="n">menlo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpfc_sli_ring</span> <span class="o">*</span><span class="n">pring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">sli</span><span class="p">.</span><span class="n">ring</span><span class="p">[</span><span class="n">LPFC_ELS_RING</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dd_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job_data</span> <span class="o">*</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="cm">/* timeout and completion crossed paths if no dd_data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_IOCB</span>:
		<span class="n">iocb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">iocb</span><span class="p">;</span>
		<span class="n">cmdiocb</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">cmdiocbq</span><span class="p">;</span>
		<span class="cm">/* hint to completion handler that the job timed out */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* this will call our completion handler */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
		<span class="n">lpfc_sli_issue_abort_iotag</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_EVT</span>:
		<span class="n">evt</span> <span class="o">=</span> <span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">evt</span><span class="p">;</span>
		<span class="cm">/* this event has no job anymore */</span>
		<span class="n">evt</span><span class="o">-&gt;</span><span class="n">set_job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Return -EAGAIN which is our way of signallying the</span>
<span class="cm">		 * app to retry.</span>
<span class="cm">		 */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_MBOX</span>:
		<span class="n">mbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">mbox</span><span class="p">;</span>
		<span class="cm">/* this mbox has no job anymore */</span>
		<span class="n">mbox</span><span class="o">-&gt;</span><span class="n">set_job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">dd_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="cm">/* the mbox completion handler can now be run */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPFC_BSG_MBOX_PORT</span><span class="p">)</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mbox_ext_buf_ctx</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPFC_BSG_MBOX_ABTS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TYPE_MENLO</span>:
		<span class="n">menlo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dd_data</span><span class="o">-&gt;</span><span class="n">context_un</span><span class="p">.</span><span class="n">menlo</span><span class="p">;</span>
		<span class="n">cmdiocb</span> <span class="o">=</span> <span class="n">menlo</span><span class="o">-&gt;</span><span class="n">cmdiocbq</span><span class="p">;</span>
		<span class="cm">/* hint to completion handler that the job timed out */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* this will call our completion handler */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
		<span class="n">lpfc_sli_issue_abort_iotag</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pring</span><span class="p">,</span> <span class="n">cmdiocb</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">hbalock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ct_ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* scsi transport fc fc_bsg_job_timeout expects a zero return code,</span>
<span class="cm">	 * otherwise an error message will be displayed on the console</span>
<span class="cm">	 * so always return success (zero)</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
