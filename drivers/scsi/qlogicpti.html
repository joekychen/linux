<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qlogicpti.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>qlogicpti.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* qlogicpti.c: Performance Technologies QlogicISP sbus card driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996, 2006, 2008 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> *</span>
<span class="cm"> * A lot of this driver was directly stolen from Erik H. Moe&#39;s PCI</span>
<span class="cm"> * Qlogic ISP driver.  Mucho kudos to him for this code.</span>
<span class="cm"> *</span>
<span class="cm"> * An even bigger kudos to John Grana at Performance Technologies</span>
<span class="cm"> * for providing me with the hardware to write this driver, you rule</span>
<span class="cm"> * John you really do.</span>
<span class="cm"> *</span>
<span class="cm"> * May, 2, 1997: Added support for QLGC,isp --jj</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &quot;qlogicpti.h&quot;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#define MAX_TARGETS	16</span>
<span class="cp">#define MAX_LUNS	8	</span><span class="cm">/* 32 for 1.31 F/W */</span><span class="cp"></span>

<span class="cp">#define DEFAULT_LOOP_COUNT	10000</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qptichain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">qptichain_lock</span><span class="p">);</span>

<span class="cp">#define PACKB(a, b)			(((a)&lt;&lt;4)|(b))</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u_char</span> <span class="n">mbox_param</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* MBOX_NO_OP */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>	<span class="cm">/* MBOX_LOAD_RAM */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* MBOX_EXEC_FIRMWARE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>	<span class="cm">/* MBOX_DUMP_RAM */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_WRITE_RAM_WORD */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_READ_RAM_WORD */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>	<span class="cm">/* MBOX_MAILBOX_REG_TEST */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_VERIFY_CHECKSUM	*/</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_ABOUT_FIRMWARE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x0009 */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x000a */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x000b */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x000c */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x000d */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_CHECK_FIRMWARE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x000f */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>	<span class="cm">/* MBOX_INIT_REQ_QUEUE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>	<span class="cm">/* MBOX_INIT_RES_QUEUE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* MBOX_EXECUTE_IOCB */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_WAKE_UP	*/</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>	<span class="cm">/* MBOX_STOP_FIRMWARE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* MBOX_ABORT */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_ABORT_DEVICE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_ABORT_TARGET */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_BUS_RESET */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_STOP_QUEUE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_START_QUEUE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_SINGLE_STEP_QUEUE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_ABORT_QUEUE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_DEV_QUEUE_STATUS */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x001e */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_FIRMWARE_STATUS */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_INIT_SCSI_ID */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_SELECT_TIMEOUT */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_RETRY_COUNT	*/</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_TAG_AGE_LIMIT */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_CLOCK_RATE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_ACT_NEG_STATE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_ASYNC_DATA_SETUP_TIME */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_SBUS_PARAMS */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_TARGET_PARAMS */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* MBOX_GET_DEV_QUEUE_PARAMS */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x002a */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x002b */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x002c */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x002d */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x002e */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x002f */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_INIT_SCSI_ID */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_SELECT_TIMEOUT */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_RETRY_COUNT	*/</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_TAG_AGE_LIMIT */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_CLOCK_RATE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_ACTIVE_NEG_STATE */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_ASYNC_DATA_SETUP_TIME */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_SBUS_CONTROL_PARAMS */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_TARGET_PARAMS */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* MBOX_SET_DEV_QUEUE_PARAMS */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x003a */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x003b */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x003c */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x003d */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x003e */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x003f */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x0040 */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 0x0041 */</span>
	<span class="n">PACKB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* 0x0042 */</span>
<span class="p">};</span>

<span class="cp">#define MAX_MBOX_COMMAND	ARRAY_SIZE(mbox_param)</span>

<span class="cm">/* queue length&#39;s _must_ be power of two: */</span>
<span class="cp">#define QUEUE_DEPTH(in, out, ql)	((in - out) &amp; (ql))</span>
<span class="cp">#define REQ_QUEUE_DEPTH(in, out)	QUEUE_DEPTH(in, out, 		     \</span>
<span class="cp">						    QLOGICPTI_REQ_QUEUE_LEN)</span>
<span class="cp">#define RES_QUEUE_DEPTH(in, out)	QUEUE_DEPTH(in, out, RES_QUEUE_LEN)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qlogicpti_enable_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">SBUS_CTRL_ERIRQ</span> <span class="o">|</span> <span class="n">SBUS_CTRL_GENAB</span><span class="p">,</span>
		    <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qlogicpti_disable_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_sbus_cfg1</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bursts</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">bursts</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c">	/* It appears that at least PTI cards do not support</span>
<span class="c">	 * 64-byte bursts and that setting the B64 bit actually</span>
<span class="c">	 * is a nop and the chip ends up using the smallest burst</span>
<span class="c">	 * size. -DaveM</span>
<span class="c">	 */</span>
<span class="c">	if (sbus_can_burst64() &amp;&amp; (bursts &amp; DMA_BURST64)) {</span>
<span class="c">		val = (SBUS_CFG1_BENAB | SBUS_CFG1_B64);</span>
<span class="c">	} else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">SBUS_CFG1_BENAB</span> <span class="o">|</span> <span class="n">SBUS_CFG1_B32</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">SBUS_CFG1_BENAB</span> <span class="o">|</span> <span class="n">SBUS_CFG1_B16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">SBUS_CFG1_BENAB</span> <span class="o">|</span> <span class="n">SBUS_CFG1_B8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No sbus bursts for you... */</span>
	<span class="p">}</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_CFG1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogicpti_mbox_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">param</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop_count</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_param</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set SBUS semaphore. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SBUS_SEMAPHORE_LCK</span><span class="p">;</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">);</span>

	<span class="cm">/* Wait for host IRQ bit to clear. */</span>
	<span class="n">loop_count</span> <span class="o">=</span> <span class="n">DEFAULT_LOOP_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">loop_count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCCTRL_HIRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loop_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: mbox_command loop timeout #1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>

	<span class="cm">/* Write mailbox command registers. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mbox_param</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">sbus_writew</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX5</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="n">sbus_writew</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX4</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">sbus_writew</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX3</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">sbus_writew</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX2</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">sbus_writew</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX1</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">sbus_writew</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear RISC interrupt. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">HCCTRL_CRIRQ</span><span class="p">;</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>

	<span class="cm">/* Clear SBUS semaphore. */</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">);</span>

	<span class="cm">/* Set HOST interrupt. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">HCCTRL_SHIRQ</span><span class="p">;</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>

	<span class="cm">/* Wait for HOST interrupt clears. */</span>
	<span class="n">loop_count</span> <span class="o">=</span> <span class="n">DEFAULT_LOOP_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">loop_count</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCCTRL_CRIRQ</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loop_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: mbox_command[%04x] loop timeout #2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Wait for SBUS semaphore to get set. */</span>
	<span class="n">loop_count</span> <span class="o">=</span> <span class="n">DEFAULT_LOOP_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">loop_count</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBUS_SEMAPHORE_LCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

		<span class="cm">/* Workaround for some buggy chips. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loop_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: mbox_command[%04x] loop timeout #3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Wait for MBOX busy condition to go away. */</span>
	<span class="n">loop_count</span> <span class="o">=</span> <span class="n">DEFAULT_LOOP_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">loop_count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loop_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: mbox_command[%04x] loop timeout #4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Read back output parameters. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mbox_param</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">param</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX5</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX4</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX3</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX2</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX1</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear RISC interrupt. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">HCCTRL_CRIRQ</span><span class="p">;</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>

	<span class="cm">/* Release SBUS semaphore. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SBUS_SEMAPHORE_LCK</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">);</span>

	<span class="cm">/* We&#39;re done. */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qlogicpti_set_hostdev_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">initiator_scsi_id</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">bus_reset_delay</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">async_data_setup_time</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">req_ack_active_negation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">data_line_active_negation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">data_dma_burst_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">command_dma_burst_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">tag_aging</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">selection_timeout</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">max_queue_depth</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TARGETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * disconnect, parity, arq, reneg on reset, and, oddly enough</span>
<span class="cm">		 * tags...the midlayer&#39;s notion of tagged support has to match</span>
<span class="cm">		 * our device settings, and since we base whether we enable a</span>
<span class="cm">		 * tag on a  per-cmnd basis upon what the midlayer sez, we</span>
<span class="cm">		 * actually enable the capability here.</span>
<span class="cm">		 */</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_flags</span> <span class="o">=</span> <span class="mh">0xcd</span><span class="p">;</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">execution_throttle</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">ultra</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">synchronous_period</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">synchronous_offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">synchronous_period</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">synchronous_offset</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogicpti_reset_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">risc_code_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop_count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">risc_code_addr</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>	<span class="cm">/* all load addresses are at 0x1000 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_PAUSE</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>

	<span class="cm">/* Only reset the scsi bus if it is not free. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">CPU_PCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CPU_PCTRL_BSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="n">CPU_ORIDE_RMOD</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">CPU_ORIDE</span><span class="p">);</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="n">CPU_CMD_BRESET</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">CPU_CMD</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">SBUS_CTRL_RESET</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_CTRL</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">((</span><span class="n">DMA_CTRL_CCLEAR</span> <span class="o">|</span> <span class="n">DMA_CTRL_CIRQ</span><span class="p">),</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">CMD_DMA_CTRL</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">((</span><span class="n">DMA_CTRL_CCLEAR</span> <span class="o">|</span> <span class="n">DMA_CTRL_CIRQ</span><span class="p">),</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">DATA_DMA_CTRL</span><span class="p">);</span>

	<span class="n">loop_count</span> <span class="o">=</span> <span class="n">DEFAULT_LOOP_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">loop_count</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loop_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: reset_hardware loop timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>

	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_PAUSE</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>
	<span class="n">set_sbus_cfg1</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>
	<span class="n">qlogicpti_enable_irqs</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">RISC_PSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RISC_PSR_ULTRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">ultra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sbus_writew</span><span class="p">((</span><span class="n">RISC_MTREG_P0ULTRA</span> <span class="o">|</span> <span class="n">RISC_MTREG_P1ULTRA</span><span class="p">),</span>
			    <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">RISC_MTREG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">ultra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sbus_writew</span><span class="p">((</span><span class="n">RISC_MTREG_P0DFLT</span> <span class="o">|</span> <span class="n">RISC_MTREG_P1DFLT</span><span class="p">),</span>
			    <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">RISC_MTREG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset adapter and per-device default values. */</span>
	<span class="cm">/* do it after finding out whether we&#39;re ultra mode capable */</span>
	<span class="n">qlogicpti_set_hostdev_defaults</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="cm">/* Release the RISC processor. */</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_REL</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>

	<span class="cm">/* Get RISC to start executing the firmware code. */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_EXEC_FIRMWARE</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">risc_code_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: Cannot execute ISP firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set initiator scsi ID. */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_SET_INIT_SCSI_ID</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">initiator_scsi_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_COMMAND_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: Cannot set initiator SCSI ID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize state of the queues, both hw and sw. */</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_in_ptr</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_out_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_INIT_RES_QUEUE</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RES_QUEUE_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_dvma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_dvma</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: Cannot init response queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_INIT_REQ_QUEUE</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">QLOGICPTI_REQ_QUEUE_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_dvma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_dvma</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: Cannot init request queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_SET_RETRY_COUNT</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">retry_count</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">retry_delay</span><span class="p">;</span>
	<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_SET_TAG_AGE_LIMIT</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">tag_aging</span><span class="p">;</span>
	<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TARGETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_GET_DEV_QUEUE_PARAMS</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_GET_FIRMWARE_STATUS</span><span class="p">;</span>
	<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_SET_SELECT_TIMEOUT</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">selection_timeout</span><span class="p">;</span>
	<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TARGETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_SET_TARGET_PARAMS</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_flags</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since we&#39;re now loading 1.31 f/w, force narrow/async.</span>
<span class="cm">		 */</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no offset, we do not have sync mode yet */</span>
		<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always (sigh) do an initial bus reset (kicks f/w).</span>
<span class="cm">	 */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_BUS_RESET</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">bus_reset_delay</span><span class="p">;</span>
	<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">send_marker</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PTI_RESET_LIMIT 400</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qlogicpti_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fwname</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;qlogic/isp1000.bin&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">risc_code_addr</span><span class="p">,</span> <span class="n">risc_code_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fwname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to load image </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fwname</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Bogus length %zu in image </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">fwname</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">outfirm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">risc_code_addr</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>	<span class="cm">/* all f/w modules load at 0x1000 */</span>
	<span class="n">risc_code_length</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Verify the checksum twice, one before loading it, and once</span>
<span class="cm">	 * afterwards via the mailbox commands.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">risc_code_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: Aieee, firmware checksum failed!&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>		
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">SBUS_CTRL_RESET</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_CTRL</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">((</span><span class="n">DMA_CTRL_CCLEAR</span> <span class="o">|</span> <span class="n">DMA_CTRL_CIRQ</span><span class="p">),</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">CMD_DMA_CTRL</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">((</span><span class="n">DMA_CTRL_CCLEAR</span> <span class="o">|</span> <span class="n">DMA_CTRL_CIRQ</span><span class="p">),</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">DATA_DMA_CTRL</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">PTI_RESET_LIMIT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBUS_CTRL_RESET</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: Cannot reset the ISP.&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_RESET</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">sbus_writew</span><span class="p">((</span><span class="n">SBUS_CTRL_GENAB</span> <span class="o">|</span> <span class="n">SBUS_CTRL_ERIRQ</span><span class="p">),</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_CTRL</span><span class="p">);</span>
	<span class="n">set_sbus_cfg1</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">RISC_PSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RISC_PSR_ULTRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">ultra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sbus_writew</span><span class="p">((</span><span class="n">RISC_MTREG_P0ULTRA</span> <span class="o">|</span> <span class="n">RISC_MTREG_P1ULTRA</span><span class="p">),</span>
			    <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">RISC_MTREG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">ultra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sbus_writew</span><span class="p">((</span><span class="n">RISC_MTREG_P0DFLT</span> <span class="o">|</span> <span class="n">RISC_MTREG_P1DFLT</span><span class="p">),</span>
			    <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">RISC_MTREG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_REL</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>

	<span class="cm">/* Pin lines are only stable while RISC is paused. */</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_PAUSE</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">CPU_PDIFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CPU_PDIFF_MODE</span><span class="p">)</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">differential</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">differential</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_REL</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>

	<span class="cm">/* This shouldn&#39;t be necessary- we&#39;ve reset things so we should be</span>
<span class="cm">	   running from the ROM now.. */</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_STOP_FIRMWARE</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: Cannot stop firmware for reload.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>		

	<span class="cm">/* Load it up.. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">risc_code_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_WRITE_RAM_WORD</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">risc_code_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qlogicpti%d: Firmware dload failed, I&#39;m bolixed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the ISP again. */</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_RESET</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">qlogicpti_enable_irqs</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_REL</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>

	<span class="cm">/* Ask ISP to verify the checksum of the new code. */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_VERIFY_CHECKSUM</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">risc_code_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_COMMAND_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: New firmware csum failure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start using newly downloaded firmware. */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_EXEC_FIRMWARE</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">risc_code_addr</span><span class="p">;</span>
	<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_ABOUT_FIRMWARE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_COMMAND_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: AboutFirmware cmd fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Snag the major and minor revisions from the result. */</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">fware_majrev</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">fware_minrev</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">fware_micrev</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* Set the clock rate */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_SET_CLOCK_RATE</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_COMMAND_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: could not set clock rate.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">is_pti</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Load scsi initiator ID and interrupt level into sbus static ram. */</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_WRITE_RAM_WORD</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff80</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">;</span>
		<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_WRITE_RAM_WORD</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff00</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">outfirm:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogicpti_verify_tmon</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">curstat</span> <span class="o">=</span> <span class="n">sbus_readb</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">);</span>

	<span class="n">curstat</span> <span class="o">&amp;=</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">curstat</span> <span class="o">&amp;</span> <span class="n">SREG_FUSE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">swsreg</span> <span class="o">&amp;</span> <span class="n">SREG_FUSE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qlogicpti%d: Fuse returned to normal state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">curstat</span> <span class="o">&amp;</span> <span class="n">SREG_TPOWER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">swsreg</span> <span class="o">&amp;</span> <span class="n">SREG_TPOWER</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qlogicpti%d: termpwr back to normal state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curstat</span> <span class="o">!=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">swsreg</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curstat</span> <span class="o">&amp;</span> <span class="n">SREG_FUSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qlogicpti%d: Fuse is open!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curstat</span> <span class="o">&amp;</span> <span class="n">SREG_TPOWER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qlogicpti%d: termpwr failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">differential</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">curstat</span> <span class="o">&amp;</span> <span class="n">SREG_DSENSE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SREG_DSENSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qlogicpti%d: You have a single ended device on a &quot;</span>
			       <span class="s">&quot;differential bus!  Please fix!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">swsreg</span> <span class="o">=</span> <span class="n">curstat</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">qpti_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">qpti_chain_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qptichain_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qptichain</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qlink</span> <span class="o">=</span> <span class="n">qptichain</span><span class="p">;</span>

		<span class="k">while</span><span class="p">(</span><span class="n">qlink</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">qlink</span> <span class="o">=</span> <span class="n">qlink</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">qlink</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">qpti</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qptichain</span> <span class="o">=</span> <span class="n">qpti</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qptichain_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">qpti_chain_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qptichain_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qptichain</span> <span class="o">==</span> <span class="n">qpti</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qptichain</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qlink</span> <span class="o">=</span> <span class="n">qptichain</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">qlink</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">qpti</span><span class="p">)</span>
			<span class="n">qlink</span> <span class="o">=</span> <span class="n">qlink</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">qlink</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qptichain_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qpti_map_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span>

	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
				 <span class="s">&quot;PTI Qlogic/ISP&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PTI: Qlogic/ISP registers are unmappable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">is_pti</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">sreg</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">),</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">),</span>
					<span class="s">&quot;PTI Qlogic/ISP statreg&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PTI: Qlogic/ISP status register is unmappable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qpti_register_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span>

	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* We used to try various overly-clever things to</span>
<span class="cm">	 * reduce the interrupt processing overhead on</span>
<span class="cm">	 * sun4c/sun4m when multiple PTI&#39;s shared the</span>
<span class="cm">	 * same IRQ.  It was too complex and messy to</span>
<span class="cm">	 * sanely maintain.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">qpti_intr</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;QlogicPTI&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qlogicpti%d: IRQ %d &quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qlogicpti%d: Cannot acquire irq line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">qpti_get_scsi_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>

	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;initiator-id&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;scsi-initiator-id&quot;</span><span class="p">,</span>
						      <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">scsi_id</span> <span class="o">=</span>
			<span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
					      <span class="s">&quot;scsi-initiator-id&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSI ID %d &quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">scsi_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qpti_get_bursts</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bursts</span><span class="p">,</span> <span class="n">bmask</span><span class="p">;</span>

	<span class="n">bursts</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;burst-sizes&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">bmask</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;burst-sizes&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmask</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">bursts</span> <span class="o">&amp;=</span> <span class="n">bmask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bursts</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bursts</span> <span class="o">&amp;</span> <span class="n">DMA_BURST32</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bursts</span> <span class="o">=</span> <span class="p">(</span><span class="n">DMA_BURST32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">bursts</span> <span class="o">=</span> <span class="n">bursts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qpti_get_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cfreq</span><span class="p">;</span>

	<span class="cm">/* Check for what the clock input to this card is.</span>
<span class="cm">	 * Default to 40Mhz.</span>
<span class="cm">	 */</span>
	<span class="n">cfreq</span> <span class="o">=</span> <span class="n">prom_getintdefault</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">prom_node</span><span class="p">,</span><span class="s">&quot;clock-frequency&quot;</span><span class="p">,</span><span class="mi">40000000</span><span class="p">);</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfreq</span> <span class="o">+</span> <span class="mi">500000</span><span class="p">)</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* bullshit */</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The request and response queues must each be aligned</span>
<span class="cm"> * on a page boundary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qpti_map_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span>

<span class="cp">#define QSIZE(entries)	(((entries) + 1) * QUEUE_ENTRY_LEN)</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_cpu</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">QSIZE</span><span class="p">(</span><span class="n">RES_QUEUE_LEN</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_dvma</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_cpu</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_dvma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;QPTI: Cannot map response queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_cpu</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">QSIZE</span><span class="p">(</span><span class="n">QLOGICPTI_REQ_QUEUE_LEN</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_dvma</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_cpu</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_dvma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">QSIZE</span><span class="p">(</span><span class="n">RES_QUEUE_LEN</span><span class="p">),</span>
				  <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_cpu</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_dvma</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;QPTI: Cannot map request queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_cpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QSIZE</span><span class="p">(</span><span class="n">RES_QUEUE_LEN</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_cpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QSIZE</span><span class="p">(</span><span class="n">QLOGICPTI_REQ_QUEUE_LEN</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">qlogicpti_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;PTI Qlogic,ISP SBUS SCSI irq %d regs at %p&quot;</span><span class="p">,</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* I am a certified frobtronicist. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">marker_frob</span><span class="p">(</span><span class="k">struct</span> <span class="n">Command_Entry</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Marker_Entry</span> <span class="o">*</span><span class="n">marker</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Marker_Entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">Marker_Entry</span><span class="p">));</span>
	<span class="n">marker</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">marker</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">ENTRY_MARKER</span><span class="p">;</span>
	<span class="n">marker</span><span class="o">-&gt;</span><span class="n">modifier</span> <span class="o">=</span> <span class="n">SYNC_ALL</span><span class="p">;</span>
	<span class="n">marker</span><span class="o">-&gt;</span><span class="n">rsvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cmd_frob</span><span class="p">(</span><span class="k">struct</span> <span class="n">Command_Entry</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">Cmnd</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">Command_Entry</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">ENTRY_COMMAND</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">target_lun</span> <span class="o">=</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cdb_length</span> <span class="o">=</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">cmd_count</span><span class="p">[</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">tag_ages</span><span class="p">[</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">tag_ages</span><span class="p">[</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">CFLAG_ORDERED_TAG</span><span class="p">;</span>
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">tag_ages</span><span class="p">[</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">CFLAG_SIMPLE_TAG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_10</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_12</span><span class="p">))</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">CFLAG_WRITE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">CFLAG_READ</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">time_out</span> <span class="o">=</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">/</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Do it to it baby. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">load_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">Cmnd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Command_Entry</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">in_ptr</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">out_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dataseg</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">Cmnd</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sg_count</span><span class="p">;</span>

		<span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">Cmnd</span><span class="p">);</span>
		<span class="n">sg_count</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span>
				      <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">Cmnd</span><span class="p">),</span>
				      <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>

		<span class="n">ds</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dataseg</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">segment_cnt</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">;</span>

		<span class="cm">/* Fill in first four sg entries: */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_base</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_count</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sg_count</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sg_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">Continuation_Entry</span> <span class="o">*</span><span class="n">cont</span><span class="p">;</span>

			<span class="o">++</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_cnt</span><span class="p">;</span>
			<span class="n">cont</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Continuation_Entry</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_cpu</span><span class="p">[</span><span class="n">in_ptr</span><span class="p">];</span>
			<span class="n">in_ptr</span> <span class="o">=</span> <span class="n">NEXT_REQ_PTR</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in_ptr</span> <span class="o">==</span> <span class="n">out_ptr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">ENTRY_CONTINUATION</span><span class="p">;</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">sys_def_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cont</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="n">cont</span><span class="o">-&gt;</span><span class="n">dataseg</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">sg_count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
				<span class="n">n</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_base</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_count</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sg_count</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dataseg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dataseg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">segment_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Shouldn&#39;t this be 0? */</span>
	<span class="p">}</span>

	<span class="cm">/* Committed, record Scsi_Cmd so we can find it later. */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">in_ptr</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">cmd_slots</span><span class="p">[</span><span class="n">in_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cmnd</span><span class="p">;</span>

	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">cmd_count</span><span class="p">[</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX4</span><span class="p">);</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_in_ptr</span> <span class="o">=</span> <span class="n">in_ptr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">in_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">update_can_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">in_ptr</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">out_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Temporary workaround until bug is found and fixed (one bug has been found</span>
<span class="cm">	   already, but fixing it makes things even worse) -jj */</span>
	<span class="kt">int</span> <span class="n">num_free</span> <span class="o">=</span> <span class="n">QLOGICPTI_REQ_QUEUE_LEN</span> <span class="o">-</span> <span class="n">REQ_QUEUE_DEPTH</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">,</span> <span class="n">out_ptr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_busy</span> <span class="o">+</span> <span class="n">num_free</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">QLOGICPTI_MAX_SG</span><span class="p">(</span><span class="n">num_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogicpti_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tgt</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="cm">/* tags handled in midlayer */</span>
	<span class="cm">/* enable sync mode? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdtr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">device_flags</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">synchronous_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">synchronous_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* are we wide capable? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">wdtr</span><span class="p">)</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">device_flags</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_SET_TARGET_PARAMS</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgt</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">device_flags</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">device_flags</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">synchronous_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">dev_param</span><span class="p">[</span><span class="n">tgt</span><span class="p">].</span><span class="n">synchronous_period</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The middle SCSI layer ensures that queuecommand never gets invoked</span>
<span class="cm"> * concurrently with itself or the interrupt handler (though the</span>
<span class="cm"> * interrupt handler may call this routine as part of</span>
<span class="cm"> * request-completion handling).</span>
<span class="cm"> *</span>
<span class="cm"> * &quot;This code must fly.&quot; -davem</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogicpti_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">Cmnd</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Command_Entry</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">out_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_ptr</span><span class="p">;</span>

	<span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">in_ptr</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_in_ptr</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Command_Entry</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_cpu</span><span class="p">[</span><span class="n">in_ptr</span><span class="p">];</span>
	<span class="n">out_ptr</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX4</span><span class="p">);</span>
	<span class="n">in_ptr</span> <span class="o">=</span> <span class="n">NEXT_REQ_PTR</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_ptr</span> <span class="o">==</span> <span class="n">out_ptr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">toss_command</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">send_marker</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">marker_frob</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">send_marker</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NEXT_REQ_PTR</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">out_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sbus_writew</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX4</span><span class="p">);</span>
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_in_ptr</span> <span class="o">=</span> <span class="n">in_ptr</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">toss_command</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Command_Entry</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_cpu</span><span class="p">[</span><span class="n">in_ptr</span><span class="p">];</span>
		<span class="n">in_ptr</span> <span class="o">=</span> <span class="n">NEXT_REQ_PTR</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cmd_frob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">Cmnd</span><span class="p">,</span> <span class="n">qpti</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">in_ptr</span> <span class="o">=</span> <span class="n">load_cmd</span><span class="p">(</span><span class="n">Cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">qpti</span><span class="p">,</span> <span class="n">in_ptr</span><span class="p">,</span> <span class="n">out_ptr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">toss_command</span><span class="p">;</span>

	<span class="n">update_can_queue</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">in_ptr</span><span class="p">,</span> <span class="n">out_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">toss_command:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: request queue overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>

	<span class="cm">/* Unfortunately, unless you use the new EH code, which</span>
<span class="cm">	 * we don&#39;t, the midlayer will ignore the return value,</span>
<span class="cm">	 * which is insane.  We pick up the pieces like this.</span>
<span class="cm">	 */</span>
	<span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span><span class="p">;</span>
	<span class="n">done</span><span class="p">(</span><span class="n">Cmnd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">qlogicpti_queuecommand</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qlogicpti_return_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">Status_Entry</span> <span class="o">*</span><span class="n">sts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="n">CS_COMPLETE</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS_INCOMPLETE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_GOT_BUS</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_GOT_TARGET</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_SENT_CDB</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_TRANSFERRED_DATA</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_GOT_STATUS</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_GOT_SENSE</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS_DMA_ERROR</span>:
	      <span class="k">case</span> <span class="n">CS_TRANSPORT_ERROR</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS_RESET_OCCURRED</span>:
	      <span class="k">case</span> <span class="n">CS_BUS_RESET</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS_ABORTED</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ABORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS_TIMEOUT</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS_DATA_OVERRUN</span>:
	      <span class="k">case</span> <span class="n">CS_COMMAND_OVERRUN</span>:
	      <span class="k">case</span> <span class="n">CS_STATUS_OVERRUN</span>:
	      <span class="k">case</span> <span class="n">CS_BAD_MESSAGE</span>:
	      <span class="k">case</span> <span class="n">CS_NO_MESSAGE_OUT</span>:
	      <span class="k">case</span> <span class="n">CS_EXT_ID_FAILED</span>:
	      <span class="k">case</span> <span class="n">CS_IDE_MSG_FAILED</span>:
	      <span class="k">case</span> <span class="n">CS_ABORT_MSG_FAILED</span>:
	      <span class="k">case</span> <span class="n">CS_NOP_MSG_FAILED</span>:
	      <span class="k">case</span> <span class="n">CS_PARITY_ERROR_MSG_FAILED</span>:
	      <span class="k">case</span> <span class="n">CS_DEVICE_RESET_MSG_FAILED</span>:
	      <span class="k">case</span> <span class="n">CS_ID_MSG_FAILED</span>:
	      <span class="k">case</span> <span class="n">CS_UNEXP_BUS_FREE</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">CS_DATA_UNDERRUN</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: unknown completion status 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">id</span><span class="p">,</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">completion_status</span><span class="p">);</span>
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">STATUS_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="nf">qlogicpti_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">Cmnd</span><span class="p">,</span> <span class="o">*</span><span class="n">done_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Status_Entry</span> <span class="o">*</span><span class="n">sts</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">in_ptr</span><span class="p">,</span> <span class="n">out_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBUS_STAT_RINT</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		
	<span class="n">in_ptr</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX5</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">HCCTRL_CRIRQ</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">HCCTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBUS_SEMAPHORE_LCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ASYNC_SCSI_BUS_RESET</span>:
		<span class="k">case</span> <span class="n">EXECUTION_TIMEOUT_RESET</span>:
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">send_marker</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INVALID_COMMAND</span>:
		<span class="k">case</span> <span class="n">HOST_INTERFACE_ERROR</span>:
		<span class="k">case</span> <span class="n">COMMAND_ERROR</span>:
		<span class="k">case</span> <span class="n">COMMAND_PARAM_ERROR</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_SEMAPHORE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* This looks like a network driver! */</span>
	<span class="n">out_ptr</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_out_ptr</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">out_ptr</span> <span class="o">!=</span> <span class="n">in_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">cmd_slot</span><span class="p">;</span>

		<span class="n">sts</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Status_Entry</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_cpu</span><span class="p">[</span><span class="n">out_ptr</span><span class="p">];</span>
		<span class="n">out_ptr</span> <span class="o">=</span> <span class="n">NEXT_RES_PTR</span><span class="p">(</span><span class="n">out_ptr</span><span class="p">);</span>

		<span class="cm">/* We store an index in the handle, not the pointer in</span>
<span class="cm">		 * some form.  This avoids problems due to the fact</span>
<span class="cm">		 * that the handle provided is only 32-bits. -DaveM</span>
<span class="cm">		 */</span>
		<span class="n">cmd_slot</span> <span class="o">=</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">Cmnd</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">cmd_slots</span><span class="p">[</span><span class="n">cmd_slot</span><span class="p">];</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">cmd_slots</span><span class="p">[</span><span class="n">cmd_slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">==</span> <span class="n">CS_RESET_OCCURRED</span> <span class="o">||</span>
		    <span class="n">sts</span><span class="o">-&gt;</span><span class="n">completion_status</span> <span class="o">==</span> <span class="n">CS_ABORTED</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">status_flags</span> <span class="o">&amp;</span> <span class="n">STF_BUS_RESET</span><span class="p">))</span>
			<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">send_marker</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_GOT_SENSE</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">req_sense_data</span><span class="p">,</span>
			       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_type</span> <span class="o">==</span> <span class="n">ENTRY_STATUS</span><span class="p">)</span>
			<span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
			    <span class="n">qlogicpti_return_status</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">Cmnd</span><span class="p">))</span>
			<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">Cmnd</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">Cmnd</span><span class="p">),</span>
				     <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>

		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">cmd_count</span><span class="p">[</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="n">out_ptr</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">MBOX5</span><span class="p">);</span>
		<span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">done_queue</span><span class="p">;</span>
		<span class="n">done_queue</span> <span class="o">=</span> <span class="n">Cmnd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_out_ptr</span> <span class="o">=</span> <span class="n">out_ptr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">done_queue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qpti_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">dq</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dq</span> <span class="o">=</span> <span class="n">qlogicpti_intr_handler</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

			<span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">dq</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
			<span class="n">dq</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">dq</span><span class="p">);</span>
			<span class="n">dq</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogicpti_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">Cmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span> <span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">return_status</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_cookie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;qlogicpti%d: Aborting cmd for tgt[%d] lun[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">qlogicpti_disable_irqs</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="cm">/* Find the 32-bit cookie we gave to the firmware for</span>
<span class="cm">	 * this command.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLOGICPTI_REQ_QUEUE_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">cmd_slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">Cmnd</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">cmd_cookie</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_ABORT</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u_short</span><span class="p">)</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_cookie</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_cookie</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_COMMAND_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicpti%d: scsi abort failure: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qlogicpti_enable_irqs</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">return_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlogicpti_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">Cmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span> <span class="n">param</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">Cmnd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">return_status</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;qlogicpti%d: Resetting SCSI bus!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>

	<span class="n">qlogicpti_disable_irqs</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_BUS_RESET</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">host_param</span><span class="p">.</span><span class="n">bus_reset_delay</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_mbox_command</span><span class="p">(</span><span class="n">qpti</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_COMMAND_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;qlogicisp%d: scsi bus reset failure: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qlogicpti_enable_irqs</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">return_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">qpti_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;qlogicpti&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">qlogicpti_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">qlogicpti_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">qlogicpti_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">qlogicpti_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>	<span class="o">=</span> <span class="n">qlogicpti_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="n">QLOGICPTI_REQ_QUEUE_LEN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">QLOGICPTI_MAX_SG</span><span class="p">(</span><span class="n">QLOGICPTI_REQ_QUEUE_LEN</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">qpti_match</span><span class="p">[];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qpti_sbus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">tpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">nqptis</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fcode</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">of_match_device</span><span class="p">(</span><span class="n">qpti_match</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">tpnt</span> <span class="o">=</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Sometimes Antares cards come up not completely</span>
<span class="cm">	 * setup, and we get a report of a zero IRQ.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="n">tpnt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlogicpti</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">qpti</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">MAX_TARGETS</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span> <span class="o">=</span> <span class="n">nqptis</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">prom_name</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">is_pti</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">prom_name</span><span class="p">,</span> <span class="s">&quot;QLGC,isp&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qpti_map_regs</span><span class="p">(</span><span class="n">qpti</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_unlink</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qpti_register_irq</span><span class="p">(</span><span class="n">qpti</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_unmap_regs</span><span class="p">;</span>

	<span class="n">qpti_get_scsi_id</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>
	<span class="n">qpti_get_bursts</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>
	<span class="n">qpti_get_clock</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="cm">/* Clear out scsi_cmnd array. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">cmd_slots</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">cmd_slots</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qpti_map_queues</span><span class="p">(</span><span class="n">qpti</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_free_irq</span><span class="p">;</span>

	<span class="cm">/* Load the firmware. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_load_firmware</span><span class="p">(</span><span class="n">qpti</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_unmap_queues</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">is_pti</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check the PTI status reg. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_verify_tmon</span><span class="p">(</span><span class="n">qpti</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail_unmap_queues</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the ISP and init res/req queues. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlogicpti_reset_hardware</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_unmap_queues</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(Firmware v%d.%d.%d)&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">fware_majrev</span><span class="p">,</span>
	       <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">fware_minrev</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">fware_micrev</span><span class="p">);</span>

	<span class="n">fcode</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;isp-fcode&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcode</span> <span class="o">&amp;&amp;</span> <span class="n">fcode</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(FCode %s)&quot;</span><span class="p">,</span> <span class="n">fcode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_find_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;differential&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">differential</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">qlogicpti%d: [%s Wide, using %s interface]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">,</span>
		<span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">ultra</span> <span class="o">?</span> <span class="s">&quot;Ultra&quot;</span> <span class="o">:</span> <span class="s">&quot;Fast&quot;</span><span class="p">),</span>
		<span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">differential</span> <span class="o">?</span> <span class="s">&quot;differential&quot;</span> <span class="o">:</span> <span class="s">&quot;single ended&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qlogicpti%d: Failed scsi_add_host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qpti_id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_unmap_queues</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">qpti</span><span class="p">);</span>

	<span class="n">qpti_chain_add</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">nqptis</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_unmap_queues:</span>
<span class="cp">#define QSIZE(entries)	(((entries) + 1) * QUEUE_ENTRY_LEN)</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">QSIZE</span><span class="p">(</span><span class="n">RES_QUEUE_LEN</span><span class="p">),</span>
			  <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_cpu</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_dvma</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">QSIZE</span><span class="p">(</span><span class="n">QLOGICPTI_REQ_QUEUE_LEN</span><span class="p">),</span>
			  <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_cpu</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_dvma</span><span class="p">);</span>
<span class="cp">#undef QSIZE</span>

<span class="nl">fail_unmap_regs:</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span><span class="p">,</span>
		   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">is_pti</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">));</span>

<span class="nl">fail_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">qpti</span><span class="p">);</span>

<span class="nl">fail_unlink:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">qpti_sbus_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlogicpti</span> <span class="o">*</span><span class="n">qpti</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">qpti_chain_del</span><span class="p">(</span><span class="n">qpti</span><span class="p">);</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span><span class="p">);</span>

	<span class="cm">/* Shut up the card. */</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span> <span class="o">+</span> <span class="n">SBUS_CTRL</span><span class="p">);</span>

	<span class="cm">/* Free IRQ handler and unmap Qlogic,ISP and PTI status regs. */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">qpti</span><span class="p">);</span>

<span class="cp">#define QSIZE(entries)	(((entries) + 1) * QUEUE_ENTRY_LEN)</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">QSIZE</span><span class="p">(</span><span class="n">RES_QUEUE_LEN</span><span class="p">),</span>
			  <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_cpu</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">res_dvma</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">QSIZE</span><span class="p">(</span><span class="n">QLOGICPTI_REQ_QUEUE_LEN</span><span class="p">),</span>
			  <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_cpu</span><span class="p">,</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">req_dvma</span><span class="p">);</span>
<span class="cp">#undef QSIZE</span>

	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qregs</span><span class="p">,</span>
		   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">is_pti</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qpti</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">));</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">qpti</span><span class="o">-&gt;</span><span class="n">qhost</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">qpti_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ptisp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qpti_template</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PTI,ptisp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qpti_template</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;QLGC,isp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qpti_template</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SUNW,isp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qpti_template</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">qpti_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">qpti_sbus_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;qpti&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">qpti_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">qpti_sbus_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">qpti_sbus_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">qpti_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qpti_sbus_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">qpti_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qpti_sbus_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;QlogicISP SBUS driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David S. Miller (davem@davemloft.net)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;2.1&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;qlogic/isp1000.bin&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">qpti_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">qpti_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
