<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › ch.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ch.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SCSI Media Changer device driver for Linux 2.6</span>
<span class="cm"> *</span>
<span class="cm"> *     (c) 1996-2003 Gerd Knorr &lt;kraxel@bytesex.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define VERSION &quot;0.25&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/chio.h&gt;			</span><span class="cm">/* here are all the ioctls */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_driver.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_ioctl.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>

<span class="cp">#define CH_DT_MAX       16</span>
<span class="cp">#define CH_TYPES        8</span>
<span class="cp">#define CH_MAX_DEVS     128</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;device driver for scsi media changer devices&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Gerd Knorr &lt;kraxel@bytesex.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_CHARDEV_MAJOR</span><span class="p">(</span><span class="n">SCSI_CHANGER_MAJOR</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_SCSI_DEVICE</span><span class="p">(</span><span class="n">TYPE_MEDIUM_CHANGER</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">ch_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> \
    <span class="s">&quot;initialize element status on driver load (default: on)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">timeout_move</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">timeout_move</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">timeout_move</span><span class="p">,</span><span class="s">&quot;timeout for move commands &quot;</span>
		 <span class="s">&quot;(default: 300 seconds)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">timeout_init</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">timeout_init</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">timeout_init</span><span class="p">,</span><span class="s">&quot;timeout for INITIALIZE ELEMENT STATUS &quot;</span>
		 <span class="s">&quot;(default: 3600 seconds)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span><span class="s">&quot;be verbose (default: on)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span><span class="s">&quot;enable/disable debug messages, also prints more &quot;</span>
		 <span class="s">&quot;detailed sense codes on scsi errors (default: off)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dt_id</span><span class="p">[</span><span class="n">CH_DT_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">CH_DT_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dt_lun</span><span class="p">[</span><span class="n">CH_DT_MAX</span><span class="p">];</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dt_id</span><span class="p">,</span>  <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dt_lun</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="cm">/* tell the driver about vendor-specific slots */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vendor_firsts</span><span class="p">[</span><span class="n">CH_TYPES</span><span class="o">-</span><span class="mi">4</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vendor_counts</span><span class="p">[</span><span class="n">CH_TYPES</span><span class="o">-</span><span class="mi">4</span><span class="p">];</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">vendor_firsts</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">vendor_counts</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">vendor_labels</span><span class="p">[</span><span class="n">CH_TYPES</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;v0&quot;</span><span class="p">,</span> <span class="s">&quot;v1&quot;</span><span class="p">,</span> <span class="s">&quot;v2&quot;</span><span class="p">,</span> <span class="s">&quot;v3&quot;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>module<em>param</em>string<em>array(vendor</em>labels, NULL, 0444);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define DPRINTK(fmt, arg...)						\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (debug)							\</span>
<span class="cp">		printk(KERN_DEBUG &quot;%s: &quot; fmt, ch-&gt;name, ##arg);		\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define VPRINTK(level, fmt, arg...)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (verbose)							\</span>
<span class="cp">		printk(level &quot;%s: &quot; fmt, ch-&gt;name, ##arg);		\</span>
<span class="cp">} while (0)</span>

<span class="cm">/* ------------------------------------------------------------------- */</span>

<span class="cp">#define MAX_RETRIES   1</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span> <span class="n">ch_sysfs_class</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>    <span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span>                 <span class="n">minor</span><span class="p">;</span>
	<span class="kt">char</span>                <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scsi_device</span>  <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span>  <span class="o">**</span><span class="n">dt</span><span class="p">;</span>        <span class="cm">/* ptrs to data transfer elements */</span>
	<span class="n">u_int</span>               <span class="n">firsts</span><span class="p">[</span><span class="n">CH_TYPES</span><span class="p">];</span>
	<span class="n">u_int</span>               <span class="n">counts</span><span class="p">[</span><span class="n">CH_TYPES</span><span class="p">];</span>
	<span class="n">u_int</span>               <span class="n">unit_attention</span><span class="p">;</span>
	<span class="n">u_int</span>		    <span class="n">voltags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>	    <span class="n">lock</span><span class="p">;</span>
<span class="p">}</span> <span class="n">scsi_changer</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_IDR</span><span class="p">(</span><span class="n">ch_index_idr</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ch_index_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">sense</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">asc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">ascq</span><span class="p">;</span>
	<span class="kt">int</span>	       <span class="n">errno</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ch_err</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* Just filled in what looks right. Hav&#39;nt checked any standard paper for</span>
<span class="cm">   these errno assignments, so they may be wrong... */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">sense</span>  <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
		<span class="p">.</span><span class="n">asc</span>    <span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ascq</span>   <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="p">.</span><span class="n">errno</span>  <span class="o">=</span> <span class="n">EBADSLT</span><span class="p">,</span> <span class="cm">/* Invalid element address */</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">sense</span>  <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
		<span class="p">.</span><span class="n">asc</span>    <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ascq</span>   <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="p">.</span><span class="n">errno</span>  <span class="o">=</span> <span class="n">EBADE</span><span class="p">,</span>   <span class="cm">/* Import or export element accessed */</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">sense</span>  <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
		<span class="p">.</span><span class="n">asc</span>    <span class="o">=</span> <span class="mh">0x3B</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ascq</span>   <span class="o">=</span> <span class="mh">0x0D</span><span class="p">,</span>
		<span class="p">.</span><span class="n">errno</span>  <span class="o">=</span> <span class="n">EXFULL</span><span class="p">,</span>  <span class="cm">/* Medium destination element full */</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">sense</span>  <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
		<span class="p">.</span><span class="n">asc</span>    <span class="o">=</span> <span class="mh">0x3B</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ascq</span>   <span class="o">=</span> <span class="mh">0x0E</span><span class="p">,</span>
		<span class="p">.</span><span class="n">errno</span>  <span class="o">=</span> <span class="n">EBADE</span><span class="p">,</span>   <span class="cm">/* Medium source element empty */</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">sense</span>  <span class="o">=</span> <span class="n">ILLEGAL_REQUEST</span><span class="p">,</span>
		<span class="p">.</span><span class="n">asc</span>    <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ascq</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">errno</span>  <span class="o">=</span> <span class="n">EBADRQC</span><span class="p">,</span> <span class="cm">/* Invalid command operation code */</span>
	<span class="p">},{</span>
	        <span class="cm">/* end of list */</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* ------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ch_find_errno</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_sense_hdr</span> <span class="o">*</span><span class="n">sshdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check to see if additional sense information is available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sense_valid</span><span class="p">(</span><span class="n">sshdr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sshdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch_err</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch_err</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sense</span> <span class="o">==</span> <span class="n">sshdr</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ch_err</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">asc</span>   <span class="o">==</span> <span class="n">sshdr</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ch_err</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ascq</span>  <span class="o">==</span> <span class="n">sshdr</span><span class="o">-&gt;</span><span class="n">ascq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">ch_err</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errno</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_do_scsi</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	   <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">buflength</span><span class="p">,</span>
	   <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errno</span><span class="p">,</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_sense_hdr</span> <span class="n">sshdr</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INITIALIZE_ELEMENT_STATUS</span><span class="p">)</span>
		<span class="o">?</span> <span class="n">timeout_init</span> <span class="o">:</span> <span class="n">timeout_move</span><span class="p">;</span>

 <span class="nl">retry:</span>
	<span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;command: &quot;</span><span class="p">);</span>
		<span class="n">__scsi_print_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">scsi_execute_req</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
				  <span class="n">buflength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sshdr</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
				  <span class="n">MAX_RETRIES</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;result: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver_byte</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DRIVER_SENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">scsi_print_sense_hdr</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sshdr</span><span class="p">);</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ch_find_errno</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sshdr</span><span class="p">);</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">sshdr</span><span class="p">.</span><span class="n">sense_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UNIT_ATTENTION</span>:
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">unit_attention</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retries</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_elem_to_typecode</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">elem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CH_TYPES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&gt;=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">&amp;&amp;</span>
		    <span class="n">elem</span> <span class="o">&lt;</span>  <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
	            <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_read_element_status</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">elem</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>  <span class="n">cmd</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u_char</span>  <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span>     <span class="n">result</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

 <span class="nl">retry:</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_ELEMENT_STATUS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">voltags</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">ch_elem_to_typecode</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">elem</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="n">ch_do_scsi</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span> <span class="o">!=</span> <span class="n">elem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;asked for element 0x%02x, got 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">elem</span><span class="p">,(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">buffer</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">voltags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">voltags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;device has no volume tag support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;READ ELEMENT STATUS for element 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">elem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_init_elem</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;INITIALIZE ELEMENT STATUS, may take some time ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">INITIALIZE_ELEMENT_STATUS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ch_do_scsi</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;... finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_readconfig</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>  <span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u_char</span>  <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span>     <span class="n">result</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">lun</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>
	<span class="n">u_int</span>   <span class="n">elem</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SENSE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1d</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ch_do_scsi</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">result</span>  <span class="o">=</span> <span class="n">ch_do_scsi</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_MT</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span> <span class="mi">7</span><span class="p">];</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_MT</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span> <span class="mi">9</span><span class="p">];</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_ST</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">11</span><span class="p">];</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_ST</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_IE</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">14</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">15</span><span class="p">];</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_IE</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">16</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">17</span><span class="p">];</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">18</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">19</span><span class="p">];</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">20</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">21</span><span class="p">];</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;type #1 (mt): 0x%x+%d [medium transport]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_MT</span><span class="p">],</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_MT</span><span class="p">]);</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;type #2 (st): 0x%x+%d [storage]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_ST</span><span class="p">],</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_ST</span><span class="p">]);</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;type #3 (ie): 0x%x+%d [import/export]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_IE</span><span class="p">],</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_IE</span><span class="p">]);</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;type #4 (dt): 0x%x+%d [data transfer]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">],</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;reading element address assigment page failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* vendor specific element types */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">vendor_counts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">vendor_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_V1</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vendor_firsts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_V1</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vendor_counts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;type #%d (v%d): 0x%x+%d [%s, vendor specific]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">vendor_firsts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">vendor_counts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">vendor_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* look up the devices of the data transfer elements */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">),</span>
			 <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">elem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">elem</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">];</span> <span class="n">elem</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&lt;</span> <span class="n">CH_DT_MAX</span>  <span class="o">&amp;&amp;</span>  <span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">dt_id</span><span class="p">[</span><span class="n">elem</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">id</span>  <span class="o">=</span> <span class="n">dt_id</span><span class="p">[</span><span class="n">elem</span><span class="p">];</span>
			<span class="n">lun</span> <span class="o">=</span> <span class="n">dt_lun</span><span class="p">[</span><span class="n">elem</span><span class="p">];</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;dt 0x%x: [insmod option] &quot;</span><span class="p">,</span>
				<span class="n">elem</span><span class="o">+</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_read_element_status</span>
			   <span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">elem</span><span class="o">+</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">],</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;dt 0x%x: READ ELEMENT STATUS failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">elem</span><span class="o">+</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;dt 0x%x: &quot;</span><span class="p">,</span><span class="n">elem</span><span class="o">+</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_CONT</span><span class="p">,</span> <span class="s">&quot;not this SCSI bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_CONT</span><span class="p">,</span> <span class="s">&quot;ID/LUN unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">id</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
				<span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="n">id</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_CONT</span><span class="p">,</span> <span class="s">&quot;ID %i, LUN %i, &quot;</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">scsi_device_lookup</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
						   <span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
						   <span class="n">id</span><span class="p">,</span><span class="n">lun</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">[</span><span class="n">elem</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* should not happen */</span>
				<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_CONT</span><span class="p">,</span> <span class="s">&quot;Huh? device not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_CONT</span><span class="p">,</span> <span class="s">&quot;name: %8.8s %16.16s %4.4s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
					<span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span>
					<span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">voltags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_position</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">elem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>  <span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;position: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">elem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">trans</span><span class="p">)</span>
		<span class="n">trans</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_MT</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">POSITION_TO_ELEMENT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">trans</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">trans</span>       <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">elem</span>  <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">elem</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">=</span> <span class="n">rotate</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ch_do_scsi</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_move</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">src</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>  <span class="n">cmd</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;move: 0x%x =&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">trans</span><span class="p">)</span>
		<span class="n">trans</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_MT</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">MOVE_MEDIUM</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">trans</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">trans</span>       <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">src</span>   <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">src</span>         <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">dest</span>  <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">dest</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotate</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ch_do_scsi</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_exchange</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">trans</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">src</span><span class="p">,</span>
	    <span class="n">u_int</span> <span class="n">dest1</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">dest2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rotate2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>  <span class="n">cmd</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;exchange: 0x%x =&gt; 0x%x =&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">src</span><span class="p">,</span><span class="n">dest1</span><span class="p">,</span><span class="n">dest2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">trans</span><span class="p">)</span>
		<span class="n">trans</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">CHET_MT</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">EXCHANGE_MEDIUM</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">trans</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">trans</span>       <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">src</span>   <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">src</span>         <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">dest1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">dest1</span>       <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">dest2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">dest2</span>       <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rotate1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rotate2</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ch_do_scsi</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ch_check_voltag</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* restrict to ascii */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x7f</span> <span class="o">||</span> <span class="n">tag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">tag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="cm">/* don&#39;t allow search wildcards */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span> <span class="o">||</span>
		    <span class="n">tag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span>
			<span class="n">tag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_set_voltag</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">elem</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="n">alternate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>  <span class="n">cmd</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u_char</span>  <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%s %s voltag: 0x%x =&gt; </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">clear</span>     <span class="o">?</span> <span class="s">&quot;clear&quot;</span>     <span class="o">:</span> <span class="s">&quot;set&quot;</span><span class="p">,</span>
		<span class="n">alternate</span> <span class="o">?</span> <span class="s">&quot;alternate&quot;</span> <span class="o">:</span> <span class="s">&quot;primary&quot;</span><span class="p">,</span>
		<span class="n">elem</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">SEND_VOLUME_TAG</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">ch_elem_to_typecode</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">elem</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">clear</span>
		<span class="o">?</span> <span class="p">(</span><span class="n">alternate</span> <span class="o">?</span> <span class="mh">0x0d</span> <span class="o">:</span> <span class="mh">0x0c</span><span class="p">)</span>
		<span class="o">:</span> <span class="p">(</span><span class="n">alternate</span> <span class="o">?</span> <span class="mh">0x0b</span> <span class="o">:</span> <span class="mh">0x0a</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">ch_check_voltag</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ch_do_scsi</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ch_gstatus</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">type</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_read_element_status</span>
		    <span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dest</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CESTATUS_EXCEPT</span><span class="p">)</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;element 0x%x: asc=0x%x, ascq=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ch_read_element_status</span>
			<span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">retval</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_mutex</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_lock</span><span class="p">);</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_idr</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">ch</span> <span class="o">||</span> <span class="n">scsi_device_get</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_lock</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_lock</span><span class="p">);</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ch_checkrange</span><span class="p">(</span><span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">CH_TYPES</span>  <span class="o">||</span>  <span class="n">unit</span> <span class="o">&gt;=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">type</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ch_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIOGPARAMS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">changer_params</span> <span class="n">params</span><span class="p">;</span>

		<span class="n">params</span><span class="p">.</span><span class="n">cp_curpicker</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">params</span><span class="p">.</span><span class="n">cp_npickers</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_MT</span><span class="p">];</span>
		<span class="n">params</span><span class="p">.</span><span class="n">cp_nslots</span>    <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_ST</span><span class="p">];</span>
		<span class="n">params</span><span class="p">.</span><span class="n">cp_nportals</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_IE</span><span class="p">];</span>
		<span class="n">params</span><span class="p">.</span><span class="n">cp_ndrives</span>   <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_DT</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">CHIOGVPARAMS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">changer_vendor_params</span> <span class="n">vparams</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vparams</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vparams</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_V1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">vparams</span><span class="p">.</span><span class="n">cvp_n1</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_V1</span><span class="p">];</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">vparams</span><span class="p">.</span><span class="n">cvp_label1</span><span class="p">,</span><span class="n">vendor_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_V2</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">vparams</span><span class="p">.</span><span class="n">cvp_n2</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_V2</span><span class="p">];</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">vparams</span><span class="p">.</span><span class="n">cvp_label2</span><span class="p">,</span><span class="n">vendor_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_V3</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">vparams</span><span class="p">.</span><span class="n">cvp_n3</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_V3</span><span class="p">];</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">vparams</span><span class="p">.</span><span class="n">cvp_label3</span><span class="p">,</span><span class="n">vendor_labels</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_V4</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">vparams</span><span class="p">.</span><span class="n">cvp_n4</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">CHET_V4</span><span class="p">];</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">vparams</span><span class="p">.</span><span class="n">cvp_label4</span><span class="p">,</span><span class="n">vendor_labels</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vparams</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vparams</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CHIOPOSITION</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">changer_position</span> <span class="n">pos</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">pos</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_checkrange</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">pos</span><span class="p">.</span><span class="n">cp_type</span><span class="p">,</span> <span class="n">pos</span><span class="p">.</span><span class="n">cp_unit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CHIOPOSITION: invalid parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADSLT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ch_position</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				     <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">pos</span><span class="p">.</span><span class="n">cp_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos</span><span class="p">.</span><span class="n">cp_unit</span><span class="p">,</span>
				     <span class="n">pos</span><span class="p">.</span><span class="n">cp_flags</span> <span class="o">&amp;</span> <span class="n">CP_INVERT</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CHIOMOVE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">changer_move</span> <span class="n">mv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mv</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">mv</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_checkrange</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">mv</span><span class="p">.</span><span class="n">cm_fromtype</span><span class="p">,</span> <span class="n">mv</span><span class="p">.</span><span class="n">cm_fromunit</span><span class="p">)</span> <span class="o">||</span>
		    <span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_checkrange</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">mv</span><span class="p">.</span><span class="n">cm_totype</span><span class="p">,</span>   <span class="n">mv</span><span class="p">.</span><span class="n">cm_tounit</span>  <span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CHIOMOVE: invalid parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADSLT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ch_move</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				 <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">mv</span><span class="p">.</span><span class="n">cm_fromtype</span><span class="p">]</span> <span class="o">+</span> <span class="n">mv</span><span class="p">.</span><span class="n">cm_fromunit</span><span class="p">,</span>
				 <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">mv</span><span class="p">.</span><span class="n">cm_totype</span><span class="p">]</span>   <span class="o">+</span> <span class="n">mv</span><span class="p">.</span><span class="n">cm_tounit</span><span class="p">,</span>
				 <span class="n">mv</span><span class="p">.</span><span class="n">cm_flags</span> <span class="o">&amp;</span> <span class="n">CM_INVERT</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CHIOEXCHANGE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">changer_exchange</span> <span class="n">mv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mv</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">mv</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_checkrange</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">mv</span><span class="p">.</span><span class="n">ce_srctype</span><span class="p">,</span>  <span class="n">mv</span><span class="p">.</span><span class="n">ce_srcunit</span> <span class="p">)</span> <span class="o">||</span>
		    <span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_checkrange</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">mv</span><span class="p">.</span><span class="n">ce_fdsttype</span><span class="p">,</span> <span class="n">mv</span><span class="p">.</span><span class="n">ce_fdstunit</span><span class="p">)</span> <span class="o">||</span>
		    <span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_checkrange</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">mv</span><span class="p">.</span><span class="n">ce_sdsttype</span><span class="p">,</span> <span class="n">mv</span><span class="p">.</span><span class="n">ce_sdstunit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CHIOEXCHANGE: invalid parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADSLT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ch_exchange</span>
			<span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
			 <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">mv</span><span class="p">.</span><span class="n">ce_srctype</span><span class="p">]</span>  <span class="o">+</span> <span class="n">mv</span><span class="p">.</span><span class="n">ce_srcunit</span><span class="p">,</span>
			 <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">mv</span><span class="p">.</span><span class="n">ce_fdsttype</span><span class="p">]</span> <span class="o">+</span> <span class="n">mv</span><span class="p">.</span><span class="n">ce_fdstunit</span><span class="p">,</span>
			 <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">mv</span><span class="p">.</span><span class="n">ce_sdsttype</span><span class="p">]</span> <span class="o">+</span> <span class="n">mv</span><span class="p">.</span><span class="n">ce_sdstunit</span><span class="p">,</span>
			 <span class="n">mv</span><span class="p">.</span><span class="n">ce_flags</span> <span class="o">&amp;</span> <span class="n">CE_INVERT1</span><span class="p">,</span> <span class="n">mv</span><span class="p">.</span><span class="n">ce_flags</span> <span class="o">&amp;</span> <span class="n">CE_INVERT2</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CHIOGSTATUS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">changer_element_status</span> <span class="n">ces</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ces</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ces</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ces</span><span class="p">.</span><span class="n">ces_type</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ces</span><span class="p">.</span><span class="n">ces_type</span> <span class="o">&gt;=</span> <span class="n">CH_TYPES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">ch_gstatus</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ces</span><span class="p">.</span><span class="n">ces_type</span><span class="p">,</span> <span class="n">ces</span><span class="p">.</span><span class="n">ces_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CHIOGELEM</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">changer_get_element</span> <span class="n">cge</span><span class="p">;</span>
		<span class="n">u_char</span> <span class="n">ch_cmd</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">elem</span><span class="p">;</span>
		<span class="kt">int</span>     <span class="n">result</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cge</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">cge</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_checkrange</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">cge</span><span class="p">.</span><span class="n">cge_type</span><span class="p">,</span> <span class="n">cge</span><span class="p">.</span><span class="n">cge_unit</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">elem</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">cge</span><span class="p">.</span><span class="n">cge_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">cge</span><span class="p">.</span><span class="n">cge_unit</span><span class="p">;</span>

		<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="nl">voltag_retry:</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ch_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch_cmd</span><span class="p">));</span>
		<span class="n">ch_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_ELEMENT_STATUS</span><span class="p">;</span>
		<span class="n">ch_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">voltags</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">ch_elem_to_typecode</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">elem</span><span class="p">);</span>
		<span class="n">ch_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ch_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ch_cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ch_cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ch_do_scsi</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ch_cmd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cge</span><span class="p">.</span><span class="n">cge_status</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
			<span class="n">cge</span><span class="p">.</span><span class="n">cge_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CESTATUS_EXCEPT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cge</span><span class="p">.</span><span class="n">cge_errno</span> <span class="o">=</span> <span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cge</span><span class="p">.</span><span class="n">cge_flags</span> <span class="o">|=</span> <span class="n">CGE_SRC</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
					<span class="n">cge</span><span class="p">.</span><span class="n">cge_flags</span> <span class="o">|=</span> <span class="n">CGE_INVERT</span><span class="p">;</span>
				<span class="n">elem</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">27</span><span class="p">];</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&gt;=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
					    <span class="n">elem</span> <span class="o">&lt;</span>  <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
						<span class="n">cge</span><span class="p">.</span><span class="n">cge_srctype</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
						<span class="n">cge</span><span class="p">.</span><span class="n">cge_srcunit</span> <span class="o">=</span> <span class="n">elem</span><span class="o">-</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cge</span><span class="p">.</span><span class="n">cge_flags</span> <span class="o">|=</span> <span class="n">CGE_IDLUN</span><span class="p">;</span>
				<span class="n">cge</span><span class="p">.</span><span class="n">cge_id</span>  <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">23</span><span class="p">];</span>
				<span class="n">cge</span><span class="p">.</span><span class="n">cge_lun</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cge</span><span class="p">.</span><span class="n">cge_flags</span> <span class="o">|=</span> <span class="n">CGE_PVOLTAG</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">cge</span><span class="p">.</span><span class="n">cge_pvoltag</span><span class="p">,</span><span class="n">buffer</span><span class="o">+</span><span class="mi">28</span><span class="p">,</span><span class="mi">36</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cge</span><span class="p">.</span><span class="n">cge_flags</span> <span class="o">|=</span> <span class="n">CGE_AVOLTAG</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">cge</span><span class="p">.</span><span class="n">cge_avoltag</span><span class="p">,</span><span class="n">buffer</span><span class="o">+</span><span class="mi">64</span><span class="p">,</span><span class="mi">36</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">voltags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">voltags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;device has no volume tag support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">voltag_retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cge</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">cge</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CHIOINITELEM</span>:
	<span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ch_init_elem</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CHIOSVOLTAG</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">changer_set_voltag</span> <span class="n">csv</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">elem</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csv</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">csv</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ch_checkrange</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">csv</span><span class="p">.</span><span class="n">csv_type</span><span class="p">,</span> <span class="n">csv</span><span class="p">.</span><span class="n">csv_unit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CHIOSVOLTAG: invalid parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADSLT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">elem</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">firsts</span><span class="p">[</span><span class="n">csv</span><span class="p">.</span><span class="n">csv_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">csv</span><span class="p">.</span><span class="n">csv_unit</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ch_set_voltag</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span>
				       <span class="n">csv</span><span class="p">.</span><span class="n">csv_flags</span> <span class="o">&amp;</span> <span class="n">CSV_AVOLTAG</span><span class="p">,</span>
				       <span class="n">csv</span><span class="p">.</span><span class="n">csv_flags</span> <span class="o">&amp;</span> <span class="n">CSV_CLEARTAG</span><span class="p">,</span>
				       <span class="n">csv</span><span class="p">.</span><span class="n">csv_voltag</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">scsi_ioctl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>

<span class="k">struct</span> <span class="n">changer_element_status32</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">ces_type</span><span class="p">;</span>
	<span class="n">compat_uptr_t</span>	<span class="n">ces_data</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define CHIOGSTATUS32  _IOW(&#39;c&#39;, 8,struct changer_element_status32)</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ch_ioctl_compat</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIOGPARAMS</span>:
	<span class="k">case</span> <span class="n">CHIOGVPARAMS</span>:
	<span class="k">case</span> <span class="n">CHIOPOSITION</span>:
	<span class="k">case</span> <span class="n">CHIOMOVE</span>:
	<span class="k">case</span> <span class="n">CHIOEXCHANGE</span>:
	<span class="k">case</span> <span class="n">CHIOGELEM</span>:
	<span class="k">case</span> <span class="n">CHIOINITELEM</span>:
	<span class="k">case</span> <span class="n">CHIOSVOLTAG</span>:
		<span class="cm">/* compatible */</span>
		<span class="k">return</span> <span class="n">ch_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CHIOGSTATUS32</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">changer_element_status32</span> <span class="n">ces32</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ces32</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">ces32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ces32</span><span class="p">.</span><span class="n">ces_type</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ces32</span><span class="p">.</span><span class="n">ces_type</span> <span class="o">&gt;=</span> <span class="n">CH_TYPES</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">ces32</span><span class="p">.</span><span class="n">ces_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ch_gstatus</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ces32</span><span class="p">.</span><span class="n">ces_type</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nl">default:</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>return scsi<em>ioctl</em>compat(ch->device, cmd, (void*)arg);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* ------------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ch_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">class_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_MEDIUM_CHANGER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ch</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">ch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idr_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_idr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_ch</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">idr_get_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_idr</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;</span> <span class="n">CH_MAX_DEVS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">remove_idr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;ch%d&quot;</span><span class="p">,</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">class_dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">ch_sysfs_class</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				  <span class="n">MKDEV</span><span class="p">(</span><span class="n">SCSI_CHANGER_MAJOR</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">),</span> <span class="n">ch</span><span class="p">,</span>
				  <span class="s">&quot;s%s&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">class_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ch%d: device_create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ch</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">class_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">remove_idr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="n">ch_readconfig</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="p">)</span>
		<span class="n">ch_init_elem</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Attached scsi changer %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">remove_idr:</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_idr</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
<span class="nl">free_ch:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ch_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_changer</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_lock</span><span class="p">);</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_idr</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_lock</span><span class="p">);</span>

	<span class="n">device_destroy</span><span class="p">(</span><span class="n">ch_sysfs_class</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">SCSI_CHANGER_MAJOR</span><span class="p">,</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_driver</span> <span class="n">ch_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>     	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gendrv</span>     	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ch&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span>  <span class="o">=</span> <span class="n">ch_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ch_remove</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">changer_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ch_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">ch_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">ch_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">ch_ioctl_compat</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_ch_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SCSI Media Changer driver v&quot;</span> <span class="n">VERSION</span> <span class="s">&quot; </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">ch_sysfs_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;scsi_changer&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ch_sysfs_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ch_sysfs_class</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="n">SCSI_CHANGER_MAJOR</span><span class="p">,</span><span class="s">&quot;ch&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">changer_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unable to get major %d for SCSI-Changer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">SCSI_CHANGER_MAJOR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail2:</span>
	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">SCSI_CHANGER_MAJOR</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">);</span>
 <span class="nl">fail1:</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">ch_sysfs_class</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_ch_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_template</span><span class="p">.</span><span class="n">gendrv</span><span class="p">);</span>
	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">SCSI_CHANGER_MAJOR</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">);</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">ch_sysfs_class</span><span class="p">);</span>
	<span class="n">idr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_index_idr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_ch_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_ch_module</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
