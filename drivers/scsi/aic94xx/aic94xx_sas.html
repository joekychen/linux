<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › aic94xx › aic94xx_sas.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>aic94xx_sas.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Aic94xx SAS/SATA driver SAS definitions and hardware interface header file.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 Adaptec, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright (C) 2005 Luben Tuikov &lt;luben_tuikov@adaptec.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under GPLv2.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is part of the aic94xx driver.</span>
<span class="cm"> *</span>
<span class="cm"> * The aic94xx driver is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; version 2 of the</span>
<span class="cm"> * License.</span>
<span class="cm"> *</span>
<span class="cm"> * The aic94xx driver is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with the aic94xx driver; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _AIC94XX_SAS_H_</span>
<span class="cp">#define _AIC94XX_SAS_H_</span>

<span class="cp">#include &lt;scsi/libsas.h&gt;</span>

<span class="cm">/* ---------- DDBs ---------- */</span>
<span class="cm">/* DDBs are device descriptor blocks which describe a device in the</span>
<span class="cm"> * domain that this sequencer can maintain low-level connections for</span>
<span class="cm"> * us.  They are be 64 bytes.</span>
<span class="cm"> */</span>
<span class="cp">#define ASD_MAX_DDBS	128</span>

<span class="k">struct</span> <span class="n">asd_ddb_ssp_smp_target_port</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">conn_type</span><span class="p">;</span>	  <span class="cm">/* byte 0 */</span>
<span class="cp">#define DDB_TP_CONN_TYPE 0x81	  </span><span class="cm">/* Initiator port and addr frame type 0x01 */</span><span class="cp"></span>

	<span class="n">u8</span>     <span class="n">conn_rate</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">init_conn_tag</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">dest_sas_addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>  <span class="cm">/* bytes 4-11 */</span>

	<span class="n">__le16</span> <span class="n">send_queue_head</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">sq_suspended</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">ddb_type</span><span class="p">;</span>	  <span class="cm">/* DDB_TYPE_TARGET */</span>
<span class="cp">#define DDB_TYPE_UNUSED    0xFF</span>
<span class="cp">#define DDB_TYPE_TARGET    0xFE</span>
<span class="cp">#define DDB_TYPE_INITIATOR 0xFD</span>
<span class="cp">#define DDB_TYPE_PM_PORT   0xFC</span>

	<span class="n">__le16</span> <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">awt_def</span><span class="p">;</span>

	<span class="n">u8</span>     <span class="n">compat_features</span><span class="p">;</span>	  <span class="cm">/* byte 20 */</span>
	<span class="n">u8</span>     <span class="n">pathway_blocked_count</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">arb_wait_time</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">more_compat_features</span><span class="p">;</span> <span class="cm">/* byte 24 */</span>

	<span class="n">u8</span>     <span class="n">conn_mask</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags</span><span class="p">;</span>	  <span class="cm">/* concurrent conn:2,2 and open:0(1) */</span>
<span class="cp">#define CONCURRENT_CONN_SUPP 0x04</span>
<span class="cp">#define OPEN_REQUIRED        0x01</span>

	<span class="n">u16</span>    <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">exec_queue_tail</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">send_queue_tail</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sister_ddb</span><span class="p">;</span>

	<span class="n">__le16</span> <span class="n">_r_c</span><span class="p">;</span>

	<span class="n">u8</span>     <span class="n">max_concurrent_conn</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">num_concurrent_conn</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">num_contexts</span><span class="p">;</span>

	<span class="n">u8</span>     <span class="n">_r_d</span><span class="p">;</span>

	<span class="n">__le16</span> <span class="n">active_task_count</span><span class="p">;</span>

	<span class="n">u8</span>     <span class="n">_r_e</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

	<span class="n">u8</span>     <span class="n">itnl_reason</span><span class="p">;</span>	  <span class="cm">/* I_T nexus loss reason */</span>

	<span class="n">__le16</span> <span class="n">_r_f</span><span class="p">;</span>

	<span class="n">__le16</span> <span class="n">itnl_timeout</span><span class="p">;</span>
<span class="cp">#define ITNL_TIMEOUT_CONST 0x7D0 </span><span class="cm">/* 2 seconds */</span><span class="cp"></span>

	<span class="n">__le32</span> <span class="n">itnl_timestamp</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">asd_ddb_stp_sata_target_port</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">conn_type</span><span class="p">;</span>	  <span class="cm">/* byte 0 */</span>
	<span class="n">u8</span>     <span class="n">conn_rate</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">init_conn_tag</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">dest_sas_addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>  <span class="cm">/* bytes 4-11 */</span>

	<span class="n">__le16</span> <span class="n">send_queue_head</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">sq_suspended</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">ddb_type</span><span class="p">;</span>	  <span class="cm">/* DDB_TYPE_TARGET */</span>

	<span class="n">__le16</span> <span class="n">_r_a</span><span class="p">;</span>

	<span class="n">__be16</span> <span class="n">awt_def</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">compat_features</span><span class="p">;</span>	  <span class="cm">/* byte 20 */</span>
	<span class="n">u8</span>     <span class="n">pathway_blocked_count</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">arb_wait_time</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">more_compat_features</span><span class="p">;</span> <span class="cm">/* byte 24 */</span>

	<span class="n">u8</span>     <span class="n">conn_mask</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags</span><span class="p">;</span>	  <span class="cm">/* concurrent conn:2,2 and open:0(1) */</span>
<span class="cp">#define SATA_MULTIPORT     0x80</span>
<span class="cp">#define SUPPORTS_AFFIL     0x40</span>
<span class="cp">#define STP_AFFIL_POL      0x20</span>

	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags2</span><span class="p">;</span>		  <span class="cm">/* STP close policy:0 */</span>
<span class="cp">#define STP_CL_POL_NO_TX    0x00</span>
<span class="cp">#define STP_CL_POL_BTW_CMDS 0x01</span>

	<span class="n">__le16</span> <span class="n">exec_queue_tail</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">send_queue_tail</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sister_ddb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">ata_cmd_scbptr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">sata_tag_alloc_mask</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">active_task_count</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">_r_c</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">sata_sactive</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">num_sata_tags</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">sata_status</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">sata_ending_status</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">itnl_reason</span><span class="p">;</span>	  <span class="cm">/* I_T nexus loss reason */</span>
	<span class="n">__le16</span> <span class="n">ncq_data_scb_ptr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">itnl_timeout</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">itnl_timestamp</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* This struct asd_ddb_init_port, describes the device descriptor block</span>
<span class="cm"> * of an initiator port (when the sequencer is operating in target mode).</span>
<span class="cm"> * Bytes [0,11] and [20,27] are from the OPEN address frame.</span>
<span class="cm"> * The sequencer allocates an initiator port DDB entry.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asd_ddb_init_port</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">conn_type</span><span class="p">;</span>	  <span class="cm">/* byte 0 */</span>
	<span class="n">u8</span>     <span class="n">conn_rate</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">init_conn_tag</span><span class="p">;</span>     <span class="cm">/* BE */</span>
	<span class="n">u8</span>     <span class="n">dest_sas_addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">send_queue_head</span><span class="p">;</span>   <span class="cm">/* LE, byte 12 */</span>
	<span class="n">u8</span>     <span class="n">sq_suspended</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">ddb_type</span><span class="p">;</span>	  <span class="cm">/* DDB_TYPE_INITIATOR */</span>
	<span class="n">__le16</span> <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">awt_def</span><span class="p">;</span>		  <span class="cm">/* BE */</span>
	<span class="n">u8</span>     <span class="n">compat_features</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">pathway_blocked_count</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">arb_wait_time</span><span class="p">;</span>	  <span class="cm">/* BE */</span>
	<span class="n">__be32</span> <span class="n">more_compat_features</span><span class="p">;</span> <span class="cm">/* BE */</span>
	<span class="n">u8</span>     <span class="n">conn_mask</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags</span><span class="p">;</span>		  <span class="cm">/* == 5 */</span>
	<span class="n">u16</span>    <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">exec_queue_tail</span><span class="p">;</span>	  <span class="cm">/* execution queue tail */</span>
	<span class="n">__le16</span> <span class="n">send_queue_tail</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sister_ddb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">init_resp_timeout</span><span class="p">;</span> <span class="cm">/* initiator response timeout */</span>
	<span class="n">__le32</span> <span class="n">_r_c</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">active_tasks</span><span class="p">;</span>	  <span class="cm">/* active task count */</span>
	<span class="n">__le16</span> <span class="n">init_list</span><span class="p">;</span>	  <span class="cm">/* initiator list link pointer */</span>
	<span class="n">__le32</span> <span class="n">_r_d</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">max_conn_to</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* from Conn-Disc mode page, in us, LE */</span>
	<span class="n">u8</span>     <span class="n">itnl_reason</span><span class="p">;</span>	  <span class="cm">/* I_T nexus loss reason */</span>
	<span class="n">__le16</span> <span class="n">bus_inact_to</span><span class="p">;</span> <span class="cm">/* from Conn-Disc mode page, in 100 us, LE */</span>
	<span class="n">__le16</span> <span class="n">itnl_to</span><span class="p">;</span>		  <span class="cm">/* from the Protocol Specific Port Ctrl MP */</span>
	<span class="n">__le32</span> <span class="n">itnl_timestamp</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* This struct asd_ddb_sata_tag, describes a look-up table to be used</span>
<span class="cm"> * by the sequencers.  SATA II, IDENTIFY DEVICE data, word 76, bit 8:</span>
<span class="cm"> * NCQ support.  This table is used by the sequencers to find the</span>
<span class="cm"> * corresponding SCB, given a SATA II tag value.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asd_ddb_sata_tag</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">scb_pointer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* This struct asd_ddb_sata_pm_table, describes a port number to</span>
<span class="cm"> * connection handle look-up table.  SATA targets attached to a port</span>
<span class="cm"> * multiplier require a 4-bit port number value.  There is one DDB</span>
<span class="cm"> * entry of this type for each SATA port multiplier (sister DDB).</span>
<span class="cm"> * Given a SATA PM port number, this table gives us the SATA PM Port</span>
<span class="cm"> * DDB of the SATA port multiplier port (i.e. the SATA target</span>
<span class="cm"> * discovered on the port).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asd_ddb_sata_pm_table</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">ddb_pointer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">_r_a</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* This struct asd_ddb_sata_pm_port, describes the SATA port multiplier</span>
<span class="cm"> * port format DDB.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asd_ddb_sata_pm_port</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">_r_a</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">u8</span>     <span class="n">ddb_type</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">u8</span>     <span class="n">pm_port_flags</span><span class="p">;</span>
<span class="cp">#define PM_PORT_MASK  0xF0</span>
<span class="cp">#define PM_PORT_SET   0x02</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">sister_ddb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">ata_cmd_scbptr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">sata_tag_alloc_mask</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">active_task_count</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">parent_ddb</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">sata_sactive</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">num_sata_tags</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">sata_status</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">sata_ending_status</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_d</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* This struct asd_ddb_seq_shared, describes a DDB shared by the</span>
<span class="cm"> * central and link sequencers.  port_map_by_links is indexed phy</span>
<span class="cm"> * number [0,7]; each byte is a bit mask of all the phys that are in</span>
<span class="cm"> * the same port as the indexed phy.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asd_ddb_seq_shared</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">q_free_ddb_head</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">q_free_ddb_tail</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">q_free_ddb_cnt</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">q_used_ddb_head</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">q_used_ddb_tail</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">shared_mem_lock</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">smp_conn_tag</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">est_nexus_buf_cnt</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">est_nexus_buf_thresh</span><span class="p">;</span>
	<span class="n">u32</span>    <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">settable_max_contexts</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">[</span><span class="mi">23</span><span class="p">];</span>
	<span class="n">u8</span>     <span class="n">conn_not_active</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">phy_is_up</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span>     <span class="n">port_map_by_links</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* ---------- SG Element ---------- */</span>

<span class="cm">/* This struct sg_el, describes the hardware scatter gather buffer</span>
<span class="cm"> * element.  All entries are little endian.  In an SCB, there are 2 of</span>
<span class="cm"> * this, plus one more, called a link element of this indicating a</span>
<span class="cm"> * sublist if needed.</span>
<span class="cm"> *</span>
<span class="cm"> * A link element has only the bus address set and the flags (DS) bit</span>
<span class="cm"> * valid.  The bus address points to the start of the sublist.</span>
<span class="cm"> *</span>
<span class="cm"> * If a sublist is needed, then that sublist should also include the 2</span>
<span class="cm"> * sg_el embedded in the SCB, in which case next_sg_offset is 32,</span>
<span class="cm"> * since sizeof(sg_el) = 16; EOS should be 1 and EOL 0 in this case.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sg_el</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">bus_addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">_r</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">next_sg_offs</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define ASD_SG_EL_DS_MASK   0x30</span>
<span class="cp">#define ASD_SG_EL_DS_OCM    0x10</span>
<span class="cp">#define ASD_SG_EL_DS_HM     0x00</span>
<span class="cp">#define ASD_SG_EL_LIST_MASK 0xC0</span>
<span class="cp">#define ASD_SG_EL_LIST_EOL  0x40</span>
<span class="cp">#define ASD_SG_EL_LIST_EOS  0x80</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* ---------- SCBs ---------- */</span>

<span class="cm">/* An SCB (sequencer control block) is comprised of a common header</span>
<span class="cm"> * and a task part, for a total of 128 bytes.  All fields are in LE</span>
<span class="cm"> * order, unless otherwise noted.</span>
<span class="cm"> */</span>

<span class="cm">/* This struct scb_header, defines the SCB header format.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">scb_header</span> <span class="p">{</span>
	<span class="n">__le64</span> <span class="n">next_scb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">index</span><span class="p">;</span>		  <span class="cm">/* transaction context */</span>
	<span class="n">u8</span>     <span class="n">opcode</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* SCB opcodes: Execution queue</span>
<span class="cm"> */</span>
<span class="cp">#define INITIATE_SSP_TASK       0x00</span>
<span class="cp">#define INITIATE_LONG_SSP_TASK  0x01</span>
<span class="cp">#define INITIATE_BIDIR_SSP_TASK 0x02</span>
<span class="cp">#define SCB_ABORT_TASK          0x03</span>
<span class="cp">#define INITIATE_SSP_TMF        0x04</span>
<span class="cp">#define SSP_TARG_GET_DATA       0x05</span>
<span class="cp">#define SSP_TARG_GET_DATA_GOOD  0x06</span>
<span class="cp">#define SSP_TARG_SEND_RESP      0x07</span>
<span class="cp">#define QUERY_SSP_TASK          0x08</span>
<span class="cp">#define INITIATE_ATA_TASK       0x09</span>
<span class="cp">#define INITIATE_ATAPI_TASK     0x0a</span>
<span class="cp">#define CONTROL_ATA_DEV         0x0b</span>
<span class="cp">#define INITIATE_SMP_TASK       0x0c</span>
<span class="cp">#define SMP_TARG_SEND_RESP      0x0f</span>

<span class="cm">/* SCB opcodes: Send Queue</span>
<span class="cm"> */</span>
<span class="cp">#define SSP_TARG_SEND_DATA      0x40</span>
<span class="cp">#define SSP_TARG_SEND_DATA_GOOD 0x41</span>

<span class="cm">/* SCB opcodes: Link Queue</span>
<span class="cm"> */</span>
<span class="cp">#define CONTROL_PHY             0x80</span>
<span class="cp">#define SEND_PRIMITIVE          0x81</span>
<span class="cp">#define INITIATE_LINK_ADM_TASK  0x82</span>

<span class="cm">/* SCB opcodes: other</span>
<span class="cm"> */</span>
<span class="cp">#define EMPTY_SCB               0xc0</span>
<span class="cp">#define INITIATE_SEQ_ADM_TASK   0xc1</span>
<span class="cp">#define EST_ICL_TARG_WINDOW     0xc2</span>
<span class="cp">#define COPY_MEM                0xc3</span>
<span class="cp">#define CLEAR_NEXUS             0xc4</span>
<span class="cp">#define INITIATE_DDB_ADM_TASK   0xc6</span>
<span class="cp">#define ESTABLISH_NEXUS_ESCB    0xd0</span>

<span class="cp">#define LUN_SIZE                8</span>

<span class="cm">/* See SAS spec, task IU</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ssp_task_iu</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">lun</span><span class="p">[</span><span class="n">LUN_SIZE</span><span class="p">];</span>	  <span class="cm">/* BE */</span>
	<span class="n">u16</span>    <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">tmf</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">tag</span><span class="p">;</span>		  <span class="cm">/* BE */</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* See SAS spec, command IU</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ssp_command_iu</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">lun</span><span class="p">[</span><span class="n">LUN_SIZE</span><span class="p">];</span>
	<span class="n">u8</span>     <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">efb_prio_attr</span><span class="p">;</span>	  <span class="cm">/* enable first burst, task prio &amp; attr */</span>
<span class="cp">#define EFB_MASK        0x80</span>
<span class="cp">#define TASK_PRIO_MASK	0x78</span>
<span class="cp">#define TASK_ATTR_MASK  0x07</span>

	<span class="n">u8</span>    <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">add_cdb_len</span><span class="p">;</span>	  <span class="cm">/* in dwords, since bit 0,1 are reserved */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u8</span>     <span class="n">cdb</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le64</span> <span class="n">long_cdb_addr</span><span class="p">;</span>	  <span class="cm">/* bus address, LE */</span>
			<span class="n">__le32</span> <span class="n">long_cdb_size</span><span class="p">;</span>	  <span class="cm">/* LE */</span>
			<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">u8</span>     <span class="n">eol_ds</span><span class="p">;</span>		  <span class="cm">/* eol:6,6, ds:5,4 */</span>
		<span class="p">}</span> <span class="n">long_cdb</span><span class="p">;</span>	  <span class="cm">/* sequencer extension */</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">xfer_rdy_iu</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">requested_offset</span><span class="p">;</span>  <span class="cm">/* BE */</span>
	<span class="n">__be32</span> <span class="n">write_data_len</span><span class="p">;</span>	  <span class="cm">/* BE */</span>
	<span class="n">__be32</span> <span class="n">_r_a</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* ---------- SCB tasks ---------- */</span>

<span class="cm">/* This is both ssp_task and long_ssp_task</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">initiate_ssp_task</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">proto_conn_rate</span><span class="p">;</span>	  <span class="cm">/* proto:6,4, conn_rate:3,0 */</span>
	<span class="n">__le32</span> <span class="n">total_xfer_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_frame_hdr</span>  <span class="n">ssp_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_command_iu</span> <span class="n">ssp_cmd</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sister_scb</span><span class="p">;</span>	  <span class="cm">/* 0xFFFF */</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>	  <span class="cm">/* index to DDB for the intended target */</span>
	<span class="n">u8</span>     <span class="n">data_dir</span><span class="p">;</span>	  <span class="cm">/* :1,0 */</span>
<span class="cp">#define DATA_DIR_NONE   0x00</span>
<span class="cp">#define DATA_DIR_IN     0x01</span>
<span class="cp">#define DATA_DIR_OUT    0x02</span>
<span class="cp">#define DATA_DIR_BYRECIPIENT 0x03</span>

	<span class="n">u8</span>     <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">retry_count</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sg_el</span> <span class="n">sg_element</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* 2 real and 1 link */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* This defines both ata_task and atapi_task.</span>
<span class="cm"> * ata: C bit of FIS should be 1,</span>
<span class="cm"> * atapi: C bit of FIS should be 1, and command register should be 0xA0,</span>
<span class="cm"> * to indicate a packet command.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">initiate_ata_task</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">proto_conn_rate</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">total_xfer_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_to_dev_fis</span> <span class="n">fis</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">data_offs</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">atapi_packet</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span>     <span class="n">_r_a</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">sister_scb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">ata_flags</span><span class="p">;</span>	  <span class="cm">/* CSMI:6,6, DTM:4,4, QT:3,3, data dir:1,0 */</span>
<span class="cp">#define CSMI_TASK           0x40</span>
<span class="cp">#define DATA_XFER_MODE_DMA  0x10</span>
<span class="cp">#define ATA_Q_TYPE_MASK     0x08</span>
<span class="cp">#define	ATA_Q_TYPE_UNTAGGED 0x00</span>
<span class="cp">#define ATA_Q_TYPE_NCQ      0x08</span>

	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">retry_count</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define STP_AFFIL_POLICY   0x20</span>
<span class="cp">#define SET_AFFIL_POLICY   0x10</span>
<span class="cp">#define RET_PARTIAL_SGLIST 0x02</span>

	<span class="n">u8</span>     <span class="n">_r_d</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sg_el</span> <span class="n">sg_element</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">initiate_smp_task</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">proto_conn_rate</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_a</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sg_el</span> <span class="n">smp_req</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sister_scb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sg_el</span> <span class="n">smp_resp</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_d</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">control_phy</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">phy_id</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">sub_func</span><span class="p">;</span>
<span class="cp">#define DISABLE_PHY            0x00</span>
<span class="cp">#define ENABLE_PHY             0x01</span>
<span class="cp">#define RELEASE_SPINUP_HOLD    0x02</span>
<span class="cp">#define ENABLE_PHY_NO_SAS_OOB  0x03</span>
<span class="cp">#define ENABLE_PHY_NO_SATA_OOB 0x04</span>
<span class="cp">#define PHY_NO_OP              0x05</span>
<span class="cp">#define EXECUTE_HARD_RESET     0x81</span>

	<span class="n">u8</span>     <span class="n">func_mask</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">speed_mask</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">hot_plug_delay</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">port_type</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define DEV_PRES_TIMER_OVERRIDE_ENABLE 0x01</span>
<span class="cp">#define DISABLE_PHY_IF_OOB_FAILS       0x02</span>

	<span class="n">__le32</span> <span class="n">timeout_override</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">link_reset_retries</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_a</span><span class="p">[</span><span class="mi">47</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">[</span><span class="mi">56</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">control_ata_dev</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">proto_conn_rate</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">_r_a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_to_dev_fis</span> <span class="n">fis</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">sister_scb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">ata_flags</span><span class="p">;</span>	  <span class="cm">/* 0 */</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">55</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">empty_scb</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">num_valid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">_r_a</span><span class="p">;</span>
<span class="cp">#define ASD_EDBS_PER_SCB 7</span>
<span class="cm">/* header+data+CRC+DMA suffix data */</span>
<span class="cp">#define ASD_EDB_SIZE (24+1024+4+16)</span>
	<span class="k">struct</span> <span class="n">sg_el</span> <span class="n">eb</span><span class="p">[</span><span class="n">ASD_EDBS_PER_SCB</span><span class="p">];</span>
<span class="cp">#define ELEMENT_NOT_VALID  0xC0</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">initiate_link_adm</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">phy_id</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">sub_func</span><span class="p">;</span>
<span class="cp">#define GET_LINK_ERROR_COUNT      0x00</span>
<span class="cp">#define RESET_LINK_ERROR_COUNT    0x01</span>
<span class="cp">#define ENABLE_NOTIFY_SPINUP_INTS 0x02</span>

	<span class="n">u8</span>     <span class="n">_r_a</span><span class="p">[</span><span class="mi">57</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">[</span><span class="mi">56</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">copy_memory</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">xfer_len</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">src_busaddr</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">src_ds</span><span class="p">;</span>		  <span class="cm">/* See definition of sg_el */</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">45</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">_r_d</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">dest_busaddr</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">dest_ds</span><span class="p">;</span>		  <span class="cm">/* See definition of sg_el */</span>
	<span class="n">u8</span>     <span class="n">_r_e</span><span class="p">[</span><span class="mi">39</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">abort_task</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">proto_conn_rate</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">_r_a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_frame_hdr</span> <span class="n">ssp_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_task_iu</span> <span class="n">ssp_task</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sister_scb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags</span><span class="p">;</span>	  <span class="cm">/* ovrd_itnl_timer:3,3, suspend_data_trans:2,2 */</span>
<span class="cp">#define SUSPEND_DATA_TRANS 0x04</span>

	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">retry_count</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">index</span><span class="p">;</span>  <span class="cm">/* Transaction context of task to be queried */</span>
	<span class="n">__le16</span> <span class="n">itnl_to</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_d</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">clear_nexus</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">nexus</span><span class="p">;</span>
<span class="cp">#define NEXUS_ADAPTER  0x00</span>
<span class="cp">#define NEXUS_PORT     0x01</span>
<span class="cp">#define NEXUS_I_T      0x02</span>
<span class="cp">#define NEXUS_I_T_L    0x03</span>
<span class="cp">#define NEXUS_TAG      0x04</span>
<span class="cp">#define NEXUS_TRANS_CX 0x05</span>
<span class="cp">#define NEXUS_SATA_TAG 0x06</span>
<span class="cp">#define NEXUS_T_L      0x07</span>
<span class="cp">#define NEXUS_L        0x08</span>
<span class="cp">#define NEXUS_T_TAG    0x09</span>

	<span class="n">__le32</span> <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define SUSPEND_TX     0x80</span>
<span class="cp">#define RESUME_TX      0x40</span>
<span class="cp">#define SEND_Q         0x04</span>
<span class="cp">#define EXEC_Q         0x02</span>
<span class="cp">#define NOTINQ         0x01</span>

	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>     <span class="n">conn_mask</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ssp_task_iu</span> <span class="n">ssp_task</span><span class="p">;</span> <span class="cm">/* LUN and TAG */</span>
	<span class="n">__le16</span> <span class="n">_r_d</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">_r_e</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">index</span><span class="p">;</span>  <span class="cm">/* Transaction context of task to be cleared */</span>
	<span class="n">__le16</span> <span class="n">context</span><span class="p">;</span>		  <span class="cm">/* Clear nexus context */</span>
	<span class="n">u8</span>     <span class="n">_r_f</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">initiate_ssp_tmf</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">proto_conn_rate</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">_r_a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_frame_hdr</span> <span class="n">ssp_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_task_iu</span> <span class="n">ssp_task</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sister_scb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">flags</span><span class="p">;</span>	  <span class="cm">/* itnl override and suspend data tx */</span>
<span class="cp">#define OVERRIDE_ITNL_TIMER  8</span>

	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">retry_count</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">index</span><span class="p">;</span>  <span class="cm">/* Transaction context of task to be queried */</span>
	<span class="n">__le16</span> <span class="n">itnl_to</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_d</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* Transmits an arbitrary primitive on the link.</span>
<span class="cm"> * Used for NOTIFY and BROADCAST.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">send_prim</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">phy_id</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">wait_transmit</span><span class="p">;</span> 	  <span class="cm">/* :0,0 */</span>
	<span class="n">u8</span>     <span class="n">xmit_flags</span><span class="p">;</span>
<span class="cp">#define XMTPSIZE_MASK      0xF0</span>
<span class="cp">#define XMTPSIZE_SINGLE    0x10</span>
<span class="cp">#define XMTPSIZE_REPEATED  0x20</span>
<span class="cp">#define XMTPSIZE_CONT      0x20</span>
<span class="cp">#define XMTPSIZE_TRIPLE    0x30</span>
<span class="cp">#define XMTPSIZE_REDUNDANT 0x60</span>
<span class="cp">#define XMTPSIZE_INF       0</span>

<span class="cp">#define XMTCONTEN          0x04</span>
<span class="cp">#define XMTPFRM            0x02	  </span><span class="cm">/* Transmit at the next frame boundary */</span><span class="cp"></span>
<span class="cp">#define XMTPIMM            0x01	  </span><span class="cm">/* Transmit immediately */</span><span class="cp"></span>

	<span class="n">__le16</span> <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">prim</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>		  <span class="cm">/* K, D0, D1, D2 */</span>
	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">56</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* This describes both SSP Target Get Data and SSP Target Get Data And</span>
<span class="cm"> * Send Good Response SCBs.  Used when the sequencer is operating in</span>
<span class="cm"> * target mode...</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ssp_targ_get_data</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">proto_conn_rate</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">total_xfer_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_frame_hdr</span> <span class="n">ssp_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xfer_rdy_iu</span>  <span class="n">xfer_rdy</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">lun</span><span class="p">[</span><span class="n">LUN_SIZE</span><span class="p">];</span>
	<span class="n">__le64</span> <span class="n">_r_a</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sister_scb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">conn_handle</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">data_dir</span><span class="p">;</span>	  <span class="cm">/* 01b */</span>
	<span class="n">u8</span>     <span class="n">_r_b</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">retry_count</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">_r_c</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sg_el</span> <span class="n">sg_element</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* ---------- The actual SCB struct ---------- */</span>

<span class="k">struct</span> <span class="n">scb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">initiate_ssp_task</span> <span class="n">ssp_task</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">initiate_ata_task</span> <span class="n">ata_task</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">initiate_smp_task</span> <span class="n">smp_task</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">control_phy</span>       <span class="n">control_phy</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">control_ata_dev</span>   <span class="n">control_ata_dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">empty_scb</span>         <span class="n">escb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">initiate_link_adm</span> <span class="n">link_adm</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">copy_memory</span>       <span class="n">cp_mem</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">abort_task</span>        <span class="n">abort_task</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">clear_nexus</span>       <span class="n">clear_nexus</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">initiate_ssp_tmf</span>  <span class="n">ssp_tmf</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* ---------- Done List ---------- */</span>
<span class="cm">/* The done list entry opcode field is defined below.</span>
<span class="cm"> * The mnemonic encoding and meaning is as follows:</span>
<span class="cm"> * TC - Task Complete, status was received and acknowledged</span>
<span class="cm"> * TF - Task Failed, indicates an error prior to receiving acknowledgment</span>
<span class="cm"> *   for the command:</span>
<span class="cm"> *   - no conn,</span>
<span class="cm"> *   - NACK or R_ERR received in response to this command,</span>
<span class="cm"> *   - credit blocked or not available, or in the case of SMP request,</span>
<span class="cm"> *   - no SMP response was received.</span>
<span class="cm"> *   In these four cases it is known that the target didn&#39;t receive the</span>
<span class="cm"> *   command.</span>
<span class="cm"> * TI - Task Interrupted, error after the command was acknowledged.  It is</span>
<span class="cm"> *   known that the command was received by the target.</span>
<span class="cm"> * TU - Task Unacked, command was transmitted but neither ACK (R_OK) nor NAK</span>
<span class="cm"> *   (R_ERR) was received due to loss of signal, broken connection, loss of</span>
<span class="cm"> *   dword sync or other reason.  The application client should send the</span>
<span class="cm"> *   appropriate task query.</span>
<span class="cm"> * TA - Task Aborted, see TF.</span>
<span class="cm"> * _RESP - The completion includes an empty buffer containing status.</span>
<span class="cm"> * TO - Timeout.</span>
<span class="cm"> */</span>
<span class="cp">#define TC_NO_ERROR             0x00</span>
<span class="cp">#define TC_UNDERRUN             0x01</span>
<span class="cp">#define TC_OVERRUN              0x02</span>
<span class="cp">#define TF_OPEN_TO              0x03</span>
<span class="cp">#define TF_OPEN_REJECT          0x04</span>
<span class="cp">#define TI_BREAK                0x05</span>
<span class="cp">#define TI_PROTO_ERR            0x06</span>
<span class="cp">#define TC_SSP_RESP             0x07</span>
<span class="cp">#define TI_PHY_DOWN             0x08</span>
<span class="cp">#define TF_PHY_DOWN             0x09</span>
<span class="cp">#define TC_LINK_ADM_RESP        0x0a</span>
<span class="cp">#define TC_CSMI                 0x0b</span>
<span class="cp">#define TC_ATA_RESP             0x0c</span>
<span class="cp">#define TU_PHY_DOWN             0x0d</span>
<span class="cp">#define TU_BREAK                0x0e</span>
<span class="cp">#define TI_SATA_TO              0x0f</span>
<span class="cp">#define TI_NAK                  0x10</span>
<span class="cp">#define TC_CONTROL_PHY          0x11</span>
<span class="cp">#define TF_BREAK                0x12</span>
<span class="cp">#define TC_RESUME               0x13</span>
<span class="cp">#define TI_ACK_NAK_TO           0x14</span>
<span class="cp">#define TF_SMPRSP_TO            0x15</span>
<span class="cp">#define TF_SMP_XMIT_RCV_ERR     0x16</span>
<span class="cp">#define TC_PARTIAL_SG_LIST      0x17</span>
<span class="cp">#define TU_ACK_NAK_TO           0x18</span>
<span class="cp">#define TU_SATA_TO              0x19</span>
<span class="cp">#define TF_NAK_RECV             0x1a</span>
<span class="cp">#define TA_I_T_NEXUS_LOSS       0x1b</span>
<span class="cp">#define TC_ATA_R_ERR_RECV       0x1c</span>
<span class="cp">#define TF_TMF_NO_CTX           0x1d</span>
<span class="cp">#define TA_ON_REQ               0x1e</span>
<span class="cp">#define TF_TMF_NO_TAG           0x1f</span>
<span class="cp">#define TF_TMF_TAG_FREE         0x20</span>
<span class="cp">#define TF_TMF_TASK_DONE        0x21</span>
<span class="cp">#define TF_TMF_NO_CONN_HANDLE   0x22</span>
<span class="cp">#define TC_TASK_CLEARED         0x23</span>
<span class="cp">#define TI_SYNCS_RECV           0x24</span>
<span class="cp">#define TU_SYNCS_RECV           0x25</span>
<span class="cp">#define TF_IRTT_TO              0x26</span>
<span class="cp">#define TF_NO_SMP_CONN          0x27</span>
<span class="cp">#define TF_IU_SHORT             0x28</span>
<span class="cp">#define TF_DATA_OFFS_ERR        0x29</span>
<span class="cp">#define TF_INV_CONN_HANDLE      0x2a</span>
<span class="cp">#define TF_REQUESTED_N_PENDING  0x2b</span>

<span class="cm">/* 0xc1 - 0xc7: empty buffer received,</span>
<span class="cm">   0xd1 - 0xd7: establish nexus empty buffer received</span>
<span class="cm">*/</span>
<span class="cm">/* This is the ESCB mask */</span>
<span class="cp">#define ESCB_RECVD              0xC0</span>


<span class="cm">/* This struct done_list_struct defines the done list entry.</span>
<span class="cm"> * All fields are LE.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">done_list_struct</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">index</span><span class="p">;</span>		  <span class="cm">/* aka transaction context */</span>
	<span class="n">u8</span>     <span class="n">opcode</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">status_block</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span>     <span class="n">toggle</span><span class="p">;</span>		  <span class="cm">/* bit 0 */</span>
<span class="cp">#define DL_TOGGLE_MASK     0x01</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/* ---------- PHYS ---------- */</span>

<span class="k">struct</span> <span class="n">asd_phy</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">asd_sas_phy</span>        <span class="n">sas_phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asd_phy_desc</span>   <span class="o">*</span><span class="n">phy_desc</span><span class="p">;</span> <span class="cm">/* hw profile */</span>

	<span class="k">struct</span> <span class="n">sas_identify_frame</span> <span class="o">*</span><span class="n">identify_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asd_dma_tok</span>  <span class="o">*</span><span class="n">id_frm_tok</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asd_port</span>     <span class="o">*</span><span class="n">asd_port</span><span class="p">;</span>

	<span class="n">u8</span>         <span class="n">frame_rcvd</span><span class="p">[</span><span class="n">ASD_EDB_SIZE</span><span class="p">];</span>
<span class="p">};</span>


<span class="cp">#define ASD_SCB_SIZE sizeof(struct scb)</span>
<span class="cp">#define ASD_DDB_SIZE sizeof(struct asd_ddb_ssp_smp_target_port)</span>

<span class="cm">/* Define this to 0 if you do not want NOTIFY (ENABLE SPINIP) sent.</span>
<span class="cm"> * Default: 0x10 (it&#39;s a mask)</span>
<span class="cm"> */</span>
<span class="cp">#define ASD_NOTIFY_ENABLE_SPINUP  0x10</span>

<span class="cm">/* If enabled, set this to the interval between transmission</span>
<span class="cm"> * of NOTIFY (ENABLE SPINUP). In units of 200 us.</span>
<span class="cm"> */</span>
<span class="cp">#define ASD_NOTIFY_TIMEOUT        2500</span>

<span class="cm">/* Initial delay after OOB, before we transmit NOTIFY (ENABLE SPINUP).</span>
<span class="cm"> * If 0, transmit immediately. In milliseconds.</span>
<span class="cm"> */</span>
<span class="cp">#define ASD_NOTIFY_DOWN_COUNT     0</span>

<span class="cm">/* Device present timer timeout constant, 10 ms. */</span>
<span class="cp">#define ASD_DEV_PRESENT_TIMEOUT   0x2710</span>

<span class="cp">#define ASD_SATA_INTERLOCK_TIMEOUT 0</span>

<span class="cm">/* How long to wait before shutting down an STP connection, unless</span>
<span class="cm"> * an STP target sent frame(s). 50 usec.</span>
<span class="cm"> * IGNORED by the sequencer (i.e. value 0 always).</span>
<span class="cm"> */</span>
<span class="cp">#define ASD_STP_SHUTDOWN_TIMEOUT  0x0</span>

<span class="cm">/* ATA soft reset timer timeout. 5 usec. */</span>
<span class="cp">#define ASD_SRST_ASSERT_TIMEOUT   0x05</span>

<span class="cm">/* 31 sec */</span>
<span class="cp">#define ASD_RCV_FIS_TIMEOUT       0x01D905C0</span>

<span class="cp">#define ASD_ONE_MILLISEC_TIMEOUT  0x03e8</span>

<span class="cm">/* COMINIT timer */</span>
<span class="cp">#define ASD_TEN_MILLISEC_TIMEOUT  0x2710</span>
<span class="cp">#define ASD_COMINIT_TIMEOUT ASD_TEN_MILLISEC_TIMEOUT</span>

<span class="cm">/* 1 sec */</span>
<span class="cp">#define ASD_SMP_RCV_TIMEOUT       0x000F4240</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
