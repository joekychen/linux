<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › pm8001 › pm8001_hwi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pm8001_hwi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PMC-Sierra SPC 8001 SAS/SATA based host adapters driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008-2009 USI Co., Ltd.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions, and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce at minimum a disclaimer</span>
<span class="cm"> *    substantially similar to the &quot;NO WARRANTY&quot; disclaimer below</span>
<span class="cm"> *    (&quot;Disclaimer&quot;) and any redistribution must be conditioned upon</span>
<span class="cm"> *    including a substantially similar Disclaimer requirement for further</span>
<span class="cm"> *    binary redistribution.</span>
<span class="cm"> * 3. Neither the names of the above-listed copyright holders nor the names</span>
<span class="cm"> *    of any contributors may be used to endorse or promote products derived</span>
<span class="cm"> *    from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;) version 2 as published by the Free</span>
<span class="cm"> * Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * NO WARRANTY</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,</span>
<span class="cm"> * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
<span class="cm"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGES.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
 <span class="cp">#include &lt;linux/slab.h&gt;</span>
 <span class="cp">#include &quot;pm8001_sas.h&quot;</span>
 <span class="cp">#include &quot;pm8001_hwi.h&quot;</span>
 <span class="cp">#include &quot;pm8001_chips.h&quot;</span>
 <span class="cp">#include &quot;pm8001_ctl.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * read_main_config_table - read the configure table and save it.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">read_main_config_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl_addr</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">signature</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">interface_rev</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">firmware_rev</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">max_out_io</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">max_sgl</span>		<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">ctrl_cap_flag</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">gst_offset</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">inbound_queue_offset</span> <span class="o">=</span>
		<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MAIN_IBQ_OFFSET</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_queue_offset</span> <span class="o">=</span>
		<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MAIN_OBQ_OFFSET</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">hda_mode_flag</span>	<span class="o">=</span>
		<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MAIN_HDA_FLAGS_OFFSET</span><span class="p">);</span>

	<span class="cm">/* read analog Setting offset from the configuration table */</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">anolog_setup_table_offset</span> <span class="o">=</span>
		<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MAIN_ANALOG_SETUP_OFFSET</span><span class="p">);</span>

	<span class="cm">/* read Error Dump Offset and Length */</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">fatal_err_dump_offset0</span> <span class="o">=</span>
		<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MAIN_FATAL_ERROR_RDUMP0_OFFSET</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">fatal_err_dump_length0</span> <span class="o">=</span>
		<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MAIN_FATAL_ERROR_RDUMP0_LENGTH</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">fatal_err_dump_offset1</span> <span class="o">=</span>
		<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MAIN_FATAL_ERROR_RDUMP1_OFFSET</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">fatal_err_dump_length1</span> <span class="o">=</span>
		<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">MAIN_FATAL_ERROR_RDUMP1_LENGTH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_general_status_table - read the general status table and save it.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">read_general_status_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">general_stat_tbl_addr</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">gst_len_mpistate</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">iq_freeze_state0</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">iq_freeze_state1</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">msgu_tcnt</span>		<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">iop_tcnt</span>		<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">reserved</span>		<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">phy_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">phy_state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">phy_state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">phy_state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">phy_state</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">phy_state</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">phy_state</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">phy_state</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">reserved1</span>		<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">reserved2</span>		<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">reserved3</span>		<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">recover_err_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">recover_err_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">recover_err_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">recover_err_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">recover_err_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">recover_err_info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">recover_err_info</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">gs_tbl</span><span class="p">.</span><span class="n">recover_err_info</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>	<span class="o">=</span> <span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_inbnd_queue_table - read the inbound queue table and save it.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">read_inbnd_queue_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">inbQ_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inbQ_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pi_pci_bar</span> <span class="o">=</span>
		      <span class="n">get_pci_bar_index</span><span class="p">(</span><span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)));</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pi_offset</span> <span class="o">=</span>
			<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_outbnd_queue_table - read the outbound queue table and save it.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">read_outbnd_queue_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">outbQ_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">outbQ_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x24</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ci_pci_bar</span> <span class="o">=</span>
		      <span class="n">get_pci_bar_index</span><span class="p">(</span><span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)));</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ci_offset</span> <span class="o">=</span>
			<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * init_default_table_values - init the default table.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">init_default_table_values</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">qn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offsetib</span><span class="p">,</span> <span class="n">offsetob</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addressib</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addressob</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl_addr</span><span class="p">;</span>

	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">inbound_q_nppd_hppd</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_hw_event_pid0_3</span> 		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_hw_event_pid4_7</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_ncq_event_pid0_3</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_ncq_event_pid4_7</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_ITNexus_event_pid0_3</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_ITNexus_event_pid4_7</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_ssp_event_pid0_3</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_ssp_event_pid4_7</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_smp_event_pid0_3</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_smp_event_pid4_7</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">upper_event_log_addr</span>		<span class="o">=</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">AAP1</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">lower_event_log_addr</span>		<span class="o">=</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">AAP1</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">event_log_size</span>	<span class="o">=</span> <span class="n">PM8001_EVENT_LOG_SIZE</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">event_log_option</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">upper_iop_event_log_addr</span>	<span class="o">=</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">IOP</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">lower_iop_event_log_addr</span>	<span class="o">=</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">IOP</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">iop_event_log_size</span>	<span class="o">=</span> <span class="n">PM8001_EVENT_LOG_SIZE</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">iop_event_log_option</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">fatal_err_interrupt</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qn</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">element_pri_size_cnt</span>	<span class="o">=</span>
			<span class="n">PM8001_MPI_QUEUE</span> <span class="o">|</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x00</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">upper_base_addr</span>	<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">IB</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower_base_addr</span>	<span class="o">=</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">IB</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base_virt</span>		<span class="o">=</span>
			<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">IB</span><span class="p">].</span><span class="n">virt_ptr</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">total_length</span>		<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">IB</span><span class="p">].</span><span class="n">total_len</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ci_upper_base_addr</span>	<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">CI</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ci_lower_base_addr</span>	<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">CI</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ci_virt</span>		<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">CI</span><span class="p">].</span><span class="n">virt_ptr</span><span class="p">;</span>
		<span class="n">offsetib</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pi_pci_bar</span>		<span class="o">=</span>
			<span class="n">get_pci_bar_index</span><span class="p">(</span><span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">addressib</span><span class="p">,</span>
				<span class="p">(</span><span class="n">offsetib</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)));</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pi_offset</span>		<span class="o">=</span>
			<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">addressib</span><span class="p">,</span> <span class="p">(</span><span class="n">offsetib</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">));</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">producer_idx</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer_index</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qn</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">element_size_cnt</span>	<span class="o">=</span>
			<span class="n">PM8001_MPI_QUEUE</span> <span class="o">|</span> <span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x01</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">upper_base_addr</span>	<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">OB</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lower_base_addr</span>	<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">OB</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base_virt</span>		<span class="o">=</span>
			<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">OB</span><span class="p">].</span><span class="n">virt_ptr</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">total_length</span>		<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">OB</span><span class="p">].</span><span class="n">total_len</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pi_upper_base_addr</span>	<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">PI</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pi_lower_base_addr</span>	<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">PI</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interrup_vec_cnt_delay</span>	<span class="o">=</span>
			<span class="mi">0</span> <span class="o">|</span> <span class="p">(</span><span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pi_virt</span>		<span class="o">=</span>
			<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">PI</span><span class="p">].</span><span class="n">virt_ptr</span><span class="p">;</span>
		<span class="n">offsetob</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x24</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ci_pci_bar</span>		<span class="o">=</span>
			<span class="n">get_pci_bar_index</span><span class="p">(</span><span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">addressob</span><span class="p">,</span>
			<span class="n">offsetob</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">));</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ci_offset</span>		<span class="o">=</span>
			<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">addressob</span><span class="p">,</span> <span class="p">(</span><span class="n">offsetob</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">));</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer_idx</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">producer_index</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * update_main_config_table - update the main default table to the HBA.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">update_main_config_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl_addr</span><span class="p">;</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">inbound_q_nppd_hppd</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_hw_event_pid0_3</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_hw_event_pid4_7</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_ncq_event_pid0_3</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_ncq_event_pid4_7</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_ITNexus_event_pid0_3</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_ITNexus_event_pid4_7</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_ssp_event_pid0_3</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_ssp_event_pid4_7</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_smp_event_pid0_3</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">outbound_tgt_smp_event_pid4_7</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">upper_event_log_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">lower_event_log_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">event_log_size</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">event_log_option</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">upper_iop_event_log_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">lower_iop_event_log_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">iop_event_log_size</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">iop_event_log_option</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl</span><span class="p">.</span><span class="n">fatal_err_interrupt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * update_inbnd_queue_table - update the inbound queue table to the HBA.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">update_inbnd_queue_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">element_pri_size_cnt</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">upper_base_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">lower_base_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x0C</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">ci_upper_base_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">ci_lower_base_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * update_outbnd_queue_table - update the outbound queue table to the HBA.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">update_outbnd_queue_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="mh">0x24</span><span class="p">;</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">element_size_cnt</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">upper_base_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">lower_base_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x0C</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">pi_upper_base_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">pi_lower_base_addr</span><span class="p">);</span>
	<span class="n">pm8001_mw32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x1C</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="n">number</span><span class="p">].</span><span class="n">interrup_vec_cnt_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_bar4_shift - function is called to shift BAR base address</span>
<span class="cm"> * @pm8001_ha : our hba card infomation</span>
<span class="cm"> * @shiftValue : shifting value in memory bar.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm8001_bar4_shift</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shiftValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regVal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>

	<span class="cm">/* program the inbound AXI translation Lower Address */</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SPC_IBW_AXI_TRANSLATION_LOW</span><span class="p">,</span> <span class="n">shiftValue</span><span class="p">);</span>

	<span class="cm">/* confirm the setting is written */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span> <span class="cm">/* 1 sec */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SPC_IBW_AXI_TRANSLATION_LOW</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">regVal</span> <span class="o">!=</span> <span class="n">shiftValue</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regVal</span> <span class="o">!=</span> <span class="n">shiftValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;TIMEOUT:SPC_IBW_AXI_TRANSLATION_LOW&quot;</span>
			<span class="s">&quot; = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpi_set_phys_g3_with_ssc</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @SSCbit: set SSCbit to 0 to disable all phys ssc; 1 to enable all phys ssc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">mpi_set_phys_g3_with_ssc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">SSCbit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#define SAS2_SETTINGS_LOCAL_PHY_0_3_SHIFT_ADDR 0x00030000</span>
<span class="cp">#define SAS2_SETTINGS_LOCAL_PHY_4_7_SHIFT_ADDR 0x00040000</span>
<span class="cp">#define SAS2_SETTINGS_LOCAL_PHY_0_3_OFFSET 0x1074</span>
<span class="cp">#define SAS2_SETTINGS_LOCAL_PHY_4_7_OFFSET 0x1074</span>
<span class="cp">#define PHY_G3_WITHOUT_SSC_BIT_SHIFT 12</span>
<span class="cp">#define PHY_G3_WITH_SSC_BIT_SHIFT 13</span>
<span class="cp">#define SNW3_PHY_CAPABILITIES_PARITY 31</span>

   <span class="cm">/*</span>
<span class="cm">    * Using shifted destination address 0x3_0000:0x1074 + 0x4000*N (N=0:3)</span>
<span class="cm">    * Using shifted destination address 0x4_0000:0x1074 + 0x4000*(N-4) (N=4:7)</span>
<span class="cm">    */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">SAS2_SETTINGS_LOCAL_PHY_0_3_SHIFT_ADDR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">SAS2_SETTINGS_LOCAL_PHY_0_3_OFFSET</span> <span class="o">+</span> <span class="mh">0x4000</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mh">0x80001501</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* shift membase 3 for SAS2_SETTINGS_LOCAL_PHY 4 - 7 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">SAS2_SETTINGS_LOCAL_PHY_4_7_SHIFT_ADDR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">SAS2_SETTINGS_LOCAL_PHY_4_7_OFFSET</span> <span class="o">+</span> <span class="mh">0x4000</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mh">0x80001501</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*************************************************************</span>
<span class="cm">	Change the SSC upspreading value to 0x0 so that upspreading is disabled.</span>
<span class="cm">	Device MABC SMOD0 Controls</span>
<span class="cm">	Address: (via MEMBASE-III):</span>
<span class="cm">	Using shifted destination address 0x0_0000: with Offset 0xD8</span>

<span class="cm">	31:28 R/W Reserved Do not change</span>
<span class="cm">	27:24 R/W SAS_SMOD_SPRDUP 0000</span>
<span class="cm">	23:20 R/W SAS_SMOD_SPRDDN 0000</span>
<span class="cm">	19:0  R/W  Reserved Do not change</span>
<span class="cm">	Upon power-up this register will read as 0x8990c016,</span>
<span class="cm">	and I would like you to change the SAS_SMOD_SPRDUP bits to 0b0000</span>
<span class="cm">	so that the written value will be 0x8090c016.</span>
<span class="cm">	This will ensure only down-spreading SSC is enabled on the SPC.</span>
<span class="cm">	*************************************************************/</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x8000C016</span><span class="p">);</span>

	<span class="cm">/*set the shifted destination address to 0x0 to avoid error operation */</span>
	<span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpi_set_open_retry_interval_reg</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @interval - interval time for each OPEN_REJECT (RETRY). The units are in 1us.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">mpi_set_open_retry_interval_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#define OPEN_RETRY_INTERVAL_PHY_0_3_SHIFT_ADDR 0x00030000</span>
<span class="cp">#define OPEN_RETRY_INTERVAL_PHY_4_7_SHIFT_ADDR 0x00040000</span>
<span class="cp">#define OPEN_RETRY_INTERVAL_PHY_0_3_OFFSET 0x30B4</span>
<span class="cp">#define OPEN_RETRY_INTERVAL_PHY_4_7_OFFSET 0x30B4</span>
<span class="cp">#define OPEN_RETRY_INTERVAL_REG_MASK 0x0000FFFF</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">&amp;</span> <span class="n">OPEN_RETRY_INTERVAL_REG_MASK</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* shift bar and set the OPEN_REJECT(RETRY) interval time of PHY 0 -3.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			     <span class="n">OPEN_RETRY_INTERVAL_PHY_0_3_SHIFT_ADDR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">OPEN_RETRY_INTERVAL_PHY_0_3_OFFSET</span> <span class="o">+</span> <span class="mh">0x4000</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			     <span class="n">OPEN_RETRY_INTERVAL_PHY_4_7_SHIFT_ADDR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">OPEN_RETRY_INTERVAL_PHY_4_7_OFFSET</span> <span class="o">+</span> <span class="mh">0x4000</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*set the shifted destination address to 0x0 to avoid error operation */</span>
	<span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpi_init_check - check firmware initialization status.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_init_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_wait_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gst_len_mpistate</span><span class="p">;</span>
	<span class="cm">/* Write bit0=1 to Inbound DoorBell Register to tell the SPC FW the</span>
<span class="cm">	table is updated */</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_IBDB_SET</span><span class="p">,</span> <span class="n">SPC_MSGU_CFG_TABLE_UPDATE</span><span class="p">);</span>
	<span class="cm">/* wait until Inbound DoorBell Clear Register toggled */</span>
	<span class="n">max_wait_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span><span class="cm">/* 1 sec */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_IBDB_SET</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="n">SPC_MSGU_CFG_TABLE_UPDATE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">--</span><span class="n">max_wait_count</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_wait_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* check the MPI-State for initialization */</span>
	<span class="n">gst_len_mpistate</span> <span class="o">=</span>
		<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">general_stat_tbl_addr</span><span class="p">,</span>
		<span class="n">GST_GSTLEN_MPIS_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GST_MPI_STATE_INIT</span> <span class="o">!=</span> <span class="p">(</span><span class="n">gst_len_mpistate</span> <span class="o">&amp;</span> <span class="n">GST_MPI_STATE_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* check MPI Initialization error */</span>
	<span class="n">gst_len_mpistate</span> <span class="o">=</span> <span class="n">gst_len_mpistate</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x0000</span> <span class="o">!=</span> <span class="n">gst_len_mpistate</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * check_fw_ready - The LLDD check if the FW is ready, if not, return error.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_fw_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">value1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_wait_count</span><span class="p">;</span>
	<span class="cm">/* check error state */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_1</span><span class="p">);</span>
	<span class="n">value1</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_2</span><span class="p">);</span>
	<span class="cm">/* check AAP error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SCRATCH_PAD1_ERR</span> <span class="o">==</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">SCRATCH_PAD_STATE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* error state */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check IOP error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SCRATCH_PAD2_ERR</span> <span class="o">==</span> <span class="p">(</span><span class="n">value1</span> <span class="o">&amp;</span> <span class="n">SCRATCH_PAD_STATE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* error state */</span>
		<span class="n">value1</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_3</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* bit 4-31 of scratch pad1 should be zeros if it is not</span>
<span class="cm">	in error state*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">SCRATCH_PAD1_STATE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* error case */</span>
		<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* bit 2, 4-31 of scratch pad2 should be zeros if it is not</span>
<span class="cm">	in error state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value1</span> <span class="o">&amp;</span> <span class="n">SCRATCH_PAD2_STATE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* error case */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max_wait_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span><span class="cm">/* 1 sec timeout */</span>

	<span class="cm">/* wait until scratch pad 1 and 2 registers in ready state  */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_1</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">SCRATCH_PAD1_RDY</span><span class="p">;</span>
		<span class="n">value1</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_2</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">SCRATCH_PAD2_RDY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="n">max_wait_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">value</span> <span class="o">!=</span> <span class="n">SCRATCH_PAD1_RDY</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">value1</span> <span class="o">!=</span> <span class="n">SCRATCH_PAD2_RDY</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_pci_device_addresses</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pcibar</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pcilogic</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x03FFFFFF</span><span class="p">;</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Scratchpad 0 Offset: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">));</span>
	<span class="n">pcilogic</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFC000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">;</span>
	<span class="n">pcibar</span> <span class="o">=</span> <span class="n">get_pci_bar_index</span><span class="p">(</span><span class="n">pcilogic</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Scratchpad 0 PCI BAR: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcibar</span><span class="p">));</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">main_cfg_tbl_addr</span> <span class="o">=</span> <span class="n">base_addr</span> <span class="o">=</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">io_mem</span><span class="p">[</span><span class="n">pcibar</span><span class="p">].</span><span class="n">memvirtaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">general_stat_tbl_addr</span> <span class="o">=</span>
		<span class="n">base_addr</span> <span class="o">+</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pcibar</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl_addr</span> <span class="o">=</span>
		<span class="n">base_addr</span> <span class="o">+</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pcibar</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x1C</span><span class="p">);</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl_addr</span> <span class="o">=</span>
		<span class="n">base_addr</span> <span class="o">+</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pcibar</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_init - the main init function that initialize whole PM8001 chip.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pm8001_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check the firmware status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">check_fw_ready</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Firmware is not ready!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize pci space address eg: mpi offset */</span>
	<span class="n">init_pci_device_addresses</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="n">init_default_table_values</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="n">read_main_config_table</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="n">read_general_status_table</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="n">read_inbnd_queue_table</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="n">read_outbnd_queue_table</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="cm">/* update main config table ,inbound table and outbound table */</span>
	<span class="n">update_main_config_table</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="n">update_inbnd_queue_table</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">update_outbnd_queue_table</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mpi_set_phys_g3_with_ssc</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* 7-&gt;130ms, 34-&gt;500ms, 119-&gt;1.5s */</span>
	<span class="n">mpi_set_open_retry_interval_reg</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">119</span><span class="p">);</span>
	<span class="cm">/* notify firmware update finished and check initialization status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">mpi_init_check</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;MPI initialize successful!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="cm">/*This register is a 16-bit timer with a resolution of 1us. This is the</span>
<span class="cm">	timer used for interrupt delay/coalescing in the PCIe Application Layer.</span>
<span class="cm">	Zero is not a valid value. A value of 1 in the register will cause the</span>
<span class="cm">	interrupts to be normal. A value greater than 1 will cause coalescing</span>
<span class="cm">	delays.*/</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x0033c0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x0033c4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_uninit_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_wait_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gst_len_mpistate</span><span class="p">;</span>
	<span class="n">init_pci_device_addresses</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="cm">/* Write bit1=1 to Inbound DoorBell Register to tell the SPC FW the</span>
<span class="cm">	table is stop */</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_IBDB_SET</span><span class="p">,</span> <span class="n">SPC_MSGU_CFG_TABLE_RESET</span><span class="p">);</span>

	<span class="cm">/* wait until Inbound DoorBell Clear Register toggled */</span>
	<span class="n">max_wait_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span><span class="cm">/* 1 sec */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_IBDB_SET</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="n">SPC_MSGU_CFG_TABLE_RESET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">--</span><span class="n">max_wait_count</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_wait_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;TIMEOUT:IBDB value/=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check the MPI-State for termination in progress */</span>
	<span class="cm">/* wait until Inbound DoorBell Clear Register toggled */</span>
	<span class="n">max_wait_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>  <span class="cm">/* 1 sec */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">gst_len_mpistate</span> <span class="o">=</span>
			<span class="n">pm8001_mr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">general_stat_tbl_addr</span><span class="p">,</span>
			<span class="n">GST_GSTLEN_MPIS_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GST_MPI_STATE_UNINIT</span> <span class="o">==</span>
			<span class="p">(</span><span class="n">gst_len_mpistate</span> <span class="o">&amp;</span> <span class="n">GST_MPI_STATE_MASK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">max_wait_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_wait_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; TIME OUT MPI State = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">gst_len_mpistate</span> <span class="o">&amp;</span> <span class="n">GST_MPI_STATE_MASK</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * soft_reset_ready_check - Function to check FW is ready for soft reset.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">soft_reset_ready_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regVal</span><span class="p">,</span> <span class="n">regVal1</span><span class="p">,</span> <span class="n">regVal2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_uninit_check</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;MPI state is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* read the scratch pad 2 register bit 2 */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_2</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">SCRATCH_PAD2_FWRDY_RST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regVal</span> <span class="o">==</span> <span class="n">SCRATCH_PAD2_FWRDY_RST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Firmware is ready for reset .</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="cm">/* Trigger NMI twice via RB6 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">RB6_ACCESS_REG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Shift Bar4 to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">RB6_ACCESS_REG</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_RB6_OFFSET</span><span class="p">,</span>
			<span class="n">RB6_MAGIC_NUMBER_RST</span><span class="p">);</span>
		<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_RB6_OFFSET</span><span class="p">,</span> <span class="n">RB6_MAGIC_NUMBER_RST</span><span class="p">);</span>
		<span class="cm">/* wait for 100 ms */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_2</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">SCRATCH_PAD2_FWRDY_RST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regVal</span> <span class="o">!=</span> <span class="n">SCRATCH_PAD2_FWRDY_RST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regVal1</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_1</span><span class="p">);</span>
			<span class="n">regVal2</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_2</span><span class="p">);</span>
			<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;TIMEOUT:MSGU_SCRATCH_PAD1&quot;</span>
				<span class="s">&quot;=0x%x, MSGU_SCRATCH_PAD2=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">regVal1</span><span class="p">,</span> <span class="n">regVal2</span><span class="p">));</span>
			<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SCRATCH_PAD0 value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_0</span><span class="p">)));</span>
			<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SCRATCH_PAD3 value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_3</span><span class="p">)));</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_soft_rst - soft reset the PM8001 chip, so that the clear all</span>
<span class="cm"> * the FW register status to the originated status.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @signature: signature in host scratch pad0 register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pm8001_chip_soft_rst</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">signature</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">regVal</span><span class="p">,</span> <span class="n">toggleVal</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">max_wait_count</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">regVal1</span><span class="p">,</span> <span class="n">regVal2</span><span class="p">,</span> <span class="n">regVal3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* step1: Check FW is ready for soft reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">soft_reset_ready_check</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;FW is not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* step 2: clear NMI status register on AAP1 and IOP, write the same</span>
<span class="cm">	value to clear */</span>
	<span class="cm">/* map 0x60000 to BAR4(0x20), BAR2(win) */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">MBIC_AAP1_ADDR_BASE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Shift Bar4 to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">MBIC_AAP1_ADDR_BASE</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MBIC_NMI_ENABLE_VPE0_IOP</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;MBIC - NMI Enable VPE0 (IOP)= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MBIC_NMI_ENABLE_VPE0_IOP</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="cm">/* map 0x70000 to BAR4(0x20), BAR2(win) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">MBIC_IOP_ADDR_BASE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Shift Bar4 to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">MBIC_IOP_ADDR_BASE</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MBIC_NMI_ENABLE_VPE0_AAP1</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;MBIC - NMI Enable VPE0 (AAP1)= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MBIC_NMI_ENABLE_VPE0_AAP1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCIE_EVENT_INTERRUPT_ENABLE</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;PCIE -Event Interrupt Enable = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCIE_EVENT_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCIE_EVENT_INTERRUPT</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;PCIE - Event Interrupt  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCIE_EVENT_INTERRUPT</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>

	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCIE_ERROR_INTERRUPT_ENABLE</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;PCIE -Error Interrupt Enable = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCIE_ERROR_INTERRUPT_ENABLE</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCIE_ERROR_INTERRUPT</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;PCIE - Error Interrupt = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCIE_ERROR_INTERRUPT</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>

	<span class="cm">/* read the scratch pad 1 register bit 2 */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_1</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">SCRATCH_PAD1_RST</span><span class="p">;</span>
	<span class="n">toggleVal</span> <span class="o">=</span> <span class="n">regVal</span> <span class="o">^</span> <span class="n">SCRATCH_PAD1_RST</span><span class="p">;</span>

	<span class="cm">/* set signature in host scratch pad0 register to tell SPC that the</span>
<span class="cm">	host performs the soft reset */</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_HOST_SCRATCH_PAD_0</span><span class="p">,</span> <span class="n">signature</span><span class="p">);</span>

	<span class="cm">/* read required registers for confirmming */</span>
	<span class="cm">/* map 0x0700000 to BAR4(0x20), BAR2(win) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">GSM_ADDR_BASE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Shift Bar4 to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">GSM_ADDR_BASE</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x0(0x00007b88)-GSM Configuration and&quot;</span>
		<span class="s">&quot; Reset = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_CONFIG_RESET</span><span class="p">)));</span>

	<span class="cm">/* step 3: host read GSM Configuration and Reset register */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_CONFIG_RESET</span><span class="p">);</span>
	<span class="cm">/* Put those bits to low */</span>
	<span class="cm">/* GSM XCBI offset = 0x70 0000</span>
<span class="cm">	0x00 Bit 13 COM_SLV_SW_RSTB 1</span>
<span class="cm">	0x00 Bit 12 QSSP_SW_RSTB 1</span>
<span class="cm">	0x00 Bit 11 RAAE_SW_RSTB 1</span>
<span class="cm">	0x00 Bit 9 RB_1_SW_RSTB 1</span>
<span class="cm">	0x00 Bit 8 SM_SW_RSTB 1</span>
<span class="cm">	*/</span>
	<span class="n">regVal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x00003b00</span><span class="p">);</span>
	<span class="cm">/* host write GSM Configuration and Reset register */</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_CONFIG_RESET</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x0 (0x00007b88 ==&gt; 0x00004088) - GSM &quot;</span>
		<span class="s">&quot;Configuration and Reset is set to = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_CONFIG_RESET</span><span class="p">)));</span>

	<span class="cm">/* step 4: */</span>
	<span class="cm">/* disable GSM - Read Address Parity Check */</span>
	<span class="n">regVal1</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_READ_ADDR_PARITY_CHECK</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x700038 - Read Address Parity Check &quot;</span>
		<span class="s">&quot;Enable = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal1</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_READ_ADDR_PARITY_CHECK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x700038 - Read Address Parity Check Enable&quot;</span>
		<span class="s">&quot;is set to = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_READ_ADDR_PARITY_CHECK</span><span class="p">)));</span>

	<span class="cm">/* disable GSM - Write Address Parity Check */</span>
	<span class="n">regVal2</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_ADDR_PARITY_CHECK</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x700040 - Write Address Parity Check&quot;</span>
		<span class="s">&quot; Enable = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal2</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_ADDR_PARITY_CHECK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x700040 - Write Address Parity Check &quot;</span>
		<span class="s">&quot;Enable is set to = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_ADDR_PARITY_CHECK</span><span class="p">)));</span>

	<span class="cm">/* disable GSM - Write Data Parity Check */</span>
	<span class="n">regVal3</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_DATA_PARITY_CHECK</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x300048 - Write Data Parity Check&quot;</span>
		<span class="s">&quot; Enable = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal3</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_DATA_PARITY_CHECK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x300048 - Write Data Parity Check Enable&quot;</span>
		<span class="s">&quot;is set to = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_DATA_PARITY_CHECK</span><span class="p">)));</span>

	<span class="cm">/* step 5: delay 10 usec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="cm">/* step 5-b: set GPIO-0 output control to tristate anyway */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">GPIO_ADDR_BASE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Shift Bar4 to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">GPIO_ADDR_BASE</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GPIO_GPIO_0_0UTPUT_CTL_OFFSET</span><span class="p">);</span>
		<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GPIO Output Control Register:&quot;</span>
				<span class="s">&quot; = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="cm">/* set GPIO-0 output control to tri-state */</span>
	<span class="n">regVal</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GPIO_GPIO_0_0UTPUT_CTL_OFFSET</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>

	<span class="cm">/* Step 6: Reset the IOP and AAP1 */</span>
	<span class="cm">/* map 0x00000 to BAR4(0x20), BAR2(win) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">SPC_TOP_LEVEL_ADDR_BASE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SPC Shift Bar4 to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">SPC_TOP_LEVEL_ADDR_BASE</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Top Register before resetting IOP/AAP1&quot;</span>
		<span class="s">&quot;:= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">regVal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SPC_REG_RESET_PCS_IOP_SS</span> <span class="o">|</span> <span class="n">SPC_REG_RESET_PCS_AAP1_SS</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>

	<span class="cm">/* step 7: Reset the BDMA/OSSP */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Top Register before resetting BDMA/OSSP&quot;</span>
		<span class="s">&quot;: = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">regVal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SPC_REG_RESET_BDMA_CORE</span> <span class="o">|</span> <span class="n">SPC_REG_RESET_OSSP</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>

	<span class="cm">/* step 8: delay 10 usec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* step 9: bring the BDMA and OSSP out of reset */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Top Register before bringing up BDMA/OSSP&quot;</span>
		<span class="s">&quot;:= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">regVal</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SPC_REG_RESET_BDMA_CORE</span> <span class="o">|</span> <span class="n">SPC_REG_RESET_OSSP</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>

	<span class="cm">/* step 10: delay 10 usec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* step 11: reads and sets the GSM Configuration and Reset Register */</span>
	<span class="cm">/* map 0x0700000 to BAR4(0x20), BAR2(win) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">GSM_ADDR_BASE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SPC Shift Bar4 to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">GSM_ADDR_BASE</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x0 (0x00007b88)-GSM Configuration and &quot;</span>
		<span class="s">&quot;Reset = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_CONFIG_RESET</span><span class="p">)));</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_CONFIG_RESET</span><span class="p">);</span>
	<span class="cm">/* Put those bits to high */</span>
	<span class="cm">/* GSM XCBI offset = 0x70 0000</span>
<span class="cm">	0x00 Bit 13 COM_SLV_SW_RSTB 1</span>
<span class="cm">	0x00 Bit 12 QSSP_SW_RSTB 1</span>
<span class="cm">	0x00 Bit 11 RAAE_SW_RSTB 1</span>
<span class="cm">	0x00 Bit 9   RB_1_SW_RSTB 1</span>
<span class="cm">	0x00 Bit 8   SM_SW_RSTB 1</span>
<span class="cm">	*/</span>
	<span class="n">regVal</span> <span class="o">|=</span> <span class="p">(</span><span class="n">GSM_CONFIG_RESET_VALUE</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_CONFIG_RESET</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM (0x00004088 ==&gt; 0x00007b88) - GSM&quot;</span>
		<span class="s">&quot; Configuration and Reset is set to = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_CONFIG_RESET</span><span class="p">)));</span>

	<span class="cm">/* step 12: Restore GSM - Read Address Parity Check */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_READ_ADDR_PARITY_CHECK</span><span class="p">);</span>
	<span class="cm">/* just for debugging */</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x700038 - Read Address Parity Check Enable&quot;</span>
		<span class="s">&quot; = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_READ_ADDR_PARITY_CHECK</span><span class="p">,</span> <span class="n">regVal1</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x700038 - Read Address Parity&quot;</span>
		<span class="s">&quot; Check Enable is set to = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_READ_ADDR_PARITY_CHECK</span><span class="p">)));</span>
	<span class="cm">/* Restore GSM - Write Address Parity Check */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_ADDR_PARITY_CHECK</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_ADDR_PARITY_CHECK</span><span class="p">,</span> <span class="n">regVal2</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x700040 - Write Address Parity Check&quot;</span>
		<span class="s">&quot; Enable is set to = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_ADDR_PARITY_CHECK</span><span class="p">)));</span>
	<span class="cm">/* Restore GSM - Write Data Parity Check */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_DATA_PARITY_CHECK</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_DATA_PARITY_CHECK</span><span class="p">,</span> <span class="n">regVal3</span><span class="p">);</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;GSM 0x700048 - Write Data Parity Check Enable&quot;</span>
		<span class="s">&quot;is set to = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GSM_WRITE_DATA_PARITY_CHECK</span><span class="p">)));</span>

	<span class="cm">/* step 13: bring the IOP and AAP1 out of reset */</span>
	<span class="cm">/* map 0x00000 to BAR4(0x20), BAR2(win) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">SPC_TOP_LEVEL_ADDR_BASE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Shift Bar4 to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">SPC_TOP_LEVEL_ADDR_BASE</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">);</span>
	<span class="n">regVal</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SPC_REG_RESET_PCS_IOP_SS</span> <span class="o">|</span> <span class="n">SPC_REG_RESET_PCS_AAP1_SS</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>

	<span class="cm">/* step 14: delay 10 usec - Normal Mode */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="cm">/* check Soft Reset Normal mode or Soft Reset HDA mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">signature</span> <span class="o">==</span> <span class="n">SPC_SOFT_RESET_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* step 15 (Normal Mode): wait until scratch pad1 register</span>
<span class="cm">		bit 2 toggled */</span>
		<span class="n">max_wait_count</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span><span class="cm">/* 2 sec */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_1</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">SCRATCH_PAD1_RST</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">regVal</span> <span class="o">!=</span> <span class="n">toggleVal</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">--</span><span class="n">max_wait_count</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_wait_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">MSGU_SCRATCH_PAD_1</span><span class="p">);</span>
			<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;TIMEOUT : ToggleVal 0x%x,&quot;</span>
				<span class="s">&quot;MSGU_SCRATCH_PAD1 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">toggleVal</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
			<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SCRATCH_PAD0 value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">MSGU_SCRATCH_PAD_0</span><span class="p">)));</span>
			<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SCRATCH_PAD2 value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">MSGU_SCRATCH_PAD_2</span><span class="p">)));</span>
			<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SCRATCH_PAD3 value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">MSGU_SCRATCH_PAD_3</span><span class="p">)));</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* step 16 (Normal) - Clear ODMR and ODCR */</span>
		<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_ODCR</span><span class="p">,</span> <span class="n">ODCR_CLEAR_ALL</span><span class="p">);</span>
		<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_ODMR</span><span class="p">,</span> <span class="n">ODMR_CLEAR_ALL</span><span class="p">);</span>

		<span class="cm">/* step 17 (Normal Mode): wait for the FW and IOP to get</span>
<span class="cm">		ready - 1 sec timeout */</span>
		<span class="cm">/* Wait for the SPC Configuration Table to be ready */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_fw_ready</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_1</span><span class="p">);</span>
			<span class="cm">/* return error if MPI Configuration Table not ready */</span>
			<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;FW not ready SCRATCH_PAD1&quot;</span>
				<span class="s">&quot; = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
			<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_SCRATCH_PAD_2</span><span class="p">);</span>
			<span class="cm">/* return error if MPI Configuration Table not ready */</span>
			<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;FW not ready SCRATCH_PAD2&quot;</span>
				<span class="s">&quot; = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regVal</span><span class="p">));</span>
			<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SCRATCH_PAD0 value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">MSGU_SCRATCH_PAD_0</span><span class="p">)));</span>
			<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SCRATCH_PAD3 value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">MSGU_SCRATCH_PAD_3</span><span class="p">)));</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pm8001_bar4_shift</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SPC soft reset Complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm8001_hw_chip_rst</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regVal</span><span class="p">;</span>
	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;chip reset start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="cm">/* do SPC chip reset. */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">);</span>
	<span class="n">regVal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SPC_REG_RESET_DEVICE</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>

	<span class="cm">/* delay 10 usec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* bring chip reset out of reset */</span>
	<span class="n">regVal</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">);</span>
	<span class="n">regVal</span> <span class="o">|=</span> <span class="n">SPC_REG_RESET_DEVICE</span><span class="p">;</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SPC_REG_RESET</span><span class="p">,</span> <span class="n">regVal</span><span class="p">);</span>

	<span class="cm">/* delay 10 usec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* wait for 20 msec until the firmware gets reloaded */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">PM8001_INIT_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;chip reset finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_iounmap - which maped when initialized.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm8001_chip_iounmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">bar</span><span class="p">,</span> <span class="n">logical</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bar</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">bar</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		** logical BARs for SPC:</span>
<span class="cm">		** bar 0 and 1 - logical BAR0</span>
<span class="cm">		** bar 2 and 3 - logical BAR1</span>
<span class="cm">		** bar4 - logical BAR2</span>
<span class="cm">		** bar5 - logical BAR3</span>
<span class="cm">		** Skip the appropriate assignments:</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bar</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bar</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">io_mem</span><span class="p">[</span><span class="n">logical</span><span class="p">].</span><span class="n">memvirtaddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">io_mem</span><span class="p">[</span><span class="n">logical</span><span class="p">].</span><span class="n">memvirtaddr</span><span class="p">);</span>
			<span class="n">logical</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_interrupt_enable - enable PM8001 chip interrupt</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pm8001_chip_intx_interrupt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_ODMR</span><span class="p">,</span> <span class="n">ODMR_CLEAR_ALL</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_ODCR</span><span class="p">,</span> <span class="n">ODCR_CLEAR_ALL</span><span class="p">);</span>
<span class="p">}</span>

 <span class="cm">/**</span>
<span class="cm">  * pm8001_chip_intx_interrupt_disable- disable PM8001 chip interrupt</span>
<span class="cm">  * @pm8001_ha: our hba card information</span>
<span class="cm">  */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pm8001_chip_intx_interrupt_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_ODMR</span><span class="p">,</span> <span class="n">ODMR_MASK_ALL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_msix_interrupt_enable - enable PM8001 chip interrupt</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pm8001_chip_msix_interrupt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">int_vec_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msi_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">msi_index</span> <span class="o">=</span> <span class="n">int_vec_idx</span> <span class="o">*</span> <span class="n">MSIX_TABLE_ELEMENT_SIZE</span><span class="p">;</span>
	<span class="n">msi_index</span> <span class="o">+=</span> <span class="n">MSIX_TABLE_BASE</span><span class="p">;</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msi_index</span><span class="p">,</span> <span class="n">MSIX_INTERRUPT_ENABLE</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">int_vec_idx</span><span class="p">);</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">MSGU_ODCR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_msix_interrupt_disable - disable PM8001 chip interrupt</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pm8001_chip_msix_interrupt_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">int_vec_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msi_index</span><span class="p">;</span>
	<span class="n">msi_index</span> <span class="o">=</span> <span class="n">int_vec_idx</span> <span class="o">*</span> <span class="n">MSIX_TABLE_ELEMENT_SIZE</span><span class="p">;</span>
	<span class="n">msi_index</span> <span class="o">+=</span> <span class="n">MSIX_TABLE_BASE</span><span class="p">;</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">msi_index</span><span class="p">,</span> <span class="n">MSIX_INTERRUPT_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_interrupt_enable - enable PM8001 chip interrupt</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pm8001_chip_interrupt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PM8001_USE_MSIX</span>
	<span class="n">pm8001_chip_msix_interrupt_enable</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">pm8001_chip_intx_interrupt_enable</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_intx_interrupt_disable- disable PM8001 chip interrupt</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pm8001_chip_interrupt_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PM8001_USE_MSIX</span>
	<span class="n">pm8001_chip_msix_interrupt_disable</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">pm8001_chip_intx_interrupt_disable</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpi_msg_free_get- get the free message buffer for transfer inbound queue.</span>
<span class="cm"> * @circularQ: the inbound queue  we want to transfer to HBA.</span>
<span class="cm"> * @messageSize: the message size of this transfer, normally it is 64 bytes</span>
<span class="cm"> * @messagePtr: the pointer to message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_msg_free_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">messageSize</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">messagePtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">consumer_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpi_msg_hdr</span> <span class="o">*</span><span class="n">msgHeader</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bcCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* only support single buffer */</span>

	<span class="cm">/* Checks is the requested message size can be allocated in this queue*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">messageSize</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">messagePtr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Stores the new consumer index */</span>
	<span class="n">consumer_index</span> <span class="o">=</span> <span class="n">pm8001_read_32</span><span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">ci_virt</span><span class="p">);</span>
	<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">consumer_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_idx</span> <span class="o">+</span> <span class="n">bcCount</span><span class="p">)</span> <span class="o">%</span> <span class="n">PM8001_MPI_QUEUE</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_index</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">messagePtr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* get memory IOMB buffer address */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_idx</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
	<span class="cm">/* increment to next bcCount element */</span>
	<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_idx</span> <span class="o">+</span> <span class="n">bcCount</span><span class="p">)</span>
				<span class="o">%</span> <span class="n">PM8001_MPI_QUEUE</span><span class="p">;</span>
	<span class="cm">/* Adds that distance to the base of the region virtual address plus</span>
<span class="cm">	the message header size*/</span>
	<span class="n">msgHeader</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpi_msg_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">base_virt</span>	<span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="o">*</span><span class="n">messagePtr</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">msgHeader</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpi_msg_hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpi_build_cmd- build the message queue for transfer, update the PI to FW</span>
<span class="cm"> * to tell the fw to get this message from IOMB.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @circularQ: the inbound queue we want to transfer to HBA.</span>
<span class="cm"> * @opCode: the operation code represents commands which LLDD and fw recognized.</span>
<span class="cm"> * @payload: the command payload of each operation command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_build_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">opCode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">Header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hpriority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">responseQueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pMessage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_msg_free_get</span><span class="p">(</span><span class="n">circularQ</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pMessage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;No free mpi buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">payload</span><span class="p">);</span>
	<span class="cm">/*Copy to the payload*/</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pMessage</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpi_msg_hdr</span><span class="p">)));</span>

	<span class="cm">/*Build the header*/</span>
	<span class="n">Header</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hpriority</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">bc</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">responseQueue</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">category</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">opCode</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">));</span>

	<span class="n">pm8001_write_32</span><span class="p">((</span><span class="n">pMessage</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">Header</span><span class="p">));</span>
	<span class="cm">/*Update the PI to the firmware*/</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">pi_pci_bar</span><span class="p">,</span>
		<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">pi_offset</span><span class="p">,</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_idx</span><span class="p">);</span>
	<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;after PI= %d CI= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_idx</span><span class="p">,</span>
		<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_index</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">mpi_msg_free_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pMsg</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">outbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">producer_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpi_msg_hdr</span> <span class="o">*</span><span class="n">msgHeader</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpi_msg_hdr</span> <span class="o">*</span><span class="n">pOutBoundMsgHeader</span><span class="p">;</span>

	<span class="n">msgHeader</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpi_msg_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">pMsg</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpi_msg_hdr</span><span class="p">));</span>
	<span class="n">pOutBoundMsgHeader</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpi_msg_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">base_virt</span> <span class="o">+</span>
				<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span> <span class="o">*</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pOutBoundMsgHeader</span> <span class="o">!=</span> <span class="n">msgHeader</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;consumer_idx = %d msgHeader = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">,</span> <span class="n">msgHeader</span><span class="p">));</span>

		<span class="cm">/* Update the producer index from SPC */</span>
		<span class="n">producer_index</span> <span class="o">=</span> <span class="n">pm8001_read_32</span><span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">pi_virt</span><span class="p">);</span>
		<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">producer_index</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;consumer_idx = %d producer_index = %d&quot;</span>
			<span class="s">&quot;msgHeader = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">,</span>
			<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">,</span> <span class="n">msgHeader</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* free the circular queue buffer elements associated with the message*/</span>
	<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span> <span class="o">+</span> <span class="n">bc</span><span class="p">)</span>
				<span class="o">%</span> <span class="n">PM8001_MPI_QUEUE</span><span class="p">;</span>
	<span class="cm">/* update the CI of outbound queue */</span>
	<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">ci_pci_bar</span><span class="p">,</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">ci_offset</span><span class="p">,</span>
		<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">);</span>
	<span class="cm">/* Update the producer index from SPC*/</span>
	<span class="n">producer_index</span> <span class="o">=</span> <span class="n">pm8001_read_32</span><span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">pi_virt</span><span class="p">);</span>
	<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">producer_index</span><span class="p">);</span>
	<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; CI=%d PI=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">,</span>
		<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpi_msg_consume- get the MPI message from  outbound queue message table.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @circularQ: the outbound queue  table.</span>
<span class="cm"> * @messagePtr1: the message contents of this outbound message.</span>
<span class="cm"> * @pBC: the message size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">mpi_msg_consume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">outbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">**</span><span class="n">messagePtr1</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pBC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpi_msg_hdr</span>	<span class="o">*</span><span class="n">msgHeader</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">msgHeader_tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">header_tmp</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* If there are not-yet-delivered messages ... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">)</span>
			<span class="o">!=</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*Get the pointer to the circular queue buffer element*/</span>
			<span class="n">msgHeader</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpi_msg_hdr</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">base_virt</span> <span class="o">+</span>
				<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span> <span class="o">*</span> <span class="mi">64</span><span class="p">);</span>
			<span class="cm">/* read header */</span>
			<span class="n">header_tmp</span> <span class="o">=</span> <span class="n">pm8001_read_32</span><span class="p">(</span><span class="n">msgHeader</span><span class="p">);</span>
			<span class="n">msgHeader_tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">header_tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msgHeader_tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">OPC_OUB_SKIP_ENTRY</span> <span class="o">!=</span>
					<span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msgHeader_tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">))</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">messagePtr1</span> <span class="o">=</span>
						<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">msgHeader</span><span class="p">)</span> <span class="o">+</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpi_msg_hdr</span><span class="p">);</span>
					<span class="o">*</span><span class="n">pBC</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msgHeader_tmp</span><span class="p">)</span>
						<span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
					<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
						<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: CI=%d PI=%d &quot;</span>
						<span class="s">&quot;msgHeader=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">,</span>
						<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">,</span>
						<span class="n">msgHeader_tmp</span><span class="p">));</span>
					<span class="k">return</span> <span class="n">MPI_IO_STATUS_SUCCESS</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span> <span class="o">+</span>
						<span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msgHeader_tmp</span><span class="p">)</span>
						 <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">))</span>
							<span class="o">%</span> <span class="n">PM8001_MPI_QUEUE</span><span class="p">;</span>
					<span class="n">msgHeader_tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">pm8001_write_32</span><span class="p">(</span><span class="n">msgHeader</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="cm">/* update the CI of outbound queue */</span>
					<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
						<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">ci_pci_bar</span><span class="p">,</span>
						<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">ci_offset</span><span class="p">,</span>
						<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span> <span class="o">+</span>
					<span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msgHeader_tmp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="mh">0x1f</span><span class="p">))</span> <span class="o">%</span> <span class="n">PM8001_MPI_QUEUE</span><span class="p">;</span>
				<span class="n">msgHeader_tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pm8001_write_32</span><span class="p">(</span><span class="n">msgHeader</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="cm">/* update the CI of outbound queue */</span>
				<span class="n">pm8001_cw32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">ci_pci_bar</span><span class="p">,</span>
					<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">ci_offset</span><span class="p">,</span>
					<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">MPI_IO_STATUS_FAIL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">producer_index</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">pi_virt</span> <span class="o">=</span> <span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">pi_virt</span><span class="p">;</span>
			<span class="cm">/* Update the producer index from SPC */</span>
			<span class="n">producer_index</span> <span class="o">=</span> <span class="n">pm8001_read_32</span><span class="p">(</span><span class="n">pi_virt</span><span class="p">);</span>
			<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">producer_index</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">)</span> <span class="o">!=</span>
		<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">);</span>
	<span class="cm">/* while we don&#39;t have any more not-yet-delivered message */</span>
	<span class="cm">/* report empty */</span>
	<span class="k">return</span> <span class="n">MPI_IO_STATUS_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm8001_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm8001_work</span> <span class="o">*</span><span class="n">pw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pm8001_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * So far, all users of this stash an associated structure here.</span>
<span class="cm">	 * If we get here, and this pointer is null, then the action</span>
<span class="cm">	 * was cancelled. This nullification happens when the device</span>
<span class="cm">	 * goes away.</span>
<span class="cm">	 */</span>
	<span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">pw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span> <span class="cm">/* Most stash device structure */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pm8001_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	 <span class="o">||</span> <span class="p">((</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">!=</span> <span class="n">IO_XFER_ERROR_BREAK</span><span class="p">)</span>
	  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">NO_DEVICE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pw</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_BREAK</span>:
	<span class="p">{</span>	<span class="cm">/* This one stashes the sas_task instead */</span>
		<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="p">)</span><span class="n">pm8001_dev</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span> <span class="o">=</span> <span class="n">pw</span><span class="o">-&gt;</span><span class="n">pm8001_ha</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">flags1</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">task_status_struct</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_query_task</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="n">TMF_RESP_FUNC_SUCC</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Task still on lu */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags1</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Task got completed by another */</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags1</span><span class="p">);</span>

		<span class="cm">/* Search for a possible ccb that matches the task */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ccb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PM8001_MAX_CCB</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tag</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">==</span> <span class="n">t</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Task got freed by another */</span>
		<span class="p">}</span>
		<span class="n">ts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="cm">/* Force the midlayer to retry */</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_QUEUE_FULL</span><span class="p">;</span>
		<span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags1</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_STATE_PENDING</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_AT_INITIATOR</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_ABORTED</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags1</span><span class="p">);</span>
			<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;task 0x%p&quot;</span>
				<span class="s">&quot; done with event 0x%x resp 0x%x stat 0x%x but&quot;</span>
				<span class="s">&quot; aborted by upper layer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">t</span><span class="p">,</span> <span class="n">pw</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">));</span>
			<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags1</span><span class="p">);</span>
			<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span><span class="cm">/* in order to force CPU ordering */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_OPEN_RETRY_TIMEOUT</span>:
	<span class="p">{</span>	<span class="cm">/* This one stashes the sas_task instead */</span>
		<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="p">)</span><span class="n">pm8001_dev</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span> <span class="o">=</span> <span class="n">pw</span><span class="o">-&gt;</span><span class="n">pm8001_ha</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">flags1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_OPEN_RETRY_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pm8001_query_task</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TMF_RESP_FUNC_SUCC</span>:
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;...Task on lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">TMF_RESP_FUNC_COMPLETE</span>:
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;...Task NOT on lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;...query task failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">});</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags1</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TMF_RESP_FUNC_SUCC</span><span class="p">)</span> <span class="cm">/* task on lu */</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pm8001_abort_task</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Task got completed by another */</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags1</span><span class="p">);</span>

		<span class="cm">/* Search for a possible ccb that matches the task */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ccb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PM8001_MAX_CCB</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tag</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">==</span> <span class="n">t</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TMF_RESP_FUNC_SUCC</span><span class="p">)</span> <span class="cm">/* task on lu */</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pm8001_abort_task</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Task got freed by another */</span>
		<span class="p">}</span>

		<span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TMF_RESP_FUNC_SUCC</span>: <span class="cm">/* task on lu */</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">open_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Snub completion */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">pm8001_abort_task</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">open_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TMF_RESP_FUNC_SUCC</span>:
			<span class="k">case</span> <span class="n">TMF_RESP_FUNC_COMPLETE</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="cm">/* device misbehavior */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">TMF_RESP_FUNC_FAILED</span><span class="p">;</span>
				<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
					<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;...Reset phy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="n">pm8001_I_T_nexus_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TMF_RESP_FUNC_COMPLETE</span>: <span class="cm">/* task not on lu */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* Do we need to abort the task locally? */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span> <span class="cm">/* device misbehavior */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">TMF_RESP_FUNC_FAILED</span><span class="p">;</span>
			<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;...Reset phy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">pm8001_I_T_nexus_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TMF_RESP_FUNC_FAILED</span><span class="p">)</span>
			<span class="n">t</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pm8001_open_reject_retry</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pm8001_dev</span><span class="p">);</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;...Complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span>:
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="p">;</span>
		<span class="n">pm8001_I_T_nexus_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY</span>:
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="p">;</span>
		<span class="n">pm8001_I_T_nexus_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_DS_IN_ERROR</span>:
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="p">;</span>
		<span class="n">pm8001_I_T_nexus_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_DS_NON_OPERATIONAL</span>:
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="p">;</span>
		<span class="n">pm8001_I_T_nexus_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_handle_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">handler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm8001_work</span> <span class="o">*</span><span class="n">pw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pw</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_work</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pw</span><span class="o">-&gt;</span><span class="n">pm8001_ha</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="p">;</span>
		<span class="n">pw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">pw</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">pm8001_work_fn</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">pm8001_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpi_ssp_completion- process the event that FW response to the SSP request.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @piomb: the message contents of this outbound message.</span>
<span class="cm"> *</span>
<span class="cm"> * When FW has completed a ssp request for example a IO request, after it has</span>
<span class="cm"> * filled the SG data with the data, it will trigger this event represent</span>
<span class="cm"> * that he has finished the job,please check the coresponding buffer.</span>
<span class="cm"> * So we will tell the caller who maybe waiting the result to tell upper layer</span>
<span class="cm"> * that the task has been finished.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpi_ssp_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_completion_resp</span> <span class="o">*</span><span class="n">psspPayload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_status_struct</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_response_iu</span> <span class="o">*</span><span class="n">iu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">;</span>
	<span class="n">psspPayload</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ssp_completion_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psspPayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psspPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">IO_ABORTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">open_retry</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Being completed by another */</span>
		<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">open_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psspPayload</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">IO_UNDERFLOW</span><span class="p">)</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;sas IO status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">lldd_task</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IO_SUCCESS</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_SUCCESS&quot;</span>
			<span class="s">&quot;,param = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_PROTO_RESPONSE</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">residual</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
			<span class="n">iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psspPayload</span><span class="o">-&gt;</span><span class="n">ssp_resp_iu</span><span class="p">;</span>
			<span class="n">sas_ssp_task_response</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">iu</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_ABORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_ABORTED IOMB Tag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_UNDERFLOW</span>:
		<span class="cm">/* SSP Completion with error */</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_UNDERFLOW&quot;</span>
			<span class="s">&quot;,param = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_UNDERRUN</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">residual</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_NO_DEVICE</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_NO_DEVICE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_PHY_DOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="cm">/* Force the midlayer to retry */</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_PHY_NOT_READY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_PHY_NOT_READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_EPROTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_UNKNOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span>
			<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_dev</span><span class="p">,</span>
				<span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BAD_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BAD_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_BAD_DEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_CONNECTION_RATE_&quot;</span>
			<span class="s">&quot;NOT_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_CONN_RATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_WRONG_DEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_NAK_RECEIVED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_NAK_RECEIVED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_ACK_NAK_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_ACK_NAK_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_NAK_R_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_DMA</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_OPEN_RETRY_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_OPEN_RETRY_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_OFFSET_MISMATCH</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_OFFSET_MISMATCH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_PORT_IN_RESET</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_PORT_IN_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_DS_NON_OPERATIONAL</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_DS_NON_OPERATIONAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span>
			<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_dev</span><span class="p">,</span>
				<span class="n">IO_DS_NON_OPERATIONAL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_DS_IN_RECOVERY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_DS_IN_RECOVERY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_TM_TAG_NOT_FOUND</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_TM_TAG_NOT_FOUND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_SSP_EXT_IU_ZERO_LEN_ERROR</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_SSP_EXT_IU_ZERO_LEN_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_HW_RESOURCE_BUSY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_HW_RESOURCE_BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Unknown status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
		<span class="cm">/* not allowed case. Therefore, return failed status */</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;scsi_status = %x </span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">,</span>
		<span class="n">psspPayload</span><span class="o">-&gt;</span><span class="n">ssp_resp_iu</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_STATE_PENDING</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_AT_INITIATOR</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_ABORTED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;task 0x%p done with&quot;</span>
			<span class="s">&quot; io_status 0x%x resp 0x%x &quot;</span>
			<span class="s">&quot;stat 0x%x but aborted by upper layer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">t</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">));</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span><span class="cm">/* in order to force CPU ordering */</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*See the comments for mpi_ssp_completion */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpi_ssp_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_status_struct</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_event_resp</span> <span class="o">*</span><span class="n">psspPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ssp_event_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psspPayload</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psspPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">port_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psspPayload</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dev_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psspPayload</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;sas IO status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">lldd_task</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">;</span>
	<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;port_id = %x,device_id = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port_id</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IO_OVERFLOW</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_UNDERFLOW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">IO_XFER_ERROR_BREAK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_PHY_NOT_READY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_PHY_NOT_READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_PROTOCOL_NOT&quot;</span>
			<span class="s">&quot;_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_EPROTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_UNKNOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span>
			<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_dev</span><span class="p">,</span>
				<span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BAD_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BAD_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_BAD_DEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_CONNECTION_RATE_&quot;</span>
			<span class="s">&quot;NOT_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_CONN_RATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		       <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_WRONG_DEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_NAK_RECEIVED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_NAK_RECEIVED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_ACK_NAK_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_ACK_NAK_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_NAK_R_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_OPEN_RETRY_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_OPEN_RETRY_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">IO_XFER_OPEN_RETRY_TIMEOUT</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_UNEXPECTED_PHASE</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_UNEXPECTED_PHASE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_XFER_RDY_OVERRUN</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_XFER_RDY_OVERRUN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		       <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_CMD_ISSUE_ACK_NAK_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_CMD_ISSUE_ACK_NAK_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_OFFSET_MISMATCH</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_OFFSET_MISMATCH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_XFER_ZERO_DATA_LEN</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_XFER_ZERO_DATA_LEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_CMD_FRAME_ISSUED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;  IO_XFER_CMD_FRAME_ISSUED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Unknown status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">));</span>
		<span class="cm">/* not allowed case. Therefore, return failed status */</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_STATE_PENDING</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_AT_INITIATOR</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_ABORTED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;task 0x%p done with&quot;</span>
			<span class="s">&quot; event 0x%x resp 0x%x &quot;</span>
			<span class="s">&quot;stat 0x%x but aborted by upper layer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">t</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">));</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span><span class="cm">/* in order to force CPU ordering */</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*See the comments for mpi_ssp_completion */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpi_sata_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sata_completion_resp</span> <span class="o">*</span><span class="n">psataPayload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_status_struct</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_task_resp</span> <span class="o">*</span><span class="n">resp</span> <span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">sata_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">psataPayload</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sata_completion_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psataPayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psataPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psataPayload</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="n">ts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">;</span>
	<span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;sata IO status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">lldd_task</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IO_SUCCESS</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_PROTO_RESPONSE</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">residual</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
			<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;SAS_PROTO_RESPONSE len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">param</span><span class="p">));</span>
			<span class="n">sata_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psataPayload</span><span class="o">-&gt;</span><span class="n">sata_resp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ata_task_resp</span> <span class="o">*</span><span class="p">)</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">dma_xfer</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pio_setup_fis</span><span class="p">);</span>
				<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;PIO read len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">use_ncq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">set_dev_bits_fis</span><span class="p">);</span>
				<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
					<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;FPDMA len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_to_host_fis</span><span class="p">);</span>
				<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;other len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SAS_STATUS_BUF_SIZE</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">resp</span><span class="o">-&gt;</span><span class="n">frame_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">ending_fis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sata_resp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">ts</span><span class="o">-&gt;</span><span class="n">buf_valid_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
					<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;response to large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_ABORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_ABORTED IOMB Tag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* following cases are to do cases */</span>
	<span class="k">case</span> <span class="n">IO_UNDERFLOW</span>:
		<span class="cm">/* SATA Completion with error */</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_UNDERFLOW param = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_UNDERRUN</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">residual</span> <span class="o">=</span>  <span class="n">param</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_NO_DEVICE</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_NO_DEVICE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_PHY_DOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_INTERRUPTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_PHY_NOT_READY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_PHY_NOT_READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_PROTOCOL_NOT&quot;</span>
			<span class="s">&quot;_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_EPROTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_CONT0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_dev</span><span class="p">,</span>
				<span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="p">);</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_QUEUE_FULL</span><span class="p">;</span>
			<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span><span class="cm">/*in order to force CPU ordering*/</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BAD_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BAD_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_BAD_DEST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_dev</span><span class="p">,</span>
				<span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="p">);</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_QUEUE_FULL</span><span class="p">;</span>
			<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span><span class="cm">/*ditto*/</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_CONNECTION_RATE_&quot;</span>
			<span class="s">&quot;NOT_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_CONN_RATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_STP_RESOURCES&quot;</span>
			<span class="s">&quot;_BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_dev</span><span class="p">,</span>
				<span class="n">IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY</span><span class="p">);</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_QUEUE_FULL</span><span class="p">;</span>
			<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span><span class="cm">/* ditto*/</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		       <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_WRONG_DEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_NAK_RECEIVED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_NAK_RECEIVED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_NAK_R_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_ACK_NAK_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_ACK_NAK_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_NAK_R_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_DMA</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_SATA_LINK_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_SATA_LINK_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_REJECTED_NCQ_MODE</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_REJECTED_NCQ_MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_UNDERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_OPEN_RETRY_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_OPEN_RETRY_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_TO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_PORT_IN_RESET</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_PORT_IN_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_DS_NON_OPERATIONAL</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_DS_NON_OPERATIONAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_dev</span><span class="p">,</span>
				    <span class="n">IO_DS_NON_OPERATIONAL</span><span class="p">);</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_QUEUE_FULL</span><span class="p">;</span>
			<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span><span class="cm">/*ditto*/</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_DS_IN_RECOVERY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;  IO_DS_IN_RECOVERY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_DS_IN_ERROR</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_DS_IN_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_dev</span><span class="p">,</span>
				    <span class="n">IO_DS_IN_ERROR</span><span class="p">);</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_QUEUE_FULL</span><span class="p">;</span>
			<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span><span class="cm">/*ditto*/</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_HW_RESOURCE_BUSY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_HW_RESOURCE_BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Unknown status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
		<span class="cm">/* not allowed case. Therefore, return failed status */</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_STATE_PENDING</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_AT_INITIATOR</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_ABORTED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;task 0x%p done with io_status 0x%x&quot;</span>
			<span class="s">&quot; resp 0x%x stat 0x%x but aborted by upper layer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">t</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">));</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span><span class="cm">/* ditto */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span><span class="cm">/*ditto*/</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*See the comments for mpi_ssp_completion */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpi_sata_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_status_struct</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sata_event_resp</span> <span class="o">*</span><span class="n">psataPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">sata_event_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psataPayload</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psataPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">port_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psataPayload</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dev_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psataPayload</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;sata IO status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">lldd_task</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">;</span>
	<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;port_id = %x,device_id = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port_id</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IO_OVERFLOW</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_UNDERFLOW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_INTERRUPTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_PHY_NOT_READY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_PHY_NOT_READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_PROTOCOL_NOT&quot;</span>
			<span class="s">&quot;_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_EPROTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_CONT0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_dev</span><span class="p">,</span>
				<span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="p">);</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_QUEUE_FULL</span><span class="p">;</span>
			<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span><span class="cm">/*ditto*/</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BAD_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BAD_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_BAD_DEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_CONNECTION_RATE_&quot;</span>
			<span class="s">&quot;NOT_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_CONN_RATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		       <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_WRONG_DEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_NAK_RECEIVED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_NAK_RECEIVED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_NAK_R_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_PEER_ABORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_PEER_ABORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_NAK_R_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_REJECTED_NCQ_MODE</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_REJECTED_NCQ_MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_UNDERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_OPEN_RETRY_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_OPEN_RETRY_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_TO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_UNEXPECTED_PHASE</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_UNEXPECTED_PHASE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_TO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_XFER_RDY_OVERRUN</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_XFER_RDY_OVERRUN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_TO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		       <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_TO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_OFFSET_MISMATCH</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_OFFSET_MISMATCH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_TO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_XFER_ZERO_DATA_LEN</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_XFER_ZERO_DATA_LEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_TO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_CMD_FRAME_ISSUED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_CMD_FRAME_ISSUED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_PIO_SETUP_ERROR</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_PIO_SETUP_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_TO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Unknown status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">));</span>
		<span class="cm">/* not allowed case. Therefore, return failed status */</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_TO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_STATE_PENDING</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_AT_INITIATOR</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_ABORTED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;task 0x%p done with io_status 0x%x&quot;</span>
			<span class="s">&quot; resp 0x%x stat 0x%x but aborted by upper layer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">t</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">));</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span><span class="cm">/* ditto */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span><span class="cm">/*ditto*/</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*See the comments for mpi_ssp_completion */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpi_smp_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smp_completion_resp</span> <span class="o">*</span><span class="n">psmpPayload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_status_struct</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">;</span>

	<span class="n">psmpPayload</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smp_completion_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psmpPayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psmpPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">psmpPayload</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="n">ts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">;</span>
	<span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;smp IO status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">lldd_task</span> <span class="o">||</span> <span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IO_SUCCESS</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_ABORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_ABORTED IOMB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OVERFLOW</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_UNDERFLOW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DATA_OVERRUN</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="p">)</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">running_req</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_NO_DEVICE</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_NO_DEVICE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_PHY_DOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_ERROR_HW_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_ERROR_HW_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAM_STAT_BUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAM_STAT_BUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_PHY_NOT_READY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_PHY_NOT_READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAM_STAT_BUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_ZONE_VIOLATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BREAK</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BREAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_CONT0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_UNKNOWN</span><span class="p">;</span>
		<span class="n">pm8001_handle_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_dev</span><span class="p">,</span>
				<span class="n">IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_BAD_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_BAD_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_BAD_DEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_CONNECTION_RATE_&quot;</span>
			<span class="s">&quot;NOT_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_CONN_RATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		       <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_WRONG_DESTINATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_WRONG_DEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_ERROR_RX_FRAME</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_ERROR_RX_FRAME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_XFER_OPEN_RETRY_TIMEOUT</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_XFER_OPEN_RETRY_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_ERROR_INTERNAL_SMP_RESOURCE</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_ERROR_INTERNAL_SMP_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_QUEUE_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_PORT_IN_RESET</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_PORT_IN_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_DS_NON_OPERATIONAL</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_DS_NON_OPERATIONAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_DS_IN_RECOVERY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_DS_IN_RECOVERY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_OPEN_CNX_ERROR_HW_RESOURCE_BUSY</span>:
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_OPEN_CNX_ERROR_HW_RESOURCE_BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">SAS_OREJ_RSVD_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Unknown status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_DEV_NO_RESPONSE</span><span class="p">;</span>
		<span class="cm">/* not allowed case. Therefore, return failed status */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_STATE_PENDING</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_AT_INITIATOR</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;</span> <span class="n">SAS_TASK_STATE_ABORTED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;task 0x%p done with&quot;</span>
			<span class="s">&quot; io_status 0x%x resp 0x%x &quot;</span>
			<span class="s">&quot;stat 0x%x but aborted by upper layer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">t</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">));</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span><span class="cm">/* in order to force CPU ordering */</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpi_set_dev_state_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">set_dev_state_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">set_dev_state_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">device_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">pds</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">pds_nds</span><span class="p">)</span> <span class="o">|</span> <span class="n">PDS_BITS</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nds</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">pds_nds</span><span class="p">)</span> <span class="o">|</span> <span class="n">NDS_BITS</span><span class="p">;</span>
	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Set device id = 0x%x state &quot;</span>
		<span class="s">&quot;from 0x%x to 0x%x status = 0x%x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">device_id</span><span class="p">,</span> <span class="n">pds</span><span class="p">,</span> <span class="n">nds</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
	<span class="n">complete</span><span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">setds_completion</span><span class="p">);</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">pm8001_ccb_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpi_set_nvmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">get_nvm_data_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">get_nvm_data_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dlen_status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">dlen_status</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">nvmd_completion</span><span class="p">);</span>
	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Set nvm data complete!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dlen_status</span> <span class="o">&amp;</span> <span class="n">NVMD_STAT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Set nvm data error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">pm8001_ccb_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpi_get_nvmd_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_control_ex</span>	<span class="o">*</span><span class="n">fw_control_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">get_nvm_data_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">get_nvm_data_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dlen_status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">dlen_status</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ir_tds_bn_dps_das_nvm</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">ir_tda_bn_dps_das_nvm</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">virt_addr</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">virt_ptr</span><span class="p">;</span>
	<span class="n">fw_control_context</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">fw_control_context</span><span class="p">;</span>

	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Get nvm data complete!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dlen_status</span> <span class="o">&amp;</span> <span class="n">NVMD_STAT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Get nvm data error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">nvmd_completion</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir_tds_bn_dps_das_nvm</span> <span class="o">&amp;</span> <span class="n">IPMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* indirect mode - IR bit set */</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Get NVMD success, IR=1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ir_tds_bn_dps_das_nvm</span> <span class="o">&amp;</span> <span class="n">NVMD_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">TWI_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ir_tds_bn_dps_das_nvm</span> <span class="o">==</span> <span class="mh">0x80a80200</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span>
				      <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span>
				       <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
				<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
					<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Get SAS address&quot;</span>
					<span class="s">&quot; from VPD successfully!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">ir_tds_bn_dps_das_nvm</span> <span class="o">&amp;</span> <span class="n">NVMD_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_SEEPROM</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">ir_tds_bn_dps_das_nvm</span> <span class="o">&amp;</span> <span class="n">NVMD_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">VPD_FLASH</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">ir_tds_bn_dps_das_nvm</span> <span class="o">&amp;</span> <span class="n">NVMD_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXPAN_ROM</span><span class="p">))</span> <span class="p">{</span>
				<span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">ir_tds_bn_dps_das_nvm</span> <span class="o">&amp;</span> <span class="n">NVMD_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">AAP1_RDUMP</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">ir_tds_bn_dps_das_nvm</span> <span class="o">&amp;</span> <span class="n">NVMD_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IOP_RDUMP</span><span class="p">))</span> <span class="p">{</span>
			<span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Should not be happened*/</span>
			<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
				<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;(IR=1)Wrong Device type 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ir_tds_bn_dps_das_nvm</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* direct mode */</span><span class="p">{</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Get NVMD success, IR=0, dataLen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dlen_status</span> <span class="o">&amp;</span> <span class="n">NVMD_LEN</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_control_context</span><span class="o">-&gt;</span><span class="n">usrAddr</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">virt_ptr</span><span class="p">,</span>
		<span class="n">fw_control_context</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">nvmd_completion</span><span class="p">);</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">pm8001_ccb_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_local_phy_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_phy_ctl_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">local_phy_ctl_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">phy_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">phyop_phyid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ID_BITS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_op</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">phyop_phyid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OP_BITS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;%x phy execute %x phy op failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phy_id</span><span class="p">,</span> <span class="n">phy_op</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;%x phy execute %x phy op success!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phy_id</span><span class="p">,</span> <span class="n">phy_op</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_bytes_dmaed - one of the interface function communication with libsas</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @i: which phy that received the event.</span>
<span class="cm"> *</span>
<span class="cm"> * when HBA driver received the identify done event or initiate FIS received</span>
<span class="cm"> * event(for SATA), it will invoke this function to notify the sas layer that</span>
<span class="cm"> * the sas toplogy has formed, please discover the the whole sas domain,</span>
<span class="cm"> * while receive a broadcast(change) primitive just tell the sas</span>
<span class="cm"> * layer to discover the changed domain rather than the whole domain.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm8001_bytes_dmaed</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm8001_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">asd_sas_phy</span> <span class="o">*</span><span class="n">sas_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_ha_struct</span> <span class="o">*</span><span class="n">sas_ha</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sas_ha</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">sas</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">sphy</span> <span class="o">=</span> <span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
		<span class="n">sphy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">;</span>
		<span class="n">sphy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span><span class="p">;</span>
		<span class="n">sphy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate_hw</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
		<span class="n">sphy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span><span class="p">;</span>
		<span class="n">sphy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate_hw</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">PORT_TYPE_SAS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sas_identify_frame</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sas_identify_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">frame_rcvd</span><span class="p">;</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span><span class="p">;</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">initiator_bits</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_ALL</span><span class="p">;</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">target_bits</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">target_port_protocols</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">PORT_TYPE_SATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*Nothing*/</span>
	<span class="p">}</span>
	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;phy %d byte dmaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">frame_rcvd_size</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">frame_rcvd_size</span><span class="p">;</span>
	<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">sas</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_BYTES_DMAED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get the link rate speed  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_lrate_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">sas_phy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">link_rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_SPEED_60</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_6_0_GBPS</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_6_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PHY_SPEED_30</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_3_0_GBPS</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_3_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PHY_SPEED_15</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">linkrate</span><span class="p">;</span>
	<span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate_hw</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_6_0_GBPS</span><span class="p">;</span>
	<span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate_hw</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
	<span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_6_0_GBPS</span><span class="p">;</span>
	<span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * asd_get_attached_sas_addr -- extract/generate attached SAS address</span>
<span class="cm"> * @phy: pointer to asd_phy</span>
<span class="cm"> * @sas_addr: pointer to buffer where the SAS address is to be written</span>
<span class="cm"> *</span>
<span class="cm"> * This function extracts the SAS address from an IDENTIFY frame</span>
<span class="cm"> * received.  If OOB is SATA, then a SAS address is generated from the</span>
<span class="cm"> * HA tables.</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING: the frame_rcvd_lock needs to be held since this parses the frame</span>
<span class="cm"> * buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm8001_get_attached_sas_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">sas_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">frame_rcvd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x34</span>
		<span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">oob_mode</span> <span class="o">==</span> <span class="n">SATA_OOB_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">lldd_ha</span><span class="p">;</span>
		<span class="cm">/* FIS device-to-host */</span>
		<span class="n">u64</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span><span class="n">sas_addr</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sas_identify_frame</span> <span class="o">*</span><span class="n">idframe</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">frame_rcvd</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sas_addr</span><span class="p">,</span> <span class="n">idframe</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_hw_event_ack_req- For PM8001,some events need to acknowage to FW.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @Qnum: the outbound queue message number.</span>
<span class="cm"> * @SEA: source of event to ack</span>
<span class="cm"> * @port_id: port id.</span>
<span class="cm"> * @phyId: phy id.</span>
<span class="cm"> * @param0: parameter 0.</span>
<span class="cm"> * @param1: parameter 1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">Qnum</span><span class="p">,</span> <span class="n">u32</span> <span class="n">SEA</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phyId</span><span class="p">,</span> <span class="n">u32</span> <span class="n">param0</span><span class="p">,</span> <span class="n">u32</span> <span class="n">param1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_event_ack_req</span>	 <span class="n">payload</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SAS_HW_EVENT_ACK</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="n">Qnum</span><span class="p">];</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">sea_phyid_portid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">SEA</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">phyId</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">));</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">param0</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">param0</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">param1</span><span class="p">);</span>
	<span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pm8001_chip_phy_ctl_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">phyId</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_op</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * hw_event_sas_phy_up -FW tells me a SAS phy up event.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @piomb: IO message buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hw_event_sas_phy_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_event_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">hw_event_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">lr_evt_status_phyid_portid</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">lr_evt_status_phyid_portid</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">link_rate</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0xF0000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">port_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x0000000F</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">phy_id</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x000000F0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">npip_portstate</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">npip_portstate</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">portstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">npip_portstate</span> <span class="o">&amp;</span> <span class="mh">0x0000000F</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pm8001_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sas_ha_struct</span> <span class="o">*</span><span class="n">sas_ha</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">sas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">deviceType</span> <span class="o">=</span> <span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">sas_identify</span><span class="p">.</span><span class="n">dev_type</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span>  <span class="n">portstate</span><span class="p">;</span>
	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_SAS_PHY_UP port id = %d, phy id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">deviceType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAS_PHY_UNUSED</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;device type no device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS_END_DEVICE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;end device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_chip_phy_ctl_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span>
			<span class="n">PHY_NOTIFY_ENABLE_SPINUP</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_attached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">get_lrate_mode</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">link_rate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS_EDGE_EXPANDER_DEVICE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;expander device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_attached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">get_lrate_mode</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">link_rate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;fanout expander device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_attached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">get_lrate_mode</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">link_rate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;unknown device type(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">deviceType</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">|=</span> <span class="n">PORT_TYPE_SAS</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">deviceType</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">SAS_END_DEVICE</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">target_port_protocols</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_SSP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">SAS_PHY_UNUSED</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">target_port_protocols</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">oob_mode</span> <span class="o">=</span> <span class="n">SAS_OOB_MODE</span><span class="p">;</span>
	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_phy_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PHYE_OOB_DONE</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">frame_rcvd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">frame_rcvd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">sas_identify</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_identify_frame</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">frame_rcvd_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_identify_frame</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pm8001_get_attached_sas_addr</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">attached_sas_addr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">frame_rcvd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">PM8001F_RUN_TIME</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span><span class="cm">/*delay a moment to wait disk to spinup*/</span>
	<span class="n">pm8001_bytes_dmaed</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_event_sata_phy_up -FW tells me a SATA phy up event.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @piomb: IO message buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hw_event_sata_phy_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_event_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">hw_event_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">lr_evt_status_phyid_portid</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">lr_evt_status_phyid_portid</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">link_rate</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0xF0000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">port_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x0000000F</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">phy_id</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x000000F0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">npip_portstate</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">npip_portstate</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">portstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">npip_portstate</span> <span class="o">&amp;</span> <span class="mh">0x0000000F</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pm8001_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sas_ha_struct</span> <span class="o">*</span><span class="n">sas_ha</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">sas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_SATA_PHY_UP port id = %d,&quot;</span>
		<span class="s">&quot; phy id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span>  <span class="n">portstate</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_attached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">get_lrate_mode</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">link_rate</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">|=</span> <span class="n">PORT_TYPE_SATA</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">oob_mode</span> <span class="o">=</span> <span class="n">SATA_OOB_MODE</span><span class="p">;</span>
	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_phy_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PHYE_OOB_DONE</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">frame_rcvd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">frame_rcvd</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">sata_fis</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_to_host_fis</span><span class="p">));</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">frame_rcvd_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_to_host_fis</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">target_port_protocols</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_SATA</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">SATA_DEV</span><span class="p">;</span>
	<span class="n">pm8001_get_attached_sas_addr</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">attached_sas_addr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">.</span><span class="n">frame_rcvd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pm8001_bytes_dmaed</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_event_phy_down -we should notify the libsas the phy is down.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @piomb: IO message buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hw_event_phy_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_event_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">hw_event_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">lr_evt_status_phyid_portid</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">lr_evt_status_phyid_portid</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">port_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x0000000F</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">phy_id</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x000000F0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">npip_portstate</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">npip_portstate</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">portstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">npip_portstate</span> <span class="o">&amp;</span> <span class="mh">0x0000000F</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pm8001_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">port_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pm8001_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span>  <span class="n">portstate</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev_sas_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">portstate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_VALID</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_INVALID</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; PortInvalid portID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_id</span><span class="p">));</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; Last phy Down and port invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HW_EVENT_PHY_DOWN</span><span class="p">,</span>
			<span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_IN_RESET</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; Port In Reset portID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_id</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_NOT_ESTABLISHED</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; phy Down and PORT_NOT_ESTABLISHED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_LOSTCOMM</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; phy Down and PORT_LOSTCOMM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; Last phy Down and port invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HW_EVENT_PHY_DOWN</span><span class="p">,</span>
			<span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">port_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; phy Down and(default) = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">portstate</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpi_reg_resp -process register device ID response.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @piomb: IO message buffer</span>
<span class="cm"> *</span>
<span class="cm"> * when sas layer find a device it will notify LLDD, then the driver register</span>
<span class="cm"> * the domain device to FW, this event is the return device ID which the FW</span>
<span class="cm"> * has assigned, from now,inter-communication with FW is no longer using the</span>
<span class="cm"> * SAS address, use device ID which FW assigned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_reg_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">htag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_reg_resp</span> <span class="o">*</span><span class="n">registerRespPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">dev_reg_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">htag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">registerRespPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">htag</span><span class="p">];</span>
	<span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">registerRespPayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">device_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">registerRespPayload</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; register device is status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEVREG_SUCCESS</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DEVREG_SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">device_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVREG_FAILURE_OUT_OF_RESOURCE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DEVREG_FAILURE_OUT_OF_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVREG_FAILURE_DEVICE_ALREADY_REGISTERED</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		   <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DEVREG_FAILURE_DEVICE_ALREADY_REGISTERED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVREG_FAILURE_INVALID_PHY_ID</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DEVREG_FAILURE_INVALID_PHY_ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVREG_FAILURE_PHY_ID_ALREADY_REGISTERED</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		   <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DEVREG_FAILURE_PHY_ID_ALREADY_REGISTERED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVREG_FAILURE_PORT_ID_OUT_OF_RANGE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DEVREG_FAILURE_PORT_ID_OUT_OF_RANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVREG_FAILURE_PORT_NOT_VALID_STATE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DEVREG_FAILURE_PORT_NOT_VALID_STATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVREG_FAILURE_DEVICE_TYPE_NOT_VALID</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		       <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DEVREG_FAILURE_DEVICE_TYPE_NOT_VALID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		 <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DEVREG_FAILURE_DEVICE_TYPE_NOT_UNSORPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">complete</span><span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">dcompletion</span><span class="p">);</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">pm8001_ccb_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">htag</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_dereg_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_reg_resp</span> <span class="o">*</span><span class="n">registerRespPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">dev_reg_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">registerRespPayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">device_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">registerRespPayload</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; deregister device failed ,status = %x&quot;</span>
			<span class="s">&quot;, device_id = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">device_id</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpi_fw_flash_update_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_control_ex</span>	<span class="n">fw_control_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_flash_Update_resp</span> <span class="o">*</span><span class="n">ppayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">fw_flash_Update_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ppayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ppayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_control_context</span><span class="p">,</span>
		<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">fw_control_context</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">fw_control_context</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLASH_UPDATE_COMPLETE_PENDING_REBOOT</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: FLASH_UPDATE_COMPLETE_PENDING_REBOOT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_UPDATE_IN_PROGRESS</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: FLASH_UPDATE_IN_PROGRESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_UPDATE_HDR_ERR</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: FLASH_UPDATE_HDR_ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_UPDATE_OFFSET_ERR</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: FLASH_UPDATE_OFFSET_ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_UPDATE_CRC_ERR</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: FLASH_UPDATE_CRC_ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_UPDATE_LENGTH_ERR</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: FLASH_UPDATE_LENGTH_ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_UPDATE_HW_ERR</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: FLASH_UPDATE_HW_ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_UPDATE_DNLD_NOT_SUPPORTED</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: FLASH_UPDATE_DNLD_NOT_SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_UPDATE_DISABLED</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;: FLASH_UPDATE_DISABLED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;No matched status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">fw_control_context</span><span class="o">-&gt;</span><span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">retcode</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">fw_control_context</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
			<span class="n">fw_control_context</span><span class="p">.</span><span class="n">virtAddr</span><span class="p">,</span>
			<span class="n">fw_control_context</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">nvmd_completion</span><span class="p">);</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">pm8001_ccb_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpi_general_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">general_event_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">general_event_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GENERAL_EVENT_PAYLOAD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;inb_IOMB_payload[0x%x] 0x%x,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">inb_IOMB_payload</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpi_task_abort_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">,</span> <span class="n">scp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_status_struct</span> <span class="o">*</span><span class="n">ts</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">task_abort_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">task_abort_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">scp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">scp</span><span class="p">);</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot; status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;task abort failed status 0x%x ,&quot;</span>
			<span class="s">&quot;tag = 0x%x, scp= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">scp</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IO_SUCCESS</span>:
		<span class="n">PM8001_EH_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IO_NOT_VALID</span>:
		<span class="n">PM8001_EH_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;IO_NOT_VALID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">TMF_RESP_FUNC_FAILED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_STATE_PENDING</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAS_TASK_AT_INITIATOR</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pm8001_ccb_task_free</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">task_done</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpi_hw_event -The hw event has come.</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @piomb: IO message buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_hw_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_event_resp</span> <span class="o">*</span><span class="n">pPayload</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">hw_event_resp</span> <span class="o">*</span><span class="p">)(</span><span class="n">piomb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">lr_evt_status_phyid_portid</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPayload</span><span class="o">-&gt;</span><span class="n">lr_evt_status_phyid_portid</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">port_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x0000000F</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">phy_id</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x000000F0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">eventType</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x00FFFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lr_evt_status_phyid_portid</span> <span class="o">&amp;</span> <span class="mh">0x0F000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sas_ha_struct</span> <span class="o">*</span><span class="n">sas_ha</span> <span class="o">=</span> <span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">sas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">asd_sas_phy</span> <span class="o">*</span><span class="n">sas_phy</span> <span class="o">=</span> <span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">[</span><span class="n">phy_id</span><span class="p">];</span>
	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;outbound queue HW event &amp; event type : &quot;</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">eventType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HW_EVENT_PHY_START_STATUS</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PHY_START_STATUS&quot;</span>
			<span class="s">&quot; status = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">PM8001F_RUN_TIME</span><span class="p">)</span>
				<span class="n">complete</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">enable_completion</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_SAS_PHY_UP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PHY_START_STATUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">hw_event_sas_phy_up</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_SATA_PHY_UP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_SATA_PHY_UP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">hw_event_sata_phy_up</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_PHY_STOP_STATUS</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PHY_STOP_STATUS &quot;</span>
			<span class="s">&quot;status = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_SATA_SPINUP_HOLD</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_SATA_SPINUP_HOLD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_phy_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PHYE_SPINUP_HOLD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_PHY_DOWN</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PHY_DOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_phy_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PHYE_LOSS_OF_SIGNAL</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw_event_phy_down</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_PORT_INVALID</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PORT_INVALID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_LINK_RESET_ERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* the broadcast change primitive received, tell the LIBSAS this event</span>
<span class="cm">	to revalidate the sas domain*/</span>
	<span class="k">case</span> <span class="n">HW_EVENT_BROADCAST_CHANGE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_BROADCAST_CHANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HW_EVENT_BROADCAST_CHANGE</span><span class="p">,</span>
			<span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">sas_prim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">sas_prim</span> <span class="o">=</span> <span class="n">HW_EVENT_BROADCAST_CHANGE</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">sas_prim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_BROADCAST_RCVD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_PHY_ERROR</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PHY_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_phy_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PHYE_OOB_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_BROADCAST_EXP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_BROADCAST_EXP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">sas_prim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">sas_prim</span> <span class="o">=</span> <span class="n">HW_EVENT_BROADCAST_EXP</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">sas_prim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_BROADCAST_RCVD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_LINK_ERR_INVALID_DWORD</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_LINK_ERR_INVALID_DWORD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">HW_EVENT_LINK_ERR_INVALID_DWORD</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_LINK_RESET_ERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_LINK_ERR_DISPARITY_ERROR</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_LINK_ERR_DISPARITY_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">HW_EVENT_LINK_ERR_DISPARITY_ERROR</span><span class="p">,</span>
			<span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_LINK_RESET_ERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_LINK_ERR_CODE_VIOLATION</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_LINK_ERR_CODE_VIOLATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">HW_EVENT_LINK_ERR_CODE_VIOLATION</span><span class="p">,</span>
			<span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_LINK_RESET_ERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_LINK_ERR_LOSS_OF_DWORD_SYNCH</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		      <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_LINK_ERR_LOSS_OF_DWORD_SYNCH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">HW_EVENT_LINK_ERR_LOSS_OF_DWORD_SYNCH</span><span class="p">,</span>
			<span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_LINK_RESET_ERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_MALFUNCTION</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_MALFUNCTION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_BROADCAST_SES</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_BROADCAST_SES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">sas_prim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">sas_prim</span> <span class="o">=</span> <span class="n">HW_EVENT_BROADCAST_SES</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_phy</span><span class="o">-&gt;</span><span class="n">sas_prim_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_BROADCAST_RCVD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_INBOUND_CRC_ERROR</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_INBOUND_CRC_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">HW_EVENT_INBOUND_CRC_ERROR</span><span class="p">,</span>
			<span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_HARD_RESET_RECEIVED</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_HARD_RESET_RECEIVED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_HARD_RESET</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_ID_FRAME_TIMEOUT</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_ID_FRAME_TIMEOUT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_LINK_RESET_ERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_LINK_ERR_PHY_RESET_FAILED</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_LINK_ERR_PHY_RESET_FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">pm8001_hw_event_ack_req</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">HW_EVENT_LINK_ERR_PHY_RESET_FAILED</span><span class="p">,</span>
			<span class="n">port_id</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_LINK_RESET_ERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_PORT_RESET_TIMER_TMO</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PORT_RESET_TIMER_TMO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_LINK_RESET_ERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_PORT_RECOVERY_TIMER_TMO</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PORT_RECOVERY_TIMER_TMO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">sas_phy_disconnected</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_attached</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">notify_port_event</span><span class="p">(</span><span class="n">sas_phy</span><span class="p">,</span> <span class="n">PORTE_LINK_RESET_ERR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_PORT_RECOVER</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PORT_RECOVER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_EVENT_PORT_RESET_COMPLETE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;HW_EVENT_PORT_RESET_COMPLETE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_BROADCAST_ASYNCH_EVENT</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;EVENT_BROADCAST_ASYNCH_EVENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Unknown event type = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eventType</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * process_one_iomb - process one outbound Queue memory block</span>
<span class="cm"> * @pm8001_ha: our hba card information</span>
<span class="cm"> * @piomb: IO message buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_one_iomb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">piomb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">pHeader</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">piomb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pHeader</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">);</span>

	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;process_one_iomb:&quot;</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OPC_OUB_ECHO</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_ECHO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_HW_EVENT</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_HW_EVENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_hw_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SSP_COMP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SSP_COMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_ssp_completion</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SMP_COMP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SMP_COMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_smp_completion</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_LOCAL_PHY_CNTRL</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_LOCAL_PHY_CNTRL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_local_phy_ctl</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_DEV_REGIST</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_DEV_REGIST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_reg_resp</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_DEREG_DEV</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;unregister the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_dereg_resp</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_GET_DEV_HANDLE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_GET_DEV_HANDLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SATA_COMP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SATA_COMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_sata_completion</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SATA_EVENT</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SATA_EVENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_sata_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SSP_EVENT</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SSP_EVENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_ssp_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_DEV_HANDLE_ARRIV</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_DEV_HANDLE_ARRIV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="cm">/*This is for target*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SSP_RECV_EVENT</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SSP_RECV_EVENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="cm">/*This is for target*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_DEV_INFO</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_DEV_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_FW_FLASH_UPDATE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_FW_FLASH_UPDATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_fw_flash_update_resp</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_GPIO_RESPONSE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_GPIO_RESPONSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_GPIO_EVENT</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_GPIO_EVENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_GENERAL_EVENT</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_GENERAL_EVENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_general_event</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SSP_ABORT_RSP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SSP_ABORT_RSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_task_abort_resp</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SATA_ABORT_RSP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SATA_ABORT_RSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_task_abort_resp</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SAS_DIAG_MODE_START_END</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SAS_DIAG_MODE_START_END</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SAS_DIAG_EXECUTE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SAS_DIAG_EXECUTE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_GET_TIME_STAMP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_GET_TIME_STAMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SAS_HW_EVENT_ACK</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SAS_HW_EVENT_ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_PORT_CONTROL</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_PORT_CONTROL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SMP_ABORT_RSP</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SMP_ABORT_RSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_task_abort_resp</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_GET_NVMD_DATA</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_GET_NVMD_DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_get_nvmd_resp</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SET_NVMD_DATA</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SET_NVMD_DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_set_nvmd_resp</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_DEVICE_HANDLE_REMOVAL</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_DEVICE_HANDLE_REMOVAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SET_DEVICE_STATE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SET_DEVICE_STATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">mpi_set_dev_state_resp</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">piomb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_GET_DEVICE_STATE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_GET_DEVICE_STATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SET_DEV_INFO</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SET_DEV_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPC_OUB_SAS_RE_INITIALIZE</span>:
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;OPC_OUB_SAS_RE_INITIALIZE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
			<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Unknown outbound Queue IOMB OPC = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">opc</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_oq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">outbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pMsg1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">bc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">MPI_IO_STATUS_FAIL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">outbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_msg_consume</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pMsg1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MPI_IO_STATUS_SUCCESS</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* process the outbound message */</span>
			<span class="n">process_one_iomb</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">pMsg1</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
			<span class="cm">/* free the message from the outbound circular buffer */</span>
			<span class="n">mpi_msg_free_set</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pMsg1</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MPI_IO_STATUS_BUSY</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Update the producer index from SPC */</span>
			<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_read_32</span><span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">pi_virt</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">circularQ</span><span class="o">-&gt;</span><span class="n">consumer_idx</span><span class="p">)</span>
				<span class="cm">/* OQ is empty */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PCI_DMA_... to our direction translation. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">data_dir_flags</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATA_DIR_BYRECIPIENT</span><span class="p">,</span><span class="cm">/* UNSPECIFIED */</span>
	<span class="p">[</span><span class="n">PCI_DMA_TODEVICE</span><span class="p">]</span>	<span class="o">=</span> <span class="n">DATA_DIR_OUT</span><span class="p">,</span><span class="cm">/* OUTBOUND */</span>
	<span class="p">[</span><span class="n">PCI_DMA_FROMDEVICE</span><span class="p">]</span>	<span class="o">=</span> <span class="n">DATA_DIR_IN</span><span class="p">,</span><span class="cm">/* INBOUND */</span>
	<span class="p">[</span><span class="n">PCI_DMA_NONE</span><span class="p">]</span>		<span class="o">=</span> <span class="n">DATA_DIR_NONE</span><span class="p">,</span><span class="cm">/* NO TRANSFER */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pm8001_chip_make_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">scatter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">prd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_prd</span> <span class="o">*</span><span class="n">buf_prd</span> <span class="o">=</span> <span class="n">prd</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_prd</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">buf_prd</span><span class="o">-&gt;</span><span class="n">im_len</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">buf_prd</span><span class="o">-&gt;</span><span class="n">im_len</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf_prd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_smp_cmd</span><span class="p">(</span><span class="n">u32</span> <span class="n">deviceID</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">hTag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smp_req</span> <span class="o">*</span><span class="n">psmp_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">psmp_cmd</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">hTag</span><span class="p">;</span>
	<span class="n">psmp_cmd</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">deviceID</span><span class="p">);</span>
	<span class="n">psmp_cmd</span><span class="o">-&gt;</span><span class="n">len_ip_ir</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_smp_req - send a SMP task to FW</span>
<span class="cm"> * @pm8001_ha: our hba card information.</span>
<span class="cm"> * @ccb: the ccb information this request used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_smp_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">elem</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lldd_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg_req</span><span class="p">,</span> <span class="o">*</span><span class="n">sg_resp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">req_len</span><span class="p">,</span> <span class="n">resp_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smp_req</span> <span class="n">smp_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">smp_cmd</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * DMA-map SMP request, response buffers</span>
<span class="cm">	 */</span>
	<span class="n">sg_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_req</span><span class="p">;</span>
	<span class="n">elem</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg_req</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">elem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">req_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_req</span><span class="p">);</span>

	<span class="n">sg_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_resp</span><span class="p">;</span>
	<span class="n">elem</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg_resp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">elem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">resp_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_resp</span><span class="p">);</span>
	<span class="cm">/* must be in dwords */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req_len</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">resp_len</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SMP_REQUEST</span><span class="p">;</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">smp_cmd</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span><span class="p">);</span>
	<span class="n">smp_cmd</span><span class="p">.</span><span class="n">long_smp_req</span><span class="p">.</span><span class="n">long_req_addr</span> <span class="o">=</span>
		<span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_req</span><span class="p">));</span>
	<span class="n">smp_cmd</span><span class="p">.</span><span class="n">long_smp_req</span><span class="p">.</span><span class="n">long_req_size</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_req</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">smp_cmd</span><span class="p">.</span><span class="n">long_smp_req</span><span class="p">.</span><span class="n">long_resp_addr</span> <span class="o">=</span>
		<span class="n">cpu_to_le64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_resp</span><span class="p">));</span>
	<span class="n">smp_cmd</span><span class="p">.</span><span class="n">long_smp_req</span><span class="p">.</span><span class="n">long_resp_size</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_resp</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">build_smp_cmd</span><span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">smp_cmd</span><span class="p">.</span><span class="n">tag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smp_cmd</span><span class="p">);</span>
	<span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">smp_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_2:</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_resp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_req</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_ssp_io_req - send a SSP task to FW</span>
<span class="cm"> * @pm8001_ha: our hba card information.</span>
<span class="cm"> * @ccb: the ccb information this request used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_ssp_io_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lldd_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_ini_io_start_req</span> <span class="n">ssp_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SSPINIIOSTART</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssp_cmd</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssp_cmd</span><span class="p">.</span><span class="n">ssp_iu</span><span class="p">.</span><span class="n">lun</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">LUN</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">dir_m_tlr</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_dir_flags</span><span class="p">[</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="mh">0x0</span><span class="p">);</span><span class="cm">/*0 for</span>
<span class="cm">	SAS 1.1 compatible TLR*/</span>
	<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">);</span>
	<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">enable_first_burst</span><span class="p">)</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">ssp_iu</span><span class="p">.</span><span class="n">efb_prio_attr</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">ssp_iu</span><span class="p">.</span><span class="n">efb_prio_attr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">task_prio</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">ssp_iu</span><span class="p">.</span><span class="n">efb_prio_attr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">task_attr</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssp_cmd</span><span class="p">.</span><span class="n">ssp_iu</span><span class="p">.</span><span class="n">cdb</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">cdb</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* fill in PRD (scatter/gather) table, if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm8001_chip_make_sg</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">buf_prd</span><span class="p">);</span>
		<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_dma_handle</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_ccb_info</span><span class="p">,</span> <span class="n">buf_prd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">addr_low</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">));</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">addr_high</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">));</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">esgl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">);</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">addr_low</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">));</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">addr_high</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">));</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">);</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">esgl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">addr_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">addr_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">);</span>
		<span class="n">ssp_cmd</span><span class="p">.</span><span class="n">esgl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssp_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_sata_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_ha_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lldd_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sata_start_req</span> <span class="n">sata_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hdr_tag</span><span class="p">,</span> <span class="n">ncg_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ATAP</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SATA_HOST_OPSTART</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sata_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sata_cmd</span><span class="p">));</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">PCI_DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATAP</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>  <span class="cm">/* no data*/</span>
		<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;no data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">device_control_reg_update</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">dma_xfer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ATAP</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span> <span class="cm">/* DMA */</span>
			<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ATAP</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span> <span class="cm">/* PIO*/</span>
			<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;PIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">use_ncq</span> <span class="o">&amp;&amp;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sata_dev</span><span class="p">.</span><span class="n">command_set</span> <span class="o">!=</span> <span class="n">ATAPI_COMMAND_SET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ATAP</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span> <span class="cm">/* FPDMA */</span>
			<span class="n">PM8001_IO_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;FPDMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">use_ncq</span> <span class="o">&amp;&amp;</span> <span class="n">pm8001_get_ncq_tag</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_tag</span><span class="p">))</span>
		<span class="n">ncg_tag</span> <span class="o">=</span> <span class="n">hdr_tag</span><span class="p">;</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="n">data_dir_flags</span><span class="p">[</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sata_cmd</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">sata_cmd</span><span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha_dev</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">sata_cmd</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">);</span>
	<span class="n">sata_cmd</span><span class="p">.</span><span class="n">ncqtag_atap_dir_m</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">ncg_tag</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">((</span><span class="n">ATAP</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">dir</span><span class="p">);</span>
	<span class="n">sata_cmd</span><span class="p">.</span><span class="n">sata_fis</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">fis</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">device_control_reg_update</span><span class="p">))</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">sata_fis</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span><span class="cm">/* C=1: update ATA cmd reg */</span>
	<span class="n">sata_cmd</span><span class="p">.</span><span class="n">sata_fis</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="mh">0xF0</span><span class="p">;</span><span class="cm">/* PM_PORT field shall be 0 */</span>
	<span class="cm">/* fill in PRD (scatter/gather) table, if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm8001_chip_make_sg</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">buf_prd</span><span class="p">);</span>
		<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_dma_handle</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_ccb_info</span><span class="p">,</span> <span class="n">buf_prd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">addr_low</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">addr_high</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">esgl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">);</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">addr_low</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">addr_high</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">);</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">esgl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">addr_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">addr_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">);</span>
		<span class="n">sata_cmd</span><span class="p">.</span><span class="n">esgl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sata_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_phy_start_req - start phy via PHY_START COMMAND</span>
<span class="cm"> * @pm8001_ha: our hba card information.</span>
<span class="cm"> * @num: the inbound queue number</span>
<span class="cm"> * @phy_id: the phy id which we wanted to start up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pm8001_chip_phy_start_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">phy_start_req</span> <span class="n">payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">OPC_INB_PHYSTART</span><span class="p">;</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 ** [0:7]   PHY Identifier</span>
<span class="cm">	 ** [8:11]  link rate 1.5G, 3G, 6G</span>
<span class="cm">	 ** [12:13] link mode 01b SAS mode; 10b SATA mode; 11b both</span>
<span class="cm">	 ** [14]    0b disable spin up hold; 1b enable spin up hold</span>
<span class="cm">	 */</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">ase_sh_lm_slr_phyid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SPINHOLD_DISABLE</span> <span class="o">|</span>
		<span class="n">LINKMODE_AUTO</span> <span class="o">|</span>	<span class="n">LINKRATE_15</span> <span class="o">|</span>
		<span class="n">LINKRATE_30</span> <span class="o">|</span> <span class="n">LINKRATE_60</span> <span class="o">|</span> <span class="n">phy_id</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">sas_identify</span><span class="p">.</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">SAS_END_DEV</span><span class="p">;</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">sas_identify</span><span class="p">.</span><span class="n">initiator_bits</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_ALL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">sas_identify</span><span class="p">.</span><span class="n">sas_addr</span><span class="p">,</span>
		<span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span> <span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">sas_identify</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_phy_stop_req - start phy via PHY_STOP COMMAND</span>
<span class="cm"> * @pm8001_ha: our hba card information.</span>
<span class="cm"> * @num: the inbound queue number</span>
<span class="cm"> * @phy_id: the phy id which we wanted to start up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_phy_stop_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">phy_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">phy_stop_req</span> <span class="n">payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">OPC_INB_PHYSTOP</span><span class="p">;</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">phy_id</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * see comments on mpi_reg_resp.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_reg_dev_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reg_dev_req</span> <span class="n">payload</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">opc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stp_sspsmp_sata</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">linkrate</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retryFlag</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">firstBurstSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ITNT</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">parent_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8001_tag_alloc</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">stp_sspsmp_sata</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/*direct attached sata */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">SATA_DEV</span><span class="p">)</span>
			<span class="n">stp_sspsmp_sata</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* stp*/</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">SAS_END_DEV</span> <span class="o">||</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">EDGE_DEV</span> <span class="o">||</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">FANOUT_DEV</span><span class="p">)</span>
			<span class="n">stp_sspsmp_sata</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/*ssp or smp*/</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent_dev</span> <span class="o">&amp;&amp;</span> <span class="n">DEV_IS_EXPANDER</span><span class="p">(</span><span class="n">parent_dev</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">))</span>
		<span class="n">phy_id</span> <span class="o">=</span> <span class="n">parent_dev</span><span class="o">-&gt;</span><span class="n">ex_dev</span><span class="p">.</span><span class="n">ex_phy</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">phy_id</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">attached_phy</span><span class="p">;</span>
	<span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_REG_DEV</span><span class="p">;</span>
	<span class="n">linkrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">linkrate</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">linkrate</span><span class="p">;</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">phyid_portid</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">dtype_dlr_retry</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">retryFlag</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">linkrate</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x1000000</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">stp_sspsmp_sata</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x10000000</span><span class="p">));</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">firstburstsize_ITNexustimeout</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ITNT</span> <span class="o">|</span> <span class="p">(</span><span class="n">firstBurstSize</span> <span class="o">*</span> <span class="mh">0x10000</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">sas_addr</span><span class="p">,</span> <span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_addr</span><span class="p">,</span>
		<span class="n">SAS_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * see comments on mpi_reg_resp.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_dereg_dev_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">device_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dereg_dev_req</span> <span class="n">payload</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_DEREG_DEV_HANDLE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>

	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">PM8001_MSG_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
		<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;unregister device device_id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device_id</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_phy_ctl_req - support the local phy operation</span>
<span class="cm"> * @pm8001_ha: our hba card information.</span>
<span class="cm"> * @num: the inbound queue number</span>
<span class="cm"> * @phy_id: the phy id which we wanted to operate</span>
<span class="cm"> * @phy_op:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_phy_ctl_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">phyId</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">local_phy_ctl_req</span> <span class="n">payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_LOCAL_PHY_CONTROL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">phyop_phyid</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">phy_op</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phyId</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pm8001_chip_is_our_interupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
<span class="cp">#ifdef PM8001_USE_MSIX</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">pm8001_cr32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSGU_ODR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_isr - PM8001 isr handler.</span>
<span class="cm"> * @pm8001_ha: our hba card information.</span>
<span class="cm"> * @irq: irq number.</span>
<span class="cm"> * @stat: stat.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">pm8001_chip_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm8001_chip_interrupt_disable</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="n">process_oq</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="n">pm8001_chip_interrupt_enable</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_task_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">opc</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">task_tag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_abort_req</span> <span class="n">task_abort</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_abort</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">task_abort</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ABORT_SINGLE</span> <span class="o">==</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">ABORT_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">task_abort</span><span class="p">.</span><span class="n">abort_all</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">task_abort</span><span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev_id</span><span class="p">);</span>
		<span class="n">task_abort</span><span class="p">.</span><span class="n">tag_to_abort</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">task_tag</span><span class="p">);</span>
		<span class="n">task_abort</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_tag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ABORT_ALL</span> <span class="o">==</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">ABORT_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">task_abort</span><span class="p">.</span><span class="n">abort_all</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">task_abort</span><span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dev_id</span><span class="p">);</span>
		<span class="n">task_abort</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_tag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task_abort</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_abort_task - SAS abort task when error or exception happened.</span>
<span class="cm"> * @task: the task we wanted to aborted.</span>
<span class="cm"> * @flag: the abort flag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_abort_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">task_tag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">opc</span><span class="p">,</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">TMF_RESP_FUNC_FAILED</span><span class="p">;</span>
	<span class="n">PM8001_EH_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;cmd_tag = %x, abort task tag&quot;</span>
		<span class="s">&quot; = %x&quot;</span><span class="p">,</span> <span class="n">cmd_tag</span><span class="p">,</span> <span class="n">task_tag</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">SAS_END_DEV</span><span class="p">)</span>
		<span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SSP_ABORT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">SATA_DEV</span><span class="p">)</span>
		<span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SATA_ABORT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SMP_ABORT</span><span class="p">;</span><span class="cm">/* SMP */</span>
	<span class="n">device_id</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">send_task_abort</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
		<span class="n">task_tag</span><span class="p">,</span> <span class="n">cmd_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">TMF_RESP_FUNC_COMPLETE</span><span class="p">)</span>
		<span class="n">PM8001_EH_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;rc= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_ssp_tm_req - built the task management command.</span>
<span class="cm"> * @pm8001_ha: our hba card information.</span>
<span class="cm"> * @ccb: the ccb information.</span>
<span class="cm"> * @tmf: task management function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_ssp_tm_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pm8001_tmf_task</span> <span class="o">*</span><span class="n">tmf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lldd_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SSPINITMSTART</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_ini_tm_start_req</span> <span class="n">sspTMCmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sspTMCmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sspTMCmd</span><span class="p">));</span>
	<span class="n">sspTMCmd</span><span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">sspTMCmd</span><span class="p">.</span><span class="n">relate_tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmf</span><span class="o">-&gt;</span><span class="n">tag_of_task_to_be_managed</span><span class="p">);</span>
	<span class="n">sspTMCmd</span><span class="p">.</span><span class="n">tmf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmf</span><span class="o">-&gt;</span><span class="n">tmf</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sspTMCmd</span><span class="p">.</span><span class="n">lun</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">LUN</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">sspTMCmd</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span><span class="p">);</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sspTMCmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_get_nvmd_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_GET_NVMD_DATA</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nvmd_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">get_nvm_data_req</span> <span class="n">nvmd_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_control_ex</span> <span class="o">*</span><span class="n">fw_control_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ioctl_payload</span> <span class="o">*</span><span class="n">ioctl_payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>

	<span class="n">nvmd_type</span> <span class="o">=</span> <span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">minor_function</span><span class="p">;</span>
	<span class="n">fw_control_context</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_control_ex</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_control_context</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fw_control_context</span><span class="o">-&gt;</span><span class="n">usrAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">func_specific</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">fw_control_context</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvmd_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nvmd_req</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8001_tag_alloc</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fw_control_context</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">fw_control_context</span> <span class="o">=</span> <span class="n">fw_control_context</span><span class="p">;</span>
	<span class="n">nvmd_req</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nvmd_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TWI_DEVICE</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">twi_addr</span><span class="p">,</span> <span class="n">twi_page_size</span><span class="p">;</span>
		<span class="n">twi_addr</span> <span class="o">=</span> <span class="mh">0xa8</span><span class="p">;</span>
		<span class="n">twi_page_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">len_ir_vpdd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPMode</span> <span class="o">|</span> <span class="n">twi_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="n">twi_page_size</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">TWI_DEVICE</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_hi</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_lo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">C_SEEPROM</span>: <span class="p">{</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">len_ir_vpdd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPMode</span> <span class="o">|</span> <span class="n">C_SEEPROM</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_hi</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_lo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VPD_FLASH</span>: <span class="p">{</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">len_ir_vpdd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPMode</span> <span class="o">|</span> <span class="n">VPD_FLASH</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_hi</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_lo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">EXPAN_ROM</span>: <span class="p">{</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">len_ir_vpdd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPMode</span> <span class="o">|</span> <span class="n">EXPAN_ROM</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_hi</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_lo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvmd_req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm8001_chip_set_nvmd_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SET_NVMD_DATA</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nvmd_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">set_nvm_data_req</span> <span class="n">nvmd_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_control_ex</span> <span class="o">*</span><span class="n">fw_control_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ioctl_payload</span> <span class="o">*</span><span class="n">ioctl_payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>

	<span class="n">nvmd_type</span> <span class="o">=</span> <span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">minor_function</span><span class="p">;</span>
	<span class="n">fw_control_context</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_control_ex</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_control_context</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">virt_ptr</span><span class="p">,</span>
		<span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">func_specific</span><span class="p">,</span>
		<span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvmd_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nvmd_req</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8001_tag_alloc</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fw_control_context</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">fw_control_context</span> <span class="o">=</span> <span class="n">fw_control_context</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">nvmd_req</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nvmd_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TWI_DEVICE</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">twi_addr</span><span class="p">,</span> <span class="n">twi_page_size</span><span class="p">;</span>
		<span class="n">twi_addr</span> <span class="o">=</span> <span class="mh">0xa8</span><span class="p">;</span>
		<span class="n">twi_page_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xFEDCBA98</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">len_ir_vpdd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPMode</span> <span class="o">|</span> <span class="n">twi_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="n">twi_page_size</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">TWI_DEVICE</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_hi</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_lo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">C_SEEPROM</span>:
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">len_ir_vpdd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPMode</span> <span class="o">|</span> <span class="n">C_SEEPROM</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xFEDCBA98</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_hi</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_lo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VPD_FLASH</span>:
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">len_ir_vpdd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPMode</span> <span class="o">|</span> <span class="n">VPD_FLASH</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xFEDCBA98</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_hi</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_lo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EXPAN_ROM</span>:
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">len_ir_vpdd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IPMode</span> <span class="o">|</span> <span class="n">EXPAN_ROM</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xFEDCBA98</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_hi</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_hi</span><span class="p">);</span>
		<span class="n">nvmd_req</span><span class="p">.</span><span class="n">resp_addr_lo</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">memoryMap</span><span class="p">.</span><span class="n">region</span><span class="p">[</span><span class="n">NVMD</span><span class="p">].</span><span class="n">phys_addr_lo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nvmd_req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm8001_chip_fw_flash_update_build - support the firmware update operation</span>
<span class="cm"> * @pm8001_ha: our hba card information.</span>
<span class="cm"> * @fw_flash_updata_info: firmware flash update param</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pm8001_chip_fw_flash_update_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fw_flash_updata_info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_flash_Update_req</span> <span class="n">payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_flash_updata_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_FW_FLASH_UPDATE</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_flash_Update_req</span><span class="p">));</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">fw_flash_updata_info</span><span class="p">;</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">cur_image_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cur_image_len</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">cur_image_offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cur_image_offset</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">total_image_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">total_image_len</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">im_len</span><span class="p">.</span><span class="n">len</span> <span class="p">;</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">sgl_addr_lo</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">addr</span><span class="p">)));</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">sgl_addr_hi</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">addr</span><span class="p">)));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pm8001_chip_fw_flash_update_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_flash_updata_info</span> <span class="n">flash_update_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_control_info</span> <span class="o">*</span><span class="n">fw_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_control_ex</span> <span class="o">*</span><span class="n">fw_control_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_addr_hi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_addr_lo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ioctl_payload</span> <span class="o">*</span><span class="n">ioctl_payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>

	<span class="n">fw_control_context</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_control_ex</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_control_context</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fw_control</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_control_info</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioctl_payload</span><span class="o">-&gt;</span><span class="n">func_specific</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm8001_mem_alloc</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">phys_addr</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">phys_addr_hi</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">phys_addr_lo</span><span class="p">,</span>
			<span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PM8001_FAIL_DBG</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span>
					<span class="n">pm8001_printk</span><span class="p">(</span><span class="s">&quot;Mem alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">fw_control_context</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">flash_update_info</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">flash_update_info</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">im_len</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">flash_update_info</span><span class="p">.</span><span class="n">sgl</span><span class="p">.</span><span class="n">im_len</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flash_update_info</span><span class="p">.</span><span class="n">cur_image_offset</span> <span class="o">=</span> <span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">flash_update_info</span><span class="p">.</span><span class="n">cur_image_len</span> <span class="o">=</span> <span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">flash_update_info</span><span class="p">.</span><span class="n">total_image_len</span> <span class="o">=</span> <span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">fw_control_context</span><span class="o">-&gt;</span><span class="n">fw_control</span> <span class="o">=</span> <span class="n">fw_control</span><span class="p">;</span>
	<span class="n">fw_control_context</span><span class="o">-&gt;</span><span class="n">virtAddr</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">fw_control_context</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">fw_control</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8001_tag_alloc</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fw_control_context</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">fw_control_context</span> <span class="o">=</span> <span class="n">fw_control_context</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8001_chip_fw_flash_update_build</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash_update_info</span><span class="p">,</span>
		<span class="n">tag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pm8001_chip_set_dev_state_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pm8001_device</span> <span class="o">*</span><span class="n">pm8001_dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">set_dev_state_req</span> <span class="n">payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SET_DEVICE_STATE</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8001_tag_alloc</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">pm8001_dev</span><span class="p">;</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pm8001_dev</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">nds</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pm8001_chip_sas_re_initialization</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm8001_hba_info</span> <span class="o">*</span><span class="n">pm8001_ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_re_initialization_req</span> <span class="n">payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_queue_table</span> <span class="o">*</span><span class="n">circularQ</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm8001_ccb_info</span> <span class="o">*</span><span class="n">ccb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="n">OPC_INB_SAS_RE_INITIALIZE</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8001_tag_alloc</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ccb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">ccb_info</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">circularQ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8001_ha</span><span class="o">-&gt;</span><span class="n">inbnd_q_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">SSAHOLT</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xd</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">sata_hol_tmo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
	<span class="n">payload</span><span class="p">.</span><span class="n">open_reject_cmdretries_data_retries</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xff00ff</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpi_build_cmd</span><span class="p">(</span><span class="n">pm8001_ha</span><span class="p">,</span> <span class="n">circularQ</span><span class="p">,</span> <span class="n">opc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">pm8001_dispatch</span> <span class="n">pm8001_8001_dispatch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;pmc8001&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_init</span>		<span class="o">=</span> <span class="n">pm8001_chip_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_soft_rst</span>		<span class="o">=</span> <span class="n">pm8001_chip_soft_rst</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_rst</span>		<span class="o">=</span> <span class="n">pm8001_hw_chip_rst</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chip_iounmap</span>		<span class="o">=</span> <span class="n">pm8001_chip_iounmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">isr</span>			<span class="o">=</span> <span class="n">pm8001_chip_isr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_our_interupt</span>	<span class="o">=</span> <span class="n">pm8001_chip_is_our_interupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">isr_process_oq</span>		<span class="o">=</span> <span class="n">process_oq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_enable</span> 	<span class="o">=</span> <span class="n">pm8001_chip_interrupt_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_disable</span>	<span class="o">=</span> <span class="n">pm8001_chip_interrupt_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">make_prd</span>		<span class="o">=</span> <span class="n">pm8001_chip_make_sg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">smp_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_smp_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ssp_io_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_ssp_io_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sata_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_sata_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_start_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_phy_start_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_stop_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_phy_stop_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reg_dev_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_reg_dev_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dereg_dev_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_dereg_dev_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_ctl_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_phy_ctl_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">task_abort</span>		<span class="o">=</span> <span class="n">pm8001_chip_abort_task</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ssp_tm_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_ssp_tm_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_nvmd_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_get_nvmd_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_nvmd_req</span>		<span class="o">=</span> <span class="n">pm8001_chip_set_nvmd_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fw_flash_update_req</span>	<span class="o">=</span> <span class="n">pm8001_chip_fw_flash_update_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dev_state_req</span>	<span class="o">=</span> <span class="n">pm8001_chip_set_dev_state_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sas_re_init_req</span>	<span class="o">=</span> <span class="n">pm8001_chip_sas_re_initialization</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
