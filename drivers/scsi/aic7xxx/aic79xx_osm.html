<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › aic7xxx › aic79xx_osm.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>aic79xx_osm.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Adaptec AIC79xx device driver for Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000-2001 Adaptec Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions, and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce at minimum a disclaimer</span>
<span class="cm"> *    substantially similar to the &quot;NO WARRANTY&quot; disclaimer below</span>
<span class="cm"> *    (&quot;Disclaimer&quot;) and any redistribution must be conditioned upon</span>
<span class="cm"> *    including a substantially similar Disclaimer requirement for further</span>
<span class="cm"> *    binary redistribution.</span>
<span class="cm"> * 3. Neither the names of the above-listed copyright holders nor the names</span>
<span class="cm"> *    of any contributors may be used to endorse or promote products derived</span>
<span class="cm"> *    from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;) version 2 as published by the Free</span>
<span class="cm"> * Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * NO WARRANTY</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,</span>
<span class="cm"> * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
<span class="cm"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGES.</span>
<span class="cm"> *</span>
<span class="cm"> * $Id: //depot/aic7xxx/linux/drivers/scsi/aic7xxx/aic79xx_osm.h#166 $</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _AIC79XX_LINUX_H_</span>
<span class="cp">#define _AIC79XX_LINUX_H_</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_spi.h&gt;</span>

<span class="cm">/* Core SCSI definitions */</span>
<span class="cp">#define AIC_LIB_PREFIX ahd</span>

<span class="cm">/* Name space conflict with BSD queue macros */</span>
<span class="cp">#ifdef LIST_HEAD</span>
<span class="cp">#undef LIST_HEAD</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;cam.h&quot;</span>
<span class="cp">#include &quot;queue.h&quot;</span>
<span class="cp">#include &quot;scsi_message.h&quot;</span>
<span class="cp">#include &quot;scsi_iu.h&quot;</span>
<span class="cp">#include &quot;aiclib.h&quot;</span>

<span class="cm">/*********************************** Debugging ********************************/</span>
<span class="cp">#ifdef CONFIG_AIC79XX_DEBUG_ENABLE</span>
<span class="cp">#ifdef CONFIG_AIC79XX_DEBUG_MASK</span>
<span class="cp">#define AHD_DEBUG 1</span>
<span class="cp">#define AHD_DEBUG_OPTS CONFIG_AIC79XX_DEBUG_MASK</span>
<span class="cp">#else</span>
<span class="cm">/*</span>
<span class="cm"> * Compile in debugging code, but do not enable any printfs.</span>
<span class="cm"> */</span>
<span class="cp">#define AHD_DEBUG 1</span>
<span class="cp">#define AHD_DEBUG_OPTS 0</span>
<span class="cp">#endif</span>
<span class="cm">/* No debugging code. */</span>
<span class="cp">#endif</span>

<span class="cm">/********************************** Misc Macros *******************************/</span>
<span class="cp">#define	powerof2(x)	((((x)-1)&amp;(x))==0)</span>

<span class="cm">/************************* Forward Declarations *******************************/</span>
<span class="k">struct</span> <span class="n">ahd_softc</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">ahd_dev_softc_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span>      <span class="o">*</span><span class="n">ahd_io_ctx_t</span><span class="p">;</span>

<span class="cm">/******************************* Byte Order ***********************************/</span>
<span class="cp">#define ahd_htobe16(x)	cpu_to_be16(x)</span>
<span class="cp">#define ahd_htobe32(x)	cpu_to_be32(x)</span>
<span class="cp">#define ahd_htobe64(x)	cpu_to_be64(x)</span>
<span class="cp">#define ahd_htole16(x)	cpu_to_le16(x)</span>
<span class="cp">#define ahd_htole32(x)	cpu_to_le32(x)</span>
<span class="cp">#define ahd_htole64(x)	cpu_to_le64(x)</span>

<span class="cp">#define ahd_be16toh(x)	be16_to_cpu(x)</span>
<span class="cp">#define ahd_be32toh(x)	be32_to_cpu(x)</span>
<span class="cp">#define ahd_be64toh(x)	be64_to_cpu(x)</span>
<span class="cp">#define ahd_le16toh(x)	le16_to_cpu(x)</span>
<span class="cp">#define ahd_le32toh(x)	le32_to_cpu(x)</span>
<span class="cp">#define ahd_le64toh(x)	le64_to_cpu(x)</span>

<span class="cm">/************************* Configuration Data *********************************/</span>
<span class="k">extern</span> <span class="kt">uint32_t</span> <span class="n">aic79xx_allow_memio</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">aic79xx_driver_template</span><span class="p">;</span>

<span class="cm">/***************************** Bus Space/DMA **********************************/</span>

<span class="k">typedef</span> <span class="kt">uint32_t</span> <span class="n">bus_size_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">BUS_SPACE_MEMIO</span><span class="p">,</span>
	<span class="n">BUS_SPACE_PIO</span>
<span class="p">}</span> <span class="n">bus_space_tag_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
	<span class="n">u_long</span>		  <span class="n">ioport</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">uint8_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">maddr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">bus_space_handle_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">bus_dma_segment</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span>	<span class="n">ds_addr</span><span class="p">;</span>
	<span class="n">bus_size_t</span>	<span class="n">ds_len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">bus_dma_segment_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ahd_linux_dma_tag</span>
<span class="p">{</span>
	<span class="n">bus_size_t</span>	<span class="n">alignment</span><span class="p">;</span>
	<span class="n">bus_size_t</span>	<span class="n">boundary</span><span class="p">;</span>
	<span class="n">bus_size_t</span>	<span class="n">maxsize</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">ahd_linux_dma_tag</span><span class="o">*</span> <span class="n">bus_dma_tag_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="n">dma_addr_t</span> <span class="n">bus_dmamap_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="n">bus_dma_filter_t</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="n">dma_addr_t</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="n">bus_dmamap_callback_t</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">bus_dma_segment_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cp">#define BUS_DMA_WAITOK		0x0</span>
<span class="cp">#define BUS_DMA_NOWAIT		0x1</span>
<span class="cp">#define BUS_DMA_ALLOCNOW	0x2</span>
<span class="cp">#define BUS_DMA_LOAD_SEGS	0x4	</span><span class="cm">/*</span>
<span class="cm">					 * Argument is an S/G list not</span>
<span class="cm">					 * a single buffer.</span>
<span class="cm">					 */</span><span class="cp"></span>

<span class="cp">#define BUS_SPACE_MAXADDR	0xFFFFFFFF</span>
<span class="cp">#define BUS_SPACE_MAXADDR_32BIT	0xFFFFFFFF</span>
<span class="cp">#define BUS_SPACE_MAXSIZE_32BIT	0xFFFFFFFF</span>

<span class="kt">int</span>	<span class="n">ahd_dma_tag_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span> <span class="n">bus_dma_tag_t</span> <span class="cm">/*parent*/</span><span class="p">,</span>
			   <span class="n">bus_size_t</span> <span class="cm">/*alignment*/</span><span class="p">,</span> <span class="n">bus_size_t</span> <span class="cm">/*boundary*/</span><span class="p">,</span>
			   <span class="n">dma_addr_t</span> <span class="cm">/*lowaddr*/</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="cm">/*highaddr*/</span><span class="p">,</span>
			   <span class="n">bus_dma_filter_t</span><span class="err">*/</span><span class="o">*</span><span class="n">filter</span><span class="err">*/</span><span class="p">,</span> <span class="kt">void</span> <span class="err">*/</span><span class="o">*</span><span class="n">filterarg</span><span class="err">*/</span><span class="p">,</span>
			   <span class="n">bus_size_t</span> <span class="cm">/*maxsize*/</span><span class="p">,</span> <span class="kt">int</span> <span class="cm">/*nsegments*/</span><span class="p">,</span>
			   <span class="n">bus_size_t</span> <span class="cm">/*maxsegsz*/</span><span class="p">,</span> <span class="kt">int</span> <span class="cm">/*flags*/</span><span class="p">,</span>
			   <span class="n">bus_dma_tag_t</span> <span class="err">*/</span><span class="o">*</span><span class="n">dma_tagp</span><span class="err">*/</span><span class="p">);</span>

<span class="kt">void</span>	<span class="n">ahd_dma_tag_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span> <span class="n">bus_dma_tag_t</span> <span class="cm">/*tag*/</span><span class="p">);</span>

<span class="kt">int</span>	<span class="n">ahd_dmamem_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span> <span class="n">bus_dma_tag_t</span> <span class="cm">/*dmat*/</span><span class="p">,</span>
			 <span class="kt">void</span><span class="o">**</span> <span class="cm">/*vaddr*/</span><span class="p">,</span> <span class="kt">int</span> <span class="cm">/*flags*/</span><span class="p">,</span>
			 <span class="n">bus_dmamap_t</span><span class="o">*</span> <span class="cm">/*mapp*/</span><span class="p">);</span>

<span class="kt">void</span>	<span class="n">ahd_dmamem_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span> <span class="n">bus_dma_tag_t</span> <span class="cm">/*dmat*/</span><span class="p">,</span>
			<span class="kt">void</span><span class="o">*</span> <span class="cm">/*vaddr*/</span><span class="p">,</span> <span class="n">bus_dmamap_t</span> <span class="cm">/*map*/</span><span class="p">);</span>

<span class="kt">void</span>	<span class="n">ahd_dmamap_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span> <span class="n">bus_dma_tag_t</span> <span class="cm">/*tag*/</span><span class="p">,</span>
			   <span class="n">bus_dmamap_t</span> <span class="cm">/*map*/</span><span class="p">);</span>

<span class="kt">int</span>	<span class="n">ahd_dmamap_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span> <span class="n">bus_dma_tag_t</span> <span class="cm">/*dmat*/</span><span class="p">,</span>
			<span class="n">bus_dmamap_t</span> <span class="cm">/*map*/</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="cm">/*buf*/</span><span class="p">,</span>
			<span class="n">bus_size_t</span> <span class="cm">/*buflen*/</span><span class="p">,</span> <span class="n">bus_dmamap_callback_t</span> <span class="o">*</span><span class="p">,</span>
			<span class="kt">void</span> <span class="err">*/</span><span class="o">*</span><span class="n">callback_arg</span><span class="err">*/</span><span class="p">,</span> <span class="kt">int</span> <span class="cm">/*flags*/</span><span class="p">);</span>

<span class="kt">int</span>	<span class="n">ahd_dmamap_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span> <span class="n">bus_dma_tag_t</span><span class="p">,</span> <span class="n">bus_dmamap_t</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Operations performed by ahd_dmamap_sync().</span>
<span class="cm"> */</span>
<span class="cp">#define BUS_DMASYNC_PREREAD	0x01	</span><span class="cm">/* pre-read synchronization */</span><span class="cp"></span>
<span class="cp">#define BUS_DMASYNC_POSTREAD	0x02	</span><span class="cm">/* post-read synchronization */</span><span class="cp"></span>
<span class="cp">#define BUS_DMASYNC_PREWRITE	0x04	</span><span class="cm">/* pre-write synchronization */</span><span class="cp"></span>
<span class="cp">#define BUS_DMASYNC_POSTWRITE	0x08	</span><span class="cm">/* post-write synchronization */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * XXX</span>
<span class="cm"> * ahd_dmamap_sync is only used on buffers allocated with</span>
<span class="cm"> * the pci_alloc_consistent() API.  Although I&#39;m not sure how</span>
<span class="cm"> * this works on architectures with a write buffer, Linux does</span>
<span class="cm"> * not have an API to sync &quot;coherent&quot; memory.  Perhaps we need</span>
<span class="cm"> * to do an mb()?</span>
<span class="cm"> */</span>
<span class="cp">#define ahd_dmamap_sync(ahd, dma_tag, dmamap, offset, len, op)</span>

<span class="cm">/************************** Timer DataStructures ******************************/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">ahd_timer_t</span><span class="p">;</span>

<span class="cm">/********************************** Includes **********************************/</span>
<span class="cp">#ifdef CONFIG_AIC79XX_REG_PRETTY_PRINT</span>
<span class="cp">#define AIC_DEBUG_REGISTERS 1</span>
<span class="cp">#else</span>
<span class="cp">#define AIC_DEBUG_REGISTERS 0</span>
<span class="cp">#endif</span>
<span class="cp">#include &quot;aic79xx.h&quot;</span>

<span class="cm">/***************************** Timer Facilities *******************************/</span>
<span class="cp">#define ahd_timer_init init_timer</span>
<span class="cp">#define ahd_timer_stop del_timer_sync</span>

<span class="cm">/***************************** SMP support ************************************/</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#define AIC79XX_DRIVER_VERSION &quot;3.0&quot;</span>

<span class="cm">/*************************** Device Data Structures ***************************/</span>
<span class="cm">/*</span>
<span class="cm"> * A per probed device structure used to deal with some error recovery</span>
<span class="cm"> * scenarios that the Linux mid-layer code just doesn&#39;t know how to</span>
<span class="cm"> * handle.  The structure allocated for a device only becomes persistent</span>
<span class="cm"> * after a successfully completed inquiry command to the target when</span>
<span class="cm"> * that inquiry data indicates a lun is present.</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">AHD_DEV_FREEZE_TIL_EMPTY</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span> <span class="cm">/* Freeze queue until active == 0 */</span>
	<span class="n">AHD_DEV_Q_BASIC</span>		 <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="cm">/* Allow basic device queuing */</span>
	<span class="n">AHD_DEV_Q_TAGGED</span>	 <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span> <span class="cm">/* Allow full SCSI2 command queueing */</span>
	<span class="n">AHD_DEV_PERIODIC_OTAG</span>	 <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="cm">/* Send OTAG to prevent starvation */</span>
<span class="p">}</span> <span class="n">ahd_linux_dev_flags</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ahd_linux_device</span> <span class="p">{</span>
	<span class="n">TAILQ_ENTRY</span><span class="p">(</span><span class="n">ahd_linux_device</span><span class="p">)</span> <span class="n">links</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The number of transactions currently</span>
<span class="cm">	 * queued to the device.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span>			<span class="n">active</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The currently allowed number of </span>
<span class="cm">	 * transactions that can be queued to</span>
<span class="cm">	 * the device.  Must be signed for</span>
<span class="cm">	 * conversion from tagged to untagged</span>
<span class="cm">	 * mode where the device may have more</span>
<span class="cm">	 * than one outstanding active transaction.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span>			<span class="n">openings</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A positive count indicates that this</span>
<span class="cm">	 * device&#39;s queue is halted.</span>
<span class="cm">	 */</span>
	<span class="n">u_int</span>			<span class="n">qfrozen</span><span class="p">;</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Cumulative command counter.</span>
<span class="cm">	 */</span>
	<span class="n">u_long</span>			<span class="n">commands_issued</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The number of tagged transactions when</span>
<span class="cm">	 * running at our current opening level</span>
<span class="cm">	 * that have been successfully received by</span>
<span class="cm">	 * this device since the last QUEUE FULL.</span>
<span class="cm">	 */</span>
	<span class="n">u_int</span>			<span class="n">tag_success_count</span><span class="p">;</span>
<span class="cp">#define AHD_TAG_SUCCESS_INTERVAL 50</span>

	<span class="n">ahd_linux_dev_flags</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Per device timer.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The high limit for the tags variable.</span>
<span class="cm">	 */</span>
	<span class="n">u_int</span>			<span class="n">maxtags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The computed number of tags outstanding</span>
<span class="cm">	 * at the time of the last QUEUE FULL event.</span>
<span class="cm">	 */</span>
	<span class="n">u_int</span>			<span class="n">tags_on_last_queuefull</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * How many times we have seen a queue full</span>
<span class="cm">	 * with the same number of tags.  This is used</span>
<span class="cm">	 * to stop our adaptive queue depth algorithm</span>
<span class="cm">	 * on devices with a fixed number of tags.</span>
<span class="cm">	 */</span>
	<span class="n">u_int</span>			<span class="n">last_queuefull_same_count</span><span class="p">;</span>
<span class="cp">#define AHD_LOCK_TAGS_COUNT 50</span>

	<span class="cm">/*</span>
<span class="cm">	 * How many transactions have been queued</span>
<span class="cm">	 * without the device going idle.  We use</span>
<span class="cm">	 * this statistic to determine when to issue</span>
<span class="cm">	 * an ordered tag to prevent transaction</span>
<span class="cm">	 * starvation.  This statistic is only updated</span>
<span class="cm">	 * if the AHD_DEV_PERIODIC_OTAG flag is set</span>
<span class="cm">	 * on this device.</span>
<span class="cm">	 */</span>
	<span class="n">u_int</span>			<span class="n">commands_since_idle_or_otag</span><span class="p">;</span>
<span class="cp">#define AHD_OTAG_THRESH	500</span>
<span class="p">};</span>

<span class="cm">/********************* Definitions Required by the Core ***********************/</span>
<span class="cm">/*</span>
<span class="cm"> * Number of SG segments we require.  So long as the S/G segments for</span>
<span class="cm"> * a particular transaction are allocated in a physically contiguous</span>
<span class="cm"> * manner and are allocated below 4GB, the number of S/G segments is</span>
<span class="cm"> * unrestricted.</span>
<span class="cm"> */</span>
<span class="cp">#define	AHD_NSEG 128</span>

<span class="cm">/*</span>
<span class="cm"> * Per-SCB OSM storage.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">scb_platform_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahd_linux_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">buf_busaddr</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		 <span class="n">xfer_len</span><span class="p">;</span>
	<span class="kt">uint32_t</span>		 <span class="n">sense_resid</span><span class="p">;</span>	<span class="cm">/* Auto-Sense residual */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Define a structure used for each host adapter.  All members are</span>
<span class="cm"> * aligned on a boundary &gt;= the size of the member to honor the</span>
<span class="cm"> * alignment restrictions of the various platforms supported by</span>
<span class="cm"> * this driver.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ahd_platform_data</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Fields accessed from interrupt context.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">[</span><span class="n">AHD_NUM_TARGETS</span><span class="p">];</span> 

	<span class="n">spinlock_t</span>		 <span class="n">spin_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="o">*</span><span class="n">eh_done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>        <span class="o">*</span><span class="n">host</span><span class="p">;</span>		<span class="cm">/* pointer to scsi host */</span>
<span class="cp">#define AHD_LINUX_NOIRQ	((uint32_t)~0)</span>
	<span class="kt">uint32_t</span>		 <span class="n">irq</span><span class="p">;</span>		<span class="cm">/* IRQ for this adapter */</span>
	<span class="kt">uint32_t</span>		 <span class="n">bios_address</span><span class="p">;</span>
	<span class="n">resource_size_t</span>		 <span class="n">mem_busaddr</span><span class="p">;</span>	<span class="cm">/* Mem Base Addr */</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">ahd_delay</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>

<span class="cm">/***************************** Low Level I/O **********************************/</span>
<span class="kt">uint8_t</span> <span class="n">ahd_inb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span> <span class="n">ahd</span><span class="p">,</span> <span class="kt">long</span> <span class="n">port</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ahd_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span> <span class="n">ahd</span><span class="p">,</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ahd_outw_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span> <span class="n">ahd</span><span class="p">,</span>
				     <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">val</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ahd_outsb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span> <span class="n">ahd</span><span class="p">,</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span>
			       <span class="kt">uint8_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ahd_insb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span> <span class="n">ahd</span><span class="p">,</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span>
			       <span class="kt">uint8_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="cm">/**************************** Initialization **********************************/</span>
<span class="kt">int</span>		<span class="n">ahd_linux_register_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*************************** Pretty Printing **********************************/</span>
<span class="k">struct</span> <span class="n">info_str</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">off_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/******************************** Locking *************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ahd_lockinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahd</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">spin_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ahd_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahd</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">spin_lock</span><span class="p">,</span> <span class="o">*</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ahd_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahd</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">spin_lock</span><span class="p">,</span> <span class="o">*</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************* PCI Definitions ******************************/</span>
<span class="cm">/*</span>
<span class="cm"> * PCIM_xxx: mask to locate subfield in register</span>
<span class="cm"> * PCIR_xxx: config register offset</span>
<span class="cm"> * PCIC_xxx: device class</span>
<span class="cm"> * PCIS_xxx: device subclass</span>
<span class="cm"> * PCIP_xxx: device programming interface</span>
<span class="cm"> * PCIV_xxx: PCI vendor ID (only required to fixup ancient devices)</span>
<span class="cm"> * PCID_xxx: device ID</span>
<span class="cm"> */</span>
<span class="cp">#define PCIR_DEVVENDOR		0x00</span>
<span class="cp">#define PCIR_VENDOR		0x00</span>
<span class="cp">#define PCIR_DEVICE		0x02</span>
<span class="cp">#define PCIR_COMMAND		0x04</span>
<span class="cp">#define PCIM_CMD_PORTEN		0x0001</span>
<span class="cp">#define PCIM_CMD_MEMEN		0x0002</span>
<span class="cp">#define PCIM_CMD_BUSMASTEREN	0x0004</span>
<span class="cp">#define PCIM_CMD_MWRICEN	0x0010</span>
<span class="cp">#define PCIM_CMD_PERRESPEN	0x0040</span>
<span class="cp">#define	PCIM_CMD_SERRESPEN	0x0100</span>
<span class="cp">#define PCIR_STATUS		0x06</span>
<span class="cp">#define PCIR_REVID		0x08</span>
<span class="cp">#define PCIR_PROGIF		0x09</span>
<span class="cp">#define PCIR_SUBCLASS		0x0a</span>
<span class="cp">#define PCIR_CLASS		0x0b</span>
<span class="cp">#define PCIR_CACHELNSZ		0x0c</span>
<span class="cp">#define PCIR_LATTIMER		0x0d</span>
<span class="cp">#define PCIR_HEADERTYPE		0x0e</span>
<span class="cp">#define PCIM_MFDEV		0x80</span>
<span class="cp">#define PCIR_BIST		0x0f</span>
<span class="cp">#define PCIR_CAP_PTR		0x34</span>

<span class="cm">/* config registers for header type 0 devices */</span>
<span class="cp">#define PCIR_MAPS	0x10</span>
<span class="cp">#define PCIR_SUBVEND_0	0x2c</span>
<span class="cp">#define PCIR_SUBDEV_0	0x2e</span>

<span class="cm">/****************************** PCI-X definitions *****************************/</span>
<span class="cp">#define PCIXR_COMMAND	0x96</span>
<span class="cp">#define PCIXR_DEVADDR	0x98</span>
<span class="cp">#define PCIXM_DEVADDR_FNUM	0x0003	</span><span class="cm">/* Function Number */</span><span class="cp"></span>
<span class="cp">#define PCIXM_DEVADDR_DNUM	0x00F8	</span><span class="cm">/* Device Number */</span><span class="cp"></span>
<span class="cp">#define PCIXM_DEVADDR_BNUM	0xFF00	</span><span class="cm">/* Bus Number */</span><span class="cp"></span>
<span class="cp">#define PCIXR_STATUS	0x9A</span>
<span class="cp">#define PCIXM_STATUS_64BIT	0x0001	</span><span class="cm">/* Active 64bit connection to device. */</span><span class="cp"></span>
<span class="cp">#define PCIXM_STATUS_133CAP	0x0002	</span><span class="cm">/* Device is 133MHz capable */</span><span class="cp"></span>
<span class="cp">#define PCIXM_STATUS_SCDISC	0x0004	</span><span class="cm">/* Split Completion Discarded */</span><span class="cp"></span>
<span class="cp">#define PCIXM_STATUS_UNEXPSC	0x0008	</span><span class="cm">/* Unexpected Split Completion */</span><span class="cp"></span>
<span class="cp">#define PCIXM_STATUS_CMPLEXDEV	0x0010	</span><span class="cm">/* Device Complexity (set == bridge) */</span><span class="cp"></span>
<span class="cp">#define PCIXM_STATUS_MAXMRDBC	0x0060	</span><span class="cm">/* Maximum Burst Read Count */</span><span class="cp"></span>
<span class="cp">#define PCIXM_STATUS_MAXSPLITS	0x0380	</span><span class="cm">/* Maximum Split Transactions */</span><span class="cp"></span>
<span class="cp">#define PCIXM_STATUS_MAXCRDS	0x1C00	</span><span class="cm">/* Maximum Cumulative Read Size */</span><span class="cp"></span>
<span class="cp">#define PCIXM_STATUS_RCVDSCEM	0x2000	</span><span class="cm">/* Received a Split Comp w/Error msg */</span><span class="cp"></span>

<span class="k">typedef</span> <span class="k">enum</span>
<span class="p">{</span>
	<span class="n">AHD_POWER_STATE_D0</span><span class="p">,</span>
	<span class="n">AHD_POWER_STATE_D1</span><span class="p">,</span>
	<span class="n">AHD_POWER_STATE_D2</span><span class="p">,</span>
	<span class="n">AHD_POWER_STATE_D3</span>
<span class="p">}</span> <span class="n">ahd_power_state</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">ahd_power_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span>
			    <span class="n">ahd_power_state</span> <span class="n">new_state</span><span class="p">);</span>

<span class="cm">/******************************* PCI Routines *********************************/</span>
<span class="kt">int</span>			 <span class="n">ahd_linux_pci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span>			 <span class="n">ahd_linux_pci_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>			 <span class="n">ahd_pci_map_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">);</span>
<span class="kt">int</span>			 <span class="n">ahd_pci_map_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">);</span>

<span class="kt">uint32_t</span>		 <span class="n">ahd_pci_read_config</span><span class="p">(</span><span class="n">ahd_dev_softc_t</span> <span class="n">pci</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">);</span>
<span class="kt">void</span>			 <span class="n">ahd_pci_write_config</span><span class="p">(</span><span class="n">ahd_dev_softc_t</span> <span class="n">pci</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">value</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">width</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">ahd_get_pci_function</span><span class="p">(</span><span class="n">ahd_dev_softc_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ahd_get_pci_function</span><span class="p">(</span><span class="n">ahd_dev_softc_t</span> <span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">ahd_get_pci_slot</span><span class="p">(</span><span class="n">ahd_dev_softc_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ahd_get_pci_slot</span><span class="p">(</span><span class="n">ahd_dev_softc_t</span> <span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">ahd_get_pci_bus</span><span class="p">(</span><span class="n">ahd_dev_softc_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ahd_get_pci_bus</span><span class="p">(</span><span class="n">ahd_dev_softc_t</span> <span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_flush_device_writes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ahd_flush_device_writes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX Is this sufficient for all architectures??? */</span>
	<span class="n">ahd_inb</span><span class="p">(</span><span class="n">ahd</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************** Proc FS Support *********************************/</span>
<span class="kt">int</span>	<span class="n">ahd_linux_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">,</span>
			    <span class="kt">off_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cm">/*********************** Transaction Access Wrappers **************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_cmd_set_transaction_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_set_transaction_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_cmd_set_scsi_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_set_scsi_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="n">ahd_cmd_get_transaction_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="n">ahd_get_transaction_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="n">ahd_cmd_get_scsi_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="n">ahd_get_scsi_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_set_transaction_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">u_int</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_long</span> <span class="n">ahd_get_transfer_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">ahd_get_transfer_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_set_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">,</span> <span class="n">u_long</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_set_sense_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">resid</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_long</span> <span class="n">ahd_get_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_long</span> <span class="n">ahd_get_sense_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">ahd_perform_autosense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="n">ahd_get_sense_bufsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_notify_xfer_settings_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">ahd_devinfo</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_platform_scb_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">ahd_freeze_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">ahd_cmd_set_transaction_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CAM_STATUS_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">status</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">ahd_set_transaction_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahd_cmd_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">ahd_cmd_set_scsi_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">ahd_set_scsi_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahd_cmd_set_scsi_status</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">uint32_t</span> <span class="nf">ahd_cmd_get_transaction_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CAM_STATUS_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">uint32_t</span> <span class="nf">ahd_get_transaction_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ahd_cmd_get_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">uint32_t</span> <span class="nf">ahd_cmd_get_scsi_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">uint32_t</span> <span class="nf">ahd_get_scsi_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ahd_cmd_get_scsi_status</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">ahd_set_transaction_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Nothing to do for linux as the incoming transaction</span>
<span class="cm">	 * has no concept of tag/non tagged, etc.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="n">u_long</span> <span class="nf">ahd_get_transfer_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xfer_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">int</span> <span class="nf">ahd_get_transfer_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">ahd_set_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">resid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">ahd_set_sense_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">resid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">sense_resid</span> <span class="o">=</span> <span class="n">resid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="n">u_long</span> <span class="nf">ahd_get_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="n">u_long</span> <span class="nf">ahd_get_sense_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">sense_resid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">int</span> <span class="nf">ahd_perform_autosense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We always perform autosense in Linux.</span>
<span class="cm">	 * On other platforms this is set on a</span>
<span class="cm">	 * per-transaction basis.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span>
<span class="nf">ahd_get_sense_bufsize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_sense_data</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ahd_notify_xfer_settings_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ahd_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do here for linux */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ahd_platform_scb_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHD_RESOURCE_SHORTAGE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>	<span class="n">ahd_platform_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">platform_arg</span><span class="p">);</span>
<span class="kt">void</span>	<span class="n">ahd_platform_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">);</span>
<span class="kt">void</span>	<span class="n">ahd_platform_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">);</span>
<span class="kt">void</span>	<span class="n">ahd_platform_freeze_devq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ahd_freeze_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CAM_DEV_QFRZN</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">CAM_DEV_QFRZN</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
                <span class="n">scb</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qfrozen</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>	<span class="n">ahd_platform_set_tags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ahd_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">ahd_queue_alg</span><span class="p">);</span>
<span class="kt">int</span>	<span class="n">ahd_platform_abort_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="n">ahd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span>
				<span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tag</span><span class="p">,</span>
				<span class="n">role_t</span> <span class="n">role</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">);</span>
<span class="n">irqreturn_t</span>
	<span class="n">ahd_linux_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="kt">void</span>	<span class="n">ahd_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span><span class="o">*</span><span class="p">);</span>
<span class="kt">void</span>	<span class="n">ahd_send_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span>
		       <span class="n">u_int</span> <span class="n">target</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">ac_code</span><span class="p">);</span>
<span class="kt">void</span>	<span class="n">ahd_print_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahd_softc</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#define AHD_PCI_CONFIG 1</span>
<span class="cp">#else</span>
<span class="cp">#define AHD_PCI_CONFIG 0</span>
<span class="cp">#endif</span>
<span class="cp">#define bootverbose aic79xx_verbose</span>
<span class="k">extern</span> <span class="kt">uint32_t</span> <span class="n">aic79xx_verbose</span><span class="p">;</span>

<span class="cp">#endif </span><span class="cm">/* _AIC79XX_LINUX_H_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
