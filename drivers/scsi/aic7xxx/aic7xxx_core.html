<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › aic7xxx › aic7xxx_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>aic7xxx_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Core routines and tables shareable across OS platforms.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1994-2002 Justin T. Gibbs.</span>
<span class="cm"> * Copyright (c) 2000-2002 Adaptec Inc.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions, and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce at minimum a disclaimer</span>
<span class="cm"> *    substantially similar to the &quot;NO WARRANTY&quot; disclaimer below</span>
<span class="cm"> *    (&quot;Disclaimer&quot;) and any redistribution must be conditioned upon</span>
<span class="cm"> *    including a substantially similar Disclaimer requirement for further</span>
<span class="cm"> *    binary redistribution.</span>
<span class="cm"> * 3. Neither the names of the above-listed copyright holders nor the names</span>
<span class="cm"> *    of any contributors may be used to endorse or promote products derived</span>
<span class="cm"> *    from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;) version 2 as published by the Free</span>
<span class="cm"> * Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * NO WARRANTY</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,</span>
<span class="cm"> * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
<span class="cm"> * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGES.</span>
<span class="cm"> *</span>
<span class="cm"> * $Id: //depot/aic7xxx/aic7xxx/aic7xxx.c#155 $</span>
<span class="cm"> */</span>

<span class="cp">#ifdef __linux__</span>
<span class="cp">#include &quot;aic7xxx_osm.h&quot;</span>
<span class="cp">#include &quot;aic7xxx_inline.h&quot;</span>
<span class="cp">#include &quot;aicasm/aicasm_insformat.h&quot;</span>
<span class="cp">#else</span>
<span class="cp">#include &lt;dev/aic7xxx/aic7xxx_osm.h&gt;</span>
<span class="cp">#include &lt;dev/aic7xxx/aic7xxx_inline.h&gt;</span>
<span class="cp">#include &lt;dev/aic7xxx/aicasm/aicasm_insformat.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/***************************** Lookup Tables **********************************/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">ahc_chip_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;NONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7770&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7850&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7855&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7859&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7860&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7870&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7880&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7895&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7895C&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7890/91&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7896/97&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7892&quot;</span><span class="p">,</span>
	<span class="s">&quot;aic7899&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u_int</span> <span class="n">num_chip_names</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ahc_chip_names</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware error codes.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ahc_hard_error_entry</span> <span class="p">{</span>
        <span class="kt">uint8_t</span> <span class="n">errno</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errmesg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_hard_error_entry</span> <span class="n">ahc_hard_errors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">ILLHADDR</span><span class="p">,</span>	<span class="s">&quot;Illegal Host Access&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ILLSADDR</span><span class="p">,</span>	<span class="s">&quot;Illegal Sequencer Address referrenced&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ILLOPCODE</span><span class="p">,</span>	<span class="s">&quot;Illegal Opcode in sequencer program&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SQPARERR</span><span class="p">,</span>	<span class="s">&quot;Sequencer Parity Error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DPARERR</span><span class="p">,</span>	<span class="s">&quot;Data-path Parity Error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MPARERR</span><span class="p">,</span>	<span class="s">&quot;Scratch or SCB Memory Parity Error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCIERRSTAT</span><span class="p">,</span>	<span class="s">&quot;PCI Error detected&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CIOPARERR</span><span class="p">,</span>	<span class="s">&quot;CIOBUS Parity Error&quot;</span> <span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u_int</span> <span class="n">num_errors</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ahc_hard_errors</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_phase_table_entry</span> <span class="n">ahc_phase_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">P_DATAOUT</span><span class="p">,</span>	<span class="n">MSG_NOOP</span><span class="p">,</span>		<span class="s">&quot;in Data-out phase&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">P_DATAIN</span><span class="p">,</span>	<span class="n">MSG_INITIATOR_DET_ERR</span><span class="p">,</span>	<span class="s">&quot;in Data-in phase&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">P_DATAOUT_DT</span><span class="p">,</span>	<span class="n">MSG_NOOP</span><span class="p">,</span>		<span class="s">&quot;in DT Data-out phase&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">P_DATAIN_DT</span><span class="p">,</span>	<span class="n">MSG_INITIATOR_DET_ERR</span><span class="p">,</span>	<span class="s">&quot;in DT Data-in phase&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">P_COMMAND</span><span class="p">,</span>	<span class="n">MSG_NOOP</span><span class="p">,</span>		<span class="s">&quot;in Command phase&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">P_MESGOUT</span><span class="p">,</span>	<span class="n">MSG_NOOP</span><span class="p">,</span>		<span class="s">&quot;in Message-out phase&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">P_STATUS</span><span class="p">,</span>	<span class="n">MSG_INITIATOR_DET_ERR</span><span class="p">,</span>	<span class="s">&quot;in Status phase&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">P_MESGIN</span><span class="p">,</span>	<span class="n">MSG_PARITY_ERROR</span><span class="p">,</span>	<span class="s">&quot;in Message-in phase&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">P_BUSFREE</span><span class="p">,</span>	<span class="n">MSG_NOOP</span><span class="p">,</span>		<span class="s">&quot;while idle&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>		<span class="n">MSG_NOOP</span><span class="p">,</span>		<span class="s">&quot;in unknown phase&quot;</span>	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * In most cases we only wish to itterate over real phases, so</span>
<span class="cm"> * exclude the last element from the count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u_int</span> <span class="n">num_phases</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ahc_phase_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Valid SCSIRATE values.  (p. 3-17)</span>
<span class="cm"> * Provides a mapping of tranfer periods in ns to the proper value to</span>
<span class="cm"> * stick in the scsixfer reg.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="n">ahc_syncrates</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
      <span class="cm">/* ultra2    fast/ultra  period     rate */</span>
	<span class="p">{</span> <span class="mh">0x42</span><span class="p">,</span>      <span class="mh">0x000</span><span class="p">,</span>      <span class="mi">9</span><span class="p">,</span>      <span class="s">&quot;80.0&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span>      <span class="mh">0x000</span><span class="p">,</span>     <span class="mi">10</span><span class="p">,</span>      <span class="s">&quot;40.0&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span>      <span class="mh">0x000</span><span class="p">,</span>     <span class="mi">11</span><span class="p">,</span>      <span class="s">&quot;33.0&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span>      <span class="mh">0x100</span><span class="p">,</span>     <span class="mi">12</span><span class="p">,</span>      <span class="s">&quot;20.0&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span>      <span class="mh">0x110</span><span class="p">,</span>     <span class="mi">15</span><span class="p">,</span>      <span class="s">&quot;16.0&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span>      <span class="mh">0x120</span><span class="p">,</span>     <span class="mi">18</span><span class="p">,</span>      <span class="s">&quot;13.4&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span>      <span class="mh">0x000</span><span class="p">,</span>     <span class="mi">25</span><span class="p">,</span>      <span class="s">&quot;10.0&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span>      <span class="mh">0x010</span><span class="p">,</span>     <span class="mi">31</span><span class="p">,</span>      <span class="s">&quot;8.0&quot;</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span>      <span class="mh">0x020</span><span class="p">,</span>     <span class="mi">37</span><span class="p">,</span>      <span class="s">&quot;6.67&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1b</span><span class="p">,</span>      <span class="mh">0x030</span><span class="p">,</span>     <span class="mi">43</span><span class="p">,</span>      <span class="s">&quot;5.7&quot;</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span>      <span class="mh">0x040</span><span class="p">,</span>     <span class="mi">50</span><span class="p">,</span>      <span class="s">&quot;5.0&quot;</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span>      <span class="mh">0x050</span><span class="p">,</span>     <span class="mi">56</span><span class="p">,</span>      <span class="s">&quot;4.4&quot;</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span>      <span class="mh">0x060</span><span class="p">,</span>     <span class="mi">62</span><span class="p">,</span>      <span class="s">&quot;4.0&quot;</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span>      <span class="mh">0x070</span><span class="p">,</span>     <span class="mi">68</span><span class="p">,</span>      <span class="s">&quot;3.6&quot;</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span>      <span class="mh">0x000</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span>      <span class="nb">NULL</span>   <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Our Sequencer Program */</span>
<span class="cp">#include &quot;aic7xxx_seq.h&quot;</span>

<span class="cm">/**************************** Function Declarations ***************************/</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_force_renegotiation</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ahc_tmode_tstate</span><span class="o">*</span>
			<span class="n">ahc_alloc_tstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					 <span class="n">u_int</span> <span class="n">scsi_id</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">);</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_free_tstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					<span class="n">u_int</span> <span class="n">scsi_id</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span><span class="o">*</span>
			<span class="n">ahc_devlimited_syncrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					        <span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="p">,</span>
						<span class="n">u_int</span> <span class="o">*</span><span class="n">period</span><span class="p">,</span>
						<span class="n">u_int</span> <span class="o">*</span><span class="n">ppr_options</span><span class="p">,</span>
						<span class="n">role_t</span> <span class="n">role</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_update_pending_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_fetch_devinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_scb_devinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_assert_atn</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_setup_initiator_msgout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_build_transfer_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_construct_sdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
					   <span class="n">u_int</span> <span class="n">period</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_construct_wdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
					   <span class="n">u_int</span> <span class="n">bus_width</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_construct_ppr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
					  <span class="n">u_int</span> <span class="n">period</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">offset</span><span class="p">,</span>
					  <span class="n">u_int</span> <span class="n">bus_width</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">ppr_options</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_clear_msg_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_handle_proto_violation</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_handle_message_phase</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">AHCMSG_1B</span><span class="p">,</span>
	<span class="n">AHCMSG_2B</span><span class="p">,</span>
	<span class="n">AHCMSG_EXT</span>
<span class="p">}</span> <span class="n">ahc_msgtype</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">ahc_sent_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc_msgtype</span> <span class="n">type</span><span class="p">,</span>
				     <span class="n">u_int</span> <span class="n">msgval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">full</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">ahc_parse_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">ahc_handle_msg_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_handle_ign_wide_residue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_reinitialize_dataptrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_handle_devreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
					    <span class="n">cam_status</span> <span class="n">status</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">verbose_level</span><span class="p">);</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_setup_target_msgin</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">bus_dmamap_callback_t</span>	<span class="n">ahc_dmamap_cb</span><span class="p">;</span> 
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_build_free_scb_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">ahc_init_scbdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_fini_scbdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_qinfifo_requeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">prev_scb</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">ahc_qinfifo_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_int</span>		<span class="n">ahc_rem_scb_from_disc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
						   <span class="n">u_int</span> <span class="n">prev</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">scbptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_add_curscb_to_free_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_int</span>		<span class="n">ahc_rem_wscb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
				     <span class="n">u_int</span> <span class="n">scbpos</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">prev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_reset_current_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="cp">#ifdef AHC_DUMP_SEQ</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_dumpseq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">ahc_loadseq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">ahc_check_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">**</span><span class="n">start_patch</span><span class="p">,</span>
					<span class="n">u_int</span> <span class="n">start_instr</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="n">skip_addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_download_instr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					   <span class="n">u_int</span> <span class="n">instrptr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">dconsts</span><span class="p">);</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_queue_lstate_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ahc_tmode_lstate</span> <span class="o">*</span><span class="n">lstate</span><span class="p">,</span>
					       <span class="n">u_int</span> <span class="n">initiator_id</span><span class="p">,</span>
					       <span class="n">u_int</span> <span class="n">event_type</span><span class="p">,</span>
					       <span class="n">u_int</span> <span class="n">event_arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_update_scsiid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					  <span class="n">u_int</span> <span class="n">targid_mask</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">ahc_handle_target_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">target_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">u_int</span>		<span class="n">ahc_index_busy_tcl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tcl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_unbusy_tcl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tcl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_busy_tcl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
				     <span class="n">u_int</span> <span class="n">tcl</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">busyid</span><span class="p">);</span>

<span class="cm">/************************** SCB and SCB queue management **********************/</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_run_untagged_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_run_untagged_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">scb_tailq</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>

<span class="cm">/****************************** Initialization ********************************/</span>
<span class="k">static</span> <span class="kt">void</span>		 <span class="n">ahc_alloc_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		 <span class="n">ahc_shutdown</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="cm">/*************************** Interrupt Services *******************************/</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_clear_intstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_run_qoutfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_run_tqinfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">paused</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_handle_brkadrint</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_handle_seqint</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">intstat</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_handle_scsiint</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					   <span class="n">u_int</span> <span class="n">intstat</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_clear_critical_section</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>

<span class="cm">/***************************** Error Recovery *********************************/</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_freeze_devq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>		<span class="n">ahc_abort_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span>
				       <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tag</span><span class="p">,</span>
				       <span class="n">role_t</span> <span class="n">role</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>		<span class="n">ahc_calc_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">);</span>

<span class="cm">/*********************** Untagged Transaction Routines ************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>	<span class="n">ahc_freeze_untagged_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>	<span class="n">ahc_release_untagged_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Block our completion routine from starting the next untagged</span>
<span class="cm"> * transaction for this target or target lun.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ahc_freeze_untagged_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SCB_BTT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">untagged_queue_lock</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allow the next untagged transaction for this target or target lun</span>
<span class="cm"> * to be executed.  We use a counting semaphore to allow the lock</span>
<span class="cm"> * to be acquired recursively.  Once the count drops to zero, the</span>
<span class="cm"> * transaction queues will be run.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ahc_release_untagged_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SCB_BTT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">untagged_queue_lock</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">untagged_queue_lock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc_run_untagged_queues</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************* Sequencer Execution Control ************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Work around any chip bugs related to halting sequencer execution.</span>
<span class="cm"> * On Ultra2 controllers, we must clear the CIOBUS stretch signal by</span>
<span class="cm"> * reading a register that will set this signal and deassert it.</span>
<span class="cm"> * Without this workaround, if the chip is paused, by an interrupt or</span>
<span class="cm"> * manual pause while accessing scb ram, accesses to certain registers</span>
<span class="cm"> * will hang the system (infinite pci retries).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_pause_bug_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CCSCBCTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Determine whether the sequencer has halted code execution.</span>
<span class="cm"> * Returns non-zero status if the sequencer is stopped.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ahc_is_paused</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request that the sequencer stop and wait, indefinitely, for it</span>
<span class="cm"> * to stop.  The sequencer will only acknowledge that it is paused</span>
<span class="cm"> * once it has reached an instruction boundary and PAUSEDIS is</span>
<span class="cm"> * cleared in the SEQCTL register.  The sequencer may use PAUSEDIS</span>
<span class="cm"> * for critical sections.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ahc_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since the sequencer can disable pausing in a critical section, we</span>
<span class="cm">	 * must loop until it actually stops.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ahc_is_paused</span><span class="p">(</span><span class="n">ahc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="n">ahc_pause_bug_fix</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allow the sequencer to continue program execution.</span>
<span class="cm"> * We check here to ensure that no additional interrupt</span>
<span class="cm"> * sources that would cause the sequencer to halt have been</span>
<span class="cm"> * asserted.  If, for example, a SCSI bus reset is detected</span>
<span class="cm"> * while we are fielding a different, pausing, interrupt type,</span>
<span class="cm"> * we don&#39;t want to release the sequencer before going back</span>
<span class="cm"> * into our interrupt handler and dealing with this new</span>
<span class="cm"> * condition.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ahc_unpause</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSIINT</span> <span class="o">|</span> <span class="n">SEQINT</span> <span class="o">|</span> <span class="n">BRKADRINT</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unpause</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************** Memory mapping routines ***************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ahc_dma_seg</span> <span class="o">*</span>
<span class="nf">ahc_sg_bus_to_virt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sg_busaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sg_index</span><span class="p">;</span>

	<span class="n">sg_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">sg_busaddr</span> <span class="o">-</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list_phys</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_dma_seg</span><span class="p">);</span>
	<span class="cm">/* sg_list_phys points to entry 1, not 0 */</span>
	<span class="n">sg_index</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">sg_index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">ahc_sg_virt_to_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_dma_seg</span> <span class="o">*</span><span class="n">sg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sg_index</span><span class="p">;</span>

	<span class="cm">/* sg_list_phys points to entry 1, not 0 */</span>
	<span class="n">sg_index</span> <span class="o">=</span> <span class="n">sg</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list_phys</span> <span class="o">+</span> <span class="p">(</span><span class="n">sg_index</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">ahc_hscb_busaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_busaddr</span>
		<span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hardware_scb</span><span class="p">)</span> <span class="o">*</span> <span class="n">index</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_sync_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc_dmamap_sync</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmat</span><span class="p">,</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmamap</span><span class="p">,</span>
			<span class="cm">/*offset*/</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span> <span class="o">-</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">hscbs</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">),</span>
			<span class="cm">/*len*/</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">),</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_sync_sglist</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ahc_dmamap_sync</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_dmat</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_dmamap</span><span class="p">,</span>
			<span class="cm">/*offset*/</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span> <span class="o">-</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_vaddr</span><span class="p">)</span>
				<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_dma_seg</span><span class="p">),</span>
			<span class="cm">/*len*/</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_dma_seg</span><span class="p">)</span> <span class="o">*</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef AHC_TARGET_MODE</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">ahc_targetcmd_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">targetcmds</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">-</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*********************** Miscellaneous Support Functions ***********************/</span>
<span class="cm">/*</span>
<span class="cm"> * Determine whether the sequencer reported a residual</span>
<span class="cm"> * for this SCB/transaction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_update_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">sgptr</span><span class="p">;</span>

	<span class="n">sgptr</span> <span class="o">=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">sgptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sgptr</span> <span class="o">&amp;</span> <span class="n">SG_RESID_VALID</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_calc_residual</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return pointers to the transfer negotiation information</span>
<span class="cm"> * for the specified our_id/remote_id pair.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span>
<span class="nf">ahc_fetch_transinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">our_id</span><span class="p">,</span>
		    <span class="n">u_int</span> <span class="n">remote_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">**</span><span class="n">tstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Transfer data structures are stored from the perspective</span>
<span class="cm">	 * of the target role.  Since the parameters for a connection</span>
<span class="cm">	 * in the initiator role to a given target are the same as</span>
<span class="cm">	 * when the roles are reversed, we pretend we are the target.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
		<span class="n">our_id</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">our_id</span><span class="p">];</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">tstate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">transinfo</span><span class="p">[</span><span class="n">remote_id</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">uint16_t</span>
<span class="nf">ahc_inw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span> <span class="o">|</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_outw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span>
<span class="nf">ahc_inl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_outl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="p">((</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint64_t</span>
<span class="nf">ahc_inq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">5</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">6</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">7</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_outq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a free scb. If there are none, see if we can allocate a new SCB.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span>
<span class="nf">ahc_get_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span> <span class="o">=</span> <span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_alloc_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">SLIST_REMOVE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">,</span> <span class="n">links</span><span class="p">.</span><span class="n">sle</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">scb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return an SCB resource to the free list.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ahc_free_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hardware_scb</span> <span class="o">*</span><span class="n">hscb</span><span class="p">;</span>

	<span class="n">hscb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>
	<span class="cm">/* Clean up for the next user */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbindex</span><span class="p">[</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SCB_FREE</span><span class="p">;</span>
	<span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SLIST_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">links</span><span class="p">.</span><span class="n">sle</span><span class="p">);</span>

	<span class="cm">/* Notify the OSM that a resource is now available. */</span>
	<span class="n">ahc_platform_scb_free</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span>
<span class="nf">ahc_lookup_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb</span><span class="o">*</span> <span class="n">scb</span><span class="p">;</span>

	<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbindex</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ahc_sync_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span>
			     <span class="n">BUS_DMASYNC_POSTREAD</span><span class="o">|</span><span class="n">BUS_DMASYNC_POSTWRITE</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">scb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_swap_with_next_hscb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hardware_scb</span> <span class="o">*</span><span class="n">q_hscb</span><span class="p">;</span>
	<span class="n">u_int</span>  <span class="n">saved_tag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Our queuing method is a bit tricky.  The card</span>
<span class="cm">	 * knows in advance which HSCB to download, and we</span>
<span class="cm">	 * can&#39;t disappoint it.  To achieve this, the next</span>
<span class="cm">	 * SCB to download is saved off in ahc-&gt;next_queued_scb.</span>
<span class="cm">	 * When we are called to queue &quot;an arbitrary scb&quot;,</span>
<span class="cm">	 * we copy the contents of the incoming HSCB to the one</span>
<span class="cm">	 * the sequencer knows about, swap HSCB pointers and</span>
<span class="cm">	 * finally assign the SCB to the tag indexed location</span>
<span class="cm">	 * in the scb_array.  This makes sure that we can still</span>
<span class="cm">	 * locate the correct SCB by SCB_TAG.</span>
<span class="cm">	 */</span>
	<span class="n">q_hscb</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">next_queued_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>
	<span class="n">saved_tag</span> <span class="o">=</span> <span class="n">q_hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">q_hscb</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_CDB32_PTR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q_hscb</span><span class="o">-&gt;</span><span class="n">shared_data</span><span class="p">.</span><span class="n">cdb_ptr</span> <span class="o">=</span>
		    <span class="n">ahc_htole32</span><span class="p">(</span><span class="n">ahc_hscb_busaddr</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">q_hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span>
			      <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hardware_scb</span><span class="p">,</span> <span class="n">cdb32</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">q_hscb</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">saved_tag</span><span class="p">;</span>
	<span class="n">q_hscb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>

	<span class="cm">/* Now swap HSCB pointers. */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">next_queued_scb</span><span class="o">-&gt;</span><span class="n">hscb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span> <span class="o">=</span> <span class="n">q_hscb</span><span class="p">;</span>

	<span class="cm">/* Now define the mapping from tag to SCB in the scbindex */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbindex</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tell the sequencer about a new transaction to execute.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ahc_queue_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc_swap_with_next_hscb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span>
	 <span class="o">||</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Attempt to queue invalid SCB tag %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup data &quot;oddness&quot;.</span>
<span class="cm">	 */</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&amp;=</span> <span class="n">LID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_get_transfer_length</span><span class="p">(</span><span class="n">scb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">|=</span> <span class="n">SCB_XFERLEN_ODD</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Keep a history of SCBs we&#39;ve downloaded in the qinfifo.</span>
<span class="cm">	 */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure our data is consistent from the</span>
<span class="cm">	 * perspective of the adapter.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_sync_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">BUS_DMASYNC_PREREAD</span><span class="o">|</span><span class="n">BUS_DMASYNC_PREWRITE</span><span class="p">);</span>

	<span class="cm">/* Tell the adapter about the newly queued SCB */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_AUTOPAUSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">KERNEL_QINPOS</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_AUTOPAUSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">scsi_sense_data</span> <span class="o">*</span>
<span class="nf">ahc_get_sense_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">scb</span> <span class="o">-</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbarray</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">ahc_get_sense_bufaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">scb</span> <span class="o">-</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbarray</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_busaddr</span>
	      <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_sense_data</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/************************** Interrupt Processing ******************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_sync_qoutfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc_dmamap_sync</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">,</span>
			<span class="cm">/*offset*/</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/*len*/</span><span class="mi">256</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_sync_tqinfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_dmamap_sync</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">,</span>
				<span class="n">ahc_targetcmd_offset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">target_cmd</span><span class="p">)</span> <span class="o">*</span> <span class="n">AHC_TMODE_CMDS</span><span class="p">,</span>
				<span class="n">op</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * See if the firmware has posted any completed commands</span>
<span class="cm"> * into our in-core command complete fifos.</span>
<span class="cm"> */</span>
<span class="cp">#define AHC_RUN_QOUTFIFO 0x1</span>
<span class="cp">#define AHC_RUN_TQINFIFO 0x2</span>
<span class="k">static</span> <span class="n">u_int</span>
<span class="nf">ahc_check_cmdcmpltqueues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc_dmamap_sync</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">,</span>
			<span class="cm">/*offset*/</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="p">,</span> <span class="cm">/*len*/</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">BUS_DMASYNC_POSTREAD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">AHC_RUN_QOUTFIFO</span><span class="p">;</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TQINFIFO_BLOCKED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_dmamap_sync</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">,</span>
				<span class="n">ahc_targetcmd_offset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifofnext</span><span class="p">),</span>
				<span class="cm">/*len*/</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">target_cmd</span><span class="p">),</span>
				<span class="n">BUS_DMASYNC_POSTREAD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">targetcmds</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span><span class="p">].</span><span class="n">cmd_valid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">|=</span> <span class="n">AHC_RUN_TQINFIFO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Catch an interrupt from the adapter</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ahc_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span>	<span class="n">intstat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pause</span> <span class="o">&amp;</span> <span class="n">INTEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Our interrupt is not enabled on the chip</span>
<span class="cm">		 * and may be disabled for re-entrancy reasons,</span>
<span class="cm">		 * so just return.  This is likely just a shared</span>
<span class="cm">		 * interrupt.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Instead of directly reading the interrupt status register,</span>
<span class="cm">	 * infer the cause of the interrupt by checking our in-core</span>
<span class="cm">	 * completion queues.  This avoids a costly PCI bus read in</span>
<span class="cm">	 * most cases.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_ALL_INTERRUPTS</span><span class="o">|</span><span class="n">AHC_EDGE_INTERRUPT</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc_check_cmdcmpltqueues</span><span class="p">(</span><span class="n">ahc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">intstat</span> <span class="o">=</span> <span class="n">CMDCMPLT</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">intstat</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">INT_PEND</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if AHC_PCI_CONFIG &gt; 0</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unsolicited_ints</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unsolicited_ints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_PCI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCIERRSTAT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">bus_intr</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unsolicited_ints</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unsolicited_ints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">CMDCMPLT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRCMDINT</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Ensure that the chip sees that we&#39;ve cleared</span>
<span class="cm">		 * this interrupt before we walk the output fifo.</span>
<span class="cm">		 * Otherwise, we may, due to posted bus writes,</span>
<span class="cm">		 * clear the interrupt after we finish the scan,</span>
<span class="cm">		 * and after the sequencer has added new entries</span>
<span class="cm">		 * and asserted the interrupt again.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_flush_device_writes</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_run_qoutfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc_run_tqinfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="cm">/*paused*/</span><span class="n">FALSE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle statuses that may invalidate our cached</span>
<span class="cm">	 * copy of INTSTAT separately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">==</span> <span class="mh">0xFF</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_REMOVABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hot eject.  Do nothing */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">BRKADRINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_handle_brkadrint</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SEQINT</span><span class="o">|</span><span class="n">SCSIINT</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ahc_pause_bug_fix</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">SEQINT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc_handle_seqint</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">intstat</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">SCSIINT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc_handle_scsiint</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">intstat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************* Sequencer Execution Control ************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Restart the sequencer program from address zero</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span>	<span class="n">sblkctl</span><span class="p">;</span>

	<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="cm">/* No more pending messages. */</span>
	<span class="n">ahc_clear_msg_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* De-assert BSY */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">,</span> <span class="n">MSG_NOOP</span><span class="p">);</span>	<span class="cm">/* No message to send */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BITBUCKET</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">,</span> <span class="n">P_BUSFREE</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_SCSIID</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_LUN</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ensure that the sequencer&#39;s idea of TQINPOS</span>
<span class="cm">	 * matches our own.  The sequencer increments TQINPOS</span>
<span class="cm">	 * only after it sees a DMA complete and a reset could</span>
<span class="cm">	 * occur before the increment leaving the kernel to believe</span>
<span class="cm">	 * the command arrived but the sequencer to not.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TQINPOS</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span><span class="p">);</span>

	<span class="cm">/* Always allow reselection */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span>
		 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ_TEMPLATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSELI</span><span class="o">|</span><span class="n">ENRSELI</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_CMD_CHAN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ensure that no DMA operations are in progress */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CCSCBCNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CCSGCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CCSCBCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we were in the process of DMA&#39;ing SCB data into</span>
<span class="cm">	 * an SCB, replace that SCB on the free list.  This prevents</span>
<span class="cm">	 * an SCB leak.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCB_DMA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_add_curscb_to_free_list</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS2</span><span class="p">,</span>
			 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCB_DMA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear any pending sequencer interrupt.  It is no</span>
<span class="cm">	 * longer relevant since we&#39;re resetting the Program</span>
<span class="cm">	 * Counter.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSEQINT</span><span class="p">);</span>

	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MWI_RESIDUAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seqctl</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Take the LED out of diagnostic mode on PM resume, too</span>
<span class="cm">	 */</span>
	<span class="n">sblkctl</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="p">(</span><span class="n">sblkctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DIAGLEDEN</span><span class="o">|</span><span class="n">DIAGLEDON</span><span class="p">)));</span>

	<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************* Input/Output Queues ********************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_run_qoutfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="n">u_int</span>  <span class="n">scb_index</span><span class="p">;</span>

	<span class="n">ahc_sync_qoutfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUS_DMASYNC_POSTREAD</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_int</span> <span class="n">modnext</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Clear 32bits of QOUTFIFO at a time</span>
<span class="cm">			 * so that we don&#39;t clobber an incoming</span>
<span class="cm">			 * byte DMA to the array on architectures</span>
<span class="cm">			 * that only support 32bit load and store</span>
<span class="cm">			 * operations.</span>
<span class="cm">			 */</span>
			<span class="n">modnext</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">;</span>
			<span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">modnext</span><span class="p">]))</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">;</span>
			<span class="n">ahc_dmamap_sync</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span>
					<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">,</span>
					<span class="cm">/*offset*/</span><span class="n">modnext</span><span class="p">,</span> <span class="cm">/*len*/</span><span class="mi">4</span><span class="p">,</span>
					<span class="n">BUS_DMASYNC_PREREAD</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="o">++</span><span class="p">;</span>

		<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: WARNING no command for scb %d &quot;</span>
			       <span class="s">&quot;(cmdcmplt)</span><span class="se">\n</span><span class="s">QOUTPOS = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">scb_index</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Save off the residual</span>
<span class="cm">		 * if there is one.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_update_residual</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">ahc_done</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_run_untagged_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ahc_run_untagged_queue</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">untagged_queues</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_run_untagged_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb_tailq</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">untagged_queue_lock</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span> <span class="o">=</span> <span class="n">TAILQ_FIRST</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_ACTIVE</span><span class="p">;</span>
		<span class="n">ahc_queue_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************* Interrupt Handling *********************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_handle_brkadrint</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We upset the sequencer :-(</span>
<span class="cm">	 * Lookup the error message</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">error</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_errors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: brkadrint, %s at seqaddr = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">ahc_hard_errors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errmesg</span><span class="p">,</span>
	       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="cm">/* Tell everyone that this HBA is no longer available */</span>
	<span class="n">ahc_abort_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">,</span> <span class="n">ALL_CHANNELS</span><span class="p">,</span>
		       <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">ROLE_UNKNOWN</span><span class="p">,</span>
		       <span class="n">CAM_NO_HBA</span><span class="p">);</span>

	<span class="cm">/* Disable all interrupt sources by resetting the controller */</span>
	<span class="n">ahc_shutdown</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_handle_seqint</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">intstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>
	
	<span class="n">ahc_fetch_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the upper byte that holds SEQINT status</span>
<span class="cm">	 * codes and clear the SEQINT bit. We will unpause</span>
<span class="cm">	 * the sequencer, if appropriate, after servicing</span>
<span class="cm">	 * the request.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSEQINT</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">SEQINT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BAD_STATUS</span>:
	<span class="p">{</span>
		<span class="n">u_int</span>  <span class="n">scb_index</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hardware_scb</span> <span class="o">*</span><span class="n">hscb</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set the default return value to 0 (don&#39;t</span>
<span class="cm">		 * send sense).  The sense code will change</span>
<span class="cm">		 * this if needed.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">RETURN_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The sequencer will notify us when a command</span>
<span class="cm">		 * has an error that would be of interest to</span>
<span class="cm">		 * the kernel.  This allows us to leave the sequencer</span>
<span class="cm">		 * running in the common case of command completes</span>
<span class="cm">		 * without error.  The sequencer will already have</span>
<span class="cm">		 * dma&#39;d the SCB back up to us, so we can reference</span>
<span class="cm">		 * the in kernel copy directly.</span>
<span class="cm">		 */</span>
		<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_print_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ahc_intr - referenced scb &quot;</span>
			       <span class="s">&quot;not valid during seqint 0x%x scb(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">intstat</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
			<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;for safety&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unpause</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hscb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span> 

		<span class="cm">/* Don&#39;t want to clobber the original sense code */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Clear the SCB_SENSE Flag and have</span>
<span class="cm">			 * the sequencer do a normal command</span>
<span class="cm">			 * complete.</span>
<span class="cm">			 */</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_SENSE</span><span class="p">;</span>
			<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">CAM_AUTOSENSE_FAIL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">CAM_SCSI_STATUS_ERROR</span><span class="p">);</span>
		<span class="cm">/* Freeze the queue until the client sees the error. */</span>
		<span class="n">ahc_freeze_devq</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">ahc_freeze_scb</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
		<span class="n">ahc_set_scsi_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">hscb</span><span class="o">-&gt;</span><span class="n">shared_data</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">scsi_status</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">shared_data</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">scsi_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SCSI_STATUS_OK</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Interrupted for status of 0???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCSI_STATUS_CMD_TERMINATED</span>:
		<span class="k">case</span> <span class="n">SCSI_STATUS_CHECK_COND</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">ahc_dma_seg</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">scsi_sense</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">targ_info</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ahc_transinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">;</span>
<span class="cp">#ifdef AHC_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_SENSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCB %d: requests Check Status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_perform_autosense</span><span class="p">(</span><span class="n">scb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">targ_info</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span>
							<span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
							<span class="n">devinfo</span><span class="p">.</span><span class="n">our_scsiid</span><span class="p">,</span>
							<span class="n">devinfo</span><span class="p">.</span><span class="n">target</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>
			<span class="n">tinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">targ_info</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">;</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">;</span>
			<span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_sense</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">shared_data</span><span class="p">.</span><span class="n">cdb</span><span class="p">);</span> 
			<span class="cm">/*</span>
<span class="cm">			 * Save off the residual if there is one.</span>
<span class="cm">			 */</span>
			<span class="n">ahc_update_residual</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
<span class="cp">#ifdef AHC_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_SENSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Sending Sense</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">sg</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ahc_get_sense_bufaddr</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ahc_get_sense_bufsize</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|=</span> <span class="n">AHC_DMA_LAST_SEG</span><span class="p">;</span>

			<span class="cm">/* Fixup byte order */</span>
			<span class="n">sg</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ahc_htole32</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ahc_htole32</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">REQUEST_SENSE</span><span class="p">;</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">byte2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">protocol_version</span> <span class="o">&lt;=</span> <span class="n">SCSI_REV_2</span>
			 <span class="o">&amp;&amp;</span> <span class="n">SCB_GET_LUN</span><span class="p">(</span><span class="n">scb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">byte2</span> <span class="o">=</span> <span class="n">SCB_GET_LUN</span><span class="p">(</span><span class="n">scb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">unused</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">unused</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * We can&#39;t allow the target to disconnect.</span>
<span class="cm">			 * This will be an untagged transaction and</span>
<span class="cm">			 * having the target disconnect will make this</span>
<span class="cm">			 * transaction indestinguishable from outstanding</span>
<span class="cm">			 * tagged transactions.</span>
<span class="cm">			 */</span>
			<span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * This request sense could be because the</span>
<span class="cm">			 * the device lost power or in some other</span>
<span class="cm">			 * way has lost our transfer negotiations.</span>
<span class="cm">			 * Renegotiate if appropriate.  Unit attention</span>
<span class="cm">			 * errors will be reported before any data</span>
<span class="cm">			 * phases occur.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_get_residual</span><span class="p">(</span><span class="n">scb</span><span class="p">)</span> 
			 <span class="o">==</span> <span class="n">ahc_get_transfer_length</span><span class="p">(</span><span class="n">scb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ahc_update_neg_request</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
						       <span class="n">tstate</span><span class="p">,</span> <span class="n">targ_info</span><span class="p">,</span>
						       <span class="n">AHC_NEG_IF_NON_ASYNC</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">auto_negotiate</span> <span class="o">&amp;</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">target_mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">MK_MESSAGE</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_NEGOTIATE</span><span class="p">;</span>
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_AUTO_NEGOTIATE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hscb</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sc</span><span class="p">);</span>
			<span class="n">hscb</span><span class="o">-&gt;</span><span class="n">dataptr</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span> 
			<span class="n">hscb</span><span class="o">-&gt;</span><span class="n">datacnt</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">hscb</span><span class="o">-&gt;</span><span class="n">sgptr</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list_phys</span> <span class="o">|</span> <span class="n">SG_FULL_RESID</span><span class="p">;</span>
			<span class="n">hscb</span><span class="o">-&gt;</span><span class="n">sgptr</span> <span class="o">=</span> <span class="n">ahc_htole32</span><span class="p">(</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">sgptr</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_SENSE</span><span class="p">;</span>
			<span class="n">ahc_qinfifo_requeue_tail</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">RETURN_1</span><span class="p">,</span> <span class="n">SEND_SENSE</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Ensure we have enough time to actually</span>
<span class="cm">			 * retrieve the sense.</span>
<span class="cm">			 */</span>
			<span class="n">ahc_scb_timer_reset</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">NO_MATCH</span>:
	<span class="p">{</span>
		<span class="cm">/* Ensure we don&#39;t leave the selection hardware on */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span>
			 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSELI</span><span class="o">|</span><span class="n">ENRSELI</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">));</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%c:%d: no active SCB for reconnecting &quot;</span>
		       <span class="s">&quot;target - issuing BUS DEVICE RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SAVED_SCSIID == 0x%x, SAVED_LUN == 0x%x, &quot;</span>
		       <span class="s">&quot;ARG_1 == 0x%x ACCUM = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_SCSIID</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_LUN</span><span class="p">),</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ARG_1</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ACCUM</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SEQ_FLAGS == 0x%x, SCBPTR == 0x%x, BTT == 0x%x, &quot;</span>
		       <span class="s">&quot;SINDEX == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">),</span>
		       <span class="n">ahc_index_busy_tcl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span>
			    <span class="n">BUILD_TCL</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_SCSIID</span><span class="p">),</span>
				      <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_LUN</span><span class="p">))),</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SINDEX</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIID == 0x%x, SCB_SCSIID == 0x%x, SCB_LUN == 0x%x, &quot;</span>
		       <span class="s">&quot;SCB_TAG == 0x%x, SCB_CONTROL == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_SCSIID</span><span class="p">),</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_LUN</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">),</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIBUSL == 0x%x, SCSISIGI == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIBUSL</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SXFRCTL0 == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SEQCTL == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">));</span>
		<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_BUS_DEV_RESET</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_INITIATOR_MSGOUT</span><span class="p">;</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">,</span> <span class="n">HOST_MSG</span><span class="p">);</span>
		<span class="n">ahc_assert_atn</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SEND_REJECT</span>: 
	<span class="p">{</span>
		<span class="n">u_int</span> <span class="n">rejbyte</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ACCUM</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%c:%d: Warning - unknown message received from &quot;</span>
		       <span class="s">&quot;target (0x%x).  Rejecting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">rejbyte</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span> 
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PROTO_VIOLATION</span>:
	<span class="p">{</span>
		<span class="n">ahc_handle_proto_violation</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">IGN_WIDE_RES</span>:
		<span class="n">ahc_handle_ign_wide_residue</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PDATA_REINIT</span>:
		<span class="n">ahc_reinitialize_dataptrs</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BAD_PHASE</span>:
	<span class="p">{</span>
		<span class="n">u_int</span> <span class="n">lastphase</span><span class="p">;</span>

		<span class="n">lastphase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%c:%d: unknown scsi bus phase %x, &quot;</span>
		       <span class="s">&quot;lastphase = 0x%x.  Attempting to continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">target</span><span class="p">,</span>
		       <span class="n">lastphase</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MISSED_BUSFREE</span>:
	<span class="p">{</span>
		<span class="n">u_int</span> <span class="n">lastphase</span><span class="p">;</span>

		<span class="n">lastphase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%c:%d: Missed busfree. &quot;</span>
		       <span class="s">&quot;Lastphase = 0x%x, Curphase = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">target</span><span class="p">,</span>
		       <span class="n">lastphase</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">));</span>
		<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">HOST_MSG_LOOP</span>:
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The sequencer has encountered a message phase</span>
<span class="cm">		 * that requires host assistance for completion.</span>
<span class="cm">		 * While handling the message phase(s), we will be</span>
<span class="cm">		 * notified by the sequencer after each byte is</span>
<span class="cm">		 * transferred so we can track bus phase changes.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If this is the first time we&#39;ve seen a HOST_MSG_LOOP</span>
<span class="cm">		 * interrupt, initialize the state of the host message</span>
<span class="cm">		 * loop.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_TYPE_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
			<span class="n">u_int</span> <span class="n">scb_index</span><span class="p">;</span>
			<span class="n">u_int</span> <span class="n">bus_phase</span><span class="p">;</span>

			<span class="n">bus_phase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHASE_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_phase</span> <span class="o">!=</span> <span class="n">P_MESGIN</span>
			 <span class="o">&amp;&amp;</span> <span class="n">bus_phase</span> <span class="o">!=</span> <span class="n">P_MESGOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ahc_intr: HOST_MSG_LOOP bad &quot;</span>
				       <span class="s">&quot;phase 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">bus_phase</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Probably transitioned to bus free before</span>
<span class="cm">				 * we got here.  Just punt the message.</span>
<span class="cm">				 */</span>
				<span class="n">ahc_clear_intstat</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
				<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
			<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devinfo</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_INITIATOR</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bus_phase</span> <span class="o">==</span> <span class="n">P_MESGOUT</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
						<span class="n">panic</span><span class="p">(</span><span class="s">&quot;HOST_MSG_LOOP with &quot;</span>
						      <span class="s">&quot;invalid SCB %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						      <span class="n">scb_index</span><span class="p">);</span>

					<span class="n">ahc_setup_initiator_msgout</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span>
								   <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
								   <span class="n">scb</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span>
					    <span class="n">MSG_TYPE_INITIATOR_MSGIN</span><span class="p">;</span>
					<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bus_phase</span> <span class="o">==</span> <span class="n">P_MESGOUT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span>
					    <span class="n">MSG_TYPE_TARGET_MSGOUT</span><span class="p">;</span>
					<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> 
					<span class="n">ahc_setup_target_msgin</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span>
							       <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
							       <span class="n">scb</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="n">ahc_handle_message_phase</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PERR_DETECTED</span>:
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;ve cleared the parity error interrupt</span>
<span class="cm">		 * but the sequencer still believes that SCSIPERR</span>
<span class="cm">		 * is true, it must be that the parity error is</span>
<span class="cm">		 * for the currently presented byte on the bus,</span>
<span class="cm">		 * and we are not in a phase (data-in) where we will</span>
<span class="cm">		 * eventually ack this byte.  Ack the byte and</span>
<span class="cm">		 * throw it away in the hope that the target will</span>
<span class="cm">		 * take us to message out to deliver the appropriate</span>
<span class="cm">		 * error message.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">SCSIINT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSIPERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u_int</span> <span class="n">curphase</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * The hardware will only let you ack bytes</span>
<span class="cm">				 * if the expected phase in SCSISIGO matches</span>
<span class="cm">				 * the current phase.  Make sure this is</span>
<span class="cm">				 * currently the case.</span>
<span class="cm">				 */</span>
				<span class="n">curphase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHASE_MASK</span><span class="p">;</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">,</span> <span class="n">curphase</span><span class="p">);</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">,</span> <span class="n">curphase</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CDI</span><span class="o">|</span><span class="n">MSGI</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">wait</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * In a data phase.  Faster to bitbucket</span>
<span class="cm">				 * the data than to individually ack each</span>
<span class="cm">				 * byte.  This is also the only strategy</span>
<span class="cm">				 * that will work with AUTOACK enabled.</span>
<span class="cm">				 */</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">,</span>
					 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BITBUCKET</span><span class="p">);</span>
				<span class="n">wait</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">wait</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span>
					  <span class="o">&amp;</span> <span class="p">(</span><span class="n">CDI</span><span class="o">|</span><span class="n">MSGI</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">ahc_delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">,</span>
					 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BITBUCKET</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wait</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
					<span class="n">u_int</span>	<span class="n">scb_index</span><span class="p">;</span>

					<span class="n">ahc_print_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unable to clear parity error.  &quot;</span>
					       <span class="s">&quot;Resetting bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
					<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
						<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span>
						    <span class="n">CAM_UNCOR_PARITY</span><span class="p">);</span>
					<span class="n">ahc_reset_channel</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> 
							  <span class="cm">/*init reset*/</span><span class="n">TRUE</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIDATL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">DATA_OVERRUN</span>:
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * When the sequencer detects an overrun, it</span>
<span class="cm">		 * places the controller in &quot;BITBUCKET&quot; mode</span>
<span class="cm">		 * and allows the target to complete its transfer.</span>
<span class="cm">		 * Unfortunately, none of the counters get updated</span>
<span class="cm">		 * when the controller is in this mode, so we have</span>
<span class="cm">		 * no way of knowing how large the overrun was.</span>
<span class="cm">		 */</span>
		<span class="n">u_int</span> <span class="n">scbindex</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
		<span class="n">u_int</span> <span class="n">lastphase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
		<span class="n">u_int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbindex</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_phases</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lastphase</span> <span class="o">==</span> <span class="n">ahc_phase_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phase</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;data overrun detected %s.&quot;</span>
		       <span class="s">&quot;  Tag == 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_phase_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phasemsg</span><span class="p">,</span>
  		       <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
		<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s seen Data Phase.  Length = %ld.  NumSGs = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPHASE</span> <span class="o">?</span> <span class="s">&quot;Have&quot;</span> <span class="o">:</span> <span class="s">&quot;Haven&#39;t&quot;</span><span class="p">,</span>
		       <span class="n">ahc_get_transfer_length</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sg[%d] - Addr 0x%x%x : Length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span>
				        <span class="o">&amp;</span> <span class="n">SG_HIGH_ADDR_BITS</span><span class="p">),</span>
				       <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">),</span>
				       <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">)</span>
				       <span class="o">&amp;</span> <span class="n">AHC_SG_LEN_MASK</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set this and it will take effect when the</span>
<span class="cm">		 * target does a command complete.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_freeze_devq</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">CAM_DATA_RUN_ERR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_SENSE</span><span class="p">;</span>
			<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">CAM_AUTOSENSE_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ahc_freeze_scb</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Clear the channel in case we return</span>
<span class="cm">			 * to data phase later.</span>
<span class="cm">			 */</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span>
				 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">)</span> <span class="o">|</span> <span class="n">CLRSTCNT</span><span class="o">|</span><span class="n">CLRCHN</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span>
				 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">)</span> <span class="o">|</span> <span class="n">CLRSTCNT</span><span class="o">|</span><span class="n">CLRCHN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_39BIT_ADDRESSING</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_int</span> <span class="n">dscommand1</span><span class="p">;</span>

			<span class="cm">/* Ensure HHADDR is 0 for future DMA operations. */</span>
			<span class="n">dscommand1</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DSCOMMAND1</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DSCOMMAND1</span><span class="p">,</span> <span class="n">dscommand1</span> <span class="o">|</span> <span class="n">HADDLDSEL0</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DSCOMMAND1</span><span class="p">,</span> <span class="n">dscommand1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MKMSG_FAILED</span>:
	<span class="p">{</span>
		<span class="n">u_int</span> <span class="n">scbindex</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%c:%d:%d: Attempt to issue message failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">target</span><span class="p">,</span>
		       <span class="n">devinfo</span><span class="p">.</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">scbindex</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbindex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_RECOVERY_SCB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * Ensure that we didn&#39;t put a second instance of this</span>
<span class="cm">			 * SCB into the QINFIFO.</span>
<span class="cm">			 */</span>
			<span class="n">ahc_search_qinfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_GET_TARGET</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">),</span>
					   <span class="n">SCB_GET_CHANNEL</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">),</span>
					   <span class="n">SCB_GET_LUN</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span>
					   <span class="n">ROLE_INITIATOR</span><span class="p">,</span> <span class="cm">/*status*/</span><span class="mi">0</span><span class="p">,</span>
					   <span class="n">SEARCH_REMOVE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">NO_FREE_SCB</span>:
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: No free or disconnected SCBs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
		<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;for safety&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SCB_MISMATCH</span>:
	<span class="p">{</span>
		<span class="n">u_int</span> <span class="n">scbptr</span><span class="p">;</span>

		<span class="n">scbptr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bogus TAG after DMA.  SCBPTR %d, tag %d, our tag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">scbptr</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ARG_1</span><span class="p">),</span>
		       <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span><span class="p">[</span><span class="n">scbptr</span><span class="p">].</span><span class="n">tag</span><span class="p">);</span>
		<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;for safety&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OUT_OF_RANGE</span>:
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: BTT calculation out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SAVED_SCSIID == 0x%x, SAVED_LUN == 0x%x, &quot;</span>
		       <span class="s">&quot;ARG_1 == 0x%x ACCUM = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_SCSIID</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_LUN</span><span class="p">),</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ARG_1</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ACCUM</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SEQ_FLAGS == 0x%x, SCBPTR == 0x%x, BTT == 0x%x, &quot;</span>
		       <span class="s">&quot;SINDEX == 0x%x</span><span class="se">\n</span><span class="s">, A == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">),</span>
		       <span class="n">ahc_index_busy_tcl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span>
			    <span class="n">BUILD_TCL</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_SCSIID</span><span class="p">),</span>
				      <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_LUN</span><span class="p">))),</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SINDEX</span><span class="p">),</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ACCUM</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIID == 0x%x, SCB_SCSIID == 0x%x, SCB_LUN == 0x%x, &quot;</span>
		       <span class="s">&quot;SCB_TAG == 0x%x, SCB_CONTROL == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_SCSIID</span><span class="p">),</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_LUN</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">),</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIBUSL == 0x%x, SCSISIGI == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIBUSL</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">));</span>
		<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;for safety&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ahc_intr: seqint, &quot;</span>
		       <span class="s">&quot;intstat == 0x%x, scsisigi = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">intstat</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">unpause:</span>
	<span class="cm">/*</span>
<span class="cm">	 *  The sequencer is paused immediately on</span>
<span class="cm">	 *  a SEQINT, so we should restart it when</span>
<span class="cm">	 *  we&#39;re done.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_handle_scsiint</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">intstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span>	<span class="n">scb_index</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">status0</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">cur_channel</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">intr_channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SELBUSB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">cur_channel</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cur_channel</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
	<span class="n">intr_channel</span> <span class="o">=</span> <span class="n">cur_channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status0</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IOERR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SELTO</span><span class="o">|</span><span class="n">SCSIRSTI</span><span class="o">|</span><span class="n">BUSFREE</span><span class="o">|</span><span class="n">SCSIPERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">status0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Try the other channel */</span>
		 	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">^</span> <span class="n">SELBUSB</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">)</span>
			       <span class="o">&amp;</span> <span class="p">(</span><span class="n">SELTO</span><span class="o">|</span><span class="n">SCSIRSTI</span><span class="o">|</span><span class="n">BUSFREE</span><span class="o">|</span><span class="n">SCSIPERR</span><span class="p">);</span>
			<span class="n">intr_channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_channel</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Spurious SCSI interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">);</span>
			<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure the sequencer is in a safe location. */</span>
	<span class="n">ahc_clear_critical_section</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
	<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NOT_IDENTIFIED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">IOERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">now_lvd</span><span class="p">;</span>

		<span class="n">now_lvd</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ENAB40</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Transceiver State Has Changed to %s mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">now_lvd</span> <span class="o">?</span> <span class="s">&quot;LVD&quot;</span> <span class="o">:</span> <span class="s">&quot;SE&quot;</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT0</span><span class="p">,</span> <span class="n">CLRIOERR</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * When transitioning to SE mode, the reset line</span>
<span class="cm">		 * glitches, triggering an arbitration bug in some</span>
<span class="cm">		 * Ultra2 controllers.  This bug is cleared when we</span>
<span class="cm">		 * assert the reset line.  Since a reset glitch has</span>
<span class="cm">		 * already occurred with this transition and a</span>
<span class="cm">		 * transceiver state change is handled just like</span>
<span class="cm">		 * a bus reset anyway, asserting the reset line</span>
<span class="cm">		 * ourselves is safe.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_reset_channel</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">intr_channel</span><span class="p">,</span>
				 <span class="cm">/*Initiate Reset*/</span><span class="n">now_lvd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SCSIRSTI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Someone reset channel %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">intr_channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr_channel</span> <span class="o">!=</span> <span class="n">cur_channel</span><span class="p">)</span>
		 	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">^</span> <span class="n">SELBUSB</span><span class="p">);</span>
		<span class="n">ahc_reset_channel</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">intr_channel</span><span class="p">,</span> <span class="cm">/*Initiate Reset*/</span><span class="n">FALSE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SCSIPERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Determine the bus phase and queue an appropriate message.</span>
<span class="cm">		 * SCSIPERR is latched true as soon as a parity error</span>
<span class="cm">		 * occurs.  If the sequencer acked the transfer that</span>
<span class="cm">		 * caused the parity error and the currently presented</span>
<span class="cm">		 * transfer on the bus has correct parity, SCSIPERR will</span>
<span class="cm">		 * be cleared by CLRSCSIPERR.  Use this to determine if</span>
<span class="cm">		 * we should look at the last phase the sequencer recorded,</span>
<span class="cm">		 * or the current phase presented on the bus.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span>	<span class="n">ahc_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">mesg_out</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">curphase</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">errorphase</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">lastphase</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">scsirate</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">i</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">sstat2</span><span class="p">;</span>
		<span class="kt">int</span>	<span class="n">silent</span><span class="p">;</span>

		<span class="n">lastphase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
		<span class="n">curphase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHASE_MASK</span><span class="p">;</span>
		<span class="n">sstat2</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRSCSIPERR</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * For all phases save DATA, the sequencer won&#39;t</span>
<span class="cm">		 * automatically ack a byte that has a parity error</span>
<span class="cm">		 * in it.  So the only way that the current phase</span>
<span class="cm">		 * could be &#39;data-in&#39; is if the parity error is for</span>
<span class="cm">		 * an already acked byte in the data phase.  During</span>
<span class="cm">		 * synchronous data-in transfers, we may actually</span>
<span class="cm">		 * ack bytes before latching the current phase in</span>
<span class="cm">		 * LASTPHASE, leading to the discrepancy between</span>
<span class="cm">		 * curphase and lastphase.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSIPERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		 <span class="o">||</span> <span class="n">curphase</span> <span class="o">==</span> <span class="n">P_DATAIN</span> <span class="o">||</span> <span class="n">curphase</span> <span class="o">==</span> <span class="n">P_DATAIN_DT</span><span class="p">)</span>
			<span class="n">errorphase</span> <span class="o">=</span> <span class="n">curphase</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">errorphase</span> <span class="o">=</span> <span class="n">lastphase</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_phases</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errorphase</span> <span class="o">==</span> <span class="n">ahc_phase_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phase</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mesg_out</span> <span class="o">=</span> <span class="n">ahc_phase_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mesg_out</span><span class="p">;</span>
		<span class="n">silent</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SCB_IS_SILENT</span><span class="p">(</span><span class="n">scb</span><span class="p">))</span>
				<span class="n">silent</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_TRANSMISSION_ERROR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%c:%d: &quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">intr_channel</span><span class="p">,</span>
			       <span class="n">SCSIID_TARGET</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_SCSIID</span><span class="p">)));</span>
		<span class="n">scsirate</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIRATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">silent</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;parity error detected %s. &quot;</span>
			       <span class="s">&quot;SEQADDR(0x%x) SCSIRATE(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc_phase_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phasemsg</span><span class="p">,</span>
			       <span class="n">ahc_inw</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">),</span>
			       <span class="n">scsirate</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sstat2</span> <span class="o">&amp;</span> <span class="n">CRCVALERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">CRC Value Mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sstat2</span> <span class="o">&amp;</span> <span class="n">CRCENDERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">No terminal CRC packet &quot;</span>
					       <span class="s">&quot;recevied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sstat2</span> <span class="o">&amp;</span> <span class="n">CRCREQERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Illegal CRC packet &quot;</span>
					       <span class="s">&quot;request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sstat2</span> <span class="o">&amp;</span> <span class="n">DUAL_EDGE_ERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Unexpected %sDT Data Phase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">SINGLE_EDGE</span><span class="p">)</span>
					     <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;non-&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sstat2</span> <span class="o">&amp;</span> <span class="n">DUAL_EDGE_ERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This error applies regardless of</span>
<span class="cm">			 * data direction, so ignore the value</span>
<span class="cm">			 * in the phase table.</span>
<span class="cm">			 */</span>
			<span class="n">mesg_out</span> <span class="o">=</span> <span class="n">MSG_INITIATOR_DET_ERR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * We&#39;ve set the hardware to assert ATN if we   </span>
<span class="cm">		 * get a parity error on &quot;in&quot; phases, so all we  </span>
<span class="cm">		 * need to do is stuff the message buffer with</span>
<span class="cm">		 * the appropriate message.  &quot;In&quot; phases have set</span>
<span class="cm">		 * mesg_out to something other than MSG_NOP.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mesg_out</span> <span class="o">!=</span> <span class="n">MSG_NOOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">!=</span> <span class="n">MSG_TYPE_NONE</span><span class="p">)</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">send_msg_perror</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">,</span> <span class="n">mesg_out</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Force a renegotiation with this target just in</span>
<span class="cm">		 * case we are out of sync for some external reason</span>
<span class="cm">		 * unknown (or unreported) by the target.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_fetch_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
		<span class="n">ahc_force_renegotiation</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>

		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">);</span>
		<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SELTO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span>	<span class="n">scbptr</span><span class="p">;</span>

		<span class="cm">/* Stop the selection */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* No more pending messages */</span>
		<span class="n">ahc_clear_msg_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

		<span class="cm">/* Clear interrupt state */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENBUSFREE</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRSELTIMEO</span><span class="o">|</span><span class="n">CLRBUSFREE</span><span class="o">|</span><span class="n">CLRSCSIPERR</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Although the driver does not care about the</span>
<span class="cm">		 * &#39;Selection in Progress&#39; status bit, the busy</span>
<span class="cm">		 * LED does.  SELINGO is only cleared by a successful</span>
<span class="cm">		 * selection, so we must manually clear it to insure</span>
<span class="cm">		 * the LED turns off just incase no future successful</span>
<span class="cm">		 * selections occur (e.g. no devices on the bus).</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT0</span><span class="p">,</span> <span class="n">CLRSELINGO</span><span class="p">);</span>

		<span class="n">scbptr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">scbptr</span><span class="p">);</span>
		<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>

		<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ahc_intr - referenced scb not &quot;</span>
			       <span class="s">&quot;valid during SELTO scb(%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">scbptr</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
			<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>
<span class="cp">#ifdef AHC_DEBUG</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_SELTO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Saw Selection Timeout for SCB 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">scb_index</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">ahc_scb_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">CAM_SEL_TIMEOUT</span><span class="p">);</span>
			<span class="n">ahc_freeze_devq</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Cancel any pending transactions on the device</span>
<span class="cm">			 * now that it seems to be missing.  This will</span>
<span class="cm">			 * also revert us to async/narrow transfers until</span>
<span class="cm">			 * we can renegotiate with the device.</span>
<span class="cm">			 */</span>
			<span class="n">ahc_handle_devreset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
					    <span class="n">CAM_SEL_TIMEOUT</span><span class="p">,</span>
					    <span class="s">&quot;Selection Timeout&quot;</span><span class="p">,</span>
					    <span class="cm">/*verbose_level*/</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">);</span>
		<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BUSFREE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ENBUSFREE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span>	<span class="n">ahc_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">lastphase</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">saved_scsiid</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">saved_lun</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">target</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">initiator_role_id</span><span class="p">;</span>
		<span class="kt">char</span>	<span class="n">channel</span><span class="p">;</span>
		<span class="kt">int</span>	<span class="n">printerror</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Clear our selection hardware as soon as possible.</span>
<span class="cm">		 * We may have an entry in the waiting Q for this target,</span>
<span class="cm">		 * that is affected by this busfree and we don&#39;t want to</span>
<span class="cm">		 * go about selecting the target while we handle the event.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span>
			 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSELI</span><span class="o">|</span><span class="n">ENRSELI</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Disable busfree interrupts and clear the busfree</span>
<span class="cm">		 * interrupt status.  We do this here so that several</span>
<span class="cm">		 * bus transactions occur prior to clearing the SCSIINT</span>
<span class="cm">		 * latch.  It can take a bit for the clearing to take effect.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENBUSFREE</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRBUSFREE</span><span class="o">|</span><span class="n">CLRSCSIPERR</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Look at what phase we were last in.</span>
<span class="cm">		 * If its message out, chances are pretty good</span>
<span class="cm">		 * that the busfree was in response to one of</span>
<span class="cm">		 * our abort requests.</span>
<span class="cm">		 */</span>
		<span class="n">lastphase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
		<span class="n">saved_scsiid</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_SCSIID</span><span class="p">);</span>
		<span class="n">saved_lun</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_LUN</span><span class="p">);</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">SCSIID_TARGET</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">saved_scsiid</span><span class="p">);</span>
		<span class="n">initiator_role_id</span> <span class="o">=</span> <span class="n">SCSIID_OUR_ID</span><span class="p">(</span><span class="n">saved_scsiid</span><span class="p">);</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">SCSIID_CHANNEL</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">saved_scsiid</span><span class="p">);</span>
		<span class="n">ahc_compile_devinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">initiator_role_id</span><span class="p">,</span>
				    <span class="n">target</span><span class="p">,</span> <span class="n">saved_lun</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ROLE_INITIATOR</span><span class="p">);</span>
		<span class="n">printerror</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lastphase</span> <span class="o">==</span> <span class="n">P_MESGOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_int</span> <span class="n">tag</span><span class="p">;</span>

			<span class="n">tag</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_1B</span><span class="p">,</span> <span class="n">MSG_ABORT_TAG</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span>
			 <span class="o">||</span> <span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_1B</span><span class="p">,</span> <span class="n">MSG_ABORT</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
				 <span class="o">==</span> <span class="n">MSG_ABORT_TAG</span><span class="p">)</span>
					<span class="n">tag</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
				<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCB %d - Abort%s Completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span> <span class="o">?</span>
				       <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; Tag&quot;</span><span class="p">);</span>
				<span class="n">ahc_abort_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
					       <span class="n">saved_lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
					       <span class="n">ROLE_INITIATOR</span><span class="p">,</span>
					       <span class="n">CAM_REQ_ABORTED</span><span class="p">);</span>
				<span class="n">printerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_1B</span><span class="p">,</span>
						<span class="n">MSG_BUS_DEV_RESET</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef __FreeBSD__</span>
				<span class="cm">/*</span>
<span class="cm">				 * Don&#39;t mark the user&#39;s request for this BDR</span>
<span class="cm">				 * as completing with CAM_BDR_SENT.  CAM3</span>
<span class="cm">				 * specifies CAM_REQ_CMP.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span>
				 <span class="o">&amp;&amp;</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">func_code</span><span class="o">==</span> <span class="n">XPT_RESET_DEV</span>
				 <span class="o">&amp;&amp;</span> <span class="n">ahc_match_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
						  <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span>
						  <span class="n">SCB_LIST_NULL</span><span class="p">,</span>
						  <span class="n">ROLE_INITIATOR</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">CAM_REQ_CMP</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
				<span class="n">ahc_compile_devinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
						    <span class="n">initiator_role_id</span><span class="p">,</span>
						    <span class="n">target</span><span class="p">,</span>
						    <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span>
						    <span class="n">channel</span><span class="p">,</span>
						    <span class="n">ROLE_INITIATOR</span><span class="p">);</span>
				<span class="n">ahc_handle_devreset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
						    <span class="n">CAM_BDR_SENT</span><span class="p">,</span>
						    <span class="s">&quot;Bus Device Reset&quot;</span><span class="p">,</span>
						    <span class="cm">/*verbose_level*/</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">printerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_EXT</span><span class="p">,</span>
						<span class="n">MSG_EXT_PPR</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * PPR Rejected.  Try non-ppr negotiation</span>
<span class="cm">				 * and retry command.</span>
<span class="cm">				 */</span>
				<span class="n">tinfo</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span>
							    <span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
							    <span class="n">devinfo</span><span class="p">.</span><span class="n">our_scsiid</span><span class="p">,</span>
							    <span class="n">devinfo</span><span class="p">.</span><span class="n">target</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">transport_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">transport_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahc_qinfifo_requeue_tail</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">printerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_EXT</span><span class="p">,</span>
						<span class="n">MSG_EXT_WDTR</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Negotiation Rejected.  Go-narrow and</span>
<span class="cm">				 * retry command.</span>
<span class="cm">				 */</span>
				<span class="n">ahc_set_width</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
					      <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">,</span>
					      <span class="n">AHC_TRANS_CUR</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="p">,</span>
					      <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
				<span class="n">ahc_qinfifo_requeue_tail</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">printerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_EXT</span><span class="p">,</span>
						<span class="n">MSG_EXT_SDTR</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Negotiation Rejected.  Go-async and</span>
<span class="cm">				 * retry command.</span>
<span class="cm">				 */</span>
				<span class="n">ahc_set_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
						<span class="cm">/*syncrate*/</span><span class="nb">NULL</span><span class="p">,</span>
						<span class="cm">/*period*/</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/*offset*/</span><span class="mi">0</span><span class="p">,</span>
						<span class="cm">/*ppr_options*/</span><span class="mi">0</span><span class="p">,</span>
						<span class="n">AHC_TRANS_CUR</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="p">,</span>
						<span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
				<span class="n">ahc_qinfifo_requeue_tail</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">printerror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printerror</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_int</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u_int</span> <span class="n">tag</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">TAG_ENB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">tag</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">tag</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
				<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">ahc_abort_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
					       <span class="n">SCB_GET_LUN</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">tag</span><span class="p">,</span>
					       <span class="n">ROLE_INITIATOR</span><span class="p">,</span>
					       <span class="n">CAM_UNEXP_BUSFREE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * We had not fully identified this connection,</span>
<span class="cm">				 * so we cannot abort anything.</span>
<span class="cm">				 */</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: &quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_phases</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lastphase</span> <span class="o">==</span> <span class="n">ahc_phase_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phase</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lastphase</span> <span class="o">!=</span> <span class="n">P_BUSFREE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Renegotiate with this device at the</span>
<span class="cm">				 * next opportunity just in case this busfree</span>
<span class="cm">				 * is due to a negotiation mismatch with the</span>
<span class="cm">				 * device.</span>
<span class="cm">				 */</span>
				<span class="n">ahc_force_renegotiation</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unexpected busfree %s</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;SEQADDR == 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc_phase_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phasemsg</span><span class="p">,</span>
			       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">);</span>
		<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Missing case in ahc_handle_scsiint. status = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Force renegotiation to occur the next time we initiate</span>
<span class="cm"> * a command to the current device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_force_renegotiation</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">targ_info</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>

	<span class="n">targ_info</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span>
					<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">,</span>
					<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>
	<span class="n">ahc_update_neg_request</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">tstate</span><span class="p">,</span>
			       <span class="n">targ_info</span><span class="p">,</span> <span class="n">AHC_NEG_IF_NON_ASYNC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define AHC_MAX_STEPS 2000</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_clear_critical_section</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">stepping</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">steps</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">simode0</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">simode1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">num_critical_sections</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">stepping</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">simode0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">simode1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span>	<span class="n">cs</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">seqaddr</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">i</span><span class="p">;</span>

		<span class="n">seqaddr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Seqaddr represents the next instruction to execute, </span>
<span class="cm">		 * so we are really executing the instruction just</span>
<span class="cm">		 * before it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seqaddr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">seqaddr</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">critical_sections</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">num_critical_sections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cs</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">begin</span> <span class="o">&lt;</span> <span class="n">seqaddr</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">seqaddr</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">num_critical_sections</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">&gt;</span> <span class="n">AHC_MAX_STEPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Infinite loop in critical section</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
			<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;critical section loop&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">steps</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stepping</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * Disable all interrupt sources so that the</span>
<span class="cm">			 * sequencer will not be stuck by a pausing</span>
<span class="cm">			 * interrupt condition while we attempt to</span>
<span class="cm">			 * leave a critical section.</span>
<span class="cm">			 */</span>
			<span class="n">simode0</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">simode1</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/*</span>
<span class="cm">				 * On DT class controllers, we</span>
<span class="cm">				 * use the enhanced busfree logic.</span>
<span class="cm">				 * Unfortunately we cannot re-enable</span>
<span class="cm">				 * busfree detection within the</span>
<span class="cm">				 * current connection, so we must</span>
<span class="cm">				 * leave it on while single stepping.</span>
<span class="cm">				 */</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">simode1</span> <span class="o">&amp;</span> <span class="n">ENBUSFREE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seqctl</span> <span class="o">|</span> <span class="n">STEP</span><span class="p">);</span>
			<span class="n">stepping</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRBUSFREE</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unpause</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ahc_is_paused</span><span class="p">(</span><span class="n">ahc</span><span class="p">))</span>
			<span class="n">ahc_delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stepping</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">,</span> <span class="n">simode0</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">simode1</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seqctl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear any pending interrupt status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_clear_intstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Clear any interrupt conditions this may have caused */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRSELTIMEO</span><span class="o">|</span><span class="n">CLRATNO</span><span class="o">|</span><span class="n">CLRSCSIRSTI</span>
				<span class="o">|</span><span class="n">CLRBUSFREE</span><span class="o">|</span><span class="n">CLRSCSIPERR</span><span class="o">|</span><span class="n">CLRPHASECHG</span><span class="o">|</span>
				<span class="n">CLRREQINIT</span><span class="p">);</span>
	<span class="n">ahc_flush_device_writes</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT0</span><span class="p">,</span> <span class="n">CLRSELDO</span><span class="o">|</span><span class="n">CLRSELDI</span><span class="o">|</span><span class="n">CLRSELINGO</span><span class="p">);</span>
 	<span class="n">ahc_flush_device_writes</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRSCSIINT</span><span class="p">);</span>
	<span class="n">ahc_flush_device_writes</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************** Debugging Routines ******************************/</span>
<span class="cp">#ifdef AHC_DEBUG</span>
<span class="kt">uint32_t</span> <span class="n">ahc_debug</span> <span class="o">=</span> <span class="n">AHC_DEBUG_OPTS</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"> /* unused */</span>
<span class="c">static void</span>
<span class="c">ahc_print_scb(struct scb *scb)</span>
<span class="c">{</span>
<span class="c">	int i;</span>

<span class="c">	struct hardware_scb *hscb = scb-&gt;hscb;</span>

<span class="c">	printk(&quot;scb:%p control:0x%x scsiid:0x%x lun:%d cdb_len:%d\n&quot;,</span>
<span class="c">	       (void *)scb,</span>
<span class="c">	       hscb-&gt;control,</span>
<span class="c">	       hscb-&gt;scsiid,</span>
<span class="c">	       hscb-&gt;lun,</span>
<span class="c">	       hscb-&gt;cdb_len);</span>
<span class="c">	printk(&quot;Shared Data: &quot;);</span>
<span class="c">	for (i = 0; i &lt; sizeof(hscb-&gt;shared_data.cdb); i++)</span>
<span class="c">		printk(&quot;%#02x&quot;, hscb-&gt;shared_data.cdb[i]);</span>
<span class="c">	printk(&quot;        dataptr:%#x datacnt:%#x sgptr:%#x tag:%#x\n&quot;,</span>
<span class="c">		ahc_le32toh(hscb-&gt;dataptr),</span>
<span class="c">		ahc_le32toh(hscb-&gt;datacnt),</span>
<span class="c">		ahc_le32toh(hscb-&gt;sgptr),</span>
<span class="c">		hscb-&gt;tag);</span>
<span class="c">	if (scb-&gt;sg_count &gt; 0) {</span>
<span class="c">		for (i = 0; i &lt; scb-&gt;sg_count; i++) {</span>
<span class="c">			printk(&quot;sg[%d] - Addr 0x%x%x : Length %d\n&quot;,</span>
<span class="c">			       i,</span>
<span class="c">			       (ahc_le32toh(scb-&gt;sg_list[i].len) &gt;&gt; 24</span>
<span class="c">			        &amp; SG_HIGH_ADDR_BITS),</span>
<span class="c">			       ahc_le32toh(scb-&gt;sg_list[i].addr),</span>
<span class="c">			       ahc_le32toh(scb-&gt;sg_list[i].len));</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/************************* Transfer Negotiation *******************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Allocate per target mode instance (ID we respond to as a target)</span>
<span class="cm"> * transfer negotiation data structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span>
<span class="nf">ahc_alloc_tstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">scsi_id</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">master_tstate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">master_tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_id</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">master_tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id_b</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span>
	 <span class="o">&amp;&amp;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">master_tstate</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: ahc_alloc_tstate - Target already allocated&quot;</span><span class="p">,</span>
		      <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
	<span class="n">tstate</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tstate</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have allocated a master tstate, copy user settings from</span>
<span class="cm">	 * the master tstate (taken from SRAM or the EEPROM) for this</span>
<span class="cm">	 * channel, but reset our current and goal settings to async/narrow</span>
<span class="cm">	 * until an initiator talks to us.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master_tstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="n">master_tstate</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tstate</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">));</span>
		<span class="n">tstate</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AHC_NUM_TARGETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">transinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">transinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curr</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">transinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">goal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">transinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">goal</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tstate</span><span class="p">));</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tstate</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">tstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef AHC_TARGET_MODE</span>
<span class="cm">/*</span>
<span class="cm"> * Free per target mode instance (ID we respond to as a target)</span>
<span class="cm"> * transfer negotiation data structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_free_tstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">scsi_id</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t clean up our &quot;master&quot; tstate.</span>
<span class="cm">	 * It has our default user settings.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_id</span> <span class="o">==</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id_b</span><span class="p">)</span>
	  <span class="o">||</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">scsi_id</span> <span class="o">==</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">))</span>
	 <span class="o">&amp;&amp;</span> <span class="n">force</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
		<span class="n">scsi_id</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tstate</span><span class="p">);</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">scsi_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Called when we have an active connection to a target on the bus,</span>
<span class="cm"> * this function finds the nearest syncrate to the input period limited</span>
<span class="cm"> * by the capabilities of the bus connectivity of and sync settings for</span>
<span class="cm"> * the target.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="o">*</span>
<span class="nf">ahc_devlimited_syncrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">,</span>
			<span class="n">u_int</span> <span class="o">*</span><span class="n">period</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="n">ppr_options</span><span class="p">,</span> <span class="n">role_t</span> <span class="n">role</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">ahc_transinfo</span> <span class="o">*</span><span class="n">transinfo</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">maxsync</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ENAB40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EXP_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_DT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">;</span>
			<span class="cm">/* Can&#39;t do DT on an SE bus */</span>
			<span class="o">*</span><span class="n">ppr_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_FAST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Never allow a value higher than our current goal</span>
<span class="cm">	 * period otherwise we may allow a target initiated</span>
<span class="cm">	 * negotiation to go above the limit as set by the</span>
<span class="cm">	 * user.  In the case of an initiator initiated</span>
<span class="cm">	 * sync negotiation, we limit based on the user</span>
<span class="cm">	 * setting.  This allows the system to still accept</span>
<span class="cm">	 * incoming negotiations even if target initiated</span>
<span class="cm">	 * negotiation is not performed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_TARGET</span><span class="p">)</span>
		<span class="n">transinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="n">transinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ppr_options</span> <span class="o">&amp;=</span> <span class="n">transinfo</span><span class="o">-&gt;</span><span class="n">ppr_options</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transinfo</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxsync</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">maxsync</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ppr_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transinfo</span><span class="o">-&gt;</span><span class="n">period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ppr_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">period</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="o">*</span><span class="n">period</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="n">transinfo</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ahc_find_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">ppr_options</span><span class="p">,</span> <span class="n">maxsync</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Look up the valid period to SCSIRATE conversion in our table.</span>
<span class="cm"> * Return the period and offset that should be sent to the target</span>
<span class="cm"> * if this was the beginning of an SDTR.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="o">*</span>
<span class="nf">ahc_find_syncrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="n">period</span><span class="p">,</span>
		  <span class="n">u_int</span> <span class="o">*</span><span class="n">ppr_options</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">maxsync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ppr_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">;</span>

	<span class="cm">/* Skip all DT only entries if DT is not available */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ppr_options</span> <span class="o">&amp;</span> <span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="n">maxsync</span> <span class="o">&lt;</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">)</span>
		<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">;</span>

	<span class="cm">/* Now set the maxsync based on the card capabilities</span>
<span class="cm">	 * DT is already done above */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_DT</span> <span class="o">|</span> <span class="n">AHC_ULTRA2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="n">maxsync</span> <span class="o">&lt;</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">)</span>
		<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_DT</span> <span class="o">|</span> <span class="n">AHC_ULTRA2</span> <span class="o">|</span> <span class="n">AHC_ULTRA</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="n">maxsync</span> <span class="o">&lt;</span> <span class="n">AHC_SYNCRATE_FAST</span><span class="p">)</span>
		<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_FAST</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ahc_syncrates</span><span class="p">[</span><span class="n">maxsync</span><span class="p">];</span>
	     <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">syncrate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * The Ultra2 table doesn&#39;t go as low</span>
<span class="cm">		 * as for the Fast/Ultra cards.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_u2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">period</span> <span class="o">&lt;=</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * When responding to a target that requests</span>
<span class="cm">			 * sync, the requested rate may fall between</span>
<span class="cm">			 * two rates that we can output, but still be</span>
<span class="cm">			 * a rate that we can receive.  Because of this,</span>
<span class="cm">			 * we want to respond to the target with</span>
<span class="cm">			 * the same rate that it sent to us even</span>
<span class="cm">			 * if the period we use to send data to it</span>
<span class="cm">			 * is lower.  Only lower the response period</span>
<span class="cm">			 * if we must.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ahc_syncrates</span><span class="p">[</span><span class="n">maxsync</span><span class="p">])</span>
				<span class="o">*</span><span class="n">period</span> <span class="o">=</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * At some speeds, we only support</span>
<span class="cm">			 * ST transfers.</span>
<span class="cm">			 */</span>
		 	<span class="k">if</span> <span class="p">((</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_u2</span> <span class="o">&amp;</span> <span class="n">ST_SXFR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">*</span><span class="n">ppr_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	 <span class="o">||</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	 <span class="o">||</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_u2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Use asynchronous transfers. */</span>
		<span class="o">*</span><span class="n">period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">syncrate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ppr_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">syncrate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert from an entry in our syncrate table to the SCSI equivalent</span>
<span class="cm"> * sync &quot;period&quot; factor.</span>
<span class="cm"> */</span>
<span class="n">u_int</span>
<span class="nf">ahc_find_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">scsirate</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">maxsync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="n">SXFR_ULTRA2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="n">SXFR</span><span class="p">;</span>

	<span class="cm">/* now set maxsync based on card capabilities */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">maxsync</span> <span class="o">&lt;</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">)</span>
		<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_DT</span> <span class="o">|</span> <span class="n">AHC_ULTRA2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="n">maxsync</span> <span class="o">&lt;</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">)</span>
		<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_DT</span> <span class="o">|</span> <span class="n">AHC_ULTRA2</span> <span class="o">|</span> <span class="n">AHC_ULTRA</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="n">maxsync</span> <span class="o">&lt;</span> <span class="n">AHC_SYNCRATE_FAST</span><span class="p">)</span>
		<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_FAST</span><span class="p">;</span>


	<span class="n">syncrate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ahc_syncrates</span><span class="p">[</span><span class="n">maxsync</span><span class="p">];</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_u2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsirate</span> <span class="o">==</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_u2</span> <span class="o">&amp;</span> <span class="n">SXFR_ULTRA2</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsirate</span> <span class="o">==</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr</span> <span class="o">&amp;</span> <span class="n">SXFR</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">syncrate</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* async */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Truncate the given synchronous offset to a value the</span>
<span class="cm"> * current adapter type and syncrate are capable of.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_validate_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">,</span>
		    <span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">,</span>
		    <span class="n">u_int</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wide</span><span class="p">,</span> <span class="n">role_t</span> <span class="n">role</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">maxoffset</span><span class="p">;</span>

	<span class="cm">/* Limit offset to what we can do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxoffset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wide</span><span class="p">)</span>
			<span class="n">maxoffset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_16BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">maxoffset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_8BIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="n">maxoffset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tinfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_TARGET</span><span class="p">)</span>
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Truncate the given transfer width parameter to a value the</span>
<span class="cm"> * current adapter type is capable of.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_validate_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">,</span>
		   <span class="n">u_int</span> <span class="o">*</span><span class="n">bus_width</span><span class="p">,</span> <span class="n">role_t</span> <span class="n">role</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Respond Wide */</span>
			<span class="o">*</span><span class="n">bus_width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span>:
		<span class="o">*</span><span class="n">bus_width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tinfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_TARGET</span><span class="p">)</span>
			<span class="o">*</span><span class="n">bus_width</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">u_int</span><span class="p">)</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="o">*</span><span class="n">bus_width</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">bus_width</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">u_int</span><span class="p">)</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="o">*</span><span class="n">bus_width</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the bitmask of targets for which the controller should</span>
<span class="cm"> * negotiate with at the next convenient opportunity.  This currently</span>
<span class="cm"> * means the next time we send the initial identify messages for</span>
<span class="cm"> * a new transaction.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ahc_update_neg_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">,</span> <span class="n">ahc_neg_type</span> <span class="n">neg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">auto_negotiate_orig</span><span class="p">;</span>

	<span class="n">auto_negotiate_orig</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">auto_negotiate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">neg_type</span> <span class="o">==</span> <span class="n">AHC_NEG_ALWAYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Force our &quot;current&quot; settings to be</span>
<span class="cm">		 * unknown so that unless a bus reset</span>
<span class="cm">		 * occurs the need to renegotiate is</span>
<span class="cm">		 * recorded persistently.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">AHC_WIDTH_UNKNOWN</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">AHC_PERIOD_UNKNOWN</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">AHC_OFFSET_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">period</span> <span class="o">!=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span>
	 <span class="o">||</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span>
	 <span class="o">||</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span>
	 <span class="o">||</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">!=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">ppr_options</span>
	 <span class="o">||</span> <span class="p">(</span><span class="n">neg_type</span> <span class="o">==</span> <span class="n">AHC_NEG_IF_NON_ASYNC</span>
	  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span>
	   <span class="o">||</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span>
	   <span class="o">||</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="n">tstate</span><span class="o">-&gt;</span><span class="n">auto_negotiate</span> <span class="o">|=</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tstate</span><span class="o">-&gt;</span><span class="n">auto_negotiate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">auto_negotiate_orig</span> <span class="o">!=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">auto_negotiate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the user/goal/curr tables of synchronous negotiation</span>
<span class="cm"> * parameters as well as, in the case of a current or active update,</span>
<span class="cm"> * any data structures on the host controller.  In the case of an</span>
<span class="cm"> * active update, the specified target is currently talking to us on</span>
<span class="cm"> * the bus, so the transfer parameter update must take effect</span>
<span class="cm"> * immediately.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ahc_set_syncrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
		 <span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">period</span><span class="p">,</span>
		 <span class="n">u_int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">ppr_options</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">paused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">old_period</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">old_offset</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">old_ppr</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">active</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">update_needed</span><span class="p">;</span>

	<span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_TRANS_ACTIVE</span><span class="p">;</span>
	<span class="n">update_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tinfo</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">,</span>
				    <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_USER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">=</span> <span class="n">ppr_options</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_GOAL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">=</span> <span class="n">ppr_options</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_period</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">period</span><span class="p">;</span>
	<span class="n">old_offset</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">old_ppr</span>	   <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ppr_options</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_CUR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">old_period</span> <span class="o">!=</span> <span class="n">period</span>
	  <span class="o">||</span> <span class="n">old_offset</span> <span class="o">!=</span> <span class="n">offset</span>
	  <span class="o">||</span> <span class="n">old_ppr</span> <span class="o">!=</span> <span class="n">ppr_options</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u_int</span>	<span class="n">scsirate</span><span class="p">;</span>

		<span class="n">update_needed</span><span class="o">++</span><span class="p">;</span>
		<span class="n">scsirate</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">scsirate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SXFR_ULTRA2</span><span class="o">|</span><span class="n">SINGLE_EDGE</span><span class="o">|</span><span class="n">ENABLE_CRC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scsirate</span> <span class="o">|=</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr_u2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ppr_options</span> <span class="o">&amp;</span> <span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">scsirate</span> <span class="o">|=</span> <span class="n">ENABLE_CRC</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">scsirate</span> <span class="o">|=</span> <span class="n">SINGLE_EDGE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SXFR</span><span class="o">|</span><span class="n">SOFS</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Ensure Ultra mode is set properly for</span>
<span class="cm">			 * this target.</span>
<span class="cm">			 */</span>
			<span class="n">tstate</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr</span> <span class="o">&amp;</span> <span class="n">ULTRA_SXFR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tstate</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">|=</span>
						<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_mask</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">scsirate</span> <span class="o">|=</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">sxfr</span> <span class="o">&amp;</span> <span class="n">SXFR</span><span class="p">;</span>
				<span class="n">scsirate</span> <span class="o">|=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="n">SOFS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u_int</span> <span class="n">sxfrctl0</span><span class="p">;</span>

				<span class="n">sxfrctl0</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">);</span>
				<span class="n">sxfrctl0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FAST20</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_mask</span><span class="p">)</span>
					<span class="n">sxfrctl0</span> <span class="o">|=</span> <span class="n">FAST20</span><span class="p">;</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">sxfrctl0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIRATE</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIOFFSET</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">scsirate</span> <span class="o">=</span> <span class="n">scsirate</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">=</span> <span class="n">ppr_options</span><span class="p">;</span>

		<span class="n">ahc_send_async</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
			       <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span> <span class="n">AC_TRANSFER_NEG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: target %d synchronous at %sMHz%s, &quot;</span>
				       <span class="s">&quot;offset = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span>
				       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">syncrate</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">ppr_options</span> <span class="o">&amp;</span> <span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">)</span>
				       <span class="o">?</span> <span class="s">&quot; DT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: target %d using &quot;</span>
				       <span class="s">&quot;asynchronous transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">update_needed</span> <span class="o">+=</span> <span class="n">ahc_update_neg_request</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">tstate</span><span class="p">,</span>
						<span class="n">tinfo</span><span class="p">,</span> <span class="n">AHC_NEG_TO_GOAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">update_needed</span><span class="p">)</span>
		<span class="n">ahc_update_pending_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the user/goal/curr tables of wide negotiation</span>
<span class="cm"> * parameters as well as, in the case of a current or active update,</span>
<span class="cm"> * any data structures on the host controller.  In the case of an</span>
<span class="cm"> * active update, the specified target is currently talking to us on</span>
<span class="cm"> * the bus, so the transfer parameter update must take effect</span>
<span class="cm"> * immediately.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ahc_set_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
	      <span class="n">u_int</span> <span class="n">width</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">paused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">oldwidth</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">active</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">update_needed</span><span class="p">;</span>

	<span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_TRANS_ACTIVE</span><span class="p">;</span>
	<span class="n">update_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tinfo</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">,</span>
				    <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_USER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_GOAL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

	<span class="n">oldwidth</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">AHC_TRANS_CUR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">oldwidth</span> <span class="o">!=</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span>	<span class="n">scsirate</span><span class="p">;</span>

		<span class="n">update_needed</span><span class="o">++</span><span class="p">;</span>
		<span class="n">scsirate</span> <span class="o">=</span>  <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">scsirate</span><span class="p">;</span>
		<span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIDEXFER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">)</span>
			<span class="n">scsirate</span> <span class="o">|=</span> <span class="n">WIDEXFER</span><span class="p">;</span>

		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">scsirate</span> <span class="o">=</span> <span class="n">scsirate</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIRATE</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">);</span>

		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

		<span class="n">ahc_send_async</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
			       <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span> <span class="n">AC_TRANSFER_NEG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: target %d using %dbit transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
			       <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">width</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">update_needed</span> <span class="o">+=</span> <span class="n">ahc_update_neg_request</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">tstate</span><span class="p">,</span>
						<span class="n">tinfo</span><span class="p">,</span> <span class="n">AHC_NEG_TO_GOAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_needed</span><span class="p">)</span>
		<span class="n">ahc_update_pending_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the current state of tagged queuing for a given target.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_set_tags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">ahc_queue_alg</span> <span class="n">alg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

 	<span class="n">ahc_platform_set_tags</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">alg</span><span class="p">);</span>
 	<span class="n">ahc_send_async</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
 		       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">AC_TRANSFER_NEG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When the transfer settings for a connection change, update any</span>
<span class="cm"> * in-transit SCBs to contain the new data so the hardware will</span>
<span class="cm"> * be set correctly during future (re)selections.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_update_pending_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">pending_scb</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">pending_scb_count</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">paused</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">saved_scbptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Traverse the pending SCB list and ensure that all of the</span>
<span class="cm">	 * SCBs there have the proper settings.</span>
<span class="cm">	 */</span>
	<span class="n">pending_scb_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LIST_FOREACH</span><span class="p">(</span><span class="n">pending_scb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_scbs</span><span class="p">,</span> <span class="n">pending_links</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hardware_scb</span> <span class="o">*</span><span class="n">pending_hscb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>

		<span class="n">ahc_scb_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">pending_scb</span><span class="p">);</span>
		<span class="n">tinfo</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
					    <span class="n">devinfo</span><span class="p">.</span><span class="n">our_scsiid</span><span class="p">,</span>
					    <span class="n">devinfo</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>
		<span class="n">pending_hscb</span> <span class="o">=</span> <span class="n">pending_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>
		<span class="n">pending_hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ULTRAENB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">target_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pending_hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">ULTRAENB</span><span class="p">;</span>
		<span class="n">pending_hscb</span><span class="o">-&gt;</span><span class="n">scsirate</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">scsirate</span><span class="p">;</span>
		<span class="n">pending_hscb</span><span class="o">-&gt;</span><span class="n">scsioffset</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">auto_negotiate</span> <span class="o">&amp;</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">target_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pending_scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_AUTO_NEGOTIATE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pending_scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_AUTO_NEGOTIATE</span><span class="p">;</span>
			<span class="n">pending_hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MK_MESSAGE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ahc_sync_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">pending_scb</span><span class="p">,</span>
			     <span class="n">BUS_DMASYNC_PREREAD</span><span class="o">|</span><span class="n">BUS_DMASYNC_PREWRITE</span><span class="p">);</span>
		<span class="n">pending_scb_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pending_scb_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_is_paused</span><span class="p">(</span><span class="n">ahc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">paused</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">paused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">saved_scbptr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
	<span class="cm">/* Ensure that the hscbs down on the card match the new information */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span>	<span class="n">hardware_scb</span> <span class="o">*</span><span class="n">pending_hscb</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">control</span><span class="p">;</span>
		<span class="n">u_int</span>	<span class="n">scb_tag</span><span class="p">;</span>

		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">scb_tag</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
		<span class="n">pending_scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_tag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pending_scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pending_hscb</span> <span class="o">=</span> <span class="n">pending_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ULTRAENB</span><span class="o">|</span><span class="n">MK_MESSAGE</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">pending_hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ULTRAENB</span><span class="o">|</span><span class="n">MK_MESSAGE</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_SCSIRATE</span><span class="p">,</span> <span class="n">pending_hscb</span><span class="o">-&gt;</span><span class="n">scsirate</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_SCSIOFFSET</span><span class="p">,</span> <span class="n">pending_hscb</span><span class="o">-&gt;</span><span class="n">scsioffset</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">saved_scbptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">paused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************** Pathing Information *****************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_fetch_devinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span>	<span class="n">saved_scsiid</span><span class="p">;</span>
	<span class="n">role_t</span>	<span class="n">role</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">our_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TARGET</span><span class="p">)</span>
		<span class="n">role</span> <span class="o">=</span> <span class="n">ROLE_TARGET</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">role</span> <span class="o">=</span> <span class="n">ROLE_INITIATOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_TARGET</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_TID</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">)</span>
 	   <span class="o">&amp;</span> <span class="p">(</span><span class="n">CMDPHASE_PENDING</span><span class="o">|</span><span class="n">TARG_CMD_PENDING</span><span class="o">|</span><span class="n">NO_DISCONNECT</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We were selected, so pull our id from TARGIDIN */</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGIDIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID_ULTRA2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OID</span><span class="p">;</span>

	<span class="n">saved_scsiid</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_SCSIID</span><span class="p">);</span>
	<span class="n">ahc_compile_devinfo</span><span class="p">(</span><span class="n">devinfo</span><span class="p">,</span>
			    <span class="n">our_id</span><span class="p">,</span>
			    <span class="n">SCSIID_TARGET</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">saved_scsiid</span><span class="p">),</span>
			    <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SAVED_LUN</span><span class="p">),</span>
			    <span class="n">SCSIID_CHANNEL</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">saved_scsiid</span><span class="p">),</span>
			    <span class="n">role</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_phase_table_entry</span><span class="o">*</span>
<span class="nf">ahc_lookup_phase_entry</span><span class="p">(</span><span class="kt">int</span> <span class="n">phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_phase_table_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_phase_table_entry</span> <span class="o">*</span><span class="n">last_entry</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * num_phases doesn&#39;t include the default entry which</span>
<span class="cm">	 * will be returned if the phase doesn&#39;t match.</span>
<span class="cm">	 */</span>
	<span class="n">last_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ahc_phase_table</span><span class="p">[</span><span class="n">num_phases</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">ahc_phase_table</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">last_entry</span><span class="p">;</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">phase</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_compile_devinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">our_id</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">target</span><span class="p">,</span>
		    <span class="n">u_int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="n">role_t</span> <span class="n">role</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span> <span class="o">=</span> <span class="n">our_id</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_offset</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
		<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_offset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_print_devinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%c:%d:%d: &quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
	       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_scb_devinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">role_t</span>	<span class="n">role</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">our_id</span><span class="p">;</span>

	<span class="n">our_id</span> <span class="o">=</span> <span class="n">SCSIID_OUR_ID</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">scsiid</span><span class="p">);</span>
	<span class="n">role</span> <span class="o">=</span> <span class="n">ROLE_INITIATOR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_TARGET_SCB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">role</span> <span class="o">=</span> <span class="n">ROLE_TARGET</span><span class="p">;</span>
	<span class="n">ahc_compile_devinfo</span><span class="p">(</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">our_id</span><span class="p">,</span> <span class="n">SCB_GET_TARGET</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">),</span>
			    <span class="n">SCB_GET_LUN</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="n">SCB_GET_CHANNEL</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">),</span> <span class="n">role</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/************************ Message Phase Processing ****************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_assert_atn</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">scsisigo</span><span class="p">;</span>

	<span class="n">scsisigo</span> <span class="o">=</span> <span class="n">ATNO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">scsisigo</span> <span class="o">|=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">,</span> <span class="n">scsisigo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When an initiator transaction with the MK_MESSAGE flag either reconnects</span>
<span class="cm"> * or enters the initial message out phase, we are interrupted.  Fill our</span>
<span class="cm"> * outgoing message buffer with the appropriate message and beging handing</span>
<span class="cm"> * the message phase(s) manually.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_setup_initiator_msgout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * To facilitate adding multiple messages together,</span>
<span class="cm">	 * each routine should increment the index and len</span>
<span class="cm">	 * variables instead of setting them explicitly.</span>
<span class="cm">	 */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_DEVICE_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">)</span> <span class="o">==</span> <span class="n">MSG_IDENTIFYFLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">identify_msg</span><span class="p">;</span>

		<span class="n">identify_msg</span> <span class="o">=</span> <span class="n">MSG_IDENTIFYFLAG</span> <span class="o">|</span> <span class="n">SCB_GET_LUN</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">DISCENB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">identify_msg</span> <span class="o">|=</span> <span class="n">MSG_IDENTIFY_DISCFLAG</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">identify_msg</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">TAG_ENB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TAG_ENB</span><span class="o">|</span><span class="n">SCB_TAG_TYPE</span><span class="p">);</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_DEVICE_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_BUS_DEV_RESET</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus Device Reset Message Sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clear our selection hardware in advance of</span>
<span class="cm">		 * the busfree.  We may have an entry in the waiting</span>
<span class="cm">		 * Q for this target, and we don&#39;t want to go about</span>
<span class="cm">		 * selecting while we handle the busfree and blow it</span>
<span class="cm">		 * away.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSELO</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ABORT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">TAG_ENB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_ABORT_TAG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_ABORT</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Abort%s Message Sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">TAG_ENB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot; Tag&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clear our selection hardware in advance of</span>
<span class="cm">		 * the busfree.  We may have an entry in the waiting</span>
<span class="cm">		 * Q for this target, and we don&#39;t want to go about</span>
<span class="cm">		 * selecting while we handle the busfree and blow it</span>
<span class="cm">		 * away.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSELO</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCB_AUTO_NEGOTIATE</span><span class="o">|</span><span class="n">SCB_NEGOTIATE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_build_transfer_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ahc_intr: AWAITING_MSG for an SCB that &quot;</span>
		       <span class="s">&quot;does not have a waiting message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSIID = %x, target_mask = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">scsiid</span><span class="p">,</span>
		       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_mask</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;SCB = %d, SCB Control = %x, MSG_OUT = %x &quot;</span>
		      <span class="s">&quot;SCB flags = %x&quot;</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span>
		      <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">),</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the MK_MESSAGE flag from the SCB so we aren&#39;t</span>
<span class="cm">	 * asked to send this message again.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MK_MESSAGE</span><span class="p">);</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MK_MESSAGE</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_INITIATOR_MSGOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build an appropriate transfer negotiation message for the</span>
<span class="cm"> * currently active target.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_build_transfer_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to initiate transfer negotiations.</span>
<span class="cm">	 * If our current and goal settings are identical,</span>
<span class="cm">	 * we want to renegotiate due to a check condition.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span>	<span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dowide</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">dosync</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">doppr</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">period</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">ppr_options</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">offset</span><span class="p">;</span>

	<span class="n">tinfo</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">,</span>
				    <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Filter our period based on the current connection.</span>
<span class="cm">	 * If we can&#39;t perform DT transfers on this segment (not in LVD</span>
<span class="cm">	 * mode for instance), then our decision to issue a PPR message</span>
<span class="cm">	 * may change.</span>
<span class="cm">	 */</span>
	<span class="n">period</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">period</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">ppr_options</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">ppr_options</span><span class="p">;</span>
	<span class="cm">/* Target initiated PPR is not allowed in the SCSI spec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_TARGET</span><span class="p">)</span>
		<span class="n">ppr_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">ahc_devlimited_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">period</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">ppr_options</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
	<span class="n">dowide</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">dosync</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">offset</span> <span class="o">||</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">period</span> <span class="o">!=</span> <span class="n">period</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Only use PPR if we have options that need it, even if the device</span>
<span class="cm">	 * claims to support it.  There might be an expander in the way</span>
<span class="cm">	 * that doesn&#39;t.</span>
<span class="cm">	 */</span>
	<span class="n">doppr</span> <span class="o">=</span> <span class="n">ppr_options</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dowide</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dosync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">doppr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dowide</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">;</span>
		<span class="n">dosync</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dowide</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dosync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">doppr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Force async with a WDTR message if we have a wide bus,</span>
<span class="cm">		 * or just issue an SDTR with a 0 offset.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dowide</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dosync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_print_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Ensuring async</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Target initiated PPR is not allowed in the SCSI spec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_TARGET</span><span class="p">)</span>
		<span class="n">doppr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Both the PPR message and SDTR message require the</span>
<span class="cm">	 * goal syncrate to be limited to what the target device</span>
<span class="cm">	 * is capable of handling (based on whether an LVD-&gt;SE</span>
<span class="cm">	 * expander is on the bus), so combine these two cases.</span>
<span class="cm">	 * Regardless, guarantee that if we are using WDTR and SDTR</span>
<span class="cm">	 * messages that WDTR comes first.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">doppr</span> <span class="o">||</span> <span class="p">(</span><span class="n">dosync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dowide</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">ahc_validate_offset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span>
				    <span class="n">doppr</span> <span class="o">?</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span>
					  <span class="o">:</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
				    <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">doppr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_construct_ppr</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
					  <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">ppr_options</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ahc_construct_sdtr</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ahc_construct_wdtr</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build a synchronous negotiation message in our message</span>
<span class="cm"> * buffer based on the input parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_construct_sdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
		   <span class="n">u_int</span> <span class="n">period</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">period</span> <span class="o">=</span> <span class="n">AHC_ASYNC_XFER_PERIOD</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">+=</span> <span class="n">spi_populate_sync_msg</span><span class="p">(</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span> <span class="o">+</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Sending SDTR period %x, offset %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
		       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build a wide negotiation message in our message</span>
<span class="cm"> * buffer based on the input parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_construct_wdtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
		   <span class="n">u_int</span> <span class="n">bus_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">+=</span> <span class="n">spi_populate_width_msg</span><span class="p">(</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span> <span class="o">+</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Sending WDTR %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
		       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build a parallel protocol request message in our message</span>
<span class="cm"> * buffer based on the input parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_construct_ppr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
		  <span class="n">u_int</span> <span class="n">period</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">bus_width</span><span class="p">,</span>
		  <span class="n">u_int</span> <span class="n">ppr_options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">period</span> <span class="o">=</span> <span class="n">AHC_ASYNC_XFER_PERIOD</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">+=</span> <span class="n">spi_populate_ppr_msg</span><span class="p">(</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span> <span class="o">+</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
			<span class="n">bus_width</span><span class="p">,</span> <span class="n">ppr_options</span><span class="p">);</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Sending PPR bus_width %x, period %x, &quot;</span>
		       <span class="s">&quot;offset %x, ppr_options %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span>
		       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
		       <span class="n">bus_width</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ppr_options</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear any active message state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_clear_msg_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATNI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The target didn&#39;t care to respond to our</span>
<span class="cm">		 * message request, so clear ATN.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRATNO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">,</span> <span class="n">MSG_NOOP</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS2</span><span class="p">,</span>
		 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TARGET_MSG_PENDING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_handle_proto_violation</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">ahc_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">scbid</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">seq_flags</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">curphase</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">lastphase</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">found</span><span class="p">;</span>

	<span class="n">ahc_fetch_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
	<span class="n">scbid</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
	<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbid</span><span class="p">);</span>
	<span class="n">seq_flags</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">);</span>
	<span class="n">curphase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHASE_MASK</span><span class="p">;</span>
	<span class="n">lastphase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">seq_flags</span> <span class="o">&amp;</span> <span class="n">NOT_IDENTIFIED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * The reconnecting target either did not send an</span>
<span class="cm">		 * identify message, or did, but we didn&#39;t find an SCB</span>
<span class="cm">		 * to match.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_print_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Target did not send an IDENTIFY message. &quot;</span>
		       <span class="s">&quot;LASTPHASE = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lastphase</span><span class="p">);</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t seem to have an SCB active for this</span>
<span class="cm">		 * transaction.  Print an error and reset the bus.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_print_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;No SCB found during protocol violation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">proto_violation_reset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">CAM_SEQUENCE_FAIL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">seq_flags</span> <span class="o">&amp;</span> <span class="n">NO_CDB_SENT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;No or incomplete CDB sent to device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STATUS_RCVD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The target never bothered to provide status to</span>
<span class="cm">			 * us prior to completing the command.  Since we don&#39;t</span>
<span class="cm">			 * know the disposition of this command, we must attempt</span>
<span class="cm">			 * to abort it.  Assert ATN and prepare to send an abort</span>
<span class="cm">			 * message.</span>
<span class="cm">			 */</span>
			<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Completed command without status.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown protocol violation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lastphase</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">P_DATAIN_DT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	 <span class="o">||</span> <span class="n">lastphase</span> <span class="o">==</span> <span class="n">P_COMMAND</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">proto_violation_reset:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Target either went directly to data/command</span>
<span class="cm">		 * phase or didn&#39;t respond to our ATN.</span>
<span class="cm">		 * The only safe thing to do is to blow</span>
<span class="cm">		 * it away with a bus reset.</span>
<span class="cm">		 */</span>
		<span class="n">found</span> <span class="o">=</span> <span class="n">ahc_reset_channel</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Issued Channel %c Bus Reset. &quot;</span>
		       <span class="s">&quot;%d SCBs aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Leave the selection hardware off in case</span>
<span class="cm">		 * this abort attempt will affect yet to</span>
<span class="cm">		 * be sent commands.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span>
			 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSELO</span><span class="p">);</span>
		<span class="n">ahc_assert_atn</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">,</span> <span class="n">HOST_MSG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_print_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_ABORT_TASK</span><span class="p">;</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_INITIATOR_MSGOUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_ABORT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Protocol violation %s.  Attempting to abort.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_lookup_phase_entry</span><span class="p">(</span><span class="n">curphase</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phasemsg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Manual message loop handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_handle_message_phase</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">ahc_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">bus_phase</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">end_session</span><span class="p">;</span>

	<span class="n">ahc_fetch_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
	<span class="n">end_session</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">bus_phase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHASE_MASK</span><span class="p">;</span>

<span class="nl">reswitch:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSG_TYPE_INITIATOR_MSGOUT</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">lastbyte</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">phasemis</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">msgdone</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;HOST_MSG_LOOP interrupt with no active message&quot;</span><span class="p">);</span>

<span class="cp">#ifdef AHC_DEBUG</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MESSAGES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_print_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;INITIATOR_MSG_OUT&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">phasemis</span> <span class="o">=</span> <span class="n">bus_phase</span> <span class="o">!=</span> <span class="n">P_MESGOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phasemis</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef AHC_DEBUG</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MESSAGES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; PHASEMIS %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ahc_lookup_phase_entry</span><span class="p">(</span><span class="n">bus_phase</span><span class="p">)</span>
							     <span class="o">-&gt;</span><span class="n">phasemsg</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_phase</span> <span class="o">==</span> <span class="n">P_MESGIN</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Change gears and see if</span>
<span class="cm">				 * this messages is of interest to</span>
<span class="cm">				 * us or should be passed back to</span>
<span class="cm">				 * the sequencer.</span>
<span class="cm">				 */</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRATNO</span><span class="p">);</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">send_msg_perror</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_INITIATOR_MSGIN</span><span class="p">;</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">reswitch</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">end_session</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">send_msg_perror</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRATNO</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRREQINIT</span><span class="p">);</span>
<span class="cp">#ifdef AHC_DEBUG</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MESSAGES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; byte 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">send_msg_perror</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIDATL</span><span class="p">,</span> <span class="n">MSG_PARITY_ERROR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msgdone</span>	<span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">==</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msgdone</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The target has requested a retry.</span>
<span class="cm">			 * Re-assert ATN, reset our message index to</span>
<span class="cm">			 * 0, and try again.</span>
<span class="cm">			 */</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ahc_assert_atn</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lastbyte</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lastbyte</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Last byte is signified by dropping ATN */</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRATNO</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Clear our interrupt status and present</span>
<span class="cm">		 * the next byte on the bus.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRREQINIT</span><span class="p">);</span>
<span class="cp">#ifdef AHC_DEBUG</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MESSAGES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; byte 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIDATL</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="o">++</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MSG_TYPE_INITIATOR_MSGIN</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">phasemis</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">message_done</span><span class="p">;</span>

<span class="cp">#ifdef AHC_DEBUG</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MESSAGES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_print_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;INITIATOR_MSG_IN&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">phasemis</span> <span class="o">=</span> <span class="n">bus_phase</span> <span class="o">!=</span> <span class="n">P_MESGIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phasemis</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef AHC_DEBUG</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MESSAGES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; PHASEMIS %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ahc_lookup_phase_entry</span><span class="p">(</span><span class="n">bus_phase</span><span class="p">)</span>
							     <span class="o">-&gt;</span><span class="n">phasemsg</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_phase</span> <span class="o">==</span> <span class="n">P_MESGOUT</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">send_msg_perror</span> <span class="o">==</span> <span class="n">TRUE</span>
			  <span class="o">||</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">!=</span> <span class="mi">0</span>
			   <span class="o">&amp;&amp;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_INITIATOR_MSGOUT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">reswitch</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">end_session</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Pull the byte in without acking it */</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIBUSL</span><span class="p">);</span>
<span class="cp">#ifdef AHC_DEBUG</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MESSAGES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; byte 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span><span class="p">]);</span>
<span class="cp">#endif</span>

		<span class="n">message_done</span> <span class="o">=</span> <span class="n">ahc_parse_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">message_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Clear our incoming message buffer in case there</span>
<span class="cm">			 * is another message following this one.</span>
<span class="cm">			 */</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * If this message illicited a response,</span>
<span class="cm">			 * assert ATN so the target takes us to the</span>
<span class="cm">			 * message out phase.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef AHC_DEBUG</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MESSAGES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ahc_print_devinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Asserting ATN for response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
				<span class="n">ahc_assert_atn</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> 
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">message_done</span> <span class="o">==</span> <span class="n">MSGLOOP_TERMINATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">end_session</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Ack the byte */</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRSINT1</span><span class="p">,</span> <span class="n">CLRREQINIT</span><span class="p">);</span>
			<span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIDATL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MSG_TYPE_TARGET_MSGIN</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">msgdone</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">msgout_request</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Target MSGIN with no active message&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we interrupted a mesgout session, the initiator</span>
<span class="cm">		 * will not know this until our first REQ.  So, we</span>
<span class="cm">		 * only honor mesgout requests after we&#39;ve sent our</span>
<span class="cm">		 * first byte.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATNI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">msgout_request</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">msgout_request</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msgout_request</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * Change gears and see if</span>
<span class="cm">			 * this messages is of interest to</span>
<span class="cm">			 * us or should be passed back to</span>
<span class="cm">			 * the sequencer.</span>
<span class="cm">			 */</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_TARGET_MSGOUT</span><span class="p">;</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">,</span> <span class="n">P_MESGOUT</span> <span class="o">|</span> <span class="n">BSYO</span><span class="p">);</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Dummy read to REQ for first byte */</span>
			<span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIDATL</span><span class="p">);</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span>
				 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPIOEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msgdone</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">==</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msgdone</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span>
				 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SPIOEN</span><span class="p">);</span>
			<span class="n">end_session</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Present the next byte on the bus.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPIOEN</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIDATL</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span><span class="o">++</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MSG_TYPE_TARGET_MSGOUT</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">lastbyte</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">msgdone</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The initiator signals that this is</span>
<span class="cm">		 * the last byte by dropping ATN.</span>
<span class="cm">		 */</span>
		<span class="n">lastbyte</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATNI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Read the latched byte, but turn off SPIOEN first</span>
<span class="cm">		 * so that we don&#39;t inadvertently cause a REQ for the</span>
<span class="cm">		 * next byte.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SPIOEN</span><span class="p">);</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIDATL</span><span class="p">);</span>
		<span class="n">msgdone</span> <span class="o">=</span> <span class="n">ahc_parse_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msgdone</span> <span class="o">==</span> <span class="n">MSGLOOP_TERMINATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The message is *really* done in that it caused</span>
<span class="cm">			 * us to go to bus free.  The sequencer has already</span>
<span class="cm">			 * been reset at this point, so pull the ejection</span>
<span class="cm">			 * handle.</span>
<span class="cm">			 */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * XXX Read spec about initiator dropping ATN too soon</span>
<span class="cm">		 *     and use msgdone to detect it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msgdone</span> <span class="o">==</span> <span class="n">MSGLOOP_MSGCOMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * If this message illicited a response, transition</span>
<span class="cm">			 * to the Message in phase and send it.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGO</span><span class="p">,</span> <span class="n">P_MESGIN</span> <span class="o">|</span> <span class="n">BSYO</span><span class="p">);</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span>
					 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPIOEN</span><span class="p">);</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_TARGET_MSGIN</span><span class="p">;</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lastbyte</span><span class="p">)</span>
			<span class="n">end_session</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Ask for the next byte. */</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span>
				 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPIOEN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unknown REQINIT message type&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end_session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_clear_msg_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">RETURN_1</span><span class="p">,</span> <span class="n">EXIT_MSG_LOOP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">RETURN_1</span><span class="p">,</span> <span class="n">CONT_MSG_LOOP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * See if we sent a particular extended message to the target.</span>
<span class="cm"> * If &quot;full&quot; is true, return true only if the target saw the full</span>
<span class="cm"> * message.  If &quot;full&quot; is false, return true if the target saw at</span>
<span class="cm"> * least the first byte of the message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ahc_sent_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc_msgtype</span> <span class="n">type</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">msgval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">full</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">found</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">found</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">MSG_EXTENDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_int</span> <span class="n">end_index</span><span class="p">;</span>

			<span class="n">end_index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">msgval</span>
			 <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">AHCMSG_EXT</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">&gt;</span> <span class="n">end_index</span><span class="p">)</span>
						<span class="n">found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">)</span>
					<span class="n">found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">end_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MSG_SIMPLE_TASK</span>
			<span class="o">&amp;&amp;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">MSG_IGN_WIDE_RESIDUE</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Skip tag type and tag id or residue param*/</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Single byte message */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AHCMSG_1B</span>
			 <span class="o">&amp;&amp;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">msgval</span>
			 <span class="o">&amp;&amp;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">)</span>
				<span class="n">found</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">found</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for a complete incoming message, parse it, and respond accordingly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ahc_parse_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">reject</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">response</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">targ_scsirate</span><span class="p">;</span>

	<span class="n">done</span> <span class="o">=</span> <span class="n">MSGLOOP_IN_PROG</span><span class="p">;</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">reject</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">tinfo</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">,</span>
				    <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>
	<span class="n">targ_scsirate</span> <span class="o">=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">scsirate</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Parse as much of the message as is available,</span>
<span class="cm">	 * rejecting it if we don&#39;t support it.  When</span>
<span class="cm">	 * the entire message is available and has been</span>
<span class="cm">	 * handled, return MSGLOOP_MSGCOMPLETE, indicating</span>
<span class="cm">	 * that we have parsed an entire message.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In the case of extended messages, we accept the length</span>
<span class="cm">	 * byte outright and perform more checking once we know the</span>
<span class="cm">	 * extended message type.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSG_DISCONNECT</span>:
	<span class="k">case</span> <span class="n">MSG_SAVEDATAPOINTER</span>:
	<span class="k">case</span> <span class="n">MSG_CMDCOMPLETE</span>:
	<span class="k">case</span> <span class="n">MSG_RESTOREPOINTERS</span>:
	<span class="k">case</span> <span class="n">MSG_IGN_WIDE_RESIDUE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * End our message loop as these are messages</span>
<span class="cm">		 * the sequencer handles on its own.</span>
<span class="cm">		 */</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">MSGLOOP_TERMINATED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSG_MESSAGE_REJECT</span>:
		<span class="n">response</span> <span class="o">=</span> <span class="n">ahc_handle_msg_reject</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">);</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="n">MSG_NOOP</span>:
		<span class="n">done</span> <span class="o">=</span> <span class="n">MSGLOOP_MSGCOMPLETE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSG_EXTENDED</span>:
	<span class="p">{</span>
		<span class="cm">/* Wait for enough of the message to begin validation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MSG_EXT_SDTR</span>:
		<span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">;</span>
			<span class="n">u_int</span>	 <span class="n">period</span><span class="p">;</span>
			<span class="n">u_int</span>	 <span class="n">ppr_options</span><span class="p">;</span>
			<span class="n">u_int</span>	 <span class="n">offset</span><span class="p">;</span>
			<span class="n">u_int</span>	 <span class="n">saved_offset</span><span class="p">;</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MSG_EXT_SDTR_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Wait until we have both args before validating</span>
<span class="cm">			 * and acting on this message.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Add one to MSG_EXT_SDTR_LEN to account for</span>
<span class="cm">			 * the extended message preamble.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MSG_EXT_SDTR_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">period</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">ppr_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">saved_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">syncrate</span> <span class="o">=</span> <span class="n">ahc_devlimited_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">period</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">ppr_options</span><span class="p">,</span>
							   <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
			<span class="n">ahc_validate_offset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="n">syncrate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span>
					    <span class="n">targ_scsirate</span> <span class="o">&amp;</span> <span class="n">WIDEXFER</span><span class="p">,</span>
					    <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Received &quot;</span>
				       <span class="s">&quot;SDTR period %x, offset %x</span><span class="se">\n\t</span><span class="s">&quot;</span>
				       <span class="s">&quot;Filtered to period %x, offset %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
				       <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">saved_offset</span><span class="p">,</span>
				       <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ahc_set_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> 
					 <span class="n">syncrate</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span>
					 <span class="n">offset</span><span class="p">,</span> <span class="n">ppr_options</span><span class="p">,</span>
					 <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="p">,</span>
					 <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * See if we initiated Sync Negotiation</span>
<span class="cm">			 * and didn&#39;t have to fall down to async</span>
<span class="cm">			 * transfers.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_EXT</span><span class="p">,</span> <span class="n">MSG_EXT_SDTR</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* We started it */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">saved_offset</span> <span class="o">!=</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Went too low - force async */</span>
					<span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Send our own SDTR in reply</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span>
				 <span class="o">&amp;&amp;</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_INITIATOR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Target &quot;</span>
					       <span class="s">&quot;Initiated SDTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahc_construct_sdtr</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span>
						   <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">response</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">done</span> <span class="o">=</span> <span class="n">MSGLOOP_MSGCOMPLETE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">MSG_EXT_WDTR</span>:
		<span class="p">{</span>
			<span class="n">u_int</span> <span class="n">bus_width</span><span class="p">;</span>
			<span class="n">u_int</span> <span class="n">saved_width</span><span class="p">;</span>
			<span class="n">u_int</span> <span class="n">sending_reply</span><span class="p">;</span>

			<span class="n">sending_reply</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MSG_EXT_WDTR_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Wait until we have our arg before validating</span>
<span class="cm">			 * and acting on this message.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Add one to MSG_EXT_WDTR_LEN to account for</span>
<span class="cm">			 * the extended message preamble.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MSG_EXT_WDTR_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">saved_width</span> <span class="o">=</span> <span class="n">bus_width</span><span class="p">;</span>
			<span class="n">ahc_validate_width</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_width</span><span class="p">,</span>
					   <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Received WDTR &quot;</span>
				       <span class="s">&quot;%x filtered to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
				       <span class="n">saved_width</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_EXT</span><span class="p">,</span> <span class="n">MSG_EXT_WDTR</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Don&#39;t send a WDTR back to the</span>
<span class="cm">				 * target, since we asked first.</span>
<span class="cm">				 * If the width went higher than our</span>
<span class="cm">				 * request, reject it.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">saved_width</span> <span class="o">&gt;</span> <span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): requested %dBit &quot;</span>
					       <span class="s">&quot;transfers.  Rejecting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
					       <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">bus_width</span><span class="p">));</span>
					<span class="n">bus_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Send our own WDTR in reply</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span>
				 <span class="o">&amp;&amp;</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_INITIATOR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Target &quot;</span>
					       <span class="s">&quot;Initiated WDTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahc_construct_wdtr</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">response</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="n">sending_reply</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * After a wide message, we are async, but</span>
<span class="cm">			 * some devices don&#39;t seem to honor this portion</span>
<span class="cm">			 * of the spec.  Force a renegotiation of the</span>
<span class="cm">			 * sync component of our transfer agreement even</span>
<span class="cm">			 * if our goal is async.  By updating our width</span>
<span class="cm">			 * after forcing the negotiation, we avoid</span>
<span class="cm">			 * renegotiating for width.</span>
<span class="cm">			 */</span>
			<span class="n">ahc_update_neg_request</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">tstate</span><span class="p">,</span>
					       <span class="n">tinfo</span><span class="p">,</span> <span class="n">AHC_NEG_ALWAYS</span><span class="p">);</span>
			<span class="n">ahc_set_width</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span>
				      <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="p">,</span>
				      <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sending_reply</span> <span class="o">==</span> <span class="n">FALSE</span> <span class="o">&amp;&amp;</span> <span class="n">reject</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/*</span>
<span class="cm">				 * We will always have an SDTR to send.</span>
<span class="cm">				 */</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahc_build_transfer_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">);</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">response</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">done</span> <span class="o">=</span> <span class="n">MSGLOOP_MSGCOMPLETE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">MSG_EXT_PPR</span>:
		<span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">ahc_syncrate</span> <span class="o">*</span><span class="n">syncrate</span><span class="p">;</span>
			<span class="n">u_int</span>	<span class="n">period</span><span class="p">;</span>
			<span class="n">u_int</span>	<span class="n">offset</span><span class="p">;</span>
			<span class="n">u_int</span>	<span class="n">bus_width</span><span class="p">;</span>
			<span class="n">u_int</span>	<span class="n">ppr_options</span><span class="p">;</span>
			<span class="n">u_int</span>	<span class="n">saved_width</span><span class="p">;</span>
			<span class="n">u_int</span>	<span class="n">saved_offset</span><span class="p">;</span>
			<span class="n">u_int</span>	<span class="n">saved_ppr_options</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MSG_EXT_PPR_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Wait until we have all args before validating</span>
<span class="cm">			 * and acting on this message.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Add one to MSG_EXT_PPR_LEN to account for</span>
<span class="cm">			 * the extended message preamble.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MSG_EXT_PPR_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">period</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="n">saved_width</span> <span class="o">=</span> <span class="n">bus_width</span><span class="p">;</span>
			<span class="n">ppr_options</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
			<span class="cm">/*</span>
<span class="cm">			 * According to the spec, a DT only</span>
<span class="cm">			 * period factor with no DT option</span>
<span class="cm">			 * set implies async.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ppr_options</span> <span class="o">&amp;</span> <span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			 <span class="o">&amp;&amp;</span> <span class="n">period</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">saved_ppr_options</span> <span class="o">=</span> <span class="n">ppr_options</span><span class="p">;</span>
			<span class="n">saved_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Mask out any options we don&#39;t support</span>
<span class="cm">			 * on any controller.  Transfer options are</span>
<span class="cm">			 * only available if we are negotiating wide.</span>
<span class="cm">			 */</span>
			<span class="n">ppr_options</span> <span class="o">&amp;=</span> <span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ppr_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ahc_validate_width</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_width</span><span class="p">,</span>
					   <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
			<span class="n">syncrate</span> <span class="o">=</span> <span class="n">ahc_devlimited_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">period</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">ppr_options</span><span class="p">,</span>
							   <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
			<span class="n">ahc_validate_offset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">tinfo</span><span class="p">,</span> <span class="n">syncrate</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span>
					    <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_EXT</span><span class="p">,</span> <span class="n">MSG_EXT_PPR</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * If we are unable to do any of the</span>
<span class="cm">				 * requested options (we went too low),</span>
<span class="cm">				 * then we&#39;ll have to reject the message.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">saved_width</span> <span class="o">&gt;</span> <span class="n">bus_width</span>
				 <span class="o">||</span> <span class="n">saved_offset</span> <span class="o">!=</span> <span class="n">offset</span>
				 <span class="o">||</span> <span class="n">saved_ppr_options</span> <span class="o">!=</span> <span class="n">ppr_options</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
					<span class="n">period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">bus_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">ppr_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">syncrate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">!=</span> <span class="n">ROLE_TARGET</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Target &quot;</span>
					       <span class="s">&quot;Initiated PPR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Initiator &quot;</span>
					       <span class="s">&quot;Initiated PPR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ahc_construct_ppr</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						  <span class="n">bus_width</span><span class="p">,</span> <span class="n">ppr_options</span><span class="p">);</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">response</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): Received PPR width %x, &quot;</span>
				       <span class="s">&quot;period %x, offset %x,options %x</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;</span><span class="se">\t</span><span class="s">Filtered to width %x, period %x, &quot;</span>
				       <span class="s">&quot;offset %x, options %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
				       <span class="n">saved_width</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				       <span class="n">saved_offset</span><span class="p">,</span> <span class="n">saved_ppr_options</span><span class="p">,</span>
				       <span class="n">bus_width</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ppr_options</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ahc_set_width</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span>
				      <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="p">,</span>
				      <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
			<span class="n">ahc_set_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span>
					 <span class="n">syncrate</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span>
					 <span class="n">offset</span><span class="p">,</span> <span class="n">ppr_options</span><span class="p">,</span>
					 <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="p">,</span>
					 <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
			<span class="n">done</span> <span class="o">=</span> <span class="n">MSGLOOP_MSGCOMPLETE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="cm">/* Unknown extended message.  Reject it. */</span>
			<span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
	<span class="k">case</span> <span class="n">MSG_BUS_DEV_RESET</span>:
		<span class="n">ahc_handle_devreset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span>
				    <span class="n">CAM_BDR_SENT</span><span class="p">,</span>
				    <span class="s">&quot;Bus Device Reset Received&quot;</span><span class="p">,</span>
				    <span class="cm">/*verbose_level*/</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">MSGLOOP_TERMINATED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSG_ABORT_TAG</span>:
	<span class="k">case</span> <span class="n">MSG_ABORT</span>:
	<span class="k">case</span> <span class="n">MSG_CLEAR_QUEUE</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>

		<span class="cm">/* Target mode messages */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">!=</span> <span class="n">ROLE_TARGET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MSG_ABORT_TAG</span><span class="p">)</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">INITIATOR_TAG</span><span class="p">);</span>
		<span class="n">ahc_abort_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ROLE_TARGET</span><span class="p">,</span>
			       <span class="n">CAM_REQ_ABORTED</span><span class="p">);</span>

		<span class="n">tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ahc_tmode_lstate</span><span class="o">*</span> <span class="n">lstate</span><span class="p">;</span>

			<span class="n">lstate</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">[</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ahc_queue_lstate_event</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">lstate</span><span class="p">,</span>
						       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">,</span>
						       <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgin_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						       <span class="cm">/*arg*/</span><span class="n">tag</span><span class="p">);</span>
				<span class="n">ahc_send_lstate_events</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">lstate</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">MSGLOOP_TERMINATED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">MSG_TERM_IO_PROC</span>:
	<span class="nl">default:</span>
		<span class="n">reject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reject</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Setup to reject the message.</span>
<span class="cm">		 */</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSG_MESSAGE_REJECT</span><span class="p">;</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">MSGLOOP_MSGCOMPLETE</span><span class="p">;</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">!=</span> <span class="n">MSGLOOP_IN_PROG</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">response</span><span class="p">)</span>
		<span class="cm">/* Clear the outgoing message buffer */</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process a message reject message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ahc_handle_msg_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * What we care about here is if we had an</span>
<span class="cm">	 * outstanding SDTR or WDTR message for this</span>
<span class="cm">	 * target.  If we did, this is a signal that</span>
<span class="cm">	 * the target is refusing negotiation.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">scb_index</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">last_msg</span><span class="p">;</span>
	<span class="kt">int</span>   <span class="n">response</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
	<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
	<span class="n">tinfo</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				    <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">,</span>
				    <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>
	<span class="cm">/* Might be necessary */</span>
	<span class="n">last_msg</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LAST_MSG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_EXT</span><span class="p">,</span> <span class="n">MSG_EXT_PPR</span><span class="p">,</span> <span class="cm">/*full*/</span><span class="n">FALSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Target does not support the PPR message.</span>
<span class="cm">		 * Attempt to negotiate SPI-2 style.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): PPR Rejected. &quot;</span>
			       <span class="s">&quot;Trying WDTR/SDTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">transport_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">transport_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ahc_build_transfer_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">);</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">response</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_EXT</span><span class="p">,</span> <span class="n">MSG_EXT_WDTR</span><span class="p">,</span> <span class="cm">/*full*/</span><span class="n">FALSE</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* note 8bit xfers */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): refuses WIDE negotiation.  Using &quot;</span>
		       <span class="s">&quot;8bit transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span>
		       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
		<span class="n">ahc_set_width</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">,</span>
			      <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="p">,</span>
			      <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * No need to clear the sync rate.  If the target</span>
<span class="cm">		 * did not accept the command, our syncrate is</span>
<span class="cm">		 * unaffected.  If the target started the negotiation,</span>
<span class="cm">		 * but rejected our response, we already cleared the</span>
<span class="cm">		 * sync rate before sending our WDTR.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Start the sync negotiation */</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ahc_build_transfer_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">);</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">response</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahc_sent_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">AHCMSG_EXT</span><span class="p">,</span> <span class="n">MSG_EXT_SDTR</span><span class="p">,</span> <span class="cm">/*full*/</span><span class="n">FALSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* note asynch xfers and clear flag */</span>
		<span class="n">ahc_set_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="cm">/*syncrate*/</span><span class="nb">NULL</span><span class="p">,</span> <span class="cm">/*period*/</span><span class="mi">0</span><span class="p">,</span>
				 <span class="cm">/*offset*/</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/*ppr_options*/</span><span class="mi">0</span><span class="p">,</span>
				 <span class="n">AHC_TRANS_ACTIVE</span><span class="o">|</span><span class="n">AHC_TRANS_GOAL</span><span class="p">,</span>
				 <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): refuses synchronous negotiation. &quot;</span>
		       <span class="s">&quot;Using asynchronous transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
		       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">MSG_SIMPLE_TASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tag_type</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">tag_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">MSG_SIMPLE_TASK</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tag_type</span> <span class="o">==</span> <span class="n">MSG_SIMPLE_TASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): refuses tagged commands.  &quot;</span>
			       <span class="s">&quot;Performing non-tagged I/O</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span>
			       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">ahc_set_tags</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">AHC_QUEUE_NONE</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0x23</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(%s:%c:%d:%d): refuses %s tagged commands.  &quot;</span>
			       <span class="s">&quot;Performing simple queue tagged I/O only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
			       <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="n">MSG_ORDERED_TASK</span>
			       <span class="o">?</span> <span class="s">&quot;ordered&quot;</span> <span class="o">:</span> <span class="s">&quot;head of queue&quot;</span><span class="p">);</span>
			<span class="n">ahc_set_tags</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">AHC_QUEUE_BASIC</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Resend the identify for this CCB as the target</span>
<span class="cm">		 * may believe that the selection is invalid otherwise.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">,</span>
			 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	 	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">ahc_set_transaction_tag</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="cm">/*enabled*/</span><span class="n">FALSE</span><span class="p">,</span>
					<span class="cm">/*type*/</span><span class="n">MSG_SIMPLE_TASK</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">,</span> <span class="n">MSG_IDENTIFYFLAG</span><span class="p">);</span>
		<span class="n">ahc_assert_atn</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * This transaction is now at the head of</span>
<span class="cm">		 * the untagged queue for this target.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SCB_BTT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">scb_tailq</span> <span class="o">*</span><span class="n">untagged_q</span><span class="p">;</span>

			<span class="n">untagged_q</span> <span class="o">=</span>
			    <span class="o">&amp;</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">untagged_queues</span><span class="p">[</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target_offset</span><span class="p">]);</span>
			<span class="n">TAILQ_INSERT_HEAD</span><span class="p">(</span><span class="n">untagged_q</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">links</span><span class="p">.</span><span class="n">tqe</span><span class="p">);</span>
			<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SCB_UNTAGGEDQ</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ahc_busy_tcl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUILD_TCL</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">scsiid</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">),</span>
			     <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Requeue all tagged commands for this target</span>
<span class="cm">		 * currently in our possession so they can be</span>
<span class="cm">		 * converted to untagged commands.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_search_qinfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_GET_TARGET</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">),</span>
				   <span class="n">SCB_GET_CHANNEL</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">),</span>
				   <span class="n">SCB_GET_LUN</span><span class="p">(</span><span class="n">scb</span><span class="p">),</span> <span class="cm">/*tag*/</span><span class="n">SCB_LIST_NULL</span><span class="p">,</span>
				   <span class="n">ROLE_INITIATOR</span><span class="p">,</span> <span class="n">CAM_REQUEUE_REQ</span><span class="p">,</span>
				   <span class="n">SEARCH_COMPLETE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Otherwise, we ignore it.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%c:%d: Message reject for %x -- ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
		       <span class="n">last_msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process an ingnore wide residue message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_handle_ign_wide_residue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">scb_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>

	<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
	<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX Actually check data direction in the sequencer?</span>
<span class="cm">	 * Perhaps add datadir to some spare bits in the hscb?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPHASE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	 <span class="o">||</span> <span class="n">ahc_get_transfer_dir</span><span class="p">(</span><span class="n">scb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CAM_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ignore the message if we haven&#39;t</span>
<span class="cm">		 * seen an appropriate data phase yet.</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the residual occurred on the last</span>
<span class="cm">		 * transfer and the transfer request was</span>
<span class="cm">		 * expected to end on an odd count, do</span>
<span class="cm">		 * nothing.  Otherwise, subtract a byte</span>
<span class="cm">		 * and update the residual count accordingly.</span>
<span class="cm">		 */</span>
		<span class="kt">uint32_t</span> <span class="n">sgptr</span><span class="p">;</span>

		<span class="n">sgptr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_SGPTR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sgptr</span> <span class="o">&amp;</span> <span class="n">SG_LIST_NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_LUN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCB_XFERLEN_ODD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the residual occurred on the last</span>
<span class="cm">			 * transfer and the transfer request was</span>
<span class="cm">			 * expected to end on an odd count, do</span>
<span class="cm">			 * nothing.</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ahc_dma_seg</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">data_cnt</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">data_addr</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">sglen</span><span class="p">;</span>

			<span class="cm">/* Pull in all of the sgptr */</span>
			<span class="n">sgptr</span> <span class="o">=</span> <span class="n">ahc_inl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_SGPTR</span><span class="p">);</span>
			<span class="n">data_cnt</span> <span class="o">=</span> <span class="n">ahc_inl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_DATACNT</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">sgptr</span> <span class="o">&amp;</span> <span class="n">SG_LIST_NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * The residual data count is not updated</span>
<span class="cm">				 * for the command run to completion case.</span>
<span class="cm">				 * Explicitly zero the count.</span>
<span class="cm">				 */</span>
				<span class="n">data_cnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_SG_LEN_MASK</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">data_addr</span> <span class="o">=</span> <span class="n">ahc_inl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SHADDR</span><span class="p">);</span>

			<span class="n">data_cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">data_addr</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sgptr</span> <span class="o">&amp;=</span> <span class="n">SG_PTR_MASK</span><span class="p">;</span>

			<span class="n">sg</span> <span class="o">=</span> <span class="n">ahc_sg_bus_to_virt</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">sgptr</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * The residual sg ptr points to the next S/G</span>
<span class="cm">			 * to load so we must go back one.</span>
<span class="cm">			 */</span>
			<span class="n">sg</span><span class="o">--</span><span class="p">;</span>
			<span class="n">sglen</span> <span class="o">=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AHC_SG_LEN_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sg</span> <span class="o">!=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">sg_list</span>
			 <span class="o">&amp;&amp;</span> <span class="n">sglen</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">data_cnt</span> <span class="o">&amp;</span> <span class="n">AHC_SG_LEN_MASK</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">sg</span><span class="o">--</span><span class="p">;</span>
				<span class="n">sglen</span> <span class="o">=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Preserve High Address and SG_LIST bits</span>
<span class="cm">				 * while setting the count to 1.</span>
<span class="cm">				 */</span>
				<span class="n">data_cnt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="n">sglen</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">AHC_SG_LEN_MASK</span><span class="p">));</span>
				<span class="n">data_addr</span> <span class="o">=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
					  <span class="o">+</span> <span class="p">(</span><span class="n">sglen</span> <span class="o">&amp;</span> <span class="n">AHC_SG_LEN_MASK</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Increment sg so it points to the</span>
<span class="cm">				 * &quot;next&quot; sg.</span>
<span class="cm">				 */</span>
				<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sgptr</span> <span class="o">=</span> <span class="n">ahc_sg_virt_to_bus</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ahc_outl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_SGPTR</span><span class="p">,</span> <span class="n">sgptr</span><span class="p">);</span>
			<span class="n">ahc_outl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_DATACNT</span><span class="p">,</span> <span class="n">data_cnt</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Toggle the &quot;oddness&quot; of the transfer length</span>
<span class="cm">			 * to handle this mid-transfer ignore wide</span>
<span class="cm">			 * residue.  This ensures that the oddness is</span>
<span class="cm">			 * correct for subsequent data transfers.</span>
<span class="cm">			 */</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_LUN</span><span class="p">,</span>
				 <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_LUN</span><span class="p">)</span> <span class="o">^</span> <span class="n">SCB_XFERLEN_ODD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Reinitialize the data pointers for the active transfer</span>
<span class="cm"> * based on its current residual.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_reinitialize_dataptrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	 <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="k">struct</span>	 <span class="n">ahc_dma_seg</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">u_int</span>	 <span class="n">scb_index</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sgptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">resid</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dataptr</span><span class="p">;</span>

	<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
	<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
	<span class="n">sgptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_SGPTR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_SGPTR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_SGPTR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
	      <span class="o">|</span>	<span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_SGPTR</span><span class="p">);</span>

	<span class="n">sgptr</span> <span class="o">&amp;=</span> <span class="n">SG_PTR_MASK</span><span class="p">;</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">ahc_sg_bus_to_virt</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">sgptr</span><span class="p">);</span>

	<span class="cm">/* The residual sg_ptr always points to the next sg */</span>
	<span class="n">sg</span><span class="o">--</span><span class="p">;</span>

	<span class="n">resid</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_DATACNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
	      <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_DATACNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
	      <span class="o">|</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_RESIDUAL_DATACNT</span><span class="p">);</span>

	<span class="n">dataptr</span> <span class="o">=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="o">+</span> <span class="p">(</span><span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AHC_SG_LEN_MASK</span><span class="p">)</span>
		<span class="o">-</span> <span class="n">resid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_39BIT_ADDRESSING</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">dscommand1</span><span class="p">;</span>

		<span class="n">dscommand1</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DSCOMMAND1</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DSCOMMAND1</span><span class="p">,</span> <span class="n">dscommand1</span> <span class="o">|</span> <span class="n">HADDLDSEL0</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HADDR</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SG_HIGH_ADDR_BITS</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DSCOMMAND1</span><span class="p">,</span> <span class="n">dscommand1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dataptr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dataptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dataptr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HADDR</span><span class="p">,</span> <span class="n">dataptr</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">resid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">resid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNT</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">STCNT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">resid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">STCNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">resid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">STCNT</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle the effects of issuing a bus device reset message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_handle_devreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
		    <span class="n">cam_status</span> <span class="n">status</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span> <span class="kt">int</span> <span class="n">verbose_level</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
	<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span><span class="o">*</span> <span class="n">tstate</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">lun</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">found</span><span class="p">;</span>

	<span class="n">found</span> <span class="o">=</span> <span class="n">ahc_abort_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			       <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">,</span>
			       <span class="n">status</span><span class="p">);</span>

<span class="cp">#ifdef AHC_TARGET_MODE</span>
	<span class="cm">/*</span>
<span class="cm">	 * Send an immediate notify ccb to all target mord peripheral</span>
<span class="cm">	 * drivers affected by this action.</span>
<span class="cm">	 */</span>
	<span class="n">tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">AHC_NUM_LUNS</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ahc_tmode_lstate</span><span class="o">*</span> <span class="n">lstate</span><span class="p">;</span>

			<span class="n">lstate</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">[</span><span class="n">lun</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ahc_queue_lstate_event</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">lstate</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">our_scsiid</span><span class="p">,</span>
					       <span class="n">MSG_BUS_DEV_RESET</span><span class="p">,</span> <span class="cm">/*arg*/</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">ahc_send_lstate_events</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">lstate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Go back to async/narrow transfers and renegotiate.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_set_width</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">,</span>
		      <span class="n">AHC_TRANS_CUR</span><span class="p">,</span> <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
	<span class="n">ahc_set_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">,</span> <span class="cm">/*syncrate*/</span><span class="nb">NULL</span><span class="p">,</span>
			 <span class="cm">/*period*/</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/*offset*/</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/*ppr_options*/</span><span class="mi">0</span><span class="p">,</span>
			 <span class="n">AHC_TRANS_CUR</span><span class="p">,</span> <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CAM_SEL_TIMEOUT</span><span class="p">)</span>
		<span class="n">ahc_send_async</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span>
			       <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span> <span class="n">AC_SENT_BDR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">!=</span> <span class="nb">NULL</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">verbose_level</span> <span class="o">&lt;=</span> <span class="n">bootverbose</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s on %c:%d. %d SCBs aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span>
		       <span class="n">message</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">devinfo</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef AHC_TARGET_MODE</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_setup_target_msgin</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="o">*</span><span class="n">devinfo</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*              </span>
<span class="cm">	 * To facilitate adding multiple messages together,</span>
<span class="cm">	 * each routine should increment the index and len</span>
<span class="cm">	 * variables instead of setting them explicitly.</span>
<span class="cm">	 */</span>             
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_AUTO_NEGOTIATE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_build_transfer_msg</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;ahc_intr: AWAITING target message with no message&quot;</span><span class="p">);</span>

	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msgout_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">MSG_TYPE_TARGET_MSGIN</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cm">/**************************** Initialization **********************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Allocate a controller structure for a new device</span>
<span class="cm"> * and perform initial initializion.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span>
<span class="nf">ahc_alloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">platform_arg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>  <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

<span class="cp">#ifndef	__FreeBSD__</span>
	<span class="n">ahc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ahc</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ahc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;aic7xxx: cannot malloc softc!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">ahc</span> <span class="o">=</span> <span class="n">device_get_softc</span><span class="p">((</span><span class="n">device_t</span><span class="p">)</span><span class="n">platform_arg</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ahc</span><span class="p">));</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seep_config</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seep_config</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seep_config</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef	__FreeBSD__</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">LIST_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_scbs</span><span class="p">);</span>
	<span class="cm">/* We don&#39;t know our unit number until the OSM sets it */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">channel_b</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">AHC_NONE</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">AHC_FENONE</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">bugs</span> <span class="o">=</span> <span class="n">AHC_BUGNONE</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">AHC_FNONE</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Default to all error reporting enabled with the</span>
<span class="cm">	 * sequencer operating at its fastest speed.</span>
<span class="cm">	 * The bus attach code may modify this.</span>
<span class="cm">	 */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seqctl</span> <span class="o">=</span> <span class="n">FASTMODE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AHC_NUM_TARGETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">TAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">untagged_queues</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_platform_alloc</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">platform_arg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_free</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ahc_softc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* The IRQMS bit is only valid on VL and EISA chips */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_PCI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unpause</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRQMS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unpause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pause</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unpause</span> <span class="o">|</span> <span class="n">PAUSE</span><span class="p">;</span> 
	<span class="cm">/* XXX The shared scb data stuff should be deprecated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_set_unit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_set_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">ahc_shutdown</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">ahc_dmamap_unload</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span>
				  <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">);</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">ahc_dmamem_free</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">,</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">);</span>
		<span class="n">ahc_dmamap_destroy</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span>
				   <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">);</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ahc_dma_tag_destroy</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
<span class="cp">#ifndef __linux__</span>
		<span class="n">ahc_dma_tag_destroy</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">buffer_dmat</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef __linux__</span>
	<span class="n">ahc_dma_tag_destroy</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">parent_dmat</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ahc_platform_free</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="n">ahc_fini_scbdata</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AHC_NUM_TARGETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>

		<span class="n">tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">AHC_NUM_LUNS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ahc_tmode_lstate</span> <span class="o">*</span><span class="n">lstate</span><span class="p">;</span>

				<span class="n">lstate</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">xpt_free_path</span><span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">lstate</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tstate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">black_hole</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xpt_free_path</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">black_hole</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">black_hole</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seep_config</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seep_config</span><span class="p">);</span>
<span class="cp">#ifndef __FreeBSD__</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_shutdown</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">ahc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* This will reset most registers to 0, but not all */</span>
	<span class="n">ahc_reset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="cm">/*reinit*/</span><span class="n">FALSE</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DSPCISTATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TARG_SCSIRATE</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCSICONF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the controller and record some information about it</span>
<span class="cm"> * that is only available just after a reset.  If &quot;reinit&quot; is</span>
<span class="cm"> * non-zero, this reset occurred after initial configuration</span>
<span class="cm"> * and the caller requests that the chip be fully reinitialized</span>
<span class="cm"> * to a runable state.  Chip interrupts are *not* enabled after</span>
<span class="cm"> * a reinitialization.  The caller must enable interrupts via</span>
<span class="cm"> * ahc_intr_enable().</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ahc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reinit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span>	<span class="n">sblkctl</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">sxfrctl1_a</span><span class="p">,</span> <span class="n">sxfrctl1_b</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">wait</span><span class="p">;</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Preserve the value of the SXFRCTL1 register for all channels.</span>
<span class="cm">	 * It contains settings that affect termination and we don&#39;t want</span>
<span class="cm">	 * to disturb the integrity of the bus.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="n">sxfrctl1_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AHC_AIC7770</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">sblkctl</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Save channel B&#39;s settings in case this chip</span>
<span class="cm">		 * is setup for TWIN channel operation.</span>
<span class="cm">		 */</span>
		<span class="n">sblkctl</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">sblkctl</span> <span class="o">|</span> <span class="n">SELBUSB</span><span class="p">);</span>
		<span class="n">sxfrctl1_b</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">sblkctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SELBUSB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sxfrctl1_a</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">);</span>

	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">,</span> <span class="n">CHIPRST</span> <span class="o">|</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ensure that the reset has finished.  We delay 1000us</span>
<span class="cm">	 * prior to reading the register to make sure the chip</span>
<span class="cm">	 * has sufficiently completed its reset to handle register</span>
<span class="cm">	 * accesses.</span>
<span class="cm">	 */</span>
	<span class="n">wait</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ahc_delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">wait</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CHIPRSTACK</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: WARNING - Failed chip reset!  &quot;</span>
		       <span class="s">&quot;Trying to initialize anyway.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">);</span>

	<span class="cm">/* Determine channel configuration */</span>
	<span class="n">sblkctl</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SELBUSB</span><span class="o">|</span><span class="n">SELWIDE</span><span class="p">);</span>
	<span class="cm">/* No Twin Channel PCI cards */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_PCI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sblkctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SELBUSB</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sblkctl</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Single Narrow Channel */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* Wide Channel */</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">AHC_WIDE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="cm">/* Twin Channel */</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">AHC_TWIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Unsupported adapter type.  Ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reload sxfrctl1.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We must always initialize STPWEN to 1 before we</span>
<span class="cm">	 * restore the saved values.  STPWEN is initialized</span>
<span class="cm">	 * to a tri-state condition which can only be cleared</span>
<span class="cm">	 * by turning it on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">sblkctl</span><span class="p">;</span>

		<span class="n">sblkctl</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">sblkctl</span> <span class="o">|</span> <span class="n">SELBUSB</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">,</span> <span class="n">sxfrctl1_b</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">sblkctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SELBUSB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">,</span> <span class="n">sxfrctl1_a</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reinit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * If a recovery action has forced a chip reset,</span>
<span class="cm">		 * re-initialize the chip to our liking.</span>
<span class="cm">		 */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">bus_chip_init</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="cp">#ifdef AHC_DUMP_SEQ</span>
	<span class="k">else</span> 
		<span class="n">ahc_dumpseq</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Determine the number of SCBs available on the controller</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ahc_probe_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AHC_SCB_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_BASE</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_BASE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_BASE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_dmamap_cb</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="n">bus_dma_segment_t</span> <span class="o">*</span><span class="n">segs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nseg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">baddr</span><span class="p">;</span>

	<span class="n">baddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="o">*</span><span class="n">baddr</span> <span class="o">=</span> <span class="n">segs</span><span class="o">-&gt;</span><span class="n">ds_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_build_free_scb_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">scbsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">scbsize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_LSCBS_ENABLED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">scbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Touch all SCB bytes to avoid parity errors</span>
<span class="cm">		 * should one of our debugging routines read</span>
<span class="cm">		 * an otherwise uninitiatlized byte.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">scbsize</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_BASE</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>

		<span class="cm">/* Clear the control byte. */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Set the next pointer */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PAGESCBS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> 
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>

		<span class="cm">/* Make the tag number, SCSIID, and lun invalid */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_SCSIID</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_LUN</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PAGESCBS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SCB 0 heads the free list. */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No free list. */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure that the last SCB terminates the free list */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ahc_init_scbdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb_data</span> <span class="o">*</span><span class="n">scb_data</span><span class="p">;</span>

	<span class="n">scb_data</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="p">;</span>
	<span class="n">SLIST_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">);</span>
	<span class="n">SLIST_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_maps</span><span class="p">);</span>

	<span class="cm">/* Allocate SCB resources */</span>
	<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbarray</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span><span class="p">)</span> <span class="o">*</span> <span class="n">AHC_SCB_MAX_ALLOC</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbarray</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbarray</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span><span class="p">)</span> <span class="o">*</span> <span class="n">AHC_SCB_MAX_ALLOC</span><span class="p">);</span>

	<span class="cm">/* Determine the number of hardware SCBs and initialize them */</span>

	<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span> <span class="o">=</span> <span class="n">ahc_probe_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: No SCB space found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ENXIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create our DMA tags.  These tags define the kinds of device</span>
<span class="cm">	 * accessible memory allocations and memory mappings we will</span>
<span class="cm">	 * need to perform during normal operation.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unless we need to further restrict the allocation, we rely</span>
<span class="cm">	 * on the restrictions of the parent dmat, hence the common</span>
<span class="cm">	 * use of MAXADDR and MAXSIZE.</span>
<span class="cm">	 */</span>

	<span class="cm">/* DMA tag for our hardware scb structures */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_dma_tag_create</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">parent_dmat</span><span class="p">,</span> <span class="cm">/*alignment*/</span><span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*boundary*/</span><span class="n">BUS_SPACE_MAXADDR_32BIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*lowaddr*/</span><span class="n">BUS_SPACE_MAXADDR_32BIT</span><span class="p">,</span>
			       <span class="cm">/*highaddr*/</span><span class="n">BUS_SPACE_MAXADDR</span><span class="p">,</span>
			       <span class="cm">/*filter*/</span><span class="nb">NULL</span><span class="p">,</span> <span class="cm">/*filterarg*/</span><span class="nb">NULL</span><span class="p">,</span>
			       <span class="n">AHC_SCB_MAX_ALLOC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hardware_scb</span><span class="p">),</span>
			       <span class="cm">/*nsegments*/</span><span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*maxsegsz*/</span><span class="n">BUS_SPACE_MAXSIZE_32BIT</span><span class="p">,</span>
			       <span class="cm">/*flags*/</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Allocation for our hscbs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_dmamem_alloc</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmat</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span><span class="p">,</span>
			     <span class="n">BUS_DMA_NOWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmamap</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* And permanently map them */</span>
	<span class="n">ahc_dmamap_load</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmat</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmamap</span><span class="p">,</span>
			<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span><span class="p">,</span>
			<span class="n">AHC_SCB_MAX_ALLOC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hardware_scb</span><span class="p">),</span>
			<span class="n">ahc_dmamap_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_busaddr</span><span class="p">,</span> <span class="cm">/*flags*/</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* DMA tag for our sense buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_dma_tag_create</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">parent_dmat</span><span class="p">,</span> <span class="cm">/*alignment*/</span><span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*boundary*/</span><span class="n">BUS_SPACE_MAXADDR_32BIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*lowaddr*/</span><span class="n">BUS_SPACE_MAXADDR_32BIT</span><span class="p">,</span>
			       <span class="cm">/*highaddr*/</span><span class="n">BUS_SPACE_MAXADDR</span><span class="p">,</span>
			       <span class="cm">/*filter*/</span><span class="nb">NULL</span><span class="p">,</span> <span class="cm">/*filterarg*/</span><span class="nb">NULL</span><span class="p">,</span>
			       <span class="n">AHC_SCB_MAX_ALLOC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_sense_data</span><span class="p">),</span>
			       <span class="cm">/*nsegments*/</span><span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*maxsegsz*/</span><span class="n">BUS_SPACE_MAXSIZE_32BIT</span><span class="p">,</span>
			       <span class="cm">/*flags*/</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Allocate them */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_dmamem_alloc</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmat</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span>
			     <span class="n">BUS_DMA_NOWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmamap</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* And permanently map them */</span>
	<span class="n">ahc_dmamap_load</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmat</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmamap</span><span class="p">,</span>
			<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span>
			<span class="n">AHC_SCB_MAX_ALLOC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_sense_data</span><span class="p">),</span>
			<span class="n">ahc_dmamap_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_busaddr</span><span class="p">,</span> <span class="cm">/*flags*/</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* DMA tag for our S/G structures.  We allocate in page sized chunks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_dma_tag_create</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">parent_dmat</span><span class="p">,</span> <span class="cm">/*alignment*/</span><span class="mi">8</span><span class="p">,</span>
			       <span class="cm">/*boundary*/</span><span class="n">BUS_SPACE_MAXADDR_32BIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*lowaddr*/</span><span class="n">BUS_SPACE_MAXADDR_32BIT</span><span class="p">,</span>
			       <span class="cm">/*highaddr*/</span><span class="n">BUS_SPACE_MAXADDR</span><span class="p">,</span>
			       <span class="cm">/*filter*/</span><span class="nb">NULL</span><span class="p">,</span> <span class="cm">/*filterarg*/</span><span class="nb">NULL</span><span class="p">,</span>
			       <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="cm">/*nsegments*/</span><span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*maxsegsz*/</span><span class="n">BUS_SPACE_MAXSIZE_32BIT</span><span class="p">,</span>
			       <span class="cm">/*flags*/</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_dmat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Perform initial CCB allocation */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">AHC_SCB_MAX_ALLOC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hardware_scb</span><span class="p">));</span>
	<span class="n">ahc_alloc_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ahc_init_scbdata - &quot;</span>
		       <span class="s">&quot;Unable to allocate initial scbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reserve the next queued SCB.</span>
<span class="cm">	 */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">next_queued_scb</span> <span class="o">=</span> <span class="n">ahc_get_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note that we were successful</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> 

<span class="nl">error_exit:</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_fini_scbdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb_data</span> <span class="o">*</span><span class="n">scb_data</span><span class="p">;</span>

	<span class="n">scb_data</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">7</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">sg_map_node</span> <span class="o">*</span><span class="n">sg_map</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">sg_map</span> <span class="o">=</span> <span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_maps</span><span class="p">))</span><span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SLIST_REMOVE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_maps</span><span class="p">,</span> <span class="n">links</span><span class="p">);</span>
			<span class="n">ahc_dmamap_unload</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_dmat</span><span class="p">,</span>
					  <span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_dmamap</span><span class="p">);</span>
			<span class="n">ahc_dmamem_free</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_dmat</span><span class="p">,</span>
					<span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_vaddr</span><span class="p">,</span>
					<span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_dmamap</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sg_map</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ahc_dma_tag_destroy</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_dmat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">ahc_dmamap_unload</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmat</span><span class="p">,</span>
				  <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmamap</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">ahc_dmamem_free</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmat</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span>
				<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmamap</span><span class="p">);</span>
		<span class="n">ahc_dmamap_destroy</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmat</span><span class="p">,</span>
				   <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmamap</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">ahc_dma_tag_destroy</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sense_dmat</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">ahc_dmamap_unload</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmat</span><span class="p">,</span>
				  <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmamap</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ahc_dmamem_free</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmat</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span><span class="p">,</span>
				<span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmamap</span><span class="p">);</span>
		<span class="n">ahc_dmamap_destroy</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmat</span><span class="p">,</span>
				   <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmamap</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ahc_dma_tag_destroy</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_dmat</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbarray</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbarray</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_alloc_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb_data</span> <span class="o">*</span><span class="n">scb_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">next_scb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sg_map_node</span> <span class="o">*</span><span class="n">sg_map</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">physaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahc_dma_seg</span> <span class="o">*</span><span class="n">segs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newcount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">scb_data</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span> <span class="o">&gt;=</span> <span class="n">AHC_SCB_MAX_ALLOC</span><span class="p">)</span>
		<span class="cm">/* Can&#39;t allocate any more */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">next_scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbarray</span><span class="p">[</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">];</span>

	<span class="n">sg_map</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sg_map</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg_map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Allocate S/G space for the next batch of SCBS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_dmamem_alloc</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_dmat</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_vaddr</span><span class="p">,</span>
			     <span class="n">BUS_DMA_NOWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_dmamap</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sg_map</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SLIST_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_maps</span><span class="p">,</span> <span class="n">sg_map</span><span class="p">,</span> <span class="n">links</span><span class="p">);</span>

	<span class="n">ahc_dmamap_load</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">sg_dmat</span><span class="p">,</span> <span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_dmamap</span><span class="p">,</span>
			<span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_vaddr</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">ahc_dmamap_cb</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_physaddr</span><span class="p">,</span> <span class="cm">/*flags*/</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">segs</span> <span class="o">=</span> <span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_vaddr</span><span class="p">;</span>
	<span class="n">physaddr</span> <span class="o">=</span> <span class="n">sg_map</span><span class="o">-&gt;</span><span class="n">sg_physaddr</span><span class="p">;</span>

	<span class="n">newcount</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="p">(</span><span class="n">AHC_NSEG</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_dma_seg</span><span class="p">)));</span>
	<span class="n">newcount</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">newcount</span><span class="p">,</span> <span class="p">(</span><span class="n">AHC_SCB_MAX_ALLOC</span> <span class="o">-</span> <span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">newcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scb_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
<span class="cp">#ifndef __linux__</span>
		<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">next_scb</span><span class="o">-&gt;</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
		<span class="n">next_scb</span><span class="o">-&gt;</span><span class="n">sg_map</span> <span class="o">=</span> <span class="n">sg_map</span><span class="p">;</span>
		<span class="n">next_scb</span><span class="o">-&gt;</span><span class="n">sg_list</span> <span class="o">=</span> <span class="n">segs</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * The sequencer always starts with the second entry.</span>
<span class="cm">		 * The first entry is embedded in the scb.</span>
<span class="cm">		 */</span>
		<span class="n">next_scb</span><span class="o">-&gt;</span><span class="n">sg_list_phys</span> <span class="o">=</span> <span class="n">physaddr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_dma_seg</span><span class="p">);</span>
		<span class="n">next_scb</span><span class="o">-&gt;</span><span class="n">ahc_softc</span> <span class="o">=</span> <span class="n">ahc</span><span class="p">;</span>
		<span class="n">next_scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SCB_FREE</span><span class="p">;</span>
<span class="cp">#ifndef __linux__</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">ahc_dmamap_create</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">buffer_dmat</span><span class="p">,</span> <span class="cm">/*flags*/</span><span class="mi">0</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">next_scb</span><span class="o">-&gt;</span><span class="n">dmamap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">next_scb</span><span class="o">-&gt;</span><span class="n">hscb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscbs</span><span class="p">[</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">];</span>
		<span class="n">next_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">;</span>
		<span class="n">SLIST_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">,</span>
				  <span class="n">next_scb</span><span class="p">,</span> <span class="n">links</span><span class="p">.</span><span class="n">sle</span><span class="p">);</span>
		<span class="n">segs</span> <span class="o">+=</span> <span class="n">AHC_NSEG</span><span class="p">;</span>
		<span class="n">physaddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">AHC_NSEG</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_dma_seg</span><span class="p">));</span>
		<span class="n">next_scb</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_controller_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s: &quot;</span><span class="p">,</span> <span class="n">ahc_chip_names</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">&amp;</span> <span class="n">AHC_CHIPID_MASK</span><span class="p">]);</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
 		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Twin Channel, A SCSI Id=%d, &quot;</span>
			      <span class="s">&quot;B SCSI Id=%d, primary %c, &quot;</span><span class="p">,</span>
			      <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id_b</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PRIMARY_CHANNEL</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;A&#39;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">speed</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>

		<span class="n">speed</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="s">&quot;Ultra &quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="s">&quot;Ultra160 &quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="s">&quot;Ultra2 &quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;Wide&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;Single&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s%s Channel %c, SCSI Id=%d, &quot;</span><span class="p">,</span>
			      <span class="n">speed</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PAGESCBS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d/%d SCBs&quot;</span><span class="p">,</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">,</span> <span class="n">AHC_MAX_QUEUE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d SCBs&quot;</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ahc_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">term</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">error</span><span class="p">;</span>
	<span class="n">u_int</span>	 <span class="n">i</span><span class="p">;</span>
	<span class="n">u_int</span>	 <span class="n">scsi_conf</span><span class="p">;</span>
	<span class="n">u_int</span>	 <span class="n">scsiseq_template</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">physaddr</span><span class="p">;</span>

	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set the SCSI Id, SXFRCTL0, SXFRCTL1, and SIMODE1, for both channels*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Setup Channel B first.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">SELBUSB</span><span class="p">);</span>
		<span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TERM_ENB_B</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">STPWEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id_b</span><span class="p">);</span>
		<span class="n">scsi_conf</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSICONF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">,</span> <span class="p">(</span><span class="n">scsi_conf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSPCHK</span><span class="o">|</span><span class="n">STIMESEL</span><span class="p">))</span>
					<span class="o">|</span><span class="n">term</span><span class="o">|</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seltime_b</span><span class="o">|</span><span class="n">ENSTIMER</span><span class="o">|</span><span class="n">ACTNEGEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">)</span><span class="o">|</span><span class="n">ENIOERR</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ENSELTIMO</span><span class="o">|</span><span class="n">ENSCSIRST</span><span class="o">|</span><span class="n">ENSCSIPERR</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">DFON</span><span class="o">|</span><span class="n">SPIOEN</span><span class="p">);</span>

		<span class="cm">/* Select Channel A */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SELBUSB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TERM_ENB_A</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">STPWEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID_ULTRA2</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">);</span>
	<span class="n">scsi_conf</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSICONF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL1</span><span class="p">,</span> <span class="p">(</span><span class="n">scsi_conf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSPCHK</span><span class="o">|</span><span class="n">STIMESEL</span><span class="p">))</span>
				<span class="o">|</span><span class="n">term</span><span class="o">|</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">seltime</span>
				<span class="o">|</span><span class="n">ENSTIMER</span><span class="o">|</span><span class="n">ACTNEGEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">)</span><span class="o">|</span><span class="n">ENIOERR</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ENSELTIMO</span><span class="o">|</span><span class="n">ENSCSIRST</span><span class="o">|</span><span class="n">ENSCSIPERR</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">,</span> <span class="n">DFON</span><span class="o">|</span><span class="n">SPIOEN</span><span class="p">);</span>

	<span class="cm">/* There are no untagged SCBs active yet. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_unbusy_tcl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUILD_TCL</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SCB_BTT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">lun</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * The SCB based BTT allows an entry per</span>
<span class="cm">			 * target and lun pair.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">AHC_NUM_LUNS</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ahc_unbusy_tcl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUILD_TCL</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* All of our queues are empty */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>
	<span class="n">ahc_sync_qoutfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUS_DMASYNC_PREREAD</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_TID</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell the sequencer where it can find our arrays in memory.</span>
<span class="cm">	 */</span>
	<span class="n">physaddr</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">hscb_busaddr</span><span class="p">;</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HSCB_ADDR</span><span class="p">,</span> <span class="n">physaddr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HSCB_ADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HSCB_ADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HSCB_ADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="n">physaddr</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_busaddr</span><span class="p">;</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SHARED_DATA_ADDR</span><span class="p">,</span> <span class="n">physaddr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SHARED_DATA_ADDR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SHARED_DATA_ADDR</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SHARED_DATA_ADDR</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the group code to command length table.</span>
<span class="cm">	 * This overrides the values in TARG_SCSIRATE, so only</span>
<span class="cm">	 * setup the table after we have processed that information.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CMDSIZE_TABLE</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CMDSIZE_TABLE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CMDSIZE_TABLE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CMDSIZE_TABLE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CMDSIZE_TABLE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CMDSIZE_TABLE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CMDSIZE_TABLE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CMDSIZE_TABLE</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_HS_MAILBOX</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HS_MAILBOX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Tell the sequencer of our initial queue positions */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">KERNEL_TQINPOS</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TQINPOS</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">QOFF_CTLSTA</span><span class="p">,</span> <span class="n">SCB_QSIZE_256</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SNSCB_QOFF</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SDSCB_QOFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">KERNEL_QINPOS</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">QINPOS</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">QOUTPOS</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We don&#39;t have any waiting selections */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>

	<span class="cm">/* Our disconnection list is empty too */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DISCONNECTED_SCBH</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>

	<span class="cm">/* Message out buffer starts empty */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">MSG_OUT</span><span class="p">,</span> <span class="n">MSG_NOOP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup the allowed SCSI Sequences based on operational mode.</span>
<span class="cm">	 * If we are a target, we&#39;ll enable select in operations once</span>
<span class="cm">	 * we&#39;ve had a lun enabled.</span>
<span class="cm">	 */</span>
	<span class="n">scsiseq_template</span> <span class="o">=</span> <span class="n">ENSELO</span><span class="o">|</span><span class="n">ENAUTOATNO</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_INITIATORROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">scsiseq_template</span> <span class="o">|=</span> <span class="n">ENRSELI</span><span class="p">;</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ_TEMPLATE</span><span class="p">,</span> <span class="n">scsiseq_template</span><span class="p">);</span>

	<span class="cm">/* Initialize our list of free SCBs. */</span>
	<span class="n">ahc_build_free_scb_list</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell the sequencer which SCB will be the next one it receives.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">NEXT_QUEUED_SCB</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">next_queued_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Load the Sequencer program and Enable the adapter</span>
<span class="cm">	 * in &quot;fast&quot; mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Downloading Sequencer Program...&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ahc_loadseq</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">wait</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait for up to 500ms for our transceivers</span>
<span class="cm">		 * to settle.  If the adapter does not have</span>
<span class="cm">		 * a cable attached, the transceivers may</span>
<span class="cm">		 * never settle, so don&#39;t complain if we</span>
<span class="cm">		 * fail here.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
		     <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENAB40</span><span class="o">|</span><span class="n">ENAB20</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wait</span><span class="p">;</span>
		     <span class="n">wait</span><span class="o">--</span><span class="p">)</span>
			<span class="n">ahc_delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start the board, ready for normal operation</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ahc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">max_targ</span><span class="p">;</span>
	<span class="n">u_int</span>	 <span class="n">i</span><span class="p">;</span>
	<span class="n">u_int</span>	 <span class="n">scsi_conf</span><span class="p">;</span>
	<span class="n">u_int</span>	 <span class="n">ultraenb</span><span class="p">;</span>
	<span class="n">u_int</span>	 <span class="n">discenable</span><span class="p">;</span>
	<span class="n">u_int</span>	 <span class="n">tagenable</span><span class="p">;</span>
	<span class="kt">size_t</span>	 <span class="n">driver_data_size</span><span class="p">;</span>

<span class="cp">#ifdef AHC_DEBUG</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_DEBUG_SEQUENCER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_SEQUENCER_DEBUG</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef AHC_PRINT_SRAM</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Scratch Ram:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x5f</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">              &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot; 0x%x&quot;</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MORE_SRAM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x7f</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">              &quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot; 0x%x&quot;</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Reading uninitialized scratch ram may</span>
<span class="cm">	 * generate parity errors.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRPARERR</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CLRINT</span><span class="p">,</span> <span class="n">CLRBRKADRINT</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">max_targ</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Assume we have a board at this stage and it has been reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_USEDEFAULTS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id_b</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Default to allowing initiator operations.</span>
<span class="cm">	 */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_INITIATORROLE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only allow target mode features if this unit has them enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">AHC_TMODE_ENABLE</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_TARGETMODE</span><span class="p">;</span>

<span class="cp">#ifndef __linux__</span>
	<span class="cm">/* DMA tag for mapping buffers into device visible space. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_dma_tag_create</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">parent_dmat</span><span class="p">,</span> <span class="cm">/*alignment*/</span><span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*boundary*/</span><span class="n">BUS_SPACE_MAXADDR_32BIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*lowaddr*/</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_39BIT_ADDRESSING</span>
					<span class="o">?</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="mh">0x7FFFFFFFFFULL</span>
					<span class="o">:</span> <span class="n">BUS_SPACE_MAXADDR_32BIT</span><span class="p">,</span>
			       <span class="cm">/*highaddr*/</span><span class="n">BUS_SPACE_MAXADDR</span><span class="p">,</span>
			       <span class="cm">/*filter*/</span><span class="nb">NULL</span><span class="p">,</span> <span class="cm">/*filterarg*/</span><span class="nb">NULL</span><span class="p">,</span>
			       <span class="cm">/*maxsize*/</span><span class="p">(</span><span class="n">AHC_NSEG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			       <span class="cm">/*nsegments*/</span><span class="n">AHC_NSEG</span><span class="p">,</span>
			       <span class="cm">/*maxsegsz*/</span><span class="n">AHC_MAXTRANSFER_SIZE</span><span class="p">,</span>
			       <span class="cm">/*flags*/</span><span class="n">BUS_DMA_ALLOCNOW</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">buffer_dmat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * DMA tag for our command fifos and other data in system memory</span>
<span class="cm">	 * the card&#39;s sequencer must be able to access.  For initiator</span>
<span class="cm">	 * roles, we need to allocate space for the qinfifo and qoutfifo.</span>
<span class="cm">	 * The qinfifo and qoutfifo are composed of 256 1 byte elements. </span>
<span class="cm">	 * When providing for the target mode role, we must additionally</span>
<span class="cm">	 * provide space for the incoming target command fifo and an extra</span>
<span class="cm">	 * byte to deal with a dma bug in some chip versions.</span>
<span class="cm">	 */</span>
	<span class="n">driver_data_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">driver_data_size</span> <span class="o">+=</span> <span class="n">AHC_TMODE_CMDS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">target_cmd</span><span class="p">)</span>
				 <span class="o">+</span> <span class="cm">/*DMA WideOdd Bug Buffer*/</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_dma_tag_create</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">parent_dmat</span><span class="p">,</span> <span class="cm">/*alignment*/</span><span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*boundary*/</span><span class="n">BUS_SPACE_MAXADDR_32BIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*lowaddr*/</span><span class="n">BUS_SPACE_MAXADDR_32BIT</span><span class="p">,</span>
			       <span class="cm">/*highaddr*/</span><span class="n">BUS_SPACE_MAXADDR</span><span class="p">,</span>
			       <span class="cm">/*filter*/</span><span class="nb">NULL</span><span class="p">,</span> <span class="cm">/*filterarg*/</span><span class="nb">NULL</span><span class="p">,</span>
			       <span class="n">driver_data_size</span><span class="p">,</span>
			       <span class="cm">/*nsegments*/</span><span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/*maxsegsz*/</span><span class="n">BUS_SPACE_MAXSIZE_32BIT</span><span class="p">,</span>
			       <span class="cm">/*flags*/</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Allocation of driver data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_dmamem_alloc</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">,</span>
			     <span class="n">BUS_DMA_NOWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* And permanently map it in */</span>
	<span class="n">ahc_dmamap_load</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">,</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">,</span> <span class="n">driver_data_size</span><span class="p">,</span> <span class="n">ahc_dmamap_cb</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_busaddr</span><span class="p">,</span> <span class="cm">/*flags*/</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">targetcmds</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">target_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">targetcmds</span><span class="p">[</span><span class="n">AHC_TMODE_CMDS</span><span class="p">];</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">dma_bug_buf</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_busaddr</span>
				 <span class="o">+</span> <span class="n">driver_data_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* All target command blocks start out invalid. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AHC_TMODE_CMDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">targetcmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ahc_sync_tqinfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUS_DMASYNC_PREREAD</span><span class="p">);</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">targetcmds</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">init_level</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Allocate SCB data now that buffer_dmat is initialized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_init_scbdata</span><span class="p">(</span><span class="n">ahc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate a tstate to house information for our</span>
<span class="cm">	 * initiator presence on the bus as well as the user</span>
<span class="cm">	 * data for any target mode initiator.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_alloc_tstate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unable to allocate ahc_tmode_tstate.  &quot;</span>
		       <span class="s">&quot;Failing attach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_alloc_tstate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id_b</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unable to allocate ahc_tmode_tstate.  &quot;</span>
			       <span class="s">&quot;Failing attach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span> <span class="o">&lt;</span> <span class="n">AHC_SCB_MAX_ALLOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_PAGESCBS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_PAGESCBS</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef AHC_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: hardware scb %u bytes; kernel scb %u bytes; &quot;</span>
		       <span class="s">&quot;ahc_dma %u bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hardware_scb</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scb</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_dma_seg</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* AHC_DEBUG */</span><span class="cp"></span>

	<span class="cm">/*</span>
<span class="cm">	 * Look at the information that board initialization or</span>
<span class="cm">	 * the board bios has left us.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_conf</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSICONF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_conf</span> <span class="o">&amp;</span> <span class="n">RESET_SCSI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_INITIATORROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_RESET_BUS_B</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_conf</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSICONF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_conf</span> <span class="o">&amp;</span> <span class="n">RESET_SCSI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_INITIATORROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_RESET_BUS_A</span><span class="p">;</span>

	<span class="n">ultraenb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	
	<span class="n">tagenable</span> <span class="o">=</span> <span class="n">ALL_TARGETS_MASK</span><span class="p">;</span>

	<span class="cm">/* Grab the disconnection disable table and invert it for our needs */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_USEDEFAULTS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Host Adapter Bios disabled.  Using default SCSI &quot;</span>
			<span class="s">&quot;device parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_EXTENDED_TRANS_A</span><span class="o">|</span><span class="n">AHC_EXTENDED_TRANS_B</span><span class="o">|</span>
			      <span class="n">AHC_TERM_ENB_A</span><span class="o">|</span><span class="n">AHC_TERM_ENB_B</span><span class="p">;</span>
		<span class="n">discenable</span> <span class="o">=</span> <span class="n">ALL_TARGETS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ultraenb</span> <span class="o">=</span> <span class="n">ALL_TARGETS_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">discenable</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DISC_DSB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			   <span class="o">|</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DISC_DSB</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_ULTRA</span><span class="o">|</span><span class="n">AHC_ULTRA2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ultraenb</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ULTRA_ENB</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				      <span class="o">|</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ULTRA_ENB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_WIDE</span><span class="o">|</span><span class="n">AHC_TWIN</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">max_targ</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">max_targ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ahc_initiator_tinfo</span> <span class="o">*</span><span class="n">tinfo</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
		<span class="n">u_int</span> <span class="n">our_id</span><span class="p">;</span>
		<span class="n">u_int</span> <span class="n">target_id</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">channel</span><span class="p">;</span>

		<span class="n">channel</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">;</span>
		<span class="n">target_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>
			<span class="n">our_id</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id_b</span><span class="p">;</span>
			<span class="n">target_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tinfo</span> <span class="o">=</span> <span class="n">ahc_fetch_transinfo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">our_id</span><span class="p">,</span>
					    <span class="n">target_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tstate</span><span class="p">);</span>
		<span class="cm">/* Default to async narrow across the board */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tinfo</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_USEDEFAULTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * These will be truncated when we determine the</span>
<span class="cm">			 * connection type we have with the target.</span>
<span class="cm">			 */</span>
			<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">ahc_syncrates</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>
			<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u_int</span> <span class="n">scsirate</span><span class="p">;</span>
			<span class="kt">uint16_t</span> <span class="n">mask</span><span class="p">;</span>

			<span class="cm">/* Take the settings leftover in scratch RAM. */</span>
			<span class="n">scsirate</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARG_SCSIRATE</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u_int</span> <span class="n">offset</span><span class="p">;</span>
				<span class="n">u_int</span> <span class="n">maxsync</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">SOFS</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Haven&#39;t negotiated yet,</span>
<span class="cm">					 * so the format is different.</span>
<span class="cm">					 */</span>
					<span class="n">scsirate</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">SXFR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
						 <span class="o">|</span> <span class="p">(</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
						  <span class="o">?</span> <span class="mh">0x08</span> <span class="o">:</span> <span class="mh">0x0</span>
						 <span class="o">|</span> <span class="p">(</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">WIDEXFER</span><span class="p">);</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET_ULTRA2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARG_OFFSET</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WIDEXFER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="cm">/* Set to the lowest sync rate, 5MHz */</span>
					<span class="n">scsirate</span> <span class="o">|=</span> <span class="mh">0x1c</span><span class="p">;</span>
				<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_ULTRA2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">maxsync</span> <span class="o">=</span> <span class="n">AHC_SYNCRATE_DT</span><span class="p">;</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span>
				    <span class="n">ahc_find_period</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span> <span class="n">maxsync</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">SXFR_ULTRA2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="cm">/*10MHz*/</span>
				 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">=</span>
					    <span class="n">MSG_EXT_PPR_DT_REQ</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">SOFS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">SXFR</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span>
				 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Treat 10MHz as a non-ultra speed */</span>
					<span class="n">scsirate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SXFR</span><span class="p">;</span>
				 	<span class="n">ultraenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> 
				    <span class="n">ahc_find_period</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scsirate</span><span class="p">,</span>
						    <span class="p">(</span><span class="n">ultraenb</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
						   <span class="o">?</span> <span class="n">AHC_SYNCRATE_ULTRA</span>
						   <span class="o">:</span> <span class="n">AHC_SYNCRATE_FAST</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">period</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">scsirate</span> <span class="o">&amp;</span> <span class="n">WIDEXFER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">MSG_EXT_WDTR_BUS_16_BIT</span><span class="p">;</span>
			<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">transport_version</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">.</span><span class="n">transport_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">goal</span><span class="p">.</span><span class="n">transport_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">tinfo</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">transport_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tstate</span><span class="o">-&gt;</span><span class="n">ultraenb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">user_discenable</span> <span class="o">=</span> <span class="n">discenable</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">user_tagenable</span> <span class="o">=</span> <span class="n">tagenable</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">bus_chip_init</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">hcntrl</span><span class="p">;</span>

	<span class="n">hcntrl</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">);</span>
	<span class="n">hcntrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INTEN</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pause</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INTEN</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unpause</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INTEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hcntrl</span> <span class="o">|=</span> <span class="n">INTEN</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pause</span> <span class="o">|=</span> <span class="n">INTEN</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">unpause</span> <span class="o">|=</span> <span class="n">INTEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNTRL</span><span class="p">,</span> <span class="n">hcntrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ensure that the card is paused in a location</span>
<span class="cm"> * outside of all critical sections and that all</span>
<span class="cm"> * pending work is completed prior to returning.</span>
<span class="cm"> * This routine should only be called from outside</span>
<span class="cm"> * an interrupt context.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ahc_pause_and_flushwork</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">intstat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxloops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">paused</span><span class="p">;</span>

	<span class="n">maxloops</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_ALL_INTERRUPTS</span><span class="p">;</span>
	<span class="n">paused</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">paused</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Give the sequencer some time to service</span>
<span class="cm">			 * any active selections.</span>
<span class="cm">			 */</span>
			<span class="n">ahc_delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ahc_intr</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">paused</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSELO</span><span class="p">);</span>
		<span class="n">intstat</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">INT_PEND</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_clear_critical_section</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="n">intstat</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">maxloops</span>
	      <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">!=</span> <span class="mh">0xFF</span> <span class="o">||</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_REMOVABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	      <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">INT_PEND</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	       <span class="o">||</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SELDO</span><span class="o">|</span><span class="n">SELINGO</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxloops</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Infinite interrupt loop, INTSTAT = %x&quot;</span><span class="p">,</span>
		       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">INTSTAT</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ahc_platform_flushwork</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_ALL_INTERRUPTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span>
<span class="nf">ahc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">ahc_pause_and_flushwork</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">LIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_scbs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef AHC_TARGET_MODE</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX What about ATIOs that have not yet been serviced?</span>
<span class="cm">	 * Perhaps we should just refuse to be suspended if we</span>
<span class="cm">	 * are acting in a target role.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_device</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ahc_shutdown</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ahc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">ahc_reset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="cm">/*reinit*/</span><span class="n">TRUE</span><span class="p">);</span>
	<span class="n">ahc_intr_enable</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span> 
	<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cm">/************************** Busy Target Table *********************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Return the untagged transaction id for a given target/channel lun.</span>
<span class="cm"> * Optionally, clear the entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u_int</span>
<span class="nf">ahc_index_busy_tcl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tcl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">scbid</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">target_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SCB_BTT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">saved_scbptr</span><span class="p">;</span>
		
		<span class="n">saved_scbptr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">TCL_LUN</span><span class="p">(</span><span class="n">tcl</span><span class="p">));</span>
		<span class="n">scbid</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_64_BTT</span> <span class="o">+</span> <span class="n">TCL_TARGET_OFFSET</span><span class="p">(</span><span class="n">tcl</span><span class="p">));</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">saved_scbptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">target_offset</span> <span class="o">=</span> <span class="n">TCL_TARGET_OFFSET</span><span class="p">(</span><span class="n">tcl</span><span class="p">);</span>
		<span class="n">scbid</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUSY_TARGETS</span> <span class="o">+</span> <span class="n">target_offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">scbid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_unbusy_tcl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tcl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">target_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SCB_BTT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">saved_scbptr</span><span class="p">;</span>
		
		<span class="n">saved_scbptr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">TCL_LUN</span><span class="p">(</span><span class="n">tcl</span><span class="p">));</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_64_BTT</span><span class="o">+</span><span class="n">TCL_TARGET_OFFSET</span><span class="p">(</span><span class="n">tcl</span><span class="p">),</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">saved_scbptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">target_offset</span> <span class="o">=</span> <span class="n">TCL_TARGET_OFFSET</span><span class="p">(</span><span class="n">tcl</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUSY_TARGETS</span> <span class="o">+</span> <span class="n">target_offset</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_busy_tcl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tcl</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">scbid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">target_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SCB_BTT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">saved_scbptr</span><span class="p">;</span>
		
		<span class="n">saved_scbptr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">TCL_LUN</span><span class="p">(</span><span class="n">tcl</span><span class="p">));</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_64_BTT</span> <span class="o">+</span> <span class="n">TCL_TARGET_OFFSET</span><span class="p">(</span><span class="n">tcl</span><span class="p">),</span> <span class="n">scbid</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">saved_scbptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">target_offset</span> <span class="o">=</span> <span class="n">TCL_TARGET_OFFSET</span><span class="p">(</span><span class="n">tcl</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUSY_TARGETS</span> <span class="o">+</span> <span class="n">target_offset</span><span class="p">,</span> <span class="n">scbid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************** SCB and SCB queue management **********************/</span>
<span class="kt">int</span>
<span class="nf">ahc_match_scb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span>
	      <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">role_t</span> <span class="n">role</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">targ</span> <span class="o">=</span> <span class="n">SCB_GET_TARGET</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">SCB_GET_CHANNEL</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">slun</span> <span class="o">=</span> <span class="n">SCB_GET_LUN</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">match</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="p">((</span><span class="n">chan</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">ALL_CHANNELS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">match</span> <span class="o">=</span> <span class="p">((</span><span class="n">targ</span> <span class="o">==</span> <span class="n">target</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">match</span> <span class="o">=</span> <span class="p">((</span><span class="n">lun</span> <span class="o">==</span> <span class="n">slun</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lun</span> <span class="o">==</span> <span class="n">CAM_LUN_WILDCARD</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
		<span class="kt">int</span> <span class="n">group</span><span class="p">;</span>

		<span class="n">group</span> <span class="o">=</span> <span class="n">XPT_FC_GROUP</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">func_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_INITIATOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span> <span class="o">!=</span> <span class="n">XPT_FC_GROUP_TMODE</span><span class="p">)</span>
			      <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tag</span> <span class="o">==</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span>
			       <span class="o">||</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">ROLE_TARGET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span> <span class="o">==</span> <span class="n">XPT_FC_GROUP_TMODE</span><span class="p">)</span>
			      <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tag</span> <span class="o">==</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="o">-&gt;</span><span class="n">csio</span><span class="p">.</span><span class="n">tag_id</span><span class="p">)</span>
			       <span class="o">||</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">));</span>
		<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !AHC_TARGET_MODE */</span><span class="cp"></span>
		<span class="n">match</span> <span class="o">=</span> <span class="p">((</span><span class="n">tag</span> <span class="o">==</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">));</span>
<span class="cp">#endif </span><span class="cm">/* AHC_TARGET_MODE */</span><span class="cp"></span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">match</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_freeze_devq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">target</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">lun</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">SCB_GET_TARGET</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">SCB_GET_LUN</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">SCB_GET_CHANNEL</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	
	<span class="n">ahc_search_qinfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
			   <span class="cm">/*tag*/</span><span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">ROLE_UNKNOWN</span><span class="p">,</span>
			   <span class="n">CAM_REQUEUE_REQ</span><span class="p">,</span> <span class="n">SEARCH_COMPLETE</span><span class="p">);</span>

	<span class="n">ahc_platform_freeze_devq</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_qinfifo_requeue_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">prev_scb</span><span class="p">;</span>

	<span class="n">prev_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_qinfifo_count</span><span class="p">(</span><span class="n">ahc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">prev_tag</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="n">prev_pos</span><span class="p">;</span>

		<span class="n">prev_pos</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">prev_tag</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">prev_pos</span><span class="p">];</span>
		<span class="n">prev_scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">prev_tag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc_qinfifo_requeue</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">prev_scb</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">KERNEL_QINPOS</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_qinfifo_requeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">prev_scb</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">NEXT_QUEUED_SCB</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">prev_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
		<span class="n">ahc_sync_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">prev_scb</span><span class="p">,</span> 
			     <span class="n">BUS_DMASYNC_PREREAD</span><span class="o">|</span><span class="n">BUS_DMASYNC_PREWRITE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">next_queued_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">ahc_sync_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">BUS_DMASYNC_PREREAD</span><span class="o">|</span><span class="n">BUS_DMASYNC_PREWRITE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ahc_qinfifo_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">qinpos</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">diff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qinpos</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SNSCB_QOFF</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SNSCB_QOFF</span><span class="p">,</span> <span class="n">qinpos</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qinpos</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">QINPOS</span><span class="p">);</span>
	<span class="n">diff</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span> <span class="o">-</span> <span class="n">qinpos</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">diff</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ahc_search_qinfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">role_t</span> <span class="n">role</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">,</span>
		   <span class="n">ahc_search_action</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">prev_scb</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">qinstart</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">qinpos</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">qintail</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">next</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">prev</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">curscbptr</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">found</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">have_qregs</span><span class="p">;</span>

	<span class="n">qintail</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">;</span>
	<span class="n">have_qregs</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">have_qregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qinstart</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SNSCB_QOFF</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SNSCB_QOFF</span><span class="p">,</span> <span class="n">qinstart</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qinstart</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">QINPOS</span><span class="p">);</span>
	<span class="n">qinpos</span> <span class="o">=</span> <span class="n">qinstart</span><span class="p">;</span>
	<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prev_scb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">SEARCH_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t attempt to run any queued untagged transactions</span>
<span class="cm">		 * until we are done with the abort process.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_freeze_untagged_queues</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start with an empty queue.  Entries that are not chosen</span>
<span class="cm">	 * for removal will be re-added to the queue as we go.</span>
<span class="cm">	 */</span>
	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span> <span class="o">=</span> <span class="n">qinpos</span><span class="p">;</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">NEXT_QUEUED_SCB</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">next_queued_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">qinpos</span> <span class="o">!=</span> <span class="n">qintail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">qinpos</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qinpos = %d, SCB index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">qinpos</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">qinpos</span><span class="p">]);</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Loop 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_match_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">role</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We found an scb that needs to be acted on.</span>
<span class="cm">			 */</span>
			<span class="n">found</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SEARCH_COMPLETE</span>:
			<span class="p">{</span>
				<span class="n">cam_status</span> <span class="n">ostat</span><span class="p">;</span>
				<span class="n">cam_status</span> <span class="n">cstat</span><span class="p">;</span>

				<span class="n">ostat</span> <span class="o">=</span> <span class="n">ahc_get_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ostat</span> <span class="o">==</span> <span class="n">CAM_REQ_INPROG</span><span class="p">)</span>
					<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="n">cstat</span> <span class="o">=</span> <span class="n">ahc_get_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">!=</span> <span class="n">CAM_REQ_CMP</span><span class="p">)</span>
					<span class="n">ahc_freeze_scb</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Inactive SCB in qinfifo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ahc_done</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>

				<span class="cm">/* FALLTHROUGH */</span>
			<span class="p">}</span>
			<span class="k">case</span> <span class="n">SEARCH_REMOVE</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SEARCH_COUNT</span>:
				<span class="n">ahc_qinfifo_requeue</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">prev_scb</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="n">prev_scb</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ahc_qinfifo_requeue</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">prev_scb</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
			<span class="n">prev_scb</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qinpos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HNSCB_QOFF</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">KERNEL_QINPOS</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">!=</span> <span class="n">SEARCH_COUNT</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">found</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qinstart</span> <span class="o">!=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The sequencer may be in the process of dmaing</span>
<span class="cm">		 * down the SCB at the beginning of the queue.</span>
<span class="cm">		 * This could be problematic if either the first,</span>
<span class="cm">		 * or the second SCB is removed from the queue</span>
<span class="cm">		 * (the first SCB includes a pointer to the &quot;next&quot;</span>
<span class="cm">		 * SCB to dma). If we have removed any entries, swap</span>
<span class="cm">		 * the first element in the queue with the next HSCB</span>
<span class="cm">		 * so the sequencer will notice that NEXT_QUEUED_SCB</span>
<span class="cm">		 * has changed during its dma attempt and will retry</span>
<span class="cm">		 * the DMA.</span>
<span class="cm">		 */</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">qinstart</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;found = %d, qinstart = %d, qinfifionext = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">found</span><span class="p">,</span> <span class="n">qinstart</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">);</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;First/Second Qinfifo fixup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * ahc_swap_with_next_hscb forces our next pointer to</span>
<span class="cm">		 * point to the reserved SCB for future commands.  Save</span>
<span class="cm">		 * and restore our original next pointer to maintain</span>
<span class="cm">		 * queue integrity.</span>
<span class="cm">		 */</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">scbindex</span><span class="p">[</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ahc_swap_with_next_hscb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">qinstart</span><span class="p">]</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>

		<span class="cm">/* Tell the card about the new head of the qinfifo. */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">NEXT_QUEUED_SCB</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

		<span class="cm">/* Fixup the tail &quot;next&quot; pointer. */</span>
		<span class="n">qintail</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">qintail</span><span class="p">]);</span>
		<span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">next_queued_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Search waiting for selection list.</span>
<span class="cm">	 */</span>
	<span class="n">curscbptr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>  <span class="cm">/* Start at head of list. */</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">scb_index</span><span class="p">;</span>

		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
		<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">&gt;=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Waiting List inconsistency. &quot;</span>
			       <span class="s">&quot;SCB index == %d, yet numscbs == %d.&quot;</span><span class="p">,</span>
			       <span class="n">scb_index</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">);</span>
			<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;for safety&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">scb</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scb_index = %d, next = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">scb_index</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Waiting List traversal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_match_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
				  <span class="n">lun</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">role</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We found an scb that needs to be acted on.</span>
<span class="cm">			 */</span>
			<span class="n">found</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SEARCH_COMPLETE</span>:
			<span class="p">{</span>
				<span class="n">cam_status</span> <span class="n">ostat</span><span class="p">;</span>
				<span class="n">cam_status</span> <span class="n">cstat</span><span class="p">;</span>

				<span class="n">ostat</span> <span class="o">=</span> <span class="n">ahc_get_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ostat</span> <span class="o">==</span> <span class="n">CAM_REQ_INPROG</span><span class="p">)</span>
					<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span>
								   <span class="n">status</span><span class="p">);</span>
				<span class="n">cstat</span> <span class="o">=</span> <span class="n">ahc_get_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">!=</span> <span class="n">CAM_REQ_CMP</span><span class="p">)</span>
					<span class="n">ahc_freeze_scb</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Inactive SCB in Waiting List</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ahc_done</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="cm">/* FALLTHROUGH */</span>
			<span class="p">}</span>
			<span class="k">case</span> <span class="n">SEARCH_REMOVE</span>:
				<span class="n">next</span> <span class="o">=</span> <span class="n">ahc_rem_wscb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SEARCH_COUNT</span>:
				<span class="n">prev</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
				<span class="n">next</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			
			<span class="n">prev</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">curscbptr</span><span class="p">);</span>

	<span class="n">found</span> <span class="o">+=</span> <span class="n">ahc_search_untagged_queues</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="cm">/*ahc_io_ctx_t*/</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
					    <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">SEARCH_COMPLETE</span><span class="p">)</span>
		<span class="n">ahc_release_untagged_queues</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">found</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ahc_search_untagged_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc_io_ctx_t</span> <span class="n">ctx</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">,</span>
			   <span class="n">ahc_search_action</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">maxtarget</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">found</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">SEARCH_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t attempt to run any queued untagged transactions</span>
<span class="cm">		 * until we are done with the abort process.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_freeze_untagged_queues</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SCB_BTT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">maxtarget</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">i</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">maxtarget</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">maxtarget</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxtarget</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scb_tailq</span> <span class="o">*</span><span class="n">untagged_q</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">next_scb</span><span class="p">;</span>

		<span class="n">untagged_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">untagged_queues</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">next_scb</span> <span class="o">=</span> <span class="n">TAILQ_FIRST</span><span class="p">(</span><span class="n">untagged_q</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">next_scb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">scb</span> <span class="o">=</span> <span class="n">next_scb</span><span class="p">;</span>
			<span class="n">next_scb</span> <span class="o">=</span> <span class="n">TAILQ_NEXT</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">links</span><span class="p">.</span><span class="n">tqe</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * The head of the list may be the currently</span>
<span class="cm">			 * active untagged command for a device.</span>
<span class="cm">			 * We&#39;re only searching for commands that</span>
<span class="cm">			 * have not been started.  A transaction</span>
<span class="cm">			 * marked active but still in the qinfifo</span>
<span class="cm">			 * is removed by the qinfifo scanning code</span>
<span class="cm">			 * above.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_match_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
					  <span class="n">SCB_LIST_NULL</span><span class="p">,</span> <span class="n">ROLE_INITIATOR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			 <span class="o">||</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span> <span class="o">!=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * We found an scb that needs to be acted on.</span>
<span class="cm">			 */</span>
			<span class="n">found</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SEARCH_COMPLETE</span>:
			<span class="p">{</span>
				<span class="n">cam_status</span> <span class="n">ostat</span><span class="p">;</span>
				<span class="n">cam_status</span> <span class="n">cstat</span><span class="p">;</span>

				<span class="n">ostat</span> <span class="o">=</span> <span class="n">ahc_get_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ostat</span> <span class="o">==</span> <span class="n">CAM_REQ_INPROG</span><span class="p">)</span>
					<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="n">cstat</span> <span class="o">=</span> <span class="n">ahc_get_transaction_status</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">!=</span> <span class="n">CAM_REQ_CMP</span><span class="p">)</span>
					<span class="n">ahc_freeze_scb</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Inactive SCB in untaggedQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ahc_done</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">case</span> <span class="n">SEARCH_REMOVE</span>:
				<span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCB_UNTAGGEDQ</span><span class="p">;</span>
				<span class="n">TAILQ_REMOVE</span><span class="p">(</span><span class="n">untagged_q</span><span class="p">,</span> <span class="n">scb</span><span class="p">,</span> <span class="n">links</span><span class="p">.</span><span class="n">tqe</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SEARCH_COUNT</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">SEARCH_COMPLETE</span><span class="p">)</span>
		<span class="n">ahc_release_untagged_queues</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">found</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ahc_search_disc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stop_on_first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">remove</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">save_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">scbp</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">next</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">prev</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">count</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">active_scb</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DISCONNECTED_SCBH</span><span class="p">);</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">save_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* restore this when we&#39;re done */</span>
		<span class="n">active_scb</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* Silence compiler */</span>
		<span class="n">active_scb</span> <span class="o">=</span> <span class="n">SCB_LIST_NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">scb_index</span><span class="p">;</span>

		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
		<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">&gt;=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Disconnected List inconsistency. &quot;</span>
			       <span class="s">&quot;SCB index == %d, yet numscbs == %d.&quot;</span><span class="p">,</span>
			       <span class="n">scb_index</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">);</span>
			<span class="n">ahc_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;for safety&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Disconnected List Loop. &quot;</span>
			      <span class="s">&quot;cur SCBPTR == %x, prev SCBPTR == %x.&quot;</span><span class="p">,</span>
			      <span class="n">next</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">scbp</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_match_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				  <span class="n">tag</span><span class="p">,</span> <span class="n">ROLE_INITIATOR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">remove</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">next</span> <span class="o">=</span>
				    <span class="n">ahc_rem_scb_from_disc_list</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">prev</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
				<span class="n">next</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stop_on_first</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">save_state</span><span class="p">)</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">active_scb</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove an SCB from the on chip list of disconnected transactions.</span>
<span class="cm"> * This is empty/unused if we are not performing SCB paging.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u_int</span>
<span class="nf">ahc_rem_scb_from_disc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">prev</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">scbptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">next</span><span class="p">;</span>

	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">scbptr</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>

	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ahc_add_curscb_to_free_list</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DISCONNECTED_SCBH</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">next</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add the SCB as selected by SCBPTR onto the on chip list of</span>
<span class="cm"> * free hardware SCBs.  This list is empty/unused if we are not</span>
<span class="cm"> * performing SCB paging.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_add_curscb_to_free_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Invalidate the tag so that our abort</span>
<span class="cm">	 * routines don&#39;t think it&#39;s active.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PAGESCBS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">));</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Manipulate the waiting for selection list and return the</span>
<span class="cm"> * scb that follows the one that we remove.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u_int</span>
<span class="nf">ahc_rem_wscb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">scbpos</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">curscb</span><span class="p">,</span> <span class="n">next</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Select the SCB we want to abort and</span>
<span class="cm">	 * pull the next pointer out of it.</span>
<span class="cm">	 */</span>
	<span class="n">curscb</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">scbpos</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>

	<span class="cm">/* Clear the necessary fields */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ahc_add_curscb_to_free_list</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="cm">/* update the waiting list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First in the list */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span> 

		<span class="cm">/*</span>
<span class="cm">		 * Ensure we aren&#39;t attempting to perform</span>
<span class="cm">		 * selection for this entry.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSELO</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Select the scb that pointed to us </span>
<span class="cm">		 * and update its next pointer.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Point us back at the original scb position.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">curscb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************** Error Handling ******************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Abort all SCBs that match the given description (target/channel/lun/tag),</span>
<span class="cm"> * setting their status to the passed in status if the status has not already</span>
<span class="cm"> * been modified from CAM_REQ_INPROG.  This routine assumes that the sequencer</span>
<span class="cm"> * is paused before it is called.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ahc_abort_scbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span>
	       <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">role_t</span> <span class="n">role</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">scbp</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">scbp_next</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">active_scb</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">maxtarget</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">minlun</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">maxlun</span><span class="p">;</span>

	<span class="kt">int</span>	<span class="n">found</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t attempt to run any queued untagged transactions</span>
<span class="cm">	 * until we are done with the abort process.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_freeze_untagged_queues</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="cm">/* restore this when we&#39;re done */</span>
	<span class="n">active_scb</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>

	<span class="n">found</span> <span class="o">=</span> <span class="n">ahc_search_qinfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span>
				   <span class="n">role</span><span class="p">,</span> <span class="n">CAM_REQUEUE_REQ</span><span class="p">,</span> <span class="n">SEARCH_COMPLETE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clean out the busy target table for any untagged commands.</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">maxtarget</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">maxtarget</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lun</span> <span class="o">==</span> <span class="n">CAM_LUN_WILDCARD</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Unless we are using an SCB based</span>
<span class="cm">		 * busy targets table, there is only</span>
<span class="cm">		 * one table entry for all luns of</span>
<span class="cm">		 * a target.</span>
<span class="cm">		 */</span>
		<span class="n">minlun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">maxlun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_SCB_BTT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">maxlun</span> <span class="o">=</span> <span class="n">AHC_NUM_LUNS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">minlun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
		<span class="n">maxlun</span> <span class="o">=</span> <span class="n">lun</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">!=</span> <span class="n">ROLE_TARGET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxtarget</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">minlun</span><span class="p">;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">maxlun</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u_int</span> <span class="n">scbid</span><span class="p">;</span>
				<span class="n">u_int</span> <span class="n">tcl</span><span class="p">;</span>

				<span class="n">tcl</span> <span class="o">=</span> <span class="n">BUILD_TCL</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="n">scbid</span> <span class="o">=</span> <span class="n">ahc_index_busy_tcl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">tcl</span><span class="p">);</span>
				<span class="n">scbp</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbid</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scbp</span> <span class="o">==</span> <span class="nb">NULL</span>
				 <span class="o">||</span> <span class="n">ahc_match_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
						  <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">ahc_unbusy_tcl</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUILD_TCL</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Go through the disconnected list and remove any entries we</span>
<span class="cm">		 * have queued for completion, 0&#39;ing their control byte too.</span>
<span class="cm">		 * We save the active SCB and restore it ourselves, so there</span>
<span class="cm">		 * is no reason for this search to restore it too.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_search_disc_list</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span>
				     <span class="cm">/*stop_on_first*/</span><span class="n">FALSE</span><span class="p">,</span> <span class="cm">/*remove*/</span><span class="n">TRUE</span><span class="p">,</span>
				     <span class="cm">/*save_state*/</span><span class="n">FALSE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Go through the hardware SCB array looking for commands that</span>
<span class="cm">	 * were active but not on any list.  In some cases, these remnants</span>
<span class="cm">	 * might not still have mappings in the scbindex array (e.g. unexpected</span>
<span class="cm">	 * bus free with the same scb queued for an abort).  Don&#39;t hold this</span>
<span class="cm">	 * against them.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">scbid</span><span class="p">;</span>

		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">scbid</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">);</span>
		<span class="n">scbp</span> <span class="o">=</span> <span class="n">ahc_lookup_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scbp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">scbid</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span><span class="p">)</span>
		 <span class="o">||</span> <span class="p">(</span><span class="n">scbp</span> <span class="o">!=</span> <span class="nb">NULL</span>
		  <span class="o">&amp;&amp;</span> <span class="n">ahc_match_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">role</span><span class="p">)))</span>
			<span class="n">ahc_add_curscb_to_free_list</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Go through the pending CCB list and look for</span>
<span class="cm">	 * commands for this target that are still active.</span>
<span class="cm">	 * These are other tagged commands that were</span>
<span class="cm">	 * disconnected when the reset occurred.</span>
<span class="cm">	 */</span>
	<span class="n">scbp_next</span> <span class="o">=</span> <span class="n">LIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_scbs</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">scbp_next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scbp</span> <span class="o">=</span> <span class="n">scbp_next</span><span class="p">;</span>
		<span class="n">scbp_next</span> <span class="o">=</span> <span class="n">LIST_NEXT</span><span class="p">(</span><span class="n">scbp</span><span class="p">,</span> <span class="n">pending_links</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_match_scb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">role</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cam_status</span> <span class="n">ostat</span><span class="p">;</span>

			<span class="n">ostat</span> <span class="o">=</span> <span class="n">ahc_get_transaction_status</span><span class="p">(</span><span class="n">scbp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ostat</span> <span class="o">==</span> <span class="n">CAM_REQ_INPROG</span><span class="p">)</span>
				<span class="n">ahc_set_transaction_status</span><span class="p">(</span><span class="n">scbp</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahc_get_transaction_status</span><span class="p">(</span><span class="n">scbp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CAM_REQ_CMP</span><span class="p">)</span>
				<span class="n">ahc_freeze_scb</span><span class="p">(</span><span class="n">scbp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">scbp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Inactive SCB on pending list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ahc_done</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scbp</span><span class="p">);</span>
			<span class="n">found</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">active_scb</span><span class="p">);</span>
	<span class="n">ahc_platform_abort_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">ahc_release_untagged_queues</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_reset_current_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">scsiseq</span><span class="p">;</span>

	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ENSCSIRST</span><span class="p">);</span>
	<span class="n">scsiseq</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">scsiseq</span> <span class="o">|</span> <span class="n">SCSIRSTO</span><span class="p">);</span>
	<span class="n">ahc_flush_device_writes</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="n">ahc_delay</span><span class="p">(</span><span class="n">AHC_BUSRESET_DELAY</span><span class="p">);</span>
	<span class="cm">/* Turn off the bus reset */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">scsiseq</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCSIRSTO</span><span class="p">);</span>

	<span class="n">ahc_clear_intstat</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="cm">/* Re-enable reset interrupts */</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">|</span> <span class="n">ENSCSIRST</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ahc_reset_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initiate_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">ahc_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">initiator</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">max_scsiid</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">sblkctl</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">scsiseq</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">simode1</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">found</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">restart_needed</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">cur_channel</span><span class="p">;</span>

	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ahc_compile_devinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span>
			    <span class="n">CAM_TARGET_WILDCARD</span><span class="p">,</span>
			    <span class="n">CAM_TARGET_WILDCARD</span><span class="p">,</span>
			    <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span>
			    <span class="n">channel</span><span class="p">,</span> <span class="n">ROLE_UNKNOWN</span><span class="p">);</span>
	<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="cm">/* Make sure the sequencer is in a safe location. */</span>
	<span class="n">ahc_clear_critical_section</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Run our command complete fifos to ensure that we perform</span>
<span class="cm">	 * completion processing on any commands that &#39;completed&#39;</span>
<span class="cm">	 * before the reset occurred.</span>
<span class="cm">	 */</span>
	<span class="n">ahc_run_qoutfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX - In Twin mode, the tqinfifo may have commands</span>
<span class="cm">	 *	 for an unaffected channel in it.  However, if</span>
<span class="cm">	 *	 we have run out of ATIO resources to drain that</span>
<span class="cm">	 *	 queue, we may not get them all out here.  Further,</span>
<span class="cm">	 *	 the blocked transactions for the reset channel</span>
<span class="cm">	 *	 should just be killed off, irrespecitve of whether</span>
<span class="cm">	 *	 we are blocked on ATIO resources.  Write a routine</span>
<span class="cm">	 *	 to compact the tqinfifo appropriately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_run_tqinfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the bus if we are initiating this reset</span>
<span class="cm">	 */</span>
	<span class="n">sblkctl</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
	<span class="n">cur_channel</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">sblkctl</span> <span class="o">&amp;</span> <span class="n">SELBUSB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
	    <span class="n">cur_channel</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>
	<span class="n">scsiseq</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ_TEMPLATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_channel</span> <span class="o">!=</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Case 1: Command for another bus is active</span>
<span class="cm">		 * Stealthily reset the other bus without</span>
<span class="cm">		 * upsetting the current bus.</span>
<span class="cm">		 */</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">sblkctl</span> <span class="o">^</span> <span class="n">SELBUSB</span><span class="p">);</span>
		<span class="n">simode1</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ENBUSFREE</span><span class="o">|</span><span class="n">ENSCSIRST</span><span class="p">);</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
		<span class="cm">/*</span>
<span class="cm">		 * Bus resets clear ENSELI, so we cannot</span>
<span class="cm">		 * defer re-enabling bus reset interrupts</span>
<span class="cm">		 * if we are in target mode.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">simode1</span> <span class="o">|=</span> <span class="n">ENSCSIRST</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">simode1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">initiate_reset</span><span class="p">)</span>
			<span class="n">ahc_reset_current_bus</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_clear_intstat</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">scsiseq</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSELI</span><span class="o">|</span><span class="n">ENRSELI</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">));</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">sblkctl</span><span class="p">);</span>
		<span class="n">restart_needed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Case 2: A command from this bus is active or we&#39;re idle */</span>
		<span class="n">simode1</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ENBUSFREE</span><span class="o">|</span><span class="n">ENSCSIRST</span><span class="p">);</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
		<span class="cm">/*</span>
<span class="cm">		 * Bus resets clear ENSELI, so we cannot</span>
<span class="cm">		 * defer re-enabling bus reset interrupts</span>
<span class="cm">		 * if we are in target mode.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">simode1</span> <span class="o">|=</span> <span class="n">ENSCSIRST</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">,</span> <span class="n">simode1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">initiate_reset</span><span class="p">)</span>
			<span class="n">ahc_reset_current_bus</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_clear_intstat</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">scsiseq</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ENSELI</span><span class="o">|</span><span class="n">ENRSELI</span><span class="o">|</span><span class="n">ENAUTOATNP</span><span class="p">));</span>
		<span class="n">restart_needed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clean up all the state information for the</span>
<span class="cm">	 * pending transactions on this bus.</span>
<span class="cm">	 */</span>
	<span class="n">found</span> <span class="o">=</span> <span class="n">ahc_abort_scbs</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
			       <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span> <span class="n">SCB_LIST_NULL</span><span class="p">,</span>
			       <span class="n">ROLE_UNKNOWN</span><span class="p">,</span> <span class="n">CAM_SCSI_BUS_RESET</span><span class="p">);</span>

	<span class="n">max_scsiid</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>

<span class="cp">#ifdef AHC_TARGET_MODE</span>
	<span class="cm">/*</span>
<span class="cm">	 * Send an immediate notify ccb to all target more peripheral</span>
<span class="cm">	 * drivers affected by this action.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;=</span> <span class="n">max_scsiid</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ahc_tmode_tstate</span><span class="o">*</span> <span class="n">tstate</span><span class="p">;</span>
		<span class="n">u_int</span> <span class="n">lun</span><span class="p">;</span>

		<span class="n">tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">AHC_NUM_LUNS</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ahc_tmode_lstate</span><span class="o">*</span> <span class="n">lstate</span><span class="p">;</span>

			<span class="n">lstate</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">[</span><span class="n">lun</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ahc_queue_lstate_event</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">lstate</span><span class="p">,</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">,</span>
					       <span class="n">EVENT_TYPE_BUS_RESET</span><span class="p">,</span> <span class="cm">/*arg*/</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">ahc_send_lstate_events</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">lstate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Notify the XPT that a bus reset occurred */</span>
	<span class="n">ahc_send_async</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">devinfo</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">,</span>
		       <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span> <span class="n">AC_BUS_RESET</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Revert to async/narrow transfers until we renegotiate.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;=</span> <span class="n">max_scsiid</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">initiator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">initiator</span> <span class="o">&lt;=</span> <span class="n">max_scsiid</span><span class="p">;</span> <span class="n">initiator</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ahc_devinfo</span> <span class="n">devinfo</span><span class="p">;</span>

			<span class="n">ahc_compile_devinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">initiator</span><span class="p">,</span>
					    <span class="n">CAM_LUN_WILDCARD</span><span class="p">,</span>
					    <span class="n">channel</span><span class="p">,</span> <span class="n">ROLE_UNKNOWN</span><span class="p">);</span>
			<span class="n">ahc_set_width</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span> <span class="n">MSG_EXT_WDTR_BUS_8_BIT</span><span class="p">,</span>
				      <span class="n">AHC_TRANS_CUR</span><span class="p">,</span> <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
			<span class="n">ahc_set_syncrate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devinfo</span><span class="p">,</span> <span class="cm">/*syncrate*/</span><span class="nb">NULL</span><span class="p">,</span>
					 <span class="cm">/*period*/</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/*offset*/</span><span class="mi">0</span><span class="p">,</span>
					 <span class="cm">/*ppr_options*/</span><span class="mi">0</span><span class="p">,</span> <span class="n">AHC_TRANS_CUR</span><span class="p">,</span>
					 <span class="cm">/*paused*/</span><span class="n">TRUE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart_needed</span><span class="p">)</span>
		<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***************************** Residual Processing ****************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Calculate the residual for a just completed SCB.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_calc_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hardware_scb</span> <span class="o">*</span><span class="n">hscb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">status_pkt</span> <span class="o">*</span><span class="n">spkt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sgptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">resid_sgptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">resid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 5 cases.</span>
<span class="cm">	 * 1) No residual.</span>
<span class="cm">	 *    SG_RESID_VALID clear in sgptr.</span>
<span class="cm">	 * 2) Transferless command</span>
<span class="cm">	 * 3) Never performed any transfers.</span>
<span class="cm">	 *    sgptr has SG_FULL_RESID set.</span>
<span class="cm">	 * 4) No residual but target did not</span>
<span class="cm">	 *    save data pointers after the</span>
<span class="cm">	 *    last transfer, so sgptr was</span>
<span class="cm">	 *    never updated.</span>
<span class="cm">	 * 5) We have a partial residual.</span>
<span class="cm">	 *    Use residual_sgptr to determine</span>
<span class="cm">	 *    where we are.</span>
<span class="cm">	 */</span>

	<span class="n">hscb</span> <span class="o">=</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="p">;</span>
	<span class="n">sgptr</span> <span class="o">=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">sgptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sgptr</span> <span class="o">&amp;</span> <span class="n">SG_RESID_VALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Case 1 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sgptr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SG_RESID_VALID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sgptr</span> <span class="o">&amp;</span> <span class="n">SG_LIST_NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Case 2 */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spkt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">shared_data</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="n">resid_sgptr</span> <span class="o">=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">spkt</span><span class="o">-&gt;</span><span class="n">residual_sg_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sgptr</span> <span class="o">&amp;</span> <span class="n">SG_FULL_RESID</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Case 3 */</span>
		<span class="n">resid</span> <span class="o">=</span> <span class="n">ahc_get_transfer_length</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">resid_sgptr</span> <span class="o">&amp;</span> <span class="n">SG_LIST_NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Case 4 */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">resid_sgptr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SG_PTR_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Bogus resid sgptr value 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resid_sgptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ahc_dma_seg</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Remainder of the SG where the transfer</span>
<span class="cm">		 * stopped.  </span>
<span class="cm">		 */</span>
		<span class="n">resid</span> <span class="o">=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">spkt</span><span class="o">-&gt;</span><span class="n">residual_datacnt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AHC_SG_LEN_MASK</span><span class="p">;</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">ahc_sg_bus_to_virt</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">resid_sgptr</span> <span class="o">&amp;</span> <span class="n">SG_PTR_MASK</span><span class="p">);</span>

		<span class="cm">/* The residual sg_ptr always points to the next sg */</span>
		<span class="n">sg</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Add up the contents of all residual</span>
<span class="cm">		 * SG segments that are after the SG where</span>
<span class="cm">		 * the transfer stopped.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AHC_DMA_LAST_SEG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
			<span class="n">resid</span> <span class="o">+=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AHC_SG_LEN_MASK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_set_residual</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ahc_set_sense_residual</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>

<span class="cp">#ifdef AHC_DEBUG</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc_debug</span> <span class="o">&amp;</span> <span class="n">AHC_SHOW_MISC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_print_path</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">scb</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Handled %sResidual of %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SCB_SENSE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Sense &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/******************************* Target Mode **********************************/</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
<span class="cm">/*</span>
<span class="cm"> * Add a target mode event to this lun&#39;s queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_queue_lstate_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_tmode_lstate</span> <span class="o">*</span><span class="n">lstate</span><span class="p">,</span>
		       <span class="n">u_int</span> <span class="n">initiator_id</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">event_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahc_tmode_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pending</span><span class="p">;</span>

	<span class="n">xpt_freeze_devq</span><span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="cm">/*count*/</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_w_idx</span> <span class="o">&gt;=</span> <span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span><span class="p">)</span>
		<span class="n">pending</span> <span class="o">=</span> <span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_w_idx</span> <span class="o">-</span> <span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pending</span> <span class="o">=</span> <span class="n">AHC_TMODE_EVENT_BUFFER_SIZE</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="o">-</span> <span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span> <span class="o">-</span> <span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_w_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">EVENT_TYPE_BUS_RESET</span>
	 <span class="o">||</span> <span class="n">event_type</span> <span class="o">==</span> <span class="n">MSG_BUS_DEV_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Any earlier events are irrelevant, so reset our buffer.</span>
<span class="cm">		 * This has the effect of allowing us to deal with reset</span>
<span class="cm">		 * floods (an external device holding down the reset line)</span>
<span class="cm">		 * without losing the event that is really interesting.</span>
<span class="cm">		 */</span>
		<span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_w_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xpt_release_devq</span><span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">pending</span><span class="p">,</span> <span class="cm">/*runqueue*/</span><span class="n">FALSE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">==</span> <span class="n">AHC_TMODE_EVENT_BUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xpt_print_path</span><span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;immediate event %x:%x lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_buffer</span><span class="p">[</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span><span class="p">].</span><span class="n">event_type</span><span class="p">,</span>
		       <span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_buffer</span><span class="p">[</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span><span class="p">].</span><span class="n">event_arg</span><span class="p">);</span>
		<span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span> <span class="o">==</span> <span class="n">AHC_TMODE_EVENT_BUFFER_SIZE</span><span class="p">)</span>
			<span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xpt_release_devq</span><span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="cm">/*count*/</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/*runqueue*/</span><span class="n">FALSE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">event</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_buffer</span><span class="p">[</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_w_idx</span><span class="p">];</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">initiator_id</span> <span class="o">=</span> <span class="n">initiator_id</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">event_type</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">event_arg</span> <span class="o">=</span> <span class="n">event_arg</span><span class="p">;</span>
	<span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_w_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_w_idx</span> <span class="o">==</span> <span class="n">AHC_TMODE_EVENT_BUFFER_SIZE</span><span class="p">)</span>
		<span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_w_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send any target mode events queued up waiting</span>
<span class="cm"> * for immediate notify resources.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ahc_send_lstate_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ahc_tmode_lstate</span> <span class="o">*</span><span class="n">lstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccb_hdr</span> <span class="o">*</span><span class="n">ccbh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccb_immed_notify</span> <span class="o">*</span><span class="n">inot</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span> <span class="o">!=</span> <span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_w_idx</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ccbh</span> <span class="o">=</span> <span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">immed_notifies</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ahc_tmode_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>

		<span class="n">event</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_buffer</span><span class="p">[</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span><span class="p">];</span>
		<span class="n">SLIST_REMOVE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">immed_notifies</span><span class="p">,</span> <span class="n">sim_links</span><span class="p">.</span><span class="n">sle</span><span class="p">);</span>
		<span class="n">inot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccb_immed_notify</span> <span class="o">*</span><span class="p">)</span><span class="n">ccbh</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EVENT_TYPE_BUS_RESET</span>:
			<span class="n">ccbh</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_SCSI_BUS_RESET</span><span class="o">|</span><span class="n">CAM_DEV_QFRZN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ccbh</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_MESSAGE_RECV</span><span class="o">|</span><span class="n">CAM_DEV_QFRZN</span><span class="p">;</span>
			<span class="n">inot</span><span class="o">-&gt;</span><span class="n">message_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">;</span>
			<span class="n">inot</span><span class="o">-&gt;</span><span class="n">message_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">event_arg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inot</span><span class="o">-&gt;</span><span class="n">initiator_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">initiator_id</span><span class="p">;</span>
		<span class="n">inot</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xpt_done</span><span class="p">((</span><span class="k">union</span> <span class="n">ccb</span> <span class="o">*</span><span class="p">)</span><span class="n">inot</span><span class="p">);</span>
		<span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span> <span class="o">==</span> <span class="n">AHC_TMODE_EVENT_BUFFER_SIZE</span><span class="p">)</span>
			<span class="n">lstate</span><span class="o">-&gt;</span><span class="n">event_r_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/******************** Sequencer Program Patching/Download *********************/</span>

<span class="cp">#ifdef AHC_DUMP_SEQ</span>
<span class="kt">void</span>
<span class="nf">ahc_dumpseq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span><span class="o">*</span> <span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">,</span> <span class="n">PERRORDIS</span><span class="o">|</span><span class="n">FAILDIS</span><span class="o">|</span><span class="n">FASTMODE</span><span class="o">|</span><span class="n">LOADRAM</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">instruction_ram_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">ins_bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

		<span class="n">ahc_insb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQRAM</span><span class="p">,</span> <span class="n">ins_bytes</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ins_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span>
				 <span class="o">|</span> <span class="n">ins_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
				 <span class="o">|</span> <span class="n">ins_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
				 <span class="o">|</span> <span class="n">ins_bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ahc_loadseq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">cs</span> <span class="n">cs_table</span><span class="p">[</span><span class="n">num_critical_sections</span><span class="p">];</span>
	<span class="n">u_int</span>	<span class="n">begin_set</span><span class="p">[</span><span class="n">num_critical_sections</span><span class="p">];</span>
	<span class="n">u_int</span>	<span class="n">end_set</span><span class="p">[</span><span class="n">num_critical_sections</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">cur_patch</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">cs_count</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">cur_cs</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">skip_addr</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">sg_prefetch_cnt</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">downloaded</span><span class="p">;</span>
	<span class="kt">uint8_t</span>	<span class="n">download_consts</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start out with 0 critical sections</span>
<span class="cm">	 * that apply to this firmware load.</span>
<span class="cm">	 */</span>
	<span class="n">cs_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cur_cs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">begin_set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">begin_set</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">end_set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">end_set</span><span class="p">));</span>

	<span class="cm">/* Setup downloadable constant table */</span>
	<span class="n">download_consts</span><span class="p">[</span><span class="n">QOUTFIFO_OFFSET</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">targetcmds</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">download_consts</span><span class="p">[</span><span class="n">QOUTFIFO_OFFSET</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">download_consts</span><span class="p">[</span><span class="n">QINFIFO_OFFSET</span><span class="p">]</span> <span class="o">=</span> <span class="n">download_consts</span><span class="p">[</span><span class="n">QOUTFIFO_OFFSET</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">download_consts</span><span class="p">[</span><span class="n">CACHESIZE_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pci_cachesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">download_consts</span><span class="p">[</span><span class="n">INVERTED_CACHESIZE_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pci_cachesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_prefetch_cnt</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pci_cachesize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sg_prefetch_cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_dma_seg</span><span class="p">)))</span>
		<span class="n">sg_prefetch_cnt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_dma_seg</span><span class="p">);</span>
	<span class="n">download_consts</span><span class="p">[</span><span class="n">SG_PREFETCH_CNT</span><span class="p">]</span> <span class="o">=</span> <span class="n">sg_prefetch_cnt</span><span class="p">;</span>
	<span class="n">download_consts</span><span class="p">[</span><span class="n">SG_PREFETCH_ALIGN_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">sg_prefetch_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">download_consts</span><span class="p">[</span><span class="n">SG_PREFETCH_ADDR_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sg_prefetch_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">cur_patch</span> <span class="o">=</span> <span class="n">patches</span><span class="p">;</span>
	<span class="n">downloaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skip_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">,</span> <span class="n">PERRORDIS</span><span class="o">|</span><span class="n">FAILDIS</span><span class="o">|</span><span class="n">FASTMODE</span><span class="o">|</span><span class="n">LOADRAM</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">seqprog</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_check_patch</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_patch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skip_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Don&#39;t download this instruction as it</span>
<span class="cm">			 * is in a patch that was removed.</span>
<span class="cm">			 */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">downloaded</span> <span class="o">==</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">instruction_ram_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We&#39;re about to exceed the instruction</span>
<span class="cm">			 * storage capacity for this chip.  Fail</span>
<span class="cm">			 * the load.</span>
<span class="cm">			 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%s: Program too large for instruction memory &quot;</span>
			       <span class="s">&quot;size of %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span>
			       <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">instruction_ram_size</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Move through the CS table until we find a CS</span>
<span class="cm">		 * that might apply to this instruction.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">cur_cs</span> <span class="o">&lt;</span> <span class="n">num_critical_sections</span><span class="p">;</span> <span class="n">cur_cs</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">critical_sections</span><span class="p">[</span><span class="n">cur_cs</span><span class="p">].</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">begin_set</span><span class="p">[</span><span class="n">cs_count</span><span class="p">]</span> <span class="o">==</span> <span class="n">TRUE</span>
				 <span class="o">&amp;&amp;</span> <span class="n">end_set</span><span class="p">[</span><span class="n">cs_count</span><span class="p">]</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cs_table</span><span class="p">[</span><span class="n">cs_count</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">downloaded</span><span class="p">;</span>
				 	<span class="n">end_set</span><span class="p">[</span><span class="n">cs_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
					<span class="n">cs_count</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">critical_sections</span><span class="p">[</span><span class="n">cur_cs</span><span class="p">].</span><span class="n">begin</span> <span class="o">&lt;=</span> <span class="n">i</span>
			 <span class="o">&amp;&amp;</span> <span class="n">begin_set</span><span class="p">[</span><span class="n">cs_count</span><span class="p">]</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cs_table</span><span class="p">[</span><span class="n">cs_count</span><span class="p">].</span><span class="n">begin</span> <span class="o">=</span> <span class="n">downloaded</span><span class="p">;</span>
				<span class="n">begin_set</span><span class="p">[</span><span class="n">cs_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ahc_download_instr</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">download_consts</span><span class="p">);</span>
		<span class="n">downloaded</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">num_critical_sections</span> <span class="o">=</span> <span class="n">cs_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">cs_count</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs</span><span class="p">);</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">critical_sections</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">cs_count</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">critical_sections</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;ahc_loadseq: Could not malloc&quot;</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">critical_sections</span><span class="p">,</span> <span class="n">cs_table</span><span class="p">,</span> <span class="n">cs_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">,</span> <span class="n">PERRORDIS</span><span class="o">|</span><span class="n">FAILDIS</span><span class="o">|</span><span class="n">FASTMODE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %d instructions downloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">downloaded</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Features 0x%x, Bugs 0x%x, Flags 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">bugs</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ahc_check_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">**</span><span class="n">start_patch</span><span class="p">,</span>
		<span class="n">u_int</span> <span class="n">start_instr</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="n">skip_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">cur_patch</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">last_patch</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">num_patches</span><span class="p">;</span>

	<span class="n">num_patches</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">patches</span><span class="p">);</span>
	<span class="n">last_patch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patches</span><span class="p">[</span><span class="n">num_patches</span><span class="p">];</span>
	<span class="n">cur_patch</span> <span class="o">=</span> <span class="o">*</span><span class="n">start_patch</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cur_patch</span> <span class="o">&lt;</span> <span class="n">last_patch</span> <span class="o">&amp;&amp;</span> <span class="n">start_instr</span> <span class="o">==</span> <span class="n">cur_patch</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_patch</span><span class="o">-&gt;</span><span class="n">patch_func</span><span class="p">(</span><span class="n">ahc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Start rejecting code */</span>
			<span class="o">*</span><span class="n">skip_addr</span> <span class="o">=</span> <span class="n">start_instr</span> <span class="o">+</span> <span class="n">cur_patch</span><span class="o">-&gt;</span><span class="n">skip_instr</span><span class="p">;</span>
			<span class="n">cur_patch</span> <span class="o">+=</span> <span class="n">cur_patch</span><span class="o">-&gt;</span><span class="n">skip_patch</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Accepted this patch.  Advance to the next</span>
<span class="cm">			 * one and wait for our intruction pointer to</span>
<span class="cm">			 * hit this point.</span>
<span class="cm">			 */</span>
			<span class="n">cur_patch</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">start_patch</span> <span class="o">=</span> <span class="n">cur_patch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start_instr</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">skip_addr</span><span class="p">)</span>
		<span class="cm">/* Still skipping */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_download_instr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">instrptr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">dconsts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span>	<span class="n">ins_formats</span> <span class="n">instr</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ins_format1</span> <span class="o">*</span><span class="n">fmt1_ins</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ins_format3</span> <span class="o">*</span><span class="n">fmt3_ins</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">opcode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The firmware is always compiled into a little endian format.</span>
<span class="cm">	 */</span>
	<span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="n">ahc_le32toh</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">seqprog</span><span class="p">[</span><span class="n">instrptr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]);</span>

	<span class="n">fmt1_ins</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">instr</span><span class="p">.</span><span class="n">format1</span><span class="p">;</span>
	<span class="n">fmt3_ins</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Pull the opcode */</span>
	<span class="n">opcode</span> <span class="o">=</span> <span class="n">instr</span><span class="p">.</span><span class="n">format1</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AIC_OP_JMP</span>:
	<span class="k">case</span> <span class="n">AIC_OP_JC</span>:
	<span class="k">case</span> <span class="n">AIC_OP_JNC</span>:
	<span class="k">case</span> <span class="n">AIC_OP_CALL</span>:
	<span class="k">case</span> <span class="n">AIC_OP_JNE</span>:
	<span class="k">case</span> <span class="n">AIC_OP_JNZ</span>:
	<span class="k">case</span> <span class="n">AIC_OP_JE</span>:
	<span class="k">case</span> <span class="n">AIC_OP_JZ</span>:
	<span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">cur_patch</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">address_offset</span><span class="p">;</span>
		<span class="n">u_int</span> <span class="n">address</span><span class="p">;</span>
		<span class="n">u_int</span> <span class="n">skip_addr</span><span class="p">;</span>
		<span class="n">u_int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">fmt3_ins</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">instr</span><span class="p">.</span><span class="n">format3</span><span class="p">;</span>
		<span class="n">address_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">address</span> <span class="o">=</span> <span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
		<span class="n">cur_patch</span> <span class="o">=</span> <span class="n">patches</span><span class="p">;</span>
		<span class="n">skip_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">address</span><span class="p">;)</span> <span class="p">{</span>

			<span class="n">ahc_check_patch</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_patch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skip_addr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skip_addr</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">end_addr</span><span class="p">;</span>

				<span class="n">end_addr</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">skip_addr</span><span class="p">);</span>
				<span class="n">address_offset</span> <span class="o">+=</span> <span class="n">end_addr</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">skip_addr</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">address</span> <span class="o">-=</span> <span class="n">address_offset</span><span class="p">;</span>
		<span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">AIC_OP_OR</span>:
	<span class="k">case</span> <span class="n">AIC_OP_AND</span>:
	<span class="k">case</span> <span class="n">AIC_OP_XOR</span>:
	<span class="k">case</span> <span class="n">AIC_OP_ADD</span>:
	<span class="k">case</span> <span class="n">AIC_OP_ADC</span>:
	<span class="k">case</span> <span class="n">AIC_OP_BMOV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">=</span> <span class="n">dconsts</span><span class="p">[</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_CMD_CHAN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		 <span class="o">&amp;&amp;</span> <span class="n">opcode</span> <span class="o">==</span> <span class="n">AIC_OP_BMOV</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Block move was added at the same time</span>
<span class="cm">			 * as the command channel.  Verify that</span>
<span class="cm">			 * this is only a move of a single element</span>
<span class="cm">			 * and convert the BMOV to a MOV</span>
<span class="cm">			 * (AND with an immediate of FF).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: BMOV not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
			<span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">AIC_OP_AND</span><span class="p">;</span>
			<span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">immediate</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="n">AIC_OP_ROL</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

			<span class="cm">/* Calculate odd parity for the instruction */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">uint32_t</span> <span class="n">mask</span><span class="p">;</span>

				<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">instr</span><span class="p">.</span><span class="n">format1</span><span class="p">.</span><span class="n">parity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Compress the instruction for older sequencers */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmt3_ins</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span>
					<span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">immediate</span>
				      <span class="o">|</span> <span class="p">(</span><span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				      <span class="o">|</span> <span class="p">(</span><span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
				      <span class="o">|</span>	<span class="p">(</span><span class="n">fmt3_ins</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span>
					<span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">immediate</span>
				      <span class="o">|</span> <span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				      <span class="o">|</span> <span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">destination</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
				      <span class="o">|</span>	<span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
				      <span class="o">|</span>	<span class="p">(</span><span class="n">fmt1_ins</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* The sequencer is a little endian cpu */</span>
		<span class="n">instr</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="n">ahc_htole32</span><span class="p">(</span><span class="n">instr</span><span class="p">.</span><span class="n">integer</span><span class="p">);</span>
		<span class="n">ahc_outsb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQRAM</span><span class="p">,</span> <span class="n">instr</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unknown opcode encountered in seq program&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ahc_print_register</span><span class="p">(</span><span class="k">const</span> <span class="n">ahc_reg_parse_entry_t</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">num_entries</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">address</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">value</span><span class="p">,</span>
		   <span class="n">u_int</span> <span class="o">*</span><span class="n">cur_column</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">wrap_point</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">printed</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">printed_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_column</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cur_column</span> <span class="o">&gt;=</span> <span class="n">wrap_point</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cur_column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printed</span>  <span class="o">=</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s[0x%x]&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printed</span> <span class="o">+=</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">cur_column</span> <span class="o">+=</span> <span class="n">printed</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">printed</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printed_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">printed_mask</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">table</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span>
			  <span class="o">!=</span> <span class="n">table</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">value</span><span class="p">)</span>
			 <span class="o">||</span> <span class="p">((</span><span class="n">printed_mask</span> <span class="o">&amp;</span> <span class="n">table</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span>
			  <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mask</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">printed</span> <span class="o">+=</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span>
					  <span class="n">printed_mask</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;:(&quot;</span> <span class="o">:</span> <span class="s">&quot;|&quot;</span><span class="p">,</span>
					  <span class="n">table</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="n">printed_mask</span> <span class="o">|=</span> <span class="n">table</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
			
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&gt;=</span> <span class="n">num_entries</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">printed_mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printed</span> <span class="o">+=</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;) &quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printed</span> <span class="o">+=</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_column</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cur_column</span> <span class="o">+=</span> <span class="n">printed</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">printed</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_dump_card_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">scb_tailq</span> <span class="o">*</span><span class="n">untagged_q</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">cur_col</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">paused</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">target</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">maxtarget</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">last_phase</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">qinpos</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">qintail</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">qoutpos</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">scb_index</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">saved_scbptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahc_is_paused</span><span class="p">(</span><span class="n">ahc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">paused</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">paused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">saved_scbptr</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">);</span>
	<span class="n">last_phase</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Dump Card State Begins &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;%s: Dumping Card State %s, at SEQADDR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">),</span> <span class="n">ahc_lookup_phase_entry</span><span class="p">(</span><span class="n">last_phase</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phasemsg</span><span class="p">,</span>
	       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQADDR1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paused</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Card was paused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ACCUM = 0x%x, SINDEX = 0x%x, DINDEX = 0x%x, ARG_2 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ACCUM</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SINDEX</span><span class="p">),</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DINDEX</span><span class="p">),</span>
	       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ARG_2</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;HCNT = 0x%x SCBPTR = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HCNT</span><span class="p">),</span>
	       <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">));</span>
	<span class="n">cur_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_scsiphase_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIPHASE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_scsisigi_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISIGI</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_error_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_scsibusl_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIBUSL</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_lastphase_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">LASTPHASE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_scsiseq_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_sblkctl_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_scsirate_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIRATE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_seqctl_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQCTL</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_seq_flags_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SEQ_FLAGS</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_sstat0_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_sstat1_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_sstat2_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_sstat3_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SSTAT3</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_simode0_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_simode1_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SIMODE1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_sxfrctl0_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SXFRCTL0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_dfcntrl_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DFCNTRL</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">ahc_dfstatus_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DFSTATUS</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_col</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;STACK:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STACK_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; 0x%x&quot;</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">STACK</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">STACK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">SCB count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">numscbs</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Kernel NEXTQSCB = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">next_queued_scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Card NEXTQSCB = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">NEXT_QUEUED_SCB</span><span class="p">));</span>
	<span class="cm">/* QINFIFO */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;QINFIFO entries: &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_QUEUE_REGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qinpos</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SNSCB_QOFF</span><span class="p">);</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SNSCB_QOFF</span><span class="p">,</span> <span class="n">qinpos</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qinpos</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">QINPOS</span><span class="p">);</span>
	<span class="n">qintail</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifonext</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">qinpos</span> <span class="o">!=</span> <span class="n">qintail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qinfifo</span><span class="p">[</span><span class="n">qinpos</span><span class="p">]);</span>
		<span class="n">qinpos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Waiting Queue entries: &quot;</span><span class="p">);</span>
	<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">WAITING_SCBH</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d:%d &quot;</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">));</span>
		<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Disconnected Queue entries: &quot;</span><span class="p">);</span>
	<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">DISCONNECTED_SCBH</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d:%d &quot;</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">,</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">));</span>
		<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		
	<span class="n">ahc_sync_qoutfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUS_DMASYNC_POSTREAD</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;QOUTFIFO entries: &quot;</span><span class="p">);</span>
	<span class="n">qoutpos</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifonext</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">qoutpos</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">qoutfifo</span><span class="p">[</span><span class="n">qoutpos</span><span class="p">]);</span>
		<span class="n">qoutpos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Sequencer Free SCB List: &quot;</span><span class="p">);</span>
	<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">FREE_SCBH</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">scb_index</span> <span class="o">!=</span> <span class="n">SCB_LIST_NULL</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">scb_index</span><span class="p">);</span>
		<span class="n">scb_index</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_NEXT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Sequencer SCB Info: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">maxhscbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">cur_col</span>  <span class="o">=</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%3d &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">ahc_scb_control_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
		<span class="n">ahc_scb_scsiid_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_SCSIID</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
		<span class="n">ahc_scb_lun_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_LUN</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
		<span class="n">ahc_scb_tag_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Pending list: &quot;</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LIST_FOREACH</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_scbs</span><span class="p">,</span> <span class="n">pending_links</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cur_col</span>  <span class="o">=</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%3d &quot;</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
		<span class="n">ahc_scb_control_print</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
		<span class="n">ahc_scb_scsiid_print</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">scsiid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
		<span class="n">ahc_scb_lun_print</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_PAGESCBS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">);</span>
			<span class="n">ahc_scb_control_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_CONTROL</span><span class="p">),</span>
					      <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
			<span class="n">ahc_scb_tag_print</span><span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCB_TAG</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cur_col</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Kernel Free SCB list: &quot;</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SLIST_FOREACH</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">scb_data</span><span class="o">-&gt;</span><span class="n">free_scbs</span><span class="p">,</span> <span class="n">links</span><span class="p">.</span><span class="n">sle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">maxtarget</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AHC_WIDE</span><span class="o">|</span><span class="n">AHC_TWIN</span><span class="p">))</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;=</span> <span class="n">maxtarget</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">untagged_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">untagged_queues</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TAILQ_FIRST</span><span class="p">(</span><span class="n">untagged_q</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Untagged Q(%d): &quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">TAILQ_FOREACH</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="n">untagged_q</span><span class="p">,</span> <span class="n">links</span><span class="p">.</span><span class="n">tqe</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">scb</span><span class="o">-&gt;</span><span class="n">hscb</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ahc_platform_dump_card_state</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Dump Card State Ends &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCBPTR</span><span class="p">,</span> <span class="n">saved_scbptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************* Target Mode ****************************************/</span>
<span class="cp">#ifdef AHC_TARGET_MODE</span>
<span class="n">cam_status</span>
<span class="nf">ahc_find_tmode_devs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cam_sim</span> <span class="o">*</span><span class="n">sim</span><span class="p">,</span> <span class="k">union</span> <span class="n">ccb</span> <span class="o">*</span><span class="n">ccb</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ahc_tmode_tstate</span> <span class="o">**</span><span class="n">tstate</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ahc_tmode_lstate</span> <span class="o">**</span><span class="n">lstate</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">notfound_failure</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETMODE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">CAM_REQ_INVALID</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle the &#39;black hole&#39; device that sucks up</span>
<span class="cm">	 * requests to unattached luns on enabled targets.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_id</span> <span class="o">==</span> <span class="n">CAM_TARGET_WILDCARD</span>
	 <span class="o">&amp;&amp;</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_lun</span> <span class="o">==</span> <span class="n">CAM_LUN_WILDCARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tstate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">black_hole</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">max_id</span><span class="p">;</span>

		<span class="n">max_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_WIDE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_id</span> <span class="o">&gt;=</span> <span class="n">max_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">CAM_TID_INVALID</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_lun</span> <span class="o">&gt;=</span> <span class="n">AHC_NUM_LUNS</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">CAM_LUN_INVALID</span><span class="p">);</span>

		<span class="o">*</span><span class="n">tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_id</span><span class="p">];</span>
		<span class="o">*</span><span class="n">lstate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">lstate</span> <span class="o">=</span>
			    <span class="p">(</span><span class="o">*</span><span class="n">tstate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">[</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_lun</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notfound_failure</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">lstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">CAM_PATH_INVALID</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">CAM_REQ_CMP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ahc_handle_en_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cam_sim</span> <span class="o">*</span><span class="n">sim</span><span class="p">,</span> <span class="k">union</span> <span class="n">ccb</span> <span class="o">*</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	   <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
	<span class="k">struct</span>	   <span class="n">ahc_tmode_lstate</span> <span class="o">*</span><span class="n">lstate</span><span class="p">;</span>
	<span class="k">struct</span>	   <span class="n">ccb_en_lun</span> <span class="o">*</span><span class="n">cel</span><span class="p">;</span>
	<span class="n">cam_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u_long</span>	   <span class="n">s</span><span class="p">;</span>
	<span class="n">u_int</span>	   <span class="n">target</span><span class="p">;</span>
	<span class="n">u_int</span>	   <span class="n">lun</span><span class="p">;</span>
	<span class="n">u_int</span>	   <span class="n">target_mask</span><span class="p">;</span>
	<span class="n">u_int</span>	   <span class="n">our_id</span><span class="p">;</span>
	<span class="kt">int</span>	   <span class="n">error</span><span class="p">;</span>
	<span class="kt">char</span>	   <span class="n">channel</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ahc_find_tmode_devs</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">ccb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lstate</span><span class="p">,</span>
				     <span class="cm">/*notfound_failure*/</span><span class="n">FALSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CAM_REQ_CMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam_sim_bus</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id_b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_id</span> <span class="o">!=</span> <span class="n">our_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * our_id represents our initiator ID, or</span>
<span class="cm">		 * the ID of the first target to have an</span>
<span class="cm">		 * enabled lun in target mode.  There are</span>
<span class="cm">		 * two cases that may preclude enabling a</span>
<span class="cm">		 * target id other than our_id.</span>
<span class="cm">		 *</span>
<span class="cm">		 *   o our_id is for an active initiator role.</span>
<span class="cm">		 *     Since the hardware does not support</span>
<span class="cm">		 *     reselections to the initiator role at</span>
<span class="cm">		 *     anything other than our_id, and our_id</span>
<span class="cm">		 *     is used by the hardware to indicate the</span>
<span class="cm">		 *     ID to use for both select-out and</span>
<span class="cm">		 *     reselect-out operations, the only target</span>
<span class="cm">		 *     ID we can support in this mode is our_id.</span>
<span class="cm">		 *</span>
<span class="cm">		 *   o The MULTARGID feature is not available and</span>
<span class="cm">		 *     a previous target mode ID has been enabled.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTIROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_TID</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		   	 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_INITIATORROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Only allow additional targets if</span>
<span class="cm">				 * the initiator role is disabled.</span>
<span class="cm">				 * The hardware cannot handle a re-select-in</span>
<span class="cm">				 * on the initiator id during a re-select-out</span>
<span class="cm">				 * on a different target id.</span>
<span class="cm">				 */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">CAM_TID_INVALID</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_INITIATORROLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">||</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_luns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Only allow our target id to change</span>
<span class="cm">				 * if the initiator role is not configured</span>
<span class="cm">				 * and there are no enabled luns which</span>
<span class="cm">				 * are attached to the currently registered</span>
<span class="cm">				 * scsi id.</span>
<span class="cm">				 */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">CAM_TID_INVALID</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_TID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_luns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">CAM_TID_INVALID</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CAM_REQ_CMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We now have an id that is valid.</span>
<span class="cm">	 * If we aren&#39;t in target mode, switch modes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHC_TARGETROLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	 <span class="o">&amp;&amp;</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_id</span> <span class="o">!=</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_long</span>	 <span class="n">s</span><span class="p">;</span>
		<span class="n">ahc_flag</span> <span class="n">saved_flags</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Configuring Target Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ahc_lock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_scbs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_BUSY</span><span class="p">;</span>
			<span class="n">ahc_unlock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">saved_flags</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TARGETROLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTIROLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_INITIATORROLE</span><span class="p">;</span>
		<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">ahc_loadseq</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Restore original configuration and notify</span>
<span class="cm">			 * the caller that we cannot support target mode.</span>
<span class="cm">			 * Since the adapter started out in this</span>
<span class="cm">			 * configuration, the firmware load will succeed,</span>
<span class="cm">			 * so there is no point in checking ahc_loadseq&#39;s</span>
<span class="cm">			 * return value.</span>
<span class="cm">			 */</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">saved_flags</span><span class="p">;</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ahc_loadseq</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="n">ahc_unlock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_FUNC_NOTAVAIL</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_unlock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cel</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">cel</span><span class="p">;</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_id</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_lun</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">SIM_CHANNEL</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">sim</span><span class="p">);</span>
	<span class="n">target_mask</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
		<span class="n">target_mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cel</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">scsiseq</span><span class="p">;</span>

		<span class="cm">/* Are we already enabled?? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xpt_print_path</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Lun already enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_LUN_ALRDY_ENA</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cel</span><span class="o">-&gt;</span><span class="n">grp6_len</span> <span class="o">!=</span> <span class="mi">0</span>
		 <span class="o">||</span> <span class="n">cel</span><span class="o">-&gt;</span><span class="n">grp7_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Don&#39;t (yet?) support vendor</span>
<span class="cm">			 * specific commands.</span>
<span class="cm">			 */</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_REQ_INVALID</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Non-zero Group Codes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Seems to be okay.</span>
<span class="cm">		 * Setup our data structures.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="n">CAM_TARGET_WILDCARD</span> <span class="o">&amp;&amp;</span> <span class="n">tstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tstate</span> <span class="o">=</span> <span class="n">ahc_alloc_tstate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xpt_print_path</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t allocate tstate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_RESRC_UNAVAIL</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">lstate</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lstate</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xpt_print_path</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t allocate lstate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_RESRC_UNAVAIL</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lstate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lstate</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">xpt_create_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="cm">/*periph*/</span><span class="nb">NULL</span><span class="p">,</span>
					 <span class="n">xpt_path_path_id</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">),</span>
					 <span class="n">xpt_path_target_id</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">),</span>
					 <span class="n">xpt_path_lun_id</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CAM_REQ_CMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">lstate</span><span class="p">);</span>
			<span class="n">xpt_print_path</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t allocate path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_RESRC_UNAVAIL</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SLIST_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">accept_tios</span><span class="p">);</span>
		<span class="n">SLIST_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">immed_notifies</span><span class="p">);</span>
		<span class="n">ahc_lock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="n">lstate</span><span class="p">;</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_TID</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u_int</span> <span class="n">targid_mask</span><span class="p">;</span>

				<span class="n">targid_mask</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span><span class="p">)</span>
					    <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

				<span class="n">targid_mask</span> <span class="o">|=</span> <span class="n">target_mask</span><span class="p">;</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span><span class="p">,</span> <span class="n">targid_mask</span><span class="p">);</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">targid_mask</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
				
				<span class="n">ahc_update_scsiid</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">targid_mask</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">u_int</span> <span class="n">our_id</span><span class="p">;</span>
				<span class="kt">char</span>  <span class="n">channel</span><span class="p">;</span>

				<span class="n">channel</span> <span class="o">=</span> <span class="n">SIM_CHANNEL</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">sim</span><span class="p">);</span>
				<span class="n">our_id</span> <span class="o">=</span> <span class="n">SIM_SCSI_ID</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">sim</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * This can only happen if selections</span>
<span class="cm">				 * are not enabled</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="n">our_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u_int</span> <span class="n">sblkctl</span><span class="p">;</span>
					<span class="kt">char</span>  <span class="n">cur_channel</span><span class="p">;</span>
					<span class="kt">int</span>   <span class="n">swap</span><span class="p">;</span>

					<span class="n">sblkctl</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">);</span>
					<span class="n">cur_channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">sblkctl</span> <span class="o">&amp;</span> <span class="n">SELBUSB</span><span class="p">)</span>
						    <span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_TWIN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">cur_channel</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
					<span class="n">swap</span> <span class="o">=</span> <span class="n">cur_channel</span> <span class="o">!=</span> <span class="n">channel</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span>
						<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id_b</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">swap</span><span class="p">)</span>
						<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span>
							 <span class="n">sblkctl</span> <span class="o">^</span> <span class="n">SELBUSB</span><span class="p">);</span>

					<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">swap</span><span class="p">)</span>
						<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SBLKCTL</span><span class="p">,</span> <span class="n">sblkctl</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">black_hole</span> <span class="o">=</span> <span class="n">lstate</span><span class="p">;</span>
		<span class="cm">/* Allow select-in operations */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">black_hole</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_luns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsiseq</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ_TEMPLATE</span><span class="p">);</span>
			<span class="n">scsiseq</span> <span class="o">|=</span> <span class="n">ENSELI</span><span class="p">;</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ_TEMPLATE</span><span class="p">,</span> <span class="n">scsiseq</span><span class="p">);</span>
			<span class="n">scsiseq</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">);</span>
			<span class="n">scsiseq</span> <span class="o">|=</span> <span class="n">ENSELI</span><span class="p">;</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">scsiseq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_unlock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_REQ_CMP</span><span class="p">;</span>
		<span class="n">xpt_print_path</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Lun now enabled for target mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">empty</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_LUN_INVALID</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ahc_lock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		
		<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_REQ_CMP</span><span class="p">;</span>
		<span class="n">LIST_FOREACH</span><span class="p">(</span><span class="n">scb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_scbs</span><span class="p">,</span> <span class="n">pending_links</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ccb_hdr</span> <span class="o">*</span><span class="n">ccbh</span><span class="p">;</span>

			<span class="n">ccbh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">io_ctx</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccbh</span><span class="o">-&gt;</span><span class="n">func_code</span> <span class="o">==</span> <span class="n">XPT_CONT_TARGET_IO</span>
			 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xpt_path_comp</span><span class="p">(</span><span class="n">ccbh</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">)){</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CTIO pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_REQ_INVALID</span><span class="p">;</span>
				<span class="n">ahc_unlock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">accept_tios</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ATIOs pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_REQ_INVALID</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">immed_notifies</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;INOTs pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">CAM_REQ_INVALID</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CAM_REQ_CMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahc_unlock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">xpt_print_path</span><span class="p">(</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">path</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Target mode disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">xpt_free_path</span><span class="p">(</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lstate</span><span class="p">);</span>

		<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="cm">/* Can we clean up the target too? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="n">CAM_TARGET_WILDCARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="o">--</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">empty</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ahc_free_tstate</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
						<span class="cm">/*force*/</span><span class="n">FALSE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_TID</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u_int</span> <span class="n">targid_mask</span><span class="p">;</span>

					<span class="n">targid_mask</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span><span class="p">)</span>
						    <span class="o">|</span> <span class="p">(</span><span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
						       <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

					<span class="n">targid_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">target_mask</span><span class="p">;</span>
					<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span><span class="p">,</span> <span class="n">targid_mask</span><span class="p">);</span>
					<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">TARGID</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
					 	 <span class="p">(</span><span class="n">targid_mask</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
					<span class="n">ahc_update_scsiid</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">targid_mask</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">black_hole</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * We can&#39;t allow selections without</span>
<span class="cm">			 * our black hole device.</span>
<span class="cm">			 */</span>
			<span class="n">empty</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_luns</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disallow select-in */</span>
			<span class="n">u_int</span> <span class="n">scsiseq</span><span class="p">;</span>

			<span class="n">scsiseq</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ_TEMPLATE</span><span class="p">);</span>
			<span class="n">scsiseq</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENSELI</span><span class="p">;</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ_TEMPLATE</span><span class="p">,</span> <span class="n">scsiseq</span><span class="p">);</span>
			<span class="n">scsiseq</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">);</span>
			<span class="n">scsiseq</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENSELI</span><span class="p">;</span>
			<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSISEQ</span><span class="p">,</span> <span class="n">scsiseq</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTIROLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Configuring Initiator Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_TARGETROLE</span><span class="p">;</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_INITIATORROLE</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * Returning to a configuration that</span>
<span class="cm">				 * fit previously will always succeed.</span>
<span class="cm">				 */</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ahc_loadseq</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
				<span class="n">ahc_restart</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Unpaused.  The extra unpause</span>
<span class="cm">				 * that follows is harmless.</span>
<span class="cm">				 */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
		<span class="n">ahc_unlock</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_update_scsiid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">targid_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">scsiid_mask</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">scsiid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_MULTI_TID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;ahc_update_scsiid called on non-multitid unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we will rely on the TARGID mask</span>
<span class="cm">	 * for selection enables, ensure that OID</span>
<span class="cm">	 * in SCSIID is not set to some other ID</span>
<span class="cm">	 * that we don&#39;t want to allow selections on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">scsiid</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID_ULTRA2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">scsiid</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">);</span>
	<span class="n">scsiid_mask</span> <span class="o">=</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">scsiid</span> <span class="o">&amp;</span> <span class="n">OID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">targid_mask</span> <span class="o">&amp;</span> <span class="n">scsiid_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_int</span> <span class="n">our_id</span><span class="p">;</span>

		<span class="cm">/* ffs counts from 1 */</span>
		<span class="n">our_id</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">targid_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">our_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">our_id</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">our_id</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">our_id</span><span class="o">--</span><span class="p">;</span>
		<span class="n">scsiid</span> <span class="o">&amp;=</span> <span class="n">TID</span><span class="p">;</span>
		<span class="n">scsiid</span> <span class="o">|=</span> <span class="n">our_id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_ULTRA2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID_ULTRA2</span><span class="p">,</span> <span class="n">scsiid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">SCSIID</span><span class="p">,</span> <span class="n">scsiid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ahc_run_tqinfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">paused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">target_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the card supports auto-access pause,</span>
<span class="cm">	 * we can access the card directly regardless</span>
<span class="cm">	 * of whether it is paused or not.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_AUTOPAUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">paused</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

	<span class="n">ahc_sync_tqinfifo</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">BUS_DMASYNC_POSTREAD</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">targetcmds</span><span class="p">[</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">cmd_valid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Only advance through the queue if we</span>
<span class="cm">		 * have the resources to process the command.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahc_handle_target_cmd</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ahc_dmamap_sync</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmat</span><span class="p">,</span>
				<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">shared_data_dmamap</span><span class="p">,</span>
				<span class="n">ahc_targetcmd_offset</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">target_cmd</span><span class="p">),</span>
				<span class="n">BUS_DMASYNC_PREREAD</span><span class="p">);</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Lazily update our position in the target mode incoming</span>
<span class="cm">		 * command queue as seen by the sequencer.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HOST_TQINPOS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ahc</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">AHC_HS_MAILBOX</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u_int</span> <span class="n">hs_mailbox</span><span class="p">;</span>

				<span class="n">hs_mailbox</span> <span class="o">=</span> <span class="n">ahc_inb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HS_MAILBOX</span><span class="p">);</span>
				<span class="n">hs_mailbox</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HOST_TQINPOS</span><span class="p">;</span>
				<span class="n">hs_mailbox</span> <span class="o">|=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span> <span class="o">&amp;</span> <span class="n">HOST_TQINPOS</span><span class="p">;</span>
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">HS_MAILBOX</span><span class="p">,</span> <span class="n">hs_mailbox</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">paused</span><span class="p">)</span>
					<span class="n">ahc_pause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>	
				<span class="n">ahc_outb</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">KERNEL_TQINPOS</span><span class="p">,</span>
					 <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">tqinfifonext</span> <span class="o">&amp;</span> <span class="n">HOST_TQINPOS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">paused</span><span class="p">)</span>
					<span class="n">ahc_unpause</span><span class="p">(</span><span class="n">ahc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ahc_handle_target_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahc_softc</span> <span class="o">*</span><span class="n">ahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">target_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	  <span class="n">ahc_tmode_tstate</span> <span class="o">*</span><span class="n">tstate</span><span class="p">;</span>
	<span class="k">struct</span>	  <span class="n">ahc_tmode_lstate</span> <span class="o">*</span><span class="n">lstate</span><span class="p">;</span>
	<span class="k">struct</span>	  <span class="n">ccb_accept_tio</span> <span class="o">*</span><span class="n">atio</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">byte</span><span class="p">;</span>
	<span class="kt">int</span>	  <span class="n">initiator</span><span class="p">;</span>
	<span class="kt">int</span>	  <span class="n">target</span><span class="p">;</span>
	<span class="kt">int</span>	  <span class="n">lun</span><span class="p">;</span>

	<span class="n">initiator</span> <span class="o">=</span> <span class="n">SCSIID_TARGET</span><span class="p">(</span><span class="n">ahc</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsiid</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">SCSIID_OUR_ID</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsiid</span><span class="p">);</span>
	<span class="n">lun</span>    <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">identify</span> <span class="o">&amp;</span> <span class="n">MSG_IDENTIFY_LUNMASK</span><span class="p">);</span>

	<span class="n">byte</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">;</span>
	<span class="n">tstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">enabled_targets</span><span class="p">[</span><span class="n">target</span><span class="p">];</span>
	<span class="n">lstate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tstate</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">lstate</span> <span class="o">=</span> <span class="n">tstate</span><span class="o">-&gt;</span><span class="n">enabled_luns</span><span class="p">[</span><span class="n">lun</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Commands for disabled luns go to the black hole driver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">lstate</span> <span class="o">=</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">black_hole</span><span class="p">;</span>

	<span class="n">atio</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ccb_accept_tio</span><span class="o">*</span><span class="p">)</span><span class="n">SLIST_FIRST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">accept_tios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHC_TQINFIFO_BLOCKED</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Wait for more ATIOs from the peripheral driver for this lun.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bootverbose</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ATIOs exhausted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ahc_name</span><span class="p">(</span><span class="n">ahc</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHC_TQINFIFO_BLOCKED</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(&quot;Incoming command from %d for %d:%d%s\n&quot;,</span>
<span class="c">	       initiator, target, lun,</span>
<span class="c">	       lstate == ahc-&gt;black_hole ? &quot;(Black Holed)&quot; : &quot;&quot;);</span>
<span class="cp">#endif</span>
	<span class="n">SLIST_REMOVE_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lstate</span><span class="o">-&gt;</span><span class="n">accept_tios</span><span class="p">,</span> <span class="n">sim_links</span><span class="p">.</span><span class="n">sle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lstate</span> <span class="o">==</span> <span class="n">ahc</span><span class="o">-&gt;</span><span class="n">black_hole</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fill in the wildcards */</span>
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">target_lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Package it up and send it off to</span>
<span class="cm">	 * whomever has this lun enabled.</span>
<span class="cm">	 */</span>
	<span class="n">atio</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atio</span><span class="o">-&gt;</span><span class="n">init_id</span> <span class="o">=</span> <span class="n">initiator</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">byte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Tag was included */</span>
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">tag_action</span> <span class="o">=</span> <span class="o">*</span><span class="n">byte</span><span class="o">++</span><span class="p">;</span>
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">tag_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">byte</span><span class="o">++</span><span class="p">;</span>
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CAM_TAG_ACTION_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">byte</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Okay.  Now determine the cdb size based on the command code */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="n">CMD_GROUP_CODE_SHIFT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="nl">default:</span>
		<span class="cm">/* Only copy the opcode. */</span>
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Reserved or VU command code type encountered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">memcpy</span><span class="p">(</span><span class="n">atio</span><span class="o">-&gt;</span><span class="n">cdb_io</span><span class="p">.</span><span class="n">cdb_bytes</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">atio</span><span class="o">-&gt;</span><span class="n">cdb_len</span><span class="p">);</span>

	<span class="n">atio</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">CAM_CDB_RECVD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">identify</span> <span class="o">&amp;</span> <span class="n">MSG_IDENTIFY_DISCFLAG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We weren&#39;t allowed to disconnect.</span>
<span class="cm">		 * We&#39;re hanging on the bus until a</span>
<span class="cm">		 * continue target I/O comes in response</span>
<span class="cm">		 * to this accept tio.</span>
<span class="cm">		 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		printk(&quot;Received Immediate Command %d:%d:%d - %p\n&quot;,</span>
<span class="c">		       initiator, target, lun, ahc-&gt;pending_device);</span>
<span class="cp">#endif</span>
		<span class="n">ahc</span><span class="o">-&gt;</span><span class="n">pending_device</span> <span class="o">=</span> <span class="n">lstate</span><span class="p">;</span>
		<span class="n">ahc_freeze_ccb</span><span class="p">((</span><span class="k">union</span> <span class="n">ccb</span> <span class="o">*</span><span class="p">)</span><span class="n">atio</span><span class="p">);</span>
		<span class="n">atio</span><span class="o">-&gt;</span><span class="n">ccb_h</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CAM_DIS_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xpt_done</span><span class="p">((</span><span class="k">union</span> <span class="n">ccb</span><span class="o">*</span><span class="p">)</span><span class="n">atio</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
