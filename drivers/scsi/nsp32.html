<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › nsp32.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nsp32.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Workbit NinjaSCSI-32Bi/UDE PCI/CardBus SCSI Host Bus Adapter driver</span>
<span class="cm"> * Basic data header</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm">*/</span>

<span class="cp">#ifndef _NSP32_H</span>
<span class="cp">#define _NSP32_H</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define NSP32_DEBUG 9</h1></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * VENDOR/DEVICE ID</span>
<span class="cm"> */</span>
<span class="cp">#define PCI_VENDOR_ID_IODATA  0x10fc</span>
<span class="cp">#define PCI_VENDOR_ID_WORKBIT 0x1145</span>

<span class="cp">#define PCI_DEVICE_ID_NINJASCSI_32BI_CBSC_II   0x0005</span>
<span class="cp">#define PCI_DEVICE_ID_NINJASCSI_32BI_KME       0xf007</span>
<span class="cp">#define PCI_DEVICE_ID_NINJASCSI_32BI_WBT       0x8007</span>
<span class="cp">#define PCI_DEVICE_ID_WORKBIT_STANDARD         0xf010</span>
<span class="cp">#define PCI_DEVICE_ID_WORKBIT_DUALEDGE         0xf011</span>
<span class="cp">#define PCI_DEVICE_ID_NINJASCSI_32BI_LOGITEC   0xf012</span>
<span class="cp">#define PCI_DEVICE_ID_NINJASCSI_32BIB_LOGITEC  0xf013</span>
<span class="cp">#define PCI_DEVICE_ID_NINJASCSI_32UDE_MELCO    0xf015</span>
<span class="cp">#define PCI_DEVICE_ID_NINJASCSI_32UDE_MELCO_II 0x8009</span>

<span class="cm">/*</span>
<span class="cm"> * MODEL</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MODEL_IODATA</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MODEL_KME</span>           <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">MODEL_WORKBIT</span>       <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">MODEL_LOGITEC</span>       <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">MODEL_PCI_WORKBIT</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">MODEL_PCI_LOGITEC</span>   <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">MODEL_PCI_MELCO</span>     <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">nsp32_model</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;I-O DATA CBSC-II CardBus card&quot;</span><span class="p">,</span>
	<span class="s">&quot;KME SCSI CardBus card&quot;</span><span class="p">,</span>
	<span class="s">&quot;Workbit duo SCSI CardBus card&quot;</span><span class="p">,</span>
	<span class="s">&quot;Logitec CardBus card with external ROM&quot;</span><span class="p">,</span>
	<span class="s">&quot;Workbit / I-O DATA PCI card&quot;</span><span class="p">,</span>
	<span class="s">&quot;Logitec PCI card with external ROM&quot;</span><span class="p">,</span>
	<span class="s">&quot;Melco CardBus/PCI card with external ROM&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * SCSI Generic Definitions</span>
<span class="cm"> */</span>
<span class="cp">#define EXTENDED_SDTR_LEN	0x03</span>

<span class="cm">/* Little Endian */</span>
<span class="k">typedef</span> <span class="n">u32</span> <span class="n">u32_le</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">u16</span> <span class="n">u16_le</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * BASIC Definitions</span>
<span class="cm"> */</span>
<span class="cp">#ifndef TRUE</span>
<span class="cp"># define TRUE  1</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef FALSE</span>
<span class="cp"># define FALSE 0</span>
<span class="cp">#endif</span>
<span class="cp">#define ASSERT 1</span>
<span class="cp">#define NEGATE 0</span>


<span class="cm">/*******************/</span>
<span class="cm">/* normal register */</span>
<span class="cm">/*******************/</span>
<span class="cm">/*</span>
<span class="cm"> * Don&#39;t access below register with Double Word:</span>
<span class="cm"> * +00, +04, +08, +0c, +64, +80, +84, +88, +90, +c4, +c8, +cc, +d0.</span>
<span class="cm"> */</span>
<span class="cp">#define IRQ_CONTROL 0x00	</span><span class="cm">/* BASE+00, W, W */</span><span class="cp"></span>
<span class="cp">#define IRQ_STATUS  0x00	</span><span class="cm">/* BASE+00, W, R */</span><span class="cp"></span>
<span class="cp"># define IRQSTATUS_LATCHED_MSG      BIT(0)</span>
<span class="cp"># define IRQSTATUS_LATCHED_IO       BIT(1)</span>
<span class="cp"># define IRQSTATUS_LATCHED_CD       BIT(2)</span>
<span class="cp"># define IRQSTATUS_LATCHED_BUS_FREE BIT(3)</span>
<span class="cp"># define IRQSTATUS_RESELECT_OCCUER  BIT(4)</span>
<span class="cp"># define IRQSTATUS_PHASE_CHANGE_IRQ BIT(5)</span>
<span class="cp"># define IRQSTATUS_SCSIRESET_IRQ    BIT(6)</span>
<span class="cp"># define IRQSTATUS_TIMER_IRQ        BIT(7)</span>
<span class="cp"># define IRQSTATUS_FIFO_SHLD_IRQ    BIT(8)</span>
<span class="cp"># define IRQSTATUS_PCI_IRQ	    BIT(9)</span>
<span class="cp"># define IRQSTATUS_BMCNTERR_IRQ     BIT(10)</span>
<span class="cp"># define IRQSTATUS_AUTOSCSI_IRQ     BIT(11)</span>
<span class="cp"># define PCI_IRQ_MASK               BIT(12)</span>
<span class="cp"># define TIMER_IRQ_MASK             BIT(13)</span>
<span class="cp"># define FIFO_IRQ_MASK              BIT(14)</span>
<span class="cp"># define SCSI_IRQ_MASK              BIT(15)</span>
<span class="cp"># define IRQ_CONTROL_ALL_IRQ_MASK   (PCI_IRQ_MASK   | \</span>
<span class="cp">                                     TIMER_IRQ_MASK | \</span>
<span class="cp">                                     FIFO_IRQ_MASK  | \</span>
<span class="cp">                                     SCSI_IRQ_MASK  )</span>
<span class="cp"># define IRQSTATUS_ANY_IRQ          (IRQSTATUS_RESELECT_OCCUER	| \</span>
<span class="cp">				     IRQSTATUS_PHASE_CHANGE_IRQ	| \</span>
<span class="cp">				     IRQSTATUS_SCSIRESET_IRQ	| \</span>
<span class="cp">				     IRQSTATUS_TIMER_IRQ	| \</span>
<span class="cp">				     IRQSTATUS_FIFO_SHLD_IRQ	| \</span>
<span class="cp">				     IRQSTATUS_PCI_IRQ		| \</span>
<span class="cp">				     IRQSTATUS_BMCNTERR_IRQ	| \</span>
<span class="cp">				     IRQSTATUS_AUTOSCSI_IRQ	)</span>

<span class="cp">#define TRANSFER_CONTROL	0x02	</span><span class="cm">/* BASE+02, W, W */</span><span class="cp"></span>
<span class="cp">#define TRANSFER_STATUS		0x02	</span><span class="cm">/* BASE+02, W, R */</span><span class="cp"></span>
<span class="cp"># define CB_MMIO_MODE        BIT(0)</span>
<span class="cp"># define CB_IO_MODE          BIT(1)</span>
<span class="cp"># define BM_TEST             BIT(2)</span>
<span class="cp"># define BM_TEST_DIR         BIT(3)</span>
<span class="cp"># define DUAL_EDGE_ENABLE    BIT(4)</span>
<span class="cp"># define NO_TRANSFER_TO_HOST BIT(5)</span>
<span class="cp"># define TRANSFER_GO         BIT(7)</span>
<span class="cp"># define BLIEND_MODE         BIT(8)</span>
<span class="cp"># define BM_START            BIT(9)</span>
<span class="cp"># define ADVANCED_BM_WRITE   BIT(10)</span>
<span class="cp"># define BM_SINGLE_MODE      BIT(11)</span>
<span class="cp"># define FIFO_TRUE_FULL      BIT(12)</span>
<span class="cp"># define FIFO_TRUE_EMPTY     BIT(13)</span>
<span class="cp"># define ALL_COUNTER_CLR     BIT(14)</span>
<span class="cp"># define FIFOTEST            BIT(15)</span>

<span class="cp">#define INDEX_REG		0x04	</span><span class="cm">/* BASE+04, Byte(R/W), Word(R) */</span><span class="cp"></span>

<span class="cp">#define TIMER_SET		0x06	</span><span class="cm">/* BASE+06, W, R/W */</span><span class="cp"></span>
<span class="cp"># define TIMER_CNT_MASK (0xff)</span>
<span class="cp"># define TIMER_STOP     BIT(8)</span>

<span class="cp">#define DATA_REG_LOW		0x08	</span><span class="cm">/* BASE+08, LowW, R/W */</span><span class="cp"></span>
<span class="cp">#define DATA_REG_HI		0x0a	</span><span class="cm">/* BASE+0a, Hi-W, R/W */</span><span class="cp"></span>

<span class="cp">#define FIFO_REST_CNT		0x0c	</span><span class="cm">/* BASE+0c, W, R/W */</span><span class="cp"></span>
<span class="cp"># define FIFO_REST_MASK       0x1ff</span>
<span class="cp"># define FIFO_EMPTY_SHLD_FLAG BIT(14)</span>
<span class="cp"># define FIFO_FULL_SHLD_FLAG  BIT(15)</span>

<span class="cp">#define SREQ_SMPL_RATE		0x0f	</span><span class="cm">/* BASE+0f, B, R/W */</span><span class="cp"></span>
<span class="cp"># define SREQSMPLRATE_RATE0 BIT(0)</span>
<span class="cp"># define SREQSMPLRATE_RATE1 BIT(1)</span>
<span class="cp"># define SAMPLING_ENABLE    BIT(2)</span>
<span class="cp">#  define SMPL_40M (0)                   </span><span class="cm">/* 40MHz:   0-100ns/period */</span><span class="cp"></span>
<span class="cp">#  define SMPL_20M (SREQSMPLRATE_RATE0)  </span><span class="cm">/* 20MHz: 100-200ns/period */</span><span class="cp"></span>
<span class="cp">#  define SMPL_10M (SREQSMPLRATE_RATE1)  </span><span class="cm">/* 10Mhz: 200-   ns/period */</span><span class="cp"></span>

<span class="cp">#define SCSI_BUS_CONTROL	0x10	</span><span class="cm">/* BASE+10, B, R/W */</span><span class="cp"></span>
<span class="cp"># define BUSCTL_SEL         BIT(0)</span>
<span class="cp"># define BUSCTL_RST         BIT(1)</span>
<span class="cp"># define BUSCTL_DATAOUT_ENB BIT(2)</span>
<span class="cp"># define BUSCTL_ATN         BIT(3)</span>
<span class="cp"># define BUSCTL_ACK         BIT(4)</span>
<span class="cp"># define BUSCTL_BSY         BIT(5)</span>
<span class="cp"># define AUTODIRECTION      BIT(6)</span>
<span class="cp"># define ACKENB             BIT(7)</span>

<span class="cp">#define CLR_COUNTER		0x12	</span><span class="cm">/* BASE+12, B, W */</span><span class="cp"></span>
<span class="cp"># define ACK_COUNTER_CLR       BIT(0)</span>
<span class="cp"># define SREQ_COUNTER_CLR      BIT(1)</span>
<span class="cp"># define FIFO_HOST_POINTER_CLR BIT(2)</span>
<span class="cp"># define FIFO_REST_COUNT_CLR   BIT(3)</span>
<span class="cp"># define BM_COUNTER_CLR        BIT(4)</span>
<span class="cp"># define SAVED_ACK_CLR         BIT(5)</span>
<span class="cp"># define CLRCOUNTER_ALLMASK    (ACK_COUNTER_CLR       | \</span>
<span class="cp">                                SREQ_COUNTER_CLR      | \</span>
<span class="cp">                                FIFO_HOST_POINTER_CLR | \</span>
<span class="cp">                                FIFO_REST_COUNT_CLR   | \</span>
<span class="cp">                                BM_COUNTER_CLR        | \</span>
<span class="cp">                                SAVED_ACK_CLR         )</span>

<span class="cp">#define SCSI_BUS_MONITOR	0x12	</span><span class="cm">/* BASE+12, B, R */</span><span class="cp"></span>
<span class="cp"># define BUSMON_MSG BIT(0)</span>
<span class="cp"># define BUSMON_IO  BIT(1)</span>
<span class="cp"># define BUSMON_CD  BIT(2)</span>
<span class="cp"># define BUSMON_BSY BIT(3)</span>
<span class="cp"># define BUSMON_ACK BIT(4)</span>
<span class="cp"># define BUSMON_REQ BIT(5)</span>
<span class="cp"># define BUSMON_SEL BIT(6)</span>
<span class="cp"># define BUSMON_ATN BIT(7)</span>

<span class="cp">#define COMMAND_DATA		0x14	</span><span class="cm">/* BASE+14, B, R/W */</span><span class="cp"></span>

<span class="cp">#define PARITY_CONTROL		0x16	</span><span class="cm">/* BASE+16, B, W */</span><span class="cp"></span>
<span class="cp"># define PARITY_CHECK_ENABLE BIT(0)</span>
<span class="cp"># define PARITY_ERROR_CLEAR  BIT(1)</span>
<span class="cp">#define PARITY_STATUS		0x16	</span><span class="cm">/* BASE+16, B, R */</span><span class="cp"></span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h1>define PARITY<em>CHECK</em>ENABLE BIT(0)</h1></td><td class="code"><div class="highlight"><pre><span class="cp"># define PARITY_ERROR_NORMAL BIT(1)</span>
<span class="cp"># define PARITY_ERROR_LSB    BIT(1)</span>
<span class="cp"># define PARITY_ERROR_MSB    BIT(2)</span>

<span class="cp">#define RESELECT_ID		0x18	</span><span class="cm">/* BASE+18, B, R */</span><span class="cp"></span>

<span class="cp">#define COMMAND_CONTROL		0x18	</span><span class="cm">/* BASE+18, W, W */</span><span class="cp"></span>
<span class="cp"># define CLEAR_CDB_FIFO_POINTER BIT(0)</span>
<span class="cp"># define AUTO_COMMAND_PHASE     BIT(1)</span>
<span class="cp"># define AUTOSCSI_START         BIT(2)</span>
<span class="cp"># define AUTOSCSI_RESTART       BIT(3)</span>
<span class="cp"># define AUTO_PARAMETER         BIT(4)</span>
<span class="cp"># define AUTO_ATN               BIT(5)</span>
<span class="cp"># define AUTO_MSGIN_00_OR_04    BIT(6)</span>
<span class="cp"># define AUTO_MSGIN_02          BIT(7)</span>
<span class="cp"># define AUTO_MSGIN_03          BIT(8)</span>

<span class="cp">#define SET_ARBIT		0x1a	</span><span class="cm">/* BASE+1a, B, W */</span><span class="cp"></span>
<span class="cp"># define ARBIT_GO    BIT(0)</span>
<span class="cp"># define ARBIT_CLEAR BIT(1)</span>

<span class="cp">#define ARBIT_STATUS		0x1a	</span><span class="cm">/* BASE+1a, B, R */</span><span class="cp"></span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><h1>define ARBIT_GO             BIT(0)</h1></td><td class="code"><div class="highlight"><pre><span class="cp"># define ARBIT_WIN            BIT(1)</span>
<span class="cp"># define ARBIT_FAIL           BIT(2)</span>
<span class="cp"># define AUTO_PARAMETER_VALID BIT(3)</span>
<span class="cp"># define SGT_VALID            BIT(4)</span>

<span class="cp">#define SYNC_REG		0x1c	</span><span class="cm">/* BASE+1c, B, R/W */</span><span class="cp"></span>

<span class="cp">#define ACK_WIDTH		0x1d	</span><span class="cm">/* BASE+1d, B, R/W */</span><span class="cp"></span>

<span class="cp">#define SCSI_DATA_WITH_ACK	0x20	</span><span class="cm">/* BASE+20, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SCSI_OUT_LATCH_TARGET_ID 0x22	</span><span class="cm">/* BASE+22, B, W */</span><span class="cp"></span>
<span class="cp">#define SCSI_DATA_IN		0x22	</span><span class="cm">/* BASE+22, B, R */</span><span class="cp"></span>

<span class="cp">#define SCAM_CONTROL		0x24	</span><span class="cm">/* BASE+24, B, W */</span><span class="cp"></span>
<span class="cp">#define SCAM_STATUS		0x24	</span><span class="cm">/* BASE+24, B, R */</span><span class="cp"></span>
<span class="cp"># define SCAM_MSG    BIT(0)</span>
<span class="cp"># define SCAM_IO     BIT(1)</span>
<span class="cp"># define SCAM_CD     BIT(2)</span>
<span class="cp"># define SCAM_BSY    BIT(3)</span>
<span class="cp"># define SCAM_SEL    BIT(4)</span>
<span class="cp"># define SCAM_XFEROK BIT(5)</span>

<span class="cp">#define SCAM_DATA		0x26	</span><span class="cm">/* BASE+26, B, R/W */</span><span class="cp"></span>
<span class="cp"># define SD0	BIT(0)</span>
<span class="cp"># define SD1	BIT(1)</span>
<span class="cp"># define SD2	BIT(2)</span>
<span class="cp"># define SD3	BIT(3)</span>
<span class="cp"># define SD4	BIT(4)</span>
<span class="cp"># define SD5	BIT(5)</span>
<span class="cp"># define SD6	BIT(6)</span>
<span class="cp"># define SD7	BIT(7)</span>

<span class="cp">#define SACK_CNT		0x28	</span><span class="cm">/* BASE+28, DW, R/W */</span><span class="cp"></span>
<span class="cp">#define SREQ_CNT		0x2c	</span><span class="cm">/* BASE+2c, DW, R/W */</span><span class="cp"></span>

<span class="cp">#define FIFO_DATA_LOW		0x30	</span><span class="cm">/* BASE+30, B/W/DW, R/W */</span><span class="cp"></span>
<span class="cp">#define FIFO_DATA_HIGH		0x32	</span><span class="cm">/* BASE+32, B/W, R/W */</span><span class="cp"></span>
<span class="cp">#define BM_START_ADR		0x34	</span><span class="cm">/* BASE+34, DW, R/W */</span><span class="cp"></span>

<span class="cp">#define BM_CNT			0x38	</span><span class="cm">/* BASE+38, DW, R/W */</span><span class="cp"></span>
<span class="cp"># define BM_COUNT_MASK 0x0001ffffUL</span>
<span class="cp"># define SGTEND        BIT(31)      </span><span class="cm">/* Last SGT marker */</span><span class="cp"></span>

<span class="cp">#define SGT_ADR			0x3c	</span><span class="cm">/* BASE+3c, DW, R/W */</span><span class="cp"></span>
<span class="cp">#define WAIT_REG		0x40	</span><span class="cm">/* Bi only */</span><span class="cp"></span>

<span class="cp">#define SCSI_EXECUTE_PHASE	0x40	</span><span class="cm">/* BASE+40, W, R */</span><span class="cp"></span>
<span class="cp"># define COMMAND_PHASE     BIT(0)</span>
<span class="cp"># define DATA_IN_PHASE     BIT(1)</span>
<span class="cp"># define DATA_OUT_PHASE    BIT(2)</span>
<span class="cp"># define MSGOUT_PHASE      BIT(3)</span>
<span class="cp"># define STATUS_PHASE      BIT(4)</span>
<span class="cp"># define ILLEGAL_PHASE     BIT(5)</span>
<span class="cp"># define BUS_FREE_OCCUER   BIT(6)</span>
<span class="cp"># define MSG_IN_OCCUER     BIT(7)</span>
<span class="cp"># define MSG_OUT_OCCUER    BIT(8)</span>
<span class="cp"># define SELECTION_TIMEOUT BIT(9)</span>
<span class="cp"># define MSGIN_00_VALID    BIT(10)</span>
<span class="cp"># define MSGIN_02_VALID    BIT(11)</span>
<span class="cp"># define MSGIN_03_VALID    BIT(12)</span>
<span class="cp"># define MSGIN_04_VALID    BIT(13)</span>
<span class="cp"># define AUTOSCSI_BUSY     BIT(15)</span>

<span class="cp">#define SCSI_CSB_IN		0x42	</span><span class="cm">/* BASE+42, B, R */</span><span class="cp"></span>

<span class="cp">#define SCSI_MSG_OUT		0x44	</span><span class="cm">/* BASE+44, DW, R/W */</span><span class="cp"></span>
<span class="cp"># define MSGOUT_COUNT_MASK (BIT(0)|BIT(1))</span>
<span class="cp"># define MV_VALID	    BIT(7)</span>

<span class="cp">#define SEL_TIME_OUT		0x48	</span><span class="cm">/* BASE+48, W, R/W */</span><span class="cp"></span>
<span class="cp">#define SAVED_SACK_CNT		0x4c	</span><span class="cm">/* BASE+4c, DW, R */</span><span class="cp"></span>

<span class="cp">#define HTOSDATADELAY		0x50	</span><span class="cm">/* BASE+50, B, R/W */</span><span class="cp"></span>
<span class="cp">#define STOHDATADELAY		0x54	</span><span class="cm">/* BASE+54, B, R/W */</span><span class="cp"></span>
<span class="cp">#define ACKSUMCHECKRD		0x58	</span><span class="cm">/* BASE+58, W, R */</span><span class="cp"></span>
<span class="cp">#define REQSUMCHECKRD		0x5c	</span><span class="cm">/* BASE+5c, W, R */</span><span class="cp"></span>


<span class="cm">/********************/</span>
<span class="cm">/* indexed register */</span>
<span class="cm">/********************/</span>

<span class="cp">#define CLOCK_DIV		0x00	</span><span class="cm">/* BASE+08, IDX+00, B, R/W */</span><span class="cp"></span>
<span class="cp"># define CLOCK_2  BIT(0)	</span><span class="cm">/* MCLK/2 */</span><span class="cp"></span>
<span class="cp"># define CLOCK_4  BIT(1)	</span><span class="cm">/* MCLK/4 */</span><span class="cp"></span>
<span class="cp"># define PCICLK	  BIT(7)	</span><span class="cm">/* PCICLK (33MHz) */</span><span class="cp"></span>

<span class="cp">#define TERM_PWR_CONTROL	0x01	</span><span class="cm">/* BASE+08, IDX+01, B, R/W */</span><span class="cp"></span>
<span class="cp"># define BPWR  BIT(0)</span>
<span class="cp"># define SENSE BIT(1)	</span><span class="cm">/* Read Only */</span><span class="cp"></span>

<span class="cp">#define EXT_PORT_DDR		0x02	</span><span class="cm">/* BASE+08, IDX+02, B, R/W */</span><span class="cp"></span>
<span class="cp">#define EXT_PORT		0x03	</span><span class="cm">/* BASE+08, IDX+03, B, R/W */</span><span class="cp"></span>
<span class="cp"># define LED_ON	 (0)</span>
<span class="cp"># define LED_OFF BIT(0)</span>

<span class="cp">#define IRQ_SELECT		0x04	</span><span class="cm">/* BASE+08, IDX+04, W, R/W */</span><span class="cp"></span>
<span class="cp"># define IRQSELECT_RESELECT_IRQ      BIT(0)</span>
<span class="cp"># define IRQSELECT_PHASE_CHANGE_IRQ  BIT(1)</span>
<span class="cp"># define IRQSELECT_SCSIRESET_IRQ     BIT(2)</span>
<span class="cp"># define IRQSELECT_TIMER_IRQ         BIT(3)</span>
<span class="cp"># define IRQSELECT_FIFO_SHLD_IRQ     BIT(4)</span>
<span class="cp"># define IRQSELECT_TARGET_ABORT_IRQ  BIT(5)</span>
<span class="cp"># define IRQSELECT_MASTER_ABORT_IRQ  BIT(6)</span>
<span class="cp"># define IRQSELECT_SERR_IRQ          BIT(7)</span>
<span class="cp"># define IRQSELECT_PERR_IRQ          BIT(8)</span>
<span class="cp"># define IRQSELECT_BMCNTERR_IRQ      BIT(9)</span>
<span class="cp"># define IRQSELECT_AUTO_SCSI_SEQ_IRQ BIT(10)</span>

<span class="cp">#define OLD_SCSI_PHASE		0x05	</span><span class="cm">/* BASE+08, IDX+05, B, R */</span><span class="cp"></span>
<span class="cp"># define OLD_MSG  BIT(0)</span>
<span class="cp"># define OLD_IO   BIT(1)</span>
<span class="cp"># define OLD_CD   BIT(2)</span>
<span class="cp"># define OLD_BUSY BIT(3)</span>

<span class="cp">#define FIFO_FULL_SHLD_COUNT	0x06	</span><span class="cm">/* BASE+08, IDX+06, B, R/W */</span><span class="cp"></span>
<span class="cp">#define FIFO_EMPTY_SHLD_COUNT	0x07	</span><span class="cm">/* BASE+08, IDX+07, B, R/W */</span><span class="cp"></span>

<span class="cp">#define EXP_ROM_CONTROL		0x08	</span><span class="cm">/* BASE+08, IDX+08, B, R/W */</span><span class="cp"> </span><span class="cm">/* external ROM control */</span><span class="cp"></span>
<span class="cp"># define ROM_WRITE_ENB BIT(0)</span>
<span class="cp"># define IO_ACCESS_ENB BIT(1)</span>
<span class="cp"># define ROM_ADR_CLEAR BIT(2)</span>

<span class="cp">#define EXP_ROM_ADR		0x09	</span><span class="cm">/* BASE+08, IDX+09, W, R/W */</span><span class="cp"></span>

<span class="cp">#define EXP_ROM_DATA		0x0a	</span><span class="cm">/* BASE+08, IDX+0a, B, R/W */</span><span class="cp"></span>

<span class="cp">#define CHIP_MODE		0x0b	</span><span class="cm">/* BASE+08, IDX+0b, B, R   */</span><span class="cp"> </span><span class="cm">/* NinjaSCSI-32Bi only */</span><span class="cp"></span>
<span class="cp"># define OEM0 BIT(1)  </span><span class="cm">/* OEM select */</span><span class="cp"> </span><span class="cm">/* 00=I-O DATA, 01=KME, 10=Workbit, 11=Ext ROM */</span><span class="cp"></span>
<span class="cp"># define OEM1 BIT(2)  </span><span class="cm">/* OEM select */</span><span class="cp"></span>
<span class="cp"># define OPTB BIT(3)  </span><span class="cm">/* KME mode select */</span><span class="cp"></span>
<span class="cp"># define OPTC BIT(4)  </span><span class="cm">/* KME mode select */</span><span class="cp"></span>
<span class="cp"># define OPTD BIT(5)  </span><span class="cm">/* KME mode select */</span><span class="cp"></span>
<span class="cp"># define OPTE BIT(6)  </span><span class="cm">/* KME mode select */</span><span class="cp"></span>
<span class="cp"># define OPTF BIT(7)  </span><span class="cm">/* Power management */</span><span class="cp"></span>

<span class="cp">#define MISC_WR			0x0c	</span><span class="cm">/* BASE+08, IDX+0c, W, R/W */</span><span class="cp"></span>
<span class="cp">#define MISC_RD			0x0c</span>
<span class="cp"># define SCSI_DIRECTION_DETECTOR_SELECT BIT(0)</span>
<span class="cp"># define SCSI2_HOST_DIRECTION_VALID	BIT(1)	</span><span class="cm">/* Read only */</span><span class="cp"></span>
<span class="cp"># define HOST2_SCSI_DIRECTION_VALID	BIT(2)	</span><span class="cm">/* Read only */</span><span class="cp"></span>
<span class="cp"># define DELAYED_BMSTART                BIT(3)</span>
<span class="cp"># define MASTER_TERMINATION_SELECT      BIT(4)</span>
<span class="cp"># define BMREQ_NEGATE_TIMING_SEL        BIT(5)</span>
<span class="cp"># define AUTOSEL_TIMING_SEL             BIT(6)</span>
<span class="cp"># define MISC_MABORT_MASK		BIT(7)</span>
<span class="cp"># define BMSTOP_CHANGE2_NONDATA_PHASE	BIT(8)</span>

<span class="cp">#define BM_CYCLE		0x0d	</span><span class="cm">/* BASE+08, IDX+0d, B, R/W */</span><span class="cp"></span>
<span class="cp"># define BM_CYCLE0		 BIT(0)</span>
<span class="cp"># define BM_CYCLE1		 BIT(1)</span>
<span class="cp"># define BM_FRAME_ASSERT_TIMING	 BIT(2)</span>
<span class="cp"># define BM_IRDY_ASSERT_TIMING	 BIT(3)</span>
<span class="cp"># define BM_SINGLE_BUS_MASTER	 BIT(4)</span>
<span class="cp"># define MEMRD_CMD0              BIT(5)</span>
<span class="cp"># define SGT_AUTO_PARA_MEMED_CMD BIT(6)</span>
<span class="cp"># define MEMRD_CMD1              BIT(7)</span>


<span class="cp">#define SREQ_EDGH		0x0e	</span><span class="cm">/* BASE+08, IDX+0e, B, W */</span><span class="cp"></span>
<span class="cp"># define SREQ_EDGH_SELECT BIT(0)</span>

<span class="cp">#define UP_CNT			0x0f	</span><span class="cm">/* BASE+08, IDX+0f, B, W */</span><span class="cp"></span>
<span class="cp"># define REQCNT_UP  BIT(0)</span>
<span class="cp"># define ACKCNT_UP  BIT(1)</span>
<span class="cp"># define BMADR_UP   BIT(4)</span>
<span class="cp"># define BMCNT_UP   BIT(5)</span>
<span class="cp"># define SGT_CNT_UP BIT(7)</span>

<span class="cp">#define CFG_CMD_STR		0x10	</span><span class="cm">/* BASE+08, IDX+10, W, R */</span><span class="cp"></span>
<span class="cp">#define CFG_LATE_CACHE		0x11	</span><span class="cm">/* BASE+08, IDX+11, W, R/W */</span><span class="cp"></span>
<span class="cp">#define CFG_BASE_ADR_1		0x12	</span><span class="cm">/* BASE+08, IDX+12, W, R */</span><span class="cp"></span>
<span class="cp">#define CFG_BASE_ADR_2		0x13	</span><span class="cm">/* BASE+08, IDX+13, W, R */</span><span class="cp"></span>
<span class="cp">#define CFG_INLINE		0x14	</span><span class="cm">/* BASE+08, IDX+14, W, R */</span><span class="cp"></span>

<span class="cp">#define SERIAL_ROM_CTL		0x15	</span><span class="cm">/* BASE+08, IDX+15, B, R */</span><span class="cp"></span>
<span class="cp"># define SCL BIT(0)</span>
<span class="cp"># define ENA BIT(1)</span>
<span class="cp"># define SDA BIT(2)</span>

<span class="cp">#define FIFO_HST_POINTER	0x16	</span><span class="cm">/* BASE+08, IDX+16, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SREQ_DELAY		0x17	</span><span class="cm">/* BASE+08, IDX+17, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SACK_DELAY		0x18	</span><span class="cm">/* BASE+08, IDX+18, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SREQ_NOISE_CANCEL	0x19	</span><span class="cm">/* BASE+08, IDX+19, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SDP_NOISE_CANCEL	0x1a	</span><span class="cm">/* BASE+08, IDX+1a, B, R/W */</span><span class="cp"></span>
<span class="cp">#define DELAY_TEST		0x1b	</span><span class="cm">/* BASE+08, IDX+1b, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SD0_NOISE_CANCEL	0x20	</span><span class="cm">/* BASE+08, IDX+20, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SD1_NOISE_CANCEL	0x21	</span><span class="cm">/* BASE+08, IDX+21, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SD2_NOISE_CANCEL	0x22	</span><span class="cm">/* BASE+08, IDX+22, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SD3_NOISE_CANCEL	0x23	</span><span class="cm">/* BASE+08, IDX+23, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SD4_NOISE_CANCEL	0x24	</span><span class="cm">/* BASE+08, IDX+24, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SD5_NOISE_CANCEL	0x25	</span><span class="cm">/* BASE+08, IDX+25, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SD6_NOISE_CANCEL	0x26	</span><span class="cm">/* BASE+08, IDX+26, B, R/W */</span><span class="cp"></span>
<span class="cp">#define SD7_NOISE_CANCEL	0x27	</span><span class="cm">/* BASE+08, IDX+27, B, R/W */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * Useful Bus Monitor status combinations.</span>
<span class="cm"> */</span>
<span class="cp">#define BUSMON_BUS_FREE    0</span>
<span class="cp">#define BUSMON_COMMAND     ( BUSMON_BSY |                          BUSMON_CD | BUSMON_REQ )</span>
<span class="cp">#define BUSMON_MESSAGE_IN  ( BUSMON_BSY | BUSMON_MSG | BUSMON_IO | BUSMON_CD | BUSMON_REQ )</span>
<span class="cp">#define BUSMON_MESSAGE_OUT ( BUSMON_BSY | BUSMON_MSG |             BUSMON_CD | BUSMON_REQ )</span>
<span class="cp">#define BUSMON_DATA_IN     ( BUSMON_BSY |              BUSMON_IO |             BUSMON_REQ )</span>
<span class="cp">#define BUSMON_DATA_OUT    ( BUSMON_BSY |                                      BUSMON_REQ )</span>
<span class="cp">#define BUSMON_STATUS      ( BUSMON_BSY |              BUSMON_IO | BUSMON_CD | BUSMON_REQ )</span>
<span class="cp">#define BUSMON_RESELECT    (                           BUSMON_IO                          | BUSMON_SEL)</span>
<span class="cp">#define BUSMON_PHASE_MASK  (              BUSMON_MSG | BUSMON_IO | BUSMON_CD              | BUSMON_SEL)</span>

<span class="cp">#define BUSPHASE_COMMAND     ( BUSMON_COMMAND     &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_MESSAGE_IN  ( BUSMON_MESSAGE_IN  &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_MESSAGE_OUT ( BUSMON_MESSAGE_OUT &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_DATA_IN     ( BUSMON_DATA_IN     &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_DATA_OUT    ( BUSMON_DATA_OUT    &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_STATUS      ( BUSMON_STATUS      &amp; BUSMON_PHASE_MASK )</span>
<span class="cp">#define BUSPHASE_SELECT      ( BUSMON_SEL | BUSMON_IO )</span>


<span class="cm">/************************************************************************</span>
<span class="cm"> * structure for DMA/Scatter Gather list</span>
<span class="cm"> */</span>
<span class="cp">#define NSP32_SG_SIZE		SG_ALL</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_nsp32_sgtable</span> <span class="p">{</span>
	<span class="cm">/* values must be little endian */</span>
	<span class="n">u32_le</span> <span class="n">addr</span><span class="p">;</span> <span class="cm">/* transfer address */</span>
	<span class="n">u32_le</span> <span class="n">len</span><span class="p">;</span>  <span class="cm">/* transfer length. BIT(31) is for SGT_END mark */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">nsp32_sgtable</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_nsp32_sglun</span> <span class="p">{</span>
	<span class="n">nsp32_sgtable</span> <span class="n">sgt</span><span class="p">[</span><span class="n">NSP32_SG_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* SG table */</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">nsp32_sglun</span><span class="p">;</span>
<span class="cp">#define NSP32_SG_TABLE_SIZE (sizeof(nsp32_sgtable) * NSP32_SG_SIZE * MAX_TARGET * MAX_LUN)</span>

<span class="cm">/* Auto parameter mode memory map.   */</span>
<span class="cm">/* All values must be little endian. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_nsp32_autoparam</span> <span class="p">{</span>
	<span class="n">u8</span>     <span class="n">cdb</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">];</span>    <span class="cm">/* SCSI Command                      */</span>
	<span class="n">u32_le</span> <span class="n">msgout</span><span class="p">;</span>           <span class="cm">/* outgoing messages                 */</span>
	<span class="n">u8</span>     <span class="n">syncreg</span><span class="p">;</span>          <span class="cm">/* sync register value               */</span>
	<span class="n">u8</span>     <span class="n">ackwidth</span><span class="p">;</span>         <span class="cm">/* ack width register value          */</span>
	<span class="n">u8</span>     <span class="n">target_id</span><span class="p">;</span>        <span class="cm">/* target/host device id             */</span>
	<span class="n">u8</span>     <span class="n">sample_reg</span><span class="p">;</span>       <span class="cm">/* hazard killer sampling rate       */</span>
	<span class="n">u16_le</span> <span class="n">command_control</span><span class="p">;</span>  <span class="cm">/* command control register          */</span>
	<span class="n">u16_le</span> <span class="n">transfer_control</span><span class="p">;</span> <span class="cm">/* transfer control register         */</span>
	<span class="n">u32_le</span> <span class="n">sgt_pointer</span><span class="p">;</span>      <span class="cm">/* SG table physical address for DMA */</span>
	<span class="n">u32_le</span> <span class="n">dummy</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">nsp32_autoparam</span><span class="p">;</span>  <span class="cm">/* must be packed struct */</span>

<span class="cm">/*</span>
<span class="cm"> * host data structure</span>
<span class="cm"> */</span>
<span class="cm">/* message in/out buffer */</span>
<span class="cp">#define MSGOUTBUF_MAX		20</span>
<span class="cp">#define MSGINBUF_MAX		20</span>

<span class="cm">/* flag for trans_method */</span>
<span class="cp">#define NSP32_TRANSFER_BUSMASTER	BIT(0)</span>
<span class="cp">#define NSP32_TRANSFER_MMIO		BIT(1)	</span><span class="cm">/* Not supported yet */</span><span class="cp"></span>
<span class="cp">#define NSP32_TRANSFER_PIO		BIT(2)	</span><span class="cm">/* Not supported yet */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * structure for connected LUN dynamic data</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Currently tagged queuing is disabled, each nsp32_lunt holds</span>
<span class="cm"> *       one SCSI command and one state.</span>
<span class="cm"> */</span>
<span class="cp">#define DISCPRIV_OK		BIT(0)		</span><span class="cm">/* DISCPRIV Enable mode */</span><span class="cp"></span>
<span class="cp">#define MSGIN03			BIT(1)		</span><span class="cm">/* Auto Msg In 03 Flag  */</span><span class="cp"></span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_nsp32_lunt</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>	    <span class="cm">/* Current Handling struct scsi_cmnd */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">save_datp</span><span class="p">;</span>  <span class="cm">/* Save Data Pointer - saved position from initial address */</span>
	<span class="kt">int</span>		 <span class="n">msgin03</span><span class="p">;</span>	<span class="cm">/* auto msg in 03 flag     */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	 <span class="n">sg_num</span><span class="p">;</span>	<span class="cm">/* Total number of SG entries */</span>
	<span class="kt">int</span>		 <span class="n">cur_entry</span><span class="p">;</span>	<span class="cm">/* Current SG entry number */</span>
	<span class="n">nsp32_sglun</span>     <span class="o">*</span><span class="n">sglun</span><span class="p">;</span>		<span class="cm">/* sg table per lun        */</span>
	<span class="n">dma_addr_t</span>       <span class="n">sglun_paddr</span><span class="p">;</span>   <span class="cm">/* sglun physical address  */</span>
<span class="p">}</span> <span class="n">nsp32_lunt</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * SCSI TARGET/LUN definition</span>
<span class="cm"> */</span>
<span class="cp">#define NSP32_HOST_SCSIID    7  </span><span class="cm">/* SCSI initiator is every time defined as 7 */</span><span class="cp"></span>
<span class="cp">#define MAX_TARGET	     8</span>
<span class="cp">#define MAX_LUN		     8	</span><span class="cm">/* XXX: In SPI3, max number of LUN is 64. */</span><span class="cp"></span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_nsp32_sync_table</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">period_num</span><span class="p">;</span>	<span class="cm">/* period number                  */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">ackwidth</span><span class="p">;</span>	<span class="cm">/* ack width designated by period */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">start_period</span><span class="p">;</span>	<span class="cm">/* search range - start period    */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">end_period</span><span class="p">;</span>	<span class="cm">/* search range - end period      */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">sample_rate</span><span class="p">;</span>    <span class="cm">/* hazard killer parameter        */</span>
<span class="p">}</span> <span class="n">nsp32_sync_table</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * structure for target device static data</span>
<span class="cm"> */</span>
<span class="cm">/* flag for nsp32_target.sync_flag */</span>
<span class="cp">#define SDTR_INITIATOR	  BIT(0)    </span><span class="cm">/* sending SDTR from initiator        */</span><span class="cp"></span>
<span class="cp">#define SDTR_TARGET	  BIT(1)    </span><span class="cm">/* sending SDTR from target           */</span><span class="cp"></span>
<span class="cp">#define SDTR_DONE	  BIT(2)    </span><span class="cm">/* exchanging SDTR has been processed */</span><span class="cp"></span>

<span class="cm">/* syncronous period value for nsp32_target.config_max */</span>
<span class="cp">#define FAST5M			0x32</span>
<span class="cp">#define FAST10M			0x19</span>
<span class="cp">#define ULTRA20M		0x0c</span>

<span class="cm">/* flag for nsp32_target.{sync_offset}, period */</span>
<span class="cp">#define ASYNC_OFFSET		0	</span><span class="cm">/* asynchronous transfer           */</span><span class="cp"></span>
<span class="cp">#define SYNC_OFFSET		0xf	</span><span class="cm">/* synchronous transfer max offset */</span><span class="cp"></span>

<span class="cm">/* syncreg:</span>
<span class="cm">  bit:07 06 05 04 03 02 01 00</span>
<span class="cm">      ---PERIOD-- ---OFFSET--   */</span>
<span class="cp">#define TO_SYNCREG(period, offset) (((period) &amp; 0x0f) &lt;&lt; 4 | ((offset) &amp; 0x0f))</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_nsp32_target</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">syncreg</span><span class="p">;</span>	<span class="cm">/* value for SYNCREG   */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">ackwidth</span><span class="p">;</span>	<span class="cm">/* value for ACKWIDTH  */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">period</span><span class="p">;</span>         <span class="cm">/* sync period (0-255) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">offset</span><span class="p">;</span>		<span class="cm">/* sync offset (0-15)  */</span>
	<span class="kt">int</span>		<span class="n">sync_flag</span><span class="p">;</span>	<span class="cm">/* SDTR_*, 0           */</span>
	<span class="kt">int</span>		<span class="n">limit_entry</span><span class="p">;</span>	<span class="cm">/* max speed limit entry designated</span>
<span class="cm">					   by EEPROM configuration */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">sample_reg</span><span class="p">;</span>     <span class="cm">/* SREQ hazard killer register */</span>
<span class="p">}</span> <span class="n">nsp32_target</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_nsp32_hw_data</span> <span class="p">{</span>
	<span class="kt">int</span>           <span class="n">IrqNumber</span><span class="p">;</span>
	<span class="kt">int</span>           <span class="n">BaseAddress</span><span class="p">;</span>
	<span class="kt">int</span>           <span class="n">NumAddress</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">MmioAddress</span><span class="p">;</span>
<span class="cp">#define NSP32_MMIO_OFFSET 0x0800</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">MmioLength</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">CurrentSC</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span>             <span class="o">*</span><span class="n">Pci</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_devid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>           <span class="o">*</span><span class="n">Host</span><span class="p">;</span>
	<span class="n">spinlock_t</span>                  <span class="n">Lock</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">info_str</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>

	<span class="cm">/* allocated memory region */</span>
	<span class="n">nsp32_sglun</span>      <span class="o">*</span><span class="n">sg_list</span><span class="p">;</span>	<span class="cm">/* sglist virtuxal address         */</span>
	<span class="n">dma_addr_t</span>	  <span class="n">sg_paddr</span><span class="p">;</span>     <span class="cm">/* physical address of hw_sg_table */</span>
	<span class="n">nsp32_autoparam</span>  <span class="o">*</span><span class="n">autoparam</span><span class="p">;</span>	<span class="cm">/* auto parameter transfer region  */</span>
	<span class="n">dma_addr_t</span>	  <span class="n">auto_paddr</span><span class="p">;</span>	<span class="cm">/* physical address of autoparam   */</span>
	<span class="kt">int</span> 		  <span class="n">cur_entry</span><span class="p">;</span>	<span class="cm">/* current sgt entry               */</span>

	<span class="cm">/* target/LUN */</span>
	<span class="n">nsp32_lunt</span>       <span class="o">*</span><span class="n">cur_lunt</span><span class="p">;</span>	<span class="cm">/* Current connected LUN table */</span>
	<span class="n">nsp32_lunt</span>        <span class="n">lunt</span><span class="p">[</span><span class="n">MAX_TARGET</span><span class="p">][</span><span class="n">MAX_LUN</span><span class="p">];</span>  <span class="cm">/* All LUN table */</span>

	<span class="n">nsp32_target</span>     <span class="o">*</span><span class="n">cur_target</span><span class="p">;</span>	<span class="cm">/* Current connected SCSI ID    */</span>
	<span class="n">nsp32_target</span>	  <span class="n">target</span><span class="p">[</span><span class="n">MAX_TARGET</span><span class="p">];</span>	     <span class="cm">/* SCSI ID */</span>
	<span class="kt">int</span>		  <span class="n">cur_id</span><span class="p">;</span>	<span class="cm">/* Current connected target ID  */</span>
	<span class="kt">int</span>		  <span class="n">cur_lun</span><span class="p">;</span>	<span class="cm">/* Current connected target LUN */</span>

	<span class="cm">/* behavior setting parameters */</span>
	<span class="kt">int</span>		  <span class="n">trans_method</span><span class="p">;</span>	<span class="cm">/* transfer method flag            */</span>
	<span class="kt">int</span>		  <span class="n">resettime</span><span class="p">;</span>	<span class="cm">/* Reset time                      */</span>
	<span class="kt">int</span> 		  <span class="n">clock</span><span class="p">;</span>       	<span class="cm">/* clock dividing flag             */</span>
	<span class="n">nsp32_sync_table</span> <span class="o">*</span><span class="n">synct</span><span class="p">;</span>	<span class="cm">/* sync_table determined by clock  */</span>
	<span class="kt">int</span>		  <span class="n">syncnum</span><span class="p">;</span>	<span class="cm">/* the max number of synct element */</span>

	<span class="cm">/* message buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msgoutbuf</span><span class="p">[</span><span class="n">MSGOUTBUF_MAX</span><span class="p">];</span> <span class="cm">/* msgout buffer    */</span>
	<span class="kt">char</span>	      <span class="n">msgout_len</span><span class="p">;</span>		<span class="cm">/* msgoutbuf length */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msginbuf</span> <span class="p">[</span><span class="n">MSGINBUF_MAX</span><span class="p">];</span>	<span class="cm">/* megin buffer     */</span>
	<span class="kt">char</span>	      <span class="n">msgin_len</span><span class="p">;</span>		<span class="cm">/* msginbuf length  */</span>

<span class="p">}</span> <span class="n">nsp32_hw_data</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * TIME definition</span>
<span class="cm"> */</span>
<span class="cp">#define RESET_HOLD_TIME		10000	</span><span class="cm">/* reset time in us (SCSI-2 says the</span>
<span class="cm">					   minimum is 25us) */</span><span class="cp"></span>
<span class="cp">#define SEL_TIMEOUT_TIME	10000	</span><span class="cm">/* 250ms defined in SCSI specification</span>
<span class="cm">					   (25.6us/1unit) */</span><span class="cp"></span>
<span class="cp">#define ARBIT_TIMEOUT_TIME	100	</span><span class="cm">/* 100us */</span><span class="cp"></span>
<span class="cp">#define REQSACK_TIMEOUT_TIME	10000	</span><span class="cm">/* max wait time for REQ/SACK assertion</span>
<span class="cm">					   or negation, 10000us == 10ms */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _NSP32_H */</span><span class="cp"></span>
<span class="cm">/* end */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
