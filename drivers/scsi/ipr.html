<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › ipr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ipr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ipr.c -- driver for IBM Power Linux RAID adapters</span>
<span class="cm"> *</span>
<span class="cm"> * Written By: Brian King &lt;brking@us.ibm.com&gt;, IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003, 2004 IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is used to control the following SCSI adapters:</span>
<span class="cm"> *</span>
<span class="cm"> * IBM iSeries: 5702, 5703, 2780, 5709, 570A, 570B</span>
<span class="cm"> *</span>
<span class="cm"> * IBM pSeries: PCI-X Dual Channel Ultra 320 SCSI RAID Adapter</span>
<span class="cm"> *              PCI-X Dual Channel Ultra 320 SCSI Adapter</span>
<span class="cm"> *              PCI-X Dual Channel Ultra 320 SCSI RAID Enablement Card</span>
<span class="cm"> *              Embedded SCSI adapter on p615 and p655 systems</span>
<span class="cm"> *</span>
<span class="cm"> * Supported Hardware Features:</span>
<span class="cm"> *	- Ultra 320 SCSI controller</span>
<span class="cm"> *	- PCI-X host interface</span>
<span class="cm"> *	- Embedded PowerPC RISC Processor and Hardware XOR DMA Engine</span>
<span class="cm"> *	- Non-Volatile Write Cache</span>
<span class="cm"> *	- Supports attachment of non-RAID disks, tape, and optical devices</span>
<span class="cm"> *	- RAID Levels 0, 5, 10</span>
<span class="cm"> *	- Hot spare</span>
<span class="cm"> *	- Background Parity Checking</span>
<span class="cm"> *	- Background Data Scrubbing</span>
<span class="cm"> *	- Ability to increase the capacity of an existing RAID 5 disk array</span>
<span class="cm"> *		by adding disks</span>
<span class="cm"> *</span>
<span class="cm"> * Driver Features:</span>
<span class="cm"> *	- Tagged command queuing</span>
<span class="cm"> *	- Adapter microcode download</span>
<span class="cm"> *	- PCI hot plug</span>
<span class="cm"> *	- SCSI device hot plug</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/stringify.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &quot;ipr.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> *   Global Data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ipr_ioa_head</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipr_log_level</span> <span class="o">=</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipr_max_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipr_testmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipr_fastfail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipr_transop_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipr_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipr_max_devs</span> <span class="o">=</span> <span class="n">IPR_DEFAULT_SIS64_DEVS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipr_dual_ioa_raid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ipr_driver_lock</span><span class="p">);</span>

<span class="cm">/* This table describes the differences between DMA controller chips */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipr_chip_cfg_t</span> <span class="n">ipr_chip_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="cm">/* Gemstone, Citrine, Obsidian, and Obsidian-E */</span>
		<span class="p">.</span><span class="n">mailbox</span> <span class="o">=</span> <span class="mh">0x0042C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cache_line_size</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clear_isr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">set_interrupt_mask_reg</span> <span class="o">=</span> <span class="mh">0x0022C</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_mask_reg</span> <span class="o">=</span> <span class="mh">0x00230</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_mask_reg32</span> <span class="o">=</span> <span class="mh">0x00230</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_mask_reg</span> <span class="o">=</span> <span class="mh">0x0022C</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_mask_reg32</span> <span class="o">=</span> <span class="mh">0x0022C</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00228</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00228</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00224</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00224</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ioarrin_reg</span> <span class="o">=</span> <span class="mh">0x00404</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_uproc_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00214</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00214</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_uproc_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00214</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00214</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_uproc_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00218</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00218</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* Snipe and Scamp */</span>
		<span class="p">.</span><span class="n">mailbox</span> <span class="o">=</span> <span class="mh">0x0052C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cache_line_size</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clear_isr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">set_interrupt_mask_reg</span> <span class="o">=</span> <span class="mh">0x00288</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_mask_reg</span> <span class="o">=</span> <span class="mh">0x0028C</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_mask_reg32</span> <span class="o">=</span> <span class="mh">0x0028C</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_mask_reg</span> <span class="o">=</span> <span class="mh">0x00288</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_mask_reg32</span> <span class="o">=</span> <span class="mh">0x00288</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00284</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00284</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00280</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00280</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ioarrin_reg</span> <span class="o">=</span> <span class="mh">0x00504</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_uproc_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00290</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00290</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_uproc_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00290</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00290</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_uproc_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00294</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00294</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* CRoC */</span>
		<span class="p">.</span><span class="n">mailbox</span> <span class="o">=</span> <span class="mh">0x00044</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cache_line_size</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clear_isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">set_interrupt_mask_reg</span> <span class="o">=</span> <span class="mh">0x00010</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_mask_reg</span> <span class="o">=</span> <span class="mh">0x00018</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_mask_reg32</span> <span class="o">=</span> <span class="mh">0x0001C</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_mask_reg</span> <span class="o">=</span> <span class="mh">0x00010</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_mask_reg32</span> <span class="o">=</span> <span class="mh">0x00014</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00008</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x0000C</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00004</span><span class="p">,</span>
			<span class="p">.</span><span class="n">ioarrin_reg</span> <span class="o">=</span> <span class="mh">0x00070</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_uproc_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00020</span><span class="p">,</span>
			<span class="p">.</span><span class="n">sense_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00024</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_uproc_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00020</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x00024</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_uproc_interrupt_reg</span> <span class="o">=</span> <span class="mh">0x00028</span><span class="p">,</span>
			<span class="p">.</span><span class="n">clr_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="mh">0x0002C</span><span class="p">,</span>
			<span class="p">.</span><span class="n">init_feedback_reg</span> <span class="o">=</span> <span class="mh">0x0005C</span><span class="p">,</span>
			<span class="p">.</span><span class="n">dump_addr_reg</span> <span class="o">=</span> <span class="mh">0x00064</span><span class="p">,</span>
			<span class="p">.</span><span class="n">dump_data_reg</span> <span class="o">=</span> <span class="mh">0x00068</span><span class="p">,</span>
			<span class="p">.</span><span class="n">endian_swap_reg</span> <span class="o">=</span> <span class="mh">0x00084</span>
		<span class="p">}</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipr_chip_t</span> <span class="n">ipr_chip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_GEMSTONE</span><span class="p">,</span> <span class="n">IPR_USE_LSI</span><span class="p">,</span> <span class="n">IPR_SIS32</span><span class="p">,</span> <span class="n">IPR_PCI_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_chip_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CITRINE</span><span class="p">,</span> <span class="n">IPR_USE_LSI</span><span class="p">,</span> <span class="n">IPR_SIS32</span><span class="p">,</span> <span class="n">IPR_PCI_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_chip_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_OBSIDIAN</span><span class="p">,</span> <span class="n">IPR_USE_LSI</span><span class="p">,</span> <span class="n">IPR_SIS32</span><span class="p">,</span> <span class="n">IPR_PCI_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_chip_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN</span><span class="p">,</span> <span class="n">IPR_USE_LSI</span><span class="p">,</span> <span class="n">IPR_SIS32</span><span class="p">,</span> <span class="n">IPR_PCI_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_chip_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN_E</span><span class="p">,</span> <span class="n">IPR_USE_MSI</span><span class="p">,</span> <span class="n">IPR_SIS32</span><span class="p">,</span> <span class="n">IPR_PCI_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_chip_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_SNIPE</span><span class="p">,</span> <span class="n">IPR_USE_LSI</span><span class="p">,</span> <span class="n">IPR_SIS32</span><span class="p">,</span> <span class="n">IPR_PCI_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_chip_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_SCAMP</span><span class="p">,</span> <span class="n">IPR_USE_LSI</span><span class="p">,</span> <span class="n">IPR_SIS32</span><span class="p">,</span> <span class="n">IPR_PCI_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_chip_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROC_FPGA_E2</span><span class="p">,</span> <span class="n">IPR_USE_MSI</span><span class="p">,</span> <span class="n">IPR_SIS64</span><span class="p">,</span> <span class="n">IPR_MMIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_chip_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROCODILE</span><span class="p">,</span> <span class="n">IPR_USE_MSI</span><span class="p">,</span> <span class="n">IPR_SIS64</span><span class="p">,</span> <span class="n">IPR_MMIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_chip_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ipr_max_bus_speeds</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IPR_80MBs_SCSI_RATE</span><span class="p">,</span> <span class="n">IPR_U160_SCSI_RATE</span><span class="p">,</span> <span class="n">IPR_U320_SCSI_RATE</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Brian King &lt;brking@us.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IBM Power RAID SCSI Adapter Driver&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">max_speed</span><span class="p">,</span> <span class="n">ipr_max_speed</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_speed</span><span class="p">,</span> <span class="s">&quot;Maximum bus speed (0-2). Default: 1=U160. Speeds: 0=80 MB/s, 1=U160, 2=U320&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="n">ipr_log_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="s">&quot;Set to 0 - 4 for increasing verbosity of device driver&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">testmode</span><span class="p">,</span> <span class="n">ipr_testmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">testmode</span><span class="p">,</span> <span class="s">&quot;DANGEROUS!!! Allows unsupported configurations&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">fastfail</span><span class="p">,</span> <span class="n">ipr_fastfail</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fastfail</span><span class="p">,</span> <span class="s">&quot;Reduce timeouts and retries&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">transop_timeout</span><span class="p">,</span> <span class="n">ipr_transop_timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">transop_timeout</span><span class="p">,</span> <span class="s">&quot;Time in seconds to wait for adapter to come operational (default: 300)&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">ipr_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Enable device driver debugging logging. Set to 1 to enable. (default: 0)&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">dual_ioa_raid</span><span class="p">,</span> <span class="n">ipr_dual_ioa_raid</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dual_ioa_raid</span><span class="p">,</span> <span class="s">&quot;Enable dual adapter RAID support. Set to 1 to enable. (default: 1)&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">max_devs</span><span class="p">,</span> <span class="n">ipr_max_devs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_devs</span><span class="p">,</span> <span class="s">&quot;Specify the maximum number of physical devices. &quot;</span>
		 <span class="s">&quot;[Default=&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">IPR_DEFAULT_SIS64_DEVS</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">IPR_DRIVER_VERSION</span><span class="p">);</span>

<span class="cm">/*  A constant array of IOASCs/URCs/Error Messages */</span>
<span class="k">static</span> <span class="k">const</span>
<span class="k">struct</span> <span class="n">ipr_error_table_t</span> <span class="n">ipr_error_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;8155: An unknown error was received&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x00330000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Soft underlength error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x005A0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Command to be cancelled not found&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x00808000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Qualified success&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01080000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFFE: Soft device bus error recovered by the IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01088100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4101: Soft device bus fabric error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01100100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFFC: Logical block guard error recovered by the device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01100300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFFC: Logical block reference tag error recovered by the device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01108300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4171: Recovered scatter list tag / sequence number error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01109000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FF3D: Recovered logical block CRC error on IOA to Host transfer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01109200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4171: Recovered logical block sequence number error on IOA to Host transfer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0110A000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFFD: Recovered logical block reference tag error detected by the IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0110A100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFFD: Logical block guard error recovered by the IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01170600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF9: Device sector reassign successful&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01170900</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF7: Media error recovered by device rewrite procedures&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01180200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;7001: IOA sector reassignment successful&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01180500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF9: Soft media error. Sector reassignment recommended&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01180600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF7: Media error recovered by IOA rewrite procedures&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01418000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FF3D: Soft PCI bus error recovered by the IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01440000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF6: Device hardware error recovered by the IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01448100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF6: Device hardware error recovered by the device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01448200</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FF3D: Soft IOA error recovered by the IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01448300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFFA: Undefined device response recovered by the IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x014A0000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF6: Device bus error, message or command phase&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x014A8000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFFE: Task Management Function failed&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x015D0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF6: Failure prediction threshold exceeded&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x015D9200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;8009: Impending cache battery pack failure&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x02040400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;34FF: Disk device format in progress&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x02048000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9070: IOA requested reset&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x023F0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Synchronization required&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x024E0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;No ready, IOA shutdown&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x025A0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Not ready, IOA has been shutdown&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x02670100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3020: Storage subsystem configuration error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x03110B00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;FFF5: Medium error, data unreadable, recommend reassign&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x03110C00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;7000: Medium error, data unreadable, do not reassign&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x03310000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF3: Disk media format bad&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04050000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3002: Addressed device failed to respond to selection&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04080000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3100: Device bus error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04080100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3109: IOA timed out a device command&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04088000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;3120: SCSI bus is not operational&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04088100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4100: Hard device bus fabric error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04100100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;310C: Logical block guard error detected by the device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04100300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;310C: Logical block reference tag error detected by the device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04108300</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4170: Scatter list tag / sequence number error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04109000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;8150: Logical block CRC error on IOA to Host transfer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04109200</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4170: Logical block sequence number error on IOA to Host transfer&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0410A000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;310D: Logical block reference tag error detected by the IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0410A100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;310D: Logical block guard error detected by the IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04118000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9000: IOA reserved area data check&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04118100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9001: IOA reserved area invalid data pattern&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04118200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9002: IOA reserved area LRC error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04118300</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;Hardware Error, IOA metadata access error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04320000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;102E: Out of alternate sectors for disk storage&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04330000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF4: Data transfer underlength error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04338000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF4: Data transfer overlength error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x043E0100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3400: Logical unit failure&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04408500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF4: Device microcode is corrupt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04418000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;8150: PCI bus error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04430000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Unsupported device bus message received&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04440000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF4: Disk device problem&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04448200</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;8150: Permanent IOA failure&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04448300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3010: Disk device returned wrong response to IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04448400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;8151: IOA microcode error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04448500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Device bus status error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04448600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;8157: IOA error requiring IOA reset to recover&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04448700</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;ATA device status error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04490000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Message reject received from the device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04449200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;8008: A permanent cache battery pack failure occurred&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0444A000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9090: Disk unit has been modified after the last known status&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0444A200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9081: IOA detected device error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0444A300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9082: IOA detected device error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x044A0000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3110: Device bus error, message or command phase&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x044A8000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3110: SAS Command / Task Management Function failed&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04670400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9091: Incorrect hardware configuration change has been detected&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04678000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9073: Invalid multi-adapter configuration&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04678100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4010: Incorrect connection between cascaded expanders&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04678200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4020: Connections exceed IOA design limits&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04678300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4030: Incorrect multipath connection&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x04679000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4110: Unsupported enclosure function&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x046E0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFF4: Command to logical unit failed&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x05240000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, invalid request type or request packet&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x05250000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, invalid resource handle&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x05258000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, commands not allowed to this device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x05258100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, command not allowed to a secondary adapter&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x05258200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, command not allowed to a non-optimized resource&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x05260000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, invalid field in parameter list&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x05260100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, parameter not supported&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x05260200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, parameter value invalid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x052C0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, command sequence error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x052C8000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Illegal request, dual adapter support not enabled&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06040500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9031: Array protection temporarily suspended, protection resuming&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06040600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9040: Array protection temporarily suspended, protection resuming&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06288000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3140: Device bus not ready to ready transition&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06290000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFFB: SCSI bus was reset&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06290500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;FFFE: SCSI bus transition to single ended&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06290600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;FFFE: SCSI bus transition to LVD&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06298000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;FFFB: SCSI bus was reset by another initiator&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x063F0300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3029: A device replacement has occurred&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x064C8000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9051: IOA cache data exists for a missing or failed device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x064C8100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9055: Auxiliary cache IOA contains cache data needed by the primary IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06670100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9025: Disk unit is not supported at its physical location&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06670600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3020: IOA detected a SCSI bus configuration error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06678000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;3150: SCSI bus configuration error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06678100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9074: Asymmetric advanced function disk configuration&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06678300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4040: Incomplete multipath connection between IOA and enclosure&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06678400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4041: Incomplete multipath connection between enclosure and device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06678500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9075: Incomplete multipath connection between IOA and remote IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06678600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9076: Configuration error, missing remote IOA&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06679100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4050: Enclosure does not support a required multipath function&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06690000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4070: Logically bad block written on device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06690200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9041: Array protection temporarily suspended&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06698200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9042: Corrupt array parity detected on specified device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x066B0200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9030: Array no longer protected due to missing or failed disk unit&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x066B8000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9071: Link operational transition&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x066B8100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9072: Link not operational transition&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x066B8200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9032: Array exposed but still protected&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x066B8300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
	<span class="s">&quot;70DD: Device forced failed by disrupt device command&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x066B9100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4061: Multipath redundancy level got better&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x066B9200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;4060: Multipath redundancy level got worse&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07270000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Failure due to other device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9008: IOA does not support functions expected by devices&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9010: Cache data associated with attached devices cannot be found&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9011: Cache data belongs to devices other than those attached&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9020: Array missing 2 or more devices with only 1 device present&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9021: Array missing 2 or more devices with 2 or more devices present&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9022: Exposed array is missing a required device&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278700</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9023: Array member(s) not at required physical locations&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9024: Array not functional due to present hardware configuration&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278900</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9026: Array not functional due to present hardware configuration&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278A00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9027: Array is missing a device and parity is out of sync&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278B00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9028: Maximum number of arrays already exist&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278C00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9050: Required cache data cannot be located for a disk unit&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278D00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9052: Cache data exists for a device that has been modified&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07278F00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9054: IOA resources not available due to previous problems&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07279100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9092: Disk unit requires initialization before use&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07279200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9029: Incorrect hardware configuration change has been detected&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07279600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9060: One or more disk pairs are missing from an array&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07279700</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9061: One or more disks are missing from an array&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07279800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9062: One or more disks are missing from an array&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07279900</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">,</span>
	<span class="s">&quot;9063: Maximum number of functional arrays has been exceeded&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B260000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Aborted command, invalid descriptor&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0B5A0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s">&quot;Command terminated by host&quot;</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipr_ses_table_entry</span> <span class="n">ipr_ses_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;2104-DL1        &quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2104-TL1        &quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HSBP07M P U2SCSI&quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">80</span> <span class="p">},</span> <span class="cm">/* Hidive 7 slot */</span>
	<span class="p">{</span> <span class="s">&quot;HSBP05M P U2SCSI&quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">80</span> <span class="p">},</span> <span class="cm">/* Hidive 5 slot */</span>
	<span class="p">{</span> <span class="s">&quot;HSBP05M S U2SCSI&quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">80</span> <span class="p">},</span> <span class="cm">/* Bowtie */</span>
	<span class="p">{</span> <span class="s">&quot;HSBP06E ASU2SCSI&quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">80</span> <span class="p">},</span> <span class="cm">/* MartinFenning */</span>
	<span class="p">{</span> <span class="s">&quot;2104-DU3        &quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">160</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2104-TU3        &quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">160</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HSBP04C RSU2SCSI&quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXX*XXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">160</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HSBP06E RSU2SCSI&quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXX*XXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">160</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;St  V1S2        &quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">160</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HSBPD4M  PU3SCSI&quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXX*XXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">160</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;VSBPD1H   U3SCSI&quot;</span><span class="p">,</span> <span class="s">&quot;XXXXXXX*XXXXXXXX&quot;</span><span class="p">,</span> <span class="mi">160</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Function Prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipr_reset_alert</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipr_process_ccn</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipr_process_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipr_reset_ioa_job</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">ipr_shutdown_type</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SCSI_IPR_TRACE</span>
<span class="cm">/**</span>
<span class="cm"> * ipr_trc_hook - Add a trace entry to the driver trace</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @type:		trace type</span>
<span class="cm"> * @add_data:	additional data</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_trc_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">add_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_trace_entry</span> <span class="o">*</span><span class="n">trace_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">trace_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">[</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">trace_index</span><span class="o">++</span><span class="p">];</span>
	<span class="n">trace_entry</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">trace_entry</span><span class="o">-&gt;</span><span class="n">op_code</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">trace_entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">trace_entry</span><span class="o">-&gt;</span><span class="n">ata_op_code</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ata_ioadl</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">trace_entry</span><span class="o">-&gt;</span><span class="n">ata_op_code</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">add_data</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>
	<span class="n">trace_entry</span><span class="o">-&gt;</span><span class="n">cmd_index</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_index</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">trace_entry</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span><span class="p">;</span>
	<span class="n">trace_entry</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">add_data</span> <span class="o">=</span> <span class="n">add_data</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ipr_trc_hook(ipr_cmd, type, add_data) do { } while(0)</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reinit_ipr_cmnd - Re-initialize an IPR Cmnd block for reuse</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_reinit_ipr_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioasa</span> <span class="o">*</span><span class="n">ioasa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioasa64</span> <span class="o">*</span><span class="n">ioasa64</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa64</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmd_pkt</span><span class="p">));</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_data_transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioadl_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_ioadl_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sis64_addr_data</span><span class="p">.</span><span class="n">data_ioadl_addr</span> <span class="o">=</span>
			<span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">ioadl64</span><span class="p">));</span>
		<span class="n">ioasa64</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">gata</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">write_ioadl_addr</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">ioadl</span><span class="p">));</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_ioadl_addr</span> <span class="o">=</span> <span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">write_ioadl_addr</span><span class="p">;</span>
		<span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">gata</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">residual_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_init_ipr_cmnd - Initialize an IPR Cmnd block</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_init_ipr_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipr_reinit_ipr_cmnd</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scratch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_free_ipr_cmnd - Get a free IPR Cmnd block</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	pointer to ipr command struct</span>
<span class="cm"> **/</span>
<span class="k">static</span>
<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="nf">ipr_get_free_ipr_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>

	<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">ipr_init_ipr_cmnd</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ipr_cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_mask_and_clear_interrupts - Mask all and clear specified interrupts</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @clr_ints:     interrupts to clear</span>
<span class="cm"> *</span>
<span class="cm"> * This function masks all interrupts on the adapter, then clears the</span>
<span class="cm"> * interrupts specified in the mask</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_mask_and_clear_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
					  <span class="n">u32</span> <span class="n">clr_ints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">int_reg</span><span class="p">;</span>

	<span class="cm">/* Stop new interrupts */</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_interrupts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set interrupt mask to stop all new interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">writeq</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_interrupt_mask_reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_interrupt_mask_reg</span><span class="p">);</span>

	<span class="cm">/* Clear any pending interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_reg</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">clr_ints</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_reg32</span><span class="p">);</span>
	<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_save_pcix_cmd_reg - Save PCI-X command register</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / -EIO on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_save_pcix_cmd_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pcix_cmd_reg</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PCIX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcix_cmd_reg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcix_cmd_reg</span> <span class="o">+</span> <span class="n">PCI_X_CMD</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">saved_pcix_cmd_reg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to save PCI-X command register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">saved_pcix_cmd_reg</span> <span class="o">|=</span> <span class="n">PCI_X_CMD_DPERR_E</span> <span class="o">|</span> <span class="n">PCI_X_CMD_ERO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_set_pcix_cmd_reg - Setup PCI-X command register</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / -EIO on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_set_pcix_cmd_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pcix_cmd_reg</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PCIX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcix_cmd_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcix_cmd_reg</span> <span class="o">+</span> <span class="n">PCI_X_CMD</span><span class="p">,</span>
					  <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">saved_pcix_cmd_reg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to setup PCI-X command register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_sata_eh_done - done function for aborted SATA commands</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is invoked for ops generated to SATA</span>
<span class="cm"> * devices which are being aborted.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_sata_eh_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_OTHER</span><span class="p">;</span>
	<span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioasa</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ATA_BUSY</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="n">ata_qc_complete</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_scsi_eh_done - mid-layer done function for aborted ops</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is invoked by the interrupt handler for</span>
<span class="cm"> * ops generated by the SCSI mid-layer which are being aborted.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_scsi_eh_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>

	<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_fail_all_ops - Fails all outstanding ops.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function fails all outstanding ops.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_fail_all_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOASC_IOA_WAS_RESET</span><span class="p">);</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ilid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_DRIVER_ILID</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_scsi_eh_done</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span><span class="p">)</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_sata_eh_done</span><span class="p">;</span>

		<span class="n">ipr_trc_hook</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_TRACE_FINISH</span><span class="p">,</span> <span class="n">IPR_IOASC_IOA_WAS_RESET</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_send_command -  Send driver initiated requests.</span>
<span class="cm"> * @ipr_cmd:		ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends a command to the adapter using the correct write call.</span>
<span class="cm"> * In the case of sis64, calculate the ioarcb size required. Then or in the</span>
<span class="cm"> * appropriate bits.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">send_dma_addr</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The default size is 256 bytes */</span>
		<span class="n">send_dma_addr</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>

		<span class="cm">/* If the number of ioadls * size of ioadl &gt; 128 bytes,</span>
<span class="cm">		   then use a 512 byte ioarcb */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span> <span class="p">)</span>
			<span class="n">send_dma_addr</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">send_dma_addr</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">ioarrin_reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">send_dma_addr</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">ioarrin_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_do_req -  Send driver initiated requests.</span>
<span class="cm"> * @ipr_cmd:		ipr command struct</span>
<span class="cm"> * @done:			done function</span>
<span class="cm"> * @timeout_func:	timeout function</span>
<span class="cm"> * @timeout:		timeout value</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends the specified command to the adapter with the</span>
<span class="cm"> * timeout given. The done function is invoked on command completion.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_do_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="p">),</span>
		       <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">timeout_func</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="p">),</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">timeout_func</span><span class="p">;</span>

	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">ipr_trc_hook</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_TRACE_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ipr_send_command</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_internal_cmd_done - Op done function for an internally generated op.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the op done function for an internally generated,</span>
<span class="cm"> * blocking op. It simply wakes the sleeping thread.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_internal_cmd_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_init_ioadl - initialize the ioadl for the correct SIS type</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @dma_addr:	dma address</span>
<span class="cm"> * @len:	transfer length</span>
<span class="cm"> * @flags:	ioadl flag value</span>
<span class="cm"> *</span>
<span class="cm"> * This function initializes an ioadl in the case where there is only a single</span>
<span class="cm"> * descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_init_ioadl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl_desc</span> <span class="o">*</span><span class="n">ioadl</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ioadl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span> <span class="o">*</span><span class="n">ioadl64</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ioadl64</span><span class="p">;</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl64</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ioadl64</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">ioadl64</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>

		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">ioadl_len</span> <span class="o">=</span>
		       	<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span><span class="p">));</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioadl</span><span class="o">-&gt;</span><span class="n">flags_and_data_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">flags</span> <span class="o">|</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ioadl</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="n">IPR_IOADL_FLAGS_READ_LAST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">read_ioadl_len</span> <span class="o">=</span>
				<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl_desc</span><span class="p">));</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">read_data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">ioadl_len</span> <span class="o">=</span>
			       	<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl_desc</span><span class="p">));</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_send_blocking_cmd - Send command and sleep on its completion.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @timeout_func:	function to invoke if command times out</span>
<span class="cm"> * @timeout:	timeout</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_send_blocking_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">timeout_func</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">),</span>
				  <span class="n">u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_internal_cmd_done</span><span class="p">,</span> <span class="n">timeout_func</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_send_hcam - Send an HCAM to the adapter.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @type:		HCAM type</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function will send a Host Controlled Async command to the adapter.</span>
<span class="cm"> * If HCAMs are currently not allowed to be issued to the adapter, it will</span>
<span class="cm"> * place the hostrcb on the free queue.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_send_hcam</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">ipr_get_free_ipr_cmnd</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_pending_q</span><span class="p">);</span>

		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hostrcb</span> <span class="o">=</span> <span class="n">hostrcb</span><span class="p">;</span>
		<span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>

		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">);</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_HCAM</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_HOST_CONTROLLED_ASYNC</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">ipr_init_ioadl</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hostrcb_dma</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">),</span> <span class="n">IPR_IOADL_FLAGS_READ_LAST</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE</span><span class="p">)</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_process_ccn</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_process_error</span><span class="p">;</span>

		<span class="n">ipr_trc_hook</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_TRACE_START</span><span class="p">,</span> <span class="n">IPR_IOA_RES_ADDR</span><span class="p">);</span>

		<span class="n">ipr_send_command</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_free_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_update_ata_class - Update the ata class in the resource entry</span>
<span class="cm"> * @res:	resource entry struct</span>
<span class="cm"> * @proto:	cfgte device bus protocol value</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_update_ata_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPR_PROTO_SATA</span>:
	<span class="k">case</span> <span class="n">IPR_PROTO_SAS_STP</span>:
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">ata_class</span> <span class="o">=</span> <span class="n">ATA_DEV_ATA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_PROTO_SATA_ATAPI</span>:
	<span class="k">case</span> <span class="n">IPR_PROTO_SAS_STP_ATAPI</span>:
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">ata_class</span> <span class="o">=</span> <span class="n">ATA_DEV_ATAPI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">ata_class</span> <span class="o">=</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_init_res_entry - Initialize a resource entry struct.</span>
<span class="cm"> * @res:	resource entry struct</span>
<span class="cm"> * @cfgtew:	config table entry wrapper struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_init_res_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ipr_config_table_entry_wrapper</span> <span class="o">*</span><span class="n">cfgtew</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">gscsi_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">in_erp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">add_to_ml</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">del_from_ml</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">resetting_device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">res_flags</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">res_flags</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">qmodel</span> <span class="o">=</span> <span class="n">IPR_QUEUEING_MODEL64</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">res_type</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">));</span>

		<span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_lun</span><span class="p">.</span><span class="n">scsi_lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_lun</span><span class="p">.</span><span class="n">scsi_lun</span><span class="p">));</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">scsilun_to_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_lun</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPR_RES_TYPE_GENERIC_SCSI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gscsi_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gscsi_res</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">==</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">gscsi_res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">target_ids</span><span class="p">,</span>
								  <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">target_ids</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPR_RES_TYPE_IOAFP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">IPR_IOAFP_VIRTUAL_BUS</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPR_RES_TYPE_ARRAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">IPR_ARRAY_VIRTUAL_BUS</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">array_ids</span><span class="p">,</span>
							  <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">array_ids</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPR_RES_TYPE_VOLUME_SET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">IPR_VSET_VIRTUAL_BUS</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vset_ids</span><span class="p">,</span>
							  <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vset_ids</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">target_ids</span><span class="p">,</span>
							  <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">target_ids</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">qmodel</span> <span class="o">=</span> <span class="n">IPR_QUEUEING_MODEL</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPR_IS_IOA_RESOURCE</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IPR_RES_TYPE_IOAFP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">rsvd_subtype</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

		<span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">res_addr</span><span class="p">.</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">res_addr</span><span class="p">.</span><span class="n">target</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">res_addr</span><span class="p">.</span><span class="n">lun</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">lun_wwn</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">lun_wwn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipr_update_ata_class</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_is_same_device - Determine if two devices are the same.</span>
<span class="cm"> * @res:	resource entry struct</span>
<span class="cm"> * @cfgtew:	config table entry wrapper struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	1 if the devices are the same / 0 otherwise</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_is_same_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ipr_config_table_entry_wrapper</span> <span class="o">*</span><span class="n">cfgtew</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_lun</span><span class="p">.</span><span class="n">scsi_lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">res_addr</span><span class="p">.</span><span class="n">bus</span> <span class="o">&amp;&amp;</span>
		    <span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">==</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">res_addr</span><span class="p">.</span><span class="n">target</span> <span class="o">&amp;&amp;</span>
		    <span class="n">res</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">==</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">res_addr</span><span class="p">.</span><span class="n">lun</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_format_res_path - Format the resource path for printing.</span>
<span class="cm"> * @res_path:	resource path</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	pointer to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ipr_format_res_path</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">res_path</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;%02X&quot;</span><span class="p">,</span> <span class="n">res_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">res_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;-%02X&quot;</span><span class="p">,</span> <span class="n">res_path</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_update_res_entry - Update the resource entry.</span>
<span class="cm"> * @res:	resource entry struct</span>
<span class="cm"> * @cfgtew:	config table entry wrapper struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *      none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_update_res_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ipr_config_table_entry_wrapper</span> <span class="o">*</span><span class="n">cfgtew</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IPR_MAX_RES_PATH_LENGTH</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">res_flags</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">res_flags</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">res_type</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">std_inq_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">std_inq_data</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_std_inq_data</span><span class="p">));</span>

		<span class="n">res</span><span class="o">-&gt;</span><span class="n">qmodel</span> <span class="o">=</span> <span class="n">IPR_QUEUEING_MODEL64</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_lun</span><span class="p">.</span><span class="n">scsi_lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_lun</span><span class="p">.</span><span class="n">scsi_lun</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">));</span>
			<span class="n">new_path</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">&amp;&amp;</span> <span class="n">new_path</span><span class="p">)</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;Resource path: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPR_IS_IOA_RESOURCE</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IPR_RES_TYPE_IOAFP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">rsvd_subtype</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">std_inq_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">std_inq_data</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_std_inq_data</span><span class="p">));</span>

		<span class="n">res</span><span class="o">-&gt;</span><span class="n">qmodel</span> <span class="o">=</span> <span class="n">IPR_QUEUEING_MODEL</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_update_ata_class</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_clear_res_target - Clear the bit in the bit map representing the target</span>
<span class="cm"> * 			  for the resource.</span>
<span class="cm"> * @res:	resource entry struct</span>
<span class="cm"> * @cfgtew:	config table entry wrapper struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *      none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_clear_res_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">gscsi_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">IPR_ARRAY_VIRTUAL_BUS</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">array_ids</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">IPR_VSET_VIRTUAL_BUS</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vset_ids</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPR_RES_TYPE_GENERIC_SCSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gscsi_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gscsi_res</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">&amp;&amp;</span> <span class="n">gscsi_res</span> <span class="o">!=</span> <span class="n">res</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">target_ids</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">target_ids</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_handle_config_change - Handle a config change from the adapter</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_handle_config_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_config_table_entry_wrapper</span> <span class="n">cfgtew</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">cc_res_handle</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">is_ndn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfgtew</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ccn</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="p">;</span>
		<span class="n">cc_res_handle</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cfgtew</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ccn</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="p">;</span>
		<span class="n">cc_res_handle</span> <span class="o">=</span> <span class="n">cfgtew</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">==</span> <span class="n">cc_res_handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">is_ndn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ndn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_res_q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipr_send_hcam</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span>
				      <span class="n">IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE</span><span class="p">,</span>
				      <span class="n">hostrcb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_res_q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ipr_resource_entry</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">ipr_init_res_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipr_update_res_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">notify_type</span> <span class="o">==</span> <span class="n">IPR_HOST_RCB_NOTIF_TYPE_REM_ENTRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">del_from_ml</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">IPR_INVALID_RES_HANDLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_ml_add_del</span><span class="p">)</span>
				<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">work_q</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ipr_clear_res_target</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_res_q</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">||</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">del_from_ml</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">add_to_ml</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_ml_add_del</span><span class="p">)</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">work_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipr_send_hcam</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_process_ccn - Op done function for a CCN.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the op done function for a configuration</span>
<span class="cm"> * change notification host controlled async from the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_process_ccn</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hostrcb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">!=</span> <span class="n">IPR_IOASC_IOA_WAS_RESET</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Host RCB failed with IOASC: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioasc</span><span class="p">);</span>

		<span class="n">ipr_send_hcam</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ipr_handle_config_change</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * strip_and_pad_whitespace - Strip and pad trailing whitespace.</span>
<span class="cm"> * @i:		index into buffer</span>
<span class="cm"> * @buf:		string to modify</span>
<span class="cm"> *</span>
<span class="cm"> * This function will strip all trailing whitespace, pad the end</span>
<span class="cm"> * of the string with a single space, and NULL terminate the string.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	new length of string</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">strip_and_pad_whitespace</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_vpd_compact - Log the passed extended VPD compactly.</span>
<span class="cm"> * @prefix:		string to print at start of printk</span>
<span class="cm"> * @hostrcb:	hostrcb pointer</span>
<span class="cm"> * @vpd:		vendor/product id/sn struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_vpd_compact</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipr_vpd</span> <span class="o">*</span><span class="n">vpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IPR_VENDOR_ID_LEN</span> <span class="o">+</span> <span class="n">IPR_PROD_ID_LEN</span> <span class="o">+</span> <span class="n">IPR_SERIAL_NUM_LEN</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">vpids</span><span class="p">.</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">IPR_VENDOR_ID_LEN</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">strip_and_pad_whitespace</span><span class="p">(</span><span class="n">IPR_VENDOR_ID_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">vpids</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span> <span class="n">IPR_PROD_ID_LEN</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">strip_and_pad_whitespace</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">IPR_PROD_ID_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">,</span> <span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">IPR_SERIAL_NUM_LEN</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s VPID/SN: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_vpd - Log the passed VPD to the error log.</span>
<span class="cm"> * @vpd:		vendor/product id/sn struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_vpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_vpd</span> <span class="o">*</span><span class="n">vpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IPR_VENDOR_ID_LEN</span> <span class="o">+</span> <span class="n">IPR_PROD_ID_LEN</span>
		    <span class="o">+</span> <span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">];</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">vpids</span><span class="p">.</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">IPR_VENDOR_ID_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">IPR_VENDOR_ID_LEN</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">vpids</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span>
	       <span class="n">IPR_PROD_ID_LEN</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">IPR_VENDOR_ID_LEN</span> <span class="o">+</span> <span class="n">IPR_PROD_ID_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Vendor/Product ID: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">vpd</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">,</span> <span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;    Serial Number: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_ext_vpd_compact - Log the passed extended VPD compactly.</span>
<span class="cm"> * @prefix:		string to print at start of printk</span>
<span class="cm"> * @hostrcb:	hostrcb pointer</span>
<span class="cm"> * @vpd:		vendor/product id/sn/wwn struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_ext_vpd_compact</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ipr_ext_vpd</span> <span class="o">*</span><span class="n">vpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipr_log_vpd_compact</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>
	<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s WWN: %08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_ext_vpd - Log the passed extended VPD to the error log.</span>
<span class="cm"> * @vpd:		vendor/product id/sn/wwn struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_ext_vpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ext_vpd</span> <span class="o">*</span><span class="n">vpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;    WWN: %08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_enhanced_cache_error - Log a cache error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_enhanced_cache_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_12_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error64</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_12_error</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_12_error</span><span class="p">;</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;-----Current Configuration-----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Cache Directory Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_vpd</span><span class="p">);</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Adapter Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">cfc_vpd</span><span class="p">);</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;-----Expected Configuration-----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Cache Directory Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_last_attached_to_cfc_vpd</span><span class="p">);</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Adapter Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">cfc_last_attached_to_ioa_vpd</span><span class="p">);</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Additional IOA Data: %08X %08X %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_cache_error - Log a cache error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_cache_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_02_error</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_02_error</span><span class="p">;</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;-----Current Configuration-----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Cache Directory Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_vpd</span><span class="p">);</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Adapter Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">cfc_vpd</span><span class="p">);</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;-----Expected Configuration-----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Cache Directory Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_last_attached_to_cfc_vpd</span><span class="p">);</span>
	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Adapter Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">cfc_last_attached_to_ioa_vpd</span><span class="p">);</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Additional IOA Data: %08X %08X %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_enhanced_config_error - Log a configuration error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_enhanced_config_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errors_logged</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_device_data_entry_enhanced</span> <span class="o">*</span><span class="n">dev_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_13_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_13_error</span><span class="p">;</span>
	<span class="n">errors_logged</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">errors_logged</span><span class="p">);</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Device Errors Detected/Logged: %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">errors_detected</span><span class="p">),</span> <span class="n">errors_logged</span><span class="p">);</span>

	<span class="n">dev_entry</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">errors_logged</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">dev_entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_err_separator</span><span class="p">;</span>

		<span class="n">ipr_phys_res_err</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">dev_res_addr</span><span class="p">,</span> <span class="s">&quot;Device %d&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;-----New Device Information-----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">new_vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Cache Directory Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">ioa_last_with_dev_vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Adapter Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">cfc_last_with_dev_vpd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_sis64_config_error - Log a device error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_sis64_config_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errors_logged</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb64_device_data_entry_enhanced</span> <span class="o">*</span><span class="n">dev_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_23_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IPR_MAX_RES_PATH_LENGTH</span><span class="p">];</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error64</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_23_error</span><span class="p">;</span>
	<span class="n">errors_logged</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">errors_logged</span><span class="p">);</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Device Errors Detected/Logged: %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">errors_detected</span><span class="p">),</span> <span class="n">errors_logged</span><span class="p">);</span>

	<span class="n">dev_entry</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">errors_logged</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">dev_entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_err_separator</span><span class="p">;</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Device %d : %s&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)));</span>
		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;-----New Device Information-----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">new_vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Cache Directory Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">ioa_last_with_dev_vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Adapter Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">cfc_last_with_dev_vpd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_config_error - Log a configuration error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_config_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errors_logged</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_device_data_entry</span> <span class="o">*</span><span class="n">dev_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_03_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_03_error</span><span class="p">;</span>
	<span class="n">errors_logged</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">errors_logged</span><span class="p">);</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Device Errors Detected/Logged: %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">errors_detected</span><span class="p">),</span> <span class="n">errors_logged</span><span class="p">);</span>

	<span class="n">dev_entry</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">errors_logged</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">dev_entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_err_separator</span><span class="p">;</span>

		<span class="n">ipr_phys_res_err</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">dev_res_addr</span><span class="p">,</span> <span class="s">&quot;Device %d&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;-----New Device Information-----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">new_vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Cache Directory Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">ioa_last_with_dev_vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Adapter Card Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">cfc_last_with_dev_vpd</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Additional IOA Data: %08X %08X %08X %08X %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dev_entry</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_enhanced_array_error - Log an array configuration error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_enhanced_array_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_entries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_14_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_array_data_entry_enhanced</span> <span class="o">*</span><span class="n">array_entry</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">zero_sn</span><span class="p">[</span><span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">IPR_SERIAL_NUM_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="p">};</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_14_error</span><span class="p">;</span>

	<span class="n">ipr_err_separator</span><span class="p">;</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;RAID %s Array Configuration: %d:%d:%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">protection_level</span><span class="p">,</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">last_func_vset_res_addr</span><span class="p">.</span><span class="n">bus</span><span class="p">,</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">last_func_vset_res_addr</span><span class="p">.</span><span class="n">target</span><span class="p">,</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">last_func_vset_res_addr</span><span class="p">.</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">ipr_err_separator</span><span class="p">;</span>

	<span class="n">array_entry</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">array_member</span><span class="p">;</span>
	<span class="n">num_entries</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">),</span>
			    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">array_member</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">array_entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">zero_sn</span><span class="p">,</span> <span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">exposed_mode_adn</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Exposed Array Member %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Array Member %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>
		<span class="n">ipr_phys_res_err</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">dev_res_addr</span><span class="p">,</span> <span class="s">&quot;Current Location&quot;</span><span class="p">);</span>
		<span class="n">ipr_phys_res_err</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">expected_dev_res_addr</span><span class="p">,</span>
				 <span class="s">&quot;Expected Location&quot;</span><span class="p">);</span>

		<span class="n">ipr_err_separator</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_array_error - Log an array configuration error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_array_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_04_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_array_data_entry</span> <span class="o">*</span><span class="n">array_entry</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">zero_sn</span><span class="p">[</span><span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">IPR_SERIAL_NUM_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="p">};</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_04_error</span><span class="p">;</span>

	<span class="n">ipr_err_separator</span><span class="p">;</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;RAID %s Array Configuration: %d:%d:%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">protection_level</span><span class="p">,</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">last_func_vset_res_addr</span><span class="p">.</span><span class="n">bus</span><span class="p">,</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">last_func_vset_res_addr</span><span class="p">.</span><span class="n">target</span><span class="p">,</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">last_func_vset_res_addr</span><span class="p">.</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">ipr_err_separator</span><span class="p">;</span>

	<span class="n">array_entry</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">array_member</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">zero_sn</span><span class="p">,</span> <span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">exposed_mode_adn</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Exposed Array Member %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Array Member %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">ipr_log_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>

		<span class="n">ipr_phys_res_err</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">dev_res_addr</span><span class="p">,</span> <span class="s">&quot;Current Location&quot;</span><span class="p">);</span>
		<span class="n">ipr_phys_res_err</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">expected_dev_res_addr</span><span class="p">,</span>
				 <span class="s">&quot;Expected Location&quot;</span><span class="p">);</span>

		<span class="n">ipr_err_separator</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
			<span class="n">array_entry</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">array_member2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">array_entry</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_hex_data - Log additional hex IOA error data.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @data:		IOA error data</span>
<span class="cm"> * @len:		data length</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_hex_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">log_level</span> <span class="o">&lt;=</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">IPR_DEFAULT_MAX_ERROR_DUMP</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;%08X: %08X %08X %08X %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_enhanced_dual_ioa_error - Log an enhanced dual adapter error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_enhanced_dual_ioa_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_17_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error64</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_17_error</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_17_error</span><span class="p">;</span>

	<span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">strim</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">);</span>

	<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s [PRC: %08X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">,</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">prc</span><span class="p">));</span>
	<span class="n">ipr_log_ext_vpd_compact</span><span class="p">(</span><span class="s">&quot;Remote IOA&quot;</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>
	<span class="n">ipr_log_hex_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span>
			 <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb_error</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">+</span>
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb_type_17_error</span><span class="p">,</span> <span class="n">data</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_dual_ioa_error - Log a dual adapter error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_dual_ioa_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_07_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_07_error</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">strim</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">);</span>

	<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s [PRC: %08X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">,</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">prc</span><span class="p">));</span>
	<span class="n">ipr_log_vpd_compact</span><span class="p">(</span><span class="s">&quot;Remote IOA&quot;</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>
	<span class="n">ipr_log_hex_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span>
			 <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb_error</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">+</span>
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb_type_07_error</span><span class="p">,</span> <span class="n">data</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">active</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">path_active_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">IPR_PATH_NO_INFO</span><span class="p">,</span> <span class="s">&quot;Path&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_ACTIVE</span><span class="p">,</span> <span class="s">&quot;Active path&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_NOT_ACTIVE</span><span class="p">,</span> <span class="s">&quot;Inactive path&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">path_state_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">IPR_PATH_STATE_NO_INFO</span><span class="p">,</span> <span class="s">&quot;has no path state information available&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_HEALTHY</span><span class="p">,</span> <span class="s">&quot;is healthy&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_DEGRADED</span><span class="p">,</span> <span class="s">&quot;is degraded&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_FAILED</span><span class="p">,</span> <span class="s">&quot;is failed&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_fabric_path - Log a fabric path error</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> * @fabric:		fabric descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_fabric_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipr_hostrcb_fabric_desc</span> <span class="o">*</span><span class="n">fabric</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">path_state</span> <span class="o">=</span> <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">path_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active</span> <span class="o">=</span> <span class="n">path_state</span> <span class="o">&amp;</span> <span class="n">IPR_PATH_ACTIVE_MASK</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">state</span> <span class="o">=</span> <span class="n">path_state</span> <span class="o">&amp;</span> <span class="n">IPR_PATH_STATE_MASK</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">path_active_desc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path_active_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">active</span> <span class="o">!=</span> <span class="n">active</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">path_state_desc</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">path_state_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: IOA Port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">path_active_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">path_state_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
					     <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">ioa_port</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: IOA Port=%d, Phy=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">path_active_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">path_state_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
					     <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">ioa_port</span><span class="p">,</span> <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: IOA Port=%d, Cascade=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">path_active_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">path_state_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
					     <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">ioa_port</span><span class="p">,</span> <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: IOA Port=%d, Cascade=%d, Phy=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">path_active_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">path_state_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
					     <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">ioa_port</span><span class="p">,</span> <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span><span class="p">,</span> <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Path state=%02X IOA Port=%d Cascade=%d Phy=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path_state</span><span class="p">,</span>
		<span class="n">fabric</span><span class="o">-&gt;</span><span class="n">ioa_port</span><span class="p">,</span> <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span><span class="p">,</span> <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log64_fabric_path - Log a fabric path error</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> * @fabric:		fabric descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log64_fabric_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ipr_hostrcb64_fabric_desc</span> <span class="o">*</span><span class="n">fabric</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">path_state</span> <span class="o">=</span> <span class="n">fabric</span><span class="o">-&gt;</span><span class="n">path_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active</span> <span class="o">=</span> <span class="n">path_state</span> <span class="o">&amp;</span> <span class="n">IPR_PATH_ACTIVE_MASK</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">state</span> <span class="o">=</span> <span class="n">path_state</span> <span class="o">&amp;</span> <span class="n">IPR_PATH_STATE_MASK</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IPR_MAX_RES_PATH_LENGTH</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">path_active_desc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path_active_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">active</span> <span class="o">!=</span> <span class="n">active</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">path_state_desc</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">path_state_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: Resource Path=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">path_active_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">path_state_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
				     <span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
							 <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Path state=%02X Resource Path=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path_state</span><span class="p">,</span>
		<span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">path_type_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">IPR_PATH_CFG_IOA_PORT</span><span class="p">,</span> <span class="s">&quot;IOA port&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_CFG_EXP_PORT</span><span class="p">,</span> <span class="s">&quot;Expander port&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_CFG_DEVICE_PORT</span><span class="p">,</span> <span class="s">&quot;Device port&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_CFG_DEVICE_LUN</span><span class="p">,</span> <span class="s">&quot;Device LUN&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">path_status_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">IPR_PATH_CFG_NO_PROB</span><span class="p">,</span> <span class="s">&quot;Functional&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_CFG_DEGRADED</span><span class="p">,</span> <span class="s">&quot;Degraded&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_CFG_FAILED</span><span class="p">,</span> <span class="s">&quot;Failed&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_CFG_SUSPECT</span><span class="p">,</span> <span class="s">&quot;Suspect&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_NOT_DETECTED</span><span class="p">,</span> <span class="s">&quot;Missing&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IPR_PATH_INCORRECT_CONN</span><span class="p">,</span> <span class="s">&quot;Incorrectly connected&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">link_rate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;disabled&quot;</span><span class="p">,</span>
	<span class="s">&quot;phy reset problem&quot;</span><span class="p">,</span>
	<span class="s">&quot;spinup hold&quot;</span><span class="p">,</span>
	<span class="s">&quot;port selector&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;1.5Gbps&quot;</span><span class="p">,</span>
	<span class="s">&quot;3.0Gbps&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;unknown&quot;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_path_elem - Log a fabric path element.</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> * @cfg:		fabric path element struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_path_elem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ipr_hostrcb_config_element</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type_status</span> <span class="o">&amp;</span> <span class="n">IPR_PATH_CFG_TYPE_MASK</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type_status</span> <span class="o">&amp;</span> <span class="n">IPR_PATH_CFG_STATUS_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPR_PATH_CFG_NOT_EXIST</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">path_type_desc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path_type_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">path_status_desc</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">path_status_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">status</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPR_PATH_CFG_IOA_PORT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: Phy=%d, Link rate=%s, WWN=%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">path_status_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">path_type_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
					     <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">link_rate</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">&amp;</span> <span class="n">IPR_PHY_LINK_RATE_MASK</span><span class="p">],</span>
					     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: Link rate=%s, WWN=%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">path_status_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">path_type_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
						     <span class="n">link_rate</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">&amp;</span> <span class="n">IPR_PHY_LINK_RATE_MASK</span><span class="p">],</span>
						     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: Phy=%d, Link rate=%s, &quot;</span>
						     <span class="s">&quot;WWN=%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path_status_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
						     <span class="n">path_type_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span>
						     <span class="n">link_rate</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">&amp;</span> <span class="n">IPR_PHY_LINK_RATE_MASK</span><span class="p">],</span>
						     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: Cascade=%d, Link rate=%s, &quot;</span>
						     <span class="s">&quot;WWN=%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path_status_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
						     <span class="n">path_type_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span><span class="p">,</span>
						     <span class="n">link_rate</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">&amp;</span> <span class="n">IPR_PHY_LINK_RATE_MASK</span><span class="p">],</span>
						     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: Cascade=%d, Phy=%d, Link rate=%s &quot;</span>
						     <span class="s">&quot;WWN=%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path_status_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
						     <span class="n">path_type_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span>
						     <span class="n">link_rate</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">&amp;</span> <span class="n">IPR_PHY_LINK_RATE_MASK</span><span class="p">],</span>
						     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;Path element=%02X: Cascade=%d Phy=%d Link rate=%s &quot;</span>
		     <span class="s">&quot;WWN=%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type_status</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cascaded_expander</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span>
		     <span class="n">link_rate</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">&amp;</span> <span class="n">IPR_PHY_LINK_RATE_MASK</span><span class="p">],</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log64_path_elem - Log a fabric path element.</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> * @cfg:		fabric path element struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log64_path_elem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipr_hostrcb64_config_element</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">desc_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">descriptor_id</span> <span class="o">&amp;</span> <span class="n">IPR_DESCRIPTOR_MASK</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type_status</span> <span class="o">&amp;</span> <span class="n">IPR_PATH_CFG_TYPE_MASK</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type_status</span> <span class="o">&amp;</span> <span class="n">IPR_PATH_CFG_STATUS_MASK</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IPR_MAX_RES_PATH_LENGTH</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPR_PATH_CFG_NOT_EXIST</span> <span class="o">||</span> <span class="n">desc_id</span> <span class="o">!=</span> <span class="n">IPR_DESCRIPTOR_SIS64</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">path_type_desc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path_type_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">path_status_desc</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">path_status_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">status</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s %s: Resource Path=%s, Link rate=%s, WWN=%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">path_status_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="n">path_type_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
				     <span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
							 <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)),</span>
				     <span class="n">link_rate</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">&amp;</span> <span class="n">IPR_PHY_LINK_RATE_MASK</span><span class="p">],</span>
				     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;Path element=%02X: Resource Path=%s, Link rate=%s &quot;</span>
		     <span class="s">&quot;WWN=%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type_status</span><span class="p">,</span>
		     <span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)),</span>
		     <span class="n">link_rate</span><span class="p">[</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">&amp;</span> <span class="n">IPR_PHY_LINK_RATE_MASK</span><span class="p">],</span>
		     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">wwid</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_fabric_error - Log a fabric error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_fabric_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_20_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_fabric_desc</span> <span class="o">*</span><span class="n">fabric</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_config_element</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">add_len</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_20_error</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">);</span>

	<span class="n">add_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb_error</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">+</span>
		 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb_type_20_error</span><span class="p">,</span> <span class="n">desc</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fabric</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_log_fabric_path</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="n">fabric</span><span class="p">);</span>
		<span class="n">for_each_fabric_cfg</span><span class="p">(</span><span class="n">fabric</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
			<span class="n">ipr_log_path_elem</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

		<span class="n">add_len</span> <span class="o">-=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">fabric</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb_fabric_desc</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fabric</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ipr_log_hex_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">fabric</span><span class="p">,</span> <span class="n">add_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_sis64_array_error - Log a sis64 array error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_sis64_array_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_entries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_24_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb64_array_data_entry</span> <span class="o">*</span><span class="n">array_entry</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IPR_MAX_RES_PATH_LENGTH</span><span class="p">];</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">zero_sn</span><span class="p">[</span><span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">IPR_SERIAL_NUM_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="p">};</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error64</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_24_error</span><span class="p">;</span>

	<span class="n">ipr_err_separator</span><span class="p">;</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;RAID %s Array Configuration: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">protection_level</span><span class="p">,</span>
		<span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">last_res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)));</span>

	<span class="n">ipr_err_separator</span><span class="p">;</span>

	<span class="n">array_entry</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">array_member</span><span class="p">;</span>
	<span class="n">num_entries</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">,</span>
			    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">array_member</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">array_entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">.</span><span class="n">vpd</span><span class="p">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">zero_sn</span><span class="p">,</span> <span class="n">IPR_SERIAL_NUM_LEN</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">exposed_mode_adn</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Exposed Array Member %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Array Member %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Array Member %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ipr_log_ext_vpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">);</span>
		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Current Location: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)));</span>
		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Expected Location: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">array_entry</span><span class="o">-&gt;</span><span class="n">expected_res_path</span><span class="p">,</span>
					     <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)));</span>

		<span class="n">ipr_err_separator</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_sis64_fabric_error - Log a sis64 fabric error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_sis64_fabric_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb_type_30_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb64_fabric_desc</span> <span class="o">*</span><span class="n">fabric</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb64_config_element</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">add_len</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error64</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">type_30_error</span><span class="p">;</span>

	<span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">failure_reason</span><span class="p">);</span>

	<span class="n">add_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb64_error</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">+</span>
		 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb_type_30_error</span><span class="p">,</span> <span class="n">desc</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fabric</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_log64_fabric_path</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="n">fabric</span><span class="p">);</span>
		<span class="n">for_each_fabric_cfg</span><span class="p">(</span><span class="n">fabric</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
			<span class="n">ipr_log64_path_elem</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

		<span class="n">add_len</span> <span class="o">-=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">fabric</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb64_fabric_desc</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fabric</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">fabric</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ipr_log_hex_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">fabric</span><span class="p">,</span> <span class="n">add_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_log_generic_error - Log an adapter error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_log_generic_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipr_log_hex_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_error - Find the specfied IOASC in the ipr_error_table.</span>
<span class="cm"> * @ioasc:	IOASC</span>
<span class="cm"> *</span>
<span class="cm"> * This function will return the index of into the ipr_error_table</span>
<span class="cm"> * for the specified IOASC. If the IOASC is not in the table,</span>
<span class="cm"> * 0 will be returned, which points to the entry used for unknown errors.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	index into the ipr_error_table</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ipr_get_error</span><span class="p">(</span><span class="n">u32</span> <span class="n">ioasc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipr_error_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_error_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ioasc</span> <span class="o">==</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">&amp;</span> <span class="n">IPR_IOASC_IOASC_MASK</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_handle_log_data - Log an adapter error.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @hostrcb:	hostrcb struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function logs an adapter error to the system.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_handle_log_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ioasc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">notify_type</span> <span class="o">!=</span> <span class="n">IPR_HOST_RCB_NOTIF_TYPE_ERROR_LOG_ENTRY</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">notifications_lost</span> <span class="o">==</span> <span class="n">IPR_HOST_RCB_NOTIFICATIONS_LOST</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error notifications lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error64</span><span class="p">.</span><span class="n">fd_ioasc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">fd_ioasc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_BUS_WAS_RESET</span> <span class="o">||</span>
	    <span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_BUS_WAS_RESET_BY_OTHER</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Tell the midlayer we had a bus reset so it will handle the UA properly */</span>
		<span class="n">scsi_report_bus_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				      <span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">fd_res_addr</span><span class="p">.</span><span class="n">bus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error_index</span> <span class="o">=</span> <span class="n">ipr_get_error</span><span class="p">(</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_error_table</span><span class="p">[</span><span class="n">error_index</span><span class="p">].</span><span class="n">log_hcam</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ipr_hcam_err</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ipr_error_table</span><span class="p">[</span><span class="n">error_index</span><span class="p">].</span><span class="n">error</span><span class="p">);</span>

	<span class="cm">/* Set indication we have logged an error */</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">errors_logged</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="n">ipr_error_table</span><span class="p">[</span><span class="n">error_index</span><span class="p">].</span><span class="n">log_hcam</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">))</span>
		<span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">overlay_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_2</span>:
		<span class="n">ipr_log_cache_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_3</span>:
		<span class="n">ipr_log_config_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_4</span>:
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_6</span>:
		<span class="n">ipr_log_array_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_7</span>:
		<span class="n">ipr_log_dual_ioa_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_12</span>:
		<span class="n">ipr_log_enhanced_cache_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_13</span>:
		<span class="n">ipr_log_enhanced_config_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_14</span>:
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_16</span>:
		<span class="n">ipr_log_enhanced_array_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_17</span>:
		<span class="n">ipr_log_enhanced_dual_ioa_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_20</span>:
		<span class="n">ipr_log_fabric_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_23</span>:
		<span class="n">ipr_log_sis64_config_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_24</span>:
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_26</span>:
		<span class="n">ipr_log_sis64_array_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_30</span>:
		<span class="n">ipr_log_sis64_fabric_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_1</span>:
	<span class="k">case</span> <span class="n">IPR_HOST_RCB_OVERLAY_ID_DEFAULT</span>:
	<span class="nl">default:</span>
		<span class="n">ipr_log_generic_error</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_process_error - Op done function for an adapter error log.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the op done function for an error log host</span>
<span class="cm"> * controlled async from the adapter. It will log the error and</span>
<span class="cm"> * send the HCAM back to the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_process_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hostrcb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fd_ioasc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">fd_ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error64</span><span class="p">.</span><span class="n">fd_ioasc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fd_ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">fd_ioasc</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioasc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_handle_log_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fd_ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_NR_IOA_RESET_REQUIRED</span><span class="p">)</span>
			<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_ABBREV</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">!=</span> <span class="n">IPR_IOASC_IOA_WAS_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Host RCB failed with IOASC: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioasc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipr_send_hcam</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_HCAM_CDB_OP_CODE_LOG_DATA</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_timeout -  An internally generated op has timed out.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function blocks host requests and initiates an</span>
<span class="cm"> * adapter reset.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">errors_logged</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Adapter being reset due to command timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_DUMP</span> <span class="o">==</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">GET_DUMP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span> <span class="o">||</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span> <span class="o">==</span> <span class="n">ipr_cmd</span><span class="p">)</span>
		<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_oper_timeout -  Adapter timed out transitioning to operational</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function blocks host requests and initiates an</span>
<span class="cm"> * adapter reset.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_oper_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">errors_logged</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Adapter timed out transitioning to operational.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_DUMP</span> <span class="o">==</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">GET_DUMP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span> <span class="o">||</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span> <span class="o">==</span> <span class="n">ipr_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_fastfail</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_retries</span> <span class="o">+=</span> <span class="n">IPR_NUM_RESET_RELOAD_RETRIES</span><span class="p">;</span>
		<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_reload - Reset/Reload the IOA</span>
<span class="cm"> * @ioa_cfg:		ioa config struct</span>
<span class="cm"> * @shutdown_type:	shutdown type</span>
<span class="cm"> *</span>
<span class="cm"> * This function resets the adapter and re-initializes it.</span>
<span class="cm"> * This function assumes that all new host commands have been stopped.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	SUCCESS / FAILED</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_reload</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ipr_shutdown_type</span> <span class="n">shutdown_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span>
		<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">shutdown_type</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="cm">/* If we got hit with a host reset while we were already resetting</span>
<span class="cm">	 the adapter for some reason, and the reset failed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_trace</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_find_ses_entry - Find matching SES in SES table</span>
<span class="cm"> * @res:	resource entry struct of SES</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	pointer to SES table entry / NULL on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipr_ses_table_entry</span> <span class="o">*</span>
<span class="nf">ipr_find_ses_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">matches</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_std_inq_vpids</span> <span class="o">*</span><span class="n">vpids</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ipr_ses_table_entry</span> <span class="o">*</span><span class="n">ste</span> <span class="o">=</span> <span class="n">ipr_ses_table</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipr_ses_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ste</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">IPR_PROD_ID_LEN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ste</span><span class="o">-&gt;</span><span class="n">compare_product_id_byte</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vpids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">std_inq_data</span><span class="p">.</span><span class="n">vpids</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vpids</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">ste</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
					<span class="n">matches</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">matches</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="n">IPR_PROD_ID_LEN</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ste</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_max_scsi_speed - Determine max SCSI speed for a given bus</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @bus:		SCSI bus</span>
<span class="cm"> * @bus_width:	bus width</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	SCSI bus speed in units of 100KHz, 1600 is 160 MHz</span>
<span class="cm"> *	For a 2-byte wide SCSI bus, the maximum transfer speed is</span>
<span class="cm"> *	twice the maximum transfer rate (e.g. for a wide enabled bus,</span>
<span class="cm"> *	max 160MHz = max 320MB/sec).</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ipr_get_max_scsi_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ipr_ses_table_entry</span> <span class="o">*</span><span class="n">ste</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_xfer_rate</span> <span class="o">=</span> <span class="n">IPR_MAX_SCSI_RATE</span><span class="p">(</span><span class="n">bus_width</span><span class="p">);</span>

	<span class="cm">/* Loop through each config table entry in the config table buffer */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">IPR_IS_SES_DEVICE</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">std_inq_data</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">!=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ste</span> <span class="o">=</span> <span class="n">ipr_find_ses_entry</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">max_xfer_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">ste</span><span class="o">-&gt;</span><span class="n">max_bus_speed_limit</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">bus_width</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">max_xfer_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_wait_iodbg_ack - Wait for an IODEBUG ACK from the IOA</span>
<span class="cm"> * @ioa_cfg:		ioa config struct</span>
<span class="cm"> * @max_delay:		max delay in micro-seconds to wait</span>
<span class="cm"> *</span>
<span class="cm"> * Waits for an IODEBUG ACK from the IOA, doing busy looping.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_wait_iodbg_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">pcii_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Read interrupt reg until IOA signals IO Debug Acknowledge */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">max_delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcii_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pcii_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_IO_DEBUG_ACKNOWLEDGE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* udelay cannot be used if delay is more than a few milliseconds */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">delay</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_UDELAY_MS</span><span class="p">)</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="n">delay</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>

		<span class="n">delay</span> <span class="o">+=</span> <span class="n">delay</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_sis64_dump_data_section - Dump IOA memory</span>
<span class="cm"> * @ioa_cfg:			ioa config struct</span>
<span class="cm"> * @start_addr:			adapter address to dump</span>
<span class="cm"> * @dest:			destination kernel buffer</span>
<span class="cm"> * @length_in_words:		length to dump in 4 byte words</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_get_sis64_dump_data_section</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
					   <span class="n">u32</span> <span class="n">start_addr</span><span class="p">,</span>
					   <span class="n">__be32</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length_in_words</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length_in_words</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">start_addr</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">dump_addr_reg</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">dump_data_reg</span><span class="p">));</span>
		<span class="n">dest</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_ldump_data_section - Dump IOA memory</span>
<span class="cm"> * @ioa_cfg:			ioa config struct</span>
<span class="cm"> * @start_addr:			adapter address to dump</span>
<span class="cm"> * @dest:				destination kernel buffer</span>
<span class="cm"> * @length_in_words:	length to dump in 4 byte words</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / -EIO on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_get_ldump_data_section</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">start_addr</span><span class="p">,</span>
				      <span class="n">__be32</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length_in_words</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">temp_pcii_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ipr_get_sis64_dump_data_section</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">,</span>
						       <span class="n">dest</span><span class="p">,</span> <span class="n">length_in_words</span><span class="p">);</span>

	<span class="cm">/* Write IOA interrupt reg starting LDUMP state  */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">IPR_UPROCI_RESET_ALERT</span> <span class="o">|</span> <span class="n">IPR_UPROCI_IO_DEBUG_ALERT</span><span class="p">),</span>
	       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_uproc_interrupt_reg32</span><span class="p">);</span>

	<span class="cm">/* Wait for IO debug acknowledge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_wait_iodbg_ack</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span>
			       <span class="n">IPR_LDUMP_MAX_LONG_ACK_DELAY_IN_USEC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;IOA dump long data transfer timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Signal LDUMP interlocked - clear IO debug ack */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_IO_DEBUG_ACKNOWLEDGE</span><span class="p">,</span>
	       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_reg</span><span class="p">);</span>

	<span class="cm">/* Write Mailbox with starting address */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_mailbox</span><span class="p">);</span>

	<span class="cm">/* Signal address valid - clear IOA Reset alert */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">IPR_UPROCI_RESET_ALERT</span><span class="p">,</span>
	       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_uproc_interrupt_reg32</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length_in_words</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wait for IO debug acknowledge */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_wait_iodbg_ack</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span>
				       <span class="n">IPR_LDUMP_MAX_SHORT_ACK_DELAY_IN_USEC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;IOA dump short data transfer timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read data from mailbox and increment destination pointer */</span>
		<span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_mailbox</span><span class="p">));</span>
		<span class="n">dest</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* For all but the last word of data, signal data received */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">length_in_words</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Signal dump data received - Clear IO debug Ack */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_IO_DEBUG_ACKNOWLEDGE</span><span class="p">,</span>
			       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Signal end of block transfer. Set reset alert then clear IO debug ack */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">IPR_UPROCI_RESET_ALERT</span><span class="p">,</span>
	       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_uproc_interrupt_reg32</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">IPR_UPROCI_IO_DEBUG_ALERT</span><span class="p">,</span>
	       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_uproc_interrupt_reg32</span><span class="p">);</span>

	<span class="cm">/* Signal dump data received - Clear IO debug Ack */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_IO_DEBUG_ACKNOWLEDGE</span><span class="p">,</span>
	       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_reg</span><span class="p">);</span>

	<span class="cm">/* Wait for IOA to signal LDUMP exit - IOA reset alert will be cleared */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">IPR_LDUMP_MAX_SHORT_ACK_DELAY_IN_USEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp_pcii_reg</span> <span class="o">=</span>
		    <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_uproc_interrupt_reg32</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp_pcii_reg</span> <span class="o">&amp;</span> <span class="n">IPR_UPROCI_RESET_ALERT</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">delay</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_IPR_DUMP</span>
<span class="cm">/**</span>
<span class="cm"> * ipr_sdt_copy - Copy Smart Dump Table to kernel buffer</span>
<span class="cm"> * @ioa_cfg:		ioa config struct</span>
<span class="cm"> * @pci_address:	adapter address</span>
<span class="cm"> * @length:			length of data to copy</span>
<span class="cm"> *</span>
<span class="cm"> * Copy data from PCI adapter to kernel buffer.</span>
<span class="cm"> * Note: length MUST be a 4 byte multiple</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_sdt_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pci_address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bytes_copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_len</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rem_len</span><span class="p">,</span> <span class="n">rem_page_len</span><span class="p">,</span> <span class="n">max_dump_size</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_dump</span> <span class="o">*</span><span class="n">ioa_dump</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">max_dump_size</span> <span class="o">=</span> <span class="n">IPR_FMT3_MAX_IOA_DUMP_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_dump_size</span> <span class="o">=</span> <span class="n">IPR_FMT2_MAX_IOA_DUMP_SIZE</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bytes_copied</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="n">bytes_copied</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_dump_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span> <span class="o">||</span>
		    <span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ipr_trace</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">bytes_copied</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">next_page_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
			<span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">next_page_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">ioa_data</span><span class="p">[</span><span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">next_page_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">rem_len</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">bytes_copied</span><span class="p">;</span>
		<span class="n">rem_page_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">;</span>
		<span class="n">cur_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">rem_len</span><span class="p">,</span> <span class="n">rem_page_len</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">ABORT_DUMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_get_ldump_data_section</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span>
							<span class="n">pci_address</span> <span class="o">+</span> <span class="n">bytes_copied</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
							<span class="p">(</span><span class="n">cur_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">+=</span> <span class="n">cur_len</span><span class="p">;</span>
			<span class="n">bytes_copied</span> <span class="o">+=</span> <span class="n">cur_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ipr_trace</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bytes_copied</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_init_dump_entry_hdr - Initialize a dump entry header.</span>
<span class="cm"> * @hdr:	dump entry header struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_init_dump_entry_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_entry_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">eye_catcher</span> <span class="o">=</span> <span class="n">IPR_DUMP_EYE_CATCHER</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">num_elems</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IPR_DUMP_STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_dump_ioa_type_data - Fill in the adapter type in the dump.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @driver_dump:	driver dump struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_dump_ioa_type_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ipr_driver_dump</span> <span class="o">*</span><span class="n">driver_dump</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_inquiry_page3</span> <span class="o">*</span><span class="n">ucode_vpd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">page3_data</span><span class="p">;</span>

	<span class="n">ipr_init_dump_entry_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">ioa_type_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">ioa_type_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_ioa_type_entry</span><span class="p">)</span> <span class="o">-</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_entry_header</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">ioa_type_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">IPR_DUMP_DATA_TYPE_BINARY</span><span class="p">;</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">ioa_type_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IPR_DUMP_DRIVER_TYPE_ID</span><span class="p">;</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">ioa_type_entry</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">ioa_type_entry</span><span class="p">.</span><span class="n">fw_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">major_release</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">minor_release</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">minor_release</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">num_entries</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_dump_version_data - Fill in the driver version in the dump.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @driver_dump:	driver dump struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_dump_version_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ipr_driver_dump</span> <span class="o">*</span><span class="n">driver_dump</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipr_init_dump_entry_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">version_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">version_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_version_entry</span><span class="p">)</span> <span class="o">-</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_entry_header</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">version_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">IPR_DUMP_DATA_TYPE_ASCII</span><span class="p">;</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">version_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IPR_DUMP_DRIVER_VERSION_ID</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">version_entry</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="n">IPR_DRIVER_VERSION</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">num_entries</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_dump_trace_data - Fill in the IOA trace in the dump.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @driver_dump:	driver dump struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_dump_trace_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ipr_driver_dump</span> <span class="o">*</span><span class="n">driver_dump</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipr_init_dump_entry_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">trace_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">trace_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_trace_entry</span><span class="p">)</span> <span class="o">-</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_entry_header</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">trace_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">IPR_DUMP_DATA_TYPE_BINARY</span><span class="p">;</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">trace_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IPR_DUMP_TRACE_ID</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">trace_entry</span><span class="p">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">,</span> <span class="n">IPR_TRACE_SIZE</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">num_entries</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_dump_location_data - Fill in the IOA location in the dump.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @driver_dump:	driver dump struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_dump_location_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ipr_driver_dump</span> <span class="o">*</span><span class="n">driver_dump</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipr_init_dump_entry_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">location_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">location_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_location_entry</span><span class="p">)</span> <span class="o">-</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_entry_header</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">location_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">IPR_DUMP_DATA_TYPE_ASCII</span><span class="p">;</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">location_entry</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IPR_DUMP_LOCATION_ID</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">location_entry</span><span class="p">.</span><span class="n">location</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">num_entries</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_ioa_dump - Perform a dump of the driver and adapter.</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @dump:		dump struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_get_ioa_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipr_dump</span> <span class="o">*</span><span class="n">dump</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">sdt_word</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_driver_dump</span> <span class="o">*</span><span class="n">driver_dump</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_dump</span> <span class="o">*</span><span class="n">ioa_dump</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_entries</span><span class="p">,</span> <span class="n">max_num_entries</span><span class="p">,</span> <span class="n">start_off</span><span class="p">,</span> <span class="n">end_off</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_dump_size</span><span class="p">,</span> <span class="n">bytes_to_copy</span><span class="p">,</span> <span class="n">bytes_copied</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sdt</span> <span class="o">*</span><span class="n">sdt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">!=</span> <span class="n">READ_DUMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="n">IPR_DUMP_DELAY_SECONDS</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">start_addr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_mailbox</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipr_sdt_is_fmt2</span><span class="p">(</span><span class="n">start_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Invalid dump table format: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dump of IOA initiated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">eye_catcher</span> <span class="o">=</span> <span class="n">IPR_DUMP_EYE_CATCHER</span><span class="p">;</span>

	<span class="cm">/* Initialize the overall dump header */</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_driver_dump</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">first_entry_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_header</span><span class="p">);</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">IPR_DUMP_STATUS_SUCCESS</span><span class="p">;</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">IPR_DUMP_OS_LINUX</span><span class="p">;</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">IPR_DUMP_DRIVER_NAME</span><span class="p">;</span>

	<span class="n">ipr_dump_version_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">driver_dump</span><span class="p">);</span>
	<span class="n">ipr_dump_location_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">driver_dump</span><span class="p">);</span>
	<span class="n">ipr_dump_ioa_type_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">driver_dump</span><span class="p">);</span>
	<span class="n">ipr_dump_trace_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">driver_dump</span><span class="p">);</span>

	<span class="cm">/* Update dump_header */</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump_entry_header</span><span class="p">);</span>

	<span class="cm">/* IOA Dump entry */</span>
	<span class="n">ipr_init_dump_entry_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">IPR_DUMP_DATA_TYPE_BINARY</span><span class="p">;</span>
	<span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IPR_DUMP_IOA_DUMP_ID</span><span class="p">;</span>

	<span class="cm">/* First entries in sdt are actually a list of dump addresses and</span>
<span class="cm">	 lengths to gather the real dump data.  sdt represents the pointer</span>
<span class="cm">	 to the ioa generated dump table.  Dump data will be extracted based</span>
<span class="cm">	 on entries in this table */</span>
	<span class="n">sdt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">sdt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_num_entries</span> <span class="o">=</span> <span class="n">IPR_FMT3_NUM_SDT_ENTRIES</span><span class="p">;</span>
		<span class="n">max_dump_size</span> <span class="o">=</span> <span class="n">IPR_FMT3_MAX_IOA_DUMP_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">max_num_entries</span> <span class="o">=</span> <span class="n">IPR_FMT2_NUM_SDT_ENTRIES</span><span class="p">;</span>
		<span class="n">max_dump_size</span> <span class="o">=</span> <span class="n">IPR_FMT2_MAX_IOA_DUMP_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bytes_to_copy</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sdt</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">max_num_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sdt_entry</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_get_ldump_data_section</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">sdt</span><span class="p">,</span>
					<span class="n">bytes_to_copy</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>

	<span class="cm">/* Smart Dump table is ready to use and the first entry is valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="p">((</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IPR_FMT3_SDT_READY_TO_USE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IPR_FMT2_SDT_READY_TO_USE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Dump of IOA failed. Dump table not valid: %d, %X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span><span class="p">));</span>
		<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">IPR_DUMP_STATUS_FAILED</span><span class="p">;</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">DUMP_OBTAINED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">num_entries</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">num_entries_used</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">&gt;</span> <span class="n">max_num_entries</span><span class="p">)</span>
		<span class="n">num_entries</span> <span class="o">=</span> <span class="n">max_num_entries</span><span class="p">;</span>

	<span class="cm">/* Update dump length to the actual data to be copied */</span>
	<span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sdt_header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">num_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sdt_entry</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">max_num_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sdt_entry</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max_dump_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">IPR_DUMP_STATUS_QUAL_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPR_SDT_VALID_ENTRY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdt_word</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start_token</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
				<span class="n">bytes_to_copy</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end_token</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">start_off</span> <span class="o">=</span> <span class="n">sdt_word</span> <span class="o">&amp;</span> <span class="n">IPR_FMT2_MBX_ADDR_MASK</span><span class="p">;</span>
				<span class="n">end_off</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end_token</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ipr_sdt_is_fmt2</span><span class="p">(</span><span class="n">sdt_word</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sdt_word</span><span class="p">)</span>
					<span class="n">bytes_to_copy</span> <span class="o">=</span> <span class="n">end_off</span> <span class="o">-</span> <span class="n">start_off</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bytes_to_copy</span> <span class="o">&gt;</span> <span class="n">max_dump_size</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sdt</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPR_SDT_VALID_ENTRY</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Copy data from adapter to driver buffers */</span>
				<span class="n">bytes_copied</span> <span class="o">=</span> <span class="n">ipr_sdt_copy</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">sdt_word</span><span class="p">,</span>
							    <span class="n">bytes_to_copy</span><span class="p">);</span>

				<span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">bytes_copied</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bytes_copied</span> <span class="o">!=</span> <span class="n">bytes_to_copy</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">IPR_DUMP_STATUS_QUAL_SUCCESS</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dump of IOA completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Update dump_header */</span>
	<span class="n">driver_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="n">ioa_dump</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">DUMP_OBTAINED</span><span class="p">;</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define ipr_get_ioa_dump(ioa_cfg, dump) do { } while(0)</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_release_dump - Free adapter dump memory</span>
<span class="cm"> * @kref:	kref struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_release_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_dump</span> <span class="o">*</span><span class="n">dump</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span><span class="k">struct</span> <span class="n">ipr_dump</span><span class="p">,</span><span class="n">kref</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">INACTIVE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span><span class="p">.</span><span class="n">next_page_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span><span class="p">.</span><span class="n">ioa_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span><span class="p">.</span><span class="n">ioa_data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dump</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_worker_thread - Worker thread</span>
<span class="cm"> * @work:		ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Called at task level from a work thread. This function takes care</span>
<span class="cm"> * of adding and removing device from the mid-layer as configuration</span>
<span class="cm"> * changes are detected by the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_worker_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_dump</span> <span class="o">*</span><span class="n">dump</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipr_ioa_cfg</span><span class="p">,</span> <span class="n">work_q</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">did_work</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">READ_DUMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dump</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">ipr_get_ioa_dump</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">dump</span><span class="p">);</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">ipr_release_dump</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">DUMP_OBTAINED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump_timeout</span><span class="p">)</span>
			<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">restart:</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">did_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_ml_add_del</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">del_from_ml</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">did_work</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">sdev</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_device_get</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">add_to_ml</span><span class="p">)</span>
						<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_res_q</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">del_from_ml</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
					<span class="n">scsi_remove_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
					<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">did_work</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">add_to_ml</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bus</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">;</span>
			<span class="n">lun</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">add_to_ml</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
			<span class="n">scsi_add_device</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SCSI_IPR_TRACE</span>
<span class="cm">/**</span>
<span class="cm"> * ipr_read_trace - Dump the adapter trace</span>
<span class="cm"> * @filp:		open sysfs file</span>
<span class="cm"> * @kobj:		kobject struct</span>
<span class="cm"> * @bin_attr:		bin_attribute struct</span>
<span class="cm"> * @buf:		buffer</span>
<span class="cm"> * @off:		offset</span>
<span class="cm"> * @count:		buffer size</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_read_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">memory_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">,</span>
				<span class="n">IPR_TRACE_SIZE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">ipr_trace_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span>	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;trace&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ipr_read_trace</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_show_fw_version - Show the firmware version</span>
<span class="cm"> * @dev:	class device struct</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_show_fw_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_inquiry_page3</span> <span class="o">*</span><span class="n">ucode_vpd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">page3_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%02X%02X%02X%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">major_release</span><span class="p">,</span> <span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">card_type</span><span class="p">,</span>
		       <span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">minor_release</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		       <span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">minor_release</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_fw_version_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;fw_version&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ipr_show_fw_version</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_show_log_level - Show the adapter&#39;s error logging level</span>
<span class="cm"> * @dev:	class device struct</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_show_log_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">log_level</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_store_log_level - Change the adapter&#39;s error logging level</span>
<span class="cm"> * @dev:	class device struct</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_store_log_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			           <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_log_level_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;log_level&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ipr_show_log_level</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">ipr_store_log_level</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_store_diagnostics - IOA Diagnostics interface</span>
<span class="cm"> * @dev:	device struct</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> * @count:	buffer size</span>
<span class="cm"> *</span>
<span class="cm"> * This function will reset the adapter and wait a reasonable</span>
<span class="cm"> * amount of time for any errors that the adapter might log.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	count on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_store_diagnostics</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">errors_logged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NORMAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>

		<span class="cm">/* Wait for a second for any errors to be logged */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span> <span class="o">||</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">errors_logged</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_diagnostics_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;run_diagnostics&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">ipr_store_diagnostics</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_show_adapter_state - Show the adapter&#39;s state</span>
<span class="cm"> * @class_dev:	device struct</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_show_adapter_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;offline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;online</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_store_adapter_state - Change adapter state</span>
<span class="cm"> * @dev:	device struct</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> * @count:	buffer size</span>
<span class="cm"> *</span>
<span class="cm"> * This function will change the adapter&#39;s state.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	count on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_store_adapter_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;online&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_ioa_bringdown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_ioa_state_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;online_state&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ipr_show_adapter_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">ipr_store_adapter_state</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_store_reset_adapter - Reset the adapter</span>
<span class="cm"> * @dev:	device struct</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> * @count:	buffer size</span>
<span class="cm"> *</span>
<span class="cm"> * This function will reset the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	count on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_store_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span>
		<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NORMAL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_ioa_reset_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;reset_host&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">ipr_store_reset_adapter</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_alloc_ucode_buffer - Allocates a microcode download buffer</span>
<span class="cm"> * @buf_len:		buffer length</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates a DMA&#39;able buffer in chunks and assembles a scatter/gather</span>
<span class="cm"> * list to use for microcode download</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	pointer to sglist / NULL on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="nf">ipr_alloc_ucode_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sg_size</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">bsize_elem</span><span class="p">,</span> <span class="n">num_elem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">scatterlist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="cm">/* Get the minimum size per scatter/gather element */</span>
	<span class="n">sg_size</span> <span class="o">=</span> <span class="n">buf_len</span> <span class="o">/</span> <span class="p">(</span><span class="n">IPR_MAX_SGLIST</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Get the actual size per element */</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">sg_size</span><span class="p">);</span>

	<span class="cm">/* Determine the actual number of bytes per element */</span>
	<span class="n">bsize_elem</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">);</span>

	<span class="cm">/* Determine the actual number of sg entries needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">%</span> <span class="n">bsize_elem</span><span class="p">)</span>
		<span class="n">num_elem</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">/</span> <span class="n">bsize_elem</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">num_elem</span> <span class="o">=</span> <span class="n">buf_len</span> <span class="o">/</span> <span class="n">bsize_elem</span><span class="p">;</span>

	<span class="cm">/* Allocate a scatter/gather list for the DMA */</span>
	<span class="n">sglist</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sglist</span><span class="p">)</span> <span class="o">+</span>
			 <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_elem</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
			 <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sglist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_trace</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scatterlist</span> <span class="o">=</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">scatterlist</span><span class="p">;</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">scatterlist</span><span class="p">,</span> <span class="n">num_elem</span><span class="p">);</span>

	<span class="n">sglist</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
	<span class="n">sglist</span><span class="o">-&gt;</span><span class="n">num_sg</span> <span class="o">=</span> <span class="n">num_elem</span><span class="p">;</span>

	<span class="cm">/* Allocate a bunch of sg elements */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_elem</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipr_trace</span><span class="p">;</span>

			<span class="cm">/* Free up what we already allocated */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
				<span class="n">__free_pages</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scatterlist</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">order</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sglist</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sglist</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_free_ucode_buffer - Frees a microcode download buffer</span>
<span class="cm"> * @p_dnld:		scatter/gather list pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Free a DMA&#39;able ucode download buffer previously allocated with</span>
<span class="cm"> * ipr_alloc_ucode_buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_free_ucode_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">num_sg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__free_pages</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sglist</span><span class="o">-&gt;</span><span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sglist</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_copy_ucode_buffer - Copy user buffer to kernel buffer</span>
<span class="cm"> * @sglist:		scatter/gather list pointer</span>
<span class="cm"> * @buffer:		buffer pointer</span>
<span class="cm"> * @len:		buffer length</span>
<span class="cm"> *</span>
<span class="cm"> * Copy a microcode image from a user buffer into a buffer allocated by</span>
<span class="cm"> * ipr_alloc_ucode_buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_copy_ucode_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bsize_elem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">scatterlist</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>

	<span class="cm">/* Determine the actual number of bytes per element */</span>
	<span class="n">bsize_elem</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">);</span>

	<span class="n">scatterlist</span> <span class="o">=</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">scatterlist</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="n">bsize_elem</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+=</span> <span class="n">bsize_elem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">kaddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bsize_elem</span><span class="p">);</span>
		<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">bsize_elem</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipr_trace</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">bsize_elem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">kaddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span> <span class="o">%</span> <span class="n">bsize_elem</span><span class="p">);</span>
		<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span> <span class="o">%</span> <span class="n">bsize_elem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sglist</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_build_ucode_ioadl64 - Build a microcode download IOADL</span>
<span class="cm"> * @ipr_cmd:		ipr command struct</span>
<span class="cm"> * @sglist:		scatter/gather list</span>
<span class="cm"> *</span>
<span class="cm"> * Builds a microcode download IOA data list (IOADL).</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_build_ucode_ioadl64</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span> <span class="o">*</span><span class="n">ioadl64</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ioadl64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">scatterlist</span> <span class="o">=</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">scatterlist</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span> <span class="o">=</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">num_dma_sg</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_WRITE_NOT_READ</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sglist</span><span class="o">-&gt;</span><span class="n">buffer_len</span><span class="p">);</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioadl_len</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOADL_FLAGS_WRITE</span><span class="p">);</span>
		<span class="n">ioadl64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">ioadl64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="n">ioadl64</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOADL_FLAGS_LAST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_build_ucode_ioadl - Build a microcode download IOADL</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @sglist:		scatter/gather list</span>
<span class="cm"> *</span>
<span class="cm"> * Builds a microcode download IOA data list (IOADL).</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_build_ucode_ioadl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl_desc</span> <span class="o">*</span><span class="n">ioadl</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ioadl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">scatterlist</span> <span class="o">=</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">scatterlist</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span> <span class="o">=</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">num_dma_sg</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_WRITE_NOT_READ</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sglist</span><span class="o">-&gt;</span><span class="n">buffer_len</span><span class="p">);</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioadl_len</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags_and_data_len</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOADL_FLAGS_WRITE</span> <span class="o">|</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">ioadl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scatterlist</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="n">ioadl</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags_and_data_len</span> <span class="o">|=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOADL_FLAGS_LAST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_update_ioa_ucode - Update IOA&#39;s microcode</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @sglist:		scatter/gather list</span>
<span class="cm"> *</span>
<span class="cm"> * Initiate an adapter reset to update the IOA&#39;s microcode</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / -EIO on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_update_ioa_ucode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ucode_sglist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Microcode download already in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sglist</span><span class="o">-&gt;</span><span class="n">num_dma_sg</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">scatterlist</span><span class="p">,</span>
					<span class="n">sglist</span><span class="o">-&gt;</span><span class="n">num_sg</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sglist</span><span class="o">-&gt;</span><span class="n">num_dma_sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to map microcode download buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ucode_sglist</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
	<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NORMAL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ucode_sglist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_store_update_fw - Update the firmware on the adapter</span>
<span class="cm"> * @class_dev:	device struct</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> * @count:	buffer size</span>
<span class="cm"> *</span>
<span class="cm"> * This function will update the firmware on the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	count on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_store_update_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ucode_image_header</span> <span class="o">*</span><span class="n">image_hdr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">fname</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">dnld_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">fname</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware file %s not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">image_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ucode_image_header</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">image_hdr</span> <span class="o">+</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">image_hdr</span><span class="o">-&gt;</span><span class="n">header_length</span><span class="p">);</span>
	<span class="n">dnld_size</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">image_hdr</span><span class="o">-&gt;</span><span class="n">header_length</span><span class="p">);</span>
	<span class="n">sglist</span> <span class="o">=</span> <span class="n">ipr_alloc_ucode_buffer</span><span class="p">(</span><span class="n">dnld_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sglist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Microcode buffer allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ipr_copy_ucode_buffer</span><span class="p">(</span><span class="n">sglist</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dnld_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Microcode buffer copy to DMA buffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_info</span><span class="p">(</span><span class="s">&quot;Updating microcode, please be patient.  This may take up to 30 minutes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ipr_update_ioa_ucode</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">sglist</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">ipr_free_ucode_buffer</span><span class="p">(</span><span class="n">sglist</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_update_fw_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;update_fw&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">ipr_store_update_fw</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_show_fw_type - Show the adapter&#39;s firmware type.</span>
<span class="cm"> * @dev:	class device struct</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_show_fw_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_ioa_fw_type_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;fw_type&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ipr_show_fw_type</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">ipr_ioa_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">ipr_fw_version_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ipr_log_level_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ipr_diagnostics_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ipr_ioa_state_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ipr_ioa_reset_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ipr_update_fw_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ipr_ioa_fw_type_attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SCSI_IPR_DUMP</span>
<span class="cm">/**</span>
<span class="cm"> * ipr_read_dump - Dump the adapter</span>
<span class="cm"> * @filp:		open sysfs file</span>
<span class="cm"> * @kobj:		kobject struct</span>
<span class="cm"> * @bin_attr:		bin_attribute struct</span>
<span class="cm"> * @buf:		buffer</span>
<span class="cm"> * @off:		offset</span>
<span class="cm"> * @count:		buffer size</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_read_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_dump</span> <span class="o">*</span><span class="n">dump</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">sdt_end</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">dump</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">!=</span> <span class="n">DUMP_OBTAINED</span> <span class="o">||</span> <span class="o">!</span><span class="n">dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">ipr_release_dump</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">)</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">off</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">driver_dump</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">sdt_end</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_dump</span><span class="p">,</span> <span class="n">sdt</span><span class="p">.</span><span class="n">entry</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span><span class="p">.</span><span class="n">sdt</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">num_entries_used</span><span class="p">)</span> <span class="o">*</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sdt_entry</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">sdt_end</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_dump</span><span class="p">,</span> <span class="n">sdt</span><span class="p">.</span><span class="n">entry</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">IPR_FMT2_NUM_SDT_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_sdt_entry</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">sdt_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">sdt_end</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sdt_end</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">off</span> <span class="o">-=</span> <span class="n">sdt_end</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">off</span><span class="p">)</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span><span class="p">.</span><span class="n">ioa_data</span><span class="p">[(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">];</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">ipr_release_dump</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_alloc_dump - Prepare for adapter dump</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	0 on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_alloc_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_dump</span> <span class="o">*</span><span class="n">dump</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">**</span><span class="n">ioa_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dump</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dump</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Dump memory allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">ioa_data</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">IPR_FMT3_MAX_NUM_DUMP_PAGES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">ioa_data</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">IPR_FMT2_MAX_NUM_DUMP_PAGES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;Dump memory allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dump</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span><span class="p">.</span><span class="n">ioa_data</span> <span class="o">=</span> <span class="n">ioa_data</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INACTIVE</span> <span class="o">!=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">ioa_dump</span><span class="p">.</span><span class="n">ioa_data</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dump</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump</span> <span class="o">=</span> <span class="n">dump</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_DUMP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump_taken</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump_taken</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">work_q</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_free_dump - Free adapter dump memory</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	0 on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_free_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_dump</span> <span class="o">*</span><span class="n">dump</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">dump</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dump</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">ipr_release_dump</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_write_dump - Setup dump state of adapter</span>
<span class="cm"> * @filp:		open sysfs file</span>
<span class="cm"> * @kobj:		kobject struct</span>
<span class="cm"> * @bin_attr:		bin_attribute struct</span>
<span class="cm"> * @buf:		buffer</span>
<span class="cm"> * @off:		offset</span>
<span class="cm"> * @count:		buffer size</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_write_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_alloc_dump</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_free_dump</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">ipr_dump_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span>	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dump&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ipr_read_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ipr_write_dump</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_free_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_change_queue_depth - Change the device&#39;s queue depth</span>
<span class="cm"> * @sdev:	scsi device struct</span>
<span class="cm"> * @qdepth:	depth to set</span>
<span class="cm"> * @reason:	calling context</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	actual depth set</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qdepth</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">ipr_is_gata</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">qdepth</span> <span class="o">&gt;</span> <span class="n">IPR_MAX_CMD_PER_ATA_LUN</span><span class="p">)</span>
		<span class="n">qdepth</span> <span class="o">=</span> <span class="n">IPR_MAX_CMD_PER_ATA_LUN</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">scsi_get_tag_type</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span> <span class="n">qdepth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_change_queue_type - Change the device&#39;s queue type</span>
<span class="cm"> * @dsev:		scsi device struct</span>
<span class="cm"> * @tag_type:	type of tags to use</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	actual queue type set</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_change_queue_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_gscsi</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We don&#39;t bother quiescing the device here since the</span>
<span class="cm">			 * adapter firmware does it for us.</span>
<span class="cm">			 */</span>
			<span class="n">scsi_set_tag_type</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">tag_type</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tag_type</span><span class="p">)</span>
				<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">scsi_deactivate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">tag_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tag_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tag_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_show_adapter_handle - Show the adapter&#39;s resource handle for this device</span>
<span class="cm"> * @dev:	device struct</span>
<span class="cm"> * @attr:	device attribute structure</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_show_adapter_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_adapter_handle_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> 	<span class="s">&quot;adapter_handle&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ipr_show_adapter_handle</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_show_resource_path - Show the resource path or the resource address for</span>
<span class="cm"> *			    this device.</span>
<span class="cm"> * @dev:	device struct</span>
<span class="cm"> * @attr:	device attribute structure</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_show_resource_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IPR_MAX_RES_PATH_LENGTH</span><span class="p">];</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
						   <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d:%d:%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			       <span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_resource_path_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> 	<span class="s">&quot;resource_path&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ipr_show_resource_path</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_show_device_id - Show the device_id for this device.</span>
<span class="cm"> * @dev:	device struct</span>
<span class="cm"> * @attr:	device attribute structure</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_show_device_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">lun_wwn</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_device_id_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;device_id&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ipr_show_device_id</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_show_resource_type - Show the resource type for this device.</span>
<span class="cm"> * @dev:	device struct</span>
<span class="cm"> * @attr:	device attribute structure</span>
<span class="cm"> * @buf:	buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	number of bytes printed to buffer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ipr_show_resource_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">to_scsi_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ipr_resource_type_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;resource_type&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ipr_show_resource_type</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">ipr_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">ipr_adapter_handle_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ipr_resource_path_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ipr_device_id_attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ipr_resource_type_attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_biosparam - Return the HSC mapping</span>
<span class="cm"> * @sdev:			scsi device struct</span>
<span class="cm"> * @block_device:	block device pointer</span>
<span class="cm"> * @capacity:		capacity of the device</span>
<span class="cm"> * @parm:			Array containing returned HSC values.</span>
<span class="cm"> *</span>
<span class="cm"> * This function generates the HSC parms that fdisk uses.</span>
<span class="cm"> * We want to make sure we return something that places partitions</span>
<span class="cm"> * on 4k boundaries for best performance with the IOA.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">block_device</span><span class="p">,</span>
			 <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">heads</span><span class="p">,</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="n">heads</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">cylinders</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">cylinders</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>

	<span class="cm">/* return result */</span>
	<span class="n">parm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">parm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">parm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_find_starget - Find target based on bus/target.</span>
<span class="cm"> * @starget:	scsi target struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	resource entry pointer if found / NULL if not found</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="nf">ipr_find_starget</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">==</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">sata_port_info</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_target_alloc - Prepare for commands to a SCSI target</span>
<span class="cm"> * @starget:	scsi target struct</span>
<span class="cm"> *</span>
<span class="cm"> * If the device is a SATA device, this function allocates an</span>
<span class="cm"> * ATA port with libata, else it does nothing.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / non-0 on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_target_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ipr_find_starget</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>
	<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">ipr_is_gata</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">sata_port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sata_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sata_port</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ap</span> <span class="o">=</span> <span class="n">ata_sas_port_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ata_host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sata_port_info</span><span class="p">,</span> <span class="n">shost</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
			<span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="p">;</span>
			<span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="p">;</span>
			<span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

			<span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span> <span class="o">=</span> <span class="n">sata_port</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">sata_port</span><span class="p">;</span>
			<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">sata_port</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sata_port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_target_destroy - Destroy a SCSI target</span>
<span class="cm"> * @starget:	scsi target struct</span>
<span class="cm"> *</span>
<span class="cm"> * If the device was a SATA device, this function frees the libata</span>
<span class="cm"> * ATA port, else it does nothing.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_target_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_find_starget</span><span class="p">(</span><span class="n">starget</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">IPR_ARRAY_VIRTUAL_BUS</span><span class="p">)</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">array_ids</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">IPR_VSET_VIRTUAL_BUS</span><span class="p">)</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vset_ids</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">target_ids</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sata_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ata_sas_port_destroy</span><span class="p">(</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sata_port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_find_sdev - Find device based on bus/target/lun.</span>
<span class="cm"> * @sdev:	scsi device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	resource entry pointer if found / NULL if not found</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="nf">ipr_find_sdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">==</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">==</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_slave_destroy - Unconfigure a SCSI device</span>
<span class="cm"> * @sdev:	scsi device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">class</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_slave_configure - Configure a SCSI device</span>
<span class="cm"> * @sdev:	scsi device struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function configures the specified scsi device.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">IPR_MAX_RES_PATH_LENGTH</span><span class="p">];</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_af_dasd_device</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_RAID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_af_dasd_device</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipr_is_ioa_resource</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_vset_device</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">blk_queue_rq_timeout</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span>
					     <span class="n">IPR_VSET_RW_TIMEOUT</span><span class="p">);</span>
			<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="n">IPR_VSET_MAX_SECTORS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_gata</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="p">)</span>
			<span class="n">ap</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_MAX_CMD_PER_ATA_LUN</span><span class="p">);</span>
			<span class="n">ata_sas_slave_configure</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
			<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;Resource path: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ipr_format_res_path</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ata_slave_alloc - Prepare for commands to a SATA device</span>
<span class="cm"> * @sdev:	scsi device struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function initializes an ATA port so that future commands</span>
<span class="cm"> * sent through queuecommand will work.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ata_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">)</span>
		<span class="n">sata_port</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sata_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_sas_port_init</span><span class="p">(</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_sas_sync_probe</span><span class="p">(</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">ipr_slave_destroy</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_slave_alloc - Prepare for commands to a device.</span>
<span class="cm"> * @sdev:	scsi device struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function saves a pointer to the resource entry</span>
<span class="cm"> * in the scsi device struct if the device exists. We</span>
<span class="cm"> * can then use this pointer in ipr_queuecommand when</span>
<span class="cm"> * handling new commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / -ENXIO if device does not exist</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ipr_find_sdev</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">add_to_ml</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">in_erp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_naca_model</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_gata</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ipr_ata_slave_alloc</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_eh_host_reset - Reset the host adapter</span>
<span class="cm"> * @scsi_cmd:	scsi command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	SUCCESS / FAILED</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ipr_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsi_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Adapter being reset as a result of error recovery.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_DUMP</span> <span class="o">==</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">GET_DUMP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_reset_reload</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_ABBREV</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__ipr_eh_host_reset</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_device_reset - Reset the device</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @res:		resource entry struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function issues a device reset to the affected device.</span>
<span class="cm"> * If the device is a SCSI device, a LUN reset will be sent</span>
<span class="cm"> * to the device first. If that does not work, a target reset</span>
<span class="cm"> * will be sent. If the device is a SATA device, a PHY reset will</span>
<span class="cm"> * be sent.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	0 on success / non-zero on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_cmd_pkt</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb_ata_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">ipr_get_free_ipr_cmnd</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="n">cmd_pkt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ata_ioadl</span><span class="p">.</span><span class="n">regs</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">add_cmd_parms_offset</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioarcb</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">add_data</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_RESET_DEVICE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_gata</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_ATA_PHY_RESET</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">add_cmd_parms_len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPR_ATA_FLAG_STATUS_ON_GOOD_COMPLETION</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_send_blocking_cmd</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_DEVICE_RESET_TIMEOUT</span><span class="p">);</span>
	<span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_gata</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span> <span class="o">&amp;&amp;</span> <span class="n">ioasc</span> <span class="o">!=</span> <span class="n">IPR_IOASC_IOA_WAS_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioasa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa64</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gata</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioasa_gata</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioasa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gata</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioasa_gata</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_sata_reset - Reset the SATA port</span>
<span class="cm"> * @link:	SATA link to reset</span>
<span class="cm"> * @classes:	class of the attached device</span>
<span class="cm"> *</span>
<span class="cm"> * This function issues a SATA phy reset to the affected ATA link.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	0 on success / non-zero on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_sata_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">classes</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_device_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="o">*</span><span class="n">classes</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ata_class</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_eh_dev_reset - Reset the device</span>
<span class="cm"> * @scsi_cmd:	scsi command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function issues a device reset to the affected device.</span>
<span class="cm"> * A LUN reset will be sent to the device first. If that does</span>
<span class="cm"> * not work, a target reset will be sent.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	SUCCESS / FAILED</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ipr_eh_dev_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsi_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are currently going through reset/reload, return failed. This will force the</span>
<span class="cm">	 * mid-layer to call ipr_eh_host_reset, which will then go to sleep and wait for the</span>
<span class="cm">	 * reset to complete</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">)</span>
				<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_scsi_eh_done</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span><span class="p">)</span>
				<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_sata_eh_done</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_TIMEOUT</span><span class="p">;</span>
				<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">resetting_device</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">scsi_cmd</span><span class="p">,</span> <span class="s">&quot;Resetting device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_gata</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ata_std_error_handler</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_device_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">resetting_device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">?</span> <span class="n">FAILED</span> <span class="o">:</span> <span class="n">SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_eh_dev_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__ipr_eh_dev_reset</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_bus_reset_done - Op done function for bus reset.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the op done function for a bus reset</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_bus_reset_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">==</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scsi_report_bus_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If abort has not completed, indicate the reset has, else call the</span>
<span class="cm">	 * abort&#39;s done function to wake the sleeping eh thread</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_abort_timeout - An abort task has timed out</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function handles when an abort task times out. If this</span>
<span class="cm"> * happens we issue a bus reset since we have resources tied</span>
<span class="cm"> * up that must be freed before returning to the midlayer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_abort_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">reset_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_cmd_pkt</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">done</span> <span class="o">||</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;Abort timed out. Resetting bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">reset_cmd</span> <span class="o">=</span> <span class="n">ipr_get_free_ipr_cmnd</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">reset_cmd</span><span class="p">;</span>
	<span class="n">reset_cmd</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="n">reset_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span><span class="p">;</span>
	<span class="n">cmd_pkt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reset_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_RESET_DEVICE</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_RESET_TYPE_SELECT</span> <span class="o">|</span> <span class="n">IPR_BUS_RESET</span><span class="p">;</span>

	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">reset_cmd</span><span class="p">,</span> <span class="n">ipr_bus_reset_done</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_DEVICE_RESET_TIMEOUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_cancel_op - Cancel specified op</span>
<span class="cm"> * @scsi_cmd:	scsi command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function cancels specified op.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	SUCCESS / FAILED</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_cancel_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsi_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_cmd_pkt</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span><span class="p">,</span> <span class="n">int_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="cm">/* If we are currently going through reset/reload, return failed.</span>
<span class="cm">	 * This will force the mid-layer to call ipr_eh_host_reset,</span>
<span class="cm">	 * which will then go to sleep and wait for the reset to complete</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span> <span class="o">||</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are aborting a timed out op, chances are that the timeout was caused</span>
<span class="cm">	 * by a still not detected EEH error. In such cases, reading a register will</span>
<span class="cm">	 * trigger the EEH recovery infrastructure.</span>
<span class="cm">	 */</span>
	<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_gscsi</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">==</span> <span class="n">scsi_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_scsi_eh_done</span><span class="p">;</span>
			<span class="n">op_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op_found</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">ipr_get_free_ipr_cmnd</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">;</span>
	<span class="n">cmd_pkt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_CANCEL_ALL_REQUESTS</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">scsi_cmd</span><span class="p">,</span> <span class="s">&quot;Aborting command: %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">ipr_send_blocking_cmd</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_abort_timeout</span><span class="p">,</span> <span class="n">IPR_CANCEL_ALL_TIMEOUT</span><span class="p">);</span>
	<span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the abort task timed out and we sent a bus reset, we will get</span>
<span class="cm">	 * one the following responses to the abort</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_BUS_WAS_RESET</span> <span class="o">||</span> <span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_SYNC_REQUIRED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioasc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ipr_trace</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_naca_model</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">?</span> <span class="n">FAILED</span> <span class="o">:</span> <span class="n">SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_eh_abort - Abort a single op</span>
<span class="cm"> * @scsi_cmd:	scsi command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	SUCCESS / FAILED</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">scsi_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_cancel_op</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_handle_other_interrupt - Handle &quot;other&quot; interrupts</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @int_reg:	interrupt register</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IRQ_NONE / IRQ_HANDLED</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ipr_handle_other_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">int_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_mask_reg</span><span class="p">;</span>

	<span class="n">int_mask_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_mask_reg32</span><span class="p">);</span>
	<span class="n">int_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">int_mask_reg</span><span class="p">;</span>

	<span class="cm">/* If an interrupt on the adapter did not occur, ignore it.</span>
<span class="cm">	 * Or in the case of SIS 64, check for a stage change interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_OPER_INTERRUPTS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">int_mask_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_mask_reg</span><span class="p">);</span>
			<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">int_mask_reg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_IPL_STAGE_CHANGE</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* clear stage change */</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_IPL_STAGE_CHANGE</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_reg</span><span class="p">);</span>
				<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">int_mask_reg</span><span class="p">;</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
				<span class="n">ipr_reset_ioa_job</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_IOA_TRANS_TO_OPER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mask the interrupt */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_IOA_TRANS_TO_OPER</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_interrupt_mask_reg</span><span class="p">);</span>

		<span class="cm">/* Clear the interrupt */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_IOA_TRANS_TO_OPER</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_reg</span><span class="p">);</span>
		<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">ipr_reset_ioa_job</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_HRRQ_UPDATED</span><span class="p">)</span> <span class="o">==</span> <span class="n">int_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">clear_isr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipr_debug</span> <span class="o">&amp;&amp;</span> <span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Spurious interrupt detected. 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">int_reg</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_HRRQ_UPDATED</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_reg32</span><span class="p">);</span>
			<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg32</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_IOA_UNIT_CHECKED</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_unit_checked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Permanent IOA failure. 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">int_reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_DUMP</span> <span class="o">==</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">GET_DUMP</span><span class="p">;</span>

		<span class="n">ipr_mask_and_clear_interrupts</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_isr_eh - Interrupt service routine error handler</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @msg:	message to log</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_isr_eh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">errors_logged</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_DUMP</span> <span class="o">==</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">GET_DUMP</span><span class="p">;</span>

	<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_isr - Interrupt service routine</span>
<span class="cm"> * @irq:	irq number</span>
<span class="cm"> * @devp:	pointer to ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IRQ_NONE / IRQ_HANDLED</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ipr_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">devp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_hrrq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_none</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="cm">/* If interrupts are disabled, ignore the interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_interrupts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_curr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPR_HRRQ_TOGGLE_BIT</span><span class="p">)</span> <span class="o">==</span>
		       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">toggle_bit</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">cmd_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_curr</span><span class="p">)</span> <span class="o">&amp;</span>
				     <span class="n">IPR_HRRQ_REQ_RESP_HANDLE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IPR_HRRQ_REQ_RESP_HANDLE_SHIFT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmd_index</span> <span class="o">&gt;=</span> <span class="n">IPR_NUM_CMD_BLKS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ipr_isr_eh</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="s">&quot;Invalid response handle from IOA&quot;</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list</span><span class="p">[</span><span class="n">cmd_index</span><span class="p">];</span>

			<span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

			<span class="n">ipr_trc_hook</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_TRACE_FINISH</span><span class="p">,</span> <span class="n">ioasc</span><span class="p">);</span>

			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_curr</span> <span class="o">&lt;</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_end</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_curr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_curr</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_start</span><span class="p">;</span>
				<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">toggle_bit</span> <span class="o">^=</span> <span class="mi">1u</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">clear_isr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Clear the PCI interrupt */</span>
			<span class="n">num_hrrq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_HRRQ_UPDATED</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_reg32</span><span class="p">);</span>
				<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg32</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_HRRQ_UPDATED</span> <span class="o">&amp;&amp;</span>
					<span class="n">num_hrrq</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">IPR_MAX_HRRQ_RETRIES</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IRQ_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">irq_none</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg32</span><span class="p">);</span>
			<span class="n">irq_none</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">num_hrrq</span> <span class="o">==</span> <span class="n">IPR_MAX_HRRQ_RETRIES</span> <span class="o">&amp;&amp;</span>
			   <span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_HRRQ_UPDATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipr_isr_eh</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="s">&quot;Error clearing HRRQ&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IRQ_NONE</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_handle_other_interrupt</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">int_reg</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_build_ioadl64 - Build a scatter/gather list and map the buffer</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / -1 on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_build_ioadl64</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioadl_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span> <span class="o">*</span><span class="n">ioadl64</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ioadl64</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci_map_sg failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span> <span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioadl_len</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl_flags</span> <span class="o">=</span> <span class="n">IPR_IOADL_FLAGS_WRITE</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_WRITE_NOT_READ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
		<span class="n">ioadl_flags</span> <span class="o">=</span> <span class="n">IPR_IOADL_FLAGS_READ</span><span class="p">;</span>

	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ioadl_flags</span><span class="p">);</span>
		<span class="n">ioadl64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">ioadl64</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ioadl64</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOADL_FLAGS_LAST</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_build_ioadl - Build a scatter/gather list and map the buffer</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / -1 on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_build_ioadl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioadl_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl_desc</span> <span class="o">*</span><span class="n">ioadl</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ioadl</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci_map_sg failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span> <span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl_flags</span> <span class="o">=</span> <span class="n">IPR_IOADL_FLAGS_WRITE</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_WRITE_NOT_READ</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioadl_len</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl_flags</span> <span class="o">=</span> <span class="n">IPR_IOADL_FLAGS_READ</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_ioadl_len</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span> <span class="o">&lt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">add_data</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ioadl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioadl</span> <span class="o">=</span> <span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">add_data</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ioadl</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">write_ioadl_addr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioarcb</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">add_data</span><span class="p">));</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_ioadl_addr</span> <span class="o">=</span> <span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">write_ioadl_addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags_and_data_len</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ioadl_flags</span> <span class="o">|</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">ioadl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ioadl</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags_and_data_len</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOADL_FLAGS_LAST</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_task_attributes - Translate SPI Q-Tag to task attributes</span>
<span class="cm"> * @scsi_cmd:	scsi command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	task attributes</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ipr_get_task_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_FLAGS_LO_UNTAGGED_TASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MSG_SIMPLE_TAG</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_FLAGS_LO_SIMPLE_TASK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MSG_HEAD_TAG</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_FLAGS_LO_HEAD_OF_Q_TASK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MSG_ORDERED_TAG</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_FLAGS_LO_ORDERED_TASK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_erp_done - Process completion of ERP for a device</span>
<span class="cm"> * @ipr_cmd:		ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function copies the sense buffer into the scsi_cmd</span>
<span class="cm"> * struct and pushes the scsi_done function.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_erp_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">scmd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">scsi_cmd</span><span class="p">,</span>
			    <span class="s">&quot;Request Sense failed with IOASC: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioasc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
		       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_naca_model</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">in_erp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reinit_ipr_cmnd_for_erp - Re-initialize a cmnd block to be used for ERP</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_reinit_ipr_cmnd_for_erp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioasa</span> <span class="o">*</span><span class="n">ioasa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmd_pkt</span><span class="p">));</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_data_transfer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioadl_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_ioadl_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">residual_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sis64_addr_data</span><span class="p">.</span><span class="n">data_ioadl_addr</span> <span class="o">=</span>
			<span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">ioadl64</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">write_ioadl_addr</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">ioadl</span><span class="p">));</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_ioadl_addr</span> <span class="o">=</span> <span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">write_ioadl_addr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_erp_request_sense - Send request sense to a device</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends a request sense to a device as a result</span>
<span class="cm"> * of a check condition.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_erp_request_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmd_pkt</span> <span class="o">*</span><span class="n">cmd_pkt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_erp_done</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_reinit_ipr_cmnd_for_erp</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>

	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_SCSICDB</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SENSE</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_SYNC_OVERRIDE</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_NO_ULEN_CHK</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">IPR_REQUEST_SENSE_TIMEOUT</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">ipr_init_ioadl</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer_dma</span><span class="p">,</span>
		       <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">IPR_IOADL_FLAGS_READ_LAST</span><span class="p">);</span>

	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_erp_done</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span>
		   <span class="n">IPR_REQUEST_SENSE_TIMEOUT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_erp_cancel_all - Send cancel all to a device</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends a cancel all to a device to clear the</span>
<span class="cm"> * queue. If we are running TCQ on the device, QERR is set to 1,</span>
<span class="cm"> * which means all outstanding ops have been dropped on the floor.</span>
<span class="cm"> * Cancel all will return them to us.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_erp_cancel_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_cmd_pkt</span> <span class="o">*</span><span class="n">cmd_pkt</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">in_erp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ipr_reinit_ipr_cmnd_for_erp</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_get_tag_type</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipr_erp_request_sense</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd_pkt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>
	<span class="n">cmd_pkt</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_CANCEL_ALL_REQUESTS</span><span class="p">;</span>

	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_erp_request_sense</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span>
		   <span class="n">IPR_CANCEL_ALL_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_dump_ioasa - Dump contents of IOASA</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @res:		resource entry struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is invoked by the interrupt handler when ops</span>
<span class="cm"> * fail. It will log the IOASA if appropriate. Only called</span>
<span class="cm"> * for GPDD ops.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_dump_ioasa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span><span class="p">,</span> <span class="n">fd_ioasc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioasa</span> <span class="o">*</span><span class="n">ioasa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">ioasa_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">ioasa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error_index</span><span class="p">;</span>

	<span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPR_IOASC_IOASC_MASK</span><span class="p">;</span>
	<span class="n">fd_ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">fd_ioasc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPR_IOASC_IOASC_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">ioasc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="n">IPR_DEFAULT_LOG_LEVEL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_BUS_WAS_RESET</span> <span class="o">&amp;&amp;</span> <span class="n">fd_ioasc</span><span class="p">)</span>
		<span class="n">error_index</span> <span class="o">=</span> <span class="n">ipr_get_error</span><span class="p">(</span><span class="n">fd_ioasc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">error_index</span> <span class="o">=</span> <span class="n">ipr_get_error</span><span class="p">(</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">log_level</span> <span class="o">&lt;</span> <span class="n">IPR_MAX_LOG_LEVEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t log an error if the IOA already logged one */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ilid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_gscsi</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_error_table</span><span class="p">[</span><span class="n">error_index</span><span class="p">].</span><span class="n">log_ioasa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_res_err</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ipr_error_table</span><span class="p">[</span><span class="n">error_index</span><span class="p">].</span><span class="n">error</span><span class="p">);</span>

	<span class="n">data_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ret_stat_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span> <span class="o">&amp;&amp;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioasa64</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">)</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioasa64</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span> <span class="o">&amp;&amp;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioasa</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">)</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioasa</span><span class="p">);</span>

	<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;IOASA Dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_err</span><span class="p">(</span><span class="s">&quot;%08X: %08X %08X %08X %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa_data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]),</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_gen_sense - Generate SCSI sense data from an IOASA</span>
<span class="cm"> * @ioasa:		IOASA</span>
<span class="cm"> * @sense_buf:	sense data buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_gen_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">failing_lba</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">sense_buf</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioasa</span> <span class="o">*</span><span class="n">ioasa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sense_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">&gt;=</span> <span class="n">IPR_FIRST_DRIVER_IOASC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_vset_device</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_MED_DO_NOT_REALLOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vset</span><span class="p">.</span><span class="n">failing_lba_hi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x72</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">);</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_IOASC_SENSE_CODE</span><span class="p">(</span><span class="n">ioasc</span><span class="p">);</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_IOASC_SENSE_QUAL</span><span class="p">(</span><span class="n">ioasc</span><span class="p">);</span>

		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

		<span class="n">failing_lba</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vset</span><span class="p">.</span><span class="n">failing_lba_hi</span><span class="p">);</span>

		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">;</span>

		<span class="n">failing_lba</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vset</span><span class="p">.</span><span class="n">failing_lba_lo</span><span class="p">);</span>

		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">);</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_IOASC_SENSE_CODE</span><span class="p">(</span><span class="n">ioasc</span><span class="p">);</span>
		<span class="n">sense_buf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_IOASC_SENSE_QUAL</span><span class="p">(</span><span class="n">ioasc</span><span class="p">);</span>

		<span class="cm">/* Illegal request */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x05</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc_specific</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPR_FIELD_POINTER_VALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sense_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* additional length */</span>

			<span class="cm">/* IOARCB was in error */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IPR_IOASC_SENSE_CODE</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x24</span><span class="p">)</span>
				<span class="n">sense_buf</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
			<span class="k">else</span>	<span class="cm">/* Parameter data was invalid */</span>
				<span class="n">sense_buf</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

			<span class="n">sense_buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">IPR_FIELD_POINTER_MASK</span> <span class="o">&amp;</span>
			      <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc_specific</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">sense_buf</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">IPR_FIELD_POINTER_MASK</span> <span class="o">&amp;</span>
			     <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc_specific</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_MED_DO_NOT_REALLOC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_vset_device</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
					<span class="n">failing_lba</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vset</span><span class="p">.</span><span class="n">failing_lba_lo</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">failing_lba</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">dasd</span><span class="p">.</span><span class="n">failing_lba</span><span class="p">);</span>

				<span class="n">sense_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* Or in the Valid bit */</span>
				<span class="n">sense_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
				<span class="n">sense_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">sense_buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">sense_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">failing_lba</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sense_buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* additional length */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_autosense - Copy autosense data to sense buffer</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function copies the autosense buffer to the buffer</span>
<span class="cm"> * in the scsi_cmd, if there is autosense available.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	1 if autosense was available / 0 if not</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_get_autosense</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioasa</span> <span class="o">*</span><span class="n">ioasa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioasa64</span> <span class="o">*</span><span class="n">ioasa64</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc_specific</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPR_AUTOSENSE_VALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">ioasa64</span><span class="o">-&gt;</span><span class="n">auto_sense</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ioasa64</span><span class="o">-&gt;</span><span class="n">auto_sense</span><span class="p">.</span><span class="n">auto_sense_len</span><span class="p">),</span>
			   <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">auto_sense</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ioasa</span><span class="o">-&gt;</span><span class="n">auto_sense</span><span class="p">.</span><span class="n">auto_sense_len</span><span class="p">),</span>
			   <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_erp_start - Process an error response for a SCSI op</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function determines whether or not to initiate ERP</span>
<span class="cm"> * on the affected device.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_erp_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">masked_ioasc</span> <span class="o">=</span> <span class="n">ioasc</span> <span class="o">&amp;</span> <span class="n">IPR_IOASC_IOASC_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_scsi_eh_done</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_gscsi</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">masked_ioasc</span> <span class="o">!=</span> <span class="n">IPR_IOASC_HW_DEV_BUS_STATUS</span><span class="p">)</span>
		<span class="n">ipr_gen_sense</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>

	<span class="n">ipr_dump_ioasa</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">masked_ioasc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPR_IOASC_ABORTED_CMD_TERM_BY_HOST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_naca_model</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_IMM_RETRY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_IOASC_IR_RESOURCE_HANDLE</span>:
	<span class="k">case</span> <span class="n">IPR_IOASC_IR_NO_CMDS_TO_2ND_IOA</span>:
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_IOASC_HW_SEL_TIMEOUT</span>:
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_naca_model</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_IOASC_SYNC_REQUIRED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">in_erp</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_IMM_RETRY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_IOASC_MED_DO_NOT_REALLOC</span>: <span class="cm">/* prevent retries */</span>
	<span class="k">case</span> <span class="n">IPR_IOASA_IR_DUAL_IOA_DISABLED</span>:
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_PASSTHROUGH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_IOASC_BUS_WAS_RESET</span>:
	<span class="k">case</span> <span class="n">IPR_IOASC_BUS_WAS_RESET_BY_OTHER</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Report the bus reset and ask for a retry. The device</span>
<span class="cm">		 * will give CC/UA the next command.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">resetting_device</span><span class="p">)</span>
			<span class="n">scsi_report_bus_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_naca_model</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_IOASC_HW_DEV_BUS_STATUS</span>:
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="n">IPR_IOASC_SENSE_STATUS</span><span class="p">(</span><span class="n">ioasc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IPR_IOASC_SENSE_STATUS</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_get_autosense</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_naca_model</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ipr_erp_cancel_all</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_naca_model</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPR_IOASC_NR_INIT_CMD_REQUIRED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RECOVERED_ERROR</span><span class="p">)</span>
			<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_vset_device</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipr_is_naca_model</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_scsi_done - mid-layer done function</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is invoked by the interrupt handler for</span>
<span class="cm"> * ops generated by the SCSI mid-layer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_scsi_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">residual_data_len</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ipr_erp_start</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_queuecommand - Queue a mid-layer request</span>
<span class="cm"> * @scsi_cmd:	scsi command struct</span>
<span class="cm"> * @done:		done function</span>
<span class="cm"> *</span>
<span class="cm"> * This function queues a request generated by the mid-layer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> *	SCSI_MLQUEUE_DEVICE_BUSY if device is busy</span>
<span class="cm"> *	SCSI_MLQUEUE_HOST_BUSY if host is busy</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsi_cmd</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are currently blocking all devices due to a host reset</span>
<span class="cm">	 * We have told the host to stop giving us new requests, but</span>
<span class="cm">	 * ERP ops don&#39;t count. FIXME</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME - Create scsi_set_host_offline interface</span>
<span class="cm">	 *  and the ioa_is_dead check can be removed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span> <span class="o">||</span> <span class="o">!</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_gata</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ata_sas_queuecmd</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">ipr_get_free_ipr_cmnd</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">,</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_scsi_done</span><span class="p">;</span>
	<span class="n">ipr_trc_hook</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_TRACE_START</span><span class="p">,</span> <span class="n">IPR_GET_RES_PHYS_LOC</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_gscsi</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipr_is_vset_device</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">underflow</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_NO_ULEN_CHK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_SYNC_COMPLETE</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">needs_sync_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_NO_LINK_DESC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_gscsi</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_lo</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_LO_DELAY_AFTER_RST</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_lo</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_LO_ALIGNED_BFR</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_lo</span> <span class="o">|=</span> <span class="n">ipr_get_task_attributes</span><span class="p">(</span><span class="n">scsi_cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0xC0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_gscsi</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">||</span> <span class="n">scsi_cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">IPR_QUERY_RSRC_STATE</span><span class="p">))</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_build_ioadl64</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_build_ioadl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_send_command</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">ipr_queuecommand</span><span class="p">)</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioctl - IOCTL handler</span>
<span class="cm"> * @sdev:	scsi device struct</span>
<span class="cm"> * @cmd:	IOCTL cmd</span>
<span class="cm"> * @arg:	IOCTL arg</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ipr_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">ipr_is_gata</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">HDIO_GET_IDENTITY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ata_sas_scsi_ioctl</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_info - Get information about the card/driver</span>
<span class="cm"> * @scsi_host:	scsi host struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	pointer to buffer with description string</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">ipr_ioa_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IBM %X Storage Adapter&quot;</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IPR&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">ipr_ioa_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">ipr_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span> <span class="o">=</span> <span class="n">ipr_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span> <span class="o">=</span> <span class="n">ipr_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">ipr_eh_dev_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span> <span class="o">=</span> <span class="n">ipr_eh_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span> <span class="o">=</span> <span class="n">ipr_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span> <span class="o">=</span> <span class="n">ipr_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span> <span class="o">=</span> <span class="n">ipr_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span> <span class="o">=</span> <span class="n">ipr_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_destroy</span> <span class="o">=</span> <span class="n">ipr_target_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span> <span class="o">=</span> <span class="n">ipr_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_type</span> <span class="o">=</span> <span class="n">ipr_change_queue_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span> <span class="o">=</span> <span class="n">ipr_biosparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">IPR_MAX_COMMANDS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">IPR_MAX_SGLIST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">IPR_IOA_MAX_SECTORS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">IPR_MAX_CMD_PER_LUN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span> <span class="o">=</span> <span class="n">ipr_ioa_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sdev_attrs</span> <span class="o">=</span> <span class="n">ipr_dev_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span> <span class="o">=</span> <span class="n">IPR_NAME</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ata_phy_reset - libata phy_reset handler</span>
<span class="cm"> * @ap:		ata port to reset</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_ata_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_device_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">class</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">class</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ata_class</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">class</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ata_post_internal - Cleanup after an internal command</span>
<span class="cm"> * @qc:	ATA queued command</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_ata_post_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span> <span class="o">==</span> <span class="n">qc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipr_device_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_copy_sata_tf - Copy a SATA taskfile to an IOA data structure</span>
<span class="cm"> * @regs:	destination</span>
<span class="cm"> * @tf:	source ATA taskfile</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_copy_sata_tf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioarcb_ata_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nsect</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lbal</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lbam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lbah</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">hob_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_feature</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">hob_nsect</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">hob_lbal</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">hob_lbam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">hob_lbah</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_sata_done - done function for SATA commands</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is invoked by the interrupt handler for</span>
<span class="cm"> * ops generated by the SCSI mid-layer to SATA devices</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_sata_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioasa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa64</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gata</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioasa_gata</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioasa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">gata</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioasa_gata</span><span class="p">));</span>
	<span class="n">ipr_dump_ioasa</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc_specific</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IPR_ATA_DEVICE_WAS_RESET</span><span class="p">)</span>
		<span class="n">scsi_report_device_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RECOVERED_ERROR</span><span class="p">)</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">__ac_err_mask</span><span class="p">(</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioasa</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">ac_err_mask</span><span class="p">(</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioasa</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="n">ata_qc_complete</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_build_ata_ioadl64 - Build an ATA scatter/gather list</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @qc:		ATA queued command</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_build_ata_ioadl64</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ioadl_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span> <span class="o">*</span><span class="n">ioadl64</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ioadl64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span> <span class="o">*</span><span class="n">last_ioadl64</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">si</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dma_dir</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl_flags</span> <span class="o">=</span> <span class="n">IPR_IOADL_FLAGS_WRITE</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_WRITE_NOT_READ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dma_dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
		<span class="n">ioadl_flags</span> <span class="o">=</span> <span class="n">IPR_IOADL_FLAGS_READ</span><span class="p">;</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioadl_len</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl64_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">);</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sis64_addr_data</span><span class="p">.</span><span class="n">data_ioadl_addr</span> <span class="o">=</span>
		<span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">ata_ioadl</span><span class="p">));</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl64</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ioadl_flags</span><span class="p">);</span>
		<span class="n">ioadl64</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">ioadl64</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>

		<span class="n">last_ioadl64</span> <span class="o">=</span> <span class="n">ioadl64</span><span class="p">;</span>
		<span class="n">ioadl64</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">last_ioadl64</span><span class="p">))</span>
		<span class="n">last_ioadl64</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOADL_FLAGS_LAST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_build_ata_ioadl - Build an ATA scatter/gather list</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @qc:		ATA queued command</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_build_ata_ioadl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ioadl_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl_desc</span> <span class="o">*</span><span class="n">ioadl</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ioadl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioadl_desc</span> <span class="o">*</span><span class="n">last_ioadl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">si</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dma_dir</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl_flags</span> <span class="o">=</span> <span class="n">IPR_IOADL_FLAGS_WRITE</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_WRITE_NOT_READ</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioadl_len</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dma_dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl_flags</span> <span class="o">=</span> <span class="n">IPR_IOADL_FLAGS_READ</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_data_transfer_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_ioadl_len</span> <span class="o">=</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioadl_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioadl</span><span class="o">-&gt;</span><span class="n">flags_and_data_len</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">ioadl_flags</span> <span class="o">|</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">ioadl</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>

		<span class="n">last_ioadl</span> <span class="o">=</span> <span class="n">ioadl</span><span class="p">;</span>
		<span class="n">ioadl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">last_ioadl</span><span class="p">))</span>
		<span class="n">last_ioadl</span><span class="o">-&gt;</span><span class="n">flags_and_data_len</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOADL_FLAGS_LAST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_qc_issue - Issue a SATA qc to a device</span>
<span class="cm"> * @qc:	queued command</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 if success</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ipr_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb_ata_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span> <span class="o">||</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">AC_ERR_SYSTEM</span><span class="p">;</span>

	<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">ipr_get_free_ipr_cmnd</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ata_ioadl</span><span class="p">.</span><span class="n">regs</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">add_cmd_parms_offset</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioarcb</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">add_data</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">regs</span><span class="p">));</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">add_cmd_parms_len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">regs</span><span class="p">));</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_sata_done</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_ATA_PASSTHRU</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_NO_LINK_DESC</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_NO_ULEN_CHK</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_use_sg</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">ipr_build_ata_ioadl64</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ipr_build_ata_ioadl</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPR_ATA_FLAG_STATUS_ON_GOOD_COMPLETION</span><span class="p">;</span>
	<span class="n">ipr_copy_sata_tf</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">IPR_MAX_CDB_LEN</span><span class="p">);</span>
	<span class="n">ipr_trc_hook</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_TRACE_START</span><span class="p">,</span> <span class="n">IPR_GET_RES_PHYS_LOC</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATA_PROT_NODATA</span>:
	<span class="k">case</span> <span class="n">ATA_PROT_PIO</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATA_PROT_DMA</span>:
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPR_ATA_FLAG_XFER_TYPE_DMA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATAPI_PROT_PIO</span>:
	<span class="k">case</span> <span class="n">ATAPI_PROT_NODATA</span>:
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPR_ATA_FLAG_PACKET_CMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATAPI_PROT_DMA</span>:
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPR_ATA_FLAG_PACKET_CMD</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPR_ATA_FLAG_XFER_TYPE_DMA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AC_ERR_INVALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_send_command</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_qc_fill_rtf - Read result TF</span>
<span class="cm"> * @qc: ATA queued command</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	true</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ipr_qc_fill_rtf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_sata_port</span> <span class="o">*</span><span class="n">sata_port</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioasa_gata</span> <span class="o">*</span><span class="n">g</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sata_port</span><span class="o">-&gt;</span><span class="n">ioasa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">;</span>

	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">lbal</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">lbam</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">lbah</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">hob_nsect</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">hob_lbal</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">hob_lbam</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">hob_lbah</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">alt_status</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">ipr_sata_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">phy_reset</span> <span class="o">=</span> <span class="n">ipr_ata_phy_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardreset</span> <span class="o">=</span> <span class="n">ipr_sata_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_internal_cmd</span> <span class="o">=</span> <span class="n">ipr_ata_post_internal</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_prep</span> <span class="o">=</span> <span class="n">ata_noop_qc_prep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_issue</span> <span class="o">=</span> <span class="n">ipr_qc_issue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_fill_rtf</span> <span class="o">=</span> <span class="n">ipr_qc_fill_rtf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_start</span> <span class="o">=</span> <span class="n">ata_sas_port_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_stop</span> <span class="o">=</span> <span class="n">ata_sas_port_stop</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">sata_port_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ATA_FLAG_SATA</span> <span class="o">|</span> <span class="n">ATA_FLAG_PIO_DMA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4_ONLY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_sata_ops</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PPC_PSERIES</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">ipr_blocked_processors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PV_NORTHSTAR</span><span class="p">,</span>
	<span class="n">PV_PULSAR</span><span class="p">,</span>
	<span class="n">PV_POWER4</span><span class="p">,</span>
	<span class="n">PV_ICESTAR</span><span class="p">,</span>
	<span class="n">PV_SSTAR</span><span class="p">,</span>
	<span class="n">PV_POWER4p</span><span class="p">,</span>
	<span class="n">PV_630</span><span class="p">,</span>
	<span class="n">PV_630p</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_invalid_adapter - Determine if this adapter is supported on this hardware</span>
<span class="cm"> * @ioa_cfg:	ioa cfg struct</span>
<span class="cm"> *</span>
<span class="cm"> * Adapters that use Gemstone revision &lt; 3.1 do not work reliably on</span>
<span class="cm"> * certain pSeries hardware. This function determines if the given</span>
<span class="cm"> * adapter is in one of these confgurations or not.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	1 if adapter is not supported / 0 if adapter is supported</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_invalid_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mh">0x5702</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipr_blocked_processors</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__is_processor</span><span class="p">(</span><span class="n">ipr_blocked_processors</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ipr_invalid_adapter(ioa_cfg) 0</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioa_bringdown_done - IOA bring down completion.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function processes the completion of an adapter bring down.</span>
<span class="cm"> * It wakes any reset sleepers.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioa_bringdown_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioa_reset_done - IOA reset completion.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function processes the completion of an adapter reset.</span>
<span class="cm"> * It schedules any necessary mid-layer add/removes and</span>
<span class="cm"> * wakes any reset sleepers.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioa_reset_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">doorbell</span> <span class="o">|=</span> <span class="n">IPR_RUNTIME_RESET</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_ml_add_del</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">add_to_ml</span> <span class="o">||</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">del_from_ml</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ipr_trace</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">work_q</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">hostrcb</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_free_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">IPR_NUM_LOG_HCAMS</span><span class="p">)</span>
			<span class="n">ipr_send_hcam</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_HCAM_CDB_OP_CODE_LOG_DATA</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ipr_send_hcam</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_report_bus_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">IPR_VSET_BUS</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IOA initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span><span class="p">)</span>
		<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_set_sup_dev_dflt - Initialize a Set Supported Device buffer</span>
<span class="cm"> * @supported_dev:	supported device struct</span>
<span class="cm"> * @vpids:			vendor product id struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_set_sup_dev_dflt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_supported_device</span> <span class="o">*</span><span class="n">supported_dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ipr_std_inq_vpids</span> <span class="o">*</span><span class="n">vpids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">supported_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_supported_device</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">supported_dev</span><span class="o">-&gt;</span><span class="n">vpids</span><span class="p">,</span> <span class="n">vpids</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_std_inq_vpids</span><span class="p">));</span>
	<span class="n">supported_dev</span><span class="o">-&gt;</span><span class="n">num_records</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">supported_dev</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span>
		<span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_supported_device</span><span class="p">));</span>
	<span class="n">supported_dev</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_set_supported_devs - Send Set Supported Devices for a device</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends a Set Supported Devices to the adapter</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_set_supported_devs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_supported_device</span> <span class="o">*</span><span class="n">supp_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">supp_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">res</span><span class="p">;</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioa_reset_done</span><span class="p">;</span>

	<span class="n">list_for_each_entry_continue</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_is_scsi_disk</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">ipr_set_sup_dev_dflt</span><span class="p">(</span><span class="n">supp_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">std_inq_data</span><span class="p">.</span><span class="n">vpids</span><span class="p">);</span>

		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">);</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_WRITE_NOT_READ</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>

		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_SET_SUPPORTED_DEVICES</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_SET_ALL_SUPPORTED_DEVICES</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_supported_device</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_supported_device</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">ipr_init_ioadl</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span>
			       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span> <span class="o">+</span>
				 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">,</span> <span class="n">supp_dev</span><span class="p">),</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_supported_device</span><span class="p">),</span>
			       <span class="n">IPR_IOADL_FLAGS_WRITE_LAST</span><span class="p">);</span>

		<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span>
			   <span class="n">IPR_SET_SUP_DEVICE_TIMEOUT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_set_supported_devs</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_mode_page - Locate specified mode page</span>
<span class="cm"> * @mode_pages:	mode page buffer</span>
<span class="cm"> * @page_code:	page code to find</span>
<span class="cm"> * @len:		minimum required length for mode page</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	pointer to mode page / NULL on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ipr_get_mode_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_pages</span> <span class="o">*</span><span class="n">mode_pages</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">page_code</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_mode_page_hdr</span> <span class="o">*</span><span class="n">mode_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">page_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_pages</span> <span class="o">||</span> <span class="p">(</span><span class="n">mode_pages</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode_pages</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">mode_pages</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">block_desc_len</span><span class="p">;</span>
	<span class="n">mode_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_page_hdr</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">mode_pages</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">mode_pages</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">block_desc_len</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IPR_GET_MODE_PAGE_CODE</span><span class="p">(</span><span class="n">mode_hdr</span><span class="p">)</span> <span class="o">==</span> <span class="n">page_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode_hdr</span><span class="o">-&gt;</span><span class="n">page_length</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_page_hdr</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">mode_hdr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">page_length</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_page_hdr</span><span class="p">)</span> <span class="o">+</span>
				       <span class="n">mode_hdr</span><span class="o">-&gt;</span><span class="n">page_length</span><span class="p">);</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="n">page_length</span><span class="p">;</span>
			<span class="n">mode_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_page_hdr</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mode_hdr</span> <span class="o">+</span> <span class="n">page_length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_check_term_power - Check for term power errors</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @mode_pages:	IOAFP mode pages buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Check the IOAFP&#39;s mode page 28 for term power errors</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_check_term_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ipr_mode_pages</span> <span class="o">*</span><span class="n">mode_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_dev_bus_entry</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_mode_page28</span> <span class="o">*</span><span class="n">mode_page</span><span class="p">;</span>

	<span class="n">mode_page</span> <span class="o">=</span> <span class="n">ipr_get_mode_page</span><span class="p">(</span><span class="n">mode_pages</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_page28</span><span class="p">));</span>

	<span class="n">entry_length</span> <span class="o">=</span> <span class="n">mode_page</span><span class="o">-&gt;</span><span class="n">entry_length</span><span class="p">;</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">mode_page</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mode_page</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPR_SCSI_ATTR_NO_TERM_PWR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Term power is absent on scsi bus %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">res_addr</span><span class="p">.</span><span class="n">bus</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dev_bus_entry</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bus</span> <span class="o">+</span> <span class="n">entry_length</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_scsi_bus_speed_limit - Limit the SCSI speed based on SES table</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Looks through the config table checking for SES devices. If</span>
<span class="cm"> * the SES device is in the SES table indicating a maximum SCSI</span>
<span class="cm"> * bus speed, the speed is limited for the bus.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_scsi_bus_speed_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_xfer_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPR_MAX_NUM_BUSES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_xfer_rate</span> <span class="o">=</span> <span class="n">ipr_get_max_scsi_speed</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">bus_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_width</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_xfer_rate</span> <span class="o">&lt;</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">bus_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_xfer_rate</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">bus_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_xfer_rate</span> <span class="o">=</span> <span class="n">max_xfer_rate</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_modify_ioafp_mode_page_28 - Modify IOAFP Mode Page 28</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @mode_pages:	mode page 28 buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Updates mode page 28 based on driver configuration</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_modify_ioafp_mode_page_28</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
					  	<span class="k">struct</span> <span class="n">ipr_mode_pages</span> <span class="o">*</span><span class="n">mode_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_dev_bus_entry</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_bus_attributes</span> <span class="o">*</span><span class="n">bus_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_mode_page28</span> <span class="o">*</span><span class="n">mode_page</span><span class="p">;</span>

	<span class="n">mode_page</span> <span class="o">=</span> <span class="n">ipr_get_mode_page</span><span class="p">(</span><span class="n">mode_pages</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_page28</span><span class="p">));</span>

	<span class="n">entry_length</span> <span class="o">=</span> <span class="n">mode_page</span><span class="o">-&gt;</span><span class="n">entry_length</span><span class="p">;</span>

	<span class="cm">/* Loop for each device bus entry */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bus</span> <span class="o">=</span> <span class="n">mode_page</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mode_page</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_dev_bus_entry</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bus</span> <span class="o">+</span> <span class="n">entry_length</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">res_addr</span><span class="p">.</span><span class="n">bus</span> <span class="o">&gt;</span> <span class="n">IPR_MAX_NUM_BUSES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Invalid resource address reported: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">IPR_GET_PHYS_LOC</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">res_addr</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bus_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">bus_attr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">extended_reset_delay</span> <span class="o">=</span> <span class="n">IPR_EXTENDED_RESET_DELAY</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">=</span> <span class="n">bus_attr</span><span class="o">-&gt;</span><span class="n">bus_width</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_xfer_rate</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">bus_attr</span><span class="o">-&gt;</span><span class="n">max_xfer_rate</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPR_SCSI_ATTR_QAS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_attr</span><span class="o">-&gt;</span><span class="n">qas_enabled</span><span class="p">)</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPR_SCSI_ATTR_ENABLE_QAS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPR_SCSI_ATTR_DISABLE_QAS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_build_mode_select - Build a mode select command</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @res_handle:	resource handle to send command to</span>
<span class="cm"> * @parm:		Byte 2 of Mode Sense command</span>
<span class="cm"> * @dma_addr:	DMA buffer address</span>
<span class="cm"> * @xfer_len:	data transfer length</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_build_mode_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
				  <span class="n">__be32</span> <span class="n">res_handle</span><span class="p">,</span> <span class="n">u8</span> <span class="n">parm</span><span class="p">,</span>
				  <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">xfer_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">res_handle</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_SCSICDB</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">flags_hi</span> <span class="o">|=</span> <span class="n">IPR_FLAGS_HI_WRITE_NOT_READ</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SELECT</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfer_len</span><span class="p">;</span>

	<span class="n">ipr_init_ioadl</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">xfer_len</span><span class="p">,</span> <span class="n">IPR_IOADL_FLAGS_WRITE_LAST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_mode_select_page28 - Issue Mode Select Page 28 to IOA</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sets up the SCSI bus attributes and sends</span>
<span class="cm"> * a Mode Select for Page 28 to activate them.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_mode_select_page28</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_mode_pages</span> <span class="o">*</span><span class="n">mode_pages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">mode_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ipr_scsi_bus_speed_limit</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">ipr_check_term_power</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">mode_pages</span><span class="p">);</span>
	<span class="n">ipr_modify_ioafp_mode_page_28</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">mode_pages</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">mode_pages</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode_pages</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ipr_build_mode_select</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">),</span> <span class="mh">0x11</span><span class="p">,</span>
			      <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">,</span> <span class="n">mode_pages</span><span class="p">),</span>
			      <span class="n">length</span><span class="p">);</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_set_supported_devs</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ipr_resource_entry</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_INTERNAL_TIMEOUT</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_build_mode_sense - Builds a mode sense command</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @res:		resource entry struct</span>
<span class="cm"> * @parm:		Byte 2 of mode sense command</span>
<span class="cm"> * @dma_addr:	DMA address of mode sense buffer</span>
<span class="cm"> * @xfer_len:	Size of DMA buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_build_mode_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
				 <span class="n">__be32</span> <span class="n">res_handle</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">parm</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">xfer_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">res_handle</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MODE_SENSE</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfer_len</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_SCSICDB</span><span class="p">;</span>

	<span class="n">ipr_init_ioadl</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">xfer_len</span><span class="p">,</span> <span class="n">IPR_IOADL_FLAGS_READ_LAST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_cmd_failed - Handle failure of IOA reset command</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function handles the failure of an IOA bringup command.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_cmd_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;0x%02X failed with IOASC: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ioasc</span><span class="p">);</span>

	<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_mode_sense_failed - Handle failure of IOAFP mode sense</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function handles the failure of a Mode Sense to the IOAFP.</span>
<span class="cm"> * Some adapters do not handle all mode pages.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_mode_sense_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_IR_INVALID_REQ_TYPE_OR_PKT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_set_supported_devs</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ipr_resource_entry</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipr_reset_cmd_failed</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_mode_sense_page28 - Issue Mode Sense Page 28 to IOA</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function send a Page 28 mode sense to the IOA to</span>
<span class="cm"> * retrieve SCSI bus attributes.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_mode_sense_page28</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ipr_build_mode_sense</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">),</span>
			     <span class="mh">0x28</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span> <span class="o">+</span>
			     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">,</span> <span class="n">mode_pages</span><span class="p">),</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_pages</span><span class="p">));</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_mode_select_page28</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step_failed</span> <span class="o">=</span> <span class="n">ipr_reset_mode_sense_failed</span><span class="p">;</span>

	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_INTERNAL_TIMEOUT</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_mode_select_page24 - Issue Mode Select to IOA</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function enables dual IOA RAID support if possible.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_mode_select_page24</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_mode_pages</span> <span class="o">*</span><span class="n">mode_pages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">mode_pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_mode_page24</span> <span class="o">*</span><span class="n">mode_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">mode_page</span> <span class="o">=</span> <span class="n">ipr_get_mode_page</span><span class="p">(</span><span class="n">mode_pages</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_page24</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_page</span><span class="p">)</span>
		<span class="n">mode_page</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPR_ENABLE_DUAL_IOA_AF</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">mode_pages</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode_pages</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ipr_build_mode_select</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">),</span> <span class="mh">0x11</span><span class="p">,</span>
			      <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">,</span> <span class="n">mode_pages</span><span class="p">),</span>
			      <span class="n">length</span><span class="p">);</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_mode_sense_page28</span><span class="p">;</span>
	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_INTERNAL_TIMEOUT</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_mode_sense_page24_failed - Handle failure of IOAFP mode sense</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function handles the failure of a Mode Sense to the IOAFP.</span>
<span class="cm"> * Some adapters do not handle all mode pages.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_mode_sense_page24_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_IR_INVALID_REQ_TYPE_OR_PKT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_mode_sense_page28</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ipr_reset_cmd_failed</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_mode_sense_page24 - Issue Page 24 Mode Sense to IOA</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function send a mode sense to the IOA to retrieve</span>
<span class="cm"> * the IOA Advanced Function Control mode page.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_mode_sense_page24</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ipr_build_mode_sense</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">),</span>
			     <span class="mh">0x24</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span> <span class="o">+</span>
			     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">,</span> <span class="n">mode_pages</span><span class="p">),</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_mode_pages</span><span class="p">));</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_mode_select_page24</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step_failed</span> <span class="o">=</span> <span class="n">ipr_reset_mode_sense_page24_failed</span><span class="p">;</span>

	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_INTERNAL_TIMEOUT</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_init_res_table - Initialize the resource table</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function looks through the existing resource table, comparing</span>
<span class="cm"> * it with the config table. This function will take care of old/new</span>
<span class="cm"> * devices and schedule adding/removing them from the mid-layer</span>
<span class="cm"> * as appropriate.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_init_res_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_resource_entry</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_config_table_entry_wrapper</span> <span class="n">cfgtew</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">old_res</span><span class="p">);</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table64</span><span class="o">-&gt;</span><span class="n">hdr64</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">IPR_UCODE_DOWNLOAD_REQ</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Microcode download required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">entries</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table64</span><span class="o">-&gt;</span><span class="n">hdr64</span><span class="p">.</span><span class="n">num_entries</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">entries</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">num_entries</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
			<span class="n">cfgtew</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte64</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table64</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">cfgtew</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">cfgte</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_res</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipr_is_same_device</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">);</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_res_q</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Too many devices attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_res_q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ipr_resource_entry</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">);</span>
			<span class="n">ipr_init_res_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="p">);</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">add_to_ml</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ipr_is_vset_device</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">||</span> <span class="n">ipr_is_scsi_disk</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">allow_restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="n">ipr_update_res_entry</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgtew</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_res</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">del_from_ml</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">IPR_INVALID_RES_HANDLE</span><span class="p">;</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_res</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_clear_res_target</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_res_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dual_raid</span> <span class="o">&amp;&amp;</span> <span class="n">ipr_dual_ioa_raid</span><span class="p">)</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_mode_sense_page24</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_mode_sense_page28</span><span class="p">;</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_query_ioa_cfg - Send a Query IOA Config to the adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends a Query IOA Configuration command</span>
<span class="cm"> * to the adapter to retrieve the IOA configuration table.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_query_ioa_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_inquiry_page3</span> <span class="o">*</span><span class="n">ucode_vpd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">page3_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_inquiry_cap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IPR_CAP_DUAL_IOA_RAID</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dual_raid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Adapter firmware version: %02X%02X%02X%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">major_release</span><span class="p">,</span> <span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">card_type</span><span class="p">,</span>
		 <span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">minor_release</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ucode_vpd</span><span class="o">-&gt;</span><span class="n">minor_release</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">);</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_QUERY_IOA_CONFIG</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ipr_init_ioadl</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_dma</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span><span class="p">,</span>
		       <span class="n">IPR_IOADL_FLAGS_READ_LAST</span><span class="p">);</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_init_res_table</span><span class="p">;</span>

	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_INTERNAL_TIMEOUT</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_inquiry - Send an Inquiry to the adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This utility function sends an inquiry to the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_ioafp_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page</span><span class="p">,</span>
			      <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">xfer_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_SCSICDB</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">);</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">INQUIRY</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfer_len</span><span class="p">;</span>

	<span class="n">ipr_init_ioadl</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">xfer_len</span><span class="p">,</span> <span class="n">IPR_IOADL_FLAGS_READ_LAST</span><span class="p">);</span>

	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_INTERNAL_TIMEOUT</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_inquiry_page_supported - Is the given inquiry page supported</span>
<span class="cm"> * @page0:		inquiry page 0 buffer</span>
<span class="cm"> * @page:		page code.</span>
<span class="cm"> *</span>
<span class="cm"> * This function determines if the specified inquiry page is supported.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	1 if page is supported / 0 if not</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_inquiry_page_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_inquiry_page0</span> <span class="o">*</span><span class="n">page0</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">page0</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IPR_INQUIRY_PAGE0_ENTRIES</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page0</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">page</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_cap_inquiry - Send a Page 0xD0 Inquiry to the adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends a Page 0xD0 inquiry to the adapter</span>
<span class="cm"> * to retrieve adapter capabilities.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_cap_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_inquiry_page0</span> <span class="o">*</span><span class="n">page0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">page0_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_inquiry_cap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_query_ioa_cfg</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cap</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_inquiry_page_supported</span><span class="p">(</span><span class="n">page0</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipr_ioafp_inquiry</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span>
				  <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">,</span> <span class="n">cap</span><span class="p">),</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_inquiry_cap</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_page3_inquiry - Send a Page 3 Inquiry to the adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends a Page 3 inquiry to the adapter</span>
<span class="cm"> * to retrieve software VPD information.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_page3_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_cap_inquiry</span><span class="p">;</span>

	<span class="n">ipr_ioafp_inquiry</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
			  <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">,</span> <span class="n">page3_data</span><span class="p">),</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_inquiry_page3</span><span class="p">));</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_page0_inquiry - Send a Page 0 Inquiry to the adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends a Page 0 inquiry to the adapter</span>
<span class="cm"> * to retrieve supported inquiry pages.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_page0_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">ENTER</span><span class="p">;</span>

	<span class="cm">/* Grab the type out of the VPD and store it away */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="o">-&gt;</span><span class="n">ioa_vpd</span><span class="p">.</span><span class="n">std_inq_data</span><span class="p">.</span><span class="n">vpids</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">type</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_page3_inquiry</span><span class="p">;</span>

	<span class="n">ipr_ioafp_inquiry</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">,</span> <span class="n">page0_data</span><span class="p">),</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_inquiry_page0</span><span class="p">));</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_std_inquiry - Send a Standard Inquiry to the adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function sends a standard inquiry to the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_std_inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_page0_inquiry</span><span class="p">;</span>

	<span class="n">ipr_ioafp_inquiry</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">,</span> <span class="n">ioa_vpd</span><span class="p">),</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_vpd</span><span class="p">));</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_ioafp_identify_hrrq - Send Identify Host RRQ.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function send an Identify Host Request Response Queue</span>
<span class="cm"> * command to establish the HRRQ with the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_ioafp_identify_hrrq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Starting IOA initialization sequence.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_ID_HOST_RR_Q</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">);</span>

	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPR_NUM_CMD_BLKS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPR_NUM_CMD_BLKS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_std_inquiry</span><span class="p">;</span>

	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_INTERNAL_TIMEOUT</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_timer_done - Adapter reset timer function</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function is used in adapter reset processing</span>
<span class="cm"> * for timing events. If the reset_cmd pointer in the IOA</span>
<span class="cm"> * config struct is not this adapter&#39;s we are doing nested</span>
<span class="cm"> * resets and fail_all_ops will take care of freeing the</span>
<span class="cm"> * command block.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_reset_timer_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span> <span class="o">==</span> <span class="n">ipr_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_start_timer - Start a timer for adapter reset job</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> * @timeout:	timeout value</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function is used in adapter reset processing</span>
<span class="cm"> * for timing events. If the reset_cmd pointer in the IOA</span>
<span class="cm"> * config struct is not this adapter&#39;s we are doing nested</span>
<span class="cm"> * resets and fail_all_ops will take care of freeing the</span>
<span class="cm"> * command block.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_reset_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_reset_ioa_job</span><span class="p">;</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">ipr_reset_timer_done</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_init_ioa_mem - Initialize ioa_cfg control block</span>
<span class="cm"> * @ioa_cfg:	ioa cfg struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_init_ioa_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPR_NUM_CMD_BLKS</span><span class="p">);</span>

	<span class="cm">/* Initialize Host RRQ pointers */</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_start</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_end</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq</span><span class="p">[</span><span class="n">IPR_NUM_CMD_BLKS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_curr</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hrrq_start</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">toggle_bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Zero out config table */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_next_stage - Process IPL stage change based on feedback register.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_next_stage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stage</span><span class="p">,</span> <span class="n">stage_time</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">feedback</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">int_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">maskval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">feedback</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">init_feedback_reg</span><span class="p">);</span>
	<span class="n">stage</span> <span class="o">=</span> <span class="n">feedback</span> <span class="o">&amp;</span> <span class="n">IPR_IPL_INIT_STAGE_MASK</span><span class="p">;</span>
	<span class="n">stage_time</span> <span class="o">=</span> <span class="n">feedback</span> <span class="o">&amp;</span> <span class="n">IPR_IPL_INIT_STAGE_TIME_MASK</span><span class="p">;</span>

	<span class="n">ipr_dbg</span><span class="p">(</span><span class="s">&quot;IPL stage = 0x%lx, IPL stage time = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">stage_time</span><span class="p">);</span>

	<span class="cm">/* sanity check the stage_time value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stage_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">stage_time</span> <span class="o">=</span> <span class="n">IPR_IPL_INIT_DEFAULT_STAGE_TIME</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stage_time</span> <span class="o">&lt;</span> <span class="n">IPR_IPL_INIT_MIN_STAGE_TIME</span><span class="p">)</span>
		<span class="n">stage_time</span> <span class="o">=</span> <span class="n">IPR_IPL_INIT_MIN_STAGE_TIME</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stage_time</span> <span class="o">&gt;</span> <span class="n">IPR_LONG_OPERATIONAL_TIMEOUT</span><span class="p">)</span>
		<span class="n">stage_time</span> <span class="o">=</span> <span class="n">IPR_LONG_OPERATIONAL_TIMEOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stage</span> <span class="o">==</span> <span class="n">IPR_IPL_INIT_STAGE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_IPL_STAGE_CHANGE</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_interrupt_mask_reg</span><span class="p">);</span>
		<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_mask_reg</span><span class="p">);</span>
		<span class="n">stage_time</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">transop_timeout</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_identify_hrrq</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stage</span> <span class="o">==</span> <span class="n">IPR_IPL_INIT_STAGE_TRANSOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_IOA_TRANS_TO_OPER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_identify_hrrq</span><span class="p">;</span>
			<span class="n">maskval</span> <span class="o">=</span> <span class="n">IPR_PCII_IPL_STAGE_CHANGE</span><span class="p">;</span>
			<span class="n">maskval</span> <span class="o">=</span> <span class="p">(</span><span class="n">maskval</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">IPR_PCII_IOA_TRANS_TO_OPER</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">maskval</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_interrupt_mask_reg</span><span class="p">);</span>
			<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_mask_reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">stage_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">ipr_oper_timeout</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_reset_ioa_job</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_enable_ioa - Enable the IOA following a reset.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function reinitializes some control blocks and</span>
<span class="cm"> * enables destructive diagnostics on the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_enable_ioa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">int_reg</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u64</span> <span class="n">maskval</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioafp_identify_hrrq</span><span class="p">;</span>
	<span class="n">ipr_init_ioa_mem</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_interrupts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the adapter to the correct endian mode. */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">IPR_ENDIAN_SWAP_KEY</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">endian_swap_reg</span><span class="p">);</span>
		<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">endian_swap_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_IOA_TRANS_TO_OPER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">IPR_PCII_ERROR_INTERRUPTS</span> <span class="o">|</span> <span class="n">IPR_PCII_HRRQ_UPDATED</span><span class="p">),</span>
		       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_mask_reg32</span><span class="p">);</span>
		<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_mask_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable destructive diagnostics on IOA */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_uproc_interrupt_reg32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maskval</span> <span class="o">=</span> <span class="n">IPR_PCII_IPL_STAGE_CHANGE</span><span class="p">;</span>
		<span class="n">maskval</span> <span class="o">=</span> <span class="p">(</span><span class="n">maskval</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">IPR_PCII_OPER_INTERRUPTS</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">maskval</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_mask_reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_OPER_INTERRUPTS</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_mask_reg32</span><span class="p">);</span>

	<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_mask_reg</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Initializing IOA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_next_stage</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">transop_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">ipr_oper_timeout</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_reset_ioa_job</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_wait_for_dump - Wait for a dump to timeout.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is invoked when an adapter dump has run out</span>
<span class="cm"> * of processing time.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_wait_for_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">GET_DUMP</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_DUMP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">READ_DUMP</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">ABORT_DUMP</span><span class="p">;</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump_timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_alert</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_unit_check_no_data - Log a unit check/no data error log</span>
<span class="cm"> * @ioa_cfg:		ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Logs an error indicating the adapter unit checked, but for some</span>
<span class="cm"> * reason, we were unable to fetch the unit check buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_unit_check_no_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">errors_logged</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IOA unit check with no data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_unit_check_buffer - Get the unit check buffer from the IOA</span>
<span class="cm"> * @ioa_cfg:		ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Fetches the unit check buffer from the adapter by clocking the data</span>
<span class="cm"> * through the mailbox register.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_get_unit_check_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mailbox</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_hostrcb</span> <span class="o">*</span><span class="n">hostrcb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_uc_sdt</span> <span class="n">sdt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioasc</span><span class="p">;</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_mailbox</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ipr_sdt_is_fmt2</span><span class="p">(</span><span class="n">mailbox</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipr_unit_check_no_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_uc_sdt</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_get_ldump_data_section</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sdt</span><span class="p">,</span>
					<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_uc_sdt</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sdt</span><span class="p">.</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPR_SDT_VALID_ENTRY</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IPR_FMT3_SDT_READY_TO_USE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IPR_FMT2_SDT_READY_TO_USE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ipr_unit_check_no_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find length of the first sdt entry (UC buffer) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">IPR_FMT3_SDT_READY_TO_USE</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">.</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end_token</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">.</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end_token</span><span class="p">)</span> <span class="o">-</span>
			  <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">.</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start_token</span><span class="p">))</span> <span class="o">&amp;</span>
			  <span class="n">IPR_FMT2_MBX_ADDR_MASK</span><span class="p">;</span>

	<span class="n">hostrcb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_free_q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ipr_hostrcb</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_get_ldump_data_section</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span>
					<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sdt</span><span class="p">.</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start_token</span><span class="p">),</span>
					<span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">,</span>
					<span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_handle_log_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">hostrcb</span><span class="p">);</span>
		<span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">hcam</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">fd_ioasc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioasc</span> <span class="o">==</span> <span class="n">IPR_IOASC_NR_IOA_RESET_REQUIRED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">GET_DUMP</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_DUMP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ipr_unit_check_no_data</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hostrcb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_get_unit_check_job - Call to get the unit check buffer.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function will call to get the unit check buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_get_unit_check_job</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_unit_checked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipr_get_unit_check_buffer</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_alert</span><span class="p">;</span>
	<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_restore_cfg_space - Restore PCI config space.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function restores the saved PCI config space of</span>
<span class="cm"> * the adapter, fails all outstanding ops back to the callers, and</span>
<span class="cm"> * fetches the dump/unit check if applicable to this reset.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_restore_cfg_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_reg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">state_saved</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_set_pcix_cmd_reg</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOASC_PCI_ACCESS_ERROR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_fail_all_ops</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the adapter to the correct endian mode. */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">IPR_ENDIAN_SWAP_KEY</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">endian_swap_reg</span><span class="p">);</span>
		<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">endian_swap_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_unit_checked</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_get_unit_check_job</span><span class="p">;</span>
			<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_DUMP_DELAY_TIMEOUT</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_unit_checked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ipr_get_unit_check_buffer</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_alert</span><span class="p">;</span>
			<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_ioa_bringdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_ioa_bringdown_done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_enable_ioa</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_DUMP</span> <span class="o">==</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">READ_DUMP</span><span class="p">;</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dump_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
				<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_SIS64_DUMP_TIMEOUT</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_SIS32_DUMP_TIMEOUT</span><span class="p">);</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_wait_for_dump</span><span class="p">;</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">work_q</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_bist_done - BIST has completed on the adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Unblock config space and resume the reset process.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_bist_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_locked</span><span class="p">)</span>
		<span class="n">pci_cfg_access_unlock</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_restore_cfg_space</span><span class="p">;</span>
	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_start_bist - Run BIST on the adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function runs BIST on the adapter, then delays 2 seconds.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_start_bist</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_chip</span><span class="o">-&gt;</span><span class="n">bist_method</span> <span class="o">==</span> <span class="n">IPR_MMIO</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">IPR_UPROCI_SIS64_START_BIST</span><span class="p">,</span>
		       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_uproc_interrupt_reg32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BIST</span><span class="p">,</span> <span class="n">PCI_BIST_START</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_bist_done</span><span class="p">;</span>
		<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_WAIT_FOR_BIST_TIMEOUT</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_locked</span><span class="p">)</span>
			<span class="n">pci_cfg_access_unlock</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOASC_PCI_ACCESS_ERROR</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_slot_reset_done - Clear PCI reset to the adapter</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This clears PCI reset to the adapter and delays two seconds.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_slot_reset_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">pci_set_pcie_reset_state</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcie_deassert_reset</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_bist_done</span><span class="p">;</span>
	<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_WAIT_FOR_BIST_TIMEOUT</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_slot_reset - Reset the PCI slot of the adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This asserts PCI reset to the adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">pci_set_pcie_reset_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcie_warm_reset</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_slot_reset_done</span><span class="p">;</span>
	<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_PCI_RESET_TIMEOUT</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_block_config_access_wait - Wait for permission to block config access</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This attempts to block config access to the IOA.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_block_config_access_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_cfg_access_trylock</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">time_left</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">time_left</span> <span class="o">-=</span> <span class="n">IPR_CHECK_FOR_RESET_TIMEOUT</span><span class="p">;</span>
			<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span>
					      <span class="n">IPR_CHECK_FOR_RESET_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Timed out waiting to lock config access. Resetting anyway.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_block_config_access - Block config access to the IOA</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This attempts to block config access to the IOA</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_block_config_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_block_config_access_wait</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">time_left</span> <span class="o">=</span> <span class="n">IPR_WAIT_FOR_RESET_TIMEOUT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_allowed - Query whether or not IOA can be reset</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 if reset not allowed / non-zero if reset is allowed</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">temp_reg</span><span class="p">;</span>

	<span class="n">temp_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">temp_reg</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_CRITICAL_OPERATION</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_wait_to_start_bist - Wait for permission to reset IOA.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function waits for adapter permission to run BIST,</span>
<span class="cm"> * then runs BIST. If the adapter does not give permission after a</span>
<span class="cm"> * reasonable time, we will reset the adapter anyway. The impact of</span>
<span class="cm"> * resetting the adapter without warning the adapter is the risk of</span>
<span class="cm"> * losing the persistent error log on the adapter. If the adapter is</span>
<span class="cm"> * reset while it is writing to the flash on the adapter, the flash</span>
<span class="cm"> * segment will have bad ECC and be zeroed.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_wait_to_start_bist</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_reset_allowed</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">time_left</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">time_left</span> <span class="o">-=</span> <span class="n">IPR_CHECK_FOR_RESET_TIMEOUT</span><span class="p">;</span>
		<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_CHECK_FOR_RESET_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_block_config_access</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_alert - Alert the adapter of a pending reset</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function alerts the adapter that it will be reset.</span>
<span class="cm"> * If memory space is not currently enabled, proceed directly</span>
<span class="cm"> * to running BIST on the adapter. The timer must always be started</span>
<span class="cm"> * so we guarantee we do not run BIST from ipr_isr.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_alert</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd_reg</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ipr_mask_and_clear_interrupts</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">IPR_UPROCI_RESET_ALERT</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">set_uproc_interrupt_reg32</span><span class="p">);</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_wait_to_start_bist</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_block_config_access</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">time_left</span> <span class="o">=</span> <span class="n">IPR_WAIT_FOR_RESET_TIMEOUT</span><span class="p">;</span>
	<span class="n">ipr_reset_start_timer</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">IPR_CHECK_FOR_RESET_TIMEOUT</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_ucode_download_done - Microcode download completion</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function unmaps the microcode download buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_ucode_download_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="n">sglist</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ucode_sglist</span><span class="p">;</span>

	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">scatterlist</span><span class="p">,</span>
		     <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">num_sg</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_alert</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_ucode_download - Download microcode to the adapter</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function checks to see if it there is microcode</span>
<span class="cm"> * to download to the adapter. If there is, a download is performed.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_ucode_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_sglist</span> <span class="o">*</span><span class="n">sglist</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ucode_sglist</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_alert</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sglist</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>

	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_SCSICDB</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_BUFFER</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_WR_BUF_DOWNLOAD_AND_SAVE</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sglist</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sglist</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">&amp;</span> <span class="mh">0x00ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">&amp;</span> <span class="mh">0x0000ff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">ipr_build_ucode_ioadl64</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">sglist</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ipr_build_ucode_ioadl</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">sglist</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_ucode_download_done</span><span class="p">;</span>

	<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span>
		   <span class="n">IPR_WRITE_BUFFER_TIMEOUT</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_shutdown_ioa - Shutdown the adapter</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function issues an adapter shutdown of the</span>
<span class="cm"> * specified type to the specified adapter as part of the</span>
<span class="cm"> * adapter reset job.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_shutdown_ioa</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ipr_shutdown_type</span> <span class="n">shutdown_type</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">shutdown_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shutdown_type</span> <span class="o">!=</span> <span class="n">IPR_SHUTDOWN_NONE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">);</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_IOA_SHUTDOWN</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">shutdown_type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shutdown_type</span> <span class="o">==</span> <span class="n">IPR_SHUTDOWN_NORMAL</span><span class="p">)</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">IPR_SHUTDOWN_TIMEOUT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shutdown_type</span> <span class="o">==</span> <span class="n">IPR_SHUTDOWN_PREPARE_FOR_NORMAL</span><span class="p">)</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">IPR_INTERNAL_TIMEOUT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">dual_raid</span> <span class="o">&amp;&amp;</span> <span class="n">ipr_dual_ioa_raid</span><span class="p">)</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">IPR_DUAL_IOA_ABBR_SHUTDOWN_TO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">IPR_ABBREV_SHUTDOWN_TIMEOUT</span><span class="p">;</span>

		<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_reset_ioa_job</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_ucode_download</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">ipr_reset_alert</span><span class="p">;</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_ioa_job - Adapter reset job</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function is the job router for the adapter reset job.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_reset_ioa_job</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ioasc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ioasc</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">ioasc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span> <span class="o">!=</span> <span class="n">ipr_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We are doing nested adapter resets and this is</span>
<span class="cm">			 * not the current reset job.</span>
<span class="cm">			 */</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IPR_IOASC_SENSE_KEY</span><span class="p">(</span><span class="n">ioasc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step_failed</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ipr_reinit_ipr_cmnd</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step_failed</span> <span class="o">=</span> <span class="n">ipr_reset_cmd_failed</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IPR_RC_JOB_CONTINUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _ipr_initiate_ioa_reset - Initiate an adapter reset</span>
<span class="cm"> * @ioa_cfg:		ioa config struct</span>
<span class="cm"> * @job_step:		first job step of reset job</span>
<span class="cm"> * @shutdown_type:	shutdown type</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function will initiate the reset of the given adapter</span>
<span class="cm"> * starting at the selected job step.</span>
<span class="cm"> * If the caller needs to wait on the completion of the reset,</span>
<span class="cm"> * the caller must sleep on the reset_wait_q.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ipr_initiate_ioa_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">job_step</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="p">),</span>
				    <span class="k">enum</span> <span class="n">ipr_shutdown_type</span> <span class="n">shutdown_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">ipr_get_free_ipr_cmnd</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">job_step</span> <span class="o">=</span> <span class="n">job_step</span><span class="p">;</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">shutdown_type</span> <span class="o">=</span> <span class="n">shutdown_type</span><span class="p">;</span>

	<span class="n">ipr_reset_ioa_job</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_initiate_ioa_reset - Initiate an adapter reset</span>
<span class="cm"> * @ioa_cfg:		ioa config struct</span>
<span class="cm"> * @shutdown_type:	shutdown type</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function will initiate the reset of the given adapter.</span>
<span class="cm"> * If the caller needs to wait on the completion of the reset,</span>
<span class="cm"> * the caller must sleep on the reset_wait_q.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">ipr_shutdown_type</span> <span class="n">shutdown_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">GET_DUMP</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_DUMP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">READ_DUMP</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">ABORT_DUMP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_retries</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">IPR_NUM_RESET_RELOAD_RETRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;IOA taken offline - error recovery failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_ioa_bringdown</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ipr_fail_all_ops</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
			<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">);</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_ioa_bringdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">shutdown_type</span> <span class="o">=</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">_ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">ipr_reset_shutdown_ioa</span><span class="p">,</span>
				<span class="n">shutdown_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_reset_freeze - Hold off all I/O activity</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: If the PCI slot is frozen, hold off all I/O</span>
<span class="cm"> * activity; then, as soon as the slot is available again,</span>
<span class="cm"> * initiate an adapter reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_reset_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disallow new interrupts, avoid loop */</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_interrupts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>
	<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">ipr_reset_ioa_job</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IPR_RC_JOB_RETURN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_pci_frozen - Called when slot has experienced a PCI bus error.</span>
<span class="cm"> * @pdev:	PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This routine is called to tell us that the PCI bus</span>
<span class="cm"> * is down. Can&#39;t do anything here, except put the device driver</span>
<span class="cm"> * into a holding pattern, waiting for the PCI bus to come back.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_pci_frozen</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">ipr_reset_freeze</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_pci_slot_reset - Called when PCI slot has been reset.</span>
<span class="cm"> * @pdev:	PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This routine is called by the pci error recovery</span>
<span class="cm"> * code after the PCI slot has been reset, just before we</span>
<span class="cm"> * should resume normal operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">ipr_pci_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">needs_warm_reset</span><span class="p">)</span>
		<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">_ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">ipr_reset_restore_cfg_space</span><span class="p">,</span>
					<span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_pci_perm_failure - Called when PCI slot is dead for good.</span>
<span class="cm"> * @pdev:	PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This routine is called when the PCI bus has</span>
<span class="cm"> * permanently failed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_pci_perm_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">WAIT_FOR_DUMP</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">ABORT_DUMP</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_retries</span> <span class="o">=</span> <span class="n">IPR_NUM_RESET_RELOAD_RETRIES</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_ioa_bringdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_pci_error_detected - Called when a PCI error is detected.</span>
<span class="cm"> * @pdev:	PCI device struct</span>
<span class="cm"> * @state:	PCI channel state</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Called when a PCI error is detected.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	PCI_ERS_RESULT_NEED_RESET or PCI_ERS_RESULT_DISCONNECT</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">ipr_pci_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					       <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pci_channel_io_frozen</span>:
		<span class="n">ipr_pci_frozen</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_channel_io_perm_failure</span>:
		<span class="n">ipr_pci_perm_failure</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_probe_ioa_part2 - Initializes IOAs found in ipr_probe_ioa(..)</span>
<span class="cm"> * @ioa_cfg:	ioa cfg struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This is the second phase of adapter intialization</span>
<span class="cm"> * This function takes care of initilizing the adapter to the point</span>
<span class="cm"> * where it can accept new commands.</span>

<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / -EIO on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ipr_probe_ioa_part2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">host_lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioa_cfg adx: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">needs_hard_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">needs_hard_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">_ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">ipr_reset_enable_ioa</span><span class="p">,</span>
					<span class="n">IPR_SHUTDOWN_NONE</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_is_dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipr_invalid_adapter</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_testmode</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Adapter not supported in this hardware configuration.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_free_cmd_blks - Frees command blocks allocated for an adapter</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_free_cmd_blks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPR_NUM_CMD_BLKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmd_pool</span><span class="p">,</span>
				      <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				      <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list_dma</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmd_pool</span><span class="p">)</span>
		<span class="n">pci_pool_destroy</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmd_pool</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list_dma</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list_dma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmd_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_free_mem - Frees memory allocated for an adapter</span>
<span class="cm"> * @ioa_cfg:	ioa cfg struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_free_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">res_entries</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">),</span>
			    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span><span class="p">);</span>
	<span class="n">ipr_free_cmd_blks</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPR_NUM_CMD_BLKS</span><span class="p">,</span>
			    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span><span class="p">,</span>
			    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table</span><span class="p">,</span>
			    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_dma</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPR_NUM_HCAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb</span><span class="p">),</span>
				    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_dma</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ipr_free_dump</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_free_all_resources - Free all allocated resources for an adapter.</span>
<span class="cm"> * @ipr_cmd:	ipr command struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function frees all allocated resources for the</span>
<span class="cm"> * specified adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_free_all_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hdw_dma_regs</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ipr_free_mem</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_alloc_cmd_blks - Allocate command blocks for an adapter</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / -ENOMEM on allocation failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ipr_alloc_cmd_blks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioarcb</span> <span class="o">*</span><span class="n">ioarcb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmd_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span> <span class="p">(</span><span class="n">IPR_NAME</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">),</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmd_pool</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">IPR_NUM_CMD_BLKS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list_dma</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">IPR_NUM_CMD_BLKS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_free_cmd_blks</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPR_NUM_CMD_BLKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmd_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ipr_free_cmd_blks</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ipr_cmd</span><span class="p">));</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="p">;</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmnd_list_dma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>

		<span class="n">ioarcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">ioarcb_host_pci_addr64</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">ioarcb_host_pci_addr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>

		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">host_response_handle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sis64_addr_data</span><span class="p">.</span><span class="n">data_ioadl_addr</span> <span class="o">=</span>
				<span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">ioadl64</span><span class="p">));</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sis64_addr_data</span><span class="p">.</span><span class="n">ioasa_host_pci_addr</span> <span class="o">=</span>
				<span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">ioasa64</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">write_ioadl_addr</span> <span class="o">=</span>
				<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">ioadl</span><span class="p">));</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">read_ioadl_addr</span> <span class="o">=</span> <span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">write_ioadl_addr</span><span class="p">;</span>
			<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioasa_host_pci_addr</span> <span class="o">=</span>
				<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">ioasa</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">ioarcb</span><span class="o">-&gt;</span><span class="n">ioasa_len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioasa</span><span class="p">));</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer_dma</span> <span class="o">=</span> <span class="n">dma_addr</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span><span class="p">,</span> <span class="n">sense_buffer</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_alloc_mem - Allocate memory for an adapter</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / non-zero for error</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ipr_alloc_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">res_entries</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_resource_entry</span><span class="p">)</span> <span class="o">*</span>
				       <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">res_entries</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">target_ids</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span>
					      <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">array_ids</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span>
					     <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vset_ids</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span>
					    <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">res_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_res_q</span><span class="p">);</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">res_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_res_entries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_alloc_cmd_blks</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_vpd_cbs</span><span class="p">;</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPR_NUM_CMD_BLKS</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_ipr_free_cmd_blocks</span><span class="p">;</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_host_rrq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPR_NUM_HCAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb</span><span class="p">),</span>
							   <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_dma</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">out_free_hostrcb_dma</span><span class="p">;</span>

		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hostrcb_dma</span> <span class="o">=</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_dma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb</span><span class="p">,</span> <span class="n">hcam</span><span class="p">);</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_free_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">trace</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_trace_entry</span><span class="p">)</span> <span class="o">*</span>
				 <span class="n">IPR_NUM_TRACE_ENTRIES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_hostrcb_dma</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">LEAVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">out_free_hostrcb_dma:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_hostrcb</span><span class="p">),</span>
				    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_dma</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span><span class="p">,</span>
			    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cfg_table</span><span class="p">,</span>
			    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_dma</span><span class="p">);</span>
<span class="nl">out_free_host_rrq:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPR_NUM_CMD_BLKS</span><span class="p">,</span>
			    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host_rrq_dma</span><span class="p">);</span>
<span class="nl">out_ipr_free_cmd_blocks:</span>
	<span class="n">ipr_free_cmd_blks</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
<span class="nl">out_free_vpd_cbs:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_misc_cbs</span><span class="p">),</span>
			    <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">vpd_cbs_dma</span><span class="p">);</span>
<span class="nl">out_free_res_entries:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">res_entries</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_initialize_bus_attr - Initialize SCSI bus attributes to default values</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">ipr_initialize_bus_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPR_MAX_NUM_BUSES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">bus_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">bus_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qas_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">bus_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_width</span> <span class="o">=</span> <span class="n">IPR_DEFAULT_BUS_WIDTH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_max_speed</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipr_max_bus_speeds</span><span class="p">))</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">bus_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_xfer_rate</span> <span class="o">=</span> <span class="n">ipr_max_bus_speeds</span><span class="p">[</span><span class="n">ipr_max_speed</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">bus_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_xfer_rate</span> <span class="o">=</span> <span class="n">IPR_U160_SCSI_RATE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_init_ioa_cfg - Initialize IOA config struct</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> * @host:		scsi host struct</span>
<span class="cm"> * @pdev:		PCI dev struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">ipr_init_ioa_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ipr_interrupt_offsets</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_interrupts</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">ipr_log_level</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">doorbell</span> <span class="o">=</span> <span class="n">IPR_DOORBELL</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">eye_catcher</span><span class="p">,</span> <span class="n">IPR_EYECATCHER</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">trace_start</span><span class="p">,</span> <span class="n">IPR_TRACE_START_LABEL</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_free_label</span><span class="p">,</span> <span class="n">IPR_FREEQ_LABEL</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_pending_label</span><span class="p">,</span> <span class="n">IPR_PENDQ_LABEL</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_start</span><span class="p">,</span> <span class="n">IPR_CFG_TBL_START</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">resource_table_label</span><span class="p">,</span> <span class="n">IPR_RES_TABLE_LABEL</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_hcam_label</span><span class="p">,</span> <span class="n">IPR_HCAM_LABEL</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_cmd_label</span><span class="p">,</span> <span class="n">IPR_CMD_LABEL</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">pending_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_free_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hostrcb_pending_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_res_q</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">used_res_q</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">work_q</span><span class="p">,</span> <span class="n">ipr_worker_thread</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">msi_wait_q</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">INACTIVE</span><span class="p">;</span>

	<span class="n">ipr_initialize_bus_attr</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span> <span class="o">=</span> <span class="n">ipr_max_devs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">IPR_MAX_SIS64_TARGETS_PER_BUS</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">IPR_MAX_SIS64_LUNS_PER_TARGET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_max_devs</span> <span class="o">&gt;</span> <span class="n">IPR_MAX_SIS64_DEVS</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span> <span class="o">=</span> <span class="n">IPR_MAX_SIS64_DEVS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">IPR_MAX_NUM_TARGETS_PER_BUS</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">IPR_MAX_NUM_LUNS_PER_TARGET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_max_devs</span> <span class="o">&gt;</span> <span class="n">IPR_MAX_PHYSICAL_DEVS</span><span class="p">)</span>
			<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span> <span class="o">=</span> <span class="n">IPR_MAX_PHYSICAL_DEVS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">IPR_MAX_BUS_TO_SCAN</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">IPR_MAX_CDB_LEN</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_cmds</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">chip_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hdw_dma_regs</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">set_interrupt_mask_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">set_interrupt_mask_reg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">clr_interrupt_mask_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">clr_interrupt_mask_reg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">clr_interrupt_mask_reg32</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">clr_interrupt_mask_reg32</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">sense_interrupt_mask_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sense_interrupt_mask_reg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">sense_interrupt_mask_reg32</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sense_interrupt_mask_reg32</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">clr_interrupt_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">clr_interrupt_reg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">clr_interrupt_reg32</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">clr_interrupt_reg32</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">sense_interrupt_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sense_interrupt_reg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">sense_interrupt_reg32</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sense_interrupt_reg32</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">ioarrin_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ioarrin_reg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">sense_uproc_interrupt_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sense_uproc_interrupt_reg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">sense_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sense_uproc_interrupt_reg32</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">set_uproc_interrupt_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">set_uproc_interrupt_reg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">set_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">set_uproc_interrupt_reg32</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">clr_uproc_interrupt_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">clr_uproc_interrupt_reg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">clr_uproc_interrupt_reg32</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">clr_uproc_interrupt_reg32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">init_feedback_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">init_feedback_reg</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">dump_addr_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dump_addr_reg</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">dump_data_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dump_data_reg</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">endian_swap_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">endian_swap_reg</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_get_chip_info - Find adapter chip information</span>
<span class="cm"> * @dev_id:		PCI device id struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	ptr to chip information on success / NULL on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipr_chip_t</span> <span class="o">*</span> <span class="n">__devinit</span>
<span class="nf">ipr_get_chip_info</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ipr_chip</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipr_chip</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ipr_chip</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device</span> <span class="o">==</span> <span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">ipr_chip</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_test_intr - Handle the interrupt generated in ipr_test_msi().</span>
<span class="cm"> * @pdev:		PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Simply set the msi_received flag to 1 indicating that</span>
<span class="cm"> * Message Signaled Interrupts are supported.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / non-zero on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">__devinit</span> <span class="nf">ipr_test_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">devp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">msi_received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">msi_wait_q</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_test_msi - Test for Message Signaled Interrupt (MSI) support.</span>
<span class="cm"> * @pdev:		PCI device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: The return value from pci_enable_msi() can not always be</span>
<span class="cm"> * trusted.  This routine sets up and initiates a test interrupt to determine</span>
<span class="cm"> * if the interrupt is received via the ipr_test_intr() service routine.</span>
<span class="cm"> * If the tests fails, the driver will fall back to LSI.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / non-zero on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ipr_test_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">int_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">msi_wait_q</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">msi_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ipr_mask_and_clear_interrupts</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="o">~</span><span class="n">IPR_PCII_IOA_TRANS_TO_OPER</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_IO_DEBUG_ACKNOWLEDGE</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">clr_interrupt_mask_reg32</span><span class="p">);</span>
	<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_mask_reg</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ipr_test_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPR_NAME</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can not assign irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipr_debug</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ assigned: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">IPR_PCII_IO_DEBUG_ACKNOWLEDGE</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg32</span><span class="p">);</span>
	<span class="n">int_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg</span><span class="p">);</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">msi_wait_q</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">msi_received</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">ipr_mask_and_clear_interrupts</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="o">~</span><span class="n">IPR_PCII_IOA_TRANS_TO_OPER</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">msi_received</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MSI test failed */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSI test failed.  Falling back to LSI.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipr_debug</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSI test succeeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_probe_ioa - Allocates memory and does first stage of initialization</span>
<span class="cm"> * @pdev:		PCI device struct</span>
<span class="cm"> * @dev_id:		PCI device id struct</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / non-zero on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ipr_probe_ioa</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ipr_regs_pci</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ipr_regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">uproc</span><span class="p">,</span> <span class="n">interrupts</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Found IOA with IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioa_cfg</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;call to scsi_host_alloc failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioa_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span><span class="p">));</span>
	<span class="n">ata_host_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ata_host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		      <span class="n">sata_port_info</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_sata_ops</span><span class="p">);</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_chip</span> <span class="o">=</span> <span class="n">ipr_get_chip_info</span><span class="p">(</span><span class="n">dev_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown adapter chipset 0x%04X 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_scsi_host_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set SIS 32 or SIS 64 */</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_chip</span><span class="o">-&gt;</span><span class="n">sis_type</span> <span class="o">==</span> <span class="n">IPR_SIS64</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">chip_cfg</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_chip</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">clear_isr</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">chip_cfg</span><span class="o">-&gt;</span><span class="n">clear_isr</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_cmds</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">chip_cfg</span><span class="o">-&gt;</span><span class="n">max_cmds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipr_transop_timeout</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">transop_timeout</span> <span class="o">=</span> <span class="n">ipr_transop_timeout</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">transop_timeout</span> <span class="o">=</span> <span class="n">IPR_LONG_OPERATIONAL_TIMEOUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">transop_timeout</span> <span class="o">=</span> <span class="n">IPR_OPERATIONAL_TIMEOUT</span><span class="p">;</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">revid</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="n">ipr_regs_pci</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IPR_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Couldn&#39;t register memory range of registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_scsi_host_put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipr_regs</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipr_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Couldn&#39;t map memory range of registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hdw_dma_regs</span> <span class="o">=</span> <span class="n">ipr_regs</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">hdw_dma_regs_pci</span> <span class="o">=</span> <span class="n">ipr_regs_pci</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_mailbox</span> <span class="o">=</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">chip_cfg</span><span class="o">-&gt;</span><span class="n">mailbox</span> <span class="o">+</span> <span class="n">ipr_regs</span><span class="p">;</span>

	<span class="n">ipr_init_ioa_cfg</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set 64 bit PCI DMA mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set PCI DMA mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup_nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span>
				   <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">chip_cfg</span><span class="o">-&gt;</span><span class="n">cache_line_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Write of cache line size failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup_nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable MSI style interrupts if they are supported. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ipr_chip</span><span class="o">-&gt;</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">IPR_USE_MSI</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_test_msi</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_msi_disable</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSI enabled with IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipr_debug</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable MSI.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Save away PCI config space for use following IOA reset */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to save PCI config space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_msi_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_save_pcix_cmd_reg</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_msi_disable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_set_pcix_cmd_reg</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_msi_disable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sis64</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_config_table_hdr64</span><span class="p">)</span>
				<span class="o">+</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_config_table_entry64</span><span class="p">)</span>
				<span class="o">*</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">cfg_table_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_config_table_hdr</span><span class="p">)</span>
				<span class="o">+</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_config_table_entry</span><span class="p">)</span>
				<span class="o">*</span> <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">max_devs_supported</span><span class="p">)));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_alloc_mem</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Couldn&#39;t allocate enough memory for device driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_msi_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If HRRQ updated interrupt is not masked, or reset alert is set,</span>
<span class="cm">	 * the card is in an unknown state and needs a hard reset</span>
<span class="cm">	 */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_mask_reg32</span><span class="p">);</span>
	<span class="n">interrupts</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_interrupt_reg32</span><span class="p">);</span>
	<span class="n">uproc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sense_uproc_interrupt_reg32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_HRRQ_UPDATED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">uproc</span> <span class="o">&amp;</span> <span class="n">IPR_UPROCI_RESET_ALERT</span><span class="p">))</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">needs_hard_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">interrupts</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_ERROR_INTERRUPTS</span><span class="p">)</span> <span class="o">||</span> <span class="n">reset_devices</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">needs_hard_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupts</span> <span class="o">&amp;</span> <span class="n">IPR_PCII_IOA_UNIT_CHECKED</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">ioa_unit_checked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ipr_mask_and_clear_interrupts</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="o">~</span><span class="n">IPR_PCII_IOA_TRANS_TO_OPER</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ipr_isr</span><span class="p">,</span>
			 <span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">msi_received</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			 <span class="n">IPR_NAME</span><span class="p">,</span> <span class="n">ioa_cfg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t register IRQ %d! rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup_nolog</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="n">IPR_USE_PCI_WARM_RESET</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev_id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN_E</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">revid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">needs_warm_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">ipr_reset_slot_reset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">ipr_reset_start_bist</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_driver_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_ioa_head</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_driver_lock</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">cleanup_nolog:</span>
	<span class="n">ipr_free_mem</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
<span class="nl">out_msi_disable:</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">cleanup_nomem:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ipr_regs</span><span class="p">);</span>
<span class="nl">out_release_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_scsi_host_put:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">out_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_scan_vsets - Scans for VSET devices</span>
<span class="cm"> * @ioa_cfg:	ioa config struct</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Since the VSET resources do not follow SAM in that we can have</span>
<span class="cm"> * sparse LUNs with no LUN 0, we have to scan for these ourselves.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_scan_vsets</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">IPR_MAX_NUM_TARGETS_PER_BUS</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">IPR_MAX_NUM_VSET_LUNS_PER_TARGET</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span> <span class="p">)</span>
			<span class="n">scsi_add_device</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">IPR_VSET_BUS</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_initiate_ioa_bringdown - Bring down an adapter</span>
<span class="cm"> * @ioa_cfg:		ioa config struct</span>
<span class="cm"> * @shutdown_type:	shutdown type</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function will initiate bringing down the adapter.</span>
<span class="cm"> * This consists of issuing an IOA shutdown to the adapter</span>
<span class="cm"> * to flush the cache, and running BIST.</span>
<span class="cm"> * If the caller needs to wait on the completion of the reset,</span>
<span class="cm"> * the caller must sleep on the reset_wait_q.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_initiate_ioa_bringdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">ipr_shutdown_type</span> <span class="n">shutdown_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">WAIT_FOR_DUMP</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">ABORT_DUMP</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_ioa_bringdown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ipr_initiate_ioa_reset</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">shutdown_type</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __ipr_remove - Remove a single adapter</span>
<span class="cm"> * @pdev:	pci device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Adapter hot plug remove entry point.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ipr_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">host_lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ENTER</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipr_initiate_ioa_bringdown</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NORMAL</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">work_q</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_driver_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_driver_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">==</span> <span class="n">ABORT_DUMP</span><span class="p">)</span>
		<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">sdt_state</span> <span class="o">=</span> <span class="n">WAIT_FOR_DUMP</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">host_lock_flags</span><span class="p">);</span>

	<span class="n">ipr_free_all_resources</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_remove - IOA hot plug remove entry point</span>
<span class="cm"> * @pdev:	pci device struct</span>
<span class="cm"> *</span>
<span class="cm"> * Adapter hot plug remove entry point.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">ipr_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ENTER</span><span class="p">;</span>

	<span class="n">ipr_remove_trace_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">ipr_trace_attr</span><span class="p">);</span>
	<span class="n">ipr_remove_dump_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">ipr_dump_attr</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">__ipr_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_probe - Adapter hot plug add entry point</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / non-zero on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ipr_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_probe_ioa</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_probe_ioa_part2</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__ipr_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__ipr_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_create_trace_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ipr_trace_attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="n">__ipr_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipr_create_dump_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ipr_dump_attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipr_remove_trace_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">shost_dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">ipr_trace_attr</span><span class="p">);</span>
		<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="n">__ipr_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">ipr_scan_vsets</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
	<span class="n">scsi_add_device</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">IPR_IOA_BUS</span><span class="p">,</span> <span class="n">IPR_IOA_TARGET</span><span class="p">,</span> <span class="n">IPR_IOA_LUN</span><span class="p">);</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_ml_add_del</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">IPR_VSET_BUS</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">work_q</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_shutdown - Shutdown handler.</span>
<span class="cm"> * @pdev:	pci device struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function is invoked upon system shutdown/reboot. It will issue</span>
<span class="cm"> * an adapter shutdown to the adapter to flush the write cache.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ipr_initiate_ioa_bringdown</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="n">IPR_SHUTDOWN_NORMAL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">reset_wait_q</span><span class="p">,</span> <span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">in_reset_reload</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">ipr_pci_table</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_GEMSTONE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_5702</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_GEMSTONE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_5703</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_GEMSTONE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_573D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_GEMSTONE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_573E</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CITRINE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_571B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CITRINE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_572E</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CITRINE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_571A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CITRINE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_575B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_OBSIDIAN</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_572A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_OBSIDIAN</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_572B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	      <span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_OBSIDIAN</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_575C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	      <span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_572A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_572B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	      <span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_575C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	      <span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN_E</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_574E</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	      <span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN_E</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57B3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN_E</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57CC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_OBSIDIAN_E</span><span class="p">,</span>
	      <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57B7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	      <span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span> <span class="o">|</span> <span class="n">IPR_USE_PCI_WARM_RESET</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_SNIPE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_2780</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_SCAMP</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_571E</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_SCAMP</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_571F</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ADAPTEC2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ADAPTEC2_SCAMP</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_572F</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">IPR_USE_LONG_TRANSOP_TIMEOUT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROC_FPGA_E2</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57B5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROC_FPGA_E2</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_574D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROC_FPGA_E2</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57B2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROC_FPGA_E2</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57C3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROC_FPGA_E2</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57C4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROCODILE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57B4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROCODILE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57B1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROCODILE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57C6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROCODILE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57C8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IBM_CROCODILE</span><span class="p">,</span>
		<span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span> <span class="n">IPR_SUBS_DEV_ID_57CE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ipr_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">ipr_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">ipr_pci_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">ipr_pci_slot_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ipr_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">IPR_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ipr_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ipr_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ipr_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ipr_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ipr_err_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_halt_done - Shutdown prepare completion</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipr_halt_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span> <span class="o">=</span> <span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioa_cfg</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_halt - Issue shutdown prepare to all adapters</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	NOTIFY_OK on success / NOTIFY_DONE on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ipr_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipr_cmnd</span> <span class="o">*</span><span class="n">ipr_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipr_ioa_cfg</span> <span class="o">*</span><span class="n">ioa_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">SYS_RESTART</span> <span class="o">&amp;&amp;</span> <span class="n">event</span> <span class="o">!=</span> <span class="n">SYS_HALT</span> <span class="o">&amp;&amp;</span> <span class="n">event</span> <span class="o">!=</span> <span class="n">SYS_POWER_OFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_driver_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipr_ioa_head</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">allow_cmds</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ipr_cmd</span> <span class="o">=</span> <span class="n">ipr_get_free_ipr_cmnd</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="p">);</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">res_handle</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">IPR_IOA_RES_HANDLE</span><span class="p">);</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">request_type</span> <span class="o">=</span> <span class="n">IPR_RQTYPE_IOACMD</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_IOA_SHUTDOWN</span><span class="p">;</span>
		<span class="n">ipr_cmd</span><span class="o">-&gt;</span><span class="n">ioarcb</span><span class="p">.</span><span class="n">cmd_pkt</span><span class="p">.</span><span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPR_SHUTDOWN_PREPARE_FOR_NORMAL</span><span class="p">;</span>

		<span class="n">ipr_do_req</span><span class="p">(</span><span class="n">ipr_cmd</span><span class="p">,</span> <span class="n">ipr_halt_done</span><span class="p">,</span> <span class="n">ipr_timeout</span><span class="p">,</span> <span class="n">IPR_DEVICE_RESET_TIMEOUT</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ioa_cfg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_driver_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">ipr_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ipr_halt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_init - Module entry point</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / negative value on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ipr_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipr_info</span><span class="p">(</span><span class="s">&quot;IBM Power RAID SCSI Device Driver version: %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">IPR_DRIVER_VERSION</span><span class="p">,</span> <span class="n">IPR_DRIVER_DATE</span><span class="p">);</span>

	<span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_notifier</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ipr_exit - Module unload</span>
<span class="cm"> *</span>
<span class="cm"> * Module unload entry point.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	none</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ipr_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_notifier</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipr_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ipr_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ipr_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
