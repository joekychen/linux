<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › libfc › fc_lport.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fc_lport.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright(c) 2007 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Maintained at www.Open-FCoE.org</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * PORT LOCKING NOTES</span>
<span class="cm"> *</span>
<span class="cm"> * These comments only apply to the &#39;port code&#39; which consists of the lport,</span>
<span class="cm"> * disc and rport blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * MOTIVATION</span>
<span class="cm"> *</span>
<span class="cm"> * The lport, disc and rport blocks all have mutexes that are used to protect</span>
<span class="cm"> * those objects. The main motivation for these locks is to prevent from</span>
<span class="cm"> * having an lport reset just before we send a frame. In that scenario the</span>
<span class="cm"> * lport&#39;s FID would get set to zero and then we&#39;d send a frame with an</span>
<span class="cm"> * invalid SID. We also need to ensure that states don&#39;t change unexpectedly</span>
<span class="cm"> * while processing another state.</span>
<span class="cm"> *</span>
<span class="cm"> * HIERARCHY</span>
<span class="cm"> *</span>
<span class="cm"> * The following hierarchy defines the locking rules. A greater lock</span>
<span class="cm"> * may be held before acquiring a lesser lock, but a lesser lock should never</span>
<span class="cm"> * be held while attempting to acquire a greater lock. Here is the hierarchy-</span>
<span class="cm"> *</span>
<span class="cm"> * lport &gt; disc, lport &gt; rport, disc &gt; rport</span>
<span class="cm"> *</span>
<span class="cm"> * CALLBACKS</span>
<span class="cm"> *</span>
<span class="cm"> * The callbacks cause complications with this scheme. There is a callback</span>
<span class="cm"> * from the rport (to either lport or disc) and a callback from disc</span>
<span class="cm"> * (to the lport).</span>
<span class="cm"> *</span>
<span class="cm"> * As rports exit the rport state machine a callback is made to the owner of</span>
<span class="cm"> * the rport to notify success or failure. Since the callback is likely to</span>
<span class="cm"> * cause the lport or disc to grab its lock we cannot hold the rport lock</span>
<span class="cm"> * while making the callback. To ensure that the rport is not free&#39;d while</span>
<span class="cm"> * processing the callback the rport callbacks are serialized through a</span>
<span class="cm"> * single-threaded workqueue. An rport would never be free&#39;d while in a</span>
<span class="cm"> * callback handler because no other rport work in this queue can be executed</span>
<span class="cm"> * at the same time.</span>
<span class="cm"> *</span>
<span class="cm"> * When discovery succeeds or fails a callback is made to the lport as</span>
<span class="cm"> * notification. Currently, successful discovery causes the lport to take no</span>
<span class="cm"> * action. A failure will cause the lport to reset. There is likely a circular</span>
<span class="cm"> * locking problem with this implementation.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * LPORT LOCKING</span>
<span class="cm"> *</span>
<span class="cm"> * The critical sections protected by the lport&#39;s mutex are quite broad and</span>
<span class="cm"> * may be improved upon in the future. The lport code and its locking doesn&#39;t</span>
<span class="cm"> * influence the I/O path, so excessive locking doesn&#39;t penalize I/O</span>
<span class="cm"> * performance.</span>
<span class="cm"> *</span>
<span class="cm"> * The strategy is to lock whenever processing a request or response. Note</span>
<span class="cm"> * that every _enter_* function corresponds to a state change. They generally</span>
<span class="cm"> * change the lports state and then send a request out on the wire. We lock</span>
<span class="cm"> * before calling any of these functions to protect that state change. This</span>
<span class="cm"> * means that the entry points into the lport block manage the locks while</span>
<span class="cm"> * the state machine can transition between states (i.e. _enter_* functions)</span>
<span class="cm"> * while always staying protected.</span>
<span class="cm"> *</span>
<span class="cm"> * When handling responses we also hold the lport mutex broadly. When the</span>
<span class="cm"> * lport receives the response frame it locks the mutex and then calls the</span>
<span class="cm"> * appropriate handler for the particuar response. Generally a response will</span>
<span class="cm"> * trigger a state change and so the lock must already be held.</span>
<span class="cm"> *</span>
<span class="cm"> * Retries also have to consider the locking. The retries occur from a work</span>
<span class="cm"> * context and the work function will lock the lport and then retry the state</span>
<span class="cm"> * (i.e. _enter_* function).</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;scsi/fc/fc_gs.h&gt;</span>

<span class="cp">#include &lt;scsi/libfc.h&gt;</span>
<span class="cp">#include &lt;scsi/fc_encode.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>

<span class="cp">#include &quot;fc_libfc.h&quot;</span>

<span class="cm">/* Fabric IDs to use for point-to-point mode, chosen on whims. */</span>
<span class="cp">#define FC_LOCAL_PTP_FID_LO   0x010101</span>
<span class="cp">#define FC_LOCAL_PTP_FID_HI   0x010102</span>

<span class="cp">#define	DNS_DELAY	      3 </span><span class="cm">/* Discovery delay after RSCN (in seconds)*/</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_enter_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_enter_flogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_enter_dns</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_enter_ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_lport_state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_enter_scr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_enter_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_enter_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_enter_fdmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_lport_enter_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_lport_state</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fc_lport_state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">LPORT_ST_DISABLED</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_FLOGI</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;FLOGI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_DNS</span><span class="p">]</span> <span class="o">=</span>      <span class="s">&quot;dNS&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_RNN_ID</span><span class="p">]</span> <span class="o">=</span>   <span class="s">&quot;RNN_ID&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_RSNN_NN</span><span class="p">]</span> <span class="o">=</span>  <span class="s">&quot;RSNN_NN&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_RSPN_ID</span><span class="p">]</span> <span class="o">=</span>  <span class="s">&quot;RSPN_ID&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_RFT_ID</span><span class="p">]</span> <span class="o">=</span>   <span class="s">&quot;RFT_ID&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_RFF_ID</span><span class="p">]</span> <span class="o">=</span>   <span class="s">&quot;RFF_ID&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_FDMI</span><span class="p">]</span> <span class="o">=</span>     <span class="s">&quot;FDMI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_RHBA</span><span class="p">]</span> <span class="o">=</span>     <span class="s">&quot;RHBA&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_RPA</span><span class="p">]</span> <span class="o">=</span>      <span class="s">&quot;RPA&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_DHBA</span><span class="p">]</span> <span class="o">=</span>     <span class="s">&quot;DHBA&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_DPRT</span><span class="p">]</span> <span class="o">=</span>     <span class="s">&quot;DPRT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_SCR</span><span class="p">]</span> <span class="o">=</span>      <span class="s">&quot;SCR&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_READY</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;Ready&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_LOGO</span><span class="p">]</span> <span class="o">=</span>     <span class="s">&quot;LOGO&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">LPORT_ST_RESET</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;reset&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct fc_bsg_info - FC Passthrough managemet structure</span>
<span class="cm"> * @job:      The passthrough job</span>
<span class="cm"> * @lport:    The local port to pass through a command</span>
<span class="cm"> * @rsp_code: The expected response code</span>
<span class="cm"> * @sg:	      job-&gt;reply_payload.sg_list</span>
<span class="cm"> * @nents:    job-&gt;reply_payload.sg_cnt</span>
<span class="cm"> * @offset:   The offset into the response data</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fc_bsg_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rsp_code</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nents</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fc_frame_drop() - Dummy frame handler</span>
<span class="cm"> * @lport: The local port the frame was received on</span>
<span class="cm"> * @fp:	   The received frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fc_frame_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_rport_callback() - Event handler for rport events</span>
<span class="cm"> * @lport: The lport which is receiving the event</span>
<span class="cm"> * @rdata: private remote port data</span>
<span class="cm"> * @event: The event that occurred</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock should not be held when calling</span>
<span class="cm"> *		 this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_rport_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">fc_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a %d event for port (%6.6x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span>
		     <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_EV_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPORT_ST_DNS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">dns_rdata</span> <span class="o">=</span> <span class="n">rdata</span><span class="p">;</span>
			<span class="n">fc_lport_enter_ns</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RNN_ID</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPORT_ST_FDMI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">ms_rdata</span> <span class="o">=</span> <span class="n">rdata</span><span class="p">;</span>
			<span class="n">fc_lport_enter_ms</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_DHBA</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received an READY event &quot;</span>
				     <span class="s">&quot;on port (%6.6x) for the directory &quot;</span>
				     <span class="s">&quot;server, but the lport is not &quot;</span>
				     <span class="s">&quot;in the DNS or FDMI state, it&#39;s in the &quot;</span>
				     <span class="s">&quot;%d state&quot;</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span>
				     <span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_EV_LOGO</span>:
	<span class="k">case</span> <span class="n">RPORT_EV_FAILED</span>:
	<span class="k">case</span> <span class="n">RPORT_EV_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">==</span> <span class="n">FC_FID_DIR_SERV</span><span class="p">)</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">dns_rdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">==</span> <span class="n">FC_FID_MGMT_SERV</span><span class="p">)</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">ms_rdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_EV_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_state() - Return a string which represents the lport&#39;s state</span>
<span class="cm"> * @lport: The lport whose state is to converted to a string</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">fc_lport_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">fc_lport_state_names</span><span class="p">[</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_ptp_setup() - Create an rport for point-to-point mode</span>
<span class="cm"> * @lport:	 The lport to attach the ptp rport to</span>
<span class="cm"> * @remote_fid:	 The FID of the ptp rport</span>
<span class="cm"> * @remote_wwpn: The WWPN of the ptp rport</span>
<span class="cm"> * @remote_wwnn: The WWNN of the ptp rport</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_ptp_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">remote_fid</span><span class="p">,</span> <span class="n">u64</span> <span class="n">remote_wwpn</span><span class="p">,</span>
			       <span class="n">u64</span> <span class="n">remote_wwnn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="p">);</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_create</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">remote_fid</span><span class="p">);</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">remote_wwpn</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">remote_wwnn</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_login</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="p">);</span>

	<span class="n">fc_lport_enter_ready</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_get_host_port_state() - Return the port state of the given Scsi_Host</span>
<span class="cm"> * @shost:  The SCSI host whose port state is to be determined</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_get_host_port_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
		<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_LINKDOWN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LPORT_ST_READY</span>:
			<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_ONLINE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_OFFLINE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_get_host_port_state</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_get_host_speed() - Return the speed of the given Scsi_Host</span>
<span class="cm"> * @shost: The SCSI host whose port speed is to be determined</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_get_host_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_speed</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_get_host_speed</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_get_host_stats() - Return the Scsi_Host&#39;s statistics</span>
<span class="cm"> * @shost: The SCSI host whose statistics are to be returned</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="nf">fc_get_host_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="n">fcoe_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fcp_in_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fcp_out_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fcoe_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host_stats</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fcoe_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_host_statistics</span><span class="p">));</span>

	<span class="n">jiffies_to_timespec</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v0</span><span class="p">);</span>
	<span class="n">jiffies_to_timespec</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">boot_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">);</span>
	<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">seconds_since_last_reset</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">v1</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fcoe_dev_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>

		<span class="n">stats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dev_stats</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">TxFrames</span><span class="p">;</span>
		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">tx_words</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">TxWords</span><span class="p">;</span>
		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">rx_frames</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxFrames</span><span class="p">;</span>
		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">rx_words</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxWords</span><span class="p">;</span>
		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">error_frames</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">ErrorFrames</span><span class="p">;</span>
		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">invalid_crc_count</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">InvalidCRCCount</span><span class="p">;</span>
		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">fcp_input_requests</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">InputRequests</span><span class="p">;</span>
		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">fcp_output_requests</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">OutputRequests</span><span class="p">;</span>
		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">fcp_control_requests</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">ControlRequests</span><span class="p">;</span>
		<span class="n">fcp_in_bytes</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">InputBytes</span><span class="p">;</span>
		<span class="n">fcp_out_bytes</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">OutputBytes</span><span class="p">;</span>
		<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">link_failure_count</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">LinkFailureCount</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">fcp_input_megabytes</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">fcp_in_bytes</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">fcp_output_megabytes</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">fcp_out_bytes</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">lip_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">nos_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">loss_of_sync_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">loss_of_signal_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">prim_seq_protocol_err_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fcoe_stats</span><span class="o">-&gt;</span><span class="n">dumped_frames</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fcoe_stats</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_get_host_stats</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_flogi_fill() - Fill in FLOGI command for request</span>
<span class="cm"> * @lport: The local port the FLOGI is for</span>
<span class="cm"> * @flogi: The FLOGI command</span>
<span class="cm"> * @op:	   The opcode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_flogi_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">flogi</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_els_csp</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_cssp</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">flogi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flogi</span><span class="p">));</span>
	<span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">);</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">);</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_hi_ver</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_lo_ver</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_bb_cred</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>	<span class="cm">/* this gets set by gateway */</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_bb_data</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_cssp</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* class 3 parameters */</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_class</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FC_CPC_VALID</span> <span class="o">|</span> <span class="n">FC_CPC_SEQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">!=</span> <span class="n">ELS_FLOGI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_features</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FC_SP_FT_CIRO</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_tot_seq</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>	<span class="cm">/* seq. we accept */</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_rel_off</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sp_e_d_tov</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">);</span>

		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_rdfs</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_con_seq</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">cp_open_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_add_fc4_type() - Add a supported FC-4 type to a local port</span>
<span class="cm"> * @lport: The local port to add a new FC-4 type to</span>
<span class="cm"> * @type:  The new FC-4 type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_add_fc4_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_fh_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>

	<span class="n">mp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">fcts</span><span class="p">.</span><span class="n">ff_type_map</span><span class="p">[</span><span class="n">type</span> <span class="o">/</span> <span class="n">FC_NS_BPW</span><span class="p">];</span>
	<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">mp</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">type</span> <span class="o">%</span> <span class="n">FC_NS_BPW</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_recv_rlir_req() - Handle received Registered Link Incident Report.</span>
<span class="cm"> * @lport: Fibre Channel local port receiving the RLIR</span>
<span class="cm"> * @fp:	   The RLIR request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_recv_rlir_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received RLIR request while in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LS_ACC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_recv_echo_req() - Handle received ECHO request</span>
<span class="cm"> * @lport: The local port receiving the ECHO</span>
<span class="cm"> * @fp:	   ECHO request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_recv_echo_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">in_fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received ECHO request while in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fr_len</span><span class="p">(</span><span class="n">in_fp</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">in_fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="o">*</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">dp</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ELS_LS_ACC</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">fc_fill_reply_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">in_fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">in_fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_recv_rnid_req() - Handle received Request Node ID data request</span>
<span class="cm"> * @lport: The local port receiving the RNID</span>
<span class="cm"> * @fp:	   The RNID request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_recv_rnid_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">in_fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_rnid</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fc_els_rnid_resp</span> <span class="n">rnid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_els_rnid_cid</span> <span class="n">cid</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_els_rnid_gen</span> <span class="n">gen</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">rjt_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received RNID request while in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">in_fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_LOGIC</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NONE</span><span class="p">;</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">in_fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rjt_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rnid_fmt</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">!=</span> <span class="n">ELS_RNIDF_GEN</span> <span class="o">||</span>
		    <span class="n">ntohl</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">rnid_gen</span><span class="p">.</span><span class="n">rnid_atype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">ELS_RNIDF_NONE</span><span class="p">;</span>	<span class="cm">/* nothing to provide */</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rnid</span><span class="p">.</span><span class="n">rnid_cmd</span> <span class="o">=</span> <span class="n">ELS_LS_ACC</span><span class="p">;</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rnid</span><span class="p">.</span><span class="n">rnid_fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rnid</span><span class="p">.</span><span class="n">rnid_cid_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">);</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">rnid_wwpn</span> <span class="o">=</span> <span class="n">htonll</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>
			<span class="n">rp</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">rnid_wwnn</span> <span class="o">=</span> <span class="n">htonll</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">ELS_RNIDF_GEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rp</span><span class="o">-&gt;</span><span class="n">rnid</span><span class="p">.</span><span class="n">rnid_sid_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">rnid_gen</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">fc_fill_reply_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">in_fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">in_fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_recv_logo_req() - Handle received fabric LOGO request</span>
<span class="cm"> * @lport: The local port receiving the LOGO</span>
<span class="cm"> * @fp:	   The LOGO request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is exected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_recv_logo_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LS_ACC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">fc_lport_enter_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_fabric_login() - Start the lport state machine</span>
<span class="cm"> * @lport: The local port that should log into the fabric</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function should not be called</span>
<span class="cm"> *		 with the lport lock held.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_fabric_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPORT_ST_DISABLED</span> <span class="o">||</span>
	    <span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPORT_ST_LOGO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RESET</span><span class="p">);</span>
		<span class="n">fc_lport_enter_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_fabric_login</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __fc_linkup() - Handler for transport linkup events</span>
<span class="cm"> * @lport: The lport whose link is up</span>
<span class="cm"> *</span>
<span class="cm"> * Locking: must be called with the lp_mutex held</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__fc_linkup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPORT_ST_RESET</span><span class="p">)</span>
			<span class="n">fc_lport_enter_flogi</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_linkup() - Handler for transport linkup events</span>
<span class="cm"> * @lport: The local port whose link is up</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_linkup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;host%d: libfc: Link up on port (%6.6x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">__fc_linkup</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_linkup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __fc_linkdown() - Handler for transport linkdown events</span>
<span class="cm"> * @lport: The lport whose link is down</span>
<span class="cm"> *</span>
<span class="cm"> * Locking: must be called with the lp_mutex held</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__fc_linkdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fc_lport_enter_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">fcp_cleanup</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_linkdown() - Handler for transport linkdown events</span>
<span class="cm"> * @lport: The local port whose link is down</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_linkdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;host%d: libfc: Link down on port (%6.6x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">__fc_linkdown</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_linkdown</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_fabric_logoff() - Logout of the fabric</span>
<span class="cm"> * @lport: The local port to logoff the fabric</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	0 for success, -1 for failure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_fabric_logoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">disc_stop_final</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dns_rdata</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dns_rdata</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_flush_queue</span><span class="p">();</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">fc_lport_enter_logo</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">retry_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_fabric_logoff</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_destroy() - Unregister a fc_lport</span>
<span class="cm"> * @lport: The local port to unregister</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> * exit routine for fc_lport instance</span>
<span class="cm"> * clean-up all the allocated memory</span>
<span class="cm"> * and free up other system resources.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_lport_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LPORT_ST_DISABLED</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span> <span class="o">=</span> <span class="n">fc_frame_drop</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">fcp_abort_io</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">disc_stop_final</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_mgr_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">retry_work</span><span class="p">);</span>
	<span class="n">fc_fc4_del_lport</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_lport_destroy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_set_mfs() - Set the maximum frame size for a local port</span>
<span class="cm"> * @lport: The local port to set the MFS for</span>
<span class="cm"> * @mfs:   The new MFS</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_set_mfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mfs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_mfs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="n">old_mfs</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mfs</span> <span class="o">&gt;=</span> <span class="n">FC_MIN_MAX_FRAME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mfs</span> <span class="o">&gt;</span> <span class="n">FC_MAX_FRAME</span><span class="p">)</span>
			<span class="n">mfs</span> <span class="o">=</span> <span class="n">FC_MAX_FRAME</span><span class="p">;</span>
		<span class="n">mfs</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span><span class="p">);</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span> <span class="o">=</span> <span class="n">mfs</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">mfs</span> <span class="o">&lt;</span> <span class="n">old_mfs</span><span class="p">)</span>
		<span class="n">fc_lport_enter_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_set_mfs</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_disc_callback() - Callback for discovery events</span>
<span class="cm"> * @lport: The local port receiving the event</span>
<span class="cm"> * @event: The discovery event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_disc_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">fc_disc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DISC_EV_SUCCESS</span>:
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Discovery succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISC_EV_FAILED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;host%d: libfc: &quot;</span>
		       <span class="s">&quot;Discovery failed for port (%6.6x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
		<span class="n">fc_lport_enter_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISC_EV_NONE</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_ready() - Enter the ready state and start discovery</span>
<span class="cm"> * @lport: The local port that is ready</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered READY from state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_READY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span>
		<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_ACTIVE</span><span class="p">);</span>
	<span class="n">fc_vports_linkchange</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">disc_start</span><span class="p">(</span><span class="n">fc_lport_disc_callback</span><span class="p">,</span> <span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_set_port_id() - set the local port Port ID</span>
<span class="cm"> * @lport: The local port which will have its Port ID set.</span>
<span class="cm"> * @port_id: The new port ID.</span>
<span class="cm"> * @fp: The frame containing the incoming request, or NULL.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_set_port_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_id</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_id</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;host%d: Assigned Port ID %6.6x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">port_id</span><span class="p">;</span>

	<span class="cm">/* Update the fc_host */</span>
	<span class="n">fc_host_port_id</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">port_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">lport_set_port_id</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">lport_set_port_id</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_set_port_id() - set the local port Port ID for point-to-multipoint</span>
<span class="cm"> * @lport: The local port which will have its Port ID set.</span>
<span class="cm"> * @port_id: The new port ID.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the lower-level driver when transport sets the local port_id.</span>
<span class="cm"> * This is used in VN_port to VN_port mode for FCoE, and causes FLOGI and</span>
<span class="cm"> * discovery to be skipped.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_lport_set_local_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="n">fc_lport_set_port_id</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RESET</span>:
	<span class="k">case</span> <span class="n">LPORT_ST_FLOGI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">port_id</span><span class="p">)</span>
			<span class="n">fc_lport_enter_ready</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_lport_set_local_id</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_recv_flogi_req() - Receive a FLOGI request</span>
<span class="cm"> * @lport: The local port that received the request</span>
<span class="cm"> * @rx_fp: The FLOGI frame</span>
<span class="cm"> *</span>
<span class="cm"> * A received FLOGI request indicates a point-to-point connection.</span>
<span class="cm"> * Accept it with the common service parameters indicating our N port.</span>
<span class="cm"> * Set up to do a PLOGI if we have the higher-number WWPN.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_recv_flogi_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">rx_fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">new_flp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">remote_wwpn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">remote_fid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">local_fid</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received FLOGI request while in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">remote_fid</span> <span class="o">=</span> <span class="n">fc_frame_sid</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">);</span>
	<span class="n">flp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">remote_wwpn</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remote_wwpn</span> <span class="o">==</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;host%d: libfc: Received FLOGI from port &quot;</span>
		       <span class="s">&quot;with same WWPN %16.16llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">remote_wwpn</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;FLOGI from port WWPN %16.16llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">remote_wwpn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX what is the right thing to do for FIDs?</span>
<span class="cm">	 * The originator might expect our S_ID to be 0xfffffe.</span>
<span class="cm">	 * But if so, both of us could end up with the same FID.</span>
<span class="cm">	 */</span>
	<span class="n">local_fid</span> <span class="o">=</span> <span class="n">FC_LOCAL_PTP_FID_LO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remote_wwpn</span> <span class="o">&lt;</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_fid</span> <span class="o">=</span> <span class="n">FC_LOCAL_PTP_FID_HI</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remote_fid</span> <span class="o">||</span> <span class="n">remote_fid</span> <span class="o">==</span> <span class="n">local_fid</span><span class="p">)</span>
			<span class="n">remote_fid</span> <span class="o">=</span> <span class="n">FC_LOCAL_PTP_FID_LO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remote_fid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remote_fid</span> <span class="o">=</span> <span class="n">FC_LOCAL_PTP_FID_HI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc_lport_set_port_id</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">local_fid</span><span class="p">,</span> <span class="n">rx_fp</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_flp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flp</span><span class="p">));</span>
		<span class="n">fc_lport_flogi_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">new_flp</span><span class="p">,</span> <span class="n">ELS_FLOGI</span><span class="p">);</span>
		<span class="n">new_flp</span><span class="o">-&gt;</span><span class="n">fl_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ELS_LS_ACC</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Send the response.  If this fails, the originator should</span>
<span class="cm">		 * repeat the sequence.</span>
<span class="cm">		 */</span>
		<span class="n">fc_fill_reply_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">rx_fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_s_id</span><span class="p">,</span> <span class="n">local_fid</span><span class="p">);</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">,</span> <span class="n">remote_fid</span><span class="p">);</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fc_lport_ptp_setup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">remote_fid</span><span class="p">,</span> <span class="n">remote_wwpn</span><span class="p">,</span>
			   <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_recv_els_req() - The generic lport ELS request handler</span>
<span class="cm"> * @lport: The local port that received the request</span>
<span class="cm"> * @fp:	   The request frame</span>
<span class="cm"> *</span>
<span class="cm"> * This function will see if the lport handles the request or</span>
<span class="cm"> * if an rport should handle the request.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function should not be called with the lport</span>
<span class="cm"> *		 lock held because it will grab the lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_recv_els_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">recv</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle special ELS cases like FLOGI, LOGO, and</span>
<span class="cm">	 * RSCN here.  These don&#39;t require a session.</span>
<span class="cm">	 * Even if we had a session, it might not be ready.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
		<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check opcode.</span>
<span class="cm">		 */</span>
		<span class="n">recv</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_recv_req</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ELS_FLOGI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">point_to_multipoint</span><span class="p">)</span>
				<span class="n">recv</span> <span class="o">=</span> <span class="n">fc_lport_recv_flogi_req</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELS_LOGO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fc_frame_sid</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_FID_FLOGI</span><span class="p">)</span>
				<span class="n">recv</span> <span class="o">=</span> <span class="n">fc_lport_recv_logo_req</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELS_RSCN</span>:
			<span class="n">recv</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">disc_recv_req</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELS_ECHO</span>:
			<span class="n">recv</span> <span class="o">=</span> <span class="n">fc_lport_recv_echo_req</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELS_RLIR</span>:
			<span class="n">recv</span> <span class="o">=</span> <span class="n">fc_lport_recv_rlir_req</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELS_RNID</span>:
			<span class="n">recv</span> <span class="o">=</span> <span class="n">fc_lport_recv_rnid_req</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">recv</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fc_lport_els_prli</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span> <span class="n">u32</span> <span class="n">spp_len</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">spp_in</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">spp_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">FC_SPP_RESP_INVL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fc4_prov</span> <span class="n">fc_lport_els_prov</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prli</span> <span class="o">=</span> <span class="n">fc_lport_els_prli</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recv</span> <span class="o">=</span> <span class="n">fc_lport_recv_els_req</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_recv_req() - The generic lport request handler</span>
<span class="cm"> * @lport: The lport that received the request</span>
<span class="cm"> * @fp: The frame the request is in</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function should not be called with the lport</span>
<span class="cm"> *		 lock held because it may grab the lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_recv_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">fr_seq</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc4_prov</span> <span class="o">*</span><span class="n">prov</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use RCU read lock and module_lock to be sure module doesn&#39;t</span>
<span class="cm">	 * deregister and get unloaded while we&#39;re calling it.</span>
<span class="cm">	 * try_module_get() is inlined and accepts a NULL parameter.</span>
<span class="cm">	 * Only ELSes and FCP target ops should come through here.</span>
<span class="cm">	 * The locking is unfortunate, and a better scheme is being sought.</span>
<span class="cm">	 */</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">&gt;=</span> <span class="n">FC_FC4_PROV_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="n">prov</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">fc_passive_prov</span><span class="p">[</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prov</span> <span class="o">||</span> <span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">prov</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">prov</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">prov</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">drop:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;dropping unexpected frame type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_done</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_reset() - Reset a local port</span>
<span class="cm"> * @lport: The local port which should be reset</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This functions should not be called with the</span>
<span class="cm"> *		 lport lock held.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_lport_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">retry_work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">fc_lport_enter_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_lport_reset</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_reset_locked() - Reset the local port w/ the lport lock held</span>
<span class="cm"> * @lport: The local port to be reset</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_reset_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dns_rdata</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dns_rdata</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="p">);</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">ptp_rdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">disc_stop</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_mgr_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fc_host_fabric_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">point_to_multipoint</span> <span class="o">||</span> <span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">))</span>
		<span class="n">fc_lport_set_port_id</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_enter_reset() - Reset the local port</span>
<span class="cm"> * @lport: The local port to be reset</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered RESET state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPORT_ST_DISABLED</span> <span class="o">||</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">LPORT_ST_LOGO</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
			<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_INITIALIZING</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fc_vport_set_state</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span><span class="p">,</span> <span class="n">FC_VPORT_LINKDOWN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RESET</span><span class="p">);</span>
	<span class="n">fc_host_post_event</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">fc_get_event_number</span><span class="p">(),</span>
			   <span class="n">FCH_EVT_LIPRESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fc_vports_linkchange</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_lport_reset_locked</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
		<span class="n">fc_lport_enter_flogi</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_enter_disabled() - Disable the local port</span>
<span class="cm"> * @lport: The local port to be reset</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered disabled state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_DISABLED</span><span class="p">);</span>
	<span class="n">fc_vports_linkchange</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_lport_reset_locked</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_error() - Handler for any errors</span>
<span class="cm"> * @lport: The local port that the error was on</span>
<span class="cm"> * @fp:	   The error code encoded in a frame pointer</span>
<span class="cm"> *</span>
<span class="cm"> * If the error was caused by a resource allocation failure</span>
<span class="cm"> * then wait for half a second and retry, otherwise retry</span>
<span class="cm"> * after the e_d_tov time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Error %ld in state %s, retries %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">),</span>
		     <span class="n">lport</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">FC_EX_CLOSED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Memory allocation failure, or the exchange timed out</span>
<span class="cm">	 * or we received LS_RJT.</span>
<span class="cm">	 * Retry after delay</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">max_retry_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">delay</span> <span class="o">=</span>	<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">);</span>

		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">retry_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fc_lport_enter_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_ns_resp() - Handle response to a name server</span>
<span class="cm"> *			registration exchange</span>
<span class="cm"> * @sp:	    current sequence in exchange</span>
<span class="cm"> * @fp:	    response frame</span>
<span class="cm"> * @lp_arg: Fibre Channel host port instance</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function will be called without the lport lock</span>
<span class="cm"> * held, but it will lock, call an _enter_* function or fc_lport_error()</span>
<span class="cm"> * and then unlock the lport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_ns_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">lp_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lp_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_ct_hdr</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a ns %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">FC_EX_CLOSED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">LPORT_ST_RNN_ID</span> <span class="o">||</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">LPORT_ST_RFF_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a name server response, &quot;</span>
			     <span class="s">&quot;but in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ct</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span> <span class="o">&amp;&amp;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">==</span> <span class="n">FC_TYPE_CT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">ct_fs_type</span> <span class="o">==</span> <span class="n">FC_FST_DIR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">ct_fs_subtype</span> <span class="o">==</span> <span class="n">FC_NS_SUBTYPE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ntohs</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">ct_cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_FS_ACC</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LPORT_ST_RNN_ID</span>:
			<span class="n">fc_lport_enter_ns</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RSNN_NN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPORT_ST_RSNN_NN</span>:
			<span class="n">fc_lport_enter_ns</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RSPN_ID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPORT_ST_RSPN_ID</span>:
			<span class="n">fc_lport_enter_ns</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RFT_ID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPORT_ST_RFT_ID</span>:
			<span class="n">fc_lport_enter_ns</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RFF_ID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPORT_ST_RFF_ID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">fdmi_enabled</span><span class="p">)</span>
				<span class="n">fc_lport_enter_fdmi</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">fc_lport_enter_scr</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* should have already been caught by state checks */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_ms_resp() - Handle response to a management server</span>
<span class="cm"> *			exchange</span>
<span class="cm"> * @sp:	    current sequence in exchange</span>
<span class="cm"> * @fp:	    response frame</span>
<span class="cm"> * @lp_arg: Fibre Channel host port instance</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function will be called without the lport lock</span>
<span class="cm"> * held, but it will lock, call an _enter_* function or fc_lport_error()</span>
<span class="cm"> * and then unlock the lport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_ms_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">lp_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lp_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_ct_hdr</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a ms %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">FC_EX_CLOSED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">LPORT_ST_RHBA</span> <span class="o">||</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">LPORT_ST_DPRT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a management server response, &quot;</span>
			     <span class="s">&quot;but in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ct</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span> <span class="o">&amp;&amp;</span> <span class="n">ct</span> <span class="o">&amp;&amp;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">==</span> <span class="n">FC_TYPE_CT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">ct_fs_type</span> <span class="o">==</span> <span class="n">FC_FST_MGMT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">ct_fs_subtype</span> <span class="o">==</span> <span class="n">FC_FDMI_SUBTYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a management server response, &quot;</span>
				    <span class="s">&quot;reason=%d explain=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">ct_reason</span><span class="p">,</span>
				    <span class="n">ct</span><span class="o">-&gt;</span><span class="n">ct_explan</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LPORT_ST_RHBA</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">ct_cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_FS_ACC</span><span class="p">)</span>
				<span class="n">fc_lport_enter_ms</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RPA</span><span class="p">);</span>
			<span class="k">else</span> <span class="cm">/* Error Skip RPA */</span>
				<span class="n">fc_lport_enter_scr</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPORT_ST_RPA</span>:
			<span class="n">fc_lport_enter_scr</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPORT_ST_DPRT</span>:
			<span class="n">fc_lport_enter_ms</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RHBA</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LPORT_ST_DHBA</span>:
			<span class="n">fc_lport_enter_ms</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_DPRT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* should have already been caught by state checks */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Invalid Frame? */</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_scr_resp() - Handle response to State Change Register (SCR) request</span>
<span class="cm"> * @sp:	    current sequence in SCR exchange</span>
<span class="cm"> * @fp:	    response frame</span>
<span class="cm"> * @lp_arg: Fibre Channel lport port instance that sent the registration request</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function will be called without the lport lock</span>
<span class="cm"> * held, but it will lock, call an _enter_* function or fc_lport_error</span>
<span class="cm"> * and then unlock the lport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_scr_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">lp_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lp_arg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a SCR %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">FC_EX_CLOSED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LPORT_ST_SCR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a SCR response, but in state &quot;</span>
			     <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_LS_ACC</span><span class="p">)</span>
		<span class="n">fc_lport_enter_ready</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_enter_scr() - Send a SCR (State Change Register) request</span>
<span class="cm"> * @lport: The local port to register for state changes</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_scr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered SCR state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_SCR</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_scr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_FID_FCTRL</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ELS_SCR</span><span class="p">,</span>
				  <span class="n">fc_lport_scr_resp</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span>
				  <span class="mi">2</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">))</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_enter_ns() - register some object with the name server</span>
<span class="cm"> * @lport: Fibre Channel local port to register</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_lport_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fc_ns_req</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ct_hdr</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered %s state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state_names</span><span class="p">[</span><span class="n">state</span><span class="p">],</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RNN_ID</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FC_NS_RNN_ID</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rn_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RSNN_NN</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="mi">255</span><span class="p">);</span>
		<span class="cm">/* if there is no symbolic name, skip to RFT_ID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fc_lport_enter_ns</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RFT_ID</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FC_NS_RSNN_NN</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rsnn</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RSPN_ID</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="mi">255</span><span class="p">);</span>
		<span class="cm">/* if there is no symbolic name, skip to RFT_ID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fc_lport_enter_ns</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_RFT_ID</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FC_NS_RSPN_ID</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rspn</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RFT_ID</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FC_NS_RFT_ID</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rft</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RFF_ID</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FC_NS_RFF_ID</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ns_rff_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_FID_DIR_SERV</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				  <span class="n">fc_lport_ns_resp</span><span class="p">,</span>
				  <span class="n">lport</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">))</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_rport_operations</span> <span class="n">fc_lport_rport_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">event_callback</span> <span class="o">=</span> <span class="n">fc_lport_rport_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_dns() - Create a fc_rport for the name server</span>
<span class="cm"> * @lport: The local port requesting a remote port for the name server</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_dns</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered DNS state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_DNS</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_create</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_FID_DIR_SERV</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdata</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fc_lport_rport_ops</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_login</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_enter_ms() - management server commands</span>
<span class="cm"> * @lport: Fibre Channel local port to register</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_lport_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fc_fdmi_req</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ct_hdr</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numattrs</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered %s state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state_names</span><span class="p">[</span><span class="n">state</span><span class="p">],</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RHBA</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FC_FDMI_RHBA</span><span class="p">;</span>
		<span class="cm">/* Number of HBA Attributes */</span>
		<span class="n">numattrs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_rhba</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">numattrs</span> <span class="o">*</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_NODENAME_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_MANUFACTURER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_SERIALNUMBER_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_MODEL_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_MODELDESCR_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_HARDWAREVERSION_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_DRIVERVERSION_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_OPTIONROMVERSION_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_FIRMWAREVERSION_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_HBA_ATTR_OSNAMEVERSION_LEN</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RPA</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FC_FDMI_RPA</span><span class="p">;</span>
		<span class="cm">/* Number of Port Attributes */</span>
		<span class="n">numattrs</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_rpa</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_attr_entry</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">numattrs</span> <span class="o">*</span> <span class="n">FC_FDMI_ATTR_ENTRY_HEADER_LEN</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_FC4TYPES_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_SUPPORTEDSPEED_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_CURRENTPORTSPEED_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_MAXFRAMESIZE_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_OSDEVICENAME_LEN</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">FC_FDMI_PORT_ATTR_HOSTNAME_LEN</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_DPRT</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FC_FDMI_DPRT</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_dprt</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_DHBA</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">FC_FDMI_DHBA</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_fdmi_dhba</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Cmd=0x%x Len %d size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_FID_MGMT_SERV</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				  <span class="n">fc_lport_ms_resp</span><span class="p">,</span>
				  <span class="n">lport</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">))</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_fdmi() - Create a fc_rport for the management server</span>
<span class="cm"> * @lport: The local port requesting a remote port for the management server</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_fdmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered FDMI state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_FDMI</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_create</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_FID_MGMT_SERV</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdata</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fc_lport_rport_ops</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_login</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_timeout() - Handler for the retry_work timer</span>
<span class="cm"> * @work: The work struct of the local port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_lport</span><span class="p">,</span>
			     <span class="n">retry_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LPORT_ST_DISABLED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_READY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RESET</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_FLOGI</span>:
		<span class="n">fc_lport_enter_flogi</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_DNS</span>:
		<span class="n">fc_lport_enter_dns</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RNN_ID</span>:
	<span class="k">case</span> <span class="n">LPORT_ST_RSNN_NN</span>:
	<span class="k">case</span> <span class="n">LPORT_ST_RSPN_ID</span>:
	<span class="k">case</span> <span class="n">LPORT_ST_RFT_ID</span>:
	<span class="k">case</span> <span class="n">LPORT_ST_RFF_ID</span>:
		<span class="n">fc_lport_enter_ns</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_FDMI</span>:
		<span class="n">fc_lport_enter_fdmi</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_RHBA</span>:
	<span class="k">case</span> <span class="n">LPORT_ST_RPA</span>:
	<span class="k">case</span> <span class="n">LPORT_ST_DHBA</span>:
	<span class="k">case</span> <span class="n">LPORT_ST_DPRT</span>:
		<span class="n">fc_lport_enter_ms</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_SCR</span>:
		<span class="n">fc_lport_enter_scr</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LPORT_ST_LOGO</span>:
		<span class="n">fc_lport_enter_logo</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_logo_resp() - Handle response to LOGO request</span>
<span class="cm"> * @sp:	    The sequence that the LOGO was on</span>
<span class="cm"> * @fp:	    The LOGO frame</span>
<span class="cm"> * @lp_arg: The lport port that received the LOGO request</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function will be called without the lport lock</span>
<span class="cm"> * held, but it will lock, call an _enter_* function or fc_lport_error()</span>
<span class="cm"> * and then unlock the lport.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_lport_logo_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">lp_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lp_arg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a LOGO %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">FC_EX_CLOSED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LPORT_ST_LOGO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a LOGO response, but in state &quot;</span>
			     <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_LS_ACC</span><span class="p">)</span>
		<span class="n">fc_lport_enter_disabled</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_lport_logo_resp</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_logo() - Logout of the fabric</span>
<span class="cm"> * @lport: The local port to be logged out</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_logo</span> <span class="o">*</span><span class="n">logo</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered LOGO state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_LOGO</span><span class="p">);</span>
	<span class="n">fc_vports_linkchange</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">logo</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_FID_FLOGI</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LOGO</span><span class="p">,</span>
				  <span class="n">fc_lport_logo_resp</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span>
				  <span class="mi">2</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">))</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_flogi_resp() - Handle response to FLOGI request</span>
<span class="cm"> * @sp:	    The sequence that the FLOGI was on</span>
<span class="cm"> * @fp:	    The FLOGI response frame</span>
<span class="cm"> * @lp_arg: The lport port that received the FLOGI response</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function will be called without the lport lock</span>
<span class="cm"> * held, but it will lock, call an _enter_* function or fc_lport_error()</span>
<span class="cm"> * and then unlock the lport.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_lport_flogi_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">lp_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lp_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">did</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">csp_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r_a_tov</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">e_d_tov</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mfs</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a FLOGI %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">FC_EX_CLOSED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LPORT_ST_FLOGI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Received a FLOGI response, but in state &quot;</span>
			     <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">did</span> <span class="o">=</span> <span class="n">fc_frame_did</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">!=</span> <span class="n">FC_RCTL_ELS_REP</span> <span class="o">||</span> <span class="n">did</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ELS_LS_ACC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;FLOGI not accepted or bad response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;FLOGI bad response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mfs</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_bb_data</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">FC_SP_BB_DATA_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mfs</span> <span class="o">&lt;</span> <span class="n">FC_SP_MIN_MAX_PAYLOAD</span> <span class="o">||</span> <span class="n">mfs</span> <span class="o">&gt;</span> <span class="n">FC_SP_MAX_MAX_PAYLOAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;FLOGI bad mfs:%hu response, &quot;</span>
			     <span class="s">&quot;lport-&gt;mfs:%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mfs</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mfs</span> <span class="o">&lt;=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span> <span class="o">=</span> <span class="n">mfs</span><span class="p">;</span>
		<span class="n">fc_host_maxframe_size</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">mfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">csp_flags</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_features</span><span class="p">);</span>
	<span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_r_a_tov</span><span class="p">);</span>
	<span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_e_d_tov</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csp_flags</span> <span class="o">&amp;</span> <span class="n">FC_SP_FT_EDTR</span><span class="p">)</span>
		<span class="n">e_d_tov</span> <span class="o">/=</span> <span class="mi">1000000</span><span class="p">;</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">npiv_enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">csp_flags</span> <span class="o">&amp;</span> <span class="n">FC_SP_FT_NPIV_ACC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">csp_flags</span> <span class="o">&amp;</span> <span class="n">FC_SP_FT_FPORT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e_d_tov</span> <span class="o">&gt;</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">)</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">e_d_tov</span><span class="p">;</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">e_d_tov</span><span class="p">;</span>
		<span class="n">fc_lport_set_port_id</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;host%d: libfc: &quot;</span>
		       <span class="s">&quot;Port (%6.6x) entered &quot;</span>
		       <span class="s">&quot;point-to-point mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">did</span><span class="p">);</span>
		<span class="n">fc_lport_ptp_setup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fc_frame_sid</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span>
				   <span class="n">get_unaligned_be64</span><span class="p">(</span>
					   <span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">),</span>
				   <span class="n">get_unaligned_be64</span><span class="p">(</span>
					   <span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">e_d_tov</span><span class="p">;</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">r_a_tov</span><span class="p">;</span>
		<span class="n">fc_host_fabric_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">);</span>
		<span class="n">fc_lport_set_port_id</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="n">fc_lport_enter_dns</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_lport_flogi_resp</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_flogi() - Send a FLOGI request to the fabric manager</span>
<span class="cm"> * @lport: Fibre Channel local port to be logged in to the fabric</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_enter_flogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">FC_LPORT_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="s">&quot;Entered FLOGI state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_lport_state</span><span class="p">(</span><span class="n">lport</span><span class="p">));</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_FLOGI</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">point_to_multipoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span>
			<span class="n">fc_lport_enter_ready</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_flogi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_FID_FLOGI</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span>
				  <span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">?</span> <span class="n">ELS_FDISC</span> <span class="o">:</span> <span class="n">ELS_FLOGI</span><span class="p">,</span>
				  <span class="n">fc_lport_flogi_resp</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span>
				  <span class="n">lport</span><span class="o">-&gt;</span><span class="n">vport</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">:</span>
				  <span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">))</span>
		<span class="n">fc_lport_error</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_config() - Configure a fc_lport</span>
<span class="cm"> * @lport: The local port to be configured</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_lport_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">retry_work</span><span class="p">,</span> <span class="n">fc_lport_timeout</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="n">fc_lport_state_enter</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">LPORT_ST_DISABLED</span><span class="p">);</span>

	<span class="n">fc_lport_add_fc4_type</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_TYPE_FCP</span><span class="p">);</span>
	<span class="n">fc_lport_add_fc4_type</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_TYPE_CT</span><span class="p">);</span>
	<span class="n">fc_fc4_conf_lport_params</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">FC_TYPE_FCP</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_lport_config</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_init() - Initialize the lport layer for a local port</span>
<span class="cm"> * @lport: The local port to initialize the exchange layer for</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_lport_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">lport_recv</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">lport_recv</span> <span class="o">=</span> <span class="n">fc_lport_recv_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">lport_reset</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">lport_reset</span> <span class="o">=</span> <span class="n">fc_lport_reset</span><span class="p">;</span>

	<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPORT</span><span class="p">;</span>
	<span class="n">fc_host_node_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">;</span>
	<span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">;</span>
	<span class="n">fc_host_supported_classes</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)));</span>
	<span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fc_host_supported_fc4s</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* This value is also unchanging */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fc_host_active_fc4s</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">fc_host_active_fc4s</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)));</span>
	<span class="n">fc_host_active_fc4s</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fc_host_active_fc4s</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fc_host_maxframe_size</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">;</span>
	<span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_supported_speeds</span> <span class="o">&amp;</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">)</span>
		<span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">|=</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">link_supported_speeds</span> <span class="o">&amp;</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">)</span>
		<span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">|=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
	<span class="n">fc_fc4_add_lport</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_lport_init</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_bsg_resp() - The common response handler for FC Passthrough requests</span>
<span class="cm"> * @sp:	      The sequence for the FC Passthrough response</span>
<span class="cm"> * @fp:	      The response frame</span>
<span class="cm"> * @info_arg: The BSG info that the response is for</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_lport_bsg_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">info_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_bsg_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">info_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">job</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">FC_EX_CLOSED</span><span class="p">)</span> <span class="o">?</span>
			<span class="o">-</span><span class="n">ECONNABORTED</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">state_flags</span> <span class="o">|=</span> <span class="n">FC_RQST_STATE_DONE</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">fr_len</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fr_sof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_SOF_I3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ntohs</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_seq_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Get the response code from the first frame payload */</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rsp_code</span> <span class="o">==</span> <span class="n">FC_FS_ACC</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">ntohs</span><span class="p">(((</span><span class="k">struct</span> <span class="n">fc_ct_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ct_cmd</span><span class="p">)</span> <span class="o">:</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

		<span class="cm">/* Save the reply status of the job */</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_data</span><span class="p">.</span><span class="n">ctels_reply</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rsp_code</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">FC_CTELS_STATUS_OK</span> <span class="o">:</span> <span class="n">FC_CTELS_STATUS_REJECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">+=</span>
		<span class="n">fc_copy_buffer_to_sglist</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nents</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fr_eof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_EOF_T</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_f_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FC_FC_LAST_SEQ</span> <span class="o">|</span> <span class="n">FC_FC_END_SEQ</span><span class="p">))</span> <span class="o">==</span>
	    <span class="p">(</span><span class="n">FC_FC_LAST_SEQ</span> <span class="o">|</span> <span class="n">FC_FC_END_SEQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">&gt;</span>
		    <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">)</span>
			<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span>
				<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">state_flags</span> <span class="o">|=</span> <span class="n">FC_RQST_STATE_DONE</span><span class="p">;</span>
		<span class="n">job</span><span class="o">-&gt;</span><span class="n">job_done</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_els_request() - Send ELS passthrough request</span>
<span class="cm"> * @job:   The BSG Passthrough job</span>
<span class="cm"> * @lport: The local port sending the request</span>
<span class="cm"> * @did:   The destination port id</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fc_lport_els_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">did</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tov</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_bsg_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">sg_copy_to_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
			  <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
			  <span class="n">pp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">=</span> <span class="n">FC_RCTL_ELS_REQ</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">,</span> <span class="n">did</span><span class="p">);</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_s_id</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">=</span> <span class="n">FC_TYPE_ELS</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_f_ctl</span><span class="p">,</span> <span class="n">FC_FCTL_REQ</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_cs_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_df_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_parm_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rsp_code</span> <span class="o">=</span> <span class="n">ELS_LS_ACC</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">nents</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_seq_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fc_lport_bsg_resp</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">tov</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_ct_request() - Send CT Passthrough request</span>
<span class="cm"> * @job:   The BSG Passthrough job</span>
<span class="cm"> * @lport: The local port sending the request</span>
<span class="cm"> * @did:   The destination FC-ID</span>
<span class="cm"> * @tov:   The timeout period to wait for the response</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The lport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fc_lport_ct_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">did</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tov</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_bsg_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_ct_req</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_ct_hdr</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>
	<span class="n">ct</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">sg_copy_to_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
			  <span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
			  <span class="n">ct</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">=</span> <span class="n">FC_RCTL_DD_UNSOL_CTL</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">,</span> <span class="n">did</span><span class="p">);</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_s_id</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">=</span> <span class="n">FC_TYPE_CT</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_f_ctl</span><span class="p">,</span> <span class="n">FC_FCTL_REQ</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_cs_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_df_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_parm_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rsp_code</span> <span class="o">=</span> <span class="n">FC_FS_ACC</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">nents</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_seq_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fc_lport_bsg_resp</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">tov</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ECOMM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_lport_bsg_request() - The common entry point for sending</span>
<span class="cm"> *			    FC Passthrough requests</span>
<span class="cm"> * @job: The BSG passthrough job</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_lport_bsg_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">next_rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">did</span><span class="p">;</span>

	<span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">)</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">msgcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_BSG_RPT_ELS</span>:
		<span class="n">rport</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rdata</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fc_lport_els_request</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span>
					  <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_BSG_RPT_CT</span>:
		<span class="n">rport</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rdata</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fc_lport_ct_request</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span>
					 <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_BSG_HST_CT</span>:
		<span class="n">did</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_ct</span><span class="p">.</span><span class="n">port_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">did</span> <span class="o">==</span> <span class="n">FC_FID_DIR_SERV</span><span class="p">)</span>
			<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">dns_rdata</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">did</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdata</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">fc_lport_ct_request</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC_BSG_HST_ELS_NOLOGIN</span>:
		<span class="n">did</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">rqst_data</span><span class="p">.</span><span class="n">h_els</span><span class="p">.</span><span class="n">port_id</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fc_lport_els_request</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">did</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_lport_bsg_request</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
