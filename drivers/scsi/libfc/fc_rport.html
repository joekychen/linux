<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › libfc › fc_rport.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fc_rport.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright(c) 2007 - 2008 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Maintained at www.Open-FCoE.org</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * RPORT GENERAL INFO</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains all processing regarding fc_rports. It contains the</span>
<span class="cm"> * rport state machine and does all rport interaction with the transport class.</span>
<span class="cm"> * There should be no other places in libfc that interact directly with the</span>
<span class="cm"> * transport class in regards to adding and deleting rports.</span>
<span class="cm"> *</span>
<span class="cm"> * fc_rport&#39;s represent N_Port&#39;s within the fabric.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * RPORT LOCKING</span>
<span class="cm"> *</span>
<span class="cm"> * The rport should never hold the rport mutex and then attempt to acquire</span>
<span class="cm"> * either the lport or disc mutexes. The rport&#39;s mutex is considered lesser</span>
<span class="cm"> * than both the lport&#39;s mutex and the disc mutex. Refer to fc_lport.c for</span>
<span class="cm"> * more comments on the hierarchy.</span>
<span class="cm"> *</span>
<span class="cm"> * The locking strategy is similar to the lport&#39;s strategy. The lock protects</span>
<span class="cm"> * the rport&#39;s states and is held and released by the entry points to the rport</span>
<span class="cm"> * block. All _enter_* functions correspond to rport states and expect the rport</span>
<span class="cm"> * mutex to be locked before calling them. This means that rports only handle</span>
<span class="cm"> * one request or response at a time, since they&#39;re not critical for the I/O</span>
<span class="cm"> * path this potential over-use of the mutex is acceptable.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;scsi/libfc.h&gt;</span>
<span class="cp">#include &lt;scsi/fc_encode.h&gt;</span>

<span class="cp">#include &quot;fc_libfc.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">rport_event_queue</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_enter_flogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_enter_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_enter_prli</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_enter_rtv</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_enter_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_enter_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_enter_adisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_recv_plogi_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_recv_prli_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_recv_prlo_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_recv_logo_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fc_rport_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fc_rport_state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">RPORT_ST_INIT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Init&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RPORT_ST_FLOGI</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FLOGI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RPORT_ST_PLOGI_WAIT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;PLOGI_WAIT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RPORT_ST_PLOGI</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;PLOGI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RPORT_ST_PRLI</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;PRLI&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RPORT_ST_RTV</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RTV&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RPORT_ST_READY</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Ready&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RPORT_ST_ADISC</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ADISC&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">RPORT_ST_DELETE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Delete&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_lookup() - Lookup a remote port by port_id</span>
<span class="cm"> * @lport:   The local port to lookup the remote port on</span>
<span class="cm"> * @port_id: The remote port ID to look up</span>
<span class="cm"> *</span>
<span class="cm"> * The caller must hold either disc_mutex or rcu_read_lock().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="nf">fc_rport_lookup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">port_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">rports</span><span class="p">,</span> <span class="n">peers</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">==</span> <span class="n">port_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rdata</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_create() - Create a new remote port</span>
<span class="cm"> * @lport: The local port this remote port will be associated with</span>
<span class="cm"> * @ids:   The identifiers for the new remote port</span>
<span class="cm"> *</span>
<span class="cm"> * The remote port will start in the INIT state.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking note:  must be called with the disc_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="nf">fc_rport_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">port_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>

	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rdata</span><span class="p">;</span>

	<span class="n">rdata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdata</span><span class="p">)</span> <span class="o">+</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">rport_priv_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">port_id</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">FC_RPORT_ROLE_UNKNOWN</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">=</span> <span class="n">RPORT_ST_INIT</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">RPORT_EV_NONE</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FC_RP_FLAGS_REC_SUPPORTED</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">maxframe_size</span> <span class="o">=</span> <span class="n">FC_MIN_MAX_PAYLOAD</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">retry_work</span><span class="p">,</span> <span class="n">fc_rport_timeout</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">,</span> <span class="n">fc_rport_work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">!=</span> <span class="n">FC_FID_DIR_SERV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">lld_event_callback</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_event_callback</span><span class="p">;</span>
		<span class="n">list_add_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">peers</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">rports</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_destroy() - Free a remote port after last reference is released</span>
<span class="cm"> * @kref: The remote port&#39;s kref</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>

	<span class="n">rdata</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_rport_priv</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>
	<span class="n">kfree_rcu</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">rcu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_state() - Return a string identifying the remote port&#39;s state</span>
<span class="cm"> * @rdata: The remote port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">fc_rport_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">fc_rport_state_names</span><span class="p">[</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_set_rport_loss_tmo() - Set the remote port loss timeout</span>
<span class="cm"> * @rport:   The remote port that gets a new timeout value</span>
<span class="cm"> * @timeout: The new timeout value (in seconds)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_set_rport_loss_tmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_set_rport_loss_tmo</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_plogi_get_maxframe() - Get the maximum payload from the common service</span>
<span class="cm"> *			     parameters in a FLOGI frame</span>
<span class="cm"> * @flp:    The FLOGI or PLOGI payload</span>
<span class="cm"> * @maxval: The maximum frame size upper limit; this may be less than what</span>
<span class="cm"> *	    is in the service parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">fc_plogi_get_maxframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">flp</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mfs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get max payload from the common service parameters and the</span>
<span class="cm">	 * class 3 receive data field size.</span>
<span class="cm">	 */</span>
	<span class="n">mfs</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_bb_data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FC_SP_BB_DATA_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfs</span> <span class="o">&gt;=</span> <span class="n">FC_SP_MIN_MAX_PAYLOAD</span> <span class="o">&amp;&amp;</span> <span class="n">mfs</span> <span class="o">&lt;</span> <span class="n">maxval</span><span class="p">)</span>
		<span class="n">maxval</span> <span class="o">=</span> <span class="n">mfs</span><span class="p">;</span>
	<span class="n">mfs</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_cssp</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">cp_rdfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfs</span> <span class="o">&gt;=</span> <span class="n">FC_SP_MIN_MAX_PAYLOAD</span> <span class="o">&amp;&amp;</span> <span class="n">mfs</span> <span class="o">&lt;</span> <span class="n">maxval</span><span class="p">)</span>
		<span class="n">maxval</span> <span class="o">=</span> <span class="n">mfs</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">maxval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_state_enter() - Change the state of a remote port</span>
<span class="cm"> * @rdata: The remote port whose state should change</span>
<span class="cm"> * @new:   The new state</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: Called with the rport lock held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_state_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">fc_rport_state</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">!=</span> <span class="n">new</span><span class="p">)</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_work() - Handler for remote port events in the rport_event_queue</span>
<span class="cm"> * @work: Handle to the remote port being dequeued</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">port_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_rport_priv</span><span class="p">,</span> <span class="n">event_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fc_rport_libfc_priv</span> <span class="o">*</span><span class="n">rpriv</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fc_rport_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_operations</span> <span class="o">*</span><span class="n">rport_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_identifiers</span> <span class="n">ids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc4_prov</span> <span class="o">*</span><span class="n">prov</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
	<span class="n">rport_ops</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;work event %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_EV_READY</span>:
		<span class="n">ids</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">;</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">RPORT_EV_NONE</span><span class="p">;</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">major_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span>
			<span class="n">rport</span> <span class="o">=</span> <span class="n">fc_remote_port_add</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ids</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Failed to add the rport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
			<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">)</span>
			<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;rport already allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport</span><span class="p">;</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">maxframe_size</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">maxframe_size</span><span class="p">;</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">supported_classes</span><span class="p">;</span>

		<span class="n">rpriv</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="n">rpriv</span><span class="o">-&gt;</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
		<span class="n">rpriv</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">;</span>
		<span class="n">rpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">rpriv</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">;</span>
		<span class="n">rpriv</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rport_ops</span> <span class="o">&amp;&amp;</span> <span class="n">rport_ops</span><span class="o">-&gt;</span><span class="n">event_callback</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;callback ev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
			<span class="n">rport_ops</span><span class="o">-&gt;</span><span class="n">event_callback</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">lld_event_callback</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;lld callback ev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">lld_event_callback</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPORT_EV_FAILED</span>:
	<span class="k">case</span> <span class="n">RPORT_EV_LOGO</span>:
	<span class="k">case</span> <span class="n">RPORT_EV_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">prli_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc_prov_mutex</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">type</span> <span class="o">&lt;</span> <span class="n">FC_FC4_PROV_SIZE</span><span class="p">;</span> <span class="n">type</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prov</span> <span class="o">=</span> <span class="n">fc_passive_prov</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prov</span> <span class="o">&amp;&amp;</span> <span class="n">prov</span><span class="o">-&gt;</span><span class="n">prlo</span><span class="p">)</span>
					<span class="n">prov</span><span class="o">-&gt;</span><span class="n">prlo</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc_prov_mutex</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">port_id</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rport_ops</span> <span class="o">&amp;&amp;</span> <span class="n">rport_ops</span><span class="o">-&gt;</span><span class="n">event_callback</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;callback ev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
			<span class="n">rport_ops</span><span class="o">-&gt;</span><span class="n">event_callback</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">lld_event_callback</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;lld callback ev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">lld_event_callback</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">retry_work</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reset any outstanding exchanges before freeing rport.</span>
<span class="cm">		 */</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_mgr_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_mgr_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">port_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rpriv</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
			<span class="n">rpriv</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">=</span> <span class="n">RPORT_ST_DELETE</span><span class="p">;</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
			<span class="n">fc_remote_port_delete</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">==</span> <span class="n">RPORT_ST_DELETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">==</span> <span class="n">FC_FID_DIR_SERV</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">RPORT_EV_NONE</span><span class="p">;</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
				<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FC_RP_STARTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">major_retries</span> <span class="o">&lt;</span>
				   <span class="n">lport</span><span class="o">-&gt;</span><span class="n">max_rport_retry_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">major_retries</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">RPORT_EV_NONE</span><span class="p">;</span>
				<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;work restart</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">fc_rport_enter_flogi</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;work delete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">peers</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
				<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Re-open for events.  Reissue READY event if ready.</span>
<span class="cm">			 */</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">RPORT_EV_NONE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">==</span> <span class="n">RPORT_ST_READY</span><span class="p">)</span>
				<span class="n">fc_rport_enter_ready</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_login() - Start the remote port login state machine</span>
<span class="cm"> * @rdata: The remote port to be logged in to</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: Called without the rport lock held. This</span>
<span class="cm"> * function will hold the rport lock, call an _enter_*</span>
<span class="cm"> * function and then unlock the rport.</span>
<span class="cm"> *</span>
<span class="cm"> * This indicates the intent to be logged into the remote port.</span>
<span class="cm"> * If it appears we are already logged in, ADISC is used to verify</span>
<span class="cm"> * the setup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fc_rport_login</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FC_RP_STARTED</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_ST_READY</span>:
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;ADISC port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fc_rport_enter_adisc</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_DELETE</span>:
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Restart deleted port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Login to port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fc_rport_enter_flogi</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_delete() - Schedule a remote port to be deleted</span>
<span class="cm"> * @rdata: The remote port to be deleted</span>
<span class="cm"> * @event: The event to report as the reason for deletion</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: Called with the rport lock held.</span>
<span class="cm"> *</span>
<span class="cm"> * Allow state change into DELETE only once.</span>
<span class="cm"> *</span>
<span class="cm"> * Call queue_work only if there&#39;s no event already pending.</span>
<span class="cm"> * Set the new event so that the old pending event will not occur.</span>
<span class="cm"> * Since we have the mutex, even if fc_rport_work() is already started,</span>
<span class="cm"> * it&#39;ll see the new event.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_enter_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">fc_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">==</span> <span class="n">RPORT_ST_DELETE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Delete port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">fc_rport_state_enter</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_ST_DELETE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">RPORT_EV_NONE</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">rport_event_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_logoff() - Logoff and remove a remote port</span>
<span class="cm"> * @rdata: The remote port to be logged off of</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: Called without the rport lock held. This</span>
<span class="cm"> * function will hold the rport lock, call an _enter_*</span>
<span class="cm"> * function and then unlock the rport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fc_rport_logoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Remove port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_RP_STARTED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">==</span> <span class="n">RPORT_ST_DELETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Port in Delete state, not removing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fc_rport_enter_logo</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Change the state to Delete so that we discard</span>
<span class="cm">	 * the response.</span>
<span class="cm">	 */</span>
	<span class="n">fc_rport_enter_delete</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_EV_STOP</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_ready() - Transition to the RPORT_ST_READY state</span>
<span class="cm"> * @rdata: The remote port that is ready</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_enter_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc_rport_state_enter</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_ST_READY</span><span class="p">);</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Port is Ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">RPORT_EV_NONE</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">rport_event_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">RPORT_EV_READY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_timeout() - Handler for the retry_work timer</span>
<span class="cm"> * @work: Handle to the remote port that has timed out</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: Called without the rport lock held. This</span>
<span class="cm"> * function will hold the rport lock, call an _enter_*</span>
<span class="cm"> * function and then unlock the rport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_rport_priv</span><span class="p">,</span> <span class="n">retry_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_ST_FLOGI</span>:
		<span class="n">fc_rport_enter_flogi</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PLOGI</span>:
		<span class="n">fc_rport_enter_plogi</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PRLI</span>:
		<span class="n">fc_rport_enter_prli</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_RTV</span>:
		<span class="n">fc_rport_enter_rtv</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_ADISC</span>:
		<span class="n">fc_rport_enter_adisc</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PLOGI_WAIT</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_READY</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_INIT</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_DELETE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_error() - Error handler, called once retries have been exhausted</span>
<span class="cm"> * @rdata: The remote port the error is happened on</span>
<span class="cm"> * @fp:	   The error code encapsulated in a frame pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before</span>
<span class="cm"> * calling this routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Error %ld in state %s, retries %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">),</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_ST_FLOGI</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_PLOGI</span>:
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_RP_STARTED</span><span class="p">;</span>
		<span class="n">fc_rport_enter_delete</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_EV_FAILED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_RTV</span>:
		<span class="n">fc_rport_enter_ready</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PRLI</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_ADISC</span>:
		<span class="n">fc_rport_enter_logo</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PLOGI_WAIT</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_DELETE</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_READY</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_INIT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_error_retry() - Handler for remote port state retries</span>
<span class="cm"> * @rdata: The remote port whose state is to be retried</span>
<span class="cm"> * @fp:	   The error code encapsulated in a frame pointer</span>
<span class="cm"> *</span>
<span class="cm"> * If the error was an exchange timeout retry immediately,</span>
<span class="cm"> * otherwise wait for E_D_TOV.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before</span>
<span class="cm"> * calling this routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_error_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">FC_DEF_E_D_TOV</span><span class="p">;</span>

	<span class="cm">/* make sure this isn&#39;t an FC_EX_CLOSED error, never retry those */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">FC_EX_CLOSED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="o">-&gt;</span><span class="n">max_rport_retry_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Error %ld in state %s, retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">),</span> <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">retries</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* no additional delay on exchange timeouts */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">FC_EX_TIMEOUT</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">retry_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">fc_rport_error</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_login_complete() - Handle parameters and completion of p-mp login.</span>
<span class="cm"> * @rdata:  The remote port which we logged into or which logged into us.</span>
<span class="cm"> * @fp:     The FLOGI or PLOGI request or response frame</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero error if a problem is detected with the frame.</span>
<span class="cm"> * Does not free the frame.</span>
<span class="cm"> *</span>
<span class="cm"> * This is only used in point-to-multipoint mode for FIP currently.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fc_rport_login_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">flogi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">e_d_tov</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">csp_flags</span><span class="p">;</span>

	<span class="n">flogi</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flogi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flogi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">csp_flags</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_features</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">ELS_FLOGI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csp_flags</span> <span class="o">&amp;</span> <span class="n">FC_SP_FT_FPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Fabric bit set in FLOGI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * E_D_TOV is not valid on an incoming FLOGI request.</span>
<span class="cm">		 */</span>
		<span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_e_d_tov</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csp_flags</span> <span class="o">&amp;</span> <span class="n">FC_SP_FT_EDTR</span><span class="p">)</span>
			<span class="n">e_d_tov</span> <span class="o">/=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e_d_tov</span> <span class="o">&gt;</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">)</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">e_d_tov</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">maxframe_size</span> <span class="o">=</span> <span class="n">fc_plogi_get_maxframe</span><span class="p">(</span><span class="n">flogi</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_flogi_resp() - Handle response to FLOGI request for p-mp mode</span>
<span class="cm"> * @sp:	    The sequence that the FLOGI was on</span>
<span class="cm"> * @fp:	    The FLOGI response frame</span>
<span class="cm"> * @rp_arg: The remote port that received the FLOGI response</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_flogi_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">rp_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">rp_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">flogi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r_a_tov</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a FLOGI %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">FC_EX_CLOSED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">put</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">!=</span> <span class="n">RPORT_ST_FLOGI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a FLOGI response, but in state &quot;</span>
			     <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_rport_error</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ELS_LS_ACC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc_rport_login_complete</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="n">flogi</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flogi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flogi</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">flogi</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_r_a_tov</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_a_tov</span> <span class="o">&gt;</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">)</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">r_a_tov</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">&lt;</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">)</span>
		<span class="n">fc_rport_enter_plogi</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fc_rport_state_enter</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_ST_PLOGI_WAIT</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
<span class="nl">put:</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">bad:</span>
	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Bad FLOGI response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_flogi() - Send a FLOGI request to the remote port for p-mp</span>
<span class="cm"> * @rdata: The remote port to send a FLOGI to</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_enter_flogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">point_to_multipoint</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fc_rport_enter_plogi</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Entered FLOGI state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="n">fc_rport_state_enter</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_ST_FLOGI</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_flogi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ELS_FLOGI</span><span class="p">,</span>
				  <span class="n">fc_rport_flogi_resp</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span>
				  <span class="mi">2</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">))</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_recv_flogi_req() - Handle Fabric Login (FLOGI) request in p-mp mode</span>
<span class="cm"> * @lport: The local port that received the PLOGI request</span>
<span class="cm"> * @rx_fp: The PLOGI request frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_recv_flogi_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">rx_fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_disc</span> <span class="o">*</span><span class="n">disc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">rx_fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">rjt_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

	<span class="n">sid</span> <span class="o">=</span> <span class="n">fc_frame_sid</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="n">FC_RPORT_ID_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="s">&quot;Received FLOGI request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">disc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">point_to_multipoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_UNSUP</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_LOGIC</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INV_LEN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_FIP</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NOT_NEIGHBOR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received FLOGI in %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_ST_INIT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If received the FLOGI request on RPORT which is INIT state</span>
<span class="cm">		 * (means not transition to FLOGI either fc_rport timeout</span>
<span class="cm">		 * function didn;t trigger or this end hasn;t received</span>
<span class="cm">		 * beacon yet from other end. In that case only, allow RPORT</span>
<span class="cm">		 * state machine to continue, otherwise fall through which</span>
<span class="cm">		 * causes the code to send reject response.</span>
<span class="cm">		 * NOTE; Not checking for FIP-&gt;state such as VNMP_UP or</span>
<span class="cm">		 * VNMP_CLAIM because if FIP state is not one of those,</span>
<span class="cm">		 * RPORT wouldn;t have created and &#39;rport_lookup&#39; would have</span>
<span class="cm">		 * failed anyway in that case.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">point_to_multipoint</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_DELETE</span>:
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_FIP</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NOT_NEIGHBOR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_FLOGI</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_PLOGI_WAIT</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_PLOGI</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PRLI</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_RTV</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_READY</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_ADISC</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Set the remote port to be deleted and to then restart.</span>
<span class="cm">		 * This queues work to be sure exchanges are reset.</span>
<span class="cm">		 */</span>
		<span class="n">fc_rport_enter_delete</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_EV_LOGO</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_BUSY</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc_rport_login_complete</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_LOGIC</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">fc_flogi_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">flp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">flp</span><span class="p">));</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">fl_cmd</span> <span class="o">=</span> <span class="n">ELS_LS_ACC</span><span class="p">;</span>

	<span class="n">fc_fill_reply_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">rx_fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">&lt;</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">)</span>
		<span class="n">fc_rport_enter_plogi</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fc_rport_state_enter</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_ST_PLOGI_WAIT</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">reject:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rjt_data</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_plogi_resp() - Handler for ELS PLOGI responses</span>
<span class="cm"> * @sp:	       The sequence the PLOGI is on</span>
<span class="cm"> * @fp:	       The PLOGI response frame</span>
<span class="cm"> * @rdata_arg: The remote port that sent the PLOGI response</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function will be called without the rport lock</span>
<span class="cm"> * held, but it will lock, call an _enter_* function or fc_rport_error</span>
<span class="cm"> * and then unlock the rport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_plogi_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">rdata_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">rdata_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">plp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">csp_seq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cssp_seq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a PLOGI %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">!=</span> <span class="n">RPORT_ST_PLOGI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a PLOGI response, but in state &quot;</span>
			     <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_LS_ACC</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">plp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">plp</span><span class="p">)))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plp</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">);</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plp</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">);</span>

		<span class="cm">/* save plogi response sp_features for further reference */</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">sp_features</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">plp</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_features</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">point_to_multipoint</span><span class="p">)</span>
			<span class="n">fc_rport_login_complete</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="n">csp_seq</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">plp</span><span class="o">-&gt;</span><span class="n">fl_csp</span><span class="p">.</span><span class="n">sp_tot_seq</span><span class="p">);</span>
		<span class="n">cssp_seq</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">plp</span><span class="o">-&gt;</span><span class="n">fl_cssp</span><span class="p">[</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">cp_con_seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cssp_seq</span> <span class="o">&lt;</span> <span class="n">csp_seq</span><span class="p">)</span>
			<span class="n">csp_seq</span> <span class="o">=</span> <span class="n">cssp_seq</span><span class="p">;</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">max_seq</span> <span class="o">=</span> <span class="n">csp_seq</span><span class="p">;</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">maxframe_size</span> <span class="o">=</span> <span class="n">fc_plogi_get_maxframe</span><span class="p">(</span><span class="n">plp</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>
		<span class="n">fc_rport_enter_prli</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_plogi() - Send Port Login (PLOGI) request</span>
<span class="cm"> * @rdata: The remote port to send a PLOGI to</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_enter_plogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Port entered PLOGI state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="n">fc_rport_state_enter</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_ST_PLOGI</span><span class="p">);</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">maxframe_size</span> <span class="o">=</span> <span class="n">FC_MIN_MAX_PAYLOAD</span><span class="p">;</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_flogi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;%s frame alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">e_d_tov</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ELS_PLOGI</span><span class="p">,</span>
				  <span class="n">fc_rport_plogi_resp</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span>
				  <span class="mi">2</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">))</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_prli_resp() - Process Login (PRLI) response handler</span>
<span class="cm"> * @sp:	       The sequence the PRLI response was on</span>
<span class="cm"> * @fp:	       The PRLI response frame</span>
<span class="cm"> * @rdata_arg: The remote port that sent the PRLI response</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function will be called without the rport lock</span>
<span class="cm"> * held, but it will lock, call an _enter_* function or fc_rport_error</span>
<span class="cm"> * and then unlock the rport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_prli_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">rdata_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">rdata_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fc_els_prli</span> <span class="n">prli</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="n">spp</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="n">temp_spp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc4_prov</span> <span class="o">*</span><span class="n">prov</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">roles</span> <span class="o">=</span> <span class="n">FC_RPORT_ROLE_UNKNOWN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fcp_parm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">resp_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a PRLI %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">!=</span> <span class="n">RPORT_ST_PRLI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a PRLI response, but in state &quot;</span>
			     <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reinitialize remote port roles */</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">FC_RPORT_ROLE_UNKNOWN</span><span class="p">;</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_LS_ACC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">resp_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">.</span><span class="n">spp_flags</span> <span class="o">&amp;</span> <span class="n">FC_SPP_RESP_MASK</span><span class="p">);</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;PRLI spp_flags = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">.</span><span class="n">spp_flags</span><span class="p">);</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">spp_type</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">.</span><span class="n">spp_type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp_code</span> <span class="o">!=</span> <span class="n">FC_SPP_RESP_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resp_code</span> <span class="o">==</span> <span class="n">FC_SPP_RESP_CONF</span><span class="p">)</span>
				<span class="n">fc_rport_error</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_spp_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">fcp_parm</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">.</span><span class="n">spp_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcp_parm</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_RETRY</span><span class="p">)</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FC_RP_FLAGS_RETRY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcp_parm</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_CONF_COMPL</span><span class="p">)</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FC_RP_FLAGS_CONF_REQ</span><span class="p">;</span>

		<span class="n">prov</span> <span class="o">=</span> <span class="n">fc_passive_prov</span><span class="p">[</span><span class="n">FC_TYPE_FCP</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prov</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp_spp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">temp_spp</span><span class="p">));</span>
			<span class="n">prov</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_spp_len</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_spp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcp_parm</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_INIT_FCN</span><span class="p">)</span>
			<span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_INITIATOR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcp_parm</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_TARG_FCN</span><span class="p">)</span>
			<span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_TARGET</span><span class="p">;</span>

		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">roles</span><span class="p">;</span>
		<span class="n">fc_rport_enter_rtv</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Bad ELS response for PRLI command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_prli() - Send Process Login (PRLI) request</span>
<span class="cm"> * @rdata: The remote port to send the PRLI request to</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_enter_prli</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fc_els_prli</span> <span class="n">prli</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="n">spp</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc4_prov</span> <span class="o">*</span><span class="n">prov</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the rport is one of the well known addresses</span>
<span class="cm">	 * we skip PRLI and RTV and go straight to READY.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">&gt;=</span> <span class="n">FC_FID_DOM_MGR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_rport_enter_ready</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Port entered PRLI state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="n">fc_rport_state_enter</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_ST_PRLI</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc_prli_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="n">prov</span> <span class="o">=</span> <span class="n">fc_passive_prov</span><span class="p">[</span><span class="n">FC_TYPE_FCP</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prov</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">));</span>
		<span class="n">prov</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fc_fill_fc_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REQ</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span>
		       <span class="n">fc_host_port_id</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">FC_TYPE_ELS</span><span class="p">,</span>
		       <span class="n">FC_FC_FIRST_SEQ</span> <span class="o">|</span> <span class="n">FC_FC_END_SEQ</span> <span class="o">|</span> <span class="n">FC_FC_SEQ_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_seq_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fc_rport_prli_resp</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">))</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_els_rtv_resp() - Handler for Request Timeout Value (RTV) responses</span>
<span class="cm"> * @sp:	       The sequence the RTV was on</span>
<span class="cm"> * @fp:	       The RTV response frame</span>
<span class="cm"> * @rdata_arg: The remote port that sent the RTV response</span>
<span class="cm"> *</span>
<span class="cm"> * Many targets don&#39;t seem to support this.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function will be called without the rport lock</span>
<span class="cm"> * held, but it will lock, call an _enter_* function or fc_rport_error</span>
<span class="cm"> * and then unlock the rport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_rtv_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">rdata_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">rdata_arg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a RTV %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">!=</span> <span class="n">RPORT_ST_RTV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a RTV response, but in state &quot;</span>
			     <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_rport_error</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_LS_ACC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fc_els_rtv_acc</span> <span class="o">*</span><span class="n">rtv</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">toq</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tov</span><span class="p">;</span>

		<span class="n">rtv</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rtv</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">toq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rtv</span><span class="o">-&gt;</span><span class="n">rtv_toq</span><span class="p">);</span>
			<span class="n">tov</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rtv</span><span class="o">-&gt;</span><span class="n">rtv_r_a_tov</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tov</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tov</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">r_a_tov</span> <span class="o">=</span> <span class="n">tov</span><span class="p">;</span>
			<span class="n">tov</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rtv</span><span class="o">-&gt;</span><span class="n">rtv_e_d_tov</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">toq</span> <span class="o">&amp;</span> <span class="n">FC_ELS_RTV_EDRES</span><span class="p">)</span>
				<span class="n">tov</span> <span class="o">/=</span> <span class="mi">1000000</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tov</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tov</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">e_d_tov</span> <span class="o">=</span> <span class="n">tov</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fc_rport_enter_ready</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_rtv() - Send Request Timeout Value (RTV) request</span>
<span class="cm"> * @rdata: The remote port to send the RTV request to</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_enter_rtv</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Port entered RTV state from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="n">fc_rport_state_enter</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_ST_RTV</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_rtv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ELS_RTV</span><span class="p">,</span>
				  <span class="n">fc_rport_rtv_resp</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span>
				  <span class="mi">2</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">))</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_logo_resp() - Handler for logout (LOGO) responses</span>
<span class="cm"> * @sp:	       The sequence the LOGO was on</span>
<span class="cm"> * @fp:	       The LOGO response frame</span>
<span class="cm"> * @lport_arg: The local port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_logo_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">lport_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lport_arg</span><span class="p">;</span>

	<span class="n">FC_RPORT_ID_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fc_seq_exch</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">did</span><span class="p">,</span>
			<span class="s">&quot;Received a LOGO %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fc_els_resp_type</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_logo() - Send a logout (LOGO) request</span>
<span class="cm"> * @rdata: The remote port to send the LOGO request to</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_enter_logo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Port sending LOGO from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_logo</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LOGO</span><span class="p">,</span>
				   <span class="n">fc_rport_logo_resp</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_els_adisc_resp() - Handler for Address Discovery (ADISC) responses</span>
<span class="cm"> * @sp:	       The sequence the ADISC response was on</span>
<span class="cm"> * @fp:	       The ADISC response frame</span>
<span class="cm"> * @rdata_arg: The remote port that sent the ADISC response</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: This function will be called without the rport lock</span>
<span class="cm"> * held, but it will lock, call an _enter_* function or fc_rport_error</span>
<span class="cm"> * and then unlock the rport.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_adisc_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_seq</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">rdata_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">rdata_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_adisc</span> <span class="o">*</span><span class="n">adisc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a ADISC response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span> <span class="o">!=</span> <span class="n">RPORT_ST_ADISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received a ADISC resp but in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_rport_error</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If address verification failed.  Consider us logged out of the rport.</span>
<span class="cm">	 * Since the rport is still in discovery, we want to be</span>
<span class="cm">	 * logged in, so go to PLOGI state.  Otherwise, go back to READY.</span>
<span class="cm">	 */</span>
	<span class="n">op</span> <span class="o">=</span> <span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">adisc</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adisc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">!=</span> <span class="n">ELS_LS_ACC</span> <span class="o">||</span> <span class="o">!</span><span class="n">adisc</span> <span class="o">||</span>
	    <span class="n">ntoh24</span><span class="p">(</span><span class="n">adisc</span><span class="o">-&gt;</span><span class="n">adisc_port_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">||</span>
	    <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adisc</span><span class="o">-&gt;</span><span class="n">adisc_wwpn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">||</span>
	    <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adisc</span><span class="o">-&gt;</span><span class="n">adisc_wwnn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;ADISC error or mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fc_rport_enter_flogi</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;ADISC OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fc_rport_enter_ready</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_enter_adisc() - Send Address Discover (ADISC) request</span>
<span class="cm"> * @rdata: The remote port to send the ADISC request to</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before calling</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_enter_adisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;sending ADISC from %s state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="n">fc_rport_state_enter</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_ST_ADISC</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_adisc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">elsct_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ELS_ADISC</span><span class="p">,</span>
				  <span class="n">fc_rport_adisc_resp</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span>
				  <span class="mi">2</span> <span class="o">*</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">r_a_tov</span><span class="p">))</span>
		<span class="n">fc_rport_error_retry</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_recv_adisc_req() - Handler for Address Discovery (ADISC) requests</span>
<span class="cm"> * @rdata: The remote port that sent the ADISC request</span>
<span class="cm"> * @in_fp: The ADISC request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note:  Called with the lport and rport locks held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_recv_adisc_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">in_fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_adisc</span> <span class="o">*</span><span class="n">adisc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">rjt_data</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received ADISC request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">adisc</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">in_fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adisc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adisc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_PROT</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INV_LEN</span><span class="p">;</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">in_fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rjt_data</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adisc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="n">fc_adisc_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">adisc</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">adisc</span><span class="p">));</span>
	<span class="n">adisc</span><span class="o">-&gt;</span><span class="n">adisc_cmd</span> <span class="o">=</span> <span class="n">ELS_LS_ACC</span><span class="p">;</span>
	<span class="n">fc_fill_reply_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">in_fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="nl">drop:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">in_fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_recv_rls_req() - Handle received Read Link Status request</span>
<span class="cm"> * @rdata: The remote port that sent the RLS request</span>
<span class="cm"> * @rx_fp: The PRLI request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is expected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_recv_rls_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">rx_fp</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_rls</span> <span class="o">*</span><span class="n">rls</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_rls_resp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_lesb</span> <span class="o">*</span><span class="n">lesb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">rjt_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_host_statistics</span> <span class="o">*</span><span class="n">hst</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received RLS request while in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="n">rls</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rls</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rls</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_PROT</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INV_LEN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_rjt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_UNAB</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INSUF_RES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_rjt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">));</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rls_cmd</span> <span class="o">=</span> <span class="n">ELS_LS_ACC</span><span class="p">;</span>
	<span class="n">lesb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rls_lesb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">get_lesb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get LESB from LLD if it supports it */</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">get_lesb</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">lesb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fc_get_host_stats</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="n">hst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">host_stats</span><span class="p">;</span>
		<span class="n">lesb</span><span class="o">-&gt;</span><span class="n">lesb_link_fail</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">hst</span><span class="o">-&gt;</span><span class="n">link_failure_count</span><span class="p">);</span>
		<span class="n">lesb</span><span class="o">-&gt;</span><span class="n">lesb_sync_loss</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">hst</span><span class="o">-&gt;</span><span class="n">loss_of_sync_count</span><span class="p">);</span>
		<span class="n">lesb</span><span class="o">-&gt;</span><span class="n">lesb_sig_loss</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">hst</span><span class="o">-&gt;</span><span class="n">loss_of_signal_count</span><span class="p">);</span>
		<span class="n">lesb</span><span class="o">-&gt;</span><span class="n">lesb_prim_err</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">hst</span><span class="o">-&gt;</span><span class="n">prim_seq_protocol_err_count</span><span class="p">);</span>
		<span class="n">lesb</span><span class="o">-&gt;</span><span class="n">lesb_inv_word</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">hst</span><span class="o">-&gt;</span><span class="n">invalid_tx_word_count</span><span class="p">);</span>
		<span class="n">lesb</span><span class="o">-&gt;</span><span class="n">lesb_inv_crc</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">hst</span><span class="o">-&gt;</span><span class="n">invalid_crc_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fc_fill_reply_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">rx_fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_rjt:</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rjt_data</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_recv_els_req() - Handler for validated ELS requests</span>
<span class="cm"> * @lport: The local port that received the ELS request</span>
<span class="cm"> * @fp:	   The ELS request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Handle incoming ELS requests that require port login.</span>
<span class="cm"> * The ELS opcode has already been validated by the caller.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: Called with the lport lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_recv_els_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">els_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fc_frame_sid</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PRLI</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_RTV</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_READY</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_ADISC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ELS_PRLI</span>:
		<span class="n">fc_rport_recv_prli_req</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_PRLO</span>:
		<span class="n">fc_rport_recv_prlo_req</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_ADISC</span>:
		<span class="n">fc_rport_recv_adisc_req</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_RRQ</span>:
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ELS_RRQ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_REC</span>:
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ELS_REC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_RLS</span>:
		<span class="n">fc_rport_recv_rls_req</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>	<span class="cm">/* can&#39;t happen */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">reject:</span>
	<span class="n">els_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_UNAB</span><span class="p">;</span>
	<span class="n">els_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_PLOGI_REQD</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">els_data</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_recv_req() - Handler for requests</span>
<span class="cm"> * @lport: The local port that received the request</span>
<span class="cm"> * @fp:	   The request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: Called with the lport lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_recv_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">els_data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle FLOGI, PLOGI and LOGO requests separately, since they</span>
<span class="cm">	 * don&#39;t require prior login.</span>
<span class="cm">	 * Check for unsupported opcodes first and reject them.</span>
<span class="cm">	 * For some ops, it would be incorrect to reject with &quot;PLOGI required&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ELS_FLOGI</span>:
		<span class="n">fc_rport_recv_flogi_req</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_PLOGI</span>:
		<span class="n">fc_rport_recv_plogi_req</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_LOGO</span>:
		<span class="n">fc_rport_recv_logo_req</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_PRLI</span>:
	<span class="k">case</span> <span class="n">ELS_PRLO</span>:
	<span class="k">case</span> <span class="n">ELS_ADISC</span>:
	<span class="k">case</span> <span class="n">ELS_RRQ</span>:
	<span class="k">case</span> <span class="n">ELS_REC</span>:
	<span class="k">case</span> <span class="n">ELS_RLS</span>:
		<span class="n">fc_rport_recv_els_req</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">els_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_UNSUP</span><span class="p">;</span>
		<span class="n">els_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NONE</span><span class="p">;</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">els_data</span><span class="p">);</span>
		<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_recv_plogi_req() - Handler for Port Login (PLOGI) requests</span>
<span class="cm"> * @lport: The local port that received the PLOGI request</span>
<span class="cm"> * @rx_fp: The PLOGI request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is held before calling this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_recv_plogi_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">rx_fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_disc</span> <span class="o">*</span><span class="n">disc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">rx_fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_flogi</span> <span class="o">*</span><span class="n">pl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">rjt_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

	<span class="n">sid</span> <span class="o">=</span> <span class="n">fc_frame_sid</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="n">FC_RPORT_ID_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="s">&quot;Received PLOGI request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pl</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pl</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FC_RPORT_ID_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="s">&quot;Received PLOGI too short</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_PROT</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INV_LEN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">disc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_create</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_UNAB</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INSUF_RES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl</span><span class="o">-&gt;</span><span class="n">fl_wwpn</span><span class="p">);</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl</span><span class="o">-&gt;</span><span class="n">fl_wwnn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the rport was just created, possibly due to the incoming PLOGI,</span>
<span class="cm">	 * set the state appropriately and accept the PLOGI.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we had also sent a PLOGI, and if the received PLOGI is from a</span>
<span class="cm">	 * higher WWPN, we accept it, otherwise an LS_RJT is sent with reason</span>
<span class="cm">	 * &quot;command already in progress&quot;.</span>
<span class="cm">	 *</span>
<span class="cm">	 * XXX TBD: If the session was ready before, the PLOGI should result in</span>
<span class="cm">	 * all outstanding exchanges being reset.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_ST_INIT</span>:
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received PLOGI in INIT state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PLOGI_WAIT</span>:
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received PLOGI in PLOGI_WAIT state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PLOGI</span>:
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received PLOGI in PLOGI state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">&lt;</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
			<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_INPROG</span><span class="p">;</span>
			<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NONE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PRLI</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_RTV</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_READY</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_ADISC</span>:
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received PLOGI in logged-in state %d &quot;</span>
			     <span class="s">&quot;- ignored for now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">);</span>
		<span class="cm">/* XXX TBD - should reset */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_ST_FLOGI</span>:
	<span class="k">case</span> <span class="n">RPORT_ST_DELETE</span>:
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received PLOGI in state %s - send busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_BUSY</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get session payload size from incoming PLOGI.</span>
<span class="cm">	 */</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">maxframe_size</span> <span class="o">=</span> <span class="n">fc_plogi_get_maxframe</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">mfs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send LS_ACC.	 If this fails, the originator should retry.</span>
<span class="cm">	 */</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pl</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">fc_plogi_fill</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LS_ACC</span><span class="p">);</span>
	<span class="n">fc_fill_reply_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">rx_fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">fc_rport_enter_prli</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">reject:</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rjt_data</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_recv_prli_req() - Handler for process login (PRLI) requests</span>
<span class="cm"> * @rdata: The remote port that sent the PRLI request</span>
<span class="cm"> * @rx_fp: The PRLI request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is exected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_recv_prli_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">rx_fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fc_els_prli</span> <span class="n">prli</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="n">spp</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">rspp</span><span class="p">;</span>	<span class="cm">/* request service param page */</span>
	<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">spp</span><span class="p">;</span>	<span class="cm">/* response spp */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plen</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fc_els_spp_resp</span> <span class="n">resp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fc_els_spp_resp</span> <span class="n">passive</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">rjt_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc4_prov</span> <span class="o">*</span><span class="n">prov</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received PRLI request while in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fr_len</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reject_len</span><span class="p">;</span>
	<span class="n">plen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">plen</span> <span class="o">&gt;</span> <span class="n">len</span> <span class="o">||</span> <span class="n">plen</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reject_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>
	<span class="n">plen</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_spp_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">plen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spp</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">plen</span> <span class="o">&gt;</span> <span class="n">len</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span> <span class="o">||</span> <span class="n">plen</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reject_len</span><span class="p">;</span>
	<span class="n">rspp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_UNAB</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INSUF_RES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_cmd</span> <span class="o">=</span> <span class="n">ELS_LS_ACC</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_spp_len</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">.</span><span class="n">prli_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_prli</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Go through all the service parameter pages and build</span>
<span class="cm">	 * response.  If plen indicates longer SPP than standard,</span>
<span class="cm">	 * use that.  The entire response has been pre-cleared above.</span>
<span class="cm">	 */</span>
	<span class="n">spp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc_prov_mutex</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">plen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">spp_type</span> <span class="o">=</span> <span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_type</span><span class="p">;</span>
		<span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_type</span> <span class="o">=</span> <span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_type</span><span class="p">;</span>
		<span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_type_ext</span> <span class="o">=</span> <span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_type_ext</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_type</span> <span class="o">&lt;</span> <span class="n">FC_FC4_PROV_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prov</span> <span class="o">=</span> <span class="n">fc_active_prov</span><span class="p">[</span><span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_type</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prov</span><span class="p">)</span>
				<span class="n">resp</span> <span class="o">=</span> <span class="n">prov</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">rspp</span><span class="p">,</span> <span class="n">spp</span><span class="p">);</span>
			<span class="n">prov</span> <span class="o">=</span> <span class="n">fc_passive_prov</span><span class="p">[</span><span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_type</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prov</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">passive</span> <span class="o">=</span> <span class="n">prov</span><span class="o">-&gt;</span><span class="n">prli</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">rspp</span><span class="p">,</span> <span class="n">spp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span> <span class="o">||</span> <span class="n">passive</span> <span class="o">==</span> <span class="n">FC_SPP_RESP_ACK</span><span class="p">)</span>
					<span class="n">resp</span> <span class="o">=</span> <span class="n">passive</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_flags</span> <span class="o">&amp;</span> <span class="n">FC_SPP_EST_IMG_PAIR</span><span class="p">)</span>
				<span class="n">resp</span> <span class="o">|=</span> <span class="n">FC_SPP_RESP_CONF</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">resp</span> <span class="o">|=</span> <span class="n">FC_SPP_RESP_INVL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_flags</span> <span class="o">|=</span> <span class="n">resp</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">plen</span><span class="p">;</span>
		<span class="n">rspp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">rspp</span> <span class="o">+</span> <span class="n">plen</span><span class="p">);</span>
		<span class="n">spp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">spp</span> <span class="o">+</span> <span class="n">plen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc_prov_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send LS_ACC.	 If this fails, the originator should retry.</span>
<span class="cm">	 */</span>
	<span class="n">fc_fill_reply_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">rx_fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_ST_PRLI</span>:
		<span class="n">fc_rport_enter_ready</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

<span class="nl">reject_len:</span>
	<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_PROT</span><span class="p">;</span>
	<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INV_LEN</span><span class="p">;</span>
<span class="nl">reject:</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rjt_data</span><span class="p">);</span>
<span class="nl">drop:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_recv_prlo_req() - Handler for process logout (PRLO) requests</span>
<span class="cm"> * @rdata: The remote port that sent the PRLO request</span>
<span class="cm"> * @rx_fp: The PRLO request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is exected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_recv_prlo_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">rx_fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fc_els_prlo</span> <span class="n">prlo</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="n">spp</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">rspp</span><span class="p">;</span>	<span class="cm">/* request service param page */</span>
	<span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">spp</span><span class="p">;</span>		<span class="cm">/* response spp */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">rjt_data</span><span class="p">;</span>

	<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received PRLO request while in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">fr_len</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reject_len</span><span class="p">;</span>
	<span class="n">plen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">prlo</span><span class="p">.</span><span class="n">prlo_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">!=</span> <span class="mi">20</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reject_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">rspp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">fc_frame_alloc</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_UNAB</span><span class="p">;</span>
		<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INSUF_RES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">fc_frame_payload_get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prlo</span><span class="p">.</span><span class="n">prlo_cmd</span> <span class="o">=</span> <span class="n">ELS_LS_ACC</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prlo</span><span class="p">.</span><span class="n">prlo_obs</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prlo</span><span class="p">.</span><span class="n">prlo_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">spp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">spp</span><span class="p">;</span>
	<span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_type</span> <span class="o">=</span> <span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_type</span><span class="p">;</span>
	<span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_type_ext</span> <span class="o">=</span> <span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_type_ext</span><span class="p">;</span>
	<span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_flags</span> <span class="o">=</span> <span class="n">FC_SPP_RESP_ACK</span><span class="p">;</span>

	<span class="n">fc_rport_enter_delete</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_EV_LOGO</span><span class="p">);</span>

	<span class="n">fc_fill_reply_hdr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">rx_fp</span><span class="p">,</span> <span class="n">FC_RCTL_ELS_REP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">frame_send</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

<span class="nl">reject_len:</span>
	<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_PROT</span><span class="p">;</span>
	<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_INV_LEN</span><span class="p">;</span>
<span class="nl">reject:</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rjt_data</span><span class="p">);</span>
<span class="nl">drop:</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">rx_fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_recv_logo_req() - Handler for logout (LOGO) requests</span>
<span class="cm"> * @lport: The local port that received the LOGO request</span>
<span class="cm"> * @fp:	   The LOGO request frame</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note: The rport lock is exected to be held before calling</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_recv_logo_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LS_ACC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">sid</span> <span class="o">=</span> <span class="n">fc_frame_sid</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">sid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
		<span class="n">FC_RPORT_DBG</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&quot;Received LOGO request while in state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">fc_rport_state</span><span class="p">(</span><span class="n">rdata</span><span class="p">));</span>

		<span class="n">fc_rport_enter_delete</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">RPORT_EV_LOGO</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">rp_mutex</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">FC_RPORT_ID_DBG</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span>
				<span class="s">&quot;Received LOGO from non-logged-in port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_flush_queue() - Flush the rport_event_queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fc_rport_flush_queue</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">rport_event_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_init() - Initialize the remote port layer for a local port</span>
<span class="cm"> * @lport: The local port to initialize the remote port layer for</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_rport_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_lookup</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_lookup</span> <span class="o">=</span> <span class="n">fc_rport_lookup</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_create</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_create</span> <span class="o">=</span> <span class="n">fc_rport_create</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_login</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_login</span> <span class="o">=</span> <span class="n">fc_rport_login</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span> <span class="o">=</span> <span class="n">fc_rport_logoff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_recv_req</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_recv_req</span> <span class="o">=</span> <span class="n">fc_rport_recv_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_flush_queue</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_flush_queue</span> <span class="o">=</span> <span class="n">fc_rport_flush_queue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span> <span class="o">=</span> <span class="n">fc_rport_destroy</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_rport_init</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_fcp_prli() - Handle incoming PRLI for the FCP initiator.</span>
<span class="cm"> * @rdata: remote port private</span>
<span class="cm"> * @spp_len: service parameter page length</span>
<span class="cm"> * @rspp: received service parameter page</span>
<span class="cm"> * @spp: response service parameter page</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the value for the response code to be placed in spp_flags;</span>
<span class="cm"> * Returns 0 if not an initiator.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fc_rport_fcp_prli</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span> <span class="n">u32</span> <span class="n">spp_len</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">rspp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">spp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fcp_parm</span><span class="p">;</span>

	<span class="n">fcp_parm</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_params</span><span class="p">);</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">FC_RPORT_ROLE_UNKNOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcp_parm</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_INIT_FCN</span><span class="p">)</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_INITIATOR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcp_parm</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_TARG_FCN</span><span class="p">)</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_TARGET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcp_parm</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_RETRY</span><span class="p">)</span>
		<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FC_RP_FLAGS_RETRY</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">supported_classes</span> <span class="o">=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">service_params</span> <span class="o">&amp;</span> <span class="n">FC_RPORT_ROLE_FCP_INITIATOR</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_flags</span> <span class="o">|=</span> <span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_flags</span> <span class="o">&amp;</span> <span class="n">FC_SPP_EST_IMG_PAIR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * OR in our service parameters with other providers (target), if any.</span>
<span class="cm">	 */</span>
	<span class="n">fcp_parm</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_params</span><span class="p">);</span>
	<span class="n">spp</span><span class="o">-&gt;</span><span class="n">spp_params</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">fcp_parm</span> <span class="o">|</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">service_params</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FC_SPP_RESP_ACK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC-4 provider ops for FCP initiator.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fc4_prov</span> <span class="n">fc_rport_fcp_init</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prli</span> <span class="o">=</span> <span class="n">fc_rport_fcp_prli</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_t0_prli() - Handle incoming PRLI parameters for type 0</span>
<span class="cm"> * @rdata: remote port private</span>
<span class="cm"> * @spp_len: service parameter page length</span>
<span class="cm"> * @rspp: received service parameter page</span>
<span class="cm"> * @spp: response service parameter page</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fc_rport_t0_prli</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span> <span class="n">u32</span> <span class="n">spp_len</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">rspp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fc_els_spp</span> <span class="o">*</span><span class="n">spp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rspp</span><span class="o">-&gt;</span><span class="n">spp_flags</span> <span class="o">&amp;</span> <span class="n">FC_SPP_EST_IMG_PAIR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FC_SPP_RESP_INVL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">FC_SPP_RESP_ACK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FC-4 provider ops for type 0 service parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * This handles the special case of type 0 which is always successful</span>
<span class="cm"> * but doesn&#39;t do anything otherwise.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fc4_prov</span> <span class="n">fc_rport_t0_prov</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prli</span> <span class="o">=</span> <span class="n">fc_rport_t0_prli</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fc_setup_rport() - Initialize the rport_event_queue</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fc_setup_rport</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rport_event_queue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;fc_rport_eq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport_event_queue</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_destroy_rport() - Destroy the rport_event_queue</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_destroy_rport</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">rport_event_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fc_rport_terminate_io() - Stop all outstanding I/O on a remote port</span>
<span class="cm"> * @rport: The remote port whose I/O should be terminated</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fc_rport_terminate_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_libfc_priv</span> <span class="o">*</span><span class="n">rpriv</span> <span class="o">=</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">rpriv</span><span class="o">-&gt;</span><span class="n">local_port</span><span class="p">;</span>

	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_mgr_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">exch_mgr_reset</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">rport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fc_rport_terminate_io</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
