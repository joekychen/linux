<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › sun3_scsi_vme.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sun3_scsi_vme.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre> <span class="cm">/*</span>
<span class="cm"> * Sun3 SCSI stuff by Erik Verbruggen (erik@bigmama.xtdnet.nl)</span>
<span class="cm"> *</span>
<span class="cm"> * Sun3 DMA routines added by Sam Creasey (sammy@sammy.net)</span>
<span class="cm"> *</span>
<span class="cm"> * VME support added by Sam Creasey</span>
<span class="cm"> *</span>
<span class="cm"> * Adapted from sun3_scsi.c -- see there for other headers</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: modify this driver to support multiple Sun3 SCSI VME boards</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define AUTOSENSE</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;asm/sun3ints.h&gt;</span>
<span class="cp">#include &lt;asm/dvma.h&gt;</span>
<span class="cp">#include &lt;asm/idprom.h&gt;</span>
<span class="cp">#include &lt;asm/machines.h&gt;</span>

<span class="cp">#define SUN3_SCSI_VME</span>

<span class="cp">#undef SUN3_SCSI_DEBUG</span>

<span class="cm">/* dma on! */</span>
<span class="cp">#define REAL_DMA</span>

<span class="cp">#define NDEBUG 0</span>

<span class="cp">#define NDEBUG_ABORT		0x00100000</span>
<span class="cp">#define NDEBUG_TAGS		0x00200000</span>
<span class="cp">#define NDEBUG_MERGING		0x00400000</span>

<span class="cp">#include &quot;scsi.h&quot;</span>
<span class="cp">#include &quot;initio.h&quot;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &quot;sun3_scsi.h&quot;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">sun3_map_test</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#define USE_WRAPPER</span>
<span class="cm">/*#define RESET_BOOT */</span>
<span class="cp">#define DRIVER_SETUP</span>

<span class="cm">/*</span>
<span class="cm"> * BUG can be used to trigger a strange code-size related hang on 2.1 kernels</span>
<span class="cm"> */</span>
<span class="cp">#ifdef BUG</span>
<span class="cp">#undef RESET_BOOT</span>
<span class="cp">#undef DRIVER_SETUP</span>
<span class="cp">#endif</span>

<span class="cm">/* #define SUPPORT_TAGS */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define    ENABLE<em>IRQ()    enable</em>irq( SUN3<em>VEC</em>VMESCSI0 );</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define ENABLE_IRQ()</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">scsi_sun3_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sun3scsi_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">sun3scsi_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_can_queue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">setup_can_queue</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_cmd_per_lun</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">setup_cmd_per_lun</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_sg_tablesize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">setup_sg_tablesize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_TAGS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_use_tagged_queuing</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">setup_use_tagged_queuing</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_hostid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">setup_hostid</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sun3_dma_setup_done</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#define	AFTER_RESET_DELAY	(HZ/2)</span>

<span class="cm">/* ms to wait after hitting dma regs */</span>
<span class="cp">#define SUN3_DMA_DELAY 10</span>

<span class="cm">/* dvma buffer to allocate -- 32k should hopefully be more than sufficient */</span>
<span class="cp">#define SUN3_DVMA_BUFSIZE 0xe000</span>

<span class="cm">/* minimum number of bytes to do dma on */</span>
<span class="cp">#define SUN3_DMA_MINSIZE 128</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sun3_scsi_regp</span><span class="p">;</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="k">struct</span> <span class="n">sun3_dma_regs</span> <span class="o">*</span><span class="n">dregs</span><span class="p">;</span>
<span class="cp">#ifdef OLDDMA</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* dma memory buffer */</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sun3_dma_orig_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sun3_dma_orig_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sun3_dma_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * NCR 5380 register access functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">sun3scsi_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">(</span> <span class="n">sun3_scsi_regp</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sun3scsi_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sun3_scsi_regp</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * XXX: status debug</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">default_instance</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Function : int sun3scsi_detect(struct scsi_host_template * tpnt)</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose : initializes mac NCR5380 driver based on the</span>
<span class="cm"> *	command line / compile time port and irq definitions.</span>
<span class="cm"> *</span>
<span class="cm"> * Inputs : tpnt - template for this SCSI adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns : 1 if a host adapter was found, 0 if not.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sun3scsi_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span> <span class="n">tpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addrs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">IOBASE_SUN3_VMESCSI</span><span class="p">,</span> 
				   <span class="n">IOBASE_SUN3_VMESCSI</span> <span class="o">+</span> <span class="mh">0x4000</span><span class="p">,</span>
				   <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vecs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SUN3_VEC_VMESCSI0</span><span class="p">,</span>
				  <span class="n">SUN3_VEC_VMESCSI1</span><span class="p">,</span>
				  <span class="mi">0</span> <span class="p">};</span>
	<span class="cm">/* check that this machine has an onboard 5380 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_machtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SM_SUN3</span><span class="o">|</span><span class="n">SM_3_160</span>:
	<span class="k">case</span> <span class="n">SM_SUN3</span><span class="o">|</span><span class="n">SM_3_260</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">called</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">proc_name</span> <span class="o">=</span> <span class="s">&quot;Sun3 5380 VME SCSI&quot;</span><span class="p">;</span>

	<span class="cm">/* setup variables */</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">setup_can_queue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">setup_can_queue</span> <span class="o">:</span> <span class="n">CAN_QUEUE</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">setup_cmd_per_lun</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">setup_cmd_per_lun</span> <span class="o">:</span> <span class="n">CMD_PER_LUN</span><span class="p">;</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> 
		<span class="p">(</span><span class="n">setup_sg_tablesize</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">setup_sg_tablesize</span> <span class="o">:</span> <span class="n">SG_TABLESIZE</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_hostid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">setup_hostid</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* use 7 as default */</span>
		<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span><span class="p">;</span>
		
		<span class="n">ioaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sun3_ioremap</span><span class="p">(</span><span class="n">addrs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
						     <span class="n">SUN3_PAGE_TYPE_VME16</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">sun3_scsi_regp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">;</span>
		
		<span class="n">dregs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sun3_dma_regs</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		
		<span class="k">if</span><span class="p">(</span><span class="n">sun3_map_test</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dregs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">oldcsr</span><span class="p">;</span>

			<span class="n">oldcsr</span> <span class="o">=</span> <span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">;</span>
			<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">SUN3_DMA_DELAY</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">==</span> <span class="mh">0x1400</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			
			<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">=</span> <span class="n">oldcsr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">ioaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	
<span class="cp">#ifdef SUPPORT_TAGS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_use_tagged_queuing</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">setup_use_tagged_queuing</span> <span class="o">=</span> <span class="n">USE_TAGGED_QUEUING</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">instance</span> <span class="o">=</span> <span class="n">scsi_register</span> <span class="p">(</span><span class="n">tpnt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR5380_hostdata</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		
	<span class="n">default_instance</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>

        <span class="n">instance</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">NCR5380_init</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

        <span class="p">((</span><span class="k">struct</span> <span class="n">NCR5380_hostdata</span> <span class="o">*</span><span class="p">)</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">scsi_sun3_intr</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Sun3SCSI-5380VME&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifndef REAL_DMA</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: IRQ%d not free, interrupts disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: IRQ%d not free, bailing out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: Sun3 5380 VME at port %lX irq&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;s disabled&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot; %d&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; options CAN_QUEUE=%d CMD_PER_LUN=%d release=%d&quot;</span><span class="p">,</span>
	       <span class="n">instance</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span><span class="p">,</span>
	       <span class="n">SUN3SCSI_PUBLIC_RELEASE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">scsi%d:&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">NCR5380_print_options</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">SUN3_DMA_DELAY</span><span class="p">);</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">=</span> <span class="n">CSR_SCSI</span> <span class="o">|</span> <span class="n">CSR_FIFO</span> <span class="o">|</span> <span class="n">CSR_INTR</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">SUN3_DMA_DELAY</span><span class="p">);</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_addr_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_addr_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">ivect</span> <span class="o">=</span> <span class="n">VME_DATA24</span> <span class="o">|</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">called</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef RESET_BOOT</span>
	<span class="n">sun3_scsi_reset_boot</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sun3scsi_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">shpnt</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">shpnt</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sun3_scsi_regp</span><span class="p">);</span>

	<span class="n">NCR5380_exit</span><span class="p">(</span><span class="n">shpnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef RESET_BOOT</span>
<span class="cm">/*</span>
<span class="cm"> * Our &#39;bus reset on boot&#39; function</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sun3_scsi_reset_boot</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">NCR5380_local_declare</span><span class="p">();</span>
	<span class="n">NCR5380_setup</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Do a SCSI reset to clean up the bus during initialization. No</span>
<span class="cm">	 * messing with the queues, interrupts, or locks necessary here.</span>
<span class="cm">	 */</span>

	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;Sun3 SCSI: resetting the SCSI bus...&quot;</span> <span class="p">);</span>

	<span class="cm">/* switch off SCSI IRQ - catch an interrupt without IRQ bit set else */</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><pre><code>      sun3_disable_irq( IRQ_SUN3_SCSI );
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* get in phase */</span>
	<span class="n">NCR5380_write</span><span class="p">(</span> <span class="n">TARGET_COMMAND_REG</span><span class="p">,</span>
		      <span class="n">PHASE_SR_TO_TCR</span><span class="p">(</span> <span class="n">NCR5380_read</span><span class="p">(</span><span class="n">STATUS_REG</span><span class="p">)</span> <span class="p">));</span>

	<span class="cm">/* assert RST */</span>
	<span class="n">NCR5380_write</span><span class="p">(</span> <span class="n">INITIATOR_COMMAND_REG</span><span class="p">,</span> <span class="n">ICR_BASE</span> <span class="o">|</span> <span class="n">ICR_ASSERT_RST</span> <span class="p">);</span>

	<span class="cm">/* The min. reset hold time is 25us, so 40us should be enough */</span>
	<span class="n">udelay</span><span class="p">(</span> <span class="mi">50</span> <span class="p">);</span>

	<span class="cm">/* reset RST and interrupt */</span>
	<span class="n">NCR5380_write</span><span class="p">(</span> <span class="n">INITIATOR_COMMAND_REG</span><span class="p">,</span> <span class="n">ICR_BASE</span> <span class="p">);</span>
	<span class="n">NCR5380_read</span><span class="p">(</span> <span class="n">RESET_PARITY_INTERRUPT_REG</span> <span class="p">);</span>

	<span class="k">for</span><span class="p">(</span> <span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">AFTER_RESET_DELAY</span><span class="p">;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span> <span class="p">)</span>
		<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* switch on SCSI IRQ again */</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><pre><code>      sun3_enable_irq( IRQ_SUN3_SCSI );
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot; done</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">sun3scsi_info</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">spnt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>safe bits for the CSR</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define CSR_GOOD 0x060f</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">scsi_sun3_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">csr</span> <span class="o">=</span> <span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSR_DMA_ENABLE</span><span class="p">;</span>


<span class="cp">#ifdef SUN3_SCSI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi_intr csr %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CSR_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">CSR_DMA_BUSERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: bus error in dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">default_instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
<span class="cp">#ifdef SUN3_SCSI_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi: residual %x count %x addr %p dmaaddr %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			       <span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count</span><span class="p">,</span>
			       <span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_lo</span> <span class="o">|</span> <span class="p">(</span><span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>
			       <span class="n">sun3_dma_orig_addr</span><span class="p">,</span>
			       <span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_addr_lo</span> <span class="o">|</span> <span class="p">(</span><span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_addr_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">CSR_DMA_CONFLICT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%d: dma conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">default_instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSR_SDB_INT</span> <span class="o">|</span> <span class="n">CSR_DMA_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NCR5380_intr</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dummy</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Debug stuff - to be called on NMI, or sysrq key. Use at your own risk; </span>
<span class="cm"> * reentering NCR5380_print_status seems to have ugly side effects</span>
<span class="cm"> */</span>

<span class="cm">/* this doesn&#39;t seem to get used at all -- sam */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">void sun3_sun3_debug (void)</span>
<span class="c">{</span>
<span class="c">	unsigned long flags;</span>
<span class="c">	NCR5380_local_declare();</span>

<span class="c">	if (default_instance) {</span>
<span class="c">			local_irq_save(flags);</span>
<span class="c">			NCR5380_print_status(default_instance);</span>
<span class="c">			local_irq_restore(flags);</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>


<span class="cm">/* sun3scsi_dma_setup() -- initialize the dma controller for a read/write */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sun3scsi_dma_setup</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">sun3_dma_orig_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dvma_unmap</span><span class="p">(</span><span class="n">sun3_dma_orig_addr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>addr = sun3<em>dvma</em>page((unsigned long)data, (unsigned long)dmabuf);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dvma_map_vme</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		
	<span class="n">sun3_dma_orig_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">sun3_dma_orig_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	
<span class="cp">#ifdef SUN3_SCSI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi: dma_setup addr %p count %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>dregs->fifo_count = 0;</p></td><td class="code"><div class="highlight"><pre><span class="cp">#if 0</span><span class="c">	</span>
<span class="c">	/* reset fifo */</span>
<span class="c">	dregs-&gt;csr &amp;= ~CSR_FIFO;</span>
<span class="c">	dregs-&gt;csr |= CSR_FIFO;</span>
<span class="cp">#endif	</span>
	<span class="cm">/* set direction */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">write_flag</span><span class="p">)</span>
		<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">|=</span> <span class="n">CSR_SEND</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSR_SEND</span><span class="p">;</span>
	
	<span class="cm">/* reset fifo */</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>dregs->csr &amp;= ~CSR<em>FIFO;
dregs->csr |= CSR</em>FIFO;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">|=</span> <span class="n">CSR_PACK_ENABLE</span><span class="p">;</span>

	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_addr_hi</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_addr_lo</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		
<span class="cp">#ifdef SUN3_SCSI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi: dma_setup done csr %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">);</span>
<span class="cp">#endif</span>
       	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sun3scsi_dma_residual</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">last_residual</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sun3scsi_dma_xfer_len</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wanted</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="n">write_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span>
 		<span class="k">return</span> <span class="n">wanted</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sun3scsi_dma_start</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">csr</span><span class="p">;</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">;</span>
<span class="cp">#ifdef SUN3_SCSI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi: dma_start data %p count %x csr %x fifo %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">csr</span><span class="p">,</span> <span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count</span><span class="p">);</span>
<span class="cp">#endif</span>
	
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">sun3_dma_orig_count</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">sun3_dma_orig_count</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">sun3_dma_orig_count</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">sun3_dma_orig_count</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>if(!(csr &amp; CSR<em>DMA</em>ENABLE))
    dregs->csr |= CSR<em>DMA</em>ENABLE;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* clean up after our dma is done */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sun3scsi_dma_finish</span><span class="p">(</span><span class="kt">int</span> <span class="n">write_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">sun3_dma_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSR_DMA_ENABLE</span><span class="p">;</span>
	
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">write_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">fifo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;</span> <span class="n">sun3_dma_orig_count</span><span class="p">))</span>
			<span class="n">fifo</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">last_residual</span> <span class="o">=</span> <span class="n">fifo</span><span class="p">;</span>
<span class="cp">#ifdef SUN3_SCSI_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi: residual %x total %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">sun3_dma_orig_count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* empty bytes from the fifo which didn&#39;t make it */</span>
	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">write_flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">CSR_LEFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>

<span class="cp">#ifdef SUN3_SCSI_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi: got left over bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dvma_vmetov</span><span class="p">(</span><span class="n">sun3_dma_orig_addr</span><span class="p">);</span>
		
		<span class="n">vaddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sun3_dma_orig_count</span> <span class="o">-</span> <span class="n">fifo</span><span class="p">);</span>
		<span class="n">vaddr</span><span class="o">--</span><span class="p">;</span>
		
		<span class="k">switch</span><span class="p">(</span><span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">CSR_LEFT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CSR_LEFT_3</span>:
			<span class="o">*</span><span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dregs</span><span class="o">-&gt;</span><span class="n">bpack_lo</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">vaddr</span><span class="o">--</span><span class="p">;</span>
			
		<span class="k">case</span> <span class="n">CSR_LEFT_2</span>:
			<span class="o">*</span><span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dregs</span><span class="o">-&gt;</span><span class="n">bpack_hi</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
			<span class="n">vaddr</span><span class="o">--</span><span class="p">;</span>
			
		<span class="k">case</span> <span class="n">CSR_LEFT_1</span>:
			<span class="o">*</span><span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dregs</span><span class="o">-&gt;</span><span class="n">bpack_hi</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		
		
	<span class="p">}</span>

	<span class="n">dvma_unmap</span><span class="p">(</span><span class="n">sun3_dma_orig_addr</span><span class="p">);</span>
	<span class="n">sun3_dma_orig_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_addr_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_addr_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">dma_count_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">fifo_count_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dregs</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSR_SEND</span><span class="p">;</span>
	</pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>dregs->csr |= CSR<em>DMA</em>ENABLE;</p></td><td class="code"><div class="highlight"><pre>	
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* reset fifo */</span>
<span class="c">	dregs-&gt;csr &amp;= ~CSR_FIFO;</span>
<span class="c">	dregs-&gt;csr |= CSR_FIFO;</span>
<span class="cp">#endif	</span>
	<span class="n">sun3_dma_setup_done</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#include &quot;sun3_NCR5380.c&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">SUN3_SCSI_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span>			<span class="o">=</span> <span class="n">sun3scsi_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">sun3scsi_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">sun3scsi_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">sun3scsi_queue_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>      	<span class="o">=</span> <span class="n">sun3scsi_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>  	<span class="o">=</span> <span class="n">sun3scsi_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="n">CAN_QUEUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">SG_TABLESIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="n">CMD_PER_LUN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span>
<span class="p">};</span>


<span class="cp">#include &quot;scsi_module.c&quot;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
