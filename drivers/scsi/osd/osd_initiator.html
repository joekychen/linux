<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › osd › osd_initiator.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>osd_initiator.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * osd_initiator - Main body of the osd initiator library.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: The file does not contain the advanced security functionality which</span>
<span class="cm"> * is only needed by the security_manager&#39;s initiators.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Panasas Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *   Boaz Harrosh &lt;bharrosh@panasas.com&gt;</span>
<span class="cm"> *   Benny Halevy &lt;bhalevy@panasas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> *  1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *  2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *     documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *  3. Neither the name of the Panasas company nor the names of its</span>
<span class="cm"> *     contributors may be used to endorse or promote products derived</span>
<span class="cm"> *     from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> * DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="cm"> * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="cm"> * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm"> * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;scsi/osd_initiator.h&gt;</span>
<span class="cp">#include &lt;scsi/osd_sec.h&gt;</span>
<span class="cp">#include &lt;scsi/osd_attributes.h&gt;</span>
<span class="cp">#include &lt;scsi/osd_sense.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>

<span class="cp">#include &quot;osd_debug.h&quot;</span>

<span class="cp">#ifndef __unused</span>
<span class="cp">#    define __unused			__attribute__((unused))</span>
<span class="cp">#endif</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">OSD_REQ_RETRIES</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Boaz Harrosh &lt;bharrosh@panasas.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;open-osd initiator library libosd.ko&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">build_test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* structures were not packed */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_capability</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OSD_CAP_LEN</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osdv2_cdb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OSD_TOTAL_CDB_LEN</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osdv1_cdb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OSDv1_TOTAL_CDB_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">_osd_ver_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;OSD1&quot;</span> <span class="o">:</span> <span class="s">&quot;OSD2&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ATTR_DEF_RI(id, len) ATTR_DEF(OSD_APAGE_ROOT_INFORMATION, id, len)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_get_print_system_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">od</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">caps</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_dev_info</span> <span class="o">*</span><span class="n">odi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_attr</span> <span class="n">get_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_VENDOR_IDENTIFICATION</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_PRODUCT_IDENTIFICATION</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_PRODUCT_MODEL</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_PRODUCT_REVISION_LEVEL</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_PRODUCT_SERIAL_NUMBER</span><span class="p">,</span> <span class="mi">64</span> <span class="cm">/*variable*/</span><span class="p">),</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_OSD_NAME</span><span class="p">,</span> <span class="mi">64</span> <span class="cm">/*variable*/</span><span class="p">),</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_TOTAL_CAPACITY</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_USED_CAPACITY</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_NUMBER_OF_PARTITIONS</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_CLOCK</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
		<span class="cm">/* IBM-OSD-SIM Has a bug with this one put it last */</span>
		<span class="n">ATTR_DEF_RI</span><span class="p">(</span><span class="n">OSD_ATTR_RI_OSD_SYSTEM_ID</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
	<span class="p">};</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pFirst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nelem</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">get_attrs</span><span class="p">),</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">or</span> <span class="o">=</span> <span class="n">osd_start_request</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* get attrs */</span>
	<span class="n">osd_req_get_attributes</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osd_root_object</span><span class="p">);</span>
	<span class="n">osd_req_add_get_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">get_attrs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">get_attrs</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_finalize_request</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">caps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">osd_execute_request</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OSD_ERR</span><span class="p">(</span><span class="s">&quot;Failed to detect %s =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_osd_ver_desc</span><span class="p">(</span><span class="n">or</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">osd_req_decode_get_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">get_attrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nelem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="p">);</span>

	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;Detected %s device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">_osd_ver_desc</span><span class="p">(</span><span class="n">or</span><span class="p">));</span>

	<span class="n">pFirst</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">++</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;VENDOR_IDENTIFICATION  [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">);</span>

	<span class="n">pFirst</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">++</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;PRODUCT_IDENTIFICATION [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">);</span>

	<span class="n">pFirst</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">++</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;PRODUCT_MODEL          [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">);</span>

	<span class="n">pFirst</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">++</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;PRODUCT_REVISION_LEVEL [%u]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pFirst</span> <span class="o">?</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="n">pFirst</span><span class="p">)</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0U</span><span class="p">);</span>

	<span class="n">pFirst</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">++</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;PRODUCT_SERIAL_NUMBER  [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">);</span>

	<span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname_len</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
	<span class="cm">/* Avoid NULL for memcmp optimization 0-length is good enough */</span>
	<span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname</span><span class="p">,</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">,</span> <span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname_len</span><span class="p">);</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;OSD_NAME               [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">odi</span><span class="o">-&gt;</span><span class="n">osdname</span><span class="p">);</span>
	<span class="n">a</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pFirst</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">++</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;TOTAL_CAPACITY         [0x%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pFirst</span> <span class="o">?</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">get_unaligned_be64</span><span class="p">(</span><span class="n">pFirst</span><span class="p">))</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>

	<span class="n">pFirst</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">++</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;USED_CAPACITY          [0x%llx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pFirst</span> <span class="o">?</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">get_unaligned_be64</span><span class="p">(</span><span class="n">pFirst</span><span class="p">))</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>

	<span class="n">pFirst</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">++</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;NUMBER_OF_PARTITIONS   [%llu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pFirst</span> <span class="o">?</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">get_unaligned_be64</span><span class="p">(</span><span class="n">pFirst</span><span class="p">))</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="n">nelem</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* FIXME: Where are the time utilities */</span>
	<span class="n">pFirst</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">++</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;CLOCK                  [0x%02x%02x%02x%02x%02x%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span>
		<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">)[</span><span class="mi">4</span><span class="p">],</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFirst</span><span class="p">)[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">nelem</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* IBM-OSD-SIM bug, Might not have it */</span>
		<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">sid_dump</span><span class="p">[</span><span class="mi">32</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span> <span class="cm">/* 2nibbles+space+ASCII */</span>

		<span class="n">hex_dump_to_buffer</span><span class="p">(</span><span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="n">sid_dump</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sid_dump</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">OSD_INFO</span><span class="p">(</span><span class="s">&quot;OSD_SYSTEM_ID(%d)</span><span class="se">\n</span><span class="s">&quot;</span>
			 <span class="s">&quot;        [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">sid_dump</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">systemid</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">OSD_ERR</span><span class="p">(</span><span class="s">&quot;OSD Target error: OSD_SYSTEM_ID too long(%d). &quot;</span>
				<span class="s">&quot;device idetification might not work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">systemid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">odi</span><span class="o">-&gt;</span><span class="n">systemid_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">odi</span><span class="o">-&gt;</span><span class="n">systemid</span><span class="p">,</span> <span class="n">get_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">].</span><span class="n">val_ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">a</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">osd_end_request</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">osd_auto_detect_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">od</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">caps</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_dev_info</span> <span class="o">*</span><span class="n">odi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Auto-detect the osd version */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_osd_get_print_system_info</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="n">caps</span><span class="p">,</span> <span class="n">odi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osd_dev_set_ver</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="n">OSD_VER1</span><span class="p">);</span>
		<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;converting to OSD1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_osd_get_print_system_info</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="n">caps</span><span class="p">,</span> <span class="n">odi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_auto_detect_ver</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">_osd_req_cdb_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">)</span> <span class="o">?</span> <span class="n">OSDv1_TOTAL_CDB_LEN</span> <span class="o">:</span> <span class="n">OSD_TOTAL_CDB_LEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">_osd_req_alist_elem_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">osdv1_attr_list_elem_size</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">osdv2_attr_list_elem_size</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_req_alist_elem_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">attr_last</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">oa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv1_attributes_list_element</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr_last</span><span class="p">;</span>

		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_page</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_page</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_id</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_id</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_bytes</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_val</span><span class="p">,</span> <span class="n">oa</span><span class="o">-&gt;</span><span class="n">val_ptr</span><span class="p">,</span> <span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv2_attributes_list_element</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr_last</span><span class="p">;</span>

		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_page</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_page</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_id</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_id</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_bytes</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_val</span><span class="p">,</span> <span class="n">oa</span><span class="o">-&gt;</span><span class="n">val_ptr</span><span class="p">,</span> <span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_req_alist_elem_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cur_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">oa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">max_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">inc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv1_attributes_list_element</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">cur_p</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_bytes</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_bytes</span><span class="p">);</span>
		<span class="n">inc</span> <span class="o">=</span> <span class="n">_osd_req_alist_elem_size</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inc</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_page</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_page</span><span class="p">);</span>
		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_id</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_id</span><span class="p">);</span>

		<span class="cm">/* OSD1: On empty attributes we return a pointer to 2 bytes</span>
<span class="cm">		 * of zeros. This keeps similar behaviour with OSD2.</span>
<span class="cm">		 * (See below)</span>
<span class="cm">		 */</span>
		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">val_ptr</span> <span class="o">=</span> <span class="n">likely</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_val</span> <span class="o">:</span>
						<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_bytes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv2_attributes_list_element</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">cur_p</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_bytes</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_bytes</span><span class="p">);</span>
		<span class="n">inc</span> <span class="o">=</span> <span class="n">_osd_req_alist_elem_size</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inc</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_page</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_page</span><span class="p">);</span>
		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_id</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_id</span><span class="p">);</span>

		<span class="cm">/* OSD2: For convenience, on empty attributes, we return 8 bytes</span>
<span class="cm">		 * of zeros here. This keeps the same behaviour with OSD2r04,</span>
<span class="cm">		 * and is nice with null terminating ASCII fields.</span>
<span class="cm">		 * oa-&gt;val_ptr == NULL marks the end-of-list, or error.</span>
<span class="cm">		 */</span>
		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">val_ptr</span> <span class="o">=</span> <span class="n">likely</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_val</span> <span class="o">:</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">inc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">_osd_req_alist_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">list_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">osdv1_list_size</span><span class="p">(</span><span class="n">list_head</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">osdv2_list_size</span><span class="p">(</span><span class="n">list_head</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">_osd_req_sizeof_alist_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">)</span> <span class="o">?</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osdv1_attributes_list_header</span><span class="p">)</span> <span class="o">:</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osdv2_attributes_list_header</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_req_set_alist_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">list_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv1_attributes_list_header</span> <span class="o">*</span><span class="n">attr_list</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">attr_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attr_list</span><span class="p">));</span>
		<span class="n">attr_list</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">list_type</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv2_attributes_list_header</span> <span class="o">*</span><span class="n">attr_list</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">attr_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attr_list</span><span class="p">));</span>
		<span class="n">attr_list</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">list_type</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_osd_req_is_alist_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">list_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv1_attributes_list_header</span> <span class="o">*</span><span class="n">attr_list</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">attr_list</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">list_type</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osdv2_attributes_list_header</span> <span class="o">*</span><span class="n">attr_list</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">attr_list</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">list_type</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This is for List-objects not Attributes-Lists */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_req_encode_olist</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">osd_obj_id_list</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="n">cdbh</span> <span class="o">=</span> <span class="n">osd_cdb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">list_identifier</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">list_identifier</span><span class="p">;</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">continuation_id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">list_identifier</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">list_identifier</span><span class="p">;</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">continuation_id</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">osd_cdb_offset</span> <span class="nf">osd_req_encode_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">padding</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__osd_encode_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span>
			<span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">OSDv1_OFFSET_MIN_SHIFT</span> <span class="o">:</span> <span class="n">OSD_OFFSET_MIN_SHIFT</span><span class="p">,</span>
			<span class="n">OSD_OFFSET_MAX_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">osd_security_parameters</span> <span class="o">*</span>
<span class="nf">_osd_req_sec_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb</span> <span class="o">*</span><span class="n">ocdb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osd_security_parameters</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">sec_params</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osd_security_parameters</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">sec_params</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">osd_dev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">osdd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">scsi_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">osdd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">osdd</span><span class="p">));</span>
	<span class="n">osdd</span><span class="o">-&gt;</span><span class="n">scsi_device</span> <span class="o">=</span> <span class="n">scsi_device</span><span class="p">;</span>
	<span class="n">osdd</span><span class="o">-&gt;</span><span class="n">def_timeout</span> <span class="o">=</span> <span class="n">BLK_DEFAULT_SG_TIMEOUT</span><span class="p">;</span>
<span class="cp">#ifdef OSD_VER1_SUPPORT</span>
	<span class="n">osdd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">OSD_VER2</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* TODO: Allocate pools for osd_request attributes ... */</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_dev_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">osd_dev_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">osdd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO: De-allocate pools */</span>

	<span class="n">osdd</span><span class="o">-&gt;</span><span class="n">scsi_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_dev_fini</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="nf">_osd_request_alloc</span><span class="p">(</span><span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">;</span>

	<span class="cm">/* TODO: Use mempool with one saved request */</span>
	<span class="n">or</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">or</span><span class="p">),</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">or</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_request_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="nf">osd_start_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">;</span>

	<span class="n">or</span> <span class="o">=</span> <span class="n">_osd_request_alloc</span><span class="p">(</span><span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">osd_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">alloc_flags</span> <span class="o">=</span> <span class="n">gfp</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">def_timeout</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="n">OSD_REQ_RETRIES</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">or</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_start_request</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_free_seg</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span> <span class="n">__unused</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_osd_req_data_segment</span> <span class="o">*</span><span class="n">seg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">buff</span> <span class="o">||</span> <span class="o">!</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">buff</span><span class="p">);</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_put_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If osd_finalize_request() was called but the request was not</span>
<span class="cm">	 * executed through the block layer, then we must release BIOs.</span>
<span class="cm">	 * TODO: Keep error code in or-&gt;async_error. Need to audit all</span>
<span class="cm">	 *       code paths.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">))</span>
		<span class="n">blk_end_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">osd_end_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">next_rq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_put_request</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">next_rq</span><span class="p">);</span>
			<span class="n">rq</span><span class="o">-&gt;</span><span class="n">next_rq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">_osd_free_seg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">);</span>
	<span class="n">_osd_free_seg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">);</span>
	<span class="n">_osd_free_seg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">);</span>
	<span class="n">_osd_free_seg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">);</span>

	<span class="n">_osd_request_free</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_end_request</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_set_error_resid</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">async_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">req_errors</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">?</span> <span class="o">:</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">req</span><span class="p">)</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">resid_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">req</span><span class="p">)</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">resid_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">osd_execute_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">_set_error_resid</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_execute_request</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">osd_request_async_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">end_io_data</span><span class="p">;</span>

	<span class="n">_set_error_resid</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">next_rq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__blk_put_request</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">next_rq</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">next_rq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__blk_put_request</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">async_done</span><span class="p">)</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">async_done</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">async_private</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">osd_end_request</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">osd_execute_request_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">osd_req_done_fn</span> <span class="o">*</span><span class="n">done</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">end_io_data</span> <span class="o">=</span> <span class="n">or</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">async_private</span> <span class="o">=</span> <span class="n">private</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">async_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">blk_execute_rq_nowait</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="n">osd_request_async_done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_execute_request_async</span><span class="p">);</span>

<span class="n">u8</span> <span class="n">sg_out_pad_buffer</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OSDv1_OFFSET_MIN_SHIFT</span><span class="p">];</span>
<span class="n">u8</span> <span class="n">sg_in_pad_buffer</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OSDv1_OFFSET_MIN_SHIFT</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_realloc_seg</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_osd_req_data_segment</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">max_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">&gt;=</span> <span class="n">max_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">krealloc</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">buff</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">alloc_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OSD_ERR</span><span class="p">(</span><span class="s">&quot;Failed to Realloc %d-bytes was-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">,</span>
			<span class="n">seg</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_bytes</span> <span class="o">-</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">);</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">buff</span> <span class="o">=</span> <span class="n">buff</span><span class="p">;</span>
	<span class="n">seg</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">=</span> <span class="n">max_bytes</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_alloc_cdb_cont</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">total_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;total_bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_osd_realloc_seg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">,</span> <span class="n">total_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_alloc_set_attr_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">oa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nelem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">add_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">total_bytes</span> <span class="o">=</span> <span class="n">add_bytes</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">nelem</span><span class="p">;</span> <span class="o">--</span><span class="n">nelem</span><span class="p">,</span> <span class="o">++</span><span class="n">oa</span><span class="p">)</span>
		<span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">_osd_req_alist_elem_size</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;total_bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_osd_realloc_seg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">,</span> <span class="n">total_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_alloc_get_attr_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">max_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;total_bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_osd_realloc_seg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_alloc_get_attr_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;total_bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_osd_realloc_seg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Common to all OSD commands</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osdv1_req_encode_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">__be16</span> <span class="n">act</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osdv1_cdb</span> <span class="o">*</span><span class="n">ocdb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">.</span><span class="n">v1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For speed, the commands</span>
<span class="cm">	 *	OSD_ACT_PERFORM_SCSI_COMMAND	, V1 0x8F7E, V2 0x8F7C</span>
<span class="cm">	 *	OSD_ACT_SCSI_TASK_MANAGEMENT	, V1 0x8F7F, V2 0x8F7D</span>
<span class="cm">	 * are not supported here. Should pass zero and set after the call</span>
<span class="cm">	 */</span>
	<span class="n">act</span> <span class="o">&amp;=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="o">~</span><span class="mh">0x0080</span><span class="p">);</span> <span class="cm">/* V1 action code */</span>

	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;OSDv1 execute opcode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">act</span><span class="p">));</span>

	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">varlen_cdb</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">VARIABLE_LENGTH_CMD</span><span class="p">;</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">varlen_cdb</span><span class="p">.</span><span class="n">additional_cdb_length</span> <span class="o">=</span> <span class="n">OSD_ADDITIONAL_CDB_LENGTH</span><span class="p">;</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">varlen_cdb</span><span class="p">.</span><span class="n">service_action</span> <span class="o">=</span> <span class="n">act</span><span class="p">;</span>

	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">);</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">object</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osdv2_req_encode_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	 <span class="n">__be16</span> <span class="n">act</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osdv2_cdb</span> <span class="o">*</span><span class="n">ocdb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">.</span><span class="n">v2</span><span class="p">;</span>

	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;OSDv2 execute opcode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">act</span><span class="p">));</span>

	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">varlen_cdb</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">VARIABLE_LENGTH_CMD</span><span class="p">;</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">varlen_cdb</span><span class="p">.</span><span class="n">additional_cdb_length</span> <span class="o">=</span> <span class="n">OSD_ADDITIONAL_CDB_LENGTH</span><span class="p">;</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">varlen_cdb</span><span class="p">.</span><span class="n">service_action</span> <span class="o">=</span> <span class="n">act</span><span class="p">;</span>

	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">);</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">object</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">start_address</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_req_encode_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">__be16</span> <span class="n">act</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">))</span>
		<span class="n">_osdv1_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">act</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">_osdv2_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">act</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Device commands</span>
<span class="cm"> */</span>
<span class="cm">/*TODO: void osd_req_set_master_seed_xchg(struct osd_request *, ...); */</span>
<span class="cm">/*TODO: void osd_req_set_master_key(struct osd_request *, ...); */</span>

<span class="kt">void</span> <span class="nf">osd_req_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tot_capacity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_FORMAT_OSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osd_root_object</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">tot_capacity</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_format</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">osd_req_list_dev_partitions</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">osd_id</span> <span class="n">initial_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_obj_id_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nelem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">osd_req_list_partition_objects</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">initial_id</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">nelem</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_list_dev_partitions</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_req_encode_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">osd_options_flush_scope_values</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="n">ocdb</span> <span class="o">=</span> <span class="n">osd_cdb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">);</span>

	<span class="n">ocdb</span><span class="o">-&gt;</span><span class="n">command_specific_options</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">osd_req_flush_obsd</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">osd_options_flush_scope_values</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_FLUSH_OSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osd_root_object</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">_osd_req_encode_flush</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_flush_obsd</span><span class="p">);</span>

<span class="cm">/*TODO: void osd_req_perform_scsi_command(struct osd_request *,</span>
<span class="cm">	const u8 *cdb, ...); */</span>
<span class="cm">/*TODO: void osd_req_task_management(struct osd_request *, ...); */</span>

<span class="cm">/*</span>
<span class="cm"> * Partition commands</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_osd_req_encode_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">__be16</span> <span class="n">act</span><span class="p">,</span> <span class="n">osd_id</span> <span class="n">partition</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="n">par</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">partition</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">act</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">osd_req_create_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="n">osd_id</span> <span class="n">partition</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_partition</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_CREATE_PARTITION</span><span class="p">,</span> <span class="n">partition</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_create_partition</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">osd_req_remove_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="n">osd_id</span> <span class="n">partition</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_partition</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_REMOVE_PARTITION</span><span class="p">,</span> <span class="n">partition</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_remove_partition</span><span class="p">);</span>

<span class="cm">/*TODO: void osd_req_set_partition_key(struct osd_request *,</span>
<span class="cm">	osd_id partition, u8 new_key_id[OSD_CRYPTO_KEYID_SIZE],</span>
<span class="cm">	u8 seed[OSD_CRYPTO_SEED_SIZE]); */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_req_list_objects</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">__be16</span> <span class="n">action</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">osd_id</span> <span class="n">initial_id</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">osd_obj_id_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nelem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">osd_request_queue</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">osd_dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nelem</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">osd_id</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>

	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">initial_id</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">list_identifier</span><span class="p">)</span>
		<span class="n">_osd_req_encode_olist</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_map_kern</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">alloc_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">OSD_ERR</span><span class="p">(</span><span class="s">&quot;!!! Failed to allocate list_objects BIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">REQ_WRITE</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">osd_req_list_partition_collections</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">osd_id</span> <span class="n">partition</span><span class="p">,</span> <span class="n">osd_id</span> <span class="n">initial_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_obj_id_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">nelem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="n">par</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">partition</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">osd_req_list_collection_objects</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">,</span> <span class="n">initial_id</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span>
					       <span class="n">nelem</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_list_partition_collections</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">osd_req_list_partition_objects</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">osd_id</span> <span class="n">partition</span><span class="p">,</span> <span class="n">osd_id</span> <span class="n">initial_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_obj_id_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">nelem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="n">par</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">partition</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">_osd_req_list_objects</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">par</span><span class="p">,</span> <span class="n">initial_id</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span>
				     <span class="n">nelem</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_list_partition_objects</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">osd_req_flush_partition</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">osd_id</span> <span class="n">partition</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_options_flush_scope_values</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_partition</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_FLUSH_PARTITION</span><span class="p">,</span> <span class="n">partition</span><span class="p">);</span>
	<span class="n">_osd_req_encode_flush</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_flush_partition</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Collection commands</span>
<span class="cm"> */</span>
<span class="cm">/*TODO: void osd_req_create_collection(struct osd_request *,</span>
<span class="cm">	const struct osd_obj_id *); */</span>
<span class="cm">/*TODO: void osd_req_remove_collection(struct osd_request *,</span>
<span class="cm">	const struct osd_obj_id *); */</span>

<span class="kt">int</span> <span class="nf">osd_req_list_collection_objects</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">osd_id</span> <span class="n">initial_id</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">osd_obj_id_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nelem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_osd_req_list_objects</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_LIST_COLLECTION</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span>
				     <span class="n">initial_id</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">nelem</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_list_collection_objects</span><span class="p">);</span>

<span class="cm">/*TODO: void query(struct osd_request *, ...); V2 */</span>

<span class="kt">void</span> <span class="nf">osd_req_flush_collection</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_options_flush_scope_values</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_FLUSH_PARTITION</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">_osd_req_encode_flush</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_flush_collection</span><span class="p">);</span>

<span class="cm">/*TODO: void get_member_attrs(struct osd_request *, ...); V2 */</span>
<span class="cm">/*TODO: void set_member_attrs(struct osd_request *, ...); V2 */</span>

<span class="cm">/*</span>
<span class="cm"> * Object commands</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">osd_req_create_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_CREATE</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_create_object</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">osd_req_remove_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_REMOVE</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_remove_object</span><span class="p">);</span>


<span class="cm">/*TODO: void osd_req_create_multi(struct osd_request *or,</span>
<span class="cm">	struct osd_obj_id *first, struct osd_obj_id_list *list, unsigned nelem);</span>
<span class="cm">*/</span>

<span class="kt">void</span> <span class="nf">osd_req_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_WRITE</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">bio</span> <span class="o">||</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_WRITE</span><span class="p">));</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_write</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">osd_req_write_kern</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buff</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">req_q</span> <span class="o">=</span> <span class="n">osd_request_queue</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">osd_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio_map_kern</span><span class="p">(</span><span class="n">req_q</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">|=</span> <span class="n">REQ_WRITE</span><span class="p">;</span> <span class="cm">/* FIXME: bio_set_dir() */</span>
	<span class="n">osd_req_write</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_write_kern</span><span class="p">);</span>

<span class="cm">/*TODO: void osd_req_append(struct osd_request *,</span>
<span class="cm">	const struct osd_obj_id *, struct bio *data_out); */</span>
<span class="cm">/*TODO: void osd_req_create_write(struct osd_request *,</span>
<span class="cm">	const struct osd_obj_id *, struct bio *data_out, u64 offset); */</span>
<span class="cm">/*TODO: void osd_req_clear(struct osd_request *,</span>
<span class="cm">	const struct osd_obj_id *, u64 offset, u64 len); */</span>
<span class="cm">/*TODO: void osd_req_punch(struct osd_request *,</span>
<span class="cm">	const struct osd_obj_id *, u64 offset, u64 len); V2 */</span>

<span class="kt">void</span> <span class="nf">osd_req_flush_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="k">enum</span> <span class="n">osd_options_flush_scope_values</span> <span class="n">op</span><span class="p">,</span>
	<span class="cm">/*V2*/</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="cm">/*V2*/</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">||</span> <span class="n">len</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;OSD Ver1 flush on specific range ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_FLUSH</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">_osd_req_encode_flush</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_flush_object</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">osd_req_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_READ</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">bio</span> <span class="o">||</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">&amp;</span> <span class="n">REQ_WRITE</span><span class="p">);</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_read</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">osd_req_read_kern</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buff</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">req_q</span> <span class="o">=</span> <span class="n">osd_request_queue</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">osd_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio_map_kern</span><span class="p">(</span><span class="n">req_q</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

	<span class="n">osd_req_read</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_read_kern</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_add_sg_continuation_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_sg_entry</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">numentries</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_sg_continuation_descriptor</span> <span class="o">*</span><span class="n">oscd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oscd_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">oscd_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">oscd</span><span class="p">)</span> <span class="o">+</span> <span class="n">numentries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oscd</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First time, jump over the header, we will write to:</span>
<span class="cm">		 *	cdb_cont.buff + cdb_cont.total_bytes</span>
<span class="cm">		 */</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_continuation_segment_header</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_alloc_cdb_cont</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">+</span> <span class="n">oscd_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">oscd</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">buff</span> <span class="o">+</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="n">oscd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">SCATTER_GATHER_LIST</span><span class="p">);</span>
	<span class="n">oscd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">pad_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">oscd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">oscd_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">oscd</span><span class="p">));</span>

	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* copy the sg entries and convert to network byte order */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numentries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">oscd</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sglist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">oscd</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span>    <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">sglist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">+=</span> <span class="n">sglist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">oscd_size</span><span class="p">;</span>
	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;total_bytes=%d oscd_size=%d numentries=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span> <span class="n">oscd_size</span><span class="p">,</span> <span class="n">numentries</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_req_finalize_cdb_cont</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cap_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">req_q</span> <span class="o">=</span> <span class="n">osd_request_queue</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">osd_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="n">cdbh</span> <span class="o">=</span> <span class="n">osd_cdb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">osd_continuation_segment_header</span> <span class="o">*</span><span class="n">cont_seg_hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cont_seg_hdr</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">buff</span><span class="p">;</span>
	<span class="n">cont_seg_hdr</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">CDB_CONTINUATION_FORMAT_V2</span><span class="p">;</span>
	<span class="n">cont_seg_hdr</span><span class="o">-&gt;</span><span class="n">service_action</span> <span class="o">=</span> <span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">varlen_cdb</span><span class="p">.</span><span class="n">service_action</span><span class="p">;</span>

	<span class="cm">/* create a bio for continuation segment */</span>
	<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_map_kern</span><span class="p">(</span><span class="n">req_q</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">buff</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span>
			   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">|=</span> <span class="n">REQ_WRITE</span><span class="p">;</span>

	<span class="cm">/* integrity check the continuation before the bio is linked</span>
<span class="cm">	 * with the other data segments since the continuation</span>
<span class="cm">	 * integrity is separate from the other data segments.</span>
<span class="cm">	 */</span>
	<span class="n">osd_sec_sign_data</span><span class="p">(</span><span class="n">cont_seg_hdr</span><span class="o">-&gt;</span><span class="n">integrity_check</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">cap_key</span><span class="p">);</span>

	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">cdb_continuation_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>

	<span class="cm">/* we can&#39;t use _req_append_segment, because we need to link in the</span>
<span class="cm">	 * continuation bio to the head of the bio list - the</span>
<span class="cm">	 * continuation segment (if it exists) is always the first segment in</span>
<span class="cm">	 * the out data buffer.</span>
<span class="cm">	 */</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_next</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* osd_req_write_sg: Takes a @bio that points to the data out buffer and an</span>
<span class="cm"> * @sglist that has the scatter gather entries. Scatter-gather enables a write</span>
<span class="cm"> * of multiple none-contiguous areas of an object, in a single call. The extents</span>
<span class="cm"> * may overlap and/or be in any order. The only constrain is that:</span>
<span class="cm"> *	total_bytes(sglist) &gt;= total_bytes(bio)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">osd_req_write_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_sg_entry</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">numentries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">_add_sg_continuation_descriptor</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">numentries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">osd_req_write</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_write_sg</span><span class="p">);</span>

<span class="cm">/* osd_req_read_sg: Read multiple extents of an object into @bio</span>
<span class="cm"> * See osd_req_write_sg</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">osd_req_read_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_sg_entry</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">numentries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numentries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_add_sg_continuation_descriptor</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">numentries</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Optimize the case of single segment, read_sg is a</span>
<span class="cm">		 * bidi operation.</span>
<span class="cm">		 */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">sglist</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">osd_req_read</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_read_sg</span><span class="p">);</span>

<span class="cm">/* SG-list write/read Kern API</span>
<span class="cm"> *</span>
<span class="cm"> * osd_req_{write,read}_sg_kern takes an array of @buff pointers and an array</span>
<span class="cm"> * of sg_entries. @numentries indicates how many pointers and sg_entries there</span>
<span class="cm"> * are.  By requiring an array of buff pointers. This allows a caller to do a</span>
<span class="cm"> * single write/read and scatter into multiple buffers.</span>
<span class="cm"> * NOTE: Each buffer + len should not cross a page boundary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">_create_sg_bios</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">**</span><span class="n">buff</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">osd_sg_entry</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">numentries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">osd_request_queue</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">osd_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_kmalloc</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">numentries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;Faild to allocate BIO size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">numentries</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numentries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">added_len</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">added_len</span> <span class="o">=</span> <span class="n">bio_add_pc_page</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">added_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;bio_add_pc_page len(%d) != added_len(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">len</span><span class="p">,</span> <span class="n">added_len</span><span class="p">);</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bio</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">osd_req_write_sg_kern</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">buff</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_sg_entry</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">numentries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">_create_sg_bios</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">numentries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">|=</span> <span class="n">REQ_WRITE</span><span class="p">;</span>
	<span class="n">osd_req_write_sg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">numentries</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_write_sg_kern</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">osd_req_read_sg_kern</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">buff</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_sg_entry</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">numentries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">_create_sg_bios</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">numentries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

	<span class="n">osd_req_read_sg</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">sglist</span><span class="p">,</span> <span class="n">numentries</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_read_sg_kern</span><span class="p">);</span>



<span class="kt">void</span> <span class="nf">osd_req_get_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_GET_ATTRIBUTES</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_get_attributes</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">osd_req_set_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_osd_req_encode_common</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">OSD_ACT_SET_ATTRIBUTES</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_set_attributes</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Attributes List-mode</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">osd_req_add_set_attr_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">oa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nelem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">total_bytes</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">attr_last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">&amp;&amp;</span>
	    <span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">!=</span> <span class="n">OSD_CDB_GET_SET_ATTR_LISTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">=</span> <span class="n">OSD_CDB_GET_SET_ATTR_LISTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">total_bytes</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* first-time: allocate and put list header */</span>
		<span class="n">total_bytes</span> <span class="o">=</span> <span class="n">_osd_req_sizeof_alist_header</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_alloc_set_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">oa</span><span class="p">,</span> <span class="n">nelem</span><span class="p">,</span> <span class="n">total_bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">_osd_req_set_alist_type</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">buff</span><span class="p">,</span>
					<span class="n">OSD_ATTR_LIST_SET_RETRIEVE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">attr_last</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">buff</span> <span class="o">+</span> <span class="n">total_bytes</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">nelem</span><span class="p">;</span> <span class="o">--</span><span class="n">nelem</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">elem_size</span> <span class="o">=</span> <span class="n">_osd_req_alist_elem_size</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">elem_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">alloc_size</span> <span class="o">&lt;</span> <span class="n">total_bytes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">total_bytes</span> <span class="o">-</span> <span class="n">elem_size</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">_alloc_set_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">oa</span><span class="p">,</span> <span class="n">nelem</span><span class="p">,</span> <span class="n">total_bytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">attr_last</span> <span class="o">=</span>
				<span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">buff</span> <span class="o">+</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">_osd_req_alist_elem_encode</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">attr_last</span><span class="p">,</span> <span class="n">oa</span><span class="p">);</span>

		<span class="n">attr_last</span> <span class="o">+=</span> <span class="n">elem_size</span><span class="p">;</span>
		<span class="o">++</span><span class="n">oa</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">total_bytes</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_add_set_attr_list</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_req_append_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">padding</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_osd_req_data_segment</span> <span class="o">*</span><span class="n">seg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">_osd_req_data_segment</span> <span class="o">*</span><span class="n">last_seg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_osd_io_info</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pad_buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check if we can just add it to last buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_seg</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">padding</span> <span class="o">&lt;=</span> <span class="n">last_seg</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">-</span> <span class="n">last_seg</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">))</span>
			<span class="n">pad_buff</span> <span class="o">=</span> <span class="n">last_seg</span><span class="o">-&gt;</span><span class="n">buff</span> <span class="o">+</span> <span class="n">last_seg</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pad_buff</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">pad_buff</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">pad_buff</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span>
				       <span class="n">or</span><span class="o">-&gt;</span><span class="n">alloc_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">padding</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">buff</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">,</span>
			       <span class="n">or</span><span class="o">-&gt;</span><span class="n">alloc_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">io</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;padding=%d buff=%p total_bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">seg</span><span class="o">-&gt;</span><span class="n">buff</span><span class="p">,</span>
		  <span class="n">seg</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_req_finalize_set_attr_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="n">cdbh</span> <span class="o">=</span> <span class="n">osd_cdb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">padding</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_list</span><span class="p">.</span><span class="n">set_attr_offset</span> <span class="o">=</span> <span class="n">OSD_OFFSET_UNUSED</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_list</span><span class="p">.</span><span class="n">set_attr_bytes</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>
	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_list</span><span class="p">.</span><span class="n">set_attr_offset</span> <span class="o">=</span>
		<span class="n">osd_req_encode_offset</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">padding</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_req_append_segment</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">,</span>
				  <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">last_seg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">last_seg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">osd_req_add_get_attr_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">oa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nelem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">total_bytes</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">attr_last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">&amp;&amp;</span>
	    <span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">!=</span> <span class="n">OSD_CDB_GET_SET_ATTR_LISTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">=</span> <span class="n">OSD_CDB_GET_SET_ATTR_LISTS</span><span class="p">;</span>

	<span class="cm">/* first time calc data-in list header size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">)</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">_osd_req_sizeof_alist_header</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>

	<span class="cm">/* calc data-out info */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">total_bytes</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* first-time: allocate and put list header */</span>
		<span class="kt">unsigned</span> <span class="n">max_bytes</span><span class="p">;</span>

		<span class="n">total_bytes</span> <span class="o">=</span> <span class="n">_osd_req_sizeof_alist_header</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
		<span class="n">max_bytes</span> <span class="o">=</span> <span class="n">total_bytes</span> <span class="o">+</span>
			<span class="n">nelem</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_attributes_list_attrid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_alloc_get_attr_desc</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">_osd_req_set_alist_type</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">buff</span><span class="p">,</span>
					<span class="n">OSD_ATTR_LIST_GET</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">attr_last</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">buff</span> <span class="o">+</span> <span class="n">total_bytes</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">nelem</span><span class="p">;</span> <span class="o">--</span><span class="n">nelem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">osd_attributes_list_attrid</span> <span class="o">*</span><span class="n">attrid</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">cur_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attrid</span><span class="p">);</span>

		<span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">cur_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">alloc_size</span> <span class="o">&lt;</span> <span class="n">total_bytes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">total_bytes</span> <span class="o">-</span> <span class="n">cur_size</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">_alloc_get_attr_desc</span><span class="p">(</span><span class="n">or</span><span class="p">,</span>
					<span class="n">total_bytes</span> <span class="o">+</span> <span class="n">nelem</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attrid</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">attr_last</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">buff</span> <span class="o">+</span>
				<span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">attrid</span> <span class="o">=</span> <span class="n">attr_last</span><span class="p">;</span>
		<span class="n">attrid</span><span class="o">-&gt;</span><span class="n">attr_page</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_page</span><span class="p">);</span>
		<span class="n">attrid</span><span class="o">-&gt;</span><span class="n">attr_id</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_id</span><span class="p">);</span>

		<span class="n">attr_last</span> <span class="o">+=</span> <span class="n">cur_size</span><span class="p">;</span>

		<span class="cm">/* calc data-in size */</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">+=</span>
			<span class="n">_osd_req_alist_elem_size</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="o">++</span><span class="n">oa</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">total_bytes</span><span class="p">;</span>

	<span class="n">OSD_DEBUG</span><span class="p">(</span>
	       <span class="s">&quot;get_attr.total_bytes=%u(%u) enc_get_attr.total_bytes=%u(%Zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span>
	       <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">-</span> <span class="n">_osd_req_sizeof_alist_header</span><span class="p">(</span><span class="n">or</span><span class="p">),</span>
	       <span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">-</span> <span class="n">_osd_req_sizeof_alist_header</span><span class="p">(</span><span class="n">or</span><span class="p">))</span>
			<span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_attributes_list_attrid</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_add_get_attr_list</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_req_finalize_get_attr_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="n">cdbh</span> <span class="o">=</span> <span class="n">osd_cdb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">out_padding</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">in_padding</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_list</span><span class="p">.</span><span class="n">get_attr_desc_offset</span> <span class="o">=</span> <span class="n">OSD_OFFSET_UNUSED</span><span class="p">;</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_list</span><span class="p">.</span><span class="n">get_attr_offset</span> <span class="o">=</span> <span class="n">OSD_OFFSET_UNUSED</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_alloc_get_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* The out-going buffer info update */</span>
	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;out-going</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_list</span><span class="p">.</span><span class="n">get_attr_desc_bytes</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>

	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_list</span><span class="p">.</span><span class="n">get_attr_desc_offset</span> <span class="o">=</span>
		<span class="n">osd_req_encode_offset</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_padding</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_req_append_segment</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">out_padding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">,</span>
				  <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">last_seg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">last_seg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">;</span>

	<span class="cm">/* The incoming buffer info update */</span>
	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;in-coming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_list</span><span class="p">.</span><span class="n">get_attr_alloc_length</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>

	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_list</span><span class="p">.</span><span class="n">get_attr_offset</span> <span class="o">=</span>
		<span class="n">osd_req_encode_offset</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_padding</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_req_append_segment</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">in_padding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">last_seg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">osd_req_decode_get_attr_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">oa</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nelem</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">iterator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">cur_bytes</span><span class="p">,</span> <span class="n">returned_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">sizeof_attr_list</span> <span class="o">=</span> <span class="n">_osd_req_sizeof_alist_header</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cur_p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_osd_req_is_alist_type</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">buff</span><span class="p">,</span>
				    <span class="n">OSD_ATTR_LIST_SET_RETRIEVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">attr_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">val_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">oa</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">iterator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iterator</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">((</span><span class="o">*</span><span class="n">iterator</span> <span class="o">&lt;</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">buff</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">buff</span> <span class="o">+</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">alloc_size</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">iterator</span><span class="p">));</span>
		<span class="n">cur_p</span> <span class="o">=</span> <span class="o">*</span><span class="n">iterator</span><span class="p">;</span>
		<span class="n">cur_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">iterator</span> <span class="o">-</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">buff</span><span class="p">)</span> <span class="o">-</span> <span class="n">sizeof_attr_list</span><span class="p">;</span>
		<span class="n">returned_bytes</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* first time decode the list header */</span>
		<span class="n">cur_bytes</span> <span class="o">=</span> <span class="n">sizeof_attr_list</span><span class="p">;</span>
		<span class="n">returned_bytes</span> <span class="o">=</span> <span class="n">_osd_req_alist_size</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">buff</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">sizeof_attr_list</span><span class="p">;</span>

		<span class="n">cur_p</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">buff</span> <span class="o">+</span> <span class="n">sizeof_attr_list</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">returned_bytes</span> <span class="o">&gt;</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">alloc_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;target report: space was not big enough! &quot;</span>
				  <span class="s">&quot;Allocate=%u Needed=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">alloc_size</span><span class="p">,</span>
				  <span class="n">returned_bytes</span> <span class="o">+</span> <span class="n">sizeof_attr_list</span><span class="p">);</span>

			<span class="n">returned_bytes</span> <span class="o">=</span>
				<span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">alloc_size</span> <span class="o">-</span> <span class="n">sizeof_attr_list</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">returned_bytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nelem</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur_bytes</span> <span class="o">&lt;</span> <span class="n">returned_bytes</span><span class="p">);</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">inc</span> <span class="o">=</span> <span class="n">_osd_req_alist_elem_decode</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">cur_p</span><span class="p">,</span> <span class="n">oa</span><span class="p">,</span>
						 <span class="n">returned_bytes</span> <span class="o">-</span> <span class="n">cur_bytes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OSD_ERR</span><span class="p">(</span><span class="s">&quot;BAD FOOD from target. list not valid!&quot;</span>
				<span class="s">&quot;c=%d r=%d n=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cur_bytes</span><span class="p">,</span> <span class="n">returned_bytes</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="n">oa</span><span class="o">-&gt;</span><span class="n">val_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cur_bytes</span> <span class="o">=</span> <span class="n">returned_bytes</span><span class="p">;</span> <span class="cm">/* break the caller loop */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cur_bytes</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">;</span>
		<span class="n">cur_p</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">;</span>
		<span class="o">++</span><span class="n">oa</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">iterator</span> <span class="o">=</span> <span class="p">(</span><span class="n">returned_bytes</span> <span class="o">-</span> <span class="n">cur_bytes</span><span class="p">)</span> <span class="o">?</span> <span class="n">cur_p</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">returned_bytes</span> <span class="o">-</span> <span class="n">cur_bytes</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_decode_get_attr_list</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Attributes Page-mode</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">osd_req_add_get_attr_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">page_id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">attar_page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">max_page_len</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">set_one_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="n">cdbh</span> <span class="o">=</span> <span class="n">osd_cdb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">&amp;&amp;</span>
	    <span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">!=</span> <span class="n">OSD_CDB_GET_ATTR_PAGE_SET_ONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">=</span> <span class="n">OSD_CDB_GET_ATTR_PAGE_SET_ONE</span><span class="p">;</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">buff</span> <span class="o">=</span> <span class="n">attar_page</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">max_page_len</span><span class="p">;</span>

	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_page</span><span class="p">.</span><span class="n">get_attr_page</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">page_id</span><span class="p">);</span>
	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_page</span><span class="p">.</span><span class="n">get_attr_alloc_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">max_page_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_one_attr</span> <span class="o">||</span> <span class="o">!</span><span class="n">set_one_attr</span><span class="o">-&gt;</span><span class="n">attr_page</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* The set is optional */</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">buff</span> <span class="o">=</span> <span class="n">set_one_attr</span><span class="o">-&gt;</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="n">set_one_attr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_page</span><span class="p">.</span><span class="n">set_attr_page</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">set_one_attr</span><span class="o">-&gt;</span><span class="n">attr_page</span><span class="p">);</span>
	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_page</span><span class="p">.</span><span class="n">set_attr_id</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">set_one_attr</span><span class="o">-&gt;</span><span class="n">attr_id</span><span class="p">);</span>
	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_page</span><span class="p">.</span><span class="n">set_attr_length</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">set_one_attr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_add_get_attr_page</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_req_finalize_attr_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="n">cdbh</span> <span class="o">=</span> <span class="n">osd_cdb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">in_padding</span><span class="p">,</span> <span class="n">out_padding</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* returned page */</span>
	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_page</span><span class="p">.</span><span class="n">get_attr_offset</span> <span class="o">=</span>
		<span class="n">osd_req_encode_offset</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_padding</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_req_append_segment</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">in_padding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set one value */</span>
	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">attrs_page</span><span class="p">.</span><span class="n">set_attr_offset</span> <span class="o">=</span>
		<span class="n">osd_req_encode_offset</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_padding</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_req_append_segment</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">out_padding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">osd_sec_parms_set_out_offset</span><span class="p">(</span><span class="n">bool</span> <span class="n">is_v1</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">osd_security_parameters</span> <span class="o">*</span><span class="n">sec_parms</span><span class="p">,</span> <span class="n">osd_cdb_offset</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_v1</span><span class="p">)</span>
		<span class="n">sec_parms</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">data_out_integrity_check_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sec_parms</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">data_out_integrity_check_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">osd_sec_parms_set_in_offset</span><span class="p">(</span><span class="n">bool</span> <span class="n">is_v1</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">osd_security_parameters</span> <span class="o">*</span><span class="n">sec_parms</span><span class="p">,</span> <span class="n">osd_cdb_offset</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_v1</span><span class="p">)</span>
		<span class="n">sec_parms</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">data_in_integrity_check_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sec_parms</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">data_in_integrity_check_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_osd_req_finalize_data_integrity</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">has_in</span><span class="p">,</span> <span class="n">bool</span> <span class="n">has_out</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">out_data_bio</span><span class="p">,</span> <span class="n">u64</span> <span class="n">out_data_bytes</span><span class="p">,</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cap_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_security_parameters</span> <span class="o">*</span><span class="n">sec_parms</span> <span class="o">=</span> <span class="n">_osd_req_sec_params</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osd_is_sec_alldata</span><span class="p">(</span><span class="n">sec_parms</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">_osd_req_data_segment</span> <span class="n">seg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out_data_integ</span><span class="p">,</span>
			<span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out_data_integ</span><span class="p">),</span>
		<span class="p">};</span>
		<span class="kt">unsigned</span> <span class="n">pad</span><span class="p">;</span>

		<span class="n">or</span><span class="o">-&gt;</span><span class="n">out_data_integ</span><span class="p">.</span><span class="n">data_bytes</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">out_data_bytes</span><span class="p">);</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">out_data_integ</span><span class="p">.</span><span class="n">set_attributes_bytes</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span>
			<span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">out_data_integ</span><span class="p">.</span><span class="n">get_attributes_bytes</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span>
			<span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">);</span>

		<span class="n">osd_sec_parms_set_out_offset</span><span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">),</span> <span class="n">sec_parms</span><span class="p">,</span>
			<span class="n">osd_req_encode_offset</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pad</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">_req_append_segment</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seg</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">last_seg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">last_seg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* they are now all chained to request sign them all together */</span>
		<span class="n">osd_sec_sign_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out_data_integ</span><span class="p">,</span> <span class="n">out_data_bio</span><span class="p">,</span>
				  <span class="n">cap_key</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">_osd_req_data_segment</span> <span class="n">seg</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in_data_integ</span><span class="p">,</span>
			<span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in_data_integ</span><span class="p">),</span>
		<span class="p">};</span>
		<span class="kt">unsigned</span> <span class="n">pad</span><span class="p">;</span>

		<span class="n">osd_sec_parms_set_in_offset</span><span class="p">(</span><span class="n">osd_req_is_ver1</span><span class="p">(</span><span class="n">or</span><span class="p">),</span> <span class="n">sec_parms</span><span class="p">,</span>
			<span class="n">osd_req_encode_offset</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pad</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">_req_append_segment</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seg</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">last_seg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">last_seg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * osd_finalize_request and helpers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="nf">_make_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="n">bool</span> <span class="n">has_write</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">_osd_io_info</span> <span class="o">*</span><span class="n">oii</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oii</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">blk_make_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">oii</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="n">req</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">has_write</span> <span class="o">?</span> <span class="n">WRITE</span> <span class="o">:</span> <span class="n">READ</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">req</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_init_blk_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">has_in</span><span class="p">,</span> <span class="n">bool</span> <span class="n">has_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gfp_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">alloc_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">scsi_device</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">osd_dev</span><span class="o">-&gt;</span><span class="n">scsi_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">scsi_device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">_make_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">has_out</span><span class="p">,</span> <span class="n">has_out</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_QUIET</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* allocate bidi request */</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">_make_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;blk_get_request for bidi failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>
			<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">next_rq</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">has_in</span><span class="p">)</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;or=%p has_in=%d has_out=%d =&gt; %d, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">or</span><span class="p">,</span> <span class="n">has_in</span><span class="p">,</span> <span class="n">has_out</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">osd_finalize_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">options</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cap</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cap_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_cdb_head</span> <span class="o">*</span><span class="n">cdbh</span> <span class="o">=</span> <span class="n">osd_cdb_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">has_in</span><span class="p">,</span> <span class="n">has_out</span><span class="p">;</span>
	 <span class="cm">/* Save for data_integrity without the cdb_continuation */</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">out_data_bio</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">out_data_bytes</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OSD_REQ_FUA</span><span class="p">)</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OSD_CDB_FUA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OSD_REQ_DPO</span><span class="p">)</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OSD_CDB_DPO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OSD_REQ_BYPASS_TIMESTAMPS</span><span class="p">)</span>
		<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">timestamp_control</span> <span class="o">=</span> <span class="n">OSD_CDB_BYPASS_TIMESTAMPS</span><span class="p">;</span>

	<span class="n">osd_set_caps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>

	<span class="n">has_in</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">bio</span> <span class="o">||</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="n">has_out</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">bio</span> <span class="o">||</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb_cont</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">||</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">set_attr</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">||</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">enc_get_attr</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_osd_req_finalize_cdb_cont</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">cap_key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;_osd_req_finalize_cdb_cont failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_init_blk_request</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">has_in</span><span class="p">,</span> <span class="n">has_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;_init_blk_request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">pad_buff</span> <span class="o">=</span> <span class="n">sg_out_pad_buffer</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">pad_buff</span> <span class="o">=</span> <span class="n">sg_in_pad_buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span><span class="p">)</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">=</span> <span class="n">OSD_CDB_GET_SET_ATTR_LISTS</span><span class="p">;</span>
	<span class="n">cdbh</span><span class="o">-&gt;</span><span class="n">command_specific_options</span> <span class="o">|=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">attributes_mode</span> <span class="o">==</span> <span class="n">OSD_CDB_GET_ATTR_PAGE_SET_ONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_osd_req_finalize_attr_page</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;_osd_req_finalize_attr_page failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TODO: I think that for the GET_ATTR command these 2 should</span>
<span class="cm">		 * be reversed to keep them in execution order (for embeded</span>
<span class="cm">		 * targets with low memory footprint)</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">_osd_req_finalize_set_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;_osd_req_finalize_set_attr_list failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">_osd_req_finalize_get_attr_list</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;_osd_req_finalize_get_attr_list failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">_osd_req_finalize_data_integrity</span><span class="p">(</span><span class="n">or</span><span class="p">,</span> <span class="n">has_in</span><span class="p">,</span> <span class="n">has_out</span><span class="p">,</span>
					       <span class="n">out_data_bio</span><span class="p">,</span> <span class="n">out_data_bytes</span><span class="p">,</span>
					       <span class="n">cap_key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">osd_sec_sign_cdb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cap_key</span><span class="p">);</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">.</span><span class="n">buff</span><span class="p">;</span>
	<span class="n">or</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">_osd_req_cdb_len</span><span class="p">(</span><span class="n">or</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_finalize_request</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">_is_osd_security_code</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>	<span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">osd_security_audit_value_frozen</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">osd_security_working_key_frozen</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">osd_nonce_not_unique</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">osd_nonce_timestamp_out_of_range</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">osd_invalid_dataout_buffer_integrity_check_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define OSD_SENSE_PRINT1(fmt, a...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (__cur_sense_need_output) \</span>
<span class="cp">			OSD_ERR(fmt, ##a); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define OSD_SENSE_PRINT2(fmt, a...) OSD_SENSE_PRINT1(&quot;    &quot; fmt, ##a)</span>

<span class="kt">int</span> <span class="nf">osd_req_decode_sense_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_request</span> <span class="o">*</span><span class="n">or</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">osd_sense_info</span> <span class="o">*</span><span class="n">osi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">silent</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">bad_obj_list</span> <span class="n">__unused</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_obj</span> <span class="n">__unused</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">osd_attr</span> <span class="o">*</span><span class="n">bad_attr_list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sense_len</span><span class="p">,</span> <span class="n">original_sense_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osd_sense_info</span> <span class="n">local_osi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_sense_descriptor_based</span> <span class="o">*</span><span class="n">ssdb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cur_descriptor</span><span class="p">;</span>
<span class="cp">#if (CONFIG_SCSI_OSD_DPRINT_SENSE == 0)</span>
	<span class="k">const</span> <span class="n">bool</span> <span class="n">__cur_sense_need_output</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">bool</span> <span class="n">__cur_sense_need_output</span> <span class="o">=</span> <span class="o">!</span><span class="n">silent</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">req_errors</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">osi</span> <span class="o">=</span> <span class="n">osi</span> <span class="o">?</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">local_osi</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">osi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">osi</span><span class="p">));</span>

	<span class="n">ssdb</span> <span class="o">=</span> <span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">ssdb</span><span class="p">))</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">sense_len</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sense_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ssdb</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">ssdb</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">OSD_ERR</span><span class="p">(</span><span class="s">&quot;Block-layer returned error(0x%x) but &quot;</span>
			<span class="s">&quot;sense_len(%u) || key(%d) is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">or</span><span class="o">-&gt;</span><span class="n">req_errors</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">,</span> <span class="n">ssdb</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">analyze</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ssdb</span><span class="o">-&gt;</span><span class="n">response_code</span> <span class="o">!=</span> <span class="mh">0x72</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ssdb</span><span class="o">-&gt;</span><span class="n">response_code</span> <span class="o">!=</span> <span class="mh">0x73</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">OSD_ERR</span><span class="p">(</span><span class="s">&quot;Unrecognized scsi sense: rcode=%x length=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ssdb</span><span class="o">-&gt;</span><span class="n">response_code</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">analyze</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">osi</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">ssdb</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">;</span>
	<span class="n">osi</span><span class="o">-&gt;</span><span class="n">additional_code</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ssdb</span><span class="o">-&gt;</span><span class="n">additional_sense_code</span><span class="p">);</span>
	<span class="n">original_sense_len</span> <span class="o">=</span> <span class="n">ssdb</span><span class="o">-&gt;</span><span class="n">additional_sense_length</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

<span class="cp">#if (CONFIG_SCSI_OSD_DPRINT_SENSE == 1)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__cur_sense_need_output</span><span class="p">)</span>
		<span class="n">__cur_sense_need_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&gt;</span> <span class="n">scsi_sk_recovered_error</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">OSD_SENSE_PRINT1</span><span class="p">(</span><span class="s">&quot;Main Sense information key=0x%x length(%d, %d) &quot;</span>
			<span class="s">&quot;additional_code=0x%x async_error=%d errors=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">original_sense_len</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">,</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">additional_code</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">async_error</span><span class="p">,</span>
			<span class="n">or</span><span class="o">-&gt;</span><span class="n">req_errors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">original_sense_len</span> <span class="o">&lt;</span> <span class="n">sense_len</span><span class="p">)</span>
		<span class="n">sense_len</span> <span class="o">=</span> <span class="n">original_sense_len</span><span class="p">;</span>

	<span class="n">cur_descriptor</span> <span class="o">=</span> <span class="n">ssdb</span><span class="o">-&gt;</span><span class="n">ssd</span><span class="p">;</span>
	<span class="n">sense_len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ssdb</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sense_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_sense_descriptor</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">cur_descriptor</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cur_len</span> <span class="o">=</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">additional_length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">sense_len</span> <span class="o">-=</span> <span class="n">cur_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sense_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* sense was truncated */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">descriptor_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">scsi_sense_information</span>:
		<span class="k">case</span> <span class="n">scsi_sense_command_specific_information</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_sense_command_specific_data_descriptor</span>
				<span class="o">*</span><span class="n">sscd</span> <span class="o">=</span> <span class="n">cur_descriptor</span><span class="p">;</span>

			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">command_info</span> <span class="o">=</span>
				<span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscd</span><span class="o">-&gt;</span><span class="n">information</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span>
				<span class="s">&quot;command_specific_information 0x%llx </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">_LLU</span><span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">command_info</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">scsi_sense_key_specific</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">scsi_sense_key_specific_data_descriptor</span>
				<span class="o">*</span><span class="n">ssks</span> <span class="o">=</span> <span class="n">cur_descriptor</span><span class="p">;</span>

			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">sense_info</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssks</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span>
				<span class="s">&quot;sense_key_specific_information %u&quot;</span>
				<span class="s">&quot;sksv_cd_bpv_bp (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">osi</span><span class="o">-&gt;</span><span class="n">sense_info</span><span class="p">,</span> <span class="n">ssks</span><span class="o">-&gt;</span><span class="n">sksv_cd_bpv_bp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">osd_sense_object_identification</span>:
		<span class="p">{</span> <span class="cm">/*FIXME: Keep first not last, Store in array*/</span>
			<span class="k">struct</span> <span class="n">osd_sense_identification_data_descriptor</span>
				<span class="o">*</span><span class="n">osidd</span> <span class="o">=</span> <span class="n">cur_descriptor</span><span class="p">;</span>

			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">not_initiated_command_functions</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">osidd</span><span class="o">-&gt;</span><span class="n">not_initiated_functions</span><span class="p">);</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">completed_command_functions</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">osidd</span><span class="o">-&gt;</span><span class="n">completed_functions</span><span class="p">);</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">osidd</span><span class="o">-&gt;</span><span class="n">partition_id</span><span class="p">);</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">osidd</span><span class="o">-&gt;</span><span class="n">object_id</span><span class="p">);</span>
			<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span>
				<span class="s">&quot;object_identification pid=0x%llx oid=0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">_LLU</span><span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">.</span><span class="n">partition</span><span class="p">),</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
			<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span>
				<span class="s">&quot;not_initiated_bits(%x) &quot;</span>
				<span class="s">&quot;completed_command_bits(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">osi</span><span class="o">-&gt;</span><span class="n">not_initiated_command_functions</span><span class="p">,</span>
				<span class="n">osi</span><span class="o">-&gt;</span><span class="n">completed_command_functions</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">osd_sense_response_integrity_check</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">osd_sense_response_integrity_check_descriptor</span>
				<span class="o">*</span><span class="n">osricd</span> <span class="o">=</span> <span class="n">cur_descriptor</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="n">osricd</span><span class="o">-&gt;</span><span class="n">integrity_check_value</span><span class="p">);</span>
			<span class="kt">char</span> <span class="n">key_dump</span><span class="p">[</span><span class="n">len</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span> <span class="cm">/* 2nibbles+space+ASCII */</span>

			<span class="n">hex_dump_to_buffer</span><span class="p">(</span><span class="n">osricd</span><span class="o">-&gt;</span><span class="n">integrity_check_value</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				       <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key_dump</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key_dump</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span><span class="s">&quot;response_integrity [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_dump</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">osd_sense_attribute_identification</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">osd_sense_attributes_data_descriptor</span>
				<span class="o">*</span><span class="n">osadd</span> <span class="o">=</span> <span class="n">cur_descriptor</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cur_len</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">osd_sense_attr</span> <span class="o">*</span><span class="n">pattr</span> <span class="o">=</span> <span class="n">osadd</span><span class="o">-&gt;</span><span class="n">sense_attrs</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pattr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">attr_page</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">pattr</span><span class="o">-&gt;</span><span class="n">attr_page</span><span class="p">);</span>
				<span class="n">u32</span> <span class="n">attr_id</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">pattr</span><span class="o">-&gt;</span><span class="n">attr_id</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr_page</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">osi</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr_page</span> <span class="o">=</span> <span class="n">attr_page</span><span class="p">;</span>
					<span class="n">osi</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">attr_id</span> <span class="o">=</span> <span class="n">attr_id</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bad_attr_list</span> <span class="o">&amp;&amp;</span> <span class="n">max_attr</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bad_attr_list</span><span class="o">-&gt;</span><span class="n">attr_page</span> <span class="o">=</span> <span class="n">attr_page</span><span class="p">;</span>
					<span class="n">bad_attr_list</span><span class="o">-&gt;</span><span class="n">attr_id</span> <span class="o">=</span> <span class="n">attr_id</span><span class="p">;</span>
					<span class="n">bad_attr_list</span><span class="o">++</span><span class="p">;</span>
					<span class="n">max_attr</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pattr</span><span class="p">);</span>
				<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span>
					<span class="s">&quot;osd_sense_attribute_identification&quot;</span>
					<span class="s">&quot;attr_page=0x%x attr_id=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">attr_page</span><span class="p">,</span> <span class="n">attr_id</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*These are not legal for OSD*/</span>
		<span class="k">case</span> <span class="n">scsi_sense_field_replaceable_unit</span>:
			<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span><span class="s">&quot;scsi_sense_field_replaceable_unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">scsi_sense_stream_commands</span>:
			<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span><span class="s">&quot;scsi_sense_stream_commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">scsi_sense_block_commands</span>:
			<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span><span class="s">&quot;scsi_sense_block_commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">scsi_sense_ata_return</span>:
			<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span><span class="s">&quot;scsi_sense_ata_return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">descriptor_type</span> <span class="o">&lt;=</span> <span class="n">scsi_sense_Reserved_last</span><span class="p">)</span>
				<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span>
					<span class="s">&quot;scsi_sense Reserved descriptor (0x%x)&quot;</span><span class="p">,</span>
					<span class="n">ssd</span><span class="o">-&gt;</span><span class="n">descriptor_type</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">OSD_SENSE_PRINT2</span><span class="p">(</span>
					<span class="s">&quot;scsi_sense Vendor descriptor (0x%x)&quot;</span><span class="p">,</span>
					<span class="n">ssd</span><span class="o">-&gt;</span><span class="n">descriptor_type</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">cur_descriptor</span> <span class="o">+=</span> <span class="n">cur_len</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">analyze:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* scsi sense is Empty, the request was never issued to target</span>
<span class="cm">		 * linux return code might tell us what happened.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">async_error</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="n">OSD_ERR_PRI_RESOURCE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="n">OSD_ERR_PRI_UNREACHABLE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">async_error</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&lt;=</span> <span class="n">scsi_sk_recovered_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">additional_code</span> <span class="o">==</span> <span class="n">scsi_invalid_field_in_cdb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">cdb_field_offset</span> <span class="o">==</span> <span class="n">OSD_CFO_STARTING_BYTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="n">OSD_ERR_PRI_CLEAR_PAGES</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span> <span class="cm">/* caller should recover from this */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">cdb_field_offset</span> <span class="o">==</span> <span class="n">OSD_CFO_OBJECT_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="n">OSD_ERR_PRI_NOT_FOUND</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">cdb_field_offset</span> <span class="o">==</span> <span class="n">OSD_CFO_PERMISSIONS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="n">OSD_ERR_PRI_NO_ACCESS</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="n">OSD_ERR_PRI_BAD_CRED</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">additional_code</span> <span class="o">==</span> <span class="n">osd_quota_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="n">OSD_ERR_PRI_NO_SPACE</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_is_osd_security_code</span><span class="p">(</span><span class="n">osi</span><span class="o">-&gt;</span><span class="n">additional_code</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="n">OSD_ERR_PRI_BAD_CRED</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">osi</span><span class="o">-&gt;</span><span class="n">osd_err_pri</span> <span class="o">=</span> <span class="n">OSD_ERR_PRI_EIO</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">residual</span><span class="p">)</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">residual</span><span class="p">)</span>
		<span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_req_decode_sense_full</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Implementation of osd_sec.h API</span>
<span class="cm"> * TODO: Move to a separate osd_sec.c file at a later stage.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">OSD_SEC_CAP_V1_ALL_CAPS</span> <span class="o">=</span>
	<span class="n">OSD_SEC_CAP_APPEND</span> <span class="o">|</span> <span class="n">OSD_SEC_CAP_OBJ_MGMT</span> <span class="o">|</span> <span class="n">OSD_SEC_CAP_REMOVE</span>   <span class="o">|</span>
	<span class="n">OSD_SEC_CAP_CREATE</span> <span class="o">|</span> <span class="n">OSD_SEC_CAP_SET_ATTR</span> <span class="o">|</span> <span class="n">OSD_SEC_CAP_GET_ATTR</span> <span class="o">|</span>
	<span class="n">OSD_SEC_CAP_WRITE</span>  <span class="o">|</span> <span class="n">OSD_SEC_CAP_READ</span>     <span class="o">|</span> <span class="n">OSD_SEC_CAP_POL_SEC</span>  <span class="o">|</span>
	<span class="n">OSD_SEC_CAP_GLOBAL</span> <span class="o">|</span> <span class="n">OSD_SEC_CAP_DEV_MGMT</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">OSD_SEC_CAP_V2_ALL_CAPS</span> <span class="o">=</span>
	<span class="n">OSD_SEC_CAP_V1_ALL_CAPS</span> <span class="o">|</span> <span class="n">OSD_SEC_CAP_QUERY</span> <span class="o">|</span> <span class="n">OSD_SEC_CAP_M_OBJECT</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">osd_sec_init_nosec_doall_caps</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">caps</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">osd_obj_id</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_collection</span><span class="p">,</span> <span class="k">const</span> <span class="n">bool</span> <span class="n">is_v1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_capability</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="n">caps</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">descriptor_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_collection</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">OSD_SEC_OBJ_COLLECTION</span><span class="p">;</span>
			<span class="n">descriptor_type</span> <span class="o">=</span> <span class="n">is_v1</span> <span class="o">?</span> <span class="n">OSD_SEC_OBJ_DESC_OBJ</span> <span class="o">:</span>
						  <span class="n">OSD_SEC_OBJ_DESC_COL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">OSD_SEC_OBJ_USER</span><span class="p">;</span>
			<span class="n">descriptor_type</span> <span class="o">=</span> <span class="n">OSD_SEC_OBJ_DESC_OBJ</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">partition</span> <span class="o">?</span> <span class="n">OSD_SEC_OBJ_PARTITION</span> <span class="o">:</span>
					<span class="n">OSD_SEC_OBJ_ROOT</span><span class="p">;</span>
		<span class="n">descriptor_type</span> <span class="o">=</span> <span class="n">OSD_SEC_OBJ_DESC_PAR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cap</span><span class="p">));</span>

	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">OSD_SEC_CAP_FORMAT_VER1</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">integrity_algorithm__key_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* MAKE_BYTE(0, 0); */</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">security_method</span> <span class="o">=</span> <span class="n">OSD_SEC_NOSEC</span><span class="p">;</span>
<span class="cm">/*	cap-&gt;expiration_time;</span>
<span class="cm">	cap-&gt;AUDIT[30-10];</span>
<span class="cm">	cap-&gt;discriminator[42-30];</span>
<span class="cm">	cap-&gt;object_created_time; */</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">object_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">osd_sec_set_caps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">,</span> <span class="n">OSD_SEC_CAP_V1_ALL_CAPS</span><span class="p">);</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">object_descriptor_type</span> <span class="o">=</span> <span class="n">descriptor_type</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">.</span><span class="n">obj_desc</span><span class="p">.</span><span class="n">policy_access_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">.</span><span class="n">obj_desc</span><span class="p">.</span><span class="n">allowed_partition_id</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">partition</span><span class="p">);</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">od</span><span class="p">.</span><span class="n">obj_desc</span><span class="p">.</span><span class="n">allowed_object_id</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">osd_sec_init_nosec_doall_caps</span><span class="p">);</span>

<span class="cm">/* FIXME: Extract version from caps pointer.</span>
<span class="cm"> *        Also Pete&#39;s target only supports caps from OSDv1 for now</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">osd_set_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_cdb</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_ver1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/* NOTE: They start at same address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">caps</span><span class="p">,</span> <span class="n">caps</span><span class="p">,</span> <span class="n">is_ver1</span> <span class="o">?</span> <span class="n">OSDv1_CAP_LEN</span> <span class="o">:</span> <span class="n">OSD_CAP_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">osd_is_sec_alldata</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_security_parameters</span> <span class="o">*</span><span class="n">sec_parms</span> <span class="n">__unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">osd_sec_sign_cdb</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_cdb</span> <span class="o">*</span><span class="n">ocdb</span> <span class="n">__unused</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cap_key</span> <span class="n">__unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">osd_sec_sign_data</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data_integ</span> <span class="n">__unused</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="n">__unused</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cap_key</span> <span class="n">__unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Declared in osd_protocol.h</span>
<span class="cm"> * 4.12.5 Data-In and Data-Out buffer offsets</span>
<span class="cm"> * byte offset = mantissa * (2^(exponent+8))</span>
<span class="cm"> * Returns the smallest allowed encoded offset that contains given @offset</span>
<span class="cm"> * The actual encoded offset returned is @offset + *@padding.</span>
<span class="cm"> */</span>
<span class="n">osd_cdb_offset</span> <span class="nf">__osd_encode_offset</span><span class="p">(</span>
	<span class="n">u64</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">padding</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_shift</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">try_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">osd_cdb_offset</span> <span class="n">be32_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>

	<span class="o">*</span><span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">shift</span> <span class="o">=</span> <span class="n">min_shift</span><span class="p">;</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="n">max_shift</span><span class="p">;</span> <span class="o">++</span><span class="n">shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">try_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try_offset</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OSD_OFFSET_MAX_BITS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="n">max_shift</span><span class="p">);</span>

	<span class="n">align</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">mod</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">padding</span> <span class="o">=</span> <span class="n">align</span> <span class="o">-</span> <span class="n">mod</span><span class="p">;</span>
		<span class="n">try_offset</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">try_offset</span> <span class="o">|=</span> <span class="p">((</span><span class="n">shift</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="n">be32_offset</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">try_offset</span><span class="p">);</span>

	<span class="n">OSD_DEBUG</span><span class="p">(</span><span class="s">&quot;offset=%llu mantissa=%llu exp=%d encoded=%x pad=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">_LLU</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">_LLU</span><span class="p">(</span><span class="n">try_offset</span> <span class="o">&amp;</span> <span class="mh">0x0FFFFFFF</span><span class="p">),</span> <span class="n">shift</span><span class="p">,</span>
		 <span class="n">be32_offset</span><span class="p">,</span> <span class="o">*</span><span class="n">padding</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">be32_offset</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
