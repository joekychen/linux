<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla1280.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>qla1280.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm">*                  QLOGIC LINUX SOFTWARE</span>
<span class="cm">*</span>
<span class="cm">* QLogic  QLA1280 (Ultra2)  and  QLA12160 (Ultra3) SCSI driver</span>
<span class="cm">* Copyright (C) 2000 Qlogic Corporation (www.qlogic.com)</span>
<span class="cm">* Copyright (C) 2001-2004 Jes Sorensen, Wild Open Source Inc.</span>
<span class="cm">* Copyright (C) 2003-2004 Christoph Hellwig</span>
<span class="cm">*</span>
<span class="cm">* This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">* under the terms of the GNU General Public License as published by the</span>
<span class="cm">* Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm">* later version.</span>
<span class="cm">*</span>
<span class="cm">* This program is distributed in the hope that it will be useful, but</span>
<span class="cm">* WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm">* General Public License for more details.</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="cp">#define QLA1280_VERSION      &quot;3.27.1&quot;</span>
<span class="cm">/*****************************************************************************</span>
<span class="cm">    Revision History:</span>
<span class="cm">    Rev  3.27.1, February 8, 2010, Michael Reed</span>
<span class="cm">	- Retain firmware image for error recovery.</span>
<span class="cm">    Rev  3.27, February 10, 2009, Michael Reed</span>
<span class="cm">	- General code cleanup.</span>
<span class="cm">	- Improve error recovery.</span>
<span class="cm">    Rev  3.26, January 16, 2006 Jes Sorensen</span>
<span class="cm">	- Ditch all &lt; 2.6 support</span>
<span class="cm">    Rev  3.25.1, February 10, 2005 Christoph Hellwig</span>
<span class="cm">	- use pci_map_single to map non-S/G requests</span>
<span class="cm">	- remove qla1280_proc_info</span>
<span class="cm">    Rev  3.25, September 28, 2004, Christoph Hellwig</span>
<span class="cm">	- add support for ISP1020/1040</span>
<span class="cm">	- don&#39;t include &quot;scsi.h&quot; anymore for 2.6.x</span>
<span class="cm">    Rev  3.24.4 June 7, 2004 Christoph Hellwig</span>
<span class="cm">	- restructure firmware loading, cleanup initialization code</span>
<span class="cm">	- prepare support for ISP1020/1040 chips</span>
<span class="cm">    Rev  3.24.3 January 19, 2004, Jes Sorensen</span>
<span class="cm">	- Handle PCI DMA mask settings correctly</span>
<span class="cm">	- Correct order of error handling in probe_one, free_irq should not</span>
<span class="cm">	  be called if request_irq failed</span>
<span class="cm">    Rev  3.24.2 January 19, 2004, James Bottomley &amp; Andrew Vasquez</span>
<span class="cm">	- Big endian fixes (James)</span>
<span class="cm">	- Remove bogus IOCB content on zero data transfer commands (Andrew)</span>
<span class="cm">    Rev  3.24.1 January 5, 2004, Jes Sorensen</span>
<span class="cm">	- Initialize completion queue to avoid OOPS on probe</span>
<span class="cm">	- Handle interrupts during mailbox testing</span>
<span class="cm">    Rev  3.24 November 17, 2003, Christoph Hellwig</span>
<span class="cm">    	- use struct list_head for completion queue</span>
<span class="cm">	- avoid old Scsi_FOO typedefs</span>
<span class="cm">	- cleanup 2.4 compat glue a bit</span>
<span class="cm">	- use &lt;scsi/scsi_*.h&gt; headers on 2.6 instead of &quot;scsi.h&quot;</span>
<span class="cm">	- make initialization for memory mapped vs port I/O more similar</span>
<span class="cm">	- remove broken pci config space manipulation</span>
<span class="cm">	- kill more cruft</span>
<span class="cm">	- this is an almost perfect 2.6 scsi driver now! ;)</span>
<span class="cm">    Rev  3.23.39 December 17, 2003, Jes Sorensen</span>
<span class="cm">	- Delete completion queue from srb if mailbox command failed to</span>
<span class="cm">	  to avoid qla1280_done completeting qla1280_error_action&#39;s</span>
<span class="cm">	  obsolete context</span>
<span class="cm">	- Reduce arguments for qla1280_done</span>
<span class="cm">    Rev  3.23.38 October 18, 2003, Christoph Hellwig</span>
<span class="cm">	- Convert to new-style hotplugable driver for 2.6</span>
<span class="cm">	- Fix missing scsi_unregister/scsi_host_put on HBA removal</span>
<span class="cm">	- Kill some more cruft</span>
<span class="cm">    Rev  3.23.37 October 1, 2003, Jes Sorensen</span>
<span class="cm">	- Make MMIO depend on CONFIG_X86_VISWS instead of yet another</span>
<span class="cm">	  random CONFIG option</span>
<span class="cm">	- Clean up locking in probe path</span>
<span class="cm">    Rev  3.23.36 October 1, 2003, Christoph Hellwig</span>
<span class="cm">	- queuecommand only ever receives new commands - clear flags</span>
<span class="cm">	- Reintegrate lost fixes from Linux 2.5</span>
<span class="cm">    Rev  3.23.35 August 14, 2003, Jes Sorensen</span>
<span class="cm">	- Build against 2.6</span>
<span class="cm">    Rev  3.23.34 July 23, 2003, Jes Sorensen</span>
<span class="cm">	- Remove pointless TRUE/FALSE macros</span>
<span class="cm">	- Clean up vchan handling</span>
<span class="cm">    Rev  3.23.33 July 3, 2003, Jes Sorensen</span>
<span class="cm">	- Don&#39;t define register access macros before define determining MMIO.</span>
<span class="cm">	  This just happened to work out on ia64 but not elsewhere.</span>
<span class="cm">	- Don&#39;t try and read from the card while it is in reset as</span>
<span class="cm">	  it won&#39;t respond and causes an MCA</span>
<span class="cm">    Rev  3.23.32 June 23, 2003, Jes Sorensen</span>
<span class="cm">	- Basic support for boot time arguments</span>
<span class="cm">    Rev  3.23.31 June 8, 2003, Jes Sorensen</span>
<span class="cm">	- Reduce boot time messages</span>
<span class="cm">    Rev  3.23.30 June 6, 2003, Jes Sorensen</span>
<span class="cm">	- Do not enable sync/wide/ppr before it has been determined</span>
<span class="cm">	  that the target device actually supports it</span>
<span class="cm">	- Enable DMA arbitration for multi channel controllers</span>
<span class="cm">    Rev  3.23.29 June 3, 2003, Jes Sorensen</span>
<span class="cm">	- Port to 2.5.69</span>
<span class="cm">    Rev  3.23.28 June 3, 2003, Jes Sorensen</span>
<span class="cm">	- Eliminate duplicate marker commands on bus resets</span>
<span class="cm">	- Handle outstanding commands appropriately on bus/device resets</span>
<span class="cm">    Rev  3.23.27 May 28, 2003, Jes Sorensen</span>
<span class="cm">	- Remove bogus input queue code, let the Linux SCSI layer do the work</span>
<span class="cm">	- Clean up NVRAM handling, only read it once from the card</span>
<span class="cm">	- Add a number of missing default nvram parameters</span>
<span class="cm">    Rev  3.23.26 Beta May 28, 2003, Jes Sorensen</span>
<span class="cm">	- Use completion queue for mailbox commands instead of busy wait</span>
<span class="cm">    Rev  3.23.25 Beta May 27, 2003, James Bottomley</span>
<span class="cm">	- Migrate to use new error handling code</span>
<span class="cm">    Rev  3.23.24 Beta May 21, 2003, James Bottomley</span>
<span class="cm">	- Big endian support</span>
<span class="cm">	- Cleanup data direction code</span>
<span class="cm">    Rev  3.23.23 Beta May 12, 2003, Jes Sorensen</span>
<span class="cm">	- Switch to using MMIO instead of PIO</span>
<span class="cm">    Rev  3.23.22 Beta April 15, 2003, Jes Sorensen</span>
<span class="cm">	- Fix PCI parity problem with 12160 during reset.</span>
<span class="cm">    Rev  3.23.21 Beta April 14, 2003, Jes Sorensen</span>
<span class="cm">	- Use pci_map_page()/pci_unmap_page() instead of map_single version.</span>
<span class="cm">    Rev  3.23.20 Beta April 9, 2003, Jes Sorensen</span>
<span class="cm">	- Remove &lt; 2.4.x support</span>
<span class="cm">	- Introduce HOST_LOCK to make the spin lock changes portable.</span>
<span class="cm">	- Remove a bunch of idiotic and unnecessary typedef&#39;s</span>
<span class="cm">	- Kill all leftovers of target-mode support which never worked anyway</span>
<span class="cm">    Rev  3.23.19 Beta April 11, 2002, Linus Torvalds</span>
<span class="cm">	- Do qla1280_pci_config() before calling request_irq() and</span>
<span class="cm">	  request_region()</span>
<span class="cm">	- Use pci_dma_hi32() to handle upper word of DMA addresses instead</span>
<span class="cm">	  of large shifts</span>
<span class="cm">	- Hand correct arguments to free_irq() in case of failure</span>
<span class="cm">    Rev  3.23.18 Beta April 11, 2002, Jes Sorensen</span>
<span class="cm">	- Run source through Lindent and clean up the output</span>
<span class="cm">    Rev  3.23.17 Beta April 11, 2002, Jes Sorensen</span>
<span class="cm">	- Update SCSI firmware to qla1280 v8.15.00 and qla12160 v10.04.32</span>
<span class="cm">    Rev  3.23.16 Beta March 19, 2002, Jes Sorensen</span>
<span class="cm">	- Rely on mailbox commands generating interrupts - do not</span>
<span class="cm">	  run qla1280_isr() from ql1280_mailbox_command()</span>
<span class="cm">	- Remove device_reg_t</span>
<span class="cm">	- Integrate ql12160_set_target_parameters() with 1280 version</span>
<span class="cm">	- Make qla1280_setup() non static</span>
<span class="cm">	- Do not call qla1280_check_for_dead_scsi_bus() on every I/O request</span>
<span class="cm">	  sent to the card - this command pauses the firmware!!!</span>
<span class="cm">    Rev  3.23.15 Beta March 19, 2002, Jes Sorensen</span>
<span class="cm">	- Clean up qla1280.h - remove obsolete QL_DEBUG_LEVEL_x definitions</span>
<span class="cm">	- Remove a pile of pointless and confusing (srb_t **) and</span>
<span class="cm">	  (scsi_lu_t *) typecasts</span>
<span class="cm">	- Explicit mark that we do not use the new error handling (for now)</span>
<span class="cm">	- Remove scsi_qla_host_t and use &#39;struct&#39; instead</span>
<span class="cm">	- Remove in_abort, watchdog_enabled, dpc, dpc_sched, bios_enabled,</span>
<span class="cm">	  pci_64bit_slot flags which weren&#39;t used for anything anyway</span>
<span class="cm">	- Grab host-&gt;host_lock while calling qla1280_isr() from abort()</span>
<span class="cm">	- Use spin_lock()/spin_unlock() in qla1280_intr_handler() - we</span>
<span class="cm">	  do not need to save/restore flags in the interrupt handler</span>
<span class="cm">	- Enable interrupts early (before any mailbox access) in preparation</span>
<span class="cm">	  for cleaning up the mailbox handling</span>
<span class="cm">    Rev  3.23.14 Beta March 14, 2002, Jes Sorensen</span>
<span class="cm">	- Further cleanups. Remove all trace of QL_DEBUG_LEVEL_x and replace</span>
<span class="cm">	  it with proper use of dprintk().</span>
<span class="cm">	- Make qla1280_print_scsi_cmd() and qla1280_dump_buffer() both take</span>
<span class="cm">	  a debug level argument to determine if data is to be printed</span>
<span class="cm">	- Add KERN_* info to printk()</span>
<span class="cm">    Rev  3.23.13 Beta March 14, 2002, Jes Sorensen</span>
<span class="cm">	- Significant cosmetic cleanups</span>
<span class="cm">	- Change debug code to use dprintk() and remove #if mess</span>
<span class="cm">    Rev  3.23.12 Beta March 13, 2002, Jes Sorensen</span>
<span class="cm">	- More cosmetic cleanups, fix places treating return as function</span>
<span class="cm">	- use cpu_relax() in qla1280_debounce_register()</span>
<span class="cm">    Rev  3.23.11 Beta March 13, 2002, Jes Sorensen</span>
<span class="cm">	- Make it compile under 2.5.5</span>
<span class="cm">    Rev  3.23.10 Beta October 1, 2001, Jes Sorensen</span>
<span class="cm">	- Do no typecast short * to long * in QL1280BoardTbl, this</span>
<span class="cm">	  broke miserably on big endian boxes</span>
<span class="cm">    Rev  3.23.9 Beta September 30, 2001, Jes Sorensen</span>
<span class="cm">	- Remove pre 2.2 hack for checking for reentrance in interrupt handler</span>
<span class="cm">	- Make data types used to receive from SCSI_{BUS,TCN,LUN}_32</span>
<span class="cm">	  unsigned int to match the types from struct scsi_cmnd</span>
<span class="cm">    Rev  3.23.8 Beta September 29, 2001, Jes Sorensen</span>
<span class="cm">	- Remove bogus timer_t typedef from qla1280.h</span>
<span class="cm">	- Remove obsolete pre 2.2 PCI setup code, use proper #define&#39;s</span>
<span class="cm">	  for PCI_ values, call pci_set_master()</span>
<span class="cm">	- Fix memleak of qla1280_buffer on module unload</span>
<span class="cm">	- Only compile module parsing code #ifdef MODULE - should be</span>
<span class="cm">	  changed to use individual MODULE_PARM&#39;s later</span>
<span class="cm">	- Remove dummy_buffer that was never modified nor printed</span>
<span class="cm">	- ENTER()/LEAVE() are noops unless QL_DEBUG_LEVEL_3, hence remove</span>
<span class="cm">	  #ifdef QL_DEBUG_LEVEL_3/#endif around ENTER()/LEAVE() calls</span>
<span class="cm">	- Remove \r from print statements, this is Linux, not DOS</span>
<span class="cm">	- Remove obsolete QLA1280_{SCSILU,INTR,RING}_{LOCK,UNLOCK}</span>
<span class="cm">	  dummy macros</span>
<span class="cm">	- Remove C++ compile hack in header file as Linux driver are not</span>
<span class="cm">	  supposed to be compiled as C++</span>
<span class="cm">	- Kill MS_64BITS macro as it makes the code more readable</span>
<span class="cm">	- Remove unnecessary flags.in_interrupts bit</span>
<span class="cm">    Rev  3.23.7 Beta August 20, 2001, Jes Sorensen</span>
<span class="cm">	- Dont&#39; check for set flags on q-&gt;q_flag one by one in qla1280_next()</span>
<span class="cm">        - Check whether the interrupt was generated by the QLA1280 before</span>
<span class="cm">          doing any processing</span>
<span class="cm">	- qla1280_status_entry(): Only zero out part of sense_buffer that</span>
<span class="cm">	  is not being copied into</span>
<span class="cm">	- Remove more superflouous typecasts</span>
<span class="cm">	- qla1280_32bit_start_scsi() replace home-brew memcpy() with memcpy()</span>
<span class="cm">    Rev  3.23.6 Beta August 20, 2001, Tony Luck, Intel</span>
<span class="cm">        - Don&#39;t walk the entire list in qla1280_putq_t() just to directly</span>
<span class="cm">	  grab the pointer to the last element afterwards</span>
<span class="cm">    Rev  3.23.5 Beta August 9, 2001, Jes Sorensen</span>
<span class="cm">	- Don&#39;t use IRQF_DISABLED, it&#39;s use is deprecated for this kinda driver</span>
<span class="cm">    Rev  3.23.4 Beta August 8, 2001, Jes Sorensen</span>
<span class="cm">	- Set dev-&gt;max_sectors to 1024</span>
<span class="cm">    Rev  3.23.3 Beta August 6, 2001, Jes Sorensen</span>
<span class="cm">	- Provide compat macros for pci_enable_device(), pci_find_subsys()</span>
<span class="cm">	  and scsi_set_pci_device()</span>
<span class="cm">	- Call scsi_set_pci_device() for all devices</span>
<span class="cm">	- Reduce size of kernel version dependent device probe code</span>
<span class="cm">	- Move duplicate probe/init code to separate function</span>
<span class="cm">	- Handle error if qla1280_mem_alloc() fails</span>
<span class="cm">	- Kill OFFSET() macro and use Linux&#39;s PCI definitions instead</span>
<span class="cm">        - Kill private structure defining PCI config space (struct config_reg)</span>
<span class="cm">	- Only allocate I/O port region if not in MMIO mode</span>
<span class="cm">	- Remove duplicate (unused) sanity check of sife of srb_t</span>
<span class="cm">    Rev  3.23.2 Beta August 6, 2001, Jes Sorensen</span>
<span class="cm">	- Change home-brew memset() implementations to use memset()</span>
<span class="cm">        - Remove all references to COMTRACE() - accessing a PC&#39;s COM2 serial</span>
<span class="cm">          port directly is not legal under Linux.</span>
<span class="cm">    Rev  3.23.1 Beta April 24, 2001, Jes Sorensen</span>
<span class="cm">        - Remove pre 2.2 kernel support</span>
<span class="cm">        - clean up 64 bit DMA setting to use 2.4 API (provide backwards compat)</span>
<span class="cm">        - Fix MMIO access to use readl/writel instead of directly</span>
<span class="cm">          dereferencing pointers</span>
<span class="cm">        - Nuke MSDOS debugging code</span>
<span class="cm">        - Change true/false data types to int from uint8_t</span>
<span class="cm">        - Use int for counters instead of uint8_t etc.</span>
<span class="cm">        - Clean up size &amp; byte order conversion macro usage</span>
<span class="cm">    Rev  3.23 Beta January 11, 2001 BN Qlogic</span>
<span class="cm">        - Added check of device_id when handling non</span>
<span class="cm">          QLA12160s during detect().</span>
<span class="cm">    Rev  3.22 Beta January 5, 2001 BN Qlogic</span>
<span class="cm">        - Changed queue_task() to schedule_task()</span>
<span class="cm">          for kernels 2.4.0 and higher.</span>
<span class="cm">          Note: 2.4.0-testxx kernels released prior to</span>
<span class="cm">                the actual 2.4.0 kernel release on January 2001</span>
<span class="cm">                will get compile/link errors with schedule_task().</span>
<span class="cm">                Please update your kernel to released 2.4.0 level,</span>
<span class="cm">                or comment lines in this file flagged with  3.22</span>
<span class="cm">                to resolve compile/link error of schedule_task().</span>
<span class="cm">        - Added -DCONFIG_SMP in addition to -D__SMP__</span>
<span class="cm">          in Makefile for 2.4.0 builds of driver as module.</span>
<span class="cm">    Rev  3.21 Beta January 4, 2001 BN Qlogic</span>
<span class="cm">        - Changed criteria of 64/32 Bit mode of HBA</span>
<span class="cm">          operation according to BITS_PER_LONG rather</span>
<span class="cm">          than HBA&#39;s NVRAM setting of &gt;4Gig memory bit;</span>
<span class="cm">          so that the HBA auto-configures without the need</span>
<span class="cm">          to setup each system individually.</span>
<span class="cm">    Rev  3.20 Beta December 5, 2000 BN Qlogic</span>
<span class="cm">        - Added priority handling to IA-64  onboard SCSI</span>
<span class="cm">          ISP12160 chip for kernels greater than 2.3.18.</span>
<span class="cm">        - Added irqrestore for qla1280_intr_handler.</span>
<span class="cm">        - Enabled /proc/scsi/qla1280 interface.</span>
<span class="cm">        - Clear /proc/scsi/qla1280 counters in detect().</span>
<span class="cm">    Rev  3.19 Beta October 13, 2000 BN Qlogic</span>
<span class="cm">        - Declare driver_template for new kernel</span>
<span class="cm">          (2.4.0 and greater) scsi initialization scheme.</span>
<span class="cm">        - Update /proc/scsi entry for 2.3.18 kernels and</span>
<span class="cm">          above as qla1280</span>
<span class="cm">    Rev  3.18 Beta October 10, 2000 BN Qlogic</span>
<span class="cm">        - Changed scan order of adapters to map</span>
<span class="cm">          the QLA12160 followed by the QLA1280.</span>
<span class="cm">    Rev  3.17 Beta September 18, 2000 BN Qlogic</span>
<span class="cm">        - Removed warnings for 32 bit 2.4.x compiles</span>
<span class="cm">        - Corrected declared size for request and response</span>
<span class="cm">          DMA addresses that are kept in each ha</span>
<span class="cm">    Rev. 3.16 Beta  August 25, 2000   BN  Qlogic</span>
<span class="cm">        - Corrected 64 bit addressing issue on IA-64</span>
<span class="cm">          where the upper 32 bits were not properly</span>
<span class="cm">          passed to the RISC engine.</span>
<span class="cm">    Rev. 3.15 Beta  August 22, 2000   BN  Qlogic</span>
<span class="cm">        - Modified qla1280_setup_chip to properly load</span>
<span class="cm">          ISP firmware for greater that 4 Gig memory on IA-64</span>
<span class="cm">    Rev. 3.14 Beta  August 16, 2000   BN  Qlogic</span>
<span class="cm">        - Added setting of dma_mask to full 64 bit</span>
<span class="cm">          if flags.enable_64bit_addressing is set in NVRAM</span>
<span class="cm">    Rev. 3.13 Beta  August 16, 2000   BN  Qlogic</span>
<span class="cm">        - Use new PCI DMA mapping APIs for 2.4.x kernel</span>
<span class="cm">    Rev. 3.12       July 18, 2000    Redhat &amp; BN Qlogic</span>
<span class="cm">        - Added check of pci_enable_device to detect() for 2.3.x</span>
<span class="cm">        - Use pci_resource_start() instead of</span>
<span class="cm">          pdev-&gt;resource[0].start in detect() for 2.3.x</span>
<span class="cm">        - Updated driver version</span>
<span class="cm">    Rev. 3.11       July 14, 2000    BN  Qlogic</span>
<span class="cm">	- Updated SCSI Firmware to following versions:</span>
<span class="cm">	  qla1x80:   8.13.08</span>
<span class="cm">	  qla1x160:  10.04.08</span>
<span class="cm">	- Updated driver version to 3.11</span>
<span class="cm">    Rev. 3.10    June 23, 2000   BN Qlogic</span>
<span class="cm">        - Added filtering of AMI SubSys Vendor ID devices</span>
<span class="cm">    Rev. 3.9</span>
<span class="cm">        - DEBUG_QLA1280 undefined and  new version  BN Qlogic</span>
<span class="cm">    Rev. 3.08b      May 9, 2000    MD Dell</span>
<span class="cm">        - Added logic to check against AMI subsystem vendor ID</span>
<span class="cm">	Rev. 3.08       May 4, 2000    DG  Qlogic</span>
<span class="cm">        - Added logic to check for PCI subsystem ID.</span>
<span class="cm">	Rev. 3.07       Apr 24, 2000    DG &amp; BN  Qlogic</span>
<span class="cm">	   - Updated SCSI Firmware to following versions:</span>
<span class="cm">	     qla12160:   10.01.19</span>
<span class="cm">		 qla1280:     8.09.00</span>
<span class="cm">	Rev. 3.06       Apr 12, 2000    DG &amp; BN  Qlogic</span>
<span class="cm">	   - Internal revision; not released</span>
<span class="cm">    Rev. 3.05       Mar 28, 2000    DG &amp; BN  Qlogic</span>
<span class="cm">       - Edit correction for virt_to_bus and PROC.</span>
<span class="cm">    Rev. 3.04       Mar 28, 2000    DG &amp; BN  Qlogic</span>
<span class="cm">       - Merge changes from ia64 port.</span>
<span class="cm">    Rev. 3.03       Mar 28, 2000    BN  Qlogic</span>
<span class="cm">       - Increase version to reflect new code drop with compile fix</span>
<span class="cm">         of issue with inclusion of linux/spinlock for 2.3 kernels</span>
<span class="cm">    Rev. 3.02       Mar 15, 2000    BN  Qlogic</span>
<span class="cm">       - Merge qla1280_proc_info from 2.10 code base</span>
<span class="cm">    Rev. 3.01       Feb 10, 2000    BN  Qlogic</span>
<span class="cm">       - Corrected code to compile on a 2.2.x kernel.</span>
<span class="cm">    Rev. 3.00       Jan 17, 2000    DG  Qlogic</span>
<span class="cm">	   - Added 64-bit support.</span>
<span class="cm">    Rev. 2.07       Nov 9, 1999     DG  Qlogic</span>
<span class="cm">	   - Added new routine to set target parameters for ISP12160.</span>
<span class="cm">    Rev. 2.06       Sept 10, 1999     DG  Qlogic</span>
<span class="cm">       - Added support for ISP12160 Ultra 3 chip.</span>
<span class="cm">    Rev. 2.03       August 3, 1999    Fred Lewis, Intel DuPont</span>
<span class="cm">	- Modified code to remove errors generated when compiling with</span>
<span class="cm">	  Cygnus IA64 Compiler.</span>
<span class="cm">        - Changed conversion of pointers to unsigned longs instead of integers.</span>
<span class="cm">        - Changed type of I/O port variables from uint32_t to unsigned long.</span>
<span class="cm">        - Modified OFFSET macro to work with 64-bit as well as 32-bit.</span>
<span class="cm">        - Changed sprintf and printk format specifiers for pointers to %p.</span>
<span class="cm">        - Changed some int to long type casts where needed in sprintf &amp; printk.</span>
<span class="cm">        - Added l modifiers to sprintf and printk format specifiers for longs.</span>
<span class="cm">        - Removed unused local variables.</span>
<span class="cm">    Rev. 1.20       June 8, 1999      DG,  Qlogic</span>
<span class="cm">         Changes to support RedHat release 6.0 (kernel 2.2.5).</span>
<span class="cm">       - Added SCSI exclusive access lock (io_request_lock) when accessing</span>
<span class="cm">         the adapter.</span>
<span class="cm">       - Added changes for the new LINUX interface template. Some new error</span>
<span class="cm">         handling routines have been added to the template, but for now we</span>
<span class="cm">         will use the old ones.</span>
<span class="cm">    -   Initial Beta Release.</span>
<span class="cm">*****************************************************************************/</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>

<span class="cp">#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)</span>
<span class="cp">#include &lt;asm/sn/io.h&gt;</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Compile time Options:</span>
<span class="cm"> *            0 - Disable and 1 - Enable</span>
<span class="cm"> */</span>
<span class="cp">#define  DEBUG_QLA1280_INTR	0</span>
<span class="cp">#define  DEBUG_PRINT_NVRAM	0</span>
<span class="cp">#define  DEBUG_QLA1280		0</span>

<span class="cm">/*</span>
<span class="cm"> * The SGI VISWS is broken and doesn&#39;t support MMIO ;-(</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_X86_VISWS</span>
<span class="cp">#define	MEMORY_MAPPED_IO	0</span>
<span class="cp">#else</span>
<span class="cp">#define	MEMORY_MAPPED_IO	1</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;qla1280.h&quot;</span>

<span class="cp">#ifndef BITS_PER_LONG</span>
<span class="cp">#error &quot;BITS_PER_LONG not defined!&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#if (BITS_PER_LONG == 64) || defined CONFIG_HIGHMEM</span>
<span class="cp">#define QLA_64BIT_PTR	1</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef QLA_64BIT_PTR</span>
<span class="cp">#define pci_dma_hi32(a)			((a &gt;&gt; 16) &gt;&gt; 16)</span>
<span class="cp">#else</span>
<span class="cp">#define pci_dma_hi32(a)			0</span>
<span class="cp">#endif</span>
<span class="cp">#define pci_dma_lo32(a)			(a &amp; 0xffffffff)</span>

<span class="cp">#define NVRAM_DELAY()			udelay(500)	</span><span class="cm">/* 2 microseconds */</span><span class="cp"></span>

<span class="cp">#if defined(__ia64__) &amp;&amp; !defined(ia64_platform_is)</span>
<span class="cp">#define ia64_platform_is(foo)		(!strcmp(x, platform_name))</span>
<span class="cp">#endif</span>


<span class="cp">#define IS_ISP1040(ha) (ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP1020)</span>
<span class="cp">#define IS_ISP1x40(ha) (ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP1020 || \</span>
<span class="cp">			ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP1240)</span>
<span class="cp">#define IS_ISP1x160(ha)        (ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP10160 || \</span>
<span class="cp">				ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP12160)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  QLogic Driver Support Function Prototypes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_get_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="n">__init</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *  QLogic ISP1280 Hardware Support Function Prototypes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_init_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_nvram_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span>
				   <span class="kt">uint8_t</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_abort_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_abort_isp</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef QLA_64BIT_PTR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_64bit_start_scsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_32bit_start_scsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_nv_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint16_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_marker</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_isp_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_rst_aen</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_status_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">response</span> <span class="o">*</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_error_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">response</span> <span class="o">*</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">qla1280_get_nvram_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">qla1280_nvram_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">qla1280_debounce_register</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">request_t</span> <span class="o">*</span><span class="n">qla1280_req_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_check_for_dead_scsi_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla1280_get_target_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_set_target_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_driver_setup</span> <span class="n">driver_setup</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * convert scsi data direction to request_t control flags</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span>
<span class="nf">qla1280_data_direction</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmnd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">cmnd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_FROM_DEVICE</span>:
		<span class="k">return</span> <span class="n">BIT_5</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_TO_DEVICE</span>:
		<span class="k">return</span> <span class="n">BIT_6</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_BIDIRECTIONAL</span>:
		<span class="k">return</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_6</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We could BUG() on default here if one of the four cases aren&#39;t</span>
<span class="cm">	 * met, but then again if we receive something like that from the</span>
<span class="cm">	 * SCSI layer we have more serious problems. This shuts up GCC.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">DMA_NONE</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
		
<span class="cp">#if DEBUG_QLA1280</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__qla1280_print_scsi_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__qla1280_dump_buffer</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * insmod needs to find the variable and make it point to something</span>
<span class="cm"> */</span>
<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">qla1280</span><span class="p">;</span>

<span class="cm">/* insmod qla1280 options=verbose&quot; */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qla1280</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;qla1280=&quot;</span><span class="p">,</span> <span class="n">qla1280_setup</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * We use the scsi_pointer structure that&#39;s included with each scsi_command</span>
<span class="cm"> * to overlay our struct srb over it. qla1280_init() checks that a srb is not</span>
<span class="cm"> * bigger than a scsi_pointer.</span>
<span class="cm"> */</span>

<span class="cp">#define	CMD_SP(Cmnd)		&amp;Cmnd-&gt;SCp</span>
<span class="cp">#define	CMD_CDBLEN(Cmnd)	Cmnd-&gt;cmd_len</span>
<span class="cp">#define	CMD_CDBP(Cmnd)		Cmnd-&gt;cmnd</span>
<span class="cp">#define	CMD_SNSP(Cmnd)		Cmnd-&gt;sense_buffer</span>
<span class="cp">#define	CMD_SNSLEN(Cmnd)	SCSI_SENSE_BUFFERSIZE</span>
<span class="cp">#define	CMD_RESULT(Cmnd)	Cmnd-&gt;result</span>
<span class="cp">#define	CMD_HANDLE(Cmnd)	Cmnd-&gt;host_scribble</span>
<span class="cp">#define CMD_REQUEST(Cmnd)	Cmnd-&gt;request-&gt;cmd</span>

<span class="cp">#define CMD_HOST(Cmnd)		Cmnd-&gt;device-&gt;host</span>
<span class="cp">#define SCSI_BUS_32(Cmnd)	Cmnd-&gt;device-&gt;channel</span>
<span class="cp">#define SCSI_TCN_32(Cmnd)	Cmnd-&gt;device-&gt;id</span>
<span class="cp">#define SCSI_LUN_32(Cmnd)	Cmnd-&gt;device-&gt;lun</span>


<span class="cm">/*****************************************/</span>
<span class="cm">/*   ISP Boards supported by this driver */</span>
<span class="cm">/*****************************************/</span>

<span class="k">struct</span> <span class="n">qla_boards</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>		<span class="cm">/* Board ID String */</span>
	<span class="kt">int</span> <span class="n">numPorts</span><span class="p">;</span>		<span class="cm">/* Number of SCSI ports */</span>
	<span class="kt">int</span> <span class="n">fw_index</span><span class="p">;</span>		<span class="cm">/* index into qla1280_fw_tbl for firmware */</span>
<span class="p">};</span>

<span class="cm">/* NOTE: the last argument in each entry is used to index ql1280_board_tbl */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">qla1280_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP12160</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP1020</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP1080</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP1240</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP1280</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP10160</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">qla1280_pci_tbl</span><span class="p">);</span>

<span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">qla1280_firmware_mutex</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">qla_fw</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fwname</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define QL_NUM_FW_IMAGES 3</span>

<span class="k">struct</span> <span class="n">qla_fw</span> <span class="n">qla1280_fw_tbl</span><span class="p">[</span><span class="n">QL_NUM_FW_IMAGES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;qlogic/1040.bin&quot;</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">},</span>	<span class="cm">/* image 0 */</span>
	<span class="p">{</span><span class="s">&quot;qlogic/1280.bin&quot;</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">},</span>	<span class="cm">/* image 1 */</span>
	<span class="p">{</span><span class="s">&quot;qlogic/12160.bin&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>	<span class="cm">/* image 2 */</span>
<span class="p">};</span>

<span class="cm">/* NOTE: Order of boards in this table must match order in qla1280_pci_tbl */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qla_boards</span> <span class="n">ql1280_board_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;QLA12160&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">fw_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;QLA1040&quot;</span> <span class="p">,</span> <span class="p">.</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">fw_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;QLA1080&quot;</span> <span class="p">,</span> <span class="p">.</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">fw_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;QLA1240&quot;</span> <span class="p">,</span> <span class="p">.</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">fw_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;QLA1280&quot;</span> <span class="p">,</span> <span class="p">.</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">fw_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;QLA10160&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">fw_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;        &quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">fw_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qla1280_verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if DEBUG_QLA1280</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ql_debug_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#define dprintk(level, format, a...)	\</span>
<span class="cp">	do { if (ql_debug_level &gt;= level) printk(KERN_ERR format, ##a); } while(0)</span>
<span class="cp">#define qla1280_dump_buffer(level, buf, size)	\</span>
<span class="cp">	if (ql_debug_level &gt;= level) __qla1280_dump_buffer(buf, size)</span>
<span class="cp">#define qla1280_print_scsi_cmd(level, cmd)	\</span>
<span class="cp">	if (ql_debug_level &gt;= level) __qla1280_print_scsi_cmd(cmd)</span>
<span class="cp">#else</span>
<span class="cp">#define ql_debug_level			0</span>
<span class="cp">#define dprintk(level, format, a...)	do{}while(0)</span>
<span class="cp">#define qla1280_dump_buffer(a, b, c)	do{}while(0)</span>
<span class="cp">#define qla1280_print_scsi_cmd(a, b)	do{}while(0)</span>
<span class="cp">#endif</span>

<span class="cp">#define ENTER(x)		dprintk(3, &quot;qla1280 : Entering %s()\n&quot;, x);</span>
<span class="cp">#define LEAVE(x)		dprintk(3, &quot;qla1280 : Leaving %s()\n&quot;, x);</span>
<span class="cp">#define ENTER_INTR(x)		dprintk(4, &quot;qla1280 : Entering %s()\n&quot;, x);</span>
<span class="cp">#define LEAVE_INTR(x)		dprintk(4, &quot;qla1280 : Leaving %s()\n&quot;, x);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla1280_read_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram</span> <span class="o">*</span><span class="n">nv</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_read_nvram&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">no_nvram</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi(%ld): Reading NVRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>
	<span class="n">nv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>
	<span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">wptr</span> <span class="o">=</span> <span class="n">qla1280_get_nvram_word</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">wptr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">wptr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">wptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">id0</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id1</span> <span class="o">!=</span> <span class="sc">&#39;S&#39;</span> <span class="o">||</span>
	    <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id2</span> <span class="o">!=</span> <span class="sc">&#39;P&#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id3</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Invalid nvram ID or version!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chksum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvram</span><span class="p">);</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">wptr</span> <span class="o">=</span> <span class="n">qla1280_get_nvram_word</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="n">chksum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">wptr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">chksum</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">wptr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">wptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qla1280_read_nvram: NVRAM Magic ID= %c %c %c %02x&quot;</span>
	       <span class="s">&quot; version %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id0</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id1</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id2</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">id3</span><span class="p">,</span>
	       <span class="n">nv</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">no_nvram</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi(%ld): Unable to identify or &quot;</span>
			       <span class="s">&quot;validate NVRAM checksum, using default &quot;</span>
			       <span class="s">&quot;settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* The firmware interface is, um, interesting, in that the</span>
<span class="cm">	 * actual firmware image on the chip is little endian, thus,</span>
<span class="cm">	 * the process of taking that image to the CPU would end up</span>
<span class="cm">	 * little endian.  However, the firmware interface requires it</span>
<span class="cm">	 * to be read a word (two bytes) at a time.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The net result of this would be that the word (and</span>
<span class="cm">	 * doubleword) quantites in the firmware would be correct, but</span>
<span class="cm">	 * the bytes would be pairwise reversed.  Since most of the</span>
<span class="cm">	 * firmware quantites are, in fact, bytes, we do an extra</span>
<span class="cm">	 * le16_to_cpu() in the firmware read routine.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The upshot of all this is that the bytes in the firmware</span>
<span class="cm">	 * are in the correct places, but the 16 and 32 bit quantites</span>
<span class="cm">	 * are still in little endian format.  We fix that up below by</span>
<span class="cm">	 * doing extra reverses on them */</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_parameter</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_parameter</span><span class="p">);</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_feature</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_feature</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BUSES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">selection_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">selection_timeout</span><span class="p">);</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_queue_depth</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_queue_depth</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280_read_nvram: Completed Reading NVRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_read_nvram&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">chksum</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *   qla1280_info</span>
<span class="cm"> *     Return a string describing the driver.</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">qla1280_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">qla1280_scsi_name_buffer</span><span class="p">[</span><span class="mi">125</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_boards</span> <span class="o">*</span><span class="n">bdp</span><span class="p">;</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla1280_scsi_name_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">bdp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ql1280_board_tbl</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qla1280_scsi_name_buffer</span><span class="p">));</span>

	<span class="n">sprintf</span> <span class="p">(</span><span class="n">bp</span><span class="p">,</span>
		 <span class="s">&quot;QLogic %s PCI to SCSI Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;       Firmware version: %2d.%02d.%02d, Driver version %s&quot;</span><span class="p">,</span>
		 <span class="o">&amp;</span><span class="n">bdp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwver1</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwver2</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwver3</span><span class="p">,</span>
		 <span class="n">QLA1280_VERSION</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *   qla1280_queuecommand</span>
<span class="cm"> *     Queue a command to the controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> * The mid-level driver tries to ensures that queuecommand never gets invoked</span>
<span class="cm"> * concurrently with itself or the interrupt handler (although the</span>
<span class="cm"> * interrupt handler may call this routine as part of request-completion</span>
<span class="cm"> * handling).   Unfortunely, it sometimes calls the scheduler in interrupt</span>
<span class="cm"> * context which is a big NO! NO!.</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">)</span><span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>

	<span class="n">qla1280_print_scsi_cmd</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

<span class="cp">#ifdef QLA_64BIT_PTR</span>
	<span class="cm">/*</span>
<span class="cm">	 * Using 64 bit commands if the PCI bridge doesn&#39;t support it is a</span>
<span class="cm">	 * bit wasteful, however this should really only happen if one&#39;s</span>
<span class="cm">	 * PCI controller is completely broken, like the BCM1250. For</span>
<span class="cm">	 * sane hardware this is not an issue.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_64bit_start_scsi</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_32bit_start_scsi</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">qla1280_queuecommand</span><span class="p">)</span>

<span class="k">enum</span> <span class="n">action</span> <span class="p">{</span>
	<span class="n">ABORT_COMMAND</span><span class="p">,</span>
	<span class="n">DEVICE_RESET</span><span class="p">,</span>
	<span class="n">BUS_RESET</span><span class="p">,</span>
	<span class="n">ADAPTER_RESET</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla1280_mailbox_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span><span class="n">__data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi(%ld): mailbox timed out, mailbox0 %04x, &quot;</span>
	       <span class="s">&quot;ictrl %04x, istatus %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">),</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">));</span>
	<span class="n">complete</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_qla1280_wait_for_single_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">status</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">COMPLETED_HANDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">)(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_wait_for_single_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">_qla1280_wait_for_single_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_wait_for_pending_commands</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span>	<span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for all commands with the designated bus/target</span>
<span class="cm">	 * to be completed by the firmware</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bus</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">target</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_wait_for_single_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * qla1280_error_action</span>
<span class="cm"> *    The function will attempt to perform a specified error action and</span>
<span class="cm"> *    wait for the results (or time out).</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      cmd = Linux SCSI command packet of the command that cause the</span>
<span class="cm"> *            bus reset.</span>
<span class="cm"> *      action = error action to take (see action_t)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      SUCCESS or FAILED</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_error_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">action</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="o">=</span><span class="n">FAILED</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_for_bus</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_for_target</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_error_action&quot;</span><span class="p">);</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)(</span><span class="n">CMD_HOST</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">)</span><span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;error_action %i, istatus 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;host_cmd 0x%04x, ictrl 0x%04x, jiffies %li</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">),</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">),</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_verbose</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi(%li): Resetting Cmnd=0x%p, &quot;</span>
		       <span class="s">&quot;Handle=0x%p, action=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">action</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if we have the command in the outstanding_cmds[]</span>
<span class="cm">	 * array.  If not then it must have completed before this error</span>
<span class="cm">	 * action was initiated.  If the error_action isn&#39;t ABORT_COMMAND</span>
<span class="cm">	 * then the driver must proceed with the requested action.</span>
<span class="cm">	 */</span>
	<span class="n">found</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">;</span> <span class="cm">/* we&#39;ll wait for it to complete */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* driver doesn&#39;t have command */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_verbose</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;scsi(%ld:%d:%d:%d): specified command has &quot;</span>
			       <span class="s">&quot;already completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span>
				<span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">ABORT_COMMAND</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280: RISC aborting command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * The abort might fail due to race when the host_lock</span>
<span class="cm">		 * is released to issue the abort.  As such, we</span>
<span class="cm">		 * don&#39;t bother to check the return status.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">qla1280_abort_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DEVICE_RESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_verbose</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;scsi(%ld:%d:%d:%d): Queueing device reset &quot;</span>
			       <span class="s">&quot;command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_device_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* issued device reset, set wait conditions */</span>
			<span class="n">wait_for_bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
			<span class="n">wait_for_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BUS_RESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_verbose</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280(%ld:%d): Issued bus &quot;</span>
			       <span class="s">&quot;reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_bus_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* issued bus reset, set wait conditions */</span>
			<span class="n">wait_for_bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ADAPTER_RESET</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_verbose</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;scsi(%ld): Issued ADAPTER RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi(%ld): I/O processing will &quot;</span>
			       <span class="s">&quot;continue automatically</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_abort_isp</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* it&#39;s dead */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point, the host_lock has been released and retaken</span>
<span class="cm">	 * by the issuance of the mailbox command.</span>
<span class="cm">	 * Wait for the command passed in by the mid-layer if it</span>
<span class="cm">	 * was found by the driver.  It might have been returned</span>
<span class="cm">	 * between eh recovery steps, hence the check of the &quot;found&quot;</span>
<span class="cm">	 * variable.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">_qla1280_wait_for_single_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">ABORT_COMMAND</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;scsi(%li:%i:%i:%i): &quot;</span>
		       <span class="s">&quot;Unable to abort command!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the command passed in by the mid-layer has been</span>
<span class="cm">	 * returned by the board, then wait for any additional</span>
<span class="cm">	 * commands which are supposed to complete based upon</span>
<span class="cm">	 * the error action.</span>
<span class="cm">	 *</span>
<span class="cm">	 * All commands are unconditionally returned during a</span>
<span class="cm">	 * call to qla1280_abort_isp(), ADAPTER_RESET.  No need</span>
<span class="cm">	 * to wait for them.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">wait_for_bus</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">qla1280_wait_for_pending_commands</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					<span class="n">wait_for_bus</span><span class="p">,</span> <span class="n">wait_for_target</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;RESET returning %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_error_action&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *   qla1280_abort</span>
<span class="cm"> *     Abort the specified SCSI command(s).</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qla1280_error_action</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ABORT_COMMAND</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *   qla1280_device_reset</span>
<span class="cm"> *     Reset the specified SCSI device</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_eh_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qla1280_error_action</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">DEVICE_RESET</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *   qla1280_bus_reset</span>
<span class="cm"> *     Reset the specified bus.</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_eh_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qla1280_error_action</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">BUS_RESET</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *   qla1280_adapter_reset</span>
<span class="cm"> *     Reset the specified adapter (both channels)</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_eh_adapter_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">qla1280_error_action</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ADAPTER_RESET</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
		  <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">geom</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">heads</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">capacity</span> <span class="o">/</span> <span class="p">(</span><span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cylinders</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">capacity</span> <span class="o">/</span> <span class="p">(</span><span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>
		<span class="cm">/* if (cylinders &gt; 1023)</span>
<span class="cm">		   cylinders = 1023; */</span>
	<span class="p">}</span>

	<span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

 
<span class="cm">/* disable risc and host interrupts */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla1280_disable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">);</span>	<span class="cm">/* PCI Posted Write flush */</span>
<span class="p">}</span>

<span class="cm">/* enable risc and host interrupts */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla1280_enable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">,</span> <span class="p">(</span><span class="n">ISP_EN_INT</span> <span class="o">|</span> <span class="n">ISP_EN_RISC</span><span class="p">));</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">);</span>	<span class="cm">/* PCI Posted Write flush */</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * qla1280_intr_handler</span>
<span class="cm"> *   Handles the H/W interrupt</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">qla1280_intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENTER_INTR</span> <span class="p">(</span><span class="s">&quot;qla1280_intr_handler&quot;</span><span class="p">);</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>

	<span class="n">qla1280_disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">qla1280_debounce_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">);</span>
	<span class="cm">/* Check for pending interrupts. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">RISC_INT</span><span class="p">)</span> <span class="p">{</span>	
		<span class="n">qla1280_isr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">done_q</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">done_q</span><span class="p">))</span>
		<span class="n">qla1280_done</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">qla1280_enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">LEAVE_INTR</span><span class="p">(</span><span class="s">&quot;qla1280_intr_handler&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_set_target_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">mr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nvram</span> <span class="o">*</span><span class="n">nv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>

	<span class="n">nv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>

	<span class="n">mr</span> <span class="o">=</span> <span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">;</span>

	<span class="cm">/* Set Target Parameters. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_TARGET_PARAMETERS</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)((</span><span class="n">bus</span> <span class="o">?</span> <span class="n">target</span> <span class="o">|</span> <span class="n">BIT_7</span> <span class="o">:</span> <span class="n">target</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">renegotiate_on_error</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">stop_queue_on_check</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">auto_request_sense</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">tag_queuing</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">enable_sync</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">enable_wide</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">parity_checking</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">disconnect_allowed</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1x160</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">ppr_1x160</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_ppr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>	<span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x160</span><span class="p">.</span><span class="n">sync_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>	<span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">ppr_1x160</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">ppr_1x160</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">ppr_bus_width</span><span class="p">;</span>
		<span class="n">mr</span> <span class="o">|=</span> <span class="n">BIT_6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>	<span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x80</span><span class="p">.</span><span class="n">sync_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">sync_period</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="cm">/* Set Device Queue Parameters. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">MAX_LUNS</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_DEVICE_QUEUE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)((</span><span class="n">bus</span> <span class="o">?</span> <span class="n">target</span> <span class="o">|</span> <span class="n">BIT_7</span> <span class="o">:</span> <span class="n">target</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">lun</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">max_queue_depth</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">execution_throttle</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi(%ld:%i:%i): &quot;</span>
		       <span class="s">&quot;qla1280_set_target_parameters() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> *   qla1280_slave_configure</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *   Determines the queue depth for a given device.  There are two ways</span>
<span class="cm"> *   a queue depth can be obtained for a tagged queueing device.  One</span>
<span class="cm"> *   way is the default queue depth which is determined by whether</span>
<span class="cm"> *   If it is defined, then it is used</span>
<span class="cm"> *   as the default queue depth.  Otherwise, we use either 4 or 8 as the</span>
<span class="cm"> *   default queue depth (dependent on the number of hardware SCBs).</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">default_depth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram</span> <span class="o">*</span><span class="n">nv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">nv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_check_for_dead_scsi_bus</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">qtag_enables</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_0</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">hiwat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">default_depth</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">enable_sync</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">sdtr</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">enable_wide</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">wdtr</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">ppr_1x160</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_ppr</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">ppr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">no_sync</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">sync_mask</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="o">~</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">sync_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="p">))))</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">enable_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">no_wide</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">wide_mask</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="o">~</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">wide_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="p">))))</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">enable_wide</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1x160</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">no_ppr</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">ppr_mask</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="o">~</span><span class="n">driver_setup</span><span class="p">.</span><span class="n">ppr_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="p">))))</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">ppr_1x160</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_ppr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">enable_sync</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_set_target_parameters</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">qla1280_get_target_parameters</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * qla1280_done</span>
<span class="cm"> *      Process completed commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha           = adapter block pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">done_q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_done&quot;</span><span class="p">);</span>

	<span class="n">done_q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">done_q</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">done_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">done_q</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">CMD_RESULT</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DID_RESET</span>:
			<span class="cm">/* Issue marker command. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">abort_isp_active</span><span class="p">)</span>
				<span class="n">qla1280_marker</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DID_ABORT</span>:
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_ABORT_PENDING</span><span class="p">;</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_ABORTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Release memory used for this I/O */</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

		<span class="cm">/* Call the mid-level driver interrupt handler */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">actthreads</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">)(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">complete</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_done&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Translates a ISP error to a Linux SCSI error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_return_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">response</span> <span class="o">*</span> <span class="n">sts</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">comp_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">state_flags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">state_flags</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">residual_length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">residual_length</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">scsi_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">);</span>
<span class="cp">#if DEBUG_QLA1280_INTR</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;DID_OK&quot;</span><span class="p">,</span>
		<span class="s">&quot;DID_NO_CONNECT&quot;</span><span class="p">,</span>
		<span class="s">&quot;DID_BUS_BUSY&quot;</span><span class="p">,</span>
		<span class="s">&quot;DID_TIME_OUT&quot;</span><span class="p">,</span>
		<span class="s">&quot;DID_BAD_TARGET&quot;</span><span class="p">,</span>
		<span class="s">&quot;DID_ABORT&quot;</span><span class="p">,</span>
		<span class="s">&quot;DID_PARITY&quot;</span><span class="p">,</span>
		<span class="s">&quot;DID_ERROR&quot;</span><span class="p">,</span>
		<span class="s">&quot;DID_RESET&quot;</span><span class="p">,</span>
		<span class="s">&quot;DID_BAD_INTR&quot;</span>
	<span class="p">};</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG_QLA1280_INTR */</span><span class="cp"></span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_return_status&quot;</span><span class="p">);</span>

<span class="cp">#if DEBUG_QLA1280_INTR</span>
	<span class="cm">/*</span>
<span class="cm">	  dprintk(1, &quot;qla1280_return_status: compl status = 0x%04x\n&quot;,</span>
<span class="cm">	  comp_status);</span>
<span class="cm">	*/</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">comp_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS_COMPLETE</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_INCOMPLETE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_GOT_BUS</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_GOT_TARGET</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_SENT_CDB</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_TRANSFERRED_DATA</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_GOT_STATUS</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state_flags</span> <span class="o">&amp;</span> <span class="n">SF_GOT_SENSE</span><span class="p">))</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_RESET</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_ABORTED</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ABORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_TIMEOUT</span>:
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_DATA_OVERRUN</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Data overrun 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">residual_length</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_return_status: response packet data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sts</span><span class="p">,</span> <span class="n">RESPONSE_ENTRY_SIZE</span><span class="p">);</span>
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CS_DATA_UNDERRUN</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">-</span> <span class="n">residual_length</span><span class="p">)</span> <span class="o">&lt;</span>
		    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;scsi: Underflow detected - retrying &quot;</span>
			       <span class="s">&quot;command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">residual_length</span><span class="p">);</span>
			<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if DEBUG_QLA1280_INTR</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 ISP status: host status (%s) scsi status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">reason</span><span class="p">[</span><span class="n">host_status</span><span class="p">],</span> <span class="n">scsi_status</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_return_status&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                QLogic ISP1280 Hardware Support Functions.                */</span>
<span class="cm">/****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_initialize_adapter</span>
<span class="cm"> *      Initialize board.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">qla1280_initialize_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_initialize_adapter&quot;</span><span class="p">);</span>

	<span class="cm">/* Clear adapter flags. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_host_adapter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">abort_isp_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_platform_is</span><span class="p">(</span><span class="s">&quot;sn2&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi(%li): Enabling SN2 PCI DMA &quot;</span>
		       <span class="s">&quot;dual channel lockup workaround</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">use_pci_vchannel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">driver_setup</span><span class="p">.</span><span class="n">no_nvram</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* TODO: implement support for the 1040 nvram format */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1040</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">driver_setup</span><span class="p">.</span><span class="n">no_nvram</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Configure PCI space for adapter...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>

	<span class="cm">/* Insure mailbox registers are free. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">HC_CLR_RISC_INT</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">HC_CLR_HOST_INT</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_read_nvram</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_initialize_adapter: failed to read &quot;</span>
			<span class="s">&quot;NVRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s necessary to grab the spin here as qla1280_mailbox_command</span>
<span class="cm">	 * needs to be able to drop the lock unconditionally to wait</span>
<span class="cm">	 * for completion.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_load_firmware</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi(%li): initialize: pci probe failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup adapter based on NVRAM parameters. */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;scsi(%ld): Configure NVRAM parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">qla1280_nvram_config</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_host_adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_init_rings</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Issue SCSI reset, if we can&#39;t reset twice then bus is dead */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">disable_scsi_reset</span> <span class="o">&amp;&amp;</span>
		    <span class="n">qla1280_bus_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">qla1280_bus_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">))</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">scsi_bus_dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_initialize_adapter: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_initialize_adapter&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_request_firmware</span>
<span class="cm"> *      Acquire firmware for chip.  Retain in memory</span>
<span class="cm"> *      for error recovery.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      Pointer to firmware image or an error code</span>
<span class="cm"> *      cast to pointer via ERR_PTR().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span>
<span class="nf">qla1280_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fwname</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla1280_firmware_mutex</span><span class="p">);</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">ql1280_board_tbl</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">].</span><span class="n">fw_index</span><span class="p">;</span>
	<span class="n">fw</span> <span class="o">=</span> <span class="n">qla1280_fw_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">fwname</span> <span class="o">=</span> <span class="n">qla1280_fw_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fwname</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fwname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to load image </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fwname</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">fw</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid firmware length %zu in image </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">fwname</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
		<span class="n">fw</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla1280_fw_tbl</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fw</span> <span class="o">=</span> <span class="n">fw</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwver1</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwver2</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwver3</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
 <span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla1280_firmware_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fw</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Chip diagnostics</span>
<span class="cm"> *      Test chip for proper operation.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_chip_diag</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qla1280_chip_diag: testing device at 0x%p </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;scsi(%ld): Verifying chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="cm">/* Soft reset chip and wait for it to finish. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">,</span> <span class="n">ISP_RESET</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can&#39;t do a traditional PCI write flush here by reading</span>
<span class="cm">	 * back the register. The card will not respond once the reset</span>
<span class="cm">	 * is in action and we end up with a machine check exception</span>
<span class="cm">	 * instead. Nothing to do but wait and hope for the best.</span>
<span class="cm">	 * A portable pci_write_flush(pdev) call would be very useful here.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">qla1280_debounce_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Yet another QLogic gem ;-(</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="n">ISP_RESET</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* Reset register cleared by chip reset. */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qla1280_chip_diag: reset register cleared by chip reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cfg_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Reset RISC and disable BIOS which</span>
<span class="cm">	   allows RISC to execute out of RAM. */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">HC_RESET_RISC</span> <span class="o">|</span>
		     <span class="n">HC_RELEASE_RISC</span> <span class="o">|</span> <span class="n">HC_DISABLE_BIOS</span><span class="p">);</span>

	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">qla1280_debounce_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * I *LOVE* this code!</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">==</span> <span class="n">MBS_BUSY</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* Check product ID of chip */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qla1280_chip_diag: Checking product ID of chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PROD_ID_1</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PROD_ID_2</span> <span class="o">&amp;&amp;</span>
	     <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PROD_ID_2a</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox3</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PROD_ID_3</span> <span class="o">||</span>
	    <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PROD_ID_4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280: Wrong product ID = &quot;</span>
		       <span class="s">&quot;0x%x,0x%x,0x%x,0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox1</span><span class="p">),</span>
		       <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox2</span><span class="p">),</span>
		       <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox3</span><span class="p">),</span>
		       <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable ints early!!!</span>
<span class="cm">	 */</span>
	<span class="n">qla1280_enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280_chip_diag: Checking mailboxes of chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Wrap Incoming Mailboxes Test. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_MAILBOX_REGISTER_TEST</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAAAA</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5555</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAA55</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55AA</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA5A5</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5A5A</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2525</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xAAAA</span> <span class="o">||</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x5555</span> <span class="o">||</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xAA55</span> <span class="o">||</span>
	    <span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x55AA</span> <span class="o">||</span> <span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xA5A5</span> <span class="o">||</span> <span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x5A5A</span> <span class="o">||</span>
	    <span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x2525</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280: Failed mbox check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qla1280_chip_diag: exiting normally</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_chip_diag: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_load_firmware_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enter with host_lock acquired */</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">risc_address</span><span class="p">,</span> <span class="n">risc_code_size</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">],</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fw</span> <span class="o">=</span> <span class="n">qla1280_request_firmware</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwstart</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="cm">/* Load RISC code. */</span>
	<span class="n">risc_address</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwstart</span><span class="p">;</span>
	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">risc_code_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">risc_code_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_WRITE_RAM_WORD</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">risc_address</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_0</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_2</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi(%li): Failed to load firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DUMP_IT_BACK 0		</span><span class="cm">/* for debug of RISC loading */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_load_firmware_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enter with host_lock acquired */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">risc_address</span><span class="p">,</span> <span class="n">risc_code_size</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">],</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#if DUMP_IT_BACK</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">tbuf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">p_tbuf</span><span class="p">;</span>

	<span class="n">tbuf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_tbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">fw</span> <span class="o">=</span> <span class="n">qla1280_request_firmware</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwstart</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="cm">/* Load RISC code. */</span>
	<span class="n">risc_address</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwstart</span><span class="p">;</span>
	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">risc_code_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: DMA RISC code (%i) words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">risc_code_size</span><span class="p">);</span>

	<span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">risc_code_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">warn</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">2000</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">risc_code_size</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">risc_code_size</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_setup_chip:  loading risc @ =(0x%p),&quot;</span>
			<span class="s">&quot;%d,%d(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fw_data</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">risc_address</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_LOAD_RAM</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">risc_address</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: op=%d  0x%p = 0x%4x,0x%4x,0x%4x,0x%4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">,</span>
				<span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_4</span> <span class="o">|</span> <span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span>
				<span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi(%li): Failed to load partial &quot;</span>
			       <span class="s">&quot;segment of f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#if DUMP_IT_BACK</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_DUMP_RAM</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">risc_address</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_tbuf</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_tbuf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">p_tbuf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">p_tbuf</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_4</span> <span class="o">|</span> <span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span>
				<span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;Failed to dump partial segment of f/w</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">warn</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: FW compare error @ &quot;</span>
						<span class="s">&quot;byte(0x%x) loop#=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: FWbyte=%x  &quot;</span>
						<span class="s">&quot;FWfromChip=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="cm">/*break; */</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">risc_address</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">risc_code_size</span> <span class="o">=</span> <span class="n">risc_code_size</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">fw_data</span> <span class="o">=</span> <span class="n">fw_data</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">num</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
<span class="cp">#if DUMP_IT_BACK</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">,</span> <span class="n">p_tbuf</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Verifying checksum of loaded RISC code.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Verify checksum of loaded RISC code. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_VERIFY_CHECKSUM</span><span class="p">;</span>
	<span class="cm">/* mb[1] = ql12_risc_code_addr01; */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwstart</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi(%li): RISC checksum failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start firmware execution. */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: start firmware running.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_EXECUTE_FIRMWARE</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fwstart</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi(%li): Failed to start firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enter with host_lock taken */</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qla1280_chip_diag</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1040</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qla1280_load_firmware_pio</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qla1280_load_firmware_dma</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">qla1280_start_firmware</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize rings</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha                = adapter block pointer.</span>
<span class="cm"> *      ha-&gt;request_ring  = request ring virtual address</span>
<span class="cm"> *      ha-&gt;response_ring = response ring virtual address</span>
<span class="cm"> *      ha-&gt;request_dma   = request ring physical address</span>
<span class="cm"> *      ha-&gt;response_dma  = response ring physical address</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_init_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_init_rings&quot;</span><span class="p">);</span>

	<span class="cm">/* Clear outstanding commands array. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">);</span>

	<span class="cm">/* Initialize request queue. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT</span><span class="p">;</span>
	<span class="cm">/* mb[0] = MBC_INIT_REQUEST_QUEUE; */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_INIT_REQUEST_QUEUE_A64</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_ENTRY_CNT</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_4</span> <span class="o">|</span>
					       <span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
		<span class="cm">/* Initialize response queue. */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* mb[0] = MBC_INIT_RESPONSE_QUEUE; */</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_INIT_RESPONSE_QUEUE_A64</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RESPONSE_ENTRY_CNT</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span>
						 <span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_init_rings: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_init_rings&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_print_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvram</span> <span class="o">*</span><span class="n">nv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : initiator scsi id bus[0]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">config_1</span><span class="p">.</span><span class="n">initiator_id</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : initiator scsi id bus[1]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">config_1</span><span class="p">.</span><span class="n">initiator_id</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : bus reset delay[0]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bus_reset_delay</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : bus reset delay[1]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bus_reset_delay</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : retry count[0]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">retry_count</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : retry delay[0]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">retry_delay</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : retry count[1]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">retry_count</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : retry delay[1]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">retry_delay</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : async data setup time[0]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">async_data_setup_time</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : async data setup time[1]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">async_data_setup_time</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : req/ack active negation[0]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">req_ack_active_negation</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : req/ack active negation[1]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">req_ack_active_negation</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : data line active negation[0]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">data_line_active_negation</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : data line active negation[1]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">data_line_active_negation</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : disable loading risc code=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">cntr_flags_1</span><span class="p">.</span><span class="n">disable_loading_risc_code</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : enable 64bit addressing=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">cntr_flags_1</span><span class="p">.</span><span class="n">enable_64bit_addressing</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : selection timeout limit[0]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">selection_timeout</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : selection timeout limit[1]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">selection_timeout</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : max queue depth[0]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">max_queue_depth</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;qla1280 : max queue depth[1]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">max_queue_depth</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_set_target_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvram</span> <span class="o">*</span><span class="n">nv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>

	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">renegotiate_on_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">auto_request_sense</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">tag_queuing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">enable_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#if 1	</span><span class="cm">/* Some SCSI Processors do not seem to like this */</span><span class="cp"></span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">enable_wide</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">execution_throttle</span> <span class="o">=</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">max_queue_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">parity_checking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">disconnect_allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1x160</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x160</span><span class="p">.</span><span class="n">device_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x160</span><span class="p">.</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">sync_period</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">ppr_1x160</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">enable_ppr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">ppr_1x160</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">ppr_options</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">ppr_1x160</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">ppr_bus_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x80</span><span class="p">.</span><span class="n">device_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x80</span><span class="p">.</span><span class="n">sync_offset</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">sync_period</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvram</span> <span class="o">*</span><span class="n">nv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Using defaults for NVRAM: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvram</span><span class="p">));</span>

	<span class="cm">/* nv-&gt;cntr_flags_1.disable_loading_risc_code = 1; */</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_feature</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">enable_fast_posting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_feature</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">disable_synchronous_backoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">termination</span><span class="p">.</span><span class="n">scsi_bus_0_control</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">termination</span><span class="p">.</span><span class="n">scsi_bus_1_control</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">termination</span><span class="p">.</span><span class="n">auto_term_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set default FIFO magic - What appropriate values would be here</span>
<span class="cm">	 * is unknown. This is what I have found testing with 12160s.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Now, I would love the magic decoder ring for this one, the</span>
<span class="cm">	 * header file provided by QLogic seems to be bogus or incomplete</span>
<span class="cm">	 * at best.</span>
<span class="cm">	 */</span>
	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_config</span><span class="p">.</span><span class="n">burst_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1040</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_config</span><span class="p">.</span><span class="n">fifo_threshold</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_config</span><span class="p">.</span><span class="n">fifo_threshold</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1x160</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_parameter</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* fast memory enable */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="n">MAX_BUSES</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">config_1</span><span class="p">.</span><span class="n">initiator_id</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">req_ack_active_negation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">data_line_active_negation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">selection_timeout</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">max_queue_depth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1040</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">bus_reset_delay</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">async_data_setup_time</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">bus_reset_delay</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">async_data_setup_time</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">MAX_TARGETS</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qla1280_set_target_defaults</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_config_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvram</span> <span class="o">*</span><span class="n">nv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">flag</span><span class="p">;</span>

	<span class="cm">/* Set Target Parameters. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_TARGET_PARAMETERS</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)((</span><span class="n">bus</span> <span class="o">?</span> <span class="n">target</span> <span class="o">|</span> <span class="n">BIT_7</span> <span class="o">:</span> <span class="n">target</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do not enable sync and ppr for the initial INQUIRY run. We</span>
<span class="cm">	 * enable this later if we determine the target actually</span>
<span class="cm">	 * supports it.</span>
<span class="cm">	 */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TP_RENEGOTIATE</span> <span class="o">|</span> <span class="n">TP_AUTO_REQUEST_SENSE</span> <span class="o">|</span> <span class="n">TP_TAGGED_QUEUE</span>
		 <span class="o">|</span> <span class="n">TP_WIDE</span> <span class="o">|</span> <span class="n">TP_PARITY</span> <span class="o">|</span> <span class="n">TP_DISCONNECT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1x160</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x160</span><span class="p">.</span><span class="n">sync_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>	<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x80</span><span class="p">.</span><span class="n">sync_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">sync_period</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="cm">/* Save Tag queuing enable flag. */</span>
	<span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">BIT_0</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span><span class="n">tag_queuing</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">qtag_enables</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>

	<span class="cm">/* Save Device enable flag. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1x160</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x160</span><span class="p">.</span><span class="n">device_enable</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">device_enables</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">lun_disables</span> <span class="o">|=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x80</span><span class="p">.</span><span class="n">device_enable</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">device_enables</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>
		<span class="cm">/* Save LUN disable flag. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">flags</span><span class="p">.</span><span class="n">flags1x80</span><span class="p">.</span><span class="n">lun_disable</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">lun_disables</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set Device Queue Parameters. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">MAX_LUNS</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_DEVICE_QUEUE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)((</span><span class="n">bus</span> <span class="o">?</span> <span class="n">target</span> <span class="o">|</span> <span class="n">BIT_7</span> <span class="o">:</span> <span class="n">target</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">lun</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">max_queue_depth</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">execution_throttle</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_config_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvram</span> <span class="o">*</span><span class="n">nv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* SCSI Reset Disable. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">disable_scsi_reset</span> <span class="o">=</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">config_1</span><span class="p">.</span><span class="n">scsi_reset_disable</span><span class="p">;</span>

	<span class="cm">/* Initiator ID. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">config_1</span><span class="p">.</span><span class="n">initiator_id</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_INITIATOR_ID</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus</span> <span class="o">?</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">id</span> <span class="o">|</span> <span class="n">BIT_7</span> <span class="o">:</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Reset Delay. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">bus_reset_delay</span> <span class="o">=</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">bus_reset_delay</span><span class="p">;</span>

	<span class="cm">/* Command queue depth per device. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">hiwat</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">max_queue_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set target parameters. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">MAX_TARGETS</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_config_target</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_nvram_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram</span> <span class="o">*</span><span class="n">nv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_nvram_config&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nvram_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Always force AUTO sense for LINUX SCSI */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="n">MAX_BUSES</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">MAX_TARGETS</span><span class="p">;</span> <span class="n">target</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">parameter</span><span class="p">.</span>
					<span class="n">auto_request_sense</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qla1280_set_defaults</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qla1280_print_settings</span><span class="p">(</span><span class="n">nv</span><span class="p">);</span>

	<span class="cm">/* Disable RISC load of firmware. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">disable_risc_code_load</span> <span class="o">=</span>
		<span class="n">nv</span><span class="o">-&gt;</span><span class="n">cntr_flags_1</span><span class="p">.</span><span class="n">disable_loading_risc_code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1040</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint16_t</span> <span class="n">hwrev</span><span class="p">,</span> <span class="n">cfg1</span><span class="p">,</span> <span class="n">cdma_conf</span><span class="p">,</span> <span class="n">ddma_conf</span><span class="p">;</span>

		<span class="n">hwrev</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cfg_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ISP_CFG0_HWMSK</span><span class="p">;</span>

		<span class="n">cfg1</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cfg_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT_4</span> <span class="o">|</span> <span class="n">BIT_5</span> <span class="o">|</span> <span class="n">BIT_6</span><span class="p">);</span>
		<span class="n">cdma_conf</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cdma_cfg</span><span class="p">);</span>
		<span class="n">ddma_conf</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ddma_cfg</span><span class="p">);</span>

		<span class="cm">/* Busted fifo, says mjacob. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwrev</span> <span class="o">!=</span> <span class="n">ISP_CFG0_1040A</span><span class="p">)</span>
			<span class="n">cfg1</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_config</span><span class="p">.</span><span class="n">fifo_threshold</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">cfg1</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_config</span><span class="p">.</span><span class="n">burst_enable</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cfg_1</span><span class="p">,</span> <span class="n">cfg1</span><span class="p">);</span>

		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cdma_cfg</span><span class="p">,</span> <span class="n">cdma_conf</span> <span class="o">|</span> <span class="n">CDMA_CONF_BENAB</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ddma_cfg</span><span class="p">,</span> <span class="n">cdma_conf</span> <span class="o">|</span> <span class="n">DDMA_CONF_BENAB</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">uint16_t</span> <span class="n">cfg1</span><span class="p">,</span> <span class="n">term</span><span class="p">;</span>

		<span class="cm">/* Set ISP hardware DMA burst */</span>
		<span class="n">cfg1</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_config</span><span class="p">.</span><span class="n">fifo_threshold</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">cfg1</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_config</span><span class="p">.</span><span class="n">burst_enable</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* Enable DMA arbitration on dual channel controllers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">cfg1</span> <span class="o">|=</span> <span class="n">BIT_13</span><span class="p">;</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cfg_1</span><span class="p">,</span> <span class="n">cfg1</span><span class="p">);</span>

		<span class="cm">/* Set SCSI termination. */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpio_enable</span><span class="p">,</span>
			     <span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">);</span>
		<span class="n">term</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">termination</span><span class="p">.</span><span class="n">scsi_bus_1_control</span><span class="p">;</span>
		<span class="n">term</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">termination</span><span class="p">.</span><span class="n">scsi_bus_0_control</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">term</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">termination</span><span class="p">.</span><span class="n">auto_term_support</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">gpio_data</span><span class="p">,</span> <span class="n">term</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>

	<span class="cm">/* ISP parameter word. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_SYSTEM_PARAMETER</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">isp_parameter</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISP1x40</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* clock rate - for qla1240 and older, only */</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_CLOCK_RATE</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	 	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Firmware feature word. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_FIRMWARE_FEATURES</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_feature</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">enable_fast_posting</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_feature</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">report_lvd_bus_transition</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_feature</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">disable_synchronous_backoff</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_IA64_GENERIC) || defined (CONFIG_IA64_SGI_SN2)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_platform_is</span><span class="p">(</span><span class="s">&quot;sn2&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi(%li): Enabling SN2 PCI DMA &quot;</span>
		       <span class="s">&quot;workaround</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">firmware_feature</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">unused_9</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* XXX */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="cm">/* Retry count and delay. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_RETRY_COUNT</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">retry_count</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">retry_delay</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">retry_count</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">retry_delay</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_7</span> <span class="o">|</span> <span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span>
					  <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* ASYNC data setup time. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_ASYNC_DATA_SETUP</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">async_data_setup_time</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">async_data_setup_time</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Active negation states. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_ACTIVE_NEGATION</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">req_ack_active_negation</span><span class="p">)</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">data_line_active_negation</span><span class="p">)</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_4</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">req_ack_active_negation</span><span class="p">)</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">config_2</span><span class="p">.</span><span class="n">data_line_active_negation</span><span class="p">)</span>
		<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_4</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_DATA_OVERRUN_RECOVERY</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Reset SCSI bus and return all outstanding IO */</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="cm">/* thingy */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_PCI_CONTROL</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_1</span><span class="p">;</span>	<span class="cm">/* Data DMA Channel Burst Enable */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_1</span><span class="p">;</span>	<span class="cm">/* Command DMA Channel Burst Enable */</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_TAG_AGE_LIMIT</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="cm">/* Selection timeout. */</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_SET_SELECTION_TIMEOUT</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">selection_timeout</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">selection_timeout</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">qla1280_config_bus</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_nvram_config: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_nvram_config&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get NVRAM data word</span>
<span class="cm"> *      Calculates word position in NVRAM and calls request routine to</span>
<span class="cm"> *      get the word from NVRAM.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha      = adapter block pointer.</span>
<span class="cm"> *      address = NVRAM word address.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      data word.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint16_t</span>
<span class="nf">qla1280_get_nvram_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">nv_cmd</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">nv_cmd</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">nv_cmd</span> <span class="o">|=</span> <span class="n">NV_READ_OP</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">qla1280_nvram_request</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">nv_cmd</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;qla1280_get_nvram_word: exiting normally NVRAM data = &quot;</span>
		<span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NVRAM request</span>
<span class="cm"> *      Sends read command to NVRAM and gets data from NVRAM.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha     = adapter block pointer.</span>
<span class="cm"> *      nv_cmd = Bit 26     = start bit</span>
<span class="cm"> *               Bit 25, 24 = opcode</span>
<span class="cm"> *               Bit 23-16  = address</span>
<span class="cm"> *               Bit 15-0   = write data</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      data word.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint16_t</span>
<span class="nf">qla1280_nvram_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">nv_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">reg_data</span><span class="p">;</span>

	<span class="cm">/* Send command to NVRAM. */</span>

	<span class="n">nv_cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_cmd</span> <span class="o">&amp;</span> <span class="n">BIT_31</span><span class="p">)</span>
			<span class="n">qla1280_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">NV_DATA_OUT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qla1280_nv_write</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nv_cmd</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read data from NVRAM. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="p">(</span><span class="n">NV_SELECT</span> <span class="o">|</span> <span class="n">NV_CLOCK</span><span class="p">));</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>
		<span class="n">NVRAM_DELAY</span><span class="p">();</span>
		<span class="n">data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">reg_data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_data</span> <span class="o">&amp;</span> <span class="n">NV_DATA_IN</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">BIT_0</span><span class="p">;</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NV_SELECT</span><span class="p">);</span>
		<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>
		<span class="n">NVRAM_DELAY</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Deselect chip. */</span>

	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">NV_DESELECT</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>
	<span class="n">NVRAM_DELAY</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_nv_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>

	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">NV_SELECT</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>
	<span class="n">NVRAM_DELAY</span><span class="p">();</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">NV_SELECT</span> <span class="o">|</span> <span class="n">NV_CLOCK</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>
	<span class="n">NVRAM_DELAY</span><span class="p">();</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">NV_SELECT</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>
	<span class="n">NVRAM_DELAY</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mailbox Command</span>
<span class="cm"> *      Issue mailbox command and waits for completion.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *      mr = mailbox registers to load.</span>
<span class="cm"> *      mb = data pointer for mailbox registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Output:</span>
<span class="cm"> *      mb[MAILBOX_REGISTER_COUNT] = returned mailbox data.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_mailbox_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">mr</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">optr</span><span class="p">,</span> <span class="o">*</span><span class="n">iptr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mptr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_mailbox_command&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Warning mailbox wait already in use!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_wait</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We really should start out by verifying that the mailbox is</span>
<span class="cm">	 * available before starting sending the command data</span>
<span class="cm">	 */</span>
	<span class="cm">/* Load mailbox registers. */</span>
	<span class="n">mptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">;</span>
	<span class="n">iptr</span> <span class="o">=</span> <span class="n">mb</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mr</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="n">mptr</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">iptr</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">mr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">iptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Issue set host interrupt command. */</span>

	<span class="cm">/* set up a timer just in case we&#39;re really jammed */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">20</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">qla1280_mailbox_timeout</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">HC_SET_HOST_INT</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">qla1280_debounce_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">);</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Check for mailbox command timeout. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBS_CMD_CMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;qla1280_mailbox_command: Command failed, &quot;</span>
		       <span class="s">&quot;mailbox0 = 0x%04x, mailbox_out0 = 0x%04x, istatus = &quot;</span>
		       <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;m0 %04x, m1 %04x, m2 %04x, m3 %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">),</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox1</span><span class="p">),</span>
		       <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox2</span><span class="p">),</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox3</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;m4 %04x, m5 %04x, m6 %04x, m7 %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">),</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox5</span><span class="p">),</span>
		       <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox6</span><span class="p">),</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox7</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Load return mailbox registers. */</span>
	<span class="n">optr</span> <span class="o">=</span> <span class="n">mb</span><span class="p">;</span>
	<span class="n">iptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mr</span> <span class="o">=</span> <span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">optr</span><span class="p">,</span> <span class="n">iptr</span><span class="p">,</span> <span class="n">MAILBOX_REGISTER_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_marker</span><span class="p">)</span>
		<span class="n">qla1280_rst_aen</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_mailbox_command: **** FAILED, mailbox0 = &quot;</span>
			<span class="s">&quot;0x%x ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_mailbox_command&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_poll</span>
<span class="cm"> *      Polls ISP for interrupts.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">done_q</span><span class="p">);</span>

	<span class="cm">/* ENTER(&quot;qla1280_poll&quot;); */</span>

	<span class="cm">/* Check for pending interrupts. */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">RISC_INT</span><span class="p">)</span>
		<span class="n">qla1280_isr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_marker</span><span class="p">)</span>
			<span class="n">qla1280_rst_aen</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done_q</span><span class="p">))</span>
		<span class="n">qla1280_done</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* LEAVE(&quot;qla1280_poll&quot;); */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_bus_reset</span>
<span class="cm"> *      Issue SCSI bus reset.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha  = adapter block pointer.</span>
<span class="cm"> *      bus = SCSI bus number.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">uint16_t</span> <span class="n">reset_delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qla1280_bus_reset: entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_verbose</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi(%li:%i): Resetting SCSI BUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">bus</span><span class="p">);</span>

	<span class="n">reset_delay</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">bus_reset_delay</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_BUS_RESET</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reset_delay</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">failed_reset_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">scsi_bus_dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">failed_reset_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="n">reset_delay</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">scsi_bus_dead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">failed_reset_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">reset_marker</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Issue marker command. */</span>
		<span class="n">qla1280_marker</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ALL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should probably call qla1280_set_target_parameters()</span>
<span class="cm">	 * here as well for all devices on the bus.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_bus_reset: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qla1280_bus_reset: exiting normally</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_device_reset</span>
<span class="cm"> *      Issue bus device reset message to the target.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha      = adapter block pointer.</span>
<span class="cm"> *      bus     = SCSI BUS number.</span>
<span class="cm"> *      target  = SCSI ID.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_device_reset&quot;</span><span class="p">);</span>

	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_ABORT_TARGET</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span> <span class="o">?</span> <span class="p">(</span><span class="n">target</span> <span class="o">|</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="o">:</span> <span class="n">target</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Issue marker command. */</span>
	<span class="n">qla1280_marker</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MK_SYNC_ID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_device_reset: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_device_reset&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_abort_command</span>
<span class="cm"> *      Abort command aborts a specified IOCB.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *      sp = SB structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_abort_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span> <span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_abort_command&quot;</span><span class="p">);</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_ABORT_PENDING</span><span class="p">;</span>

	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_ABORT_COMMAND</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span> <span class="o">?</span> <span class="n">target</span> <span class="o">|</span> <span class="n">BIT_7</span> <span class="o">:</span> <span class="n">target</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_abort_command: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_ABORT_PENDING</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_abort_command&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_reset_adapter</span>
<span class="cm"> *      Reset adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_reset_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_reset_adapter&quot;</span><span class="p">);</span>

	<span class="cm">/* Disable ISP chip */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ictrl</span><span class="p">,</span> <span class="n">ISP_RESET</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span>
		     <span class="n">HC_RESET_RISC</span> <span class="o">|</span> <span class="n">HC_RELEASE_RISC</span> <span class="o">|</span> <span class="n">HC_DISABLE_BIOS</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>	<span class="cm">/* Flush PCI write */</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_reset_adapter&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Issue marker command.</span>
<span class="cm"> *      Function issues marker IOCB.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha   = adapter block pointer.</span>
<span class="cm"> *      bus  = SCSI BUS number</span>
<span class="cm"> *      id   = SCSI ID</span>
<span class="cm"> *      lun  = SCSI LUN</span>
<span class="cm"> *      type = marker modifier</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_marker</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrk_entry</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_marker&quot;</span><span class="p">);</span>

	<span class="cm">/* Get request packet. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mrk_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">qla1280_req_pkt</span><span class="p">(</span><span class="n">ha</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">MARKER_TYPE</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">lun</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="p">(</span><span class="n">bus</span> <span class="o">?</span> <span class="p">(</span><span class="n">id</span> <span class="o">|</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="o">:</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">modifier</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Issue command to ISP */</span>
		<span class="n">qla1280_isp_cmd</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_marker&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * qla1280_64bit_start_scsi</span>
<span class="cm"> *      The start SCSI is responsible for building request packets on</span>
<span class="cm"> *      request ring and modifying ISP input pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *      sp = SB structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success, was able to issue command.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef QLA_64BIT_PTR</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_64bit_start_scsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span> <span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmd_a64_entry_t</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">dword_ptr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seg_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dir</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_64bit_start_scsi:&quot;</span><span class="p">);</span>

	<span class="cm">/* Calculate number of entries and segments required. */</span>
	<span class="n">req_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">seg_cnt</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req_cnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">seg_cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">seg_cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">req_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seg_cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Calculate number of free request entries. */</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">=</span>
				<span class="n">REQUEST_ENTRY_CNT</span> <span class="o">-</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Number of free entries=(%d) seg_cnt=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">,</span> <span class="n">seg_cnt</span><span class="p">);</span>

	<span class="cm">/* If room for request in request ring. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_start_scsi: in-ptr=0x%x  req_q_cnt=&quot;</span>
			<span class="s">&quot;0x%xreq_cnt=0x%x&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">,</span>
			<span class="n">req_cnt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for room in outstanding command list. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span> <span class="o">&amp;&amp;</span>
		     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_start_scsi: NO ROOM IN &quot;</span>
			<span class="s">&quot;OUTSTANDING ARRAY, req_q_cnt=0x%x&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;start: cmd=%p sp=%p CDB=%xm, handle %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;             bus %i, target %i, lun %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Build command packet.</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_a64_entry_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="p">;</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">COMMAND_A64_TYPE</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sys_define</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cnt</span><span class="p">);</span>

	<span class="cm">/* Zero out remaining portion of packet. */</span>
	<span class="n">memset</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* Set ISP command timeout. */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>

	<span class="cm">/* Set device target ID and LUN */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="o">:</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Enable simple tag queuing if device supports it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">simple_tags</span><span class="p">)</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">BIT_3</span><span class="p">);</span>

	<span class="cm">/* Load SCSI command packet. */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_CDBLEN</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">scsi_cdb</span><span class="p">,</span> <span class="n">CMD_CDBP</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">CMD_CDBLEN</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="cm">/* dprintk(1, &quot;Build packet for command[0]=0x%x\n&quot;,pkt-&gt;scsi_cdb[0]); */</span>

	<span class="cm">/* Set transfer direction. */</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="n">qla1280_data_direction</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

	<span class="cm">/* Set total data segment count. */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seg_cnt</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Load data segments.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg_cnt</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* If data transfer. */</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">remseg</span> <span class="o">=</span> <span class="n">seg_cnt</span><span class="p">;</span>

		<span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

		<span class="cm">/* Setup packet address segment pointer. */</span>
		<span class="n">dword_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>

		<span class="cm">/* Load command entry data segments. */</span>
		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">seg_cnt</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">dma_handle</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">use_pci_vchannel</span><span class="p">)</span>
				<span class="n">sn_pci_set_vchan</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">,</span>
						 <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
<span class="cp">#endif</span>
			<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">));</span>
			<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">));</span>
			<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;S/G Segment phys_addr=%x %x, len=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">)),</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">)),</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg_next</span><span class="p">(</span><span class="n">s</span><span class="p">))));</span>
			<span class="n">remseg</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_64bit_start_scsi: Scatter/gather &quot;</span>
			<span class="s">&quot;command packet data - b %i, t %i, l %i </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
			<span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">,</span>
				    <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Build continuation packets.</span>
<span class="cm">		 */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;S/G Building Continuation...seg_cnt=0x%x &quot;</span>
			<span class="s">&quot;remains</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seg_cnt</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">remseg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Update sg start */</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="cm">/* Adjust ring index. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">==</span> <span class="n">REQUEST_ENTRY_CNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span> <span class="o">=</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="o">++</span><span class="p">;</span>

			<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_a64_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="p">;</span>

			<span class="cm">/* Zero out packet. */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>

			<span class="cm">/* Load packet defaults. */</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">cont_a64_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span>
				<span class="n">CONTINUE_A64_TYPE</span><span class="p">;</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">cont_a64_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">cont_a64_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sys_define</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">;</span>
			<span class="cm">/* Setup packet address segment pointer. */</span>
			<span class="n">dword_ptr</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">cont_a64_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>

			<span class="cm">/* Load continuation entry data segments. */</span>
			<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">remseg</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">dma_handle</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">use_pci_vchannel</span><span class="p">)</span>
					<span class="n">sn_pci_set_vchan</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">,</span>
							 <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
<span class="cp">#endif</span>
				<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">));</span>
				<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">));</span>
				<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;S/G Segment Cont. phys_addr=%x %x, len=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_hi32</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">)),</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">)),</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="n">remseg</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_64bit_start_scsi: &quot;</span>
				<span class="s">&quot;continuation packet data - b %i, t &quot;</span>
				<span class="s">&quot;%i, l %i </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
				<span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
			<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">,</span>
					    <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* No data transfer */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_64bit_start_scsi: No data, command &quot;</span>
			<span class="s">&quot;packet data - b %i, t %i, l %i </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">==</span> <span class="n">REQUEST_ENTRY_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Set chip new ring index. */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
		<span class="s">&quot;qla1280_64bit_start_scsi: Wakeup RISC for pending command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_SENT</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">actthreads</span><span class="o">++</span><span class="p">;</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">);</span>
	<span class="cm">/* Enforce mmio write ordering; see comment in qla1280_isp_cmd(). */</span>
	<span class="n">mmiowb</span><span class="p">();</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_64bit_start_scsi: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qla1280_64bit_start_scsi: exiting normally</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !QLA_64BIT_PTR */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_32bit_start_scsi</span>
<span class="cm"> *      The start SCSI is responsible for building request packets on</span>
<span class="cm"> *      request ring and modifying ISP input pointer.</span>
<span class="cm"> *</span>
<span class="cm"> *      The Qlogic firmware interface allows every queue slot to have a SCSI</span>
<span class="cm"> *      command and up to 4 scatter/gather (SG) entries.  If we need more</span>
<span class="cm"> *      than 4 SG entries, then continuation entries are used that can</span>
<span class="cm"> *      hold another 7 entries each.  The start routine determines if there</span>
<span class="cm"> *      is eought empty slots then build the combination of requests to</span>
<span class="cm"> *      fulfill the OS request.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha = adapter block pointer.</span>
<span class="cm"> *      sp = SCSI Request Block structure pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success, was able to issue command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_32bit_start_scsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span> <span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_entry</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">dword_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seg_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dir</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_32bit_start_scsi&quot;</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;32bit_start: cmd=%p sp=%p CDB=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Calculate number of entries and segments required. */</span>
	<span class="n">req_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">seg_cnt</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * if greater than four sg entries then we need to allocate</span>
<span class="cm">		 * continuation entries</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req_cnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">seg_cnt</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">seg_cnt</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">)</span>
				<span class="n">req_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;S/G Transfer cmd=%p seg_cnt=0x%x, req_cnt=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="p">,</span> <span class="n">seg_cnt</span><span class="p">,</span> <span class="n">req_cnt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seg_cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Calculate number of free request entries. */</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">=</span>
				<span class="n">REQUEST_ENTRY_CNT</span> <span class="o">-</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Number of free entries=(%d) seg_cnt=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">,</span> <span class="n">seg_cnt</span><span class="p">);</span>
	<span class="cm">/* If room for request in request ring. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_32bit_start_scsi: in-ptr=0x%x, &quot;</span>
			<span class="s">&quot;req_q_cnt=0x%x, req_cnt=0x%x&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">,</span> <span class="n">req_cnt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for empty slot in outstanding command list. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_32bit_start_scsi: NO ROOM IN OUTSTANDING &quot;</span>
			<span class="s">&quot;ARRAY, req_q_cnt=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Build command packet.</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="p">;</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">=</span> <span class="n">COMMAND_TYPE</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sys_define</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cnt</span><span class="p">);</span>

	<span class="cm">/* Zero out remaining portion of packet. */</span>
	<span class="n">memset</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">REQUEST_ENTRY_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* Set ISP command timeout. */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="o">/</span><span class="n">HZ</span><span class="p">);</span>

	<span class="cm">/* Set device target ID and LUN */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="o">:</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Enable simple tag queuing if device supports it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">simple_tags</span><span class="p">)</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">BIT_3</span><span class="p">);</span>

	<span class="cm">/* Load SCSI command packet. */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cdb_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_CDBLEN</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">scsi_cdb</span><span class="p">,</span> <span class="n">CMD_CDBP</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">CMD_CDBLEN</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/*dprintk(1, &quot;Build packet for command[0]=0x%x\n&quot;,pkt-&gt;scsi_cdb[0]); */</span>
	<span class="cm">/* Set transfer direction. */</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="n">qla1280_data_direction</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

	<span class="cm">/* Set total data segment count. */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dseg_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seg_cnt</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Load data segments.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">remseg</span> <span class="o">=</span> <span class="n">seg_cnt</span><span class="p">;</span>

		<span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

		<span class="cm">/* Setup packet address segment pointer. */</span>
		<span class="n">dword_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Building S/G data segments..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sg</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* Load command entry data segments. */</span>
		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">seg_cnt</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">s</span><span class="p">)));</span>
			<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;S/G Segment phys_addr=0x%lx, len=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">s</span><span class="p">))),</span>
				<span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">)));</span>
			<span class="n">remseg</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Build continuation packets.</span>
<span class="cm">		 */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;S/G Building Continuation&quot;</span>
			<span class="s">&quot;...seg_cnt=0x%x remains</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seg_cnt</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">remseg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Continue from end point */</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="cm">/* Adjust ring index. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">==</span> <span class="n">REQUEST_ENTRY_CNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span> <span class="o">=</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="o">++</span><span class="p">;</span>

			<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="p">;</span>

			<span class="cm">/* Zero out packet. */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>

			<span class="cm">/* Load packet defaults. */</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">cont_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span>
				<span class="n">entry_type</span> <span class="o">=</span> <span class="n">CONTINUE_TYPE</span><span class="p">;</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">cont_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="p">((</span><span class="k">struct</span> <span class="n">cont_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sys_define</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">;</span>

			<span class="cm">/* Setup packet address segment pointer. */</span>
			<span class="n">dword_ptr</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">cont_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dseg_0_address</span><span class="p">;</span>

			<span class="cm">/* Load continuation entry data segments. */</span>
			<span class="n">for_each_sg</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">remseg</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">s</span><span class="p">)));</span>
				<span class="o">*</span><span class="n">dword_ptr</span><span class="o">++</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
					<span class="s">&quot;S/G Segment Cont. phys_addr=0x%x, &quot;</span>
					<span class="s">&quot;len=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_dma_lo32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">s</span><span class="p">))),</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">s</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="n">remseg</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_32bit_start_scsi: &quot;</span>
				<span class="s">&quot;continuation packet data - &quot;</span>
				<span class="s">&quot;scsi(%i:%i:%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
				<span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
			<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">,</span>
					    <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* No data transfer at all */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_32bit_start_scsi: No data, command &quot;</span>
			<span class="s">&quot;packet data - </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_32bit_start_scsi: First IOCB block:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="p">,</span>
			    <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>

	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">==</span> <span class="n">REQUEST_ENTRY_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Set chip new ring index. */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_32bit_start_scsi: Wakeup RISC &quot;</span>
		<span class="s">&quot;for pending command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_SENT</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">actthreads</span><span class="o">++</span><span class="p">;</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">);</span>
	<span class="cm">/* Enforce mmio write ordering; see comment in qla1280_isp_cmd(). */</span>
	<span class="n">mmiowb</span><span class="p">();</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_32bit_start_scsi: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_32bit_start_scsi&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_req_pkt</span>
<span class="cm"> *      Function is responsible for locking ring and</span>
<span class="cm"> *      getting a zeroed out request packet.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha  = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = failed to get slot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">request_t</span> <span class="o">*</span>
<span class="nf">qla1280_req_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="n">request_t</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">timer</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_req_pkt&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This can be called from interrupt context, damn it!!!</span>
<span class="cm">	 */</span>
	<span class="cm">/* Wait for 30 seconds for slot. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timer</span> <span class="o">=</span> <span class="mi">15000000</span><span class="p">;</span> <span class="n">timer</span><span class="p">;</span> <span class="n">timer</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Calculate number of free request entries. */</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">=</span>
					<span class="n">REQUEST_ENTRY_CNT</span> <span class="o">-</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Found empty request ring slot? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="p">;</span>

			<span class="cm">/* Zero out packet. */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * How can this be right when we have a ring</span>
<span class="cm">			 * size of 512???</span>
<span class="cm">			 */</span>
			<span class="cm">/* Set system defined field. */</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sys_define</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">;</span>

			<span class="cm">/* Set entry count. */</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>	<span class="cm">/* 10 */</span>

		<span class="cm">/* Check for pending interrupts. */</span>
		<span class="n">qla1280_poll</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_req_pkt: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;qla1280_req_pkt: exiting normally</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pkt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qla1280_isp_cmd</span>
<span class="cm"> *      Function is responsible for modifying ISP input pointer.</span>
<span class="cm"> *      Releases ring lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha  = adapter block pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_isp_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_isp_cmd&quot;</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_isp_cmd: IOCB data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="p">,</span>
			    <span class="n">REQUEST_ENTRY_SIZE</span><span class="p">);</span>

	<span class="cm">/* Adjust ring index. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">==</span> <span class="n">REQUEST_ENTRY_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring_ptr</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update request index to mailbox4 (Request Queue In).</span>
<span class="cm">	 * The mmiowb() ensures that this write is ordered with writes by other</span>
<span class="cm">	 * CPUs.  Without the mmiowb(), it is possible for the following:</span>
<span class="cm">	 *    CPUA posts write of index 5 to mailbox4</span>
<span class="cm">	 *    CPUA releases host lock</span>
<span class="cm">	 *    CPUB acquires host lock</span>
<span class="cm">	 *    CPUB posts write of index 6 to mailbox4</span>
<span class="cm">	 *    On PCI bus, order reverses and write of 6 posts, then index 5,</span>
<span class="cm">	 *       causing chip to issue full queue of stale commands</span>
<span class="cm">	 * The mmiowb() prevents future writes from crossing the barrier.</span>
<span class="cm">	 * See Documentation/DocBook/deviceiobook.tmpl for more information.</span>
<span class="cm">	 */</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_ring_index</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_isp_cmd&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*                        Interrupt Service Routine.                        */</span>
<span class="cm">/****************************************************************************/</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *  qla1280_isr</span>
<span class="cm"> *      Calls I/O done on command completion.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha           = adapter block pointer.</span>
<span class="cm"> *      done_q       = done queue.</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">done_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">response</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mailbox</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">istatus</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_isr&quot;</span><span class="p">);</span>

	<span class="n">istatus</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">istatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RISC_INT</span> <span class="o">|</span> <span class="n">PCI_INT</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Save mailbox register 5 */</span>
	<span class="n">mailbox</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox5</span><span class="p">);</span>

	<span class="cm">/* Check for mailbox interrupt. */</span>

	<span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RD_REG_WORD_dmasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get mailbox data. */</span>
		<span class="cm">/* dprintk(1, &quot;qla1280_isr: In Get mailbox data \n&quot;); */</span>

		<span class="n">wptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="o">*</span><span class="n">wptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">wptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox1</span><span class="p">);</span>
		<span class="o">*</span><span class="n">wptr</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBA_SCSI_COMPLETION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wptr</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">wptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox3</span><span class="p">);</span>
			<span class="o">*</span><span class="n">wptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox4</span><span class="p">);</span>
			<span class="n">wptr</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">wptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox6</span><span class="p">);</span>
			<span class="o">*</span><span class="n">wptr</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox7</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Release mailbox registers. */</span>

		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">semaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">HC_CLR_RISC_INT</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_isr: mailbox interrupt mailbox[0] = 0x%x&quot;</span><span class="p">,</span>
			<span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="cm">/* Handle asynchronous event */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MBA_SCSI_COMPLETION</span>:	<span class="cm">/* Response completion */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_isr: mailbox SCSI response &quot;</span>
				<span class="s">&quot;completion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Get outstanding command index. */</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

				<span class="cm">/* Validate handle. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
					<span class="n">sp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Free outstanding command slot. */</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

					<span class="cm">/* Save ISP completion status */</span>
					<span class="n">CMD_RESULT</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">COMPLETED_HANDLE</span><span class="p">;</span>

					<span class="cm">/* Place block on done queue */</span>
					<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">done_q</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * If we get here we have a real problem!</span>
<span class="cm">					 */</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					       <span class="s">&quot;qla1280: ISP invalid handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBA_BUS_RESET</span>:	<span class="cm">/* SCSI Bus Reset */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_marker</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">reset_marker</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;qla1280_isr(): index %i &quot;</span>
			       <span class="s">&quot;asynchronous BUS_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBA_SYSTEM_ERR</span>:	<span class="cm">/* System Error */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;qla1280: ISP System Error - mbx1=%xh, mbx2=&quot;</span>
			       <span class="s">&quot;%xh, mbx3=%xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			       <span class="n">mailbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBA_REQ_TRANSFER_ERR</span>:	<span class="cm">/* Request Transfer Error */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;qla1280: ISP Request Transfer Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBA_RSP_TRANSFER_ERR</span>:	<span class="cm">/* Response Transfer Error */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;qla1280: ISP Response Transfer Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBA_WAKEUP_THRES</span>:	<span class="cm">/* Request Queue Wake-up */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_isr: asynchronous WAKEUP_THRES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBA_TIMEOUT_RESET</span>:	<span class="cm">/* Execution Timeout Reset */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="s">&quot;qla1280_isr: asynchronous TIMEOUT_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBA_DEVICE_RESET</span>:	<span class="cm">/* Bus Device Reset */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280_isr(): asynchronous &quot;</span>
			       <span class="s">&quot;BUS_DEVICE_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_marker</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">reset_marker</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBA_BUS_MODE_CHANGE</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="s">&quot;qla1280_isr: asynchronous BUS_MODE_CHANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* dprintk(1, &quot;qla1280_isr: default case of switch MB \n&quot;); */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MBA_ASYNC_EVENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">memcpy</span><span class="p">((</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">,</span> <span class="n">wptr</span><span class="p">,</span>
				       <span class="n">MAILBOX_REGISTER_COUNT</span> <span class="o">*</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>

				<span class="k">if</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_wait</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">complete</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_wait</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">HC_CLR_RISC_INT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We will receive interrupts during mailbox testing prior to</span>
<span class="cm">	 * the card being marked online, hence the double check.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_wait</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_isr: Response pointer Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">RESPONSE_ENTRY_CNT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_ring_index</span> <span class="o">!=</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring_ptr</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;qla1280_isr: ha-&gt;rsp_ring_index = 0x%x, mailbox[5]&quot;</span>
			<span class="s">&quot; = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_ring_index</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="s">&quot;qla1280_isr: response packet data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">,</span> <span class="n">RESPONSE_ENTRY_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">==</span> <span class="n">STATUS_TYPE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
			    <span class="o">||</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">comp_status</span> <span class="o">||</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_isr: ha-&gt;rsp_ring_index = &quot;</span>
					<span class="s">&quot;0x%x mailbox[5] = 0x%x, comp_status &quot;</span>
					<span class="s">&quot;= 0x%x, scsi_status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_ring_index</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">),</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_isr: ha-&gt;rsp_ring_index = &quot;</span>
				<span class="s">&quot;0x%x, mailbox[5] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_ring_index</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_isr: response packet data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">,</span>
					    <span class="n">RESPONSE_ENTRY_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">==</span> <span class="n">STATUS_TYPE</span> <span class="o">||</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;status: Cmd %p, handle %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">==</span> <span class="n">STATUS_TYPE</span><span class="p">)</span>
				<span class="n">qla1280_status_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">done_q</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">qla1280_error_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">done_q</span><span class="p">);</span>
			<span class="cm">/* Adjust ring index. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_ring_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_ring_index</span> <span class="o">==</span> <span class="n">RESPONSE_ENTRY_CNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_ring_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring_ptr</span> <span class="o">=</span>	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring_ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox5</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">rsp_ring_index</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
 <span class="nl">out:</span>
	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_isr&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  qla1280_rst_aen</span>
<span class="cm"> *      Processes asynchronous reset.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha  = adapter block pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_rst_aen</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">bus</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_rst_aen&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_active</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">abort_isp_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_marker</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Issue marker command. */</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_marker</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">&amp;&amp;</span>
				     <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">reset_marker</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">reset_marker</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">reset_marker</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">qla1280_marker</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						       <span class="n">MK_SYNC_ALL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_rst_aen&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  qla1280_status_entry</span>
<span class="cm"> *      Processes received ISP status entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha           = adapter block pointer.</span>
<span class="cm"> *      pkt          = entry pointer.</span>
<span class="cm"> *      done_q       = done queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_status_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">response</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">done_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sense_sz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">scsi_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">scsi_status</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">comp_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">comp_status</span><span class="p">);</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_status_entry&quot;</span><span class="p">);</span>

	<span class="cm">/* Validate handle. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;qla1280: Status Entry invalid handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free outstanding command slot. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* Generate LU queue on cntrl, target, LUN */</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comp_status</span> <span class="o">||</span> <span class="n">scsi_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;scsi: comp_status = 0x%x, scsi_status = &quot;</span>
			<span class="s">&quot;0x%x, handle = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">comp_status</span><span class="p">,</span>
			<span class="n">scsi_status</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Target busy or queue full */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAM_STAT_TASK_SET_FULL</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAM_STAT_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CMD_RESULT</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* Save ISP completion status */</span>
		<span class="n">CMD_RESULT</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">qla1280_return_status</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">&amp;</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="n">CS_ARS_FAILED</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">uint16_t</span> <span class="n">req_sense_length</span> <span class="o">=</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req_sense_length</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req_sense_length</span> <span class="o">&lt;</span> <span class="n">CMD_SNSLEN</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
					<span class="n">sense_sz</span> <span class="o">=</span> <span class="n">req_sense_length</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="cm">/*</span>
<span class="cm">					 * scsi_cmnd-&gt;sense_buffer is</span>
<span class="cm">					 * 64 bytes, why only copy 63?</span>
<span class="cm">					 * This looks wrong! /Jes</span>
<span class="cm">					 */</span>
					<span class="n">sense_sz</span> <span class="o">=</span> <span class="n">CMD_SNSLEN</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req_sense_data</span><span class="p">,</span> <span class="n">sense_sz</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">sense_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span> <span class="o">+</span> <span class="n">sense_sz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">SCSI_SENSE_BUFFERSIZE</span> <span class="o">-</span> <span class="n">sense_sz</span><span class="p">);</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_status_entry: Check &quot;</span>
				<span class="s">&quot;condition Sense data, b %i, t %i, &quot;</span>
				<span class="s">&quot;l %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sense_sz</span><span class="p">)</span>
				<span class="n">qla1280_dump_buffer</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
						    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
						    <span class="n">sense_sz</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">COMPLETED_HANDLE</span><span class="p">;</span>

	<span class="cm">/* Place command on done queue. */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">done_q</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_status_entry&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  qla1280_error_entry</span>
<span class="cm"> *      Processes error entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha           = adapter block pointer.</span>
<span class="cm"> *      pkt          = entry pointer.</span>
<span class="cm"> *      done_q       = done queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_error_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">response</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">done_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_error_entry&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&amp;</span> <span class="n">BIT_3</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_error_entry: BAD PAYLOAD flag error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&amp;</span> <span class="n">BIT_2</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_error_entry: BAD HEADER flag error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_error_entry: FULL flag error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_error_entry: UNKNOWN flag error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Validate handle. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">)</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Free outstanding command slot. */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Bad payload or header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT_3</span> <span class="o">+</span> <span class="n">BIT_2</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Bad payload or header, set error status. */</span>
			<span class="cm">/* CMD_RESULT(sp-&gt;cmd) = CS_BAD_PAYLOAD; */</span>
			<span class="n">CMD_RESULT</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_status</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* FULL flag */</span>
			<span class="n">CMD_RESULT</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Set error status. */</span>
			<span class="n">CMD_RESULT</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">COMPLETED_HANDLE</span><span class="p">;</span>

		<span class="cm">/* Place command on done queue. */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">done_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef QLA_64BIT_PTR</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">==</span> <span class="n">COMMAND_A64_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;!qla1280: Error Entry invalid handle&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_error_entry&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  qla1280_abort_isp</span>
<span class="cm"> *      Resets ISP and aborts all outstanding commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      ha           = adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      0 = success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_abort_isp</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">;</span>

	<span class="n">ENTER</span><span class="p">(</span><span class="s">&quot;qla1280_abort_isp&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">abort_isp_active</span> <span class="o">||</span> <span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">online</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">abort_isp_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Disable ISP interrupts. */</span>
	<span class="n">qla1280_disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">HC_PAUSE_RISC</span><span class="p">);</span>
	<span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id_l</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi(%li): dequeuing outstanding commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="cm">/* Dequeue all commands in outstanding command list. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
			<span class="n">CMD_RESULT</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">COMPLETED_HANDLE</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">done_q</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">qla1280_done</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_load_firmware</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Setup adapter based on NVRAM parameters. */</span>
	<span class="n">qla1280_nvram_config</span> <span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla1280_init_rings</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		
	<span class="cm">/* Issue SCSI reset. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">bus</span><span class="o">++</span><span class="p">)</span>
		<span class="n">qla1280_bus_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bus</span><span class="p">);</span>
		
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">abort_isp_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;qla1280: ISP error recovery failed, board disabled&quot;</span><span class="p">);</span>
		<span class="n">qla1280_reset_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;qla1280_abort_isp: **** FAILED ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">LEAVE</span><span class="p">(</span><span class="s">&quot;qla1280_abort_isp&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * qla1280_debounce_register</span>
<span class="cm"> *      Debounce register.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *      port = register address.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      register value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">qla1280_debounce_register</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">ret2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">ret2</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">ret2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">ret2</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">ret2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/************************************************************************</span>
<span class="cm"> * qla1280_check_for_dead_scsi_bus                                      *</span>
<span class="cm"> *                                                                      *</span>
<span class="cm"> *    This routine checks for a dead SCSI bus                           *</span>
<span class="cm"> ************************************************************************/</span>
<span class="cp">#define SET_SXP_BANK            0x0100</span>
<span class="cp">#define SCSI_PHASE_INVALID      0x87FF</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla1280_check_for_dead_scsi_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">config_reg</span><span class="p">,</span> <span class="n">scsi_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">scsi_bus_dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">HC_PAUSE_RISC</span><span class="p">);</span>
		<span class="n">config_reg</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cfg_1</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cfg_1</span><span class="p">,</span> <span class="n">SET_SXP_BANK</span><span class="p">);</span>
		<span class="n">scsi_control</span> <span class="o">=</span> <span class="n">RD_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">scsiControlPins</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">cfg_1</span><span class="p">,</span> <span class="n">config_reg</span><span class="p">);</span>
		<span class="n">WRT_REG_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_cmd</span><span class="p">,</span> <span class="n">HC_RELEASE_RISC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_control</span> <span class="o">==</span> <span class="n">SCSI_PHASE_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">scsi_bus_dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* bus is dead */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">scsi_bus_dead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="n">bus</span><span class="p">].</span><span class="n">failed_reset_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* bus is not dead */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla1280_get_target_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">mb</span><span class="p">[</span><span class="n">MAILBOX_REGISTER_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>


	<span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBC_GET_TARGET_PARAMETERS</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">bus</span> <span class="o">?</span> <span class="n">target</span> <span class="o">|</span> <span class="n">BIT_7</span> <span class="o">:</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">qla1280_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_0</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi(%li:%d:%d:%d):&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Sync: period %d, offset %d&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_13</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, Wide&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">mb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, DT&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Async&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">simple_tags</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, Tagged queuing: depth %d&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#if DEBUG_QLA1280</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__qla1280_dump_buffer</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; 0   1   2   3   4   5   6   7   8   9   Ah  &quot;</span>
	       <span class="s">&quot;Bh  Ch  Dh  Eh  Fh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;---------------------------------------------&quot;</span>
	       <span class="s">&quot;------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%02x&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cnt</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *   ql1280_print_scsi_cmd</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__qla1280_print_scsi_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">CMD_HOST</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="cm">/* struct scatterlist *sg; */</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">)</span><span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SCSI Command @= 0x%p, Handle=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">CMD_HANDLE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  chan=%d, target = 0x%02x, lun = 0x%02x, cmd_len = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">SCSI_BUS_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">SCSI_TCN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">SCSI_LUN_32</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
	       <span class="n">CMD_CDBLEN</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; CDB = &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%02x &quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  seg_cnt =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  request buffer=0x%p, request buffer len=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="cm">/* if (cmd-&gt;use_sg)</span>
<span class="cm">	   {</span>
<span class="cm">	   sg = (struct scatterlist *) cmd-&gt;request_buffer;</span>
<span class="cm">	   printk(&quot;  SG buffer: \n&quot;);</span>
<span class="cm">	   qla1280_dump_buffer(1, (char *)sg, (cmd-&gt;use_sg*sizeof(struct scatterlist)));</span>
<span class="cm">	   } */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  tag=%d, transfersize=0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transfersize</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  SP=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; underflow size = 0x%x, direction=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *   ql1280_dump_device</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ql1280_dump_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Outstanding Commands on controller:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_OUTSTANDING_COMMANDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sp</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">outstanding_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">qla1280_print_scsi_cmd</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">enum</span> <span class="n">tokens</span> <span class="p">{</span>
	<span class="n">TOKEN_NVRAM</span><span class="p">,</span>
	<span class="n">TOKEN_SYNC</span><span class="p">,</span>
	<span class="n">TOKEN_WIDE</span><span class="p">,</span>
	<span class="n">TOKEN_PPR</span><span class="p">,</span>
	<span class="n">TOKEN_VERBOSE</span><span class="p">,</span>
	<span class="n">TOKEN_DEBUG</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">setup_tokens</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">setup_tokens</span> <span class="n">setup_token</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> 
<span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;nvram&quot;</span><span class="p">,</span> <span class="n">TOKEN_NVRAM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sync&quot;</span><span class="p">,</span> <span class="n">TOKEN_SYNC</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;wide&quot;</span><span class="p">,</span> <span class="n">TOKEN_WIDE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ppr&quot;</span><span class="p">,</span> <span class="n">TOKEN_PPR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">TOKEN_VERBOSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;debug&quot;</span><span class="p">,</span> <span class="n">TOKEN_DEBUG</span> <span class="p">},</span>
<span class="p">};</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> *   qla1280_setup</span>
<span class="cm"> *</span>
<span class="cm"> *   Handle boot parameters. This really needs to be changed so one</span>
<span class="cm"> *   can specify per adapter parameters.</span>
<span class="cm"> **************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">qla1280_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">toke</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;no&quot;</span><span class="p">))</span> <span class="p">{</span>
 			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">toke</span> <span class="o">=</span> <span class="n">qla1280_get_token</span><span class="p">(</span><span class="n">cp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TOKEN_NVRAM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
				<span class="n">driver_setup</span><span class="p">.</span><span class="n">no_nvram</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOKEN_SYNC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
				<span class="n">driver_setup</span><span class="p">.</span><span class="n">no_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x10000</span><span class="p">)</span>
				<span class="n">driver_setup</span><span class="p">.</span><span class="n">sync_mask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOKEN_WIDE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
				<span class="n">driver_setup</span><span class="p">.</span><span class="n">no_wide</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x10000</span><span class="p">)</span>
				<span class="n">driver_setup</span><span class="p">.</span><span class="n">wide_mask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOKEN_PPR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
				<span class="n">driver_setup</span><span class="p">.</span><span class="n">no_ppr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x10000</span><span class="p">)</span>
				<span class="n">driver_setup</span><span class="p">.</span><span class="n">ppr_mask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TOKEN_VERBOSE</span>:
			<span class="n">qla1280_verbose</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280: unknown boot option %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="sc">&#39;;&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
			<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">qla1280_get_token</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sep</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sep</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">setup_token</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">setup_token</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">token</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="p">(</span><span class="n">sep</span> <span class="o">-</span> <span class="n">str</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span>  <span class="n">setup_token</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">qla1280_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>		<span class="o">=</span> <span class="s">&quot;qla1280&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;Qlogic ISP 1280/12160&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">qla1280_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">qla1280_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">qla1280_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">qla1280_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span><span class="o">=</span> <span class="n">qla1280_eh_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>	<span class="o">=</span> <span class="n">qla1280_eh_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">qla1280_eh_adapter_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>		<span class="o">=</span> <span class="n">qla1280_biosparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="mh">0xfffff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">qla1280_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">devnum</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_boards</span> <span class="o">*</span><span class="n">bdp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ql1280_board_tbl</span><span class="p">[</span><span class="n">devnum</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Bypass all AMI SUBSYS VENDOR IDs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_AMI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;qla1280: Skipping AMI SubSys Vendor ID Chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280: %s found on PCI bus %i, dev %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bdp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;qla1280: Failed to enabled pci device, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla1280_driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;qla1280: Failed to register host, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span><span class="p">));</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">devnum</span> <span class="o">=</span> <span class="n">devnum</span><span class="p">;</span>	<span class="cm">/* specifies microcode load address */</span>

<span class="cp">#ifdef QLA_64BIT_PTR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi(%li): Unable to set a &quot;</span>
			       <span class="s">&quot;suitable DMA mask - aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_put_host</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;scsi(%li): 64 Bit PCI Addressing Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi(%li): Unable to set a &quot;</span>
		       <span class="s">&quot;suitable DMA mask - aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_put_host</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="p">((</span><span class="n">REQUEST_ENTRY_CNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">)),</span>
			<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280: Failed to get request memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_put_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="p">((</span><span class="n">RESPONSE_ENTRY_CNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">response</span><span class="p">)),</span>
			<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280: Failed to get response memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_free_request_ring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="n">bdp</span><span class="o">-&gt;</span><span class="n">numPorts</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="n">bdp</span><span class="o">-&gt;</span><span class="n">numPorts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">MAX_LUNS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">MAX_TARGETS</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#if MEMORY_MAPPED_IO</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mmpbase</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mmpbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280: Unable to map I/O memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_free_response_ring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mmpbase</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mmpbase</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">&quot;qla1280&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1280: Failed to reserve i/o region &quot;</span>
				 <span class="s">&quot;0x%04lx-0x%04lx - already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">+</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_free_response_ring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device_reg</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">done_q</span><span class="p">);</span>

	<span class="cm">/* Disable ISP interrupts. */</span>
	<span class="n">qla1280_disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">qla1280_intr_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				<span class="s">&quot;qla1280&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;qla1280 : Failed to reserve interrupt %d already &quot;</span>
		       <span class="s">&quot;in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_release_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* load the F/W, read paramaters, and init the H/W */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla1280_initialize_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;qla1x160: Failed to initialize adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set our host ID  (need to do something about our two IDs) */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bus_settings</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_disable_adapter</span><span class="p">;</span>
	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error_disable_adapter:</span>
	<span class="n">qla1280_disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
 <span class="nl">error_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
 <span class="nl">error_release_region:</span>
<span class="cp">#if MEMORY_MAPPED_IO</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mmpbase</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="cp">#endif</span>
 <span class="nl">error_free_response_ring:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="p">((</span><span class="n">RESPONSE_ENTRY_CNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">response</span><span class="p">)),</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span><span class="p">);</span>
 <span class="nl">error_free_request_ring:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="p">((</span><span class="n">REQUEST_ENTRY_CNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">)),</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">);</span>
 <span class="nl">error_put_host:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
 <span class="nl">error_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
 <span class="nl">error:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">qla1280_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">qla1280_disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

<span class="cp">#if MEMORY_MAPPED_IO</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mmpbase</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">io_port</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="p">((</span><span class="n">REQUEST_ENTRY_CNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">request_t</span><span class="p">))),</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="p">((</span><span class="n">RESPONSE_ENTRY_CNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">response</span><span class="p">))),</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">qla1280_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;qla1280&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">qla1280_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">qla1280_probe_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">qla1280_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">qla1280_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">srb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_pointer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;qla1280: struct srb too big, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we are called as a module, the qla1280 pointer may not be null</span>
<span class="cm">	 * and it would point to our bootup string, just like on the lilo</span>
<span class="cm">	 * command line.  IF not NULL, then process this config string with</span>
<span class="cm">	 * qla1280_setup</span>
<span class="cm">	 *</span>
<span class="cm">	 * Boot time Options</span>
<span class="cm">	 * To add options at boot time add a line to your lilo.conf file like:</span>
<span class="cm">	 * append=&quot;qla1280=verbose,max_tags:{{255,255,255,255},{255,255,255,255}}&quot;</span>
<span class="cm">	 * which will result in the first four devices on the first two</span>
<span class="cm">	 * controllers being set to a tagged queue depth of 32.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla1280</span><span class="p">)</span>
		<span class="n">qla1280_setup</span><span class="p">(</span><span class="n">qla1280</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla1280_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">qla1280_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla1280_pci_driver</span><span class="p">);</span>
	<span class="cm">/* release any allocated firmware images */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QL_NUM_FW_IMAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">qla1280_fw_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fw</span><span class="p">);</span>
		<span class="n">qla1280_fw_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">qla1280_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">qla1280_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Qlogic &amp; Jes Sorensen&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Qlogic ISP SCSI (qla1x80/qla1x160) driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;qlogic/1040.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;qlogic/1280.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;qlogic/12160.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">QLA1280_VERSION</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we almost follow Linus&#39;s tabbing style.</span>
<span class="cm"> * Emacs will notice this stuff at the end of the file and automatically</span>
<span class="cm"> * adjust the settings for this buffer only.  This must remain at the end</span>
<span class="cm"> * of the file.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * tab-width: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
