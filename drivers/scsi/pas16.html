<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › pas16.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pas16.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This driver adapted from Drew Eckhardt&#39;s Trantor T128 driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1993, Drew Eckhardt</span>
<span class="cm"> *	Visionary Computing</span>
<span class="cm"> *	(Unix and Linux consulting and custom programming)</span>
<span class="cm"> *	drew@colorado.edu</span>
<span class="cm"> *      +1 (303) 666-5836</span>
<span class="cm"> *</span>
<span class="cm"> *  ( Based on T128 - DISTRIBUTION RELEASE 3. ) </span>
<span class="cm"> *</span>
<span class="cm"> * Modified to work with the Pro Audio Spectrum/Studio 16</span>
<span class="cm"> * by John Weidman.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * For more information, please consult </span>
<span class="cm"> *</span>
<span class="cm"> * Media Vision</span>
<span class="cm"> * (510) 770-8600</span>
<span class="cm"> * (800) 348-7116</span>
<span class="cm"> * </span>
<span class="cm"> * and </span>
<span class="cm"> *</span>
<span class="cm"> * NCR 5380 Family</span>
<span class="cm"> * SCSI Protocol Controller</span>
<span class="cm"> * Databook</span>
<span class="cm"> *</span>
<span class="cm"> * NCR Microelectronics</span>
<span class="cm"> * 1635 Aeroplaza Drive</span>
<span class="cm"> * Colorado Springs, CO 80916</span>
<span class="cm"> * 1+ (719) 578-3400</span>
<span class="cm"> * 1+ (800) 334-5454</span>
<span class="cm"> */</span>


<span class="cp">#ifndef PAS16_H</span>
<span class="cp">#define PAS16_H</span>

<span class="cp">#define PAS16_PUBLIC_RELEASE 3</span>

<span class="cp">#define PDEBUG_INIT	0x1</span>
<span class="cp">#define PDEBUG_TRANSFER 0x2</span>

<span class="cp">#define PAS16_DEFAULT_BASE_1  0x388</span>
<span class="cp">#define PAS16_DEFAULT_BASE_2  0x384</span>
<span class="cp">#define PAS16_DEFAULT_BASE_3  0x38c</span>
<span class="cp">#define PAS16_DEFAULT_BASE_4  0x288</span>

<span class="cp">#define PAS16_DEFAULT_BOARD_1_IRQ 10</span>
<span class="cp">#define PAS16_DEFAULT_BOARD_2_IRQ 12</span>
<span class="cp">#define PAS16_DEFAULT_BOARD_3_IRQ 14</span>
<span class="cp">#define PAS16_DEFAULT_BOARD_4_IRQ 15</span>


<span class="cm">/*</span>
<span class="cm"> * The Pro Audio Spectrum boards are I/O mapped. They use a Zilog 5380</span>
<span class="cm"> * SCSI controller, which is the equivalent of NCR&#39;s 5380.  &quot;Pseudo-DMA&quot;</span>
<span class="cm"> * architecture is used, where a PAL drives the DMA signals on the 5380</span>
<span class="cm"> * allowing fast, blind transfers with proper handshaking. </span>
<span class="cm"> */</span>


<span class="cm">/* The Time-out Counter register is used to safe-guard against a stuck</span>
<span class="cm"> * bus (in the case of RDY driven handshake) or a stuck byte (if 16-Bit</span>
<span class="cm"> * DMA conversion is used).  The counter uses a 28.224MHz clock</span>
<span class="cm"> * divided by 14 as its clock source.  In the case of a stuck byte in</span>
<span class="cm"> * the holding register, an interrupt is generated (and mixed with the</span>
<span class="cm"> * one with the drive) using the CD-ROM interrupt pointer.</span>
<span class="cm"> */</span>
 
<span class="cp">#define P_TIMEOUT_COUNTER_REG	0x4000</span>
<span class="cp">#define P_TC_DISABLE	0x80	</span><span class="cm">/* Set to 0 to enable timeout int. */</span><span class="cp"></span>
				<span class="cm">/* Bits D6-D0 contain timeout count */</span>


<span class="cp">#define P_TIMEOUT_STATUS_REG_OFFSET	0x4001</span>
<span class="cp">#define P_TS_TIM		0x80	</span><span class="cm">/* check timeout status */</span><span class="cp"></span>
					<span class="cm">/* Bits D6-D4 N/U */</span>
<span class="cp">#define P_TS_ARM_DRQ_INT	0x08	</span><span class="cm">/* Arm DRQ Int.  When set high,</span>
<span class="cm">					 * the next rising edge will</span>
<span class="cm">					 * cause a CD-ROM interrupt.</span>
<span class="cm">					 * When set low, the interrupt</span>
<span class="cm">					 * will be cleared.  There is</span>
<span class="cm">					 * no status available for</span>
<span class="cm">					 * this interrupt.</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define P_TS_ENABLE_TO_ERR_INTERRUPT	</span><span class="cm">/* Enable timeout error int. */</span><span class="cp"></span>
<span class="cp">#define P_TS_ENABLE_WAIT		</span><span class="cm">/* Enable Wait */</span><span class="cp"></span>

<span class="cp">#define P_TS_CT			0x01	</span><span class="cm">/* clear timeout. Note: writing</span>
<span class="cm">					 * to this register clears the</span>
<span class="cm">					 * timeout error int. or status</span>
<span class="cm">					 */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * The data register reads/writes to/from the 5380 in pseudo-DMA mode</span>
<span class="cm"> */</span> 

<span class="cp">#define P_DATA_REG_OFFSET	0x5c00	</span><span class="cm">/* rw */</span><span class="cp"></span>

<span class="cp">#define P_STATUS_REG_OFFSET	0x5c01	</span><span class="cm">/* ro */</span><span class="cp"></span>
<span class="cp">#define P_ST_RDY		0x80	</span><span class="cm">/* 5380 DDRQ Status */</span><span class="cp"></span>

<span class="cp">#define P_IRQ_STATUS		0x5c03</span>
<span class="cp">#define P_IS_IRQ		0x80	</span><span class="cm">/* DIRQ status */</span><span class="cp"></span>

<span class="cp">#define PCB_CONFIG 0x803</span>
<span class="cp">#define MASTER_ADDRESS_PTR 0x9a01  </span><span class="cm">/* Fixed position - no relo */</span><span class="cp"></span>
<span class="cp">#define SYS_CONFIG_4 0x8003</span>
<span class="cp">#define WAIT_STATE 0xbc00</span>
<span class="cp">#define OPERATION_MODE_1 0xec03</span>
<span class="cp">#define IO_CONFIG_3 0xf002</span>


<span class="cp">#ifndef ASM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pas16_abort</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pas16_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="p">,</span>
			   <span class="n">sector_t</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pas16_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pas16_queue_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pas16_bus_reset</span><span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#ifndef CMD_PER_LUN</span>
<span class="cp">#define CMD_PER_LUN 2</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CAN_QUEUE</span>
<span class="cp">#define CAN_QUEUE 32 </span>
<span class="cp">#endif</span>

<span class="cp">#ifndef HOSTS_C</span>

<span class="cp">#define NCR5380_implementation_fields \</span>
<span class="cp">    volatile unsigned short io_port</span>

<span class="cp">#define NCR5380_local_declare() \</span>
<span class="cp">    volatile unsigned short io_port</span>

<span class="cp">#define NCR5380_setup(instance) \</span>
<span class="cp">    io_port = (instance)-&gt;io_port</span>

<span class="cp">#define PAS16_io_port(reg) ( io_port + pas16_offset[(reg)] )</span>

<span class="cp">#if !(PDEBUG &amp; PDEBUG_TRANSFER) </span>
<span class="cp">#define NCR5380_read(reg) ( inb(PAS16_io_port(reg)) )</span>
<span class="cp">#define NCR5380_write(reg, value) ( outb((value),PAS16_io_port(reg)) )</span>
<span class="cp">#else</span>
<span class="cp">#define NCR5380_read(reg)						\</span>
<span class="cp">    (((unsigned char) printk(&quot;scsi%d : read register %d at io_port %04x\n&quot;\</span>
<span class="cp">    , instance-&gt;hostno, (reg), PAS16_io_port(reg))), inb( PAS16_io_port(reg)) )</span>

<span class="cp">#define NCR5380_write(reg, value) 					\</span>
<span class="cp">    (printk(&quot;scsi%d : write %02x to register %d at io_port %04x\n&quot;, 	\</span>
<span class="cp">	    instance-&gt;hostno, (value), (reg), PAS16_io_port(reg)),	\</span>
<span class="cp">    outb( (value),PAS16_io_port(reg) ) )</span>

<span class="cp">#endif</span>


<span class="cp">#define NCR5380_intr pas16_intr</span>
<span class="cp">#define do_NCR5380_intr do_pas16_intr</span>
<span class="cp">#define NCR5380_queue_command pas16_queue_command</span>
<span class="cp">#define NCR5380_abort pas16_abort</span>
<span class="cp">#define NCR5380_bus_reset pas16_bus_reset</span>
<span class="cp">#define NCR5380_proc_info pas16_proc_info</span>

<span class="cm">/* 15 14 12 10 7 5 3 </span>
<span class="cm">   1101 0100 1010 1000 */</span>
   
<span class="cp">#define PAS16_IRQS 0xd4a8 </span>

<span class="cp">#endif </span><span class="cm">/* else def HOSTS_C */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* ndef ASM */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* PAS16_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
