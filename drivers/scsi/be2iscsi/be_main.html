<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › be2iscsi › be_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>be_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Copyright (C) 2005 - 2011 Emulex</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation.  The full GNU General</span>
<span class="cm"> * Public License is included in this distribution in the file called COPYING.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by: Jayamohan Kallickal (jayamohan.kallickal@emulex.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * linux-drivers@emulex.com</span>
<span class="cm"> *</span>
<span class="cm"> * Emulex</span>
<span class="cm"> * 3333 Susan Street</span>
<span class="cm"> * Costa Mesa, CA 92626</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/iscsi_boot_sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bsg-lib.h&gt;</span>

<span class="cp">#include &lt;scsi/libiscsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_bsg_iscsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_netlink.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_iscsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &quot;be_main.h&quot;</span>
<span class="cp">#include &quot;be_iscsi.h&quot;</span>
<span class="cp">#include &quot;be_mgmt.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">be_iopoll_budget</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">be_max_phys_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable_msix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gcrashmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_hba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">beiscsi_pci_id_table</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESC</span> <span class="s">&quot; &quot;</span> <span class="n">BUILD_STR</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">BUILD_STR</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Emulex Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">be_iopoll_budget</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable_msix</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">be_max_phys_size</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">be_max_phys_size</span><span class="p">,</span> <span class="s">&quot;Maximum Size (In Kilobytes) of physically&quot;</span>
				   <span class="s">&quot;contiguous memory that can be allocated.&quot;</span>
				   <span class="s">&quot;Range is 16 - 128&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_queue_max_segment_size</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">aborted_task</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="p">)</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">aborted_io_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">invalidate_command_table</span> <span class="o">*</span><span class="n">inv_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">nonemb_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">num_invalidate</span><span class="p">;</span>

	<span class="n">cls_session</span> <span class="o">=</span> <span class="n">starget_to_session</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aborted_task</span> <span class="o">||</span> <span class="o">!</span><span class="n">aborted_task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we raced */</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aborted_io_task</span> <span class="o">=</span> <span class="n">aborted_task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aborted_io_task</span><span class="o">-&gt;</span><span class="n">scsi_cmnd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* raced or invalid command */</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">aborted_task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="cm">/* invalidate iocb */</span>
	<span class="n">cid</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span><span class="p">;</span>
	<span class="n">inv_tbl</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">inv_tbl</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">inv_tbl</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inv_tbl</span><span class="p">));</span>
	<span class="n">inv_tbl</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
	<span class="n">inv_tbl</span><span class="o">-&gt;</span><span class="n">icd</span> <span class="o">=</span> <span class="n">aborted_io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="o">-&gt;</span><span class="n">sgl_index</span><span class="p">;</span>
	<span class="n">num_invalidate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">invalidate_commands_params_in</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;Failed to allocate memory for&quot;</span>
			 <span class="s">&quot;mgmt_invalidate_icds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">invalidate_commands_params_in</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">mgmt_invalidate_icds</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">inv_tbl</span><span class="p">,</span> <span class="n">num_invalidate</span><span class="p">,</span>
				   <span class="n">cid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;mgmt_invalidate_icds could not be&quot;</span>
			     <span class="s">&quot; submitted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
					 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">iscsi_eh_abort</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_eh_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">abrt_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">abrt_io_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">invalidate_command_table</span> <span class="o">*</span><span class="n">inv_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">nonemb_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_invalidate</span><span class="p">;</span>

	<span class="cm">/* invalidate iocbs */</span>
	<span class="n">cls_session</span> <span class="o">=</span> <span class="n">starget_to_session</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
	<span class="n">session</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">leadconn</span> <span class="o">||</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ISCSI_STATE_LOGGED_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">leadconn</span><span class="p">;</span>
	<span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">cid</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span><span class="p">;</span>
	<span class="n">inv_tbl</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">inv_tbl</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">inv_tbl</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inv_tbl</span><span class="p">)</span> <span class="o">*</span> <span class="n">BE2_CMDS_PER_CXN</span><span class="p">);</span>
	<span class="n">num_invalidate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">cmds_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">abrt_task</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">abrt_io_task</span> <span class="o">=</span> <span class="n">abrt_task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">abrt_task</span><span class="o">-&gt;</span><span class="n">sc</span> <span class="o">||</span> <span class="n">abrt_task</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISCSI_TASK_FREE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">abrt_task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">!=</span> <span class="n">abrt_task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">inv_tbl</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
		<span class="n">inv_tbl</span><span class="o">-&gt;</span><span class="n">icd</span> <span class="o">=</span> <span class="n">abrt_io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="o">-&gt;</span><span class="n">sgl_index</span><span class="p">;</span>
		<span class="n">num_invalidate</span><span class="o">++</span><span class="p">;</span>
		<span class="n">inv_tbl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">inv_tbl</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">inv_tbl</span><span class="p">;</span>

	<span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">invalidate_commands_params_in</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;Failed to allocate memory for&quot;</span>
			 <span class="s">&quot;mgmt_invalidate_icds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">invalidate_commands_params_in</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">mgmt_invalidate_icds</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">inv_tbl</span><span class="p">,</span> <span class="n">num_invalidate</span><span class="p">,</span>
				   <span class="n">cid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;mgmt_invalidate_icds could not be&quot;</span>
			     <span class="s">&quot; submitted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
					 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">iscsi_eh_device_reset</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">beiscsi_show_boot_tgt_info</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_session_info</span> <span class="o">*</span><span class="n">boot_sess</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mgmt_conn_info</span> <span class="o">*</span><span class="n">boot_conn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">boot_sess</span><span class="o">-&gt;</span><span class="n">conn_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">boot_sess</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">),</span>
			    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_sess</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_IP_ADDR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_ipaddr</span><span class="p">.</span><span class="n">ip_type</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_ipaddr</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_ipaddr</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_PORT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_CHAP_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span>  <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">negotiated_login_options</span><span class="p">.</span><span class="n">auth_data</span><span class="p">.</span><span class="n">chap</span><span class="p">.</span>
			     <span class="n">target_chap_name_length</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">negotiated_login_options</span><span class="p">.</span>
			     <span class="n">auth_data</span><span class="p">.</span><span class="n">chap</span><span class="p">.</span><span class="n">target_chap_name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_CHAP_SECRET</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span>  <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">negotiated_login_options</span><span class="p">.</span><span class="n">auth_data</span><span class="p">.</span><span class="n">chap</span><span class="p">.</span>
			     <span class="n">target_secret_length</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">negotiated_login_options</span><span class="p">.</span>
			     <span class="n">auth_data</span><span class="p">.</span><span class="n">chap</span><span class="p">.</span><span class="n">target_secret</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_REV_CHAP_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span>  <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">negotiated_login_options</span><span class="p">.</span><span class="n">auth_data</span><span class="p">.</span><span class="n">chap</span><span class="p">.</span>
			     <span class="n">intr_chap_name_length</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">negotiated_login_options</span><span class="p">.</span>
			     <span class="n">auth_data</span><span class="p">.</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_chap_name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_REV_CHAP_SECRET</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span>  <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">negotiated_login_options</span><span class="p">.</span><span class="n">auth_data</span><span class="p">.</span><span class="n">chap</span><span class="p">.</span>
			     <span class="n">intr_secret_length</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">negotiated_login_options</span><span class="p">.</span>
			     <span class="n">auth_data</span><span class="p">.</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_secret</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_FLAGS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_NIC_ASSOC</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">beiscsi_show_boot_ini_info</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_INI_INITIATOR_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_sess</span><span class="p">.</span><span class="n">initiator_iscsiname</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">beiscsi_show_boot_eth_info</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_FLAGS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_INDEX</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_MAC</span>:
		<span class="n">rc</span>  <span class="o">=</span> <span class="n">beiscsi_get_macaddr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">phba</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">beiscsi_tgt_get_attr_visibility</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">umode_t</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_NAME</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_IP_ADDR</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_PORT</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_CHAP_NAME</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_CHAP_SECRET</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_REV_CHAP_NAME</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_REV_CHAP_SECRET</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_NIC_ASSOC</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_FLAGS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">beiscsi_ini_get_attr_visibility</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">umode_t</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_INI_INITIATOR_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">beiscsi_eth_get_attr_visibility</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">umode_t</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_FLAGS</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_MAC</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_INDEX</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------- PCI Driver operations and data ----------------- */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">beiscsi_pci_id_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">BE_VENDOR_ID</span><span class="p">,</span> <span class="n">BE_DEVICE_ID1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">BE_VENDOR_ID</span><span class="p">,</span> <span class="n">BE_DEVICE_ID2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">BE_VENDOR_ID</span><span class="p">,</span> <span class="n">OC_DEVICE_ID1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">BE_VENDOR_ID</span><span class="p">,</span> <span class="n">OC_DEVICE_ID2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">BE_VENDOR_ID</span><span class="p">,</span> <span class="n">OC_DEVICE_ID3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">beiscsi_pci_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">beiscsi_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Emulex 10Gbe open-iscsi Initiator Driver&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span> <span class="o">=</span> <span class="n">iscsi_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span> <span class="o">=</span> <span class="n">iscsi_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span> <span class="o">=</span> <span class="n">beiscsi_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span> <span class="o">=</span> <span class="n">iscsi_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span> <span class="o">=</span> <span class="n">beiscsi_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">beiscsi_eh_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_target_reset_handler</span> <span class="o">=</span> <span class="n">iscsi_eh_session_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">BEISCSI_SGLIST_ELEMENTS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">BE2_IO_DEPTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">BEISCSI_MAX_SECTORS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">BEISCSI_CMD_PER_LUN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">SCSI_NL_VID_TYPE_PCI</span> <span class="o">|</span> <span class="n">BE_VENDOR_ID</span><span class="p">,</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">beiscsi_scsi_transport</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="nf">beiscsi_hba_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">beiscsi_sht</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">phba</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;beiscsi_hba_alloc -&quot;</span>
			<span class="s">&quot;iscsi_host_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">dma_boundary</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">BE2_MAX_SESSIONS</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">BEISCSI_MAX_CMD_LEN</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">BEISCSI_NUM_MAX_LUN</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">beiscsi_scsi_transport</span><span class="p">;</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">phba</span><span class="p">));</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span> <span class="o">=</span> <span class="n">shost</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pci_dev_get</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">phba</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">interface_handle</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_host_add</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_devices</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">phba</span><span class="p">;</span>

<span class="nl">free_devices:</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">iscsi_host_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_unmap_pci_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">csr_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">csr_va</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">csr_va</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pci_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pci_va</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pci_va</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_map_pci_bars</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pcicfg_reg</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			       <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">csr_va</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">csr_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">pci_map_err</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>  <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">BE_GEN2</span><span class="p">)</span>
		<span class="n">pcicfg_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pcicfg_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pcicfg_reg</span><span class="p">),</span>
			       <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pcicfg_reg</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">pci_map_err</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pcicfg</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pci_va</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pci_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">pcicfg_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">pci_map_err:</span>
	<span class="n">beiscsi_unmap_pci_function</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_enable_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;beiscsi_enable_pci - enable device &quot;</span>
			<span class="s">&quot;failed. Returning -ENODEV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not set PCI DMA Mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_ctrl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mbox_mem_alloc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem_alloced</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mbox_mem_align</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_map_pci_bars</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_mailbox</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
						  <span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">beiscsi_unmap_pci_function</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mbox_mem_align</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_mailbox</span><span class="p">);</span>
	<span class="n">mbox_mem_align</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mbox_mem_align</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">mbox_mem_alloc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_mem_align</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_mailbox</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_cq_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_get_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_icd_count</span>
				    <span class="o">-</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_count</span>
				    <span class="o">+</span> <span class="n">BE2_TMFS</span>
				    <span class="o">+</span> <span class="n">BE2_NOPOUT_REQ</span><span class="p">));</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_count</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">asyncpdus_per_ctrl</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">icds_per_ctrl</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_icd_count</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_sge_per_io</span> <span class="o">=</span> <span class="n">BE2_SGE</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">defpdu_hdr_sz</span> <span class="o">=</span> <span class="n">BE2_DEFPDU_HDR_SZ</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">defpdu_data_sz</span> <span class="o">=</span> <span class="n">BE2_DEFPDU_DATA_SZ</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">eq_timer</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_eq_entries</span> <span class="o">=</span>
	    <span class="p">(((</span><span class="n">BE2_CMDS_PER_CXN</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_count</span> <span class="o">*</span> <span class="mi">2</span>
				    <span class="o">+</span> <span class="n">BE2_TMFS</span><span class="p">)</span> <span class="o">/</span> <span class="mi">512</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_eq_entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_eq_entries</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
				<span class="o">?</span> <span class="mi">1024</span> <span class="o">:</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_eq_entries</span><span class="p">;</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;phba-&gt;params.num_eq_entries=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_eq_entries</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_cq_entries</span> <span class="o">=</span>
	    <span class="p">(((</span><span class="n">BE2_CMDS_PER_CXN</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>  <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_count</span> <span class="o">*</span> <span class="mi">2</span>
				    <span class="o">+</span> <span class="n">BE2_TMFS</span><span class="p">)</span> <span class="o">/</span> <span class="mi">512</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_ring_eq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clr_interrupt</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_processed</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rearm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="n">DB_EQ_RING_ID_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rearm</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_EQ_REARM_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clr_interrupt</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_EQ_CLR_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_EQ_EVNT_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">num_processed</span> <span class="o">&lt;&lt;</span> <span class="n">DB_EQ_NUM_POPPED_SHIFT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">+</span> <span class="n">DB_EQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * be_isr_mcc - The isr routine of the driver.</span>
<span class="cm"> * @irq: Not used</span>
<span class="cm"> * @dev_id: Pointer to host adapter structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">be_isr_mcc</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_entry</span> <span class="o">*</span><span class="n">eqe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mcc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_eq_processed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">pbe_eq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pbe_eq</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="n">phba</span> <span class="o">=</span>  <span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">mcc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eqe</span><span class="p">)</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;eqe is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">num_eq_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
				<span class="o">&amp;</span> <span class="n">EQE_VALID_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span>
		     <span class="n">resource_id</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span>
		     <span class="n">EQE_RESID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="n">mcc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_mcc_cq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">eqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
		<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
		<span class="n">num_eq_processed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_mcc_cq</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">work_cqs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_eq_processed</span><span class="p">)</span>
		<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>	<span class="n">num_eq_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * be_isr_msix - The isr routine of the driver.</span>
<span class="cm"> * @irq: Not used</span>
<span class="cm"> * @dev_id: Pointer to host adapter structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">be_isr_msix</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_entry</span> <span class="o">*</span><span class="n">eqe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_eq_processed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">pbe_eq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pbe_eq</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="n">cq</span> <span class="o">=</span> <span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eqe</span><span class="p">)</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;eqe is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">phba</span> <span class="o">=</span> <span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">num_eq_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_iopoll_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
					<span class="o">&amp;</span> <span class="n">EQE_VALID_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk_iopoll_sched_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">iopoll</span><span class="p">))</span>
				<span class="n">blk_iopoll_sched</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">iopoll</span><span class="p">);</span>

			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">eqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
			<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
			<span class="n">num_eq_processed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_eq_processed</span><span class="p">)</span>
			<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>	<span class="n">num_eq_processed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
						<span class="o">&amp;</span> <span class="n">EQE_VALID_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_cq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">eqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
			<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
			<span class="n">num_eq_processed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_cq</span><span class="p">)</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">work_cqs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_eq_processed</span><span class="p">)</span>
			<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_eq_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * be_isr - The isr routine of the driver.</span>
<span class="cm"> * @irq: Not used</span>
<span class="cm"> * @dev_id: Pointer to host adapter structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">be_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_entry</span> <span class="o">*</span><span class="n">eqe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mcc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_mcceq_processed</span><span class="p">,</span> <span class="n">num_ioeq_processed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">pbe_eq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isr</span><span class="p">;</span>

	<span class="n">phba</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">isr</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">+</span> <span class="n">CEV_ISR0_OFFSET</span> <span class="o">+</span>
		       <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">*</span> <span class="n">CEV_ISR_SIZE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_context</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">;</span>
	<span class="n">pbe_eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
	<span class="n">mcc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eqe</span><span class="p">)</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;eqe is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">num_ioeq_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">num_mcceq_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_iopoll_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
					<span class="o">&amp;</span> <span class="n">EQE_VALID_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span>
			     <span class="n">resource_id</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span>
			     <span class="n">EQE_RESID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="n">mcc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_mcc_cq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">num_mcceq_processed</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk_iopoll_sched_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">iopoll</span><span class="p">))</span>
					<span class="n">blk_iopoll_sched</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">iopoll</span><span class="p">);</span>
				<span class="n">num_ioeq_processed</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">eqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
			<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_ioeq_processed</span> <span class="o">||</span> <span class="n">num_mcceq_processed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_mcc_cq</span><span class="p">)</span>
				<span class="n">queue_work</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">work_cqs</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">num_mcceq_processed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">num_ioeq_processed</span><span class="p">))</span>
				<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">num_ioeq_processed</span> <span class="o">+</span>
					       <span class="n">num_mcceq_processed</span><span class="p">)</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">num_ioeq_processed</span> <span class="o">+</span>
						<span class="n">num_mcceq_processed</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_cq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
						<span class="o">&amp;</span> <span class="n">EQE_VALID_MASK</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span>
			     <span class="n">resource_id</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span>
			     <span class="n">EQE_RESID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_mcc_cq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_cq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">eqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
			<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
			<span class="n">num_ioeq_processed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_cq</span> <span class="o">||</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_mcc_cq</span><span class="p">)</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">work_cqs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_ioeq_processed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">num_ioeq_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_init_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">msix_vec</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_context</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">BEISCSI_MSI_NAME</span><span class="p">,</span>
						    <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">free_msix_irqs</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sprintf</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;beiscsi_%02x_%02x&quot;</span><span class="p">,</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">msix_vec</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">msix_vec</span><span class="p">,</span> <span class="n">be_isr_msix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					  <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
					     <span class="s">&quot;beiscsi_init_irqs-Failed to&quot;</span>
					     <span class="s">&quot;register msix for i = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">goto</span> <span class="n">free_msix_irqs</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">BEISCSI_MSI_NAME</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_msix_irqs</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;beiscsi_mcc_%02x&quot;</span><span class="p">,</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="n">msix_vec</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">msix_vec</span><span class="p">,</span> <span class="n">be_isr_mcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				  <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;beiscsi_init_irqs-&quot;</span>
				     <span class="s">&quot;Failed to register beiscsi_msix_mcc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">goto</span> <span class="n">free_msix_irqs</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">be_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="s">&quot;beiscsi&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;beiscsi_init_irqs-&quot;</span>
				     <span class="s">&quot;Failed to register irq</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">free_msix_irqs:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">msix_vec</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">msix_vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_ring_cq_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_processed</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rearm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">id</span> <span class="o">&amp;</span> <span class="n">DB_CQ_RING_ID_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rearm</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_CQ_REARM_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">num_processed</span> <span class="o">&lt;&lt;</span> <span class="n">DB_CQ_NUM_POPPED_SHIFT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">+</span> <span class="n">DB_CQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">beiscsi_process_async_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cid</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">pdu_base</span> <span class="o">*</span><span class="n">ppdu</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pdu_len</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="n">login_hdr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ppdu</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_base</span><span class="p">,</span> <span class="n">opcode</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span>
						<span class="n">PDUBASE_OPCODE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_NOOP_IN</span>:
		<span class="n">pbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_ASYNC_EVENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_REJECT</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pbuffer</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buf_len</span> <span class="o">==</span> <span class="mi">48</span><span class="p">));</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;In ISCSI_OP_REJECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_LOGIN_RSP</span>:
	<span class="k">case</span> <span class="n">ISCSI_OP_TEXT_RSP</span>:
		<span class="n">task</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">login_task</span><span class="p">;</span>
		<span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="n">login_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">ppdu</span><span class="p">;</span>
		<span class="n">login_hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">libiscsi_itt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;Unrecognized opcode 0x%x in async msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">ppdu</span><span class="o">-&gt;</span>
			     <span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_base</span><span class="p">,</span> <span class="n">opcode</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
						<span class="o">&amp;</span> <span class="n">PDUBASE_OPCODE_MASK</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">ppdu</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="nf">alloc_io_sgl_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="n">psgl_handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_avbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
			 <span class="s">&quot;In alloc_io_sgl_handle,io_sgl_alloc_index=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_alloc_index</span><span class="p">);</span>
		<span class="n">psgl_handle</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span>
						<span class="n">io_sgl_alloc_index</span><span class="p">];</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_alloc_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_avbl</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_alloc_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span>
						 <span class="n">ios_per_ctrl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_alloc_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_alloc_index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">psgl_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">psgl_handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">free_io_sgl_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="n">psgl_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In free_,io_sgl_free_index=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_free_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_free_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * this can happen if clean_task is called on a task that</span>
<span class="cm">		 * failed in xmit_task or alloc_pdu.</span>
<span class="cm">		 */</span>
		 <span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
			 <span class="s">&quot;Double Free in IO SGL io_sgl_free_index=%d,&quot;</span>
			 <span class="s">&quot;value there=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_free_index</span><span class="p">,</span>
			 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_free_index</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_free_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">psgl_handle</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_avbl</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_free_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_free_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_free_index</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * alloc_wrb_handle - To allocate a wrb handle</span>
<span class="cm"> * @phba: The hba pointer</span>
<span class="cm"> * @cid: The cid to use for allocation</span>
<span class="cm"> *</span>
<span class="cm"> * This happens under session_lock until submission to chip</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wrb_handle</span> <span class="o">*</span><span class="nf">alloc_wrb_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_wrb_context</span> <span class="o">*</span><span class="n">pwrb_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wrb_handle</span> <span class="o">*</span><span class="n">pwrb_handle</span><span class="p">,</span> <span class="o">*</span><span class="n">pwrb_handle_tmp</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pwrb_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[</span><span class="n">cid</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">wrb_handles_available</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pwrb_handle</span> <span class="o">=</span> <span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_base</span><span class="p">[</span>
					    <span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">alloc_index</span><span class="p">];</span>
		<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">wrb_handles_available</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">alloc_index</span> <span class="o">==</span>
						<span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">alloc_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">alloc_index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pwrb_handle_tmp</span> <span class="o">=</span> <span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_base</span><span class="p">[</span>
						<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">alloc_index</span><span class="p">];</span>
		<span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">nxt_wrb_index</span> <span class="o">=</span> <span class="n">pwrb_handle_tmp</span><span class="o">-&gt;</span><span class="n">wrb_index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pwrb_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pwrb_handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * free_wrb_handle - To free the wrb handle back to pool</span>
<span class="cm"> * @phba: The hba pointer</span>
<span class="cm"> * @pwrb_context: The context to free from</span>
<span class="cm"> * @pwrb_handle: The wrb_handle to free</span>
<span class="cm"> *</span>
<span class="cm"> * This happens under session_lock until submission to chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">free_wrb_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwi_wrb_context</span> <span class="o">*</span><span class="n">pwrb_context</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">wrb_handle</span> <span class="o">*</span><span class="n">pwrb_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_base</span><span class="p">[</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">free_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwrb_handle</span><span class="p">;</span>
	<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">wrb_handles_available</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">free_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">free_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">free_index</span><span class="o">++</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
		 <span class="s">&quot;FREE WRB: pwrb_handle=%p free_index=0x%x&quot;</span>
		 <span class="s">&quot;wrb_handles_available=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pwrb_handle</span><span class="p">,</span> <span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">free_index</span><span class="p">,</span>
		 <span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">wrb_handles_available</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="nf">alloc_mgmt_sgl_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="n">psgl_handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_avbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psgl_handle</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_alloc_index</span><span class="p">];</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_alloc_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;mgmt_sgl_alloc_index=%d=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_alloc_index</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_alloc_index</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_avbl</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_alloc_index</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">icds_per_ctrl</span> <span class="o">-</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span> <span class="o">-</span>
		     <span class="mi">1</span><span class="p">))</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_alloc_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_alloc_index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">psgl_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">psgl_handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">free_mgmt_sgl_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="n">psgl_handle</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In  free_mgmt_sgl_handle,eh_sgl_free_index=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_free_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_free_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * this can happen if clean_task is called on a task that</span>
<span class="cm">		 * failed in xmit_task or alloc_pdu.</span>
<span class="cm">		 */</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
			 <span class="s">&quot;Double Free in eh SGL ,eh_sgl_free_index=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_free_index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_free_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">psgl_handle</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_avbl</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_free_index</span> <span class="o">==</span>
	    <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">icds_per_ctrl</span> <span class="o">-</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_free_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_free_index</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">be_complete_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sol_cqe</span> <span class="o">*</span><span class="n">psol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_status_bhs</span> <span class="o">*</span><span class="n">sts_bhs</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">be_status_bhs</span> <span class="o">*</span><span class="p">)</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">resid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exp_cmdsn</span><span class="p">,</span> <span class="n">max_cmdsn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">psol</span><span class="o">-&gt;</span>
			<span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_exp_cmd_sn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
			<span class="o">&amp;</span> <span class="n">SOL_EXP_CMD_SN_MASK</span><span class="p">);</span>
	<span class="n">max_cmdsn</span> <span class="o">=</span> <span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span>
			<span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_exp_cmd_sn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
			<span class="o">&amp;</span> <span class="n">SOL_EXP_CMD_SN_MASK</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_cmd_wnd</span><span class="p">)</span>
				<span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_CMD_WND_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_resp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
						<span class="o">&amp;</span> <span class="n">SOL_RESP_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_sts</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
						<span class="o">&amp;</span> <span class="n">SOL_STS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_flags</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
					<span class="o">&amp;</span> <span class="n">SOL_FLAGS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">scsi_cmnd</span><span class="p">)</span>
			<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">scsi_cmnd</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span> <span class="o">!=</span> <span class="n">ISCSI_STATUS_CMD_COMPLETED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* bidi not initially supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISCSI_FLAG_CMD_UNDERFLOW</span> <span class="o">|</span> <span class="n">ISCSI_FLAG_CMD_OVERFLOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">resid</span> <span class="o">=</span> <span class="p">(</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_res_cnt</span><span class="p">)</span> <span class="o">/</span>
				<span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_RES_CNT_MASK</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FLAG_CMD_OVERFLOW</span><span class="p">))</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FLAG_CMD_UNDERFLOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">)</span> <span class="o">-</span> <span class="n">resid</span> <span class="o">&lt;</span>
			    <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">))</span>
				<span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">sense_len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">slen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">sts_bhs</span><span class="o">-&gt;</span><span class="n">sense_info</span><span class="p">;</span>

		<span class="n">sense</span> <span class="o">=</span> <span class="n">sts_bhs</span><span class="o">-&gt;</span><span class="n">sense_info</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>
		<span class="n">sense_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">slen</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span>
		       <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FLAG_CMD_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_res_cnt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
							<span class="o">&amp;</span> <span class="n">SOL_RES_CNT_MASK</span><span class="p">)</span>
			 <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span> <span class="o">+=</span> <span class="p">(</span><span class="n">psol</span><span class="o">-&gt;</span>
			     <span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_res_cnt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
			     <span class="o">&amp;</span> <span class="n">SOL_RES_CNT_MASK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">unmap:</span>
	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">scsi_cmnd</span><span class="p">);</span>
	<span class="n">iscsi_complete_scsi_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">exp_cmdsn</span><span class="p">,</span> <span class="n">max_cmdsn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">be_complete_logout</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sol_cqe</span> <span class="o">*</span><span class="n">psol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_logout_rsp</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_logout_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">ISCSI_OP_LOGOUT_RSP</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">t2wait</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">t2retain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_flags</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
					<span class="o">&amp;</span> <span class="n">SOL_FLAGS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_resp</span><span class="p">)</span> <span class="o">/</span>
					<span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_RESP_MASK</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">psol</span><span class="o">-&gt;</span>
			<span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_exp_cmd_sn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
					<span class="o">&amp;</span> <span class="n">SOL_EXP_CMD_SN_MASK</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span>
			 <span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_exp_cmd_sn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
					<span class="o">&amp;</span> <span class="n">SOL_EXP_CMD_SN_MASK</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_cmd_wnd</span><span class="p">)</span>
					<span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_CMD_WND_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dlength</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">libiscsi_itt</span><span class="p">;</span>
	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">be_complete_tmf</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sol_cqe</span> <span class="o">*</span><span class="n">psol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_tm_rsp</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_tm_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">ISCSI_OP_SCSI_TMFUNC_RSP</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_flags</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
					<span class="o">&amp;</span> <span class="n">SOL_FLAGS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_resp</span><span class="p">)</span> <span class="o">/</span>
					<span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_RESP_MASK</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span>
				    <span class="n">i_exp_cmd_sn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_EXP_CMD_SN_MASK</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span>
			<span class="n">i_exp_cmd_sn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_EXP_CMD_SN_MASK</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_cmd_wnd</span><span class="p">)</span>
			<span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_CMD_WND_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">libiscsi_itt</span><span class="p">;</span>
	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hwi_complete_drvr_msgs</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sol_cqe</span> <span class="o">*</span><span class="n">psol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_wrb_context</span> <span class="o">*</span><span class="n">pwrb_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wrb_handle</span> <span class="o">*</span><span class="n">pwrb_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pwrb_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[((</span><span class="n">psol</span><span class="o">-&gt;</span>
				<span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="n">SOL_CID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">];</span>
	<span class="n">pwrb_handle</span> <span class="o">=</span> <span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_basestd</span><span class="p">[((</span><span class="n">psol</span><span class="o">-&gt;</span>
				<span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">wrb_index</span><span class="p">)</span> <span class="o">/</span>
				<span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_WRB_INDEX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)];</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">pio_handle</span><span class="p">;</span>

	<span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
	<span class="n">free_mgmt_sgl_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">free_wrb_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pwrb_context</span><span class="p">,</span> <span class="n">pwrb_handle</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">be_complete_nopin_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sol_cqe</span> <span class="o">*</span><span class="n">psol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_nopin</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_nopin</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_flags</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
			<span class="o">&amp;</span> <span class="n">SOL_FLAGS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">exp_cmdsn</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span>
				     <span class="n">i_exp_cmd_sn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_EXP_CMD_SN_MASK</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">max_cmdsn</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span>
			<span class="n">i_exp_cmd_sn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_EXP_CMD_SN_MASK</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">i_cmd_wnd</span><span class="p">)</span>
			<span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_CMD_WND_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">ISCSI_OP_NOOP_IN</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">libiscsi_itt</span><span class="p">;</span>
	<span class="n">__iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_complete_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sol_cqe</span> <span class="o">*</span><span class="n">psol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_wrb_context</span> <span class="o">*</span><span class="n">pwrb_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wrb_handle</span> <span class="o">*</span><span class="n">pwrb_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_wrb</span> <span class="o">*</span><span class="n">pwrb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pwrb_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
				<span class="o">&amp;</span> <span class="n">SOL_CID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">];</span>
	<span class="n">pwrb_handle</span> <span class="o">=</span> <span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_basestd</span><span class="p">[((</span><span class="n">psol</span><span class="o">-&gt;</span>
				<span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">wrb_index</span><span class="p">)</span> <span class="o">/</span>
				<span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_WRB_INDEX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)];</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">pio_handle</span><span class="p">;</span>
	<span class="n">pwrb</span> <span class="o">=</span> <span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">pwrb</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">pwrb</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span>
				 <span class="n">WRB_TYPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWH_TYPE_IO</span>:
	<span class="k">case</span> <span class="n">HWH_TYPE_IO_RD</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">ISCSI_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">ISCSI_OP_NOOP_OUT</span><span class="p">)</span>
			<span class="n">be_complete_nopin_resp</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">psol</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">be_complete_io</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">psol</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HWH_TYPE_LOGOUT</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">ISCSI_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISCSI_OP_LOGOUT</span><span class="p">)</span>
			<span class="n">be_complete_logout</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">psol</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">be_complete_tmf</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">psol</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HWH_TYPE_LOGIN</span>:
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s"> No HWH_TYPE_LOGIN Expected in hwi_complete_cmd&quot;</span>
			 <span class="s">&quot;- Solicited path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HWH_TYPE_NOP</span>:
		<span class="n">be_complete_nopin_resp</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">psol</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				<span class="s">&quot;In hwi_complete_cmd, unknown type = %d&quot;</span>
				<span class="s">&quot;wrb_index 0x%x CID 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
				<span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span>
				<span class="n">type</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_WRB_INDEX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span>
				<span class="p">((</span><span class="n">psol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span>
				<span class="n">cid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_CID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="nf">hwi_get_async_busy_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwi_async_pdu_context</span>
					  <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_header</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">host_write_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_header</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">host_write_ptr</span><span class="p">].</span>
		    <span class="n">header_busy_list</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">host_write_ptr</span><span class="p">].</span><span class="n">data_busy_list</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span>
<span class="nf">hwi_get_async_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">i_t_dpdu_cqe</span> <span class="o">*</span><span class="n">pdpdu_cqe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pcq_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_bus_address</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pbusy_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="n">pasync_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">is_header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phys_addr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_lo</span> <span class="o">=</span>
	    <span class="n">pdpdu_cqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_i_t_dpdu_cqe</span><span class="p">,</span> <span class="n">db_addr_lo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">-</span>
	    <span class="p">((</span><span class="n">pdpdu_cqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_i_t_dpdu_cqe</span><span class="p">,</span> <span class="n">dpl</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
						<span class="o">&amp;</span> <span class="n">PDUCQE_DPL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">phys_addr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_hi</span> <span class="o">=</span>
	    <span class="n">pdpdu_cqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_i_t_dpdu_cqe</span><span class="p">,</span> <span class="n">db_addr_hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">];</span>

	<span class="n">phys_addr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>
			<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">phys_addr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdpdu_cqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_i_t_dpdu_cqe</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
			<span class="o">&amp;</span> <span class="n">PDUCQE_CODE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UNSOL_HDR_NOTIFY</span>:
		<span class="n">is_header</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">pbusy_list</span> <span class="o">=</span> <span class="n">hwi_get_async_busy_list</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">pdpdu_cqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_i_t_dpdu_cqe</span><span class="p">,</span>
			<span class="n">index</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PDUCQE_INDEX_MASK</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UNSOL_DATA_NOTIFY</span>:
		<span class="n">pbusy_list</span> <span class="o">=</span> <span class="n">hwi_get_async_busy_list</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">pdpdu_cqe</span><span class="o">-&gt;</span>
					<span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_i_t_dpdu_cqe</span><span class="p">,</span>
					<span class="n">index</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PDUCQE_INDEX_MASK</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pbusy_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			<span class="s">&quot;Unexpected code=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pdpdu_cqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_i_t_dpdu_cqe</span><span class="p">,</span>
					<span class="n">code</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PDUCQE_CODE_MASK</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pbusy_list</span><span class="p">));</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pasync_handle</span><span class="p">,</span> <span class="n">pbusy_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">==</span> <span class="n">phys_addr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pasync_handle</span><span class="p">);</span>

	<span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">cri</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">-</span>
					     <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">;</span>
	<span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">is_header</span> <span class="o">=</span> <span class="n">is_header</span><span class="p">;</span>
	<span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">buffer_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">pdpdu_cqe</span><span class="o">-&gt;</span>
			<span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_i_t_dpdu_cqe</span><span class="p">,</span> <span class="n">dpl</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
			<span class="o">&amp;</span> <span class="n">PDUCQE_DPL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pcq_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdpdu_cqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_i_t_dpdu_cqe</span><span class="p">,</span>
			<span class="n">index</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PDUCQE_INDEX_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pasync_handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">hwi_update_async_writables</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_header</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cq_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pbusy_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="n">pasync_handle</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_entries</span><span class="p">,</span> <span class="n">writables</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pep_read_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">pwritables</span><span class="p">;</span>

	<span class="n">num_entries</span> <span class="o">=</span> <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_header</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pep_read_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">ep_read_ptr</span><span class="p">;</span>
		<span class="n">pwritables</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">writables</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pep_read_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">ep_read_ptr</span><span class="p">;</span>
		<span class="n">pwritables</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">writables</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">pep_read_ptr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cq_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pep_read_ptr</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pep_read_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pep_read_ptr</span><span class="p">)</span> <span class="o">%</span> <span class="n">num_entries</span><span class="p">;</span>

		<span class="n">pbusy_list</span> <span class="o">=</span> <span class="n">hwi_get_async_busy_list</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="p">,</span> <span class="n">is_header</span><span class="p">,</span>
						     <span class="o">*</span><span class="n">pep_read_ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">writables</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pbusy_list</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pbusy_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pasync_handle</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pbusy_list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">async_pdu_handle</span><span class="p">,</span>
						   <span class="n">link</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pasync_handle</span><span class="p">);</span>
			<span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">writables</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">writables</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;Duplicate notification received - index 0x%x!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">cq_index</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pwritables</span> <span class="o">=</span> <span class="o">*</span><span class="n">pwritables</span> <span class="o">+</span> <span class="n">writables</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_free_async_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="n">pasync_handle</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pasync_ctx</span> <span class="o">=</span> <span class="n">HWI_GET_ASYNC_PDU_CTX</span><span class="p">(</span><span class="n">phwi_ctrlr</span><span class="p">);</span>

	<span class="n">plist</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pasync_handle</span><span class="p">,</span> <span class="n">tmp_handle</span><span class="p">,</span> <span class="n">plist</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">is_header</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">free_list</span><span class="p">);</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">free_entries</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">free_list</span><span class="p">);</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">free_entries</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">hdr_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">bytes_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">phys_addr</span> <span class="o">*</span>
<span class="nf">hwi_get_ring_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_header</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">host_write_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">phys_addr</span> <span class="o">*</span><span class="n">pasync_sge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_header</span><span class="p">)</span>
		<span class="n">pasync_sge</span> <span class="o">=</span> <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">ring_base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pasync_sge</span> <span class="o">=</span> <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">ring_base</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pasync_sge</span> <span class="o">+</span> <span class="n">host_write_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_post_async_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="n">pasync_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pfree_link</span><span class="p">,</span> <span class="o">*</span><span class="n">pbusy_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phys_addr</span> <span class="o">*</span><span class="n">pasync_sge</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ring_id</span><span class="p">,</span> <span class="n">num_entries</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">host_write_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">writables</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doorbell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pasync_ctx</span> <span class="o">=</span> <span class="n">HWI_GET_ASYNC_PDU_CTX</span><span class="p">(</span><span class="n">phwi_ctrlr</span><span class="p">);</span>
	<span class="n">num_entries</span> <span class="o">=</span> <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_header</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writables</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">writables</span><span class="p">,</span>
				<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">free_entries</span><span class="p">);</span>
		<span class="n">pfree_link</span> <span class="o">=</span> <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">host_write_num</span> <span class="o">=</span> <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">host_write_ptr</span><span class="p">;</span>
		<span class="n">ring_id</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">default_pdu_hdr</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writables</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">writables</span><span class="p">,</span>
				<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">free_entries</span><span class="p">);</span>
		<span class="n">pfree_link</span> <span class="o">=</span> <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">host_write_num</span> <span class="o">=</span> <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">host_write_ptr</span><span class="p">;</span>
		<span class="n">ring_id</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">default_pdu_data</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writables</span> <span class="o">=</span> <span class="p">(</span><span class="n">writables</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">writables</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">writables</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pbusy_list</span> <span class="o">=</span>
			    <span class="n">hwi_get_async_busy_list</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="p">,</span> <span class="n">is_header</span><span class="p">,</span>
						    <span class="n">host_write_num</span><span class="p">);</span>
			<span class="n">pasync_handle</span> <span class="o">=</span>
			    <span class="n">list_entry</span><span class="p">(</span><span class="n">pfree_link</span><span class="p">,</span> <span class="k">struct</span> <span class="n">async_pdu_handle</span><span class="p">,</span>
								<span class="n">link</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pasync_handle</span><span class="p">);</span>
			<span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">pfree_link</span> <span class="o">=</span> <span class="n">pfree_link</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

			<span class="n">pasync_sge</span> <span class="o">=</span> <span class="n">hwi_get_ring_address</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="p">,</span>
						<span class="n">is_header</span><span class="p">,</span> <span class="n">host_write_num</span><span class="p">);</span>

			<span class="n">pasync_sge</span><span class="o">-&gt;</span><span class="n">hi</span> <span class="o">=</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_lo</span><span class="p">;</span>
			<span class="n">pasync_sge</span><span class="o">-&gt;</span><span class="n">lo</span> <span class="o">=</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_hi</span><span class="p">;</span>

			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">pbusy_list</span><span class="p">);</span>

			<span class="n">host_write_num</span><span class="o">++</span><span class="p">;</span>
			<span class="n">host_write_num</span> <span class="o">=</span> <span class="n">host_write_num</span> <span class="o">%</span> <span class="n">num_entries</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_header</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">host_write_ptr</span> <span class="o">=</span>
							<span class="n">host_write_num</span><span class="p">;</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">free_entries</span> <span class="o">-=</span> <span class="n">writables</span><span class="p">;</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">writables</span> <span class="o">-=</span> <span class="n">writables</span><span class="p">;</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">busy_entries</span> <span class="o">+=</span> <span class="n">writables</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">host_write_ptr</span> <span class="o">=</span> <span class="n">host_write_num</span><span class="p">;</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">free_entries</span> <span class="o">-=</span> <span class="n">writables</span><span class="p">;</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">writables</span> <span class="o">-=</span> <span class="n">writables</span><span class="p">;</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">busy_entries</span> <span class="o">+=</span> <span class="n">writables</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">doorbell</span> <span class="o">|=</span> <span class="n">ring_id</span> <span class="o">&amp;</span> <span class="n">DB_DEF_PDU_RING_ID_MASK</span><span class="p">;</span>
		<span class="n">doorbell</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_DEF_PDU_REARM_SHIFT</span><span class="p">;</span>
		<span class="n">doorbell</span> <span class="o">|=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">DB_DEF_PDU_EVENT_SHIFT</span><span class="p">;</span>
		<span class="n">doorbell</span> <span class="o">|=</span> <span class="p">(</span><span class="n">writables</span> <span class="o">&amp;</span> <span class="n">DB_DEF_PDU_CQPROC_MASK</span><span class="p">)</span>
					<span class="o">&lt;&lt;</span> <span class="n">DB_DEF_PDU_CQPROC_SHIFT</span><span class="p">;</span>

		<span class="n">iowrite32</span><span class="p">(</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">+</span> <span class="n">DB_RXULP0_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_flush_default_pdu_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">i_t_dpdu_cqe</span> <span class="o">*</span><span class="n">pdpdu_cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="n">pasync_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cq_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pasync_ctx</span> <span class="o">=</span> <span class="n">HWI_GET_ASYNC_PDU_CTX</span><span class="p">(</span><span class="n">phwi_ctrlr</span><span class="p">);</span>

	<span class="n">pasync_handle</span> <span class="o">=</span> <span class="n">hwi_get_async_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">pasync_ctx</span><span class="p">,</span>
					     <span class="n">pdpdu_cqe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq_index</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">is_header</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hwi_update_async_writables</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="p">,</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">is_header</span><span class="p">,</span>
					   <span class="n">cq_index</span><span class="p">);</span>

	<span class="n">hwi_free_async_msg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">cri</span><span class="p">);</span>
	<span class="n">hwi_post_async_buffers</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">is_header</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">hwi_fwd_async_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="n">pasync_handle</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">phdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pfirst_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">plist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">list</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pasync_handle</span><span class="p">,</span> <span class="n">plist</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phdr</span> <span class="o">=</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">;</span>
			<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">buffer_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf_len</span> <span class="o">=</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">buffer_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfirst_buffer</span> <span class="o">=</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">;</span>
				<span class="n">num_buf</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pfirst_buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			       <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">buf_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_process_async_pdu</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">-</span>
					    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">),</span>
					    <span class="n">phdr</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">pfirst_buffer</span><span class="p">,</span>
					    <span class="n">offset</span><span class="p">);</span>

	<span class="n">hwi_free_async_msg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cri</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">hwi_gather_async_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="n">pasync_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cri</span> <span class="o">=</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">cri</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pdu_base</span> <span class="o">*</span><span class="n">ppdu</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pasync_ctx</span> <span class="o">=</span> <span class="n">HWI_GET_ASYNC_PDU_CTX</span><span class="p">(</span><span class="n">phwi_ctrlr</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">is_header</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">busy_entries</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">hdr_received</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hwi_free_async_msg</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cri</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">bytes_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">hdr_received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">hdr_len</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">buffer_len</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>

		<span class="n">ppdu</span> <span class="o">=</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">pbuffer</span><span class="p">;</span>
		<span class="n">bytes_needed</span> <span class="o">=</span> <span class="p">((((</span><span class="n">ppdu</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_base</span><span class="p">,</span>
			<span class="n">data_len_hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PDUBASE_DATALENHI_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">be16_to_cpu</span><span class="p">((</span><span class="n">ppdu</span><span class="o">-&gt;</span>
			<span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_base</span><span class="p">,</span> <span class="n">data_len_lo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
			<span class="o">&amp;</span> <span class="n">PDUBASE_DATALENLO_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">bytes_needed</span> <span class="o">=</span>
			    <span class="n">bytes_needed</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bytes_needed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">hwi_fwd_async_msg</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span>
							   <span class="n">pasync_ctx</span><span class="p">,</span> <span class="n">cri</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">busy_entries</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">hdr_received</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span>
				      <span class="n">list</span><span class="p">);</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span>
				<span class="n">bytes_received</span> <span class="o">+=</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">buffer_len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span>
			    <span class="n">bytes_received</span> <span class="o">&gt;=</span>
			    <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">cri</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span>
			    <span class="n">bytes_needed</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">hwi_fwd_async_msg</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span>
							   <span class="n">pasync_ctx</span><span class="p">,</span> <span class="n">cri</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_process_default_pdu_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">i_t_dpdu_cqe</span> <span class="o">*</span><span class="n">pdpdu_cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="n">pasync_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cq_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pasync_ctx</span> <span class="o">=</span> <span class="n">HWI_GET_ASYNC_PDU_CTX</span><span class="p">(</span><span class="n">phwi_ctrlr</span><span class="p">);</span>
	<span class="n">pasync_handle</span> <span class="o">=</span> <span class="n">hwi_get_async_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">pasync_ctx</span><span class="p">,</span>
					     <span class="n">pdpdu_cqe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hwi_update_async_writables</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="p">,</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">is_header</span><span class="p">,</span>
					   <span class="n">cq_index</span><span class="p">);</span>
	<span class="n">hwi_gather_async_pdu</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="n">pasync_handle</span><span class="p">);</span>
	<span class="n">hwi_post_async_buffers</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pasync_handle</span><span class="o">-&gt;</span><span class="n">is_header</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="nf">beiscsi_process_mcc_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mcc_cq</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">mcc_compl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mcc_cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">mcc_compl</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">mcc_cq</span><span class="p">);</span>
	<span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CQE_FLAGS_VALID_MASK</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_processed</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hwi_ring_cq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mcc_cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					<span class="n">num_processed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">num_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CQE_FLAGS_ASYNC_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Interpret flags as an async trailer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_link_state_evt</span><span class="p">(</span><span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="cm">/* Interpret compl as a async link evt */</span>
				<span class="n">beiscsi_async_link_state_process</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">be_async_event_link_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">mcc_compl</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
					<span class="s">&quot; Unsupported Async Event, flags&quot;</span>
					<span class="s">&quot; = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CQE_FLAGS_COMPLETED_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">be_mcc_compl_process_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">mcc_compl</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">.</span><span class="n">used</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">mcc_cq</span><span class="p">);</span>
		<span class="n">mcc_compl</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">mcc_cq</span><span class="p">);</span>
		<span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mcc_compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">num_processed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_processed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hwi_ring_cq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">mcc_cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">num_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">beiscsi_process_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">pbe_eq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sol_cqe</span> <span class="o">*</span><span class="n">sol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmsg_cqe</span> <span class="o">*</span><span class="n">dmsg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tot_nump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>

	<span class="n">cq</span> <span class="o">=</span> <span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
	<span class="n">sol</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span>
	       <span class="n">CQE_VALID_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sol_cqe</span><span class="p">));</span>

		<span class="n">ep</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ep_array</span><span class="p">[(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">sol</span><span class="o">-&gt;</span>
				   <span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span>
				   <span class="n">SOL_CID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span>
				   <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">];</span>

		<span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_processed</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hwi_ring_cq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					<span class="n">num_processed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tot_nump</span> <span class="o">+=</span> <span class="n">num_processed</span><span class="p">;</span>
			<span class="n">num_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="o">/</span>
			<span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CQE_CODE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOL_CMD_COMPLETE</span>:
			<span class="n">hwi_complete_cmd</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="n">sol</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DRIVERMSG_NOTIFY</span>:
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;Received DRIVERMSG_NOTIFY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dmsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dmsg_cqe</span> <span class="o">*</span><span class="p">)</span><span class="n">sol</span><span class="p">;</span>
			<span class="n">hwi_complete_drvr_msgs</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="n">sol</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UNSOL_HDR_NOTIFY</span>:
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;Received UNSOL_HDR_ NOTIFY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hwi_process_default_pdu_ring</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span>
					     <span class="p">(</span><span class="k">struct</span> <span class="n">i_t_dpdu_cqe</span> <span class="o">*</span><span class="p">)</span><span class="n">sol</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UNSOL_DATA_NOTIFY</span>:
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;Received UNSOL_DATA_NOTIFY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hwi_process_default_pdu_ring</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span>
					     <span class="p">(</span><span class="k">struct</span> <span class="n">i_t_dpdu_cqe</span> <span class="o">*</span><span class="p">)</span><span class="n">sol</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CXN_INVALIDATE_INDEX_NOTIFY</span>:
		<span class="k">case</span> <span class="n">CMD_INVALIDATED_NOTIFY</span>:
		<span class="k">case</span> <span class="n">CXN_INVALIDATE_NOTIFY</span>:
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
				 <span class="s">&quot;Ignoring CQ Error notification for cmd/cxn&quot;</span>
				 <span class="s">&quot;invalidate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOL_CMD_KILLED_DATA_DIGEST_ERR</span>:
		<span class="k">case</span> <span class="n">CMD_KILLED_INVALID_STATSN_RCVD</span>:
		<span class="k">case</span> <span class="n">CMD_KILLED_INVALID_R2T_RCVD</span>:
		<span class="k">case</span> <span class="n">CMD_CXN_KILLED_LUN_INVALID</span>:
		<span class="k">case</span> <span class="n">CMD_CXN_KILLED_ICD_INVALID</span>:
		<span class="k">case</span> <span class="n">CMD_CXN_KILLED_ITT_INVALID</span>:
		<span class="k">case</span> <span class="n">CMD_CXN_KILLED_SEQ_OUTOFORDER</span>:
		<span class="k">case</span> <span class="n">CMD_CXN_KILLED_INVALID_DATASN_RCVD</span>:
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
				 <span class="s">&quot;CQ Error notification for cmd.. &quot;</span>
				 <span class="s">&quot;code %d cid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="o">/</span>
				 <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CQE_CODE_MASK</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span> <span class="o">/</span>
				 <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SOL_CID_MASK</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">UNSOL_DATA_DIGEST_ERROR_NOTIFY</span>:
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
				 <span class="s">&quot;Digest error on def pdu ring, dropping..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hwi_flush_default_pdu_buffer</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_conn</span><span class="p">,</span>
					     <span class="p">(</span><span class="k">struct</span> <span class="n">i_t_dpdu_cqe</span> <span class="o">*</span><span class="p">)</span> <span class="n">sol</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CXN_KILLED_PDU_SIZE_EXCEEDS_DSL</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_BURST_LEN_MISMATCH</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_AHS_RCVD</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_HDR_DIGEST_ERR</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_UNKNOWN_HDR</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_STALE_ITT_TTT_RCVD</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_INVALID_ITT_TTT_RCVD</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_TIMED_OUT</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_FIN_RCVD</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_BAD_UNSOL_PDU_RCVD</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_BAD_WRB_INDEX_ERROR</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_OVER_RUN_RESIDUAL</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_UNDER_RUN_RESIDUAL</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_CMND_DATA_NOT_ON_SAME_CONN</span>:
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;CQ Error %d, reset CID &quot;</span>
				 <span class="s">&quot;0x%x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="o">/</span>
				 <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CQE_CODE_MASK</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span> <span class="o">/</span>
				 <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CQE_CID_MASK</span><span class="p">));</span>
			<span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span>
					   <span class="n">ISCSI_ERR_CONN_FAILED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CXN_KILLED_RST_SENT</span>:
		<span class="k">case</span> <span class="n">CXN_KILLED_RST_RCVD</span>:
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;CQ Error %d, reset&quot;</span>
				<span class="s">&quot;received/sent on CID 0x%x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="o">/</span>
				 <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CQE_CODE_MASK</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span> <span class="o">/</span>
				 <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CQE_CID_MASK</span><span class="p">));</span>
			<span class="n">iscsi_conn_failure</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span>
					   <span class="n">ISCSI_ERR_CONN_FAILED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;CQ Error Invalid code= %d &quot;</span>
				 <span class="s">&quot;received on CID 0x%x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="o">/</span>
				 <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CQE_CODE_MASK</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span> <span class="o">/</span>
				 <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CQE_CID_MASK</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_sol_cqe</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
		<span class="n">sol</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">cq</span><span class="p">);</span>
		<span class="n">num_processed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_processed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tot_nump</span> <span class="o">+=</span> <span class="n">num_processed</span><span class="p">;</span>
		<span class="n">hwi_ring_cq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">num_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tot_nump</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">beiscsi_process_all_cqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">pbe_eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">beiscsi_hba</span><span class="p">,</span> <span class="n">work_cqs</span><span class="p">);</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_context</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="n">pbe_eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">pbe_eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_mcc_cq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_mcc_cq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">beiscsi_process_mcc_isr</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_cq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">todo_cq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">beiscsi_process_cq</span><span class="p">(</span><span class="n">pbe_eq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_iopoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_iopoll</span> <span class="o">*</span><span class="n">iop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">pbe_eq</span><span class="p">;</span>

	<span class="n">pbe_eq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">iop</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_eq_obj</span><span class="p">,</span> <span class="n">iopoll</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_process_cq</span><span class="p">(</span><span class="n">pbe_eq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span> <span class="o">=</span> <span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
		<span class="n">blk_iopoll_complete</span><span class="p">(</span><span class="n">iop</span><span class="p">);</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;rearm pbe_eq-&gt;q.id =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hwi_write_sgl</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span> <span class="o">*</span><span class="n">pwrb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_sg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_sge</span> <span class="o">*</span><span class="n">psgl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sge_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">l_sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">iscsi_bhs_addr_lo</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
				      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_lo</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">iscsi_bhs_addr_hi</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
				      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_hi</span><span class="p">);</span>

	<span class="n">l_sg</span> <span class="o">=</span> <span class="n">sg</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_sg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">index</span><span class="o">++</span><span class="p">,</span>
							 <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_addr_lo</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)));</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_addr_hi</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
							<span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)));</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_len</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
							<span class="n">sg_len</span><span class="p">);</span>
			<span class="n">sge_len</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge1_r2t_offset</span><span class="p">,</span>
							<span class="n">pwrb</span><span class="p">,</span> <span class="n">sge_len</span><span class="p">);</span>
			<span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge1_addr_lo</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)));</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge1_addr_hi</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
							<span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)));</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge1_len</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
							<span class="n">sg_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">psgl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_sge</span> <span class="o">*</span><span class="p">)</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="o">-&gt;</span><span class="n">pfrag</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">psgl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psgl</span><span class="p">)</span> <span class="o">*</span> <span class="n">BE2_SGE</span><span class="p">);</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span>
			<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_hi</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_lo</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span>
			<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_lo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_sg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_last</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
								<span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge1_last</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">num_sg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_last</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge1_last</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
								<span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_last</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge1_last</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">l_sg</span><span class="p">;</span>
	<span class="n">psgl</span><span class="o">++</span><span class="p">;</span>
	<span class="n">psgl</span><span class="o">++</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_sg</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">,</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">psgl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_lo</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span>
						<span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">));</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span>
						<span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">sge_offset</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">last_sge</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">sg_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">psgl</span><span class="o">--</span><span class="p">;</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">last_sge</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_write_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span> <span class="o">*</span><span class="n">pwrb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_sge</span> <span class="o">*</span><span class="n">psgl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_nonio_bhs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">iscsi_bhs_addr_lo</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
				<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_lo</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">iscsi_bhs_addr_hi</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
				<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_hi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						    <span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						    <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_addr_lo</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)));</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_addr_hi</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)));</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_len</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
						<span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">);</span>

		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sge0_last</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psgl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_sge</span> <span class="o">*</span><span class="p">)</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="o">-&gt;</span><span class="n">pfrag</span><span class="p">;</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_len</span><span class="p">);</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span>
		      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_hi</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_lo</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span>
		      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_lo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psgl</span><span class="o">++</span><span class="p">;</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_lo</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">sge_offset</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">rsvd0</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">last_sge</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">psgl</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_lo</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)));</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mh">0x106</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">last_sge</span><span class="p">,</span> <span class="n">psgl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_find_mem_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_cq_pages</span><span class="p">,</span> <span class="n">num_async_pdu_buf_pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_async_pdu_data_pages</span><span class="p">,</span> <span class="n">wrb_sz_per_cxn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_async_pdu_buf_sgl_pages</span><span class="p">,</span> <span class="n">num_async_pdu_data_sgl_pages</span><span class="p">;</span>

	<span class="n">num_cq_pages</span> <span class="o">=</span> <span class="n">PAGES_REQUIRED</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_cq_entries</span> <span class="o">*</span> \
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sol_cqe</span><span class="p">));</span>
	<span class="n">num_async_pdu_buf_pages</span> <span class="o">=</span>
			<span class="n">PAGES_REQUIRED</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">asyncpdus_per_ctrl</span> <span class="o">*</span> \
				       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">defpdu_hdr_sz</span><span class="p">);</span>
	<span class="n">num_async_pdu_buf_sgl_pages</span> <span class="o">=</span>
			<span class="n">PAGES_REQUIRED</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">asyncpdus_per_ctrl</span> <span class="o">*</span> \
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span><span class="p">));</span>
	<span class="n">num_async_pdu_data_pages</span> <span class="o">=</span>
			<span class="n">PAGES_REQUIRED</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">asyncpdus_per_ctrl</span> <span class="o">*</span> \
				       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">defpdu_data_sz</span><span class="p">);</span>
	<span class="n">num_async_pdu_data_sgl_pages</span> <span class="o">=</span>
			<span class="n">PAGES_REQUIRED</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">asyncpdus_per_ctrl</span> <span class="o">*</span> \
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span><span class="p">));</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hwi_ws_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwi_controller</span><span class="p">);</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">ISCSI_MEM_GLOBAL_HEADER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span>
						 <span class="n">BE_ISCSI_PDU_HEADER_SIZE</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_ADDN_CONTEXT</span><span class="p">]</span> <span class="o">=</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwi_context_memory</span><span class="p">);</span>


	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_WRB</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span><span class="p">)</span>
	    <span class="o">*</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">)</span>
	    <span class="o">*</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">;</span>
	<span class="n">wrb_sz_per_cxn</span> <span class="o">=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wrb_handle</span><span class="p">)</span> <span class="o">*</span>
				 <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_WRBH</span><span class="p">]</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">((</span><span class="n">wrb_sz_per_cxn</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">);</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_SGLH</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgl_handle</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">icds_per_ctrl</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_SGE</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_sge</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_sge_per_io</span> <span class="o">*</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">icds_per_ctrl</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_ASYNC_HEADER_BUF</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">num_async_pdu_buf_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_ASYNC_DATA_BUF</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">num_async_pdu_data_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_ASYNC_HEADER_RING</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">num_async_pdu_buf_sgl_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_ASYNC_DATA_RING</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">num_async_pdu_data_sgl_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_ASYNC_HEADER_HANDLE</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">asyncpdus_per_ctrl</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">async_pdu_handle</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_ASYNC_DATA_HANDLE</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">asyncpdus_per_ctrl</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">async_pdu_handle</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">HWI_MEM_ASYNC_PDU_CONTEXT</span><span class="p">]</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwi_async_pdu_context</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwi_async_entry</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_alloc_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_add</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_array</span> <span class="o">*</span><span class="n">mem_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_arr_orig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">alloc_size</span><span class="p">,</span> <span class="n">curr_alloc_size</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hwi_ws_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">SE_MEM_MAX</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_descr</span><span class="p">),</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mem_arr_orig</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_arr_orig</span><span class="p">)</span> <span class="o">*</span> <span class="n">BEISCSI_MAX_FRAGS_INIT</span><span class="p">,</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_arr_orig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SE_MEM_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mem_arr</span> <span class="o">=</span> <span class="n">mem_arr_orig</span><span class="p">;</span>
		<span class="n">alloc_size</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mem_arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_array</span><span class="p">)</span> <span class="o">*</span>
		       <span class="n">BEISCSI_MAX_FRAGS_INIT</span><span class="p">);</span>
		<span class="n">curr_alloc_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">be_max_phys_size</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">alloc_size</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">mem_arr</span><span class="o">-&gt;</span><span class="n">virtual_address</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span>
							<span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
							<span class="n">curr_alloc_size</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">bus_add</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_arr</span><span class="o">-&gt;</span><span class="n">virtual_address</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">curr_alloc_size</span> <span class="o">&lt;=</span> <span class="n">BE_MIN_MEM_SIZE</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">curr_alloc_size</span> <span class="o">-</span>
					<span class="n">rounddown_pow_of_two</span><span class="p">(</span><span class="n">curr_alloc_size</span><span class="p">))</span>
					<span class="n">curr_alloc_size</span> <span class="o">=</span> <span class="n">rounddown_pow_of_two</span>
							     <span class="p">(</span><span class="n">curr_alloc_size</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">curr_alloc_size</span> <span class="o">=</span> <span class="n">curr_alloc_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mem_arr</span><span class="o">-&gt;</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span>
				    <span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">bus_add</span><span class="p">;</span>
				<span class="n">mem_arr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">curr_alloc_size</span><span class="p">;</span>
				<span class="n">alloc_size</span> <span class="o">-=</span> <span class="n">curr_alloc_size</span><span class="p">;</span>
				<span class="n">curr_alloc_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">be_max_phys_size</span> <span class="o">*</span>
						      <span class="mi">1024</span><span class="p">,</span> <span class="n">alloc_size</span><span class="p">);</span>
				<span class="n">j</span><span class="o">++</span><span class="p">;</span>
				<span class="n">mem_arr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">alloc_size</span><span class="p">);</span>
		<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">num_elements</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">size_in_bytes</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mem_req</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_arr</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">,</span>
					       <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">,</span> <span class="n">mem_arr_orig</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_array</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">);</span>
		<span class="n">mem_descr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mem_arr_orig</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">free_mem:</span>
	<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">num_elements</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">num_elements</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					    <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">,</span>
					    <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span>
					    <span class="n">virtual_address</span><span class="p">,</span>
					    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem_descr</span><span class="o">-&gt;</span>
					    <span class="n">mem_array</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span>
					    <span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">);</span>
			<span class="n">mem_descr</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mem_arr_orig</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_get_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">beiscsi_find_mem_req</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">beiscsi_alloc_mem</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iscsi_init_global_templates</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pdu_data_out</span> <span class="o">*</span><span class="n">pdata_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pdu_nop_out</span> <span class="o">*</span><span class="n">pnop_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr</span><span class="p">;</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">ISCSI_MEM_GLOBAL_HEADER</span><span class="p">;</span>
	<span class="n">pdata_out</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">pdu_data_out</span> <span class="o">*</span><span class="p">)</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pdata_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BE_ISCSI_PDU_HEADER_SIZE</span><span class="p">);</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_data_out</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">pdata_out</span><span class="p">,</span>
		      <span class="n">IIOC_SCSI_DATA</span><span class="p">);</span>

	<span class="n">pnop_out</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">pdu_nop_out</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span>
				   <span class="n">virtual_address</span> <span class="o">+</span> <span class="n">BE_ISCSI_PDU_HEADER_SIZE</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pnop_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BE_ISCSI_PDU_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_nop_out</span><span class="p">,</span> <span class="n">ttt</span><span class="p">,</span> <span class="n">pnop_out</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_nop_out</span><span class="p">,</span> <span class="n">f_bit</span><span class="p">,</span> <span class="n">pnop_out</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_nop_out</span><span class="p">,</span> <span class="n">i_bit</span><span class="p">,</span> <span class="n">pnop_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_init_wrb_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr_wrbh</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_descr_wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wrb_handle</span> <span class="o">*</span><span class="n">pwrb_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_wrb_context</span> <span class="o">*</span><span class="n">pwrb_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_wrb</span> <span class="o">*</span><span class="n">pwrb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_cxn_wrbh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_cxn_wrb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">mem_descr_wrbh</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr_wrbh</span> <span class="o">+=</span> <span class="n">HWI_MEM_WRBH</span><span class="p">;</span>

	<span class="n">mem_descr_wrb</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr_wrb</span> <span class="o">+=</span> <span class="n">HWI_MEM_WRB</span><span class="p">;</span>
	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pwrb_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_base</span> <span class="o">=</span>
				<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wrb_handle</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
					<span class="s">&quot;Mem Alloc Failed. Failing to load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">init_wrb_hndl_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_basestd</span> <span class="o">=</span>
				<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wrb_handle</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_basestd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
					<span class="s">&quot;Mem Alloc Failed. Failing to load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">init_wrb_hndl_failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_cxn_wrbh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pwrb_handle</span> <span class="o">=</span>
				<span class="n">mem_descr_wrbh</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
			<span class="n">num_cxn_wrbh</span> <span class="o">=</span> <span class="p">((</span><span class="n">mem_descr_wrbh</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span>
					<span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wrb_handle</span><span class="p">))</span> <span class="o">*</span>
					 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">));</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">alloc_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">wrb_handles_available</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">free_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_cxn_wrbh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_base</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwrb_handle</span><span class="p">;</span>
				<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_basestd</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
								<span class="n">pwrb_handle</span><span class="p">;</span>
				<span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">wrb_handles_available</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">wrb_index</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
				<span class="n">pwrb_handle</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">num_cxn_wrbh</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pwrb_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_cxn_wrb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pwrb</span> <span class="o">=</span> <span class="n">mem_descr_wrb</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
			<span class="n">num_cxn_wrb</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_descr_wrb</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span>
				<span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span><span class="p">)</span> <span class="o">*</span>
				  <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">));</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_cxn_wrb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pwrb_handle</span> <span class="o">=</span> <span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_base</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">pwrb</span> <span class="o">=</span> <span class="n">pwrb</span><span class="p">;</span>
				<span class="n">pwrb</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">num_cxn_wrb</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">init_wrb_hndl_failed:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pwrb_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_base</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_basestd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_init_async_pdu_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hba_parameters</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="n">pasync_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="n">pasync_header_h</span><span class="p">,</span> <span class="o">*</span><span class="n">pasync_data_h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">num_per_mem</span><span class="p">,</span> <span class="n">num_async_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr</span><span class="p">;</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_ASYNC_PDU_CONTEXT</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="o">-&gt;</span><span class="n">pasync_ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hwi_async_pdu_context</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">pasync_ctx</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="o">-&gt;</span><span class="n">pasync_ctx</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pasync_ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pasync_ctx</span><span class="p">));</span>

	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">asyncpdus_per_ctrl</span><span class="p">;</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">defpdu_hdr_sz</span><span class="p">;</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_ASYNC_HEADER_BUF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
			 <span class="s">&quot;hwi_init_async_pdu_ctx HWI_MEM_ASYNC_HEADER_BUF&quot;</span>
			 <span class="s">&quot;va=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;No Virtual address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">va_base</span> <span class="o">=</span>
			<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>

	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">pa_base</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>
			<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_ASYNC_HEADER_RING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
			 <span class="s">&quot;hwi_init_async_pdu_ctx HWI_MEM_ASYNC_HEADER_RING&quot;</span>
			 <span class="s">&quot;va=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			    <span class="s">&quot;No Virtual address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">ring_base</span> <span class="o">=</span>
			<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_ASYNC_HEADER_HANDLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
			 <span class="s">&quot;hwi_init_async_pdu_ctx HWI_MEM_ASYNC_HEADER_HANDLE&quot;</span>
			 <span class="s">&quot;va=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			    <span class="s">&quot;No Virtual address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">handle_base</span> <span class="o">=</span>
			<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">writables</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">free_list</span><span class="p">);</span>


	<span class="n">mem_descr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_ASYNC_DATA_RING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
			 <span class="s">&quot;hwi_init_async_pdu_ctx HWI_MEM_ASYNC_DATA_RING&quot;</span>
			 <span class="s">&quot;va=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;No Virtual address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">ring_base</span> <span class="o">=</span>
			<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_ASYNC_DATA_HANDLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">)</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			    <span class="s">&quot;No Virtual address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">handle_base</span> <span class="o">=</span>
			<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">writables</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">free_list</span><span class="p">);</span>

	<span class="n">pasync_header_h</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="p">)</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">handle_base</span><span class="p">;</span>
	<span class="n">pasync_data_h</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">async_pdu_handle</span> <span class="o">*</span><span class="p">)</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">handle_base</span><span class="p">;</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_ASYNC_DATA_BUF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
			 <span class="s">&quot;hwi_init_async_pdu_ctx HWI_MEM_ASYNC_DATA_BUF&quot;</span>
			 <span class="s">&quot;va=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			    <span class="s">&quot;No Virtual address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">va_base</span> <span class="o">=</span>
			<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">pa_base</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>
			<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>

	<span class="n">num_async_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">defpdu_data_sz</span><span class="p">);</span>
	<span class="n">num_per_mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">asyncpdus_per_ctrl</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pasync_header_h</span><span class="o">-&gt;</span><span class="n">cri</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">pasync_header_h</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">index</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_header_h</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">pasync_header_h</span><span class="o">-&gt;</span><span class="n">pbuffer</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
			<span class="p">(</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">va_base</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">defpdu_hdr_sz</span> <span class="o">*</span> <span class="n">index</span><span class="p">));</span>

		<span class="n">pasync_header_h</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">pa_base</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">defpdu_hdr_sz</span> <span class="o">*</span> <span class="n">index</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_header_h</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">pasync_header_h</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">free_entries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">writables</span><span class="o">++</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">wait_queue</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">index</span><span class="p">].</span>
			       <span class="n">header_busy_list</span><span class="p">);</span>
		<span class="n">pasync_data_h</span><span class="o">-&gt;</span><span class="n">cri</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">pasync_data_h</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">index</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_data_h</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_async_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num_per_mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">va_base</span> <span class="o">=</span>
				<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
			<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">pa_base</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>
				<span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span>
				<span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>

			<span class="n">num_async_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">defpdu_data_sz</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pasync_data_h</span><span class="o">-&gt;</span><span class="n">pbuffer</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
			<span class="p">(</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">va_base</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">defpdu_data_sz</span> <span class="o">*</span> <span class="n">num_per_mem</span><span class="p">));</span>

		<span class="n">pasync_data_h</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>
		    <span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">pa_base</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">defpdu_data_sz</span> <span class="o">*</span> <span class="n">num_per_mem</span><span class="p">);</span>
		<span class="n">num_per_mem</span><span class="o">++</span><span class="p">;</span>
		<span class="n">num_async_data</span><span class="o">--</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_data_h</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">free_list</span><span class="p">);</span>
		<span class="n">pasync_data_h</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">free_entries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">writables</span><span class="o">++</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_entry</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">data_busy_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">host_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_header</span><span class="p">.</span><span class="n">ep_read_ptr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">host_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pasync_ctx</span><span class="o">-&gt;</span><span class="n">async_data</span><span class="p">.</span><span class="n">ep_read_ptr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">be_sgl_create_contiguous</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">virtual_address</span><span class="p">,</span>
			 <span class="n">u64</span> <span class="n">physical_address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">sgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">virtual_address</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">physical_address</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sgl</span><span class="p">);</span>

	<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">physical_address</span><span class="p">;</span>
	<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_sgl_destroy_contiguous</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">sgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sgl</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hwi_build_be_sgl_arr</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">mem_array</span> <span class="o">*</span><span class="n">pmem</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">sgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sgl</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="n">be_sgl_destroy_contiguous</span><span class="p">(</span><span class="n">sgl</span><span class="p">);</span>

	<span class="n">be_sgl_create_contiguous</span><span class="p">(</span><span class="n">pmem</span><span class="o">-&gt;</span><span class="n">virtual_address</span><span class="p">,</span>
				 <span class="n">pmem</span><span class="o">-&gt;</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
				 <span class="n">pmem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">sgl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hwi_build_be_sgl_by_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">mem_array</span> <span class="o">*</span><span class="n">pmem</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">sgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sgl</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="n">be_sgl_destroy_contiguous</span><span class="p">(</span><span class="n">sgl</span><span class="p">);</span>

	<span class="n">be_sgl_create_contiguous</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pmem</span><span class="o">-&gt;</span><span class="n">virtual_address</span><span class="p">,</span>
				 <span class="n">pmem</span><span class="o">-&gt;</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">,</span>
				 <span class="n">pmem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">sgl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_fill_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">entry_size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">vaddress</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">));</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">vaddress</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_create_eqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_eq_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">eq_for_mcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">eq_vaddress</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="n">num_eq_pages</span> <span class="o">=</span> <span class="n">PAGES_REQUIRED</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_eq_entries</span> <span class="o">*</span> \
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eq_entry</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="n">eq_for_mcc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">eq_for_mcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span> <span class="o">+</span> <span class="n">eq_for_mcc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
		<span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phba</span> <span class="o">=</span> <span class="n">phba</span><span class="p">;</span>
		<span class="n">eq_vaddress</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						     <span class="n">num_eq_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eq_vaddress</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">create_eq_error</span><span class="p">;</span>

		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">eq_vaddress</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">be_fill_queue</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_eq_entries</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_eq_entry</span><span class="p">),</span> <span class="n">eq_vaddress</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;be_fill_queue Failed for EQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">create_eq_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_cmd_eq_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span>
					    <span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">cur_eqd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;beiscsi_cmd_eq_create&quot;</span>
				     <span class="s">&quot;Failedfor EQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">create_eq_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;eqid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">create_eq_error:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">num_eq_pages</span>
					    <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					    <span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_create_cqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_cq_pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">pbe_eq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cq_vaddress</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="n">num_cq_pages</span> <span class="o">=</span> <span class="n">PAGES_REQUIRED</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_cq_entries</span> <span class="o">*</span> \
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sol_cqe</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_cq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
		<span class="n">pbe_eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">cq</span> <span class="o">=</span> <span class="n">cq</span><span class="p">;</span>
		<span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">phba</span> <span class="o">=</span> <span class="n">phba</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
		<span class="n">cq_vaddress</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						     <span class="n">num_cq_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">paddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cq_vaddress</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">create_cq_error</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">be_fill_queue</span><span class="p">(</span><span class="n">cq</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_cq_entries</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sol_cqe</span><span class="p">),</span> <span class="n">cq_vaddress</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;be_fill_queue Failed for ISCSI CQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">create_cq_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_cmd_cq_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
					    <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;beiscsi_cmd_eq_create&quot;</span>
				     <span class="s">&quot;Failed for ISCSI CQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">create_cq_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;iscsi cq_id is %d for eq_id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;ISCSI CQ CREATED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">create_cq_error:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_cq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">num_cq_pages</span>
					    <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					    <span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">beiscsi_create_def_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">def_pdu_ring_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">dq</span><span class="p">,</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dq_vaddress</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_def_hdrq</span><span class="p">;</span>
	<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_cq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_ASYNC_HEADER_RING</span><span class="p">;</span>
	<span class="n">dq_vaddress</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">be_fill_queue</span><span class="p">(</span><span class="n">dq</span><span class="p">,</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">/</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span><span class="p">),</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span><span class="p">),</span> <span class="n">dq_vaddress</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;be_fill_queue Failed for DEF PDU HDR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span>
				  <span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">be_cmd_create_default_pdu_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">dq</span><span class="p">,</span>
					      <span class="n">def_pdu_ring_sz</span><span class="p">,</span>
					      <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">defpdu_hdr_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;be_cmd_create_default_pdu_queue Failed DEFHDR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">default_pdu_hdr</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_def_hdrq</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;iscsi def pdu id is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_def_hdrq</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hwi_post_async_buffers</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">beiscsi_create_def_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">def_pdu_ring_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">dataq</span><span class="p">,</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dq_vaddress</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dataq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_def_dataq</span><span class="p">;</span>
	<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_cq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dataq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_ASYNC_DATA_RING</span><span class="p">;</span>
	<span class="n">dq_vaddress</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">be_fill_queue</span><span class="p">(</span><span class="n">dataq</span><span class="p">,</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">/</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span><span class="p">),</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span><span class="p">),</span> <span class="n">dq_vaddress</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;be_fill_queue Failed for DEF PDU DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span>
				  <span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">be_cmd_create_default_pdu_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">dataq</span><span class="p">,</span>
					      <span class="n">def_pdu_ring_sz</span><span class="p">,</span>
					      <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">defpdu_data_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;be_cmd_create_default_pdu_queue Failed&quot;</span>
			     <span class="s">&quot; for DEF PDU DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">default_pdu_data</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_def_dataq</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;iscsi def data id is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_def_dataq</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hwi_post_async_buffers</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;DEFAULT PDU DATA RING CREATED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">beiscsi_post_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_array</span> <span class="o">*</span><span class="n">pm_arr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_offset</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">sgl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_SGE</span><span class="p">;</span>
	<span class="n">pm_arr</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">;</span>

	<span class="n">page_offset</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_sge</span><span class="p">)</span> <span class="o">*</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_sge_per_io</span> <span class="o">*</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_icd_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">num_elements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwi_build_be_sgl_arr</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pm_arr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgl</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_iscsi_post_sgl_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgl</span><span class="p">,</span>
						<span class="n">page_offset</span><span class="p">,</span>
						<span class="p">(</span><span class="n">pm_arr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">));</span>
		<span class="n">page_offset</span> <span class="o">+=</span> <span class="n">pm_arr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;post sgl failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pm_arr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;POSTED PAGES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			<span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_queue_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">entry_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">));</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">entry_size</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">beiscsi_create_wrb_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wrb_mem_index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">num_wrb_rings</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pa_addr_lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_array</span> <span class="o">*</span><span class="n">pwrb_arr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">wrb_vaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">sgl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">HWI_MEM_WRB</span><span class="p">;</span>
	<span class="n">pwrb_arr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pwrb_arr</span><span class="p">)</span> <span class="o">*</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">,</span>
			   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pwrb_arr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;Memory alloc failed in create wrb ring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wrb_vaddr</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">pa_addr_lo</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
	<span class="n">num_wrb_rings</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">;</span> <span class="n">num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_wrb_rings</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">virtual_address</span> <span class="o">=</span> <span class="n">wrb_vaddr</span><span class="p">;</span>
			<span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span>	<span class="o">=</span> <span class="n">pa_addr_lo</span><span class="p">;</span>
			<span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span> <span class="o">*</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span><span class="p">);</span>
			<span class="n">wrb_vaddr</span> <span class="o">+=</span> <span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
			<span class="n">pa_addr_lo</span> <span class="o">+=</span> <span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
			<span class="n">num_wrb_rings</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">wrb_vaddr</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
			<span class="n">pa_addr_lo</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span>\
					<span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
			<span class="n">num_wrb_rings</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">/</span>
					<span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span><span class="p">));</span>
			<span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">virtual_address</span> <span class="o">=</span> <span class="n">wrb_vaddr</span><span class="p">;</span>
			<span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span>\
						<span class="o">=</span> <span class="n">pa_addr_lo</span><span class="p">;</span>
			<span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span> <span class="o">*</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span><span class="p">);</span>
			<span class="n">wrb_vaddr</span> <span class="o">+=</span> <span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
			<span class="n">pa_addr_lo</span>   <span class="o">+=</span> <span class="n">pwrb_arr</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
			<span class="n">num_wrb_rings</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrb_mem_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">hwi_build_be_sgl_by_offset</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pwrb_arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sgl</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_cmd_wrbq_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgl</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_wrbq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;wrbq create failed.&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pwrb_arr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">].</span><span class="n">cid</span> <span class="o">=</span> <span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_wrbq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
								   <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pwrb_arr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_wrb_handles</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_wrb_context</span> <span class="o">*</span><span class="n">pwrb_context</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pwrb_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_base</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pwrb_context</span><span class="o">-&gt;</span><span class="n">pwrb_handle_basestd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_mcc_queues_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
		<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_MCCQ</span><span class="p">);</span>
	<span class="n">be_queue_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
		<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_CQ</span><span class="p">);</span>
	<span class="n">be_queue_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eq_num</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_context</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_wrbq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
			<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_WRBQ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_wrb_handles</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_def_hdrq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
		<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_DPDUQ</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_def_dataq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
		<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_DPDUQ</span><span class="p">);</span>

	<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">QTYPE_SGL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_cq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
			<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_CQ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="n">eq_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">eq_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span> <span class="o">+</span> <span class="n">eq_num</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">)</span>
			<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">QTYPE_EQ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">be_mcc_queues_destroy</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mcc_queues_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* Alloc MCC compl queue */</span>
	<span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_queue_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">MCC_CQ_LEN</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_compl</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* Ask BE to create MCC compl queue; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_cmd_cq_create</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span>
					 <span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">].</span><span class="n">q</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mcc_cq_free</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_cmd_cq_create</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">q</span><span class="p">,</span>
					  <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mcc_cq_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Alloc MCC queue */</span>
	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_queue_alloc</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">MCC_Q_LEN</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_wrb</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">mcc_cq_destroy</span><span class="p">;</span>

	<span class="cm">/* Ask BE to create MCC queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_cmd_mccq_create</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">cq</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">mcc_q_free</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">mcc_q_free:</span>
	<span class="n">be_queue_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
<span class="nl">mcc_cq_destroy:</span>
	<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cq</span><span class="p">,</span> <span class="n">QTYPE_CQ</span><span class="p">);</span>
<span class="nl">mcc_cq_free:</span>
	<span class="n">be_queue_free</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_num_cpus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">num_cpus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">num_cpus</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_cpus</span> <span class="o">&gt;=</span> <span class="n">MAX_CPUS</span><span class="p">)</span>
		<span class="n">num_cpus</span> <span class="o">=</span> <span class="n">MAX_CPUS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;num_cpus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_cpus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num_cpus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwi_init_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">def_pdu_ring_sz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">def_pdu_ring_sz</span> <span class="o">=</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">asyncpdus_per_ctrl</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_context</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">;</span>
	<span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">max_eqd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">min_eqd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">cur_eqd</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">be_cmd_fw_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_create_eqs</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phwi_context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;EQ not created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_queues_create</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phwi_context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mgmt_check_supported_fw</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;Unsupported fw version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_create_cqs</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phwi_context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;CQ not created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_create_def_hdr</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phwi_context</span><span class="p">,</span> <span class="n">phwi_ctrlr</span><span class="p">,</span>
					<span class="n">def_pdu_ring_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;Default Header not created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_create_def_data</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phwi_context</span><span class="p">,</span>
					 <span class="n">phwi_ctrlr</span><span class="p">,</span> <span class="n">def_pdu_ring_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;Default Data not created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_post_pages</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Post SGL Pages Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_create_wrb_rings</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>	<span class="n">phwi_context</span><span class="p">,</span> <span class="n">phwi_ctrlr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;WRB Rings not created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;hwi_init_port success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;hwi_init_port failed&quot;</span><span class="p">);</span>
	<span class="n">hwi_cleanup</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwi_init_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">[</span><span class="n">HWI_MEM_ADDN_CONTEXT</span><span class="p">].</span><span class="n">num_elements</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span>
		    <span class="n">init_mem</span><span class="p">[</span><span class="n">HWI_MEM_ADDN_CONTEXT</span><span class="p">].</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot; phwi_ctrlr-&gt;phwi_ctxt=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;HWI_MEM_ADDN_CONTEXT is more than one element.&quot;</span>
			     <span class="s">&quot;Failing to load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iscsi_init_global_templates</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_init_wrb_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hwi_init_async_pdu_ctx</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwi_init_port</span><span class="p">(</span><span class="n">phba</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;hwi_init_controller failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_free_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SE_MEM_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">num_elements</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			  <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">,</span>
			  <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span>
			  <span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">);</span>
		<span class="n">mem_descr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_init_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_get_memory</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;beiscsi_dev_probe -&quot;</span>
			     <span class="s">&quot;Failed in beiscsi_alloc_memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hwi_init_controller</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_init</span><span class="p">;</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;Return success from beiscsi_init_controller&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_init:</span>
	<span class="n">beiscsi_free_mem</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_init_sgl_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr_sglh</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_descr_sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="n">psgl_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_sge</span> <span class="o">*</span><span class="n">pfrag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arr_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_avbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_avbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mem_descr_sglh</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr_sglh</span> <span class="o">+=</span> <span class="n">HWI_MEM_SGLH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">mem_descr_sglh</span><span class="o">-&gt;</span><span class="n">num_elements</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
						 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span><span class="p">,</span>
						 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;Mem Alloc Failed. Failing to load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
						 <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">icds_per_ctrl</span> <span class="o">-</span>
						 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span><span class="p">),</span>
						 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">);</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;Mem Alloc Failed. Failing to load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;HWI_MEM_SGLH is more than one element.&quot;</span>
			     <span class="s">&quot;Failing to load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">arr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">mem_descr_sglh</span><span class="o">-&gt;</span><span class="n">num_elements</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psgl_handle</span> <span class="o">=</span> <span class="n">mem_descr_sglh</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mem_descr_sglh</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">/</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgl_handle</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arr_index</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">[</span><span class="n">arr_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">psgl_handle</span><span class="p">;</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_avbl</span><span class="o">++</span><span class="p">;</span>
				<span class="n">arr_index</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span><span class="p">[</span><span class="n">arr_index</span> <span class="o">-</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span><span class="p">]</span> <span class="o">=</span>
								<span class="n">psgl_handle</span><span class="p">;</span>
				<span class="n">arr_index</span><span class="o">++</span><span class="p">;</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_avbl</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">psgl_handle</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
		 <span class="s">&quot;phba-&gt;io_sgl_hndl_avbl=%d&quot;</span>
		 <span class="s">&quot;phba-&gt;eh_sgl_hndl_avbl=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_avbl</span><span class="p">,</span>
		 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_avbl</span><span class="p">);</span>
	<span class="n">mem_descr_sg</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr_sg</span> <span class="o">+=</span> <span class="n">HWI_MEM_SGE</span><span class="p">;</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> mem_descr_sg-&gt;num_elements=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">mem_descr_sg</span><span class="o">-&gt;</span><span class="n">num_elements</span><span class="p">);</span>
	<span class="n">arr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">mem_descr_sg</span><span class="o">-&gt;</span><span class="n">num_elements</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pfrag</span> <span class="o">=</span> <span class="n">mem_descr_sg</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">virtual_address</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mem_descr_sg</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span>
		     <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_sge</span><span class="p">)</span> <span class="o">*</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_sge_per_io</span><span class="p">);</span>
		     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arr_index</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span><span class="p">)</span>
				<span class="n">psgl_handle</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">[</span><span class="n">arr_index</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">psgl_handle</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span><span class="p">[</span><span class="n">arr_index</span> <span class="o">-</span>
						<span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span><span class="p">];</span>
			<span class="n">psgl_handle</span><span class="o">-&gt;</span><span class="n">pfrag</span> <span class="o">=</span> <span class="n">pfrag</span><span class="p">;</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">,</span> <span class="n">pfrag</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_sge</span><span class="p">,</span> <span class="n">addr_lo</span><span class="p">,</span> <span class="n">pfrag</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pfrag</span> <span class="o">+=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_sge_per_io</span><span class="p">;</span>
			<span class="n">psgl_handle</span><span class="o">-&gt;</span><span class="n">sgl_index</span> <span class="o">=</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_icd_start</span> <span class="o">+</span> <span class="n">arr_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_free_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_alloc_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_free_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_alloc_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hba_setup_cid_tbls</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">new_cid</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_array</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">,</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_array</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;Failed to allocate memory in &quot;</span>
			     <span class="s">&quot;hba_setup_cid_tbls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ep_array</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
				 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ep_array</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;Failed to allocate memory in &quot;</span>
			     <span class="s">&quot;hba_setup_cid_tbls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_array</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_cid</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cid</span><span class="p">;</span>
		<span class="n">new_cid</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">avlbl_cids</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_enable_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_context</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcicfg</span> <span class="o">+</span>
			<span class="n">PCICFG_MEMBAR_CTRL_INT_CTRL_OFFSET</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">enabled</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MEMBAR_CTRL_INT_CTRL_HOSTINTR_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">MEMBAR_CTRL_INT_CTRL_HOSTINTR_MASK</span><span class="p">;</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;reg =x%08x addr=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;eq-&gt;id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;eq-&gt;id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_disable_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcicfg</span> <span class="o">+</span> <span class="n">PCICFG_MEMBAR_CTRL_INT_CTRL_OFFSET</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">enabled</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MEMBAR_CTRL_INT_CTRL_HOSTINTR_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEMBAR_CTRL_INT_CTRL_HOSTINTR_MASK</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;In hwi_disable_intr, Already Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_get_boot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_cmd_get_boot_target_resp</span> <span class="o">*</span><span class="n">boot_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_get_session_resp</span> <span class="o">*</span><span class="n">session_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">nonemb_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">wrb_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">mgmt_get_boot_target</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;beiscsi_get_boot_info Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
					 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>

	<span class="n">wrb_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">extd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="n">extd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;beiscsi_get_boot_info Failed&quot;</span>
				    <span class="s">&quot; status = %d extd_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_get_wrb</span><span class="p">(</span><span class="n">mccq</span><span class="p">,</span> <span class="n">wrb_num</span><span class="p">);</span>
	<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">boot_resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_resp</span><span class="o">-&gt;</span><span class="n">boot_session_handle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;No Boot Session.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">session_resp</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;Failed to allocate memory for&quot;</span>
			 <span class="s">&quot;beiscsi_get_session_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">session_resp</span><span class="p">));</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">mgmt_get_session_info</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">boot_resp</span><span class="o">-&gt;</span><span class="n">boot_session_handle</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;beiscsi_get_session_info&quot;</span>
			<span class="s">&quot; Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">boot_freemem</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
					 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>

	<span class="n">wrb_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">extd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="n">extd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;beiscsi_get_session_info Failed&quot;</span>
				    <span class="s">&quot; status = %d extd_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">boot_freemem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_get_wrb</span><span class="p">(</span><span class="n">mccq</span><span class="p">,</span> <span class="n">wrb_num</span><span class="p">);</span>
	<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">session_resp</span> <span class="o">=</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_sess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session_resp</span><span class="o">-&gt;</span><span class="n">session_info</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mgmt_session_info</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">boot_freemem:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
		    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_boot_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_setup_boot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_boot_kobj</span> <span class="o">*</span><span class="n">boot_kobj</span><span class="p">;</span>

	<span class="cm">/* get boot info using mgmt cmd */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_get_boot_info</span><span class="p">(</span><span class="n">phba</span><span class="p">))</span>
		<span class="cm">/* Try to see if we can carry on without this */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_kset</span> <span class="o">=</span> <span class="n">iscsi_boot_create_host_kset</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* get a ref because the show function will ref the phba */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_kset</span><span class="p">;</span>
	<span class="n">boot_kobj</span> <span class="o">=</span> <span class="n">iscsi_boot_create_target</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span>
					     <span class="n">beiscsi_show_boot_tgt_info</span><span class="p">,</span>
					     <span class="n">beiscsi_tgt_get_attr_visibility</span><span class="p">,</span>
					     <span class="n">beiscsi_boot_release</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_shost</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_kset</span><span class="p">;</span>
	<span class="n">boot_kobj</span> <span class="o">=</span> <span class="n">iscsi_boot_create_initiator</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span>
						<span class="n">beiscsi_show_boot_ini_info</span><span class="p">,</span>
						<span class="n">beiscsi_ini_get_attr_visibility</span><span class="p">,</span>
						<span class="n">beiscsi_boot_release</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_shost</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_kset</span><span class="p">;</span>
	<span class="n">boot_kobj</span> <span class="o">=</span> <span class="n">iscsi_boot_create_ethernet</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span>
					       <span class="n">beiscsi_show_boot_eth_info</span><span class="p">,</span>
					       <span class="n">beiscsi_eth_get_attr_visibility</span><span class="p">,</span>
					       <span class="n">beiscsi_boot_release</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_shost</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">put_shost:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
<span class="nl">free_kset:</span>
	<span class="n">iscsi_boot_destroy_kset</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_init_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_init_controller</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;beiscsi_dev_probe - Failed in&quot;</span>
			     <span class="s">&quot;beiscsi_init_controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_init_sgl_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;beiscsi_dev_probe - Failed in&quot;</span>
			     <span class="s">&quot;beiscsi_init_sgl_handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">do_cleanup_ctrlr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hba_setup_cid_tbls</span><span class="p">(</span><span class="n">phba</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;Failed in hba_setup_cid_tbls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">do_cleanup_ctrlr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">do_cleanup_ctrlr:</span>
	<span class="n">hwi_cleanup</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwi_purge_eq</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_entry</span> <span class="o">*</span><span class="n">eqe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eq_msix</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_processed</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_context</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="n">eq_msix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">eq_msix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span> <span class="o">+</span> <span class="n">eq_msix</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
		<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
		<span class="n">num_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">eqe</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span>
					<span class="o">&amp;</span> <span class="n">EQE_VALID_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_entry</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">eqe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
			<span class="n">eqe</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">eq</span><span class="p">);</span>
			<span class="n">num_processed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_processed</span><span class="p">)</span>
			<span class="n">hwi_ring_eq_db</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>	<span class="n">num_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_clean_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mgmt_status</span><span class="p">;</span>

	<span class="n">mgmt_status</span> <span class="o">=</span> <span class="n">mgmt_epfw_cleanup</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">CMD_CONNECTION_CHUTE_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_status</span><span class="p">)</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;mgmt_epfw_cleanup FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">hwi_purge_eq</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">hwi_cleanup</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_hndl_base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">eh_sgl_hndl_base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_array</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ep_array</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_cleanup_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_session</span> <span class="o">*</span><span class="n">beiscsi_sess</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_wrb_context</span> <span class="o">*</span><span class="n">pwrb_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pwrb_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[</span><span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span>
			<span class="o">-</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">beiscsi_sess</span><span class="o">-&gt;</span><span class="n">bhs_pool</span><span class="p">,</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="p">,</span>
			      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
		<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_wrb_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pwrb_context</span><span class="p">,</span>
					<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">);</span>
			<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_lock</span><span class="p">);</span>
			<span class="n">free_io_sgl_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_lock</span><span class="p">);</span>
			<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">login_in_progress</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free_wrb_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pwrb_context</span><span class="p">,</span>
						<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">);</span>
				<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
				<span class="n">free_mgmt_sgl_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
						     <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
				<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">beiscsi_offload_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">beiscsi_offload_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wrb_handle</span> <span class="o">*</span><span class="n">pwrb_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_target_context_update_wrb</span> <span class="o">*</span><span class="n">pwrb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mem_descriptor</span> <span class="o">*</span><span class="n">mem_descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doorbell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can always use 0 here because it is reserved by libiscsi for</span>
<span class="cm">	 * login/startup related tasks.</span>
<span class="cm">	 */</span>
	<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">login_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">beiscsi_cleanup_task</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pwrb_handle</span> <span class="o">=</span> <span class="n">alloc_wrb_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="p">(</span><span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">-</span>
				       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">));</span>
	<span class="n">pwrb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_target_context_update_wrb</span> <span class="o">*</span><span class="p">)</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">pwrb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pwrb</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span>
		      <span class="n">max_burst_length</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span>
		      <span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		      <span class="n">max_burst_length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span>
		      <span class="n">max_send_data_segment_length</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">params</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		      <span class="n">max_send_data_segment_length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span>
		      <span class="n">first_burst_length</span><span class="p">,</span>
		      <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">params</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		      <span class="n">first_burst_length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]);</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">erl</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		      <span class="n">erl</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">OFFLD_PARAMS_ERL</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">dde</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		      <span class="n">dde</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">OFFLD_PARAMS_DDE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">hde</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		      <span class="n">hde</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">OFFLD_PARAMS_HDE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">ir2t</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		      <span class="n">ir2t</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">OFFLD_PARAMS_IR2T</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">imd</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		       <span class="n">imd</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">OFFLD_PARAMS_IMD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">stat_sn</span><span class="p">,</span>
		      <span class="n">pwrb</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		      <span class="n">exp_statsn</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">wrb_idx</span><span class="p">,</span>
		      <span class="n">pwrb</span><span class="p">,</span> <span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">wrb_index</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">ptr2nextwrb</span><span class="p">,</span>
		      <span class="n">pwrb</span><span class="p">,</span> <span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">nxt_wrb_index</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span>
			<span class="n">session_state</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">compltonack</span><span class="p">,</span>
		      <span class="n">pwrb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">notpredblq</span><span class="p">,</span>
		      <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="mi">0</span><span class="p">);</span>

	<span class="n">mem_descr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">init_mem</span><span class="p">;</span>
	<span class="n">mem_descr</span> <span class="o">+=</span> <span class="n">ISCSI_MEM_GLOBAL_HEADER</span><span class="p">;</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span>
			<span class="n">pad_buffer_addr_hi</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_hi</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_target_context_update_wrb</span><span class="p">,</span>
			<span class="n">pad_buffer_addr_lo</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">mem_descr</span><span class="o">-&gt;</span><span class="n">mem_array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bus_address</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">address_lo</span><span class="p">);</span>

	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_target_context_update_wrb</span><span class="p">));</span>

	<span class="n">doorbell</span> <span class="o">|=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">&amp;</span> <span class="n">DB_WRB_POST_CID_MASK</span><span class="p">;</span>
	<span class="n">doorbell</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">wrb_index</span> <span class="o">&amp;</span> <span class="n">DB_DEF_PDU_WRB_INDEX_MASK</span><span class="p">)</span>
			     <span class="o">&lt;&lt;</span> <span class="n">DB_DEF_PDU_WRB_INDEX_SHIFT</span><span class="p">;</span>
	<span class="n">doorbell</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_DEF_PDU_NUM_POSTED_SHIFT</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">+</span> <span class="n">DB_TXULP0_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_parse_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="n">itt_t</span> <span class="n">itt</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">age</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">itt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">age</span><span class="p">)</span>
		<span class="o">*</span><span class="n">age</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_alloc_pdu - allocates pdu and related resources</span>
<span class="cm"> * @task: libiscsi task</span>
<span class="cm"> * @opcode: opcode of pdu for task</span>
<span class="cm"> *</span>
<span class="cm"> * This is called with the session lock held. It will allocate</span>
<span class="cm"> * the wrb and sgl if needed for the command. And it will prep</span>
<span class="cm"> * the pdu&#39;s itt. beiscsi_parse_pdu will later translate</span>
<span class="cm"> * the pdu itt to the libiscsi task itt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_alloc_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_wrb_context</span> <span class="o">*</span><span class="n">pwrb_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">itt_t</span> <span class="n">itt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_session</span> <span class="o">*</span><span class="n">beiscsi_sess</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_sess</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">beiscsi_sess</span><span class="o">-&gt;</span><span class="n">bhs_pool</span><span class="p">,</span>
					  <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">paddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">libiscsi_itt</span> <span class="o">=</span> <span class="p">(</span><span class="n">itt_t</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">;</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_hdr</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr_max</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_bhs</span><span class="p">);</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_lock</span><span class="p">);</span>
		<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span> <span class="o">=</span> <span class="n">alloc_io_sgl_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_hndls</span><span class="p">;</span>
		<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span> <span class="o">=</span> <span class="n">alloc_wrb_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
					<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">-</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_io_hndls</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">scsi_cmnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">ISCSI_OPCODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISCSI_OP_LOGIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">login_in_progress</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
				<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgl_handle</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">alloc_mgmt_sgl_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">free_hndls</span><span class="p">;</span>

				<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">login_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">plogin_sgl_handle</span> <span class="o">=</span>
							<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">;</span>
				<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span> <span class="o">=</span>
					<span class="n">alloc_wrb_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
					<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">-</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">free_io_hndls</span><span class="p">;</span>
				<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">plogin_wrb_handle</span> <span class="o">=</span>
							<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span> <span class="o">=</span>
						<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">plogin_sgl_handle</span><span class="p">;</span>
				<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span> <span class="o">=</span>
						<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">plogin_wrb_handle</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
			<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span> <span class="o">=</span> <span class="n">alloc_mgmt_sgl_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">free_hndls</span><span class="p">;</span>
			<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span> <span class="o">=</span>
					<span class="n">alloc_wrb_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
					<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">-</span>
					<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">free_mgmt_hndls</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">itt</span> <span class="o">=</span> <span class="p">(</span><span class="n">itt_t</span><span class="p">)</span> <span class="n">cpu_to_be32</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span>
				 <span class="n">wrb_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
				<span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="o">-&gt;</span><span class="n">sgl_index</span><span class="p">));</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">pio_handle</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>

	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_hdr</span><span class="p">.</span><span class="n">itt</span> <span class="o">=</span> <span class="n">itt</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_io_hndls:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_lock</span><span class="p">);</span>
	<span class="n">free_io_sgl_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_lock</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">free_hndls</span><span class="p">;</span>
<span class="nl">free_mgmt_hndls:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
	<span class="n">free_mgmt_sgl_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
<span class="nl">free_hndls:</span>
	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">pwrb_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">wrb_context</span><span class="p">[</span>
			<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">-</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">)</span>
		<span class="n">free_wrb_handle</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pwrb_context</span><span class="p">,</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="p">);</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">beiscsi_sess</span><span class="o">-&gt;</span><span class="n">bhs_pool</span><span class="p">,</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="p">,</span>
		      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_pa</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">a64</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Alloc of SGL_ICD Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_iotask</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xferlen</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">writedir</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_wrb</span> <span class="o">*</span><span class="n">pwrb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">doorbell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pwrb</span> <span class="o">=</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">pwrb</span><span class="p">;</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_hdr</span><span class="p">.</span><span class="n">exp_statsn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">bhs_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_bhs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">writedir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_data_pdu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_data_out</span><span class="p">,</span> <span class="n">itt</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_data_pdu</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_hdr</span><span class="p">.</span><span class="n">itt</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_data_out</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_data_pdu</span><span class="p">,</span>
			      <span class="n">ISCSI_OPCODE_SCSI_DATA_OUT</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_data_out</span><span class="p">,</span> <span class="n">final_bit</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_data_pdu</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
			      <span class="n">INI_WR_CMD</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
			      <span class="n">INI_RD_CMD</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_data_pdu</span><span class="p">.</span>
	       <span class="n">dw</span><span class="p">[</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_pdu_data_out</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">],</span>
	       <span class="o">&amp;</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_hdr</span><span class="p">.</span><span class="n">lun</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span><span class="p">));</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">cpu_to_be16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span>
				  <span class="o">&amp;</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">cmd_bhs</span><span class="o">-&gt;</span><span class="n">iscsi_hdr</span><span class="p">.</span><span class="n">lun</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">r2t_exp_dtl</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="n">xferlen</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">wrb_idx</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">wrb_index</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">cmdsn_itt</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">cmdsn</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sgl_icd_idx</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="o">-&gt;</span><span class="n">sgl_index</span><span class="p">);</span>

	<span class="n">hwi_write_sgl</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">num_sg</span><span class="p">,</span> <span class="n">io_task</span><span class="p">);</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">ptr2nextwrb</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">nxt_wrb_index</span><span class="p">);</span>
	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span><span class="p">));</span>

	<span class="n">doorbell</span> <span class="o">|=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">&amp;</span> <span class="n">DB_WRB_POST_CID_MASK</span><span class="p">;</span>
	<span class="n">doorbell</span> <span class="o">|=</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">wrb_index</span> <span class="o">&amp;</span>
		     <span class="n">DB_DEF_PDU_WRB_INDEX_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DB_DEF_PDU_WRB_INDEX_SHIFT</span><span class="p">;</span>
	<span class="n">doorbell</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_DEF_PDU_NUM_POSTED_SHIFT</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">+</span> <span class="n">DB_TXULP0_OFFSET</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_mtask</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_wrb</span> <span class="o">*</span><span class="n">pwrb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">doorbell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">;</span>

	<span class="n">cid</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span><span class="p">;</span>
	<span class="n">pwrb</span> <span class="o">=</span> <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">pwrb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pwrb</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">cmdsn_itt</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">cmdsn</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">wrb_idx</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">wrb_index</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">sgl_icd_idx</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">psgl_handle</span><span class="o">-&gt;</span><span class="n">sgl_index</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">ISCSI_OPCODE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_LOGIN</span>:
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
			      <span class="n">TGT_DM_CMD</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dmsg</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">cmdsn_itt</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hwi_write_buffer</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_NOOP_OUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ttt</span> <span class="o">!=</span> <span class="n">ISCSI_RESERVED_TAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
				      <span class="n">TGT_DM_CMD</span><span class="p">);</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">cmdsn_itt</span><span class="p">,</span>
				      <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dmsg</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
				      <span class="n">INI_RD_CMD</span><span class="p">);</span>
			<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dmsg</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hwi_write_buffer</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_TEXT</span>:
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
			      <span class="n">TGT_DM_CMD</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dmsg</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hwi_write_buffer</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_SCSI_TMFUNC</span>:
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
			      <span class="n">INI_TMF_CMD</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dmsg</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hwi_write_buffer</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_OP_LOGOUT</span>:
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">dmsg</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
			      <span class="n">HWH_TYPE_LOGOUT</span><span class="p">);</span>
		<span class="n">hwi_write_buffer</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;opcode =%d Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">ISCSI_OPCODE_MASK</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">r2t_exp_dtl</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_iscsi_wrb</span><span class="p">,</span> <span class="n">ptr2nextwrb</span><span class="p">,</span> <span class="n">pwrb</span><span class="p">,</span>
		      <span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">nxt_wrb_index</span><span class="p">);</span>
	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">pwrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_wrb</span><span class="p">));</span>

	<span class="n">doorbell</span> <span class="o">|=</span> <span class="n">cid</span> <span class="o">&amp;</span> <span class="n">DB_WRB_POST_CID_MASK</span><span class="p">;</span>
	<span class="n">doorbell</span> <span class="o">|=</span> <span class="p">(</span><span class="n">io_task</span><span class="o">-&gt;</span><span class="n">pwrb_handle</span><span class="o">-&gt;</span><span class="n">wrb_index</span> <span class="o">&amp;</span>
		     <span class="n">DB_DEF_PDU_WRB_INDEX_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DB_DEF_PDU_WRB_INDEX_SHIFT</span><span class="p">;</span>
	<span class="n">doorbell</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_DEF_PDU_NUM_POSTED_SHIFT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">doorbell</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">+</span> <span class="n">DB_TXULP0_OFFSET</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_task_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">writedir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xferlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">beiscsi_mtask</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="n">io_task</span><span class="o">-&gt;</span><span class="n">scsi_cmnd</span> <span class="o">=</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">num_sg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_sg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot; scsi_dma_map Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">num_sg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xferlen</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writedir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_4</span><span class="p">,</span> <span class="s">&quot;task-&gt;imm_count=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">task</span><span class="o">-&gt;</span><span class="n">imm_count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">writedir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">beiscsi_iotask</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">num_sg</span><span class="p">,</span> <span class="n">xferlen</span><span class="p">,</span> <span class="n">writedir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_bsg_request - handle bsg request from ISCSI transport</span>
<span class="cm"> * @job: job to handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_bsg_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsg_job</span> <span class="o">*</span><span class="n">job</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_bsg_request</span> <span class="o">*</span><span class="n">bsg_req</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">nonemb_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_resp_hdr</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_bsg_reply</span> <span class="o">*</span><span class="n">bsg_reply</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">;</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_job_to_shost</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bsg_req</span><span class="o">-&gt;</span><span class="n">msgcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BSG_HST_VENDOR</span>:
		<span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span>
					<span class="n">job</span><span class="o">-&gt;</span><span class="n">request_payload</span><span class="p">.</span><span class="n">payload_len</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for &quot;</span>
				 <span class="s">&quot;beiscsi_bsg_request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">mgmt_vendor_specific_fw_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">phba</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;be_cmd_get_mac_addr Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
					    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
						 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>
		<span class="n">extd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_resp_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>
		<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_list</span><span class="p">,</span>
				    <span class="n">job</span><span class="o">-&gt;</span><span class="n">reply_payload</span><span class="p">.</span><span class="n">sg_cnt</span><span class="p">,</span>
				    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">response_length</span>
				    <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">)));</span>
		<span class="n">bsg_reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">response_length</span><span class="p">;</span>
		<span class="n">bsg_reply</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">bsg_job_done</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bsg_reply</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span>
			     <span class="n">bsg_reply</span><span class="o">-&gt;</span><span class="n">reply_payload_rcv_len</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="n">extd_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;be_cmd_get_mac_addr Failed&quot;</span>
				 <span class="s">&quot; status = %d extd_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Unsupported bsg command: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">bsg_req</span><span class="o">-&gt;</span><span class="n">msgcode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_quiesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">pbe_eq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">msix_vec</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">real_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_context</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">;</span>
	<span class="n">hwi_disable_intr</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msix_vec</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">msix_vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msi_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">phba</span><span class="p">);</span>
	<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_iopoll_enabled</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pbe_eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">blk_iopoll_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">iopoll</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="n">beiscsi_clean_port</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">beiscsi_free_mem</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">real_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">csr_va</span> <span class="o">+</span> <span class="n">MPU_EP_SEMAPHORE</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">real_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x00010000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0xfffeffff</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">real_offset</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">beiscsi_unmap_pci_function</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mbox_mem_alloced</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mbox_mem_alloced</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
			    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mbox_mem_alloced</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">phba</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;beiscsi_remove called with no phba</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">beiscsi_destroy_def_ifaces</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">beiscsi_quiesce</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">iscsi_boot_destroy_kset</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">);</span>
	<span class="n">iscsi_host_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">iscsi_host_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">phba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;beiscsi_shutdown called with no phba</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">beiscsi_quiesce</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_msix_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">beiscsi_dev_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_controller</span> <span class="o">*</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwi_context_memory</span> <span class="o">*</span><span class="n">phwi_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_eq_obj</span> <span class="o">*</span><span class="n">pbe_eq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">num_cpus</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">real_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_enable_pci</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;beiscsi_dev_probe-&quot;</span>
			<span class="s">&quot; Failed to enable pci device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_hba_alloc</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;beiscsi_dev_probe-&quot;</span>
			<span class="s">&quot; Failed in beiscsi_hba_alloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disable_pci</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BE_DEVICE_ID1</span>:
	<span class="k">case</span> <span class="n">OC_DEVICE_ID1</span>:
	<span class="k">case</span> <span class="n">OC_DEVICE_ID2</span>:
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">BE_GEN2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE_DEVICE_ID2</span>:
	<span class="k">case</span> <span class="n">OC_DEVICE_ID3</span>:
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">BE_GEN3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_msix</span><span class="p">)</span>
		<span class="n">num_cpus</span> <span class="o">=</span> <span class="n">find_num_cpus</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">num_cpus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span> <span class="o">=</span> <span class="n">num_cpus</span><span class="p">;</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;num_cpus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_msix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">beiscsi_msix_enable</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">be_ctrl_init</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;beiscsi_dev_probe-&quot;</span>
				<span class="s">&quot;Failed in be_ctrl_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">hba_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">real_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">csr_va</span> <span class="o">+</span> <span class="n">MPU_EP_SEMAPHORE</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">real_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x00010000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gcrashmode</span><span class="o">++</span><span class="p">;</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
				<span class="s">&quot;Loading Driver in crashdump mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_cmd_reset_function</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
					<span class="s">&quot;Reset Failed. Aborting Crashdump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">hba_free</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">be_chk_reset_complete</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
					<span class="s">&quot;Failed to get out of reset.&quot;</span>
					<span class="s">&quot;Aborting Crashdump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">hba_free</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x00010000</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">real_offset</span><span class="p">);</span>
			<span class="n">num_hba</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">io_sgl_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mgmt_sgl_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgmt_get_fw_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
			     <span class="s">&quot;Error getting fw config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_port</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_count</span><span class="p">;</span>
	<span class="n">beiscsi_get_params</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ios_per_ctrl</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_init_port</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;beiscsi_dev_probe-&quot;</span>
			     <span class="s">&quot;Failed in beiscsi_init_port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_port</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MCC_CMD</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_tag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_tag_available</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_alloc_index</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_free_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq_name</span><span class="p">),</span> <span class="s">&quot;beiscsi_q_irq%u&quot;</span><span class="p">,</span>
		 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq_name</span><span class="p">,</span> <span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;beiscsi_dev_probe-&quot;</span>
				<span class="s">&quot;Failed to allocate work queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_twq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">work_cqs</span><span class="p">,</span> <span class="n">beiscsi_process_all_cqs</span><span class="p">);</span>

	<span class="n">phwi_ctrlr</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">phwi_ctrlr</span><span class="p">;</span>
	<span class="n">phwi_context</span> <span class="o">=</span> <span class="n">phwi_ctrlr</span><span class="o">-&gt;</span><span class="n">phwi_ctxt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_iopoll_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pbe_eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">blk_iopoll_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">iopoll</span><span class="p">,</span> <span class="n">be_iopoll_budget</span><span class="p">,</span>
					<span class="n">be_iopoll</span><span class="p">);</span>
			<span class="n">blk_iopoll_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">iopoll</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_init_irqs</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;beiscsi_dev_probe-&quot;</span>
			     <span class="s">&quot;Failed to beiscsi_init_irqs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_blkenbld</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwi_enable_intr</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_setup_boot_info</span><span class="p">(</span><span class="n">phba</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * log error but continue, because we may not be using</span>
<span class="cm">		 * iscsi boot.</span>
<span class="cm">		 */</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Could not set up &quot;</span>
			     <span class="s">&quot;iSCSI boot info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">beiscsi_create_def_ifaces</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\n\n</span><span class="s"> SUCCESS - DRIVER LOADED</span><span class="se">\n\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_blkenbld:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_iopoll_enabled</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">num_cpus</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pbe_eq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phwi_context</span><span class="o">-&gt;</span><span class="n">be_eq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">blk_iopoll_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbe_eq</span><span class="o">-&gt;</span><span class="n">iopoll</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">free_twq:</span>
	<span class="n">beiscsi_clean_port</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="n">beiscsi_free_mem</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
<span class="nl">free_port:</span>
	<span class="n">real_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">csr_va</span> <span class="o">+</span> <span class="n">MPU_EP_SEMAPHORE</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">real_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x00010000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="mh">0xfffeffff</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">real_offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mbox_mem_alloced</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			    <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mbox_mem_alloced</span><span class="p">.</span><span class="n">va</span><span class="p">,</span>
			   <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mbox_mem_alloced</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">beiscsi_unmap_pci_function</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
<span class="nl">hba_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">iscsi_host_remove</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">iscsi_host_free</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">);</span>
<span class="nl">disable_pci:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="n">beiscsi_iscsi_transport</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">CAP_RECOVERY_L0</span> <span class="o">|</span> <span class="n">CAP_HDRDGST</span> <span class="o">|</span> <span class="n">CAP_TEXT_NEGO</span> <span class="o">|</span>
		<span class="n">CAP_MULTI_R2T</span> <span class="o">|</span> <span class="n">CAP_DATADGST</span> <span class="o">|</span> <span class="n">CAP_DATA_PATH_OFFLOAD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_session</span> <span class="o">=</span> <span class="n">beiscsi_session_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_session</span> <span class="o">=</span> <span class="n">beiscsi_session_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_conn</span> <span class="o">=</span> <span class="n">beiscsi_conn_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_conn</span> <span class="o">=</span> <span class="n">beiscsi_conn_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_conn</span> <span class="o">=</span> <span class="n">iscsi_conn_teardown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attr_is_visible</span> <span class="o">=</span> <span class="n">be2iscsi_attr_is_visible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_iface_param</span> <span class="o">=</span> <span class="n">be2iscsi_iface_set_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_iface_param</span> <span class="o">=</span> <span class="n">be2iscsi_iface_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_param</span> <span class="o">=</span> <span class="n">beiscsi_set_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_conn_param</span> <span class="o">=</span> <span class="n">iscsi_conn_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_session_param</span> <span class="o">=</span> <span class="n">iscsi_session_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_host_param</span> <span class="o">=</span> <span class="n">beiscsi_get_host_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_conn</span> <span class="o">=</span> <span class="n">beiscsi_conn_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_conn</span> <span class="o">=</span> <span class="n">iscsi_conn_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_pdu</span> <span class="o">=</span> <span class="n">iscsi_conn_send_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xmit_task</span> <span class="o">=</span> <span class="n">beiscsi_task_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup_task</span> <span class="o">=</span> <span class="n">beiscsi_cleanup_task</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_pdu</span> <span class="o">=</span> <span class="n">beiscsi_alloc_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parse_pdu_itt</span> <span class="o">=</span> <span class="n">beiscsi_parse_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span> <span class="o">=</span> <span class="n">beiscsi_conn_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ep_param</span> <span class="o">=</span> <span class="n">beiscsi_ep_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_connect</span> <span class="o">=</span> <span class="n">beiscsi_ep_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_poll</span> <span class="o">=</span> <span class="n">beiscsi_ep_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_disconnect</span> <span class="o">=</span> <span class="n">beiscsi_ep_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">session_recovery_timedout</span> <span class="o">=</span> <span class="n">iscsi_session_recovery_timedout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_request</span> <span class="o">=</span> <span class="n">beiscsi_bsg_request</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">beiscsi_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">beiscsi_dev_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">beiscsi_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">beiscsi_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">beiscsi_pci_id_table</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">beiscsi_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">beiscsi_scsi_transport</span> <span class="o">=</span>
			<span class="n">iscsi_register_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">beiscsi_iscsi_transport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beiscsi_scsi_transport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;beiscsi_module_init - Unable to  register beiscsi&quot;</span>
			 <span class="s">&quot;transport.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_module_init, tt=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="o">&amp;</span><span class="n">beiscsi_iscsi_transport</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">beiscsi_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;beiscsi_module_init - Unable to  register&quot;</span>
			 <span class="s">&quot;beiscsi pci driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unregister_iscsi_transport</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unregister_iscsi_transport:</span>
	<span class="n">iscsi_unregister_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">beiscsi_iscsi_transport</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">beiscsi_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">beiscsi_pci_driver</span><span class="p">);</span>
	<span class="n">iscsi_unregister_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">beiscsi_iscsi_transport</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">beiscsi_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">beiscsi_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
