<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › be2iscsi › be_cmds.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>be_cmds.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Copyright (C) 2005 - 2011 Emulex</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation.  The full GNU General</span>
<span class="cm"> * Public License is included in this distribution in the file called COPYING.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * linux-drivers@emulex.com</span>
<span class="cm"> *</span>
<span class="cm"> * Emulex</span>
<span class="cm"> * 3333 Susan Street</span>
<span class="cm"> * Costa Mesa, CA 92626</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;scsi/iscsi_proto.h&gt;</span>

<span class="cp">#include &quot;be.h&quot;</span>
<span class="cp">#include &quot;be_mgmt.h&quot;</span>
<span class="cp">#include &quot;be_main.h&quot;</span>

<span class="kt">int</span> <span class="nf">beiscsi_pci_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sreset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pci_reset_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pci_online0_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pci_online1_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pconline0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pconline1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_reset_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pci_va</span> <span class="o">+</span> <span class="n">BE2_SOFT_RESET</span><span class="p">;</span>
	<span class="n">pci_online0_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pci_va</span> <span class="o">+</span> <span class="n">BE2_PCI_ONLINE0</span><span class="p">;</span>
	<span class="n">pci_online1_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pci_va</span> <span class="o">+</span> <span class="n">BE2_PCI_ONLINE1</span><span class="p">;</span>
	<span class="n">sreset</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_reset_offset</span><span class="p">);</span>
	<span class="n">sreset</span> <span class="o">|=</span> <span class="n">BE2_SET_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">sreset</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_reset_offset</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sreset</span> <span class="o">&amp;</span> <span class="n">BE2_SET_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">sreset</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_reset_offset</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sreset</span> <span class="o">&amp;</span> <span class="n">BE2_SET_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Soft Reset  did not deassert</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pconline1</span> <span class="o">=</span> <span class="n">BE2_MPU_IRAM_ONLINE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pconline0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_online0_offset</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pconline1</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_online1_offset</span><span class="p">);</span>

	<span class="n">sreset</span> <span class="o">=</span> <span class="n">BE2_SET_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">sreset</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_reset_offset</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sreset</span> <span class="o">&amp;</span> <span class="n">BE2_SET_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">sreset</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_reset_offset</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sreset</span> <span class="o">&amp;</span> <span class="n">BE2_SET_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPU Online Soft Reset did not deassert</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_chk_reset_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_loop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mpu_sem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">num_loop</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">mpu_sem</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">csr_va</span> <span class="o">+</span> <span class="n">MPU_EP_SEMAPHORE</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">num_loop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mpu_sem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xC000</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
		<span class="n">num_loop</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">num_loop</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed in be_chk_reset_complete&quot;</span>
		<span class="s">&quot;status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_mcc_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">mccq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">DB_MCCQ_RING_ID_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_MCCQ_NUM_POSTED_SHIFT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">+</span> <span class="n">DB_MCCQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">alloc_mcc_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_tag_available</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_tag</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_alloc_index</span><span class="p">];</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_tag</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_alloc_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_tag_available</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_alloc_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">MAX_MCC_CMD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_alloc_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_alloc_index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">free_mcc_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_tag</span><span class="p">[</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_free_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_free_index</span> <span class="o">==</span> <span class="p">(</span><span class="n">MAX_MCC_CMD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_free_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_free_index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_tag_available</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">is_link_state_evt</span><span class="p">(</span><span class="n">u32</span> <span class="n">trailer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">trailer</span> <span class="o">&gt;&gt;</span> <span class="n">ASYNC_TRAILER_EVENT_CODE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		  <span class="n">ASYNC_TRAILER_EVENT_CODE_MASK</span><span class="p">)</span> <span class="o">==</span>
		  <span class="n">ASYNC_EVENT_CODE_LINK_STATE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">be_mcc_compl_is_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">((</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CQE_FLAGS_VALID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">be_mcc_compl_use</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mcc_compl_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">compl_status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">;</span>

	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">compl</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">compl_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">CQE_STATUS_COMPL_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">CQE_STATUS_COMPL_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">compl_status</span> <span class="o">!=</span> <span class="n">MCC_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">extd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">CQE_STATUS_EXTD_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">CQE_STATUS_EXTD_MASK</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;error in cmd completion: status(compl/extd)=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">compl_status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_mcc_compl_process_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">compl_status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tag</span><span class="p">;</span>

	<span class="n">be_dws_le_to_cpu</span><span class="p">(</span><span class="n">compl</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">compl_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">CQE_STATUS_COMPL_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">CQE_STATUS_COMPL_MASK</span><span class="p">;</span>
	<span class="cm">/* The ctrl.mcc_numtag[tag] is filled with</span>
<span class="cm">	 * [31] = valid, [30:24] = Rsvd, [23:16] = wrb, [15:8] = extd_status,</span>
<span class="cm">	 * [7:0] = compl_status</span>
<span class="cm">	 */</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">tag0</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">extd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">CQE_STATUS_EXTD_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">CQE_STATUS_EXTD_MASK</span><span class="p">;</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">tag0</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">);</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">extd_status</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">compl_status</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="nf">be_mcc_compl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mcc_cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span> <span class="o">=</span> <span class="n">queue_tail_node</span><span class="p">(</span><span class="n">mcc_cq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be_mcc_compl_is_new</span><span class="p">(</span><span class="n">compl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_tail_inc</span><span class="p">(</span><span class="n">mcc_cq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">compl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be2iscsi_fail_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iscsi_session_failure</span><span class="p">(</span><span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span> <span class="n">ISCSI_ERR_CONN_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">beiscsi_async_link_state_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">be_async_event_link_state</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">port_link_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ASYNC_EVENT_LINK_DOWN</span>:
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Link Down on Physical Port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">evt</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">BE_ADAPTER_LINK_DOWN</span><span class="p">;</span>
		<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
					    <span class="n">be2iscsi_fail_session</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ASYNC_EVENT_LINK_UP</span>:
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BE_ADAPTER_UP</span><span class="p">;</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Link UP on Physical Port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">evt</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Unexpected Async Notification %d on&quot;</span>
				    <span class="s">&quot;Physical Port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">evt</span><span class="o">-&gt;</span><span class="n">port_link_status</span><span class="p">,</span>
				     <span class="n">evt</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_cq_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="n">u16</span> <span class="n">qid</span><span class="p">,</span> <span class="n">bool</span> <span class="n">arm</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">num_popped</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">qid</span> <span class="o">&amp;</span> <span class="n">DB_CQ_RING_ID_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arm</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DB_CQ_REARM_SHIFT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">num_popped</span> <span class="o">&lt;&lt;</span> <span class="n">DB_CQ_NUM_POPPED_SHIFT</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">db_va</span> <span class="o">+</span> <span class="n">DB_CQ_OFFSET</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">beiscsi_process_mcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_cq_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">compl</span> <span class="o">=</span> <span class="n">be_mcc_compl_get</span><span class="p">(</span><span class="n">phba</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CQE_FLAGS_ASYNC_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Interpret flags as an async trailer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_link_state_evt</span><span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="cm">/* Interpret compl as a async link evt */</span>
				<span class="n">beiscsi_async_link_state_process</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span>
				   <span class="p">(</span><span class="k">struct</span> <span class="n">be_async_event_link_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">compl</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
					 <span class="s">&quot; Unsupported Async Event, flags&quot;</span>
					 <span class="s">&quot; = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">compl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CQE_FLAGS_COMPLETED_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_compl_process</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">compl</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">.</span><span class="n">used</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">be_mcc_compl_use</span><span class="p">(</span><span class="n">compl</span><span class="p">);</span>
		<span class="n">num</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
		<span class="n">beiscsi_cq_notify</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">cq</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_cq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wait till no more pending mcc requests are present */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mcc_wait_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mcc_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_process_mcc</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">.</span><span class="n">used</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">mcc_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mccq poll timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Notify MCC requests and wait for completion */</span>
<span class="kt">int</span> <span class="nf">be_mcc_notify_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">be_mcc_notify</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">be_mcc_wait_compl</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mbox_db_ready_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define long_delay 2000</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">MPU_MAILBOX_DB_OFFSET</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* in usecs */</span>
	<span class="n">u32</span> <span class="n">ready</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ready</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPU_MAILBOX_DB_RDY_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ready</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">12000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mbox_db poll timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wait</span> <span class="o">=</span> <span class="n">long_delay</span><span class="p">;</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="n">long_delay</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">cnt</span> <span class="o">+=</span> <span class="n">wait</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_mbox_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">+</span> <span class="n">MPU_MAILBOX_DB_OFFSET</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mbox_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_mailbox</span> <span class="o">*</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPU_MAILBOX_DB_RDY_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">MPU_MAILBOX_DB_HI_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_db_ready_wait</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot; be_mbox_db_ready_wait failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPU_MAILBOX_DB_RDY_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPU_MAILBOX_DB_HI_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_db_ready_wait</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot; be_mbox_db_ready_wait failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_mcc_compl_is_new</span><span class="p">(</span><span class="n">compl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_compl_process</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">);</span>
		<span class="n">be_mcc_compl_use</span><span class="p">(</span><span class="n">compl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;After be_mcc_compl_process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid mailbox completion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert the mailbox address into the doorbell in two steps</span>
<span class="cm"> * Polls on the mbox doorbell till a command completion (or a timeout) occurs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">be_mbox_notify_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">db</span> <span class="o">+</span> <span class="n">MPU_MAILBOX_DB_OFFSET</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mbox_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mbox_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_mailbox</span> <span class="o">*</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_compl</span> <span class="o">*</span><span class="n">compl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">MPU_MAILBOX_DB_HI_MASK</span><span class="p">;</span>
	<span class="cm">/* at bits 2 - 31 place mbox dma addr msb bits 34 - 63 */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>

	<span class="cm">/* wait for ready to be set */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_db_ready_wait</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* at bits 2 - 31 place mbox dma addr lsb bits 4 - 33 */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_db_ready_wait</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* A cq entry has been made now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be_mcc_compl_is_new</span><span class="p">(</span><span class="n">compl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">be_mcc_compl_process</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">);</span>
		<span class="n">be_mcc_compl_use</span><span class="p">(</span><span class="n">compl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid mailbox completion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_wrb_hdr_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">embedded</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sge_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">embedded</span><span class="p">)</span>
		<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">embedded</span> <span class="o">|=</span> <span class="n">MCC_WRB_EMBEDDED_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">embedded</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sge_cnt</span> <span class="o">&amp;</span> <span class="n">MCC_WRB_SGE_CNT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
						<span class="n">MCC_WRB_SGE_CNT_SHIFT</span><span class="p">;</span>
	<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">payload_length</span> <span class="o">=</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">be_cmd_hdr_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_req_hdr</span> <span class="o">*</span><span class="n">req_hdr</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">subsystem</span><span class="p">,</span> <span class="n">u8</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">req_hdr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">req_hdr</span><span class="o">-&gt;</span><span class="n">subsystem</span> <span class="o">=</span> <span class="n">subsystem</span><span class="p">;</span>
	<span class="n">req_hdr</span><span class="o">-&gt;</span><span class="n">request_length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req_hdr</span><span class="p">));</span>
	<span class="n">req_hdr</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span> <span class="o">*</span><span class="n">pages</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max_pages</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf_pages</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">buf_pages</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span> <span class="n">max_pages</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma</span><span class="p">));</span>
		<span class="n">dma</span> <span class="o">+=</span> <span class="n">PAGE_SIZE_4K</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">eq_delay_to_mult</span><span class="p">(</span><span class="n">u32</span> <span class="n">usec_delay</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define MAX_INTR_RATE 651042</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">round</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">multiplier</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usec_delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">multiplier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">interrupt_rate</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="n">usec_delay</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_INTR_RATE</span> <span class="o">-</span> <span class="n">interrupt_rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">round</span><span class="p">;</span>
			<span class="n">multiplier</span> <span class="o">/=</span> <span class="n">interrupt_rate</span><span class="p">;</span>
			<span class="n">multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">multiplier</span> <span class="o">+</span> <span class="n">round</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">round</span><span class="p">;</span>
			<span class="n">multiplier</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">multiplier</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1023</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">multiplier</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="nf">wrb_from_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">mbox_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">be_mcc_mailbox</span> <span class="o">*</span><span class="p">)(</span><span class="n">mbox_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">wrb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="nf">wrb_from_mccq</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">mccq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_head_node</span><span class="p">(</span><span class="n">mccq</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>
	<span class="n">wrb</span><span class="o">-&gt;</span><span class="n">tag0</span> <span class="o">=</span> <span class="p">(</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">queue_head_inc</span><span class="p">(</span><span class="n">mccq</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wrb</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">beiscsi_cmd_eq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">eq_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_eq_create</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_cmd_resp_eq_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_cmd_eq_create</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>

	<span class="n">be_wrb_hdr_prepare</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_EQ_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_context</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
						<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_context</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_context</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_context</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
					<span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">eq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="mi">256</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_eq_context</span><span class="p">,</span> <span class="n">delaymult</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
					<span class="n">eq_delay_to_mult</span><span class="p">(</span><span class="n">eq_delay</span><span class="p">));</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">eq_id</span><span class="p">);</span>
		<span class="n">eq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_fw_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">endian_check</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In be_cmd_fw_initialize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>

	<span class="n">endian_check</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">wrb</span><span class="p">;</span>
	<span class="o">*</span><span class="n">endian_check</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">endian_check</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="o">*</span><span class="n">endian_check</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">;</span>
	<span class="o">*</span><span class="n">endian_check</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">endian_check</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">endian_check</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x56</span><span class="p">;</span>
	<span class="o">*</span><span class="n">endian_check</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x78</span><span class="p">;</span>
	<span class="o">*</span><span class="n">endian_check</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;be_cmd_fw_initialize Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">beiscsi_cmd_cq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">eq</span><span class="p">,</span>
			  <span class="n">bool</span> <span class="n">sol_evts</span><span class="p">,</span> <span class="n">bool</span> <span class="n">no_delay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">coalesce_wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_cq_create</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_cmd_resp_cq_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_cmd_cq_create</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>

	<span class="n">be_wrb_hdr_prepare</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_CQ_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">)</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;uninitialized q_mem-&gt;va</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context</span><span class="p">,</span> <span class="n">coalescwm</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">coalesce_wm</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context</span><span class="p">,</span> <span class="n">nodelay</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">no_delay</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
		      <span class="n">__ilog2_u32</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="mi">256</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context</span><span class="p">,</span> <span class="n">solevent</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">sol_evts</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context</span><span class="p">,</span> <span class="n">eventable</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context</span><span class="p">,</span> <span class="n">eqid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context</span><span class="p">,</span> <span class="n">armed</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_cq_context</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
		      <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;In be_cmd_cq_create, status=ox%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">be_encoded_q_len</span><span class="p">(</span><span class="kt">int</span> <span class="n">q_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len_encoded</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">q_len</span><span class="p">);</span>	<span class="cm">/* log2(len) + 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len_encoded</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">len_encoded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len_encoded</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">beiscsi_cmd_mccq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_mcc_create</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">be_wrb_hdr_prepare</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			<span class="n">OPCODE_COMMON_MCC_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
		      <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context</span><span class="p">,</span> <span class="n">ring_size</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
		<span class="n">be_encoded_q_len</span><span class="p">(</span><span class="n">mccq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_mcc_context</span><span class="p">,</span> <span class="n">cq_id</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_cmd_resp_mcc_create</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">mccq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">mccq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mbox_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">queue_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_cmd_req_q_destroy</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">subsys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_cmd_q_destroy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>
	<span class="n">be_wrb_hdr_prepare</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">queue_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QTYPE_EQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_COMMON_EQ_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_CQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_COMMON_CQ_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_MCCQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_COMMON_MCC_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_WRBQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_ISCSI</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_COMMON_ISCSI_WRBQ_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_DPDUQ</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_ISCSI</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_COMMON_ISCSI_DEFQ_DESTROY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QTYPE_SGL</span>:
		<span class="n">subsys</span> <span class="o">=</span> <span class="n">CMD_SUBSYSTEM_ISCSI</span><span class="p">;</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_COMMON_ISCSI_CFG_REMOVE_SGL_PAGES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">be_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">subsys</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_type</span> <span class="o">!=</span> <span class="n">QTYPE_SGL</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_create_default_pdu_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">cq</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">dq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">entry_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_defq_create_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dq</span><span class="o">-&gt;</span><span class="n">dma_mem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In be_cmd_create_default_pdu_queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>

	<span class="n">be_wrb_hdr_prepare</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ISCSI</span><span class="p">,</span>
			   <span class="n">OPCODE_COMMON_ISCSI_DEFQ_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_be_default_pdu_context</span><span class="p">,</span> <span class="n">rx_pdid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_be_default_pdu_context</span><span class="p">,</span> <span class="n">rx_pdid_valid</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
		      <span class="mi">1</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_be_default_pdu_context</span><span class="p">,</span> <span class="n">pci_func_id</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
		      <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_be_default_pdu_context</span><span class="p">,</span> <span class="n">ring_size</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
		      <span class="n">be_encoded_q_len</span><span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_addr</span><span class="p">)));</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_be_default_pdu_context</span><span class="p">,</span> <span class="n">default_buffer_size</span><span class="p">,</span>
		      <span class="n">ctxt</span><span class="p">,</span> <span class="n">entry_size</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_be_default_pdu_context</span><span class="p">,</span> <span class="n">cq_id_recv</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span>
		      <span class="n">cq</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">be_dws_cpu_to_le</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>

	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">be_defq_create_resp</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

		<span class="n">dq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">dq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_wrbq_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">wrbq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_wrbq_create_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_wrbq_create_resp</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>

	<span class="n">be_wrb_hdr_prepare</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">be_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ISCSI</span><span class="p">,</span>
		<span class="n">OPCODE_COMMON_ISCSI_WRBQ_CREATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">PAGES_4K_SPANNED</span><span class="p">(</span><span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">,</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">),</span> <span class="n">q_mem</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrbq</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">);</span>
		<span class="n">wrbq</span><span class="o">-&gt;</span><span class="n">created</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be_cmd_iscsi_post_sgl_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="o">*</span><span class="n">q_mem</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">page_offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num_pages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_post_sgl_pages_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">curr_pages</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">internal_page_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_num_pages</span> <span class="o">=</span> <span class="n">num_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_pages</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">num_pages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wrb</span><span class="p">));</span>
		<span class="n">be_wrb_hdr_prepare</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">be_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_ISCSI</span><span class="p">,</span>
				   <span class="n">OPCODE_COMMON_ISCSI_CFG_POST_SGL_PAGES</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
		<span class="n">curr_pages</span> <span class="o">=</span> <span class="n">BE_NUMBER_OF_FIELD</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_post_sgl_pages_req</span><span class="p">,</span>
						<span class="n">pages</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">num_pages</span><span class="p">,</span> <span class="n">curr_pages</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">page_offset</span> <span class="o">=</span> <span class="n">page_offset</span><span class="p">;</span>
		<span class="n">be_cmd_page_addrs_prepare</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">,</span> <span class="n">q_mem</span><span class="p">);</span>
		<span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">q_mem</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">internal_page_offset</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">;</span>
		<span class="n">page_offset</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">;</span>
		<span class="n">num_pages</span> <span class="o">-=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp_num_pages</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">temp_num_pages</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
				 <span class="s">&quot;FW CMD to map iscsi frags failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">num_pages</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">beiscsi_cmd_q_destroy</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">QTYPE_SGL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">beiscsi_cmd_reset_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span>  <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_ctrl_info</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span> <span class="o">=</span> <span class="n">wrb_from_mbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_mem</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_post_sgl_pages_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">be_wrb_hdr_prepare</span><span class="p">(</span><span class="n">wrb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">be_cmd_hdr_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">CMD_SUBSYSTEM_COMMON</span><span class="p">,</span>
			   <span class="n">OPCODE_COMMON_FUNCTION_RESET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">be_mbox_notify_wait</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mbox_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
