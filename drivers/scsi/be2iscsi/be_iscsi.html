<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › be2iscsi › be_iscsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>be_iscsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Copyright (C) 2005 - 2011 Emulex</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation.  The full GNU General</span>
<span class="cm"> * Public License is included in this distribution in the file called COPYING.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by: Jayamohan Kallickal (jayamohan.kallickal@emulex.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * linux-drivers@emulex.com</span>
<span class="cm"> *</span>
<span class="cm"> * Emulex</span>
<span class="cm"> * 3333 Susan Street</span>
<span class="cm"> * Costa Mesa, CA 92626</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;scsi/libiscsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_iscsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_netlink.h&gt;</span>
<span class="cp">#include &lt;net/netlink.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>

<span class="cp">#include &quot;be_iscsi.h&quot;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="n">beiscsi_iscsi_transport</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_session_create - creates a new iscsi session</span>
<span class="cm"> * @cmds_max: max commands supported</span>
<span class="cm"> * @qdepth: max queue depth supported</span>
<span class="cm"> * @initial_cmdsn: initial iscsi CMDSN</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="nf">beiscsi_session_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
						 <span class="n">u16</span> <span class="n">cmds_max</span><span class="p">,</span>
						 <span class="n">u16</span> <span class="n">qdepth</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="n">initial_cmdsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_session</span> <span class="o">*</span><span class="n">beiscsi_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_io_task</span> <span class="o">*</span><span class="n">io_task</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_session_create</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;beiscsi_session_create: invalid ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">shost</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmds_max</span> <span class="o">&gt;</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Cannot handle %d cmds.&quot;</span>
			     <span class="s">&quot;Max cmds per session supported is %d. Using %d. &quot;</span>
			     <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmds_max</span><span class="p">,</span>
			      <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">,</span>
			      <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">);</span>
		<span class="n">cmds_max</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">wrbs_per_cxn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cls_session</span> <span class="o">=</span> <span class="n">iscsi_session_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">beiscsi_iscsi_transport</span><span class="p">,</span>
					  <span class="n">shost</span><span class="p">,</span> <span class="n">cmds_max</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">beiscsi_sess</span><span class="p">),</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">io_task</span><span class="p">),</span>
					  <span class="n">initial_cmdsn</span><span class="p">,</span> <span class="n">ISCSI_MAX_TARGET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_session</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">beiscsi_sess</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">beiscsi_sess</span><span class="o">-&gt;</span><span class="n">bhs_pool</span> <span class="o">=</span>  <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;beiscsi_bhs_pool&quot;</span><span class="p">,</span>
						   <span class="n">phba</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">be_cmd_bhs</span><span class="p">),</span>
						   <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beiscsi_sess</span><span class="o">-&gt;</span><span class="n">bhs_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">destroy_sess</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cls_session</span><span class="p">;</span>
<span class="nl">destroy_sess:</span>
	<span class="n">iscsi_session_teardown</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_session_destroy - destroys iscsi session</span>
<span class="cm"> * @cls_session:	pointer to iscsi cls session</span>
<span class="cm"> *</span>
<span class="cm"> * Destroys iSCSI session instance and releases</span>
<span class="cm"> * resources allocated for it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">beiscsi_session_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_session</span> <span class="o">*</span><span class="n">beiscsi_sess</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_session_destroy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">beiscsi_sess</span><span class="o">-&gt;</span><span class="n">bhs_pool</span><span class="p">);</span>
	<span class="n">iscsi_session_teardown</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_conn_create - create an instance of iscsi connection</span>
<span class="cm"> * @cls_session: ptr to iscsi_cls_session</span>
<span class="cm"> * @cid: iscsi cid</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span>
<span class="nf">beiscsi_conn_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_session</span> <span class="o">*</span><span class="n">beiscsi_sess</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_conn_create ,cid&quot;</span>
		 <span class="s">&quot;from iscsi layer=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
	<span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_session_to_shost</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">cls_conn</span> <span class="o">=</span> <span class="n">iscsi_conn_setup</span><span class="p">(</span><span class="n">cls_session</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">),</span> <span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">phba</span> <span class="o">=</span> <span class="n">phba</span><span class="p">;</span>
	<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">beiscsi_sess</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_sess</span> <span class="o">=</span> <span class="n">beiscsi_sess</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cls_conn</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_bindconn_cid - Bind the beiscsi_conn with phba connection table</span>
<span class="cm"> * @beiscsi_conn: The pointer to  beiscsi_conn structure</span>
<span class="cm"> * @phba: The phba instance</span>
<span class="cm"> * @cid: The cid to free</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_bindconn_cid</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">conn_table</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;Connection table already occupied. Detected clash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;phba-&gt;conn_table[%d]=%p(beiscsi_conn)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">cid</span><span class="p">,</span> <span class="n">beiscsi_conn</span><span class="p">);</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">conn_table</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_conn_bind - Binds iscsi session/connection with TCP connection</span>
<span class="cm"> * @cls_session: pointer to iscsi cls session</span>
<span class="cm"> * @cls_conn: pointer to iscsi cls conn</span>
<span class="cm"> * @transport_fd: EP handle(64 bit)</span>
<span class="cm"> *</span>
<span class="cm"> * This function binds the TCP Conn with iSCSI Connection and Session.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">beiscsi_conn_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="n">transport_fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_leading</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_session_to_shost</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_conn_bind</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">iscsi_lookup_endpoint</span><span class="p">(</span><span class="n">transport_fd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_conn_bind</span><span class="p">(</span><span class="n">cls_session</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">,</span> <span class="n">is_leading</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span> <span class="o">!=</span> <span class="n">phba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span>
			 <span class="s">&quot;beiscsi_ep-&gt;hba=%p not equal to phba=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">,</span> <span class="n">phba</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">beiscsi_conn_cid</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">;</span>
	<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="p">;</span>
	<span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="p">;</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;beiscsi_conn=%p conn=%p ep_cid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">beiscsi_bindconn_cid</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_conn</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_create_ipv4_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv4_iface</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv4_iface</span> <span class="o">=</span> <span class="n">iscsi_create_iface</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">beiscsi_iscsi_transport</span><span class="p">,</span>
					      <span class="n">ISCSI_IFACE_TYPE_IPV4</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv4_iface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Could not &quot;</span>
			     <span class="s">&quot;create default IPv4 address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_create_ipv6_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv6_iface</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv6_iface</span> <span class="o">=</span> <span class="n">iscsi_create_iface</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">beiscsi_iscsi_transport</span><span class="p">,</span>
					      <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv6_iface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Could not &quot;</span>
			     <span class="s">&quot;create default IPv6 address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">beiscsi_create_def_ifaces</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_cmd_get_if_info_resp</span> <span class="n">if_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mgmt_get_if_info</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">BE2_IPV4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_info</span><span class="p">))</span>
		<span class="n">beiscsi_create_ipv4_iface</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mgmt_get_if_info</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">BE2_IPV6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_info</span><span class="p">))</span>
		<span class="n">beiscsi_create_ipv6_iface</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">beiscsi_destroy_def_ifaces</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv6_iface</span><span class="p">)</span>
		<span class="n">iscsi_destroy_iface</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv6_iface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv4_iface</span><span class="p">)</span>
		<span class="n">iscsi_destroy_iface</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv4_iface</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">beiscsi_set_static_ip</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iscsi_iface_param_info</span> <span class="o">*</span><span class="n">iface_param</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">dt_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_iface_param_info</span> <span class="o">*</span><span class="n">iface_ip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_iface_param_info</span> <span class="o">*</span><span class="n">iface_subnet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">nla</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_BOOTPROTO</span>:
		<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_find</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dt_len</span><span class="p">,</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla</span><span class="p">)</span>
			<span class="n">iface_ip</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>

		<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_find</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dt_len</span><span class="p">,</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla</span><span class="p">)</span>
			<span class="n">iface_subnet</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span>:
		<span class="n">iface_ip</span> <span class="o">=</span> <span class="n">iface_param</span><span class="p">;</span>
		<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_find</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dt_len</span><span class="p">,</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla</span><span class="p">)</span>
			<span class="n">iface_subnet</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span>:
		<span class="n">iface_subnet</span> <span class="o">=</span> <span class="n">iface_param</span><span class="p">;</span>
		<span class="n">nla</span> <span class="o">=</span> <span class="n">nla_find</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dt_len</span><span class="p">,</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nla</span><span class="p">)</span>
			<span class="n">iface_ip</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">nla</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Unsupported param %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iface_ip</span> <span class="o">||</span> <span class="o">!</span><span class="n">iface_subnet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;IP and Subnet Mask required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgmt_set_ip</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">iface_ip</span><span class="p">,</span> <span class="n">iface_subnet</span><span class="p">,</span>
			<span class="n">ISCSI_BOOTPROTO_STATIC</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">beiscsi_set_ipv4</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iscsi_iface_param_info</span> <span class="o">*</span><span class="n">iface_param</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">dt_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check the param */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_GW</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgmt_set_gateway</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">iface_param</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_BOOTPROTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_BOOTPROTO_DHCP</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mgmt_set_ip</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">iface_param</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="n">ISCSI_BOOTPROTO_DHCP</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_BOOTPROTO_STATIC</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_set_static_ip</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">iface_param</span><span class="p">,</span>
						    <span class="n">data</span><span class="p">,</span> <span class="n">dt_len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Invalid BOOTPROTO: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IFACE_ENABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_ENABLE</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_create_ipv4_iface</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">iscsi_destroy_iface</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv4_iface</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span>:
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_set_static_ip</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">iface_param</span><span class="p">,</span>
					    <span class="n">data</span><span class="p">,</span> <span class="n">dt_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Param %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">beiscsi_set_ipv6</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iscsi_iface_param_info</span> <span class="o">*</span><span class="n">iface_param</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">dt_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IFACE_ENABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_ENABLE</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_create_ipv6_iface</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">iscsi_destroy_iface</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ipv6_iface</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgmt_set_ip</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">iface_param</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				  <span class="n">ISCSI_BOOTPROTO_STATIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Param %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be2iscsi_iface_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">dt_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_iface_param_info</span> <span class="o">*</span><span class="n">iface_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attrib</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rm_len</span> <span class="o">=</span> <span class="n">dt_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="n">nla_for_each_attr</span><span class="p">(</span><span class="n">attrib</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dt_len</span><span class="p">,</span> <span class="n">rm_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iface_param</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attrib</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param_type</span> <span class="o">!=</span> <span class="n">ISCSI_NET_PARAM</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * BE2ISCSI only supports 1 interface</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="s">&quot;Invalid iface_num %d.&quot;</span>
				     <span class="s">&quot;Only iface_num 0 is supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_IFACE_TYPE_IPV4</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_set_ipv4</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">iface_param</span><span class="p">,</span>
					       <span class="n">data</span><span class="p">,</span> <span class="n">dt_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_IFACE_TYPE_IPV6</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_set_ipv6</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">iface_param</span><span class="p">,</span>
					       <span class="n">data</span><span class="p">,</span> <span class="n">dt_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span>
				     <span class="s">&quot;Invalid iface type :%d passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">be2iscsi_get_if_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_cmd_get_if_info_resp</span> <span class="n">if_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ip_type</span> <span class="o">=</span> <span class="n">BE2_IPV4</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">if_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">if_info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">)</span>
		<span class="n">ip_type</span> <span class="o">=</span> <span class="n">BE2_IPV6</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">mgmt_get_if_info</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">ip_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_info</span><span class="p">.</span><span class="n">ip_addr</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_info</span><span class="p">.</span><span class="n">ip_addr</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_BOOTPROTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">if_info</span><span class="p">.</span><span class="n">dhcp_state</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;static&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;dhcp&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">if_info</span><span class="p">.</span><span class="n">ip_addr</span><span class="p">.</span><span class="n">subnet_mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">be2iscsi_iface_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">iscsi_param_type</span> <span class="n">param_type</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_iface_to_shost</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">be_cmd_get_def_gateway_resp</span> <span class="n">gateway</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span>:
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span>:
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_BOOTPROTO</span>:
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">be2iscsi_get_if_param</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">iface</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IFACE_ENABLE</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;enabled&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_GW</span>:
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gateway</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gateway</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">mgmt_get_gateway</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">BE2_IPV4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gateway</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gateway</span><span class="p">.</span><span class="n">ip_addr</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_ep_get_param - get the iscsi parameter</span>
<span class="cm"> * @ep: pointer to iscsi ep</span>
<span class="cm"> * @param: parameter type identifier</span>
<span class="cm"> * @buf: buffer pointer</span>
<span class="cm"> *</span>
<span class="cm"> * returns iscsi parameter</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">beiscsi_ep_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_ep_get_param, param= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_PORT</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">dst_tcpport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_ADDRESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ip_type</span> <span class="o">==</span> <span class="n">BE2_IPV4</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">dst6_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">beiscsi_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_conn_set_param, param= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If userspace tried to set the value to higher than we can</span>
<span class="cm">	 * support override here.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_FIRST_BURST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">first_burst</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">)</span>
			<span class="n">session</span><span class="o">-&gt;</span><span class="n">first_burst</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_RECV_DLENGTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">)</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_BURST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">max_burst</span> <span class="o">&gt;</span> <span class="mi">262144</span><span class="p">)</span>
			<span class="n">session</span><span class="o">-&gt;</span><span class="n">max_burst</span> <span class="o">=</span> <span class="mi">262144</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_XMIT_DLENGTH</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_get_initname - Read Initiator Name from flash</span>
<span class="cm"> * @buf: buffer bointer</span>
<span class="cm"> * @phba: The device priv structure instance</span>
<span class="cm"> *</span>
<span class="cm"> * returns number of bytes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_get_initname</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">wrb_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_hba_name</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">be_cmd_get_initname</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Getting Initiator Name Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>

	<span class="n">wrb_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">extd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="n">extd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;MailBox Command Failed with &quot;</span>
				<span class="s">&quot;status = %d extd_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_get_wrb</span><span class="p">(</span><span class="n">mccq</span><span class="p">,</span> <span class="n">wrb_num</span><span class="p">);</span>
	<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">initiator_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_get_port_state - Get the Port State</span>
<span class="cm"> * @shost : pointer to scsi_host structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns number of bytes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_get_port_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">shost_data</span><span class="p">;</span>

	<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BE_ADAPTER_UP</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">ISCSI_PORT_STATE_UP</span> <span class="o">:</span> <span class="n">ISCSI_PORT_STATE_DOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_get_port_speed  - Get the Port Speed from Adapter</span>
<span class="cm"> * @shost : pointer to scsi_host structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns Success/Failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_get_port_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">wrb_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_cmd_ntwk_link_status_resp</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">shost_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">be_cmd_get_port_speed</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Getting Port Speed Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	 <span class="p">}</span> <span class="k">else</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
				<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>

	<span class="n">wrb_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">extd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="n">extd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;MailBox Command Failed with &quot;</span>
				<span class="s">&quot;status = %d extd_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_get_wrb</span><span class="p">(</span><span class="n">mccq</span><span class="p">,</span> <span class="n">wrb_num</span><span class="p">);</span>
	<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">mac_speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BE2ISCSI_LINK_SPEED_10MBPS</span>:
		<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">ISCSI_PORT_SPEED_10MBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE2ISCSI_LINK_SPEED_100MBPS</span>:
		<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">BE2ISCSI_LINK_SPEED_100MBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE2ISCSI_LINK_SPEED_1GBPS</span>:
		<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">ISCSI_PORT_SPEED_1GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE2ISCSI_LINK_SPEED_10GBPS</span>:
		<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">ISCSI_PORT_SPEED_10GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">ISCSI_PORT_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_get_host_param - get the iscsi parameter</span>
<span class="cm"> * @shost: pointer to scsi_host structure</span>
<span class="cm"> * @param: parameter type identifier</span>
<span class="cm"> * @buf: buffer pointer</span>
<span class="cm"> *</span>
<span class="cm"> * returns host parameter</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">beiscsi_get_host_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_get_host_param, param= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_HWADDRESS</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_get_macaddr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">phba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;beiscsi_get_macaddr Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_INITIATOR_NAME</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_get_initname</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">phba</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
					<span class="s">&quot;Retreiving Initiator Name Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_PORT_STATE</span>:
		<span class="n">beiscsi_get_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_get_port_state_name</span><span class="p">(</span><span class="n">shost</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_PORT_SPEED</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">beiscsi_get_port_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
					<span class="s">&quot;Retreiving Port Speed Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_get_port_speed_name</span><span class="p">(</span><span class="n">shost</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">iscsi_host_get_param</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">beiscsi_get_macaddr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">be_cmd_get_nic_conf_resp</span> <span class="n">resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">strlcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mgmt_get_nic_conf</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">resp</span><span class="p">.</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sysfs_format_mac</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_conn_get_stats - get the iscsi stats</span>
<span class="cm"> * @cls_conn: pointer to iscsi cls conn</span>
<span class="cm"> * @stats: pointer to iscsi_stats structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns iscsi stats</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">beiscsi_conn_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iscsi_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_conn_get_stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">txdata_octets</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">txdata_octets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dataout_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dataout_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">scsirsp_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">scsirsp_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">scsicmd_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">scsicmd_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">datain_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">datain_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmfrsp_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tmfrsp_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmfcmd_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">tmfcmd_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">r2t_pdus</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">r2t_pdus_cnt</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">digest_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">timeout_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="s">&quot;eh_abort_cnt&quot;</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">custom</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">eh_abort_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_set_params_for_offld - get the parameters for offload</span>
<span class="cm"> * @beiscsi_conn: pointer to beiscsi_conn</span>
<span class="cm"> * @params: pointer to offload_params structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="nf">beiscsi_set_params_for_offld</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">beiscsi_offload_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>

	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span> <span class="n">max_burst_length</span><span class="p">,</span>
		      <span class="n">params</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">max_burst</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span>
		      <span class="n">max_send_data_segment_length</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
		      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span> <span class="n">first_burst_length</span><span class="p">,</span>
		      <span class="n">params</span><span class="p">,</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">first_burst</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span> <span class="n">erl</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
		      <span class="n">session</span><span class="o">-&gt;</span><span class="n">erl</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span> <span class="n">dde</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
		      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">datadgst_en</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span> <span class="n">hde</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
		      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hdrdgst_en</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span> <span class="n">ir2t</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
		      <span class="n">session</span><span class="o">-&gt;</span><span class="n">initial_r2t_en</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span> <span class="n">imd</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
		      <span class="n">session</span><span class="o">-&gt;</span><span class="n">imm_data_en</span><span class="p">);</span>
	<span class="n">AMAP_SET_BITS</span><span class="p">(</span><span class="k">struct</span> <span class="n">amap_beiscsi_offload_params</span><span class="p">,</span> <span class="n">exp_statsn</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">exp_statsn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_conn_start - offload of session to chip</span>
<span class="cm"> * @cls_conn: pointer to beiscsi_conn</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">beiscsi_conn_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_offload_params</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_conn_start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_offload_params</span><span class="p">));</span>
	<span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beiscsi_ep</span><span class="p">)</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;In beiscsi_conn_start , no beiscsi_ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">login_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">beiscsi_set_params_for_offld</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="n">beiscsi_offload_connection</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="n">iscsi_conn_start</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_get_cid - Allocate a cid</span>
<span class="cm"> * @phba: The phba instance</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_get_cid</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cid</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">avlbl_cids</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cid</span><span class="p">;</span>

	<span class="n">cid</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_array</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_alloc</span><span class="o">++</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_alloc</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">avlbl_cids</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_put_cid - Free the cid</span>
<span class="cm"> * @phba: The phba for which the cid is being freed</span>
<span class="cm"> * @cid: The cid to free</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_put_cid</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">avlbl_cids</span><span class="o">++</span><span class="p">;</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_array</span><span class="p">[</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_free</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_free</span> <span class="o">==</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span><span class="p">)</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">cid_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_free_ep - free endpoint</span>
<span class="cm"> * @ep:	pointer to iscsi endpoint structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">beiscsi_free_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="n">beiscsi_put_cid</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
	<span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_open_conn - Ask FW to open a TCP connection</span>
<span class="cm"> * @ep:	endpoint to be used</span>
<span class="cm"> * @src_addr: The source IP address</span>
<span class="cm"> * @dst_addr: The Destination  IP address</span>
<span class="cm"> *</span>
<span class="cm"> * Asks the FW to open a TCP connection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_open_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">src_addr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">non_blocking</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_queue_info</span> <span class="o">*</span><span class="n">mccq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_obj</span><span class="p">.</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_mcc_wrb</span> <span class="o">*</span><span class="n">wrb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcp_connect_and_offload_out</span> <span class="o">*</span><span class="n">ptcpcnct_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">be_dma_mem</span> <span class="n">nonemb_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">wrb_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_open_conn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span> <span class="o">=</span> <span class="n">beiscsi_get_cid</span><span class="p">(</span><span class="n">phba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;No free cid available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_open_conn, ep_cid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
	<span class="n">phba</span><span class="o">-&gt;</span><span class="n">ep_array</span><span class="p">[</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span> <span class="o">-</span>
		       <span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span><span class="p">]</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">fw_config</span><span class="p">.</span><span class="n">iscsi_cid_start</span> <span class="o">+</span>
				  <span class="n">phba</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cxns_per_ctrl</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Failed in allocate iscsi cid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_ep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">cid_vld</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_connect_and_offload_in</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;Failed to allocate memory for mgmt_open_connection&quot;</span>
			 <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">beiscsi_put_cid</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcp_connect_and_offload_in</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">mgmt_open_connection</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nonemb_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;mgmt_open_connection Failed for cid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
		<span class="n">beiscsi_put_cid</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
					 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">wrb_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">extd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="n">extd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;mgmt_open_connection Failed&quot;</span>
				    <span class="s">&quot; status = %d extd_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">status</span><span class="p">,</span> <span class="n">extd_status</span><span class="p">);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_ep</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wrb</span> <span class="o">=</span> <span class="n">queue_get_wrb</span><span class="p">(</span><span class="n">mccq</span><span class="p">,</span> <span class="n">wrb_num</span><span class="p">);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

		<span class="n">ptcpcnct_out</span> <span class="o">=</span> <span class="n">embedded_payload</span><span class="p">(</span><span class="n">wrb</span><span class="p">);</span>
		<span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">fw_handle</span> <span class="o">=</span> <span class="n">ptcpcnct_out</span><span class="o">-&gt;</span><span class="n">connection_handle</span><span class="p">;</span>
		<span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">cid_vld</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;mgmt_open_connection Success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			    <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">va</span><span class="p">,</span> <span class="n">nonemb_cmd</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_ep:</span>
	<span class="n">beiscsi_free_ep</span><span class="p">(</span><span class="n">beiscsi_ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_ep_connect - Ask chip to create TCP Conn</span>
<span class="cm"> * @scsi_host: Pointer to scsi_host structure</span>
<span class="cm"> * @dst_addr: The IP address of Target</span>
<span class="cm"> * @non_blocking: blocking or non-blocking call</span>
<span class="cm"> *</span>
<span class="cm"> * This routines first asks chip to create a connection and then allocates an EP</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span>
<span class="nf">beiscsi_ep_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">non_blocking</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_ep_connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="p">)</span>
		<span class="n">phba</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;shost is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BE_ADAPTER_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;The Adapter state is Not UP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">iscsi_create_endpoint</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_endpoint</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span> <span class="o">=</span> <span class="n">phba</span><span class="p">;</span>
	<span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">openiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">beiscsi_open_conn</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">non_blocking</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span> <span class="s">&quot;Failed in beiscsi_open_conn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_ep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>

<span class="nl">free_ep:</span>
	<span class="n">iscsi_destroy_endpoint</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_ep_poll - Poll to see if connection is established</span>
<span class="cm"> * @ep:	endpoint to be used</span>
<span class="cm"> * @timeout_ms: timeout specified in millisecs</span>
<span class="cm"> *</span>
<span class="cm"> * Poll to see if TCP connection established</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">beiscsi_ep_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In  beiscsi_ep_poll</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">cid_vld</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_close_conn - Upload the  connection</span>
<span class="cm"> * @ep: The iscsi endpoint</span>
<span class="cm"> * @flag: The type of connection closure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_close_conn</span><span class="p">(</span><span class="k">struct</span>  <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">mgmt_upload_connection</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;upload failed for cid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
					 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_unbind_conn_to_cid - Unbind the beiscsi_conn from phba conn table</span>
<span class="cm"> * @phba: The phba instance</span>
<span class="cm"> * @cid: The cid to free</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">beiscsi_unbind_conn_to_cid</span><span class="p">(</span><span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">conn_table</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span>
		<span class="n">phba</span><span class="o">-&gt;</span><span class="n">conn_table</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;Connection table Not occupied.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * beiscsi_ep_disconnect - Tears down the TCP connection</span>
<span class="cm"> * @ep:	endpoint to be used</span>
<span class="cm"> *</span>
<span class="cm"> * Tears down the TCP connection</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">beiscsi_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">beiscsi_conn</span> <span class="o">*</span><span class="n">beiscsi_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_endpoint</span> <span class="o">*</span><span class="n">beiscsi_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">beiscsi_hba</span> <span class="o">*</span><span class="n">phba</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">savecfg_flag</span> <span class="o">=</span> <span class="n">CMD_ISCSI_SESSION_SAVE_CFG_ON_FLASH</span><span class="p">;</span>

	<span class="n">beiscsi_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">phba</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">phba</span><span class="p">;</span>
	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_ep_disconnect for ep_cid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_ep_disconnect, no &quot;</span>
			 <span class="s">&quot;beiscsi_ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">beiscsi_conn</span> <span class="o">=</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">iscsi_suspend_queue</span><span class="p">(</span><span class="n">beiscsi_conn</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">);</span>

	<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_8</span><span class="p">,</span> <span class="s">&quot;In beiscsi_ep_disconnect ep_cid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">mgmt_invalidate_connection</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="p">,</span>
					    <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">savecfg_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SE_DEBUG</span><span class="p">(</span><span class="n">DBG_LVL_1</span><span class="p">,</span>
			 <span class="s">&quot;mgmt_invalidate_connection Failed for cid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_wait</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span>
					 <span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">mcc_numtag</span><span class="p">[</span><span class="n">tag</span><span class="p">]);</span>
		<span class="n">free_mcc_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phba</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">beiscsi_close_conn</span><span class="p">(</span><span class="n">beiscsi_ep</span><span class="p">,</span> <span class="n">CONNECTION_UPLOAD_GRACEFUL</span><span class="p">);</span>
	<span class="n">beiscsi_free_ep</span><span class="p">(</span><span class="n">beiscsi_ep</span><span class="p">);</span>
	<span class="n">beiscsi_unbind_conn_to_cid</span><span class="p">(</span><span class="n">phba</span><span class="p">,</span> <span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">ep_cid</span><span class="p">);</span>
	<span class="n">iscsi_destroy_endpoint</span><span class="p">(</span><span class="n">beiscsi_ep</span><span class="o">-&gt;</span><span class="n">openiscsi_ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">umode_t</span> <span class="nf">be2iscsi_attr_is_visible</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IFACE_ENABLE</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_BOOTPROTO</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_GW</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_HWADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_INITIATOR_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_PORT_STATE</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_PORT_SPEED</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_RECV_DLENGTH</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_XMIT_DLENGTH</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_HDRDGST_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_DATADGST_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_ADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_PORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_EXP_STATSN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PERSISTENT_ADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PERSISTENT_PORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PING_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_RECV_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_INITIAL_R2T_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_R2T</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_IMM_DATA_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_FIRST_BURST</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_BURST</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PDU_INORDER_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_DATASEQ_INORDER_EN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_ERL</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TARGET_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TPGT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_USERNAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PASSWORD</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_USERNAME_IN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PASSWORD_IN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_FAST_ABORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_ABORT_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_LU_RESET_TMO</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_IFACE_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_INITIATOR_NAME</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
