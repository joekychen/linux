<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › script_asm.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>script_asm.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl -s</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>NCR 53c810 script assembler
Sponsored by 
      iX Multiuser Multitasking Magazine</p>

<p>Copyright 1993, Drew Eckhardt
     Visionary Computing 
     (Unix and Linux consulting and custom programming)
     drew@Colorado.EDU
     +1 (303) 786-7975 </p>

<p>Support for 53c710 (via -ncr7x0_family switch) added by Richard
  Hirst <a href="&#109;&#x61;&#x69;&#x6C;&#116;&#111;:r&#x69;&#x63;&#x68;&#x61;&#x72;&#x64;&#x40;&#x73;&#108;&#101;&#101;&#x70;&#105;&#101;&#46;&#100;&#x65;&#109;&#x6F;&#x6E;&#x2E;&#99;&#x6F;&#46;&#117;&#x6B;">r&#x69;&#x63;&#x68;&#x61;&#x72;&#x64;&#x40;&#x73;&#108;&#101;&#101;&#x70;&#105;&#101;&#46;&#100;&#x65;&#109;&#x6F;&#x6E;&#x2E;&#99;&#x6F;&#46;&#117;&#x6B;</a> - 15th March 1997</p>

<p>This program is free software; you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation; either version 2 of the License, or
  (at your option) any later version.</p>

<p>This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</p>

<p>TolerANT and SCSI SCRIPTS are registered trademarks of NCR Corporation.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Basically, I follow the NCR syntax documented in the NCR53c710 
Programmer's guide, with the new instructions, registers, etc.
from the NCR53c810.</p>

<p>Differences between this assembler and NCR's are that 
1.  PASS, REL (data, JUMPs work fine), and the option to start a new 
script,  are unimplemented, since I didn't use them in my scripts.</p>

<ol>
<li><p>I also emit a script<em>u.h file, which will undefine all of 
the A</em><em>, E_</em>, etc. symbols defined in the script.  This 
makes including multiple scripts in one program easier</p></li>
<li><p>This is a single pass assembler, which only emits 
.h files.</p></li>
</ol></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>XXX - set these with command line options</p></td><td class="code"><div class="highlight"><pre><span class="nv">$debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="c1"># Print general debugging messages</span>
<span class="nv">$debug_external</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1"># Print external/forward reference messages</span>
<span class="nv">$list_in_array</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="c1"># Emit original SCRIPTS assembler in comments in</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>script.h
$prefix;        # (set by perl -s)
define all arrays having this prefix so we 
don't have name space collisions after 
assembling this file in different ways for
different host adapters</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Constants</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Table of the SCSI phase encodings</p></td><td class="code"><div class="highlight"><pre><span class="nv">%scsi_phases</span> <span class="o">=</span> <span class="p">(</span> 			
    <span class="s">&#39;DATA_OUT&#39;</span><span class="p">,</span> <span class="mh">0x00_00_00_00</span><span class="p">,</span> <span class="s">&#39;DATA_IN&#39;</span><span class="p">,</span> <span class="mh">0x01_00_00_00</span><span class="p">,</span> <span class="s">&#39;CMD&#39;</span><span class="p">,</span> <span class="mh">0x02_00_00_00</span><span class="p">,</span>
    <span class="s">&#39;STATUS&#39;</span><span class="p">,</span> <span class="mh">0x03_00_00_00</span><span class="p">,</span> <span class="s">&#39;MSG_OUT&#39;</span><span class="p">,</span> <span class="mh">0x06_00_00_00</span><span class="p">,</span> <span class="s">&#39;MSG_IN&#39;</span><span class="p">,</span> <span class="mh">0x07_00_00_00</span>
<span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>XXX - replace references to the *_810 constants with general constants
assigned at compile time based on chip type.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Table of operator encodings
XXX - NCR53c710 only implements 
    move (nop) = 0x00<em>00</em>00<em>00
or = 0x02</em>00<em>00</em>00
    and = 0x04<em>00</em>00<em>00
    add = 0x06</em>00<em>00</em>00</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nv">$ncr7x0_family</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">%operators</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;|&#39;</span><span class="p">,</span> <span class="mh">0x02_00_00_00</span><span class="p">,</span> <span class="s">&#39;OR&#39;</span><span class="p">,</span> <span class="mh">0x02_00_00_00</span><span class="p">,</span>
    <span class="s">&#39;&amp;&#39;</span><span class="p">,</span> <span class="mh">0x04_00_00_00</span><span class="p">,</span> <span class="s">&#39;AND&#39;</span><span class="p">,</span> <span class="mh">0x04_00_00_00</span><span class="p">,</span>
    <span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="mh">0x06_00_00_00</span>
  <span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="nv">%operators</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;SHL&#39;</span><span class="p">,</span>  <span class="mh">0x01_00_00_00</span><span class="p">,</span> 
    <span class="s">&#39;|&#39;</span><span class="p">,</span> <span class="mh">0x02_00_00_00</span><span class="p">,</span> <span class="s">&#39;OR&#39;</span><span class="p">,</span> <span class="mh">0x02_00_00_00</span><span class="p">,</span> 
    <span class="s">&#39;XOR&#39;</span><span class="p">,</span> <span class="mh">0x03_00_00_00</span><span class="p">,</span> 
    <span class="s">&#39;&amp;&#39;</span><span class="p">,</span> <span class="mh">0x04_00_00_00</span><span class="p">,</span> <span class="s">&#39;AND&#39;</span><span class="p">,</span> <span class="mh">0x04_00_00_00</span><span class="p">,</span> 
    <span class="s">&#39;SHR&#39;</span><span class="p">,</span> <span class="mh">0x05_00_00_00</span><span class="p">,</span> </pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Note : low bit of the operator bit should be set for add with 
carry.</p></td><td class="code"><div class="highlight"><pre>    <span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="mh">0x06_00_00_00</span> 
  <span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Table of register addresses</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nv">$ncr7x0_family</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">%registers</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;SCNTL0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;SCNTL1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;SDID&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;SIEN&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s">&#39;SCID&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;SXFER&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;SODL&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&#39;SOCL&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s">&#39;SFBR&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;SIDL&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&#39;SBDL&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&#39;SBCL&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>
    <span class="s">&#39;DSTAT&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&#39;SSTAT0&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="s">&#39;SSTAT1&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="s">&#39;SSTAT2&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
    <span class="s">&#39;DSA0&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&#39;DSA1&#39;</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="s">&#39;DSA2&#39;</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s">&#39;DSA3&#39;</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>
    <span class="s">&#39;CTEST0&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&#39;CTEST1&#39;</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="s">&#39;CTEST2&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="s">&#39;CTEST3&#39;</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>
    <span class="s">&#39;CTEST4&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="s">&#39;CTEST5&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">&#39;CTEST6&#39;</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="s">&#39;CTEST7&#39;</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span>
    <span class="s">&#39;TEMP0&#39;</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="s">&#39;TEMP1&#39;</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="s">&#39;TEMP2&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s">&#39;TEMP3&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
    <span class="s">&#39;DFIFO&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&#39;ISTAT&#39;</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="s">&#39;CTEST8&#39;</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="s">&#39;LCRC&#39;</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span>
    <span class="s">&#39;DBC0&#39;</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="s">&#39;DBC1&#39;</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="s">&#39;DBC2&#39;</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="s">&#39;DCMD&#39;</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>
    <span class="s">&#39;DNAD0&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="s">&#39;DNAD1&#39;</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="s">&#39;DNAD2&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="s">&#39;DNAD3&#39;</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span>
    <span class="s">&#39;DSP0&#39;</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="s">&#39;DSP1&#39;</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="s">&#39;DSP2&#39;</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="s">&#39;DSP3&#39;</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
    <span class="s">&#39;DSPS0&#39;</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="s">&#39;DSPS1&#39;</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="s">&#39;DSPS2&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s">&#39;DSPS3&#39;</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
    <span class="s">&#39;SCRATCH0&#39;</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="s">&#39;SCRATCH1&#39;</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="s">&#39;SCRATCH2&#39;</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="s">&#39;SCRATCH3&#39;</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span>
    <span class="s">&#39;DMODE&#39;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="s">&#39;DIEN&#39;</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="s">&#39;DWT&#39;</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="s">&#39;DCNTL&#39;</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span>
    <span class="s">&#39;ADDER0&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s">&#39;ADDER1&#39;</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="s">&#39;ADDER2&#39;</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="s">&#39;ADDER3&#39;</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span>
  <span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="nv">%registers</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;SCNTL0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;SCNTL1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;SCNTL2&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;SCNTL3&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s">&#39;SCID&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;SXFER&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;SDID&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&#39;GPREG&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s">&#39;SFBR&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;SOCL&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&#39;SSID&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&#39;SBCL&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>
    <span class="s">&#39;DSTAT&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&#39;SSTAT0&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="s">&#39;SSTAT1&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="s">&#39;SSTAT2&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
    <span class="s">&#39;DSA0&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&#39;DSA1&#39;</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="s">&#39;DSA2&#39;</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s">&#39;DSA3&#39;</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>
    <span class="s">&#39;ISTAT&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s">&#39;CTEST0&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="s">&#39;CTEST1&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">&#39;CTEST2&#39;</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="s">&#39;CTEST3&#39;</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span>
    <span class="s">&#39;TEMP0&#39;</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="s">&#39;TEMP1&#39;</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="s">&#39;TEMP2&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s">&#39;TEMP3&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
    <span class="s">&#39;DFIFO&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&#39;CTEST4&#39;</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="s">&#39;CTEST5&#39;</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="s">&#39;CTEST6&#39;</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span>
    <span class="s">&#39;DBC0&#39;</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="s">&#39;DBC1&#39;</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="s">&#39;DBC2&#39;</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="s">&#39;DCMD&#39;</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>
    <span class="s">&#39;DNAD0&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="s">&#39;DNAD1&#39;</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="s">&#39;DNAD2&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="s">&#39;DNAD3&#39;</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span>
    <span class="s">&#39;DSP0&#39;</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="s">&#39;DSP1&#39;</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="s">&#39;DSP2&#39;</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="s">&#39;DSP3&#39;</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
    <span class="s">&#39;DSPS0&#39;</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="s">&#39;DSPS1&#39;</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="s">&#39;DSPS2&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s">&#39;DSPS3&#39;</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
    <span class="s">&#39;SCRATCH0&#39;</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="s">&#39;SCRATCH1&#39;</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="s">&#39;SCRATCH2&#39;</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="s">&#39;SCRATCH3&#39;</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span>
    <span class="s">&#39;SCRATCHA0&#39;</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="s">&#39;SCRATCHA1&#39;</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="s">&#39;SCRATCHA2&#39;</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="s">&#39;SCRATCHA3&#39;</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span>
    <span class="s">&#39;DMODE&#39;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="s">&#39;DIEN&#39;</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="s">&#39;DWT&#39;</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="s">&#39;DCNTL&#39;</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span>
    <span class="s">&#39;ADDER0&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s">&#39;ADDER1&#39;</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="s">&#39;ADDER2&#39;</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="s">&#39;ADDER3&#39;</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span>
    <span class="s">&#39;SIEN0&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&#39;SIEN1&#39;</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="s">&#39;SIST0&#39;</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="s">&#39;SIST1&#39;</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span>
    <span class="s">&#39;SLPAR&#39;</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> 	      <span class="s">&#39;MACNTL&#39;</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="s">&#39;GPCNTL&#39;</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span>
    <span class="s">&#39;STIME0&#39;</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="s">&#39;STIME1&#39;</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="s">&#39;RESPID&#39;</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> 
    <span class="s">&#39;STEST0&#39;</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="s">&#39;STEST1&#39;</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="s">&#39;STEST2&#39;</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="s">&#39;STEST3&#39;</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span>
    <span class="s">&#39;SIDL&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s">&#39;SODL&#39;</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span>
    <span class="s">&#39;SBDL&#39;</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span>
    <span class="s">&#39;SCRATCHB0&#39;</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="s">&#39;SCRATCHB1&#39;</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="s">&#39;SCRATCHB2&#39;</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="s">&#39;SCRATCHB3&#39;</span><span class="p">,</span> <span class="mi">95</span>
  <span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Parsing regular expressions</p></td><td class="code"><div class="highlight"><pre><span class="nv">$identifier</span> <span class="o">=</span> <span class="s">&#39;[A-Za-z_][A-Za-z_0-9]*&#39;</span><span class="p">;</span>		
<span class="nv">$decnum</span> <span class="o">=</span> <span class="s">&#39;-?\\d+&#39;</span><span class="p">;</span>
<span class="nv">$hexnum</span> <span class="o">=</span> <span class="s">&#39;0[xX][0-9A-Fa-f]+&#39;</span><span class="p">;</span>		
<span class="nv">$constant</span> <span class="o">=</span> <span class="s">&quot;$hexnum|$decnum&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>yucky - since we can't control grouping of # $constant, we need to 
expand out each alternative for $value.</p></td><td class="code"><div class="highlight"><pre><span class="nv">$value</span> <span class="o">=</span> <span class="s">&quot;$identifier|$identifier\\s*[+\-]\\s*$decnum|&quot;</span><span class="o">.</span>
    <span class="s">&quot;$identifier\\s*[+-]\s*$hexnum|$constant&quot;</span><span class="p">;</span>

<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;value regex = $value\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>

<span class="nv">$phase</span> <span class="o">=</span> <span class="nb">join</span> <span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">,</span> <span class="nb">keys</span> <span class="nv">%scsi_phases</span><span class="p">);</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;phase regex = $phase\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
<span class="nv">$register</span> <span class="o">=</span> <span class="nb">join</span> <span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">,</span> <span class="nb">keys</span> <span class="nv">%registers</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>yucky - since %operators includes meta-characters which must
be escaped, I can't use the join() trick I used for the register
regex</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nv">$ncr7x0_family</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$operator</span> <span class="o">=</span> <span class="s">&#39;\||OR|AND|\&amp;|\+&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="nv">$operator</span> <span class="o">=</span> <span class="s">&#39;\||OR|AND|XOR|\&amp;|\+&#39;</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Global variables</p></td><td class="code"><div class="highlight"><pre><span class="nv">%symbol_values</span> <span class="o">=</span> <span class="p">(</span><span class="nv">%registers</span><span class="p">)</span> <span class="p">;</span>		<span class="c1"># Traditional symbol table</span>

<span class="nv">%symbol_references</span> <span class="o">=</span> <span class="p">()</span> <span class="p">;</span>		<span class="c1"># Table of symbol references, where</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>the index is the symbol name, 
and the contents a white space 
delimited list of address,size
tuples where size is in bytes.</p></td><td class="code"><div class="highlight"><pre><span class="nv">@code</span> <span class="o">=</span> <span class="p">();</span>				<span class="c1"># Array of 32 bit words for SIOP </span>

<span class="nv">@entry</span> <span class="o">=</span> <span class="p">();</span>				<span class="c1"># Array of entry point names</span>

<span class="nv">@label</span> <span class="o">=</span> <span class="p">();</span>				<span class="c1"># Array of label names</span>

<span class="nv">@absolute</span> <span class="o">=</span> <span class="p">();</span>				<span class="c1"># Array of absolute names</span>

<span class="nv">@relative</span> <span class="o">=</span> <span class="p">();</span>				<span class="c1"># Array of relative names</span>

<span class="nv">@external</span> <span class="o">=</span> <span class="p">();</span>				<span class="c1"># Array of external names</span>

<span class="nv">$address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="c1"># Address of current instruction</span>

<span class="nv">$lineno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="c1"># Line number we are parsing</span>

<span class="nv">$output</span> <span class="o">=</span> <span class="s">&#39;script.h&#39;</span><span class="p">;</span>			<span class="c1"># Output file</span>
<span class="nv">$outputu</span> <span class="o">=</span> <span class="s">&#39;scriptu.h&#39;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>&amp;patch ($address, $offset, $length, $value) patches $code[$address]
    so that the $length bytes at $offset have $value added to
    them.  </p></td><td class="code"><div class="highlight"><pre><span class="nv">@inverted_masks</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x00_00_00_00</span><span class="p">,</span> <span class="mh">0x00_00_00_ff</span><span class="p">,</span> <span class="mh">0x00_00_ff_ff</span><span class="p">,</span> <span class="mh">0x00_ff_ff_ff</span><span class="p">,</span> 
    <span class="mh">0xff_ff_ff_ff</span><span class="p">);</span>

<span class="k">sub </span><span class="nf">patch</span> <span class="p">{</span>
    <span class="nb">local</span> <span class="p">(</span><span class="nv">$address</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">,</span> <span class="nv">$length</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Patching $address at offset $offset, length $length to $value\n&quot;</span><span class="p">;</span>
	<span class="nb">printf</span> <span class="bp">STDERR</span> <span class="s">&quot;Old code : %08x\n&quot;</span><span class="p">,</span> <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">];</span>
     <span class="p">}</span>

    <span class="nv">$mask</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$inverted_masks</span><span class="p">[</span><span class="nv">$length</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nv">$offset</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
   
    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="nv">$mask</span><span class="p">)</span> <span class="o">|</span> 
	<span class="p">((</span><span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">&amp;</span> <span class="nv">$mask</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nv">$offset</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> 
	<span class="nv">$mask</span><span class="p">);</span>
    
    <span class="nb">printf</span> <span class="bp">STDERR</span> <span class="s">&quot;New code : %08x\n&quot;</span><span class="p">,</span> <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>&amp;parse_value($value, $word, $offset, $length) where $value is 
    an identifier or constant, $word is the word offset relative to 
$address, $offset is the starting byte within that word, and 
$length is the length of the field in bytes.</p>

<p>Side effects are that the bytes are combined into the @code array
relative to $address, and that the %symbol_references table is 
    updated as appropriate.</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">parse_value</span> <span class="p">{</span>
    <span class="nb">local</span> <span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nv">$word</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">,</span> <span class="nv">$length</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="nb">local</span> <span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span>

    <span class="nv">$symbol</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">=~</span><span class="sr"> /^REL\s*\(\s*($identifier)\s*\)\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$relative</span> <span class="o">=</span> <span class="s">&#39;REL&#39;</span><span class="p">;</span>
	<span class="nv">$symbol</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$value</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Relative reference $symbol\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">=~</span><span class="sr"> /^($identifier)\s*(.*)/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$relative</span> <span class="o">=</span> <span class="s">&#39;ABS&#39;</span><span class="p">;</span>
	<span class="nv">$symbol</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$value</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Absolute reference $symbol\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
    <span class="p">}</span> 

    <span class="k">if</span> <span class="p">(</span><span class="nv">$symbol</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Referencing symbol $1, length = $length in $_\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
     	<span class="nv">$tmp</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$address</span> <span class="o">+</span> <span class="nv">$word</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="nv">$offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$symbol_references</span><span class="p">{</span><span class="nv">$symbol</span><span class="p">}</span> <span class="ow">ne</span> <span class="nb">undef</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$symbol_references</span><span class="p">{</span><span class="nv">$symbol</span><span class="p">}</span> <span class="o">=</span> 
		<span class="s">&quot;$symbol_references{$symbol} $relative,$tmp,$length&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$symbol</span><span class="p">}))</span> <span class="p">{</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;forward $1\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug_external</span><span class="p">);</span>
		<span class="nv">$forward</span><span class="p">{</span><span class="nv">$symbol</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;line $lineno : $_&quot;</span><span class="p">;</span>
	    <span class="p">}</span> 
	    <span class="nv">$symbol_references</span><span class="p">{</span><span class="nv">$symbol</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;$relative,$tmp,$length&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> 

    <span class="nv">$value</span> <span class="o">=</span> <span class="nb">eval</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="o">&amp;</span><span class="n">patch</span> <span class="p">(</span><span class="nv">$address</span> <span class="o">+</span> <span class="nv">$word</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">,</span> <span class="nv">$length</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>&amp;parse_conditional ($conditional) where $conditional is the conditional
clause from a transfer control instruction (RETURN, CALL, JUMP, INT).</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">parse_conditional</span> <span class="p">{</span>
    <span class="nb">local</span> <span class="p">(</span><span class="nv">$conditional</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">=~</span><span class="sr"> /^\s*(IF|WHEN)\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$if</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$conditional</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$if</span> <span class="o">=~</span><span class="sr"> /WHEN/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$allow_atn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x00_01_00_00</span><span class="p">;</span>
	    <span class="nv">$allow_atn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$0 : parsed WHEN\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$allow_atn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$0 : parsed IF\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span> <span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected IF or WHEN</span>
<span class="s">&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">=~</span><span class="sr"> /^NOT\s+(.*)$/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$not</span> <span class="o">=</span> <span class="s">&#39;NOT &#39;</span><span class="p">;</span>
	<span class="nv">$other</span> <span class="o">=</span> <span class="s">&#39;OR&#39;</span><span class="p">;</span>
	<span class="nv">$conditional</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$0 : parsed NOT\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x00_08_00_00</span><span class="p">;</span>
	<span class="nv">$not</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="nv">$other</span> <span class="o">=</span> <span class="s">&#39;AND&#39;</span>
    <span class="p">}</span>

    <span class="nv">$need_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">=~</span><span class="sr"> /^ATN\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span><span class="c1">#</span>
	<span class="nb">die</span> <span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	WHEN conditional is incompatible with ATN </span>
<span class="s">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$allow_atn</span><span class="p">);</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x00_02_00_00</span><span class="p">;</span>
	<span class="nv">$conditional</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$0 : parsed ATN\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">=~</span><span class="sr"> /^($phase)\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$phase_index</span> <span class="o">=</span> <span class="s">&quot;\U$1\E&quot;</span><span class="p">;</span>
	<span class="nv">$p</span> <span class="o">=</span> <span class="nv">$scsi_phases</span><span class="p">{</span><span class="nv">$phase_index</span><span class="p">};</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="nv">$p</span> <span class="o">|</span> <span class="mh">0x00_02_00_00</span><span class="p">;</span>
	<span class="nv">$conditional</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$0 : parsed phase $phase_index\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nv">$other</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
	<span class="nv">$need_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Parsing conjunction, expecting $other\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">=~</span><span class="sr"> /^(AND|OR)\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$conjunction</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$conditional</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="nv">$need_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nb">die</span> <span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	    Illegal use of $1.  Valid uses are </span>
<span class="s">	    &quot;</span><span class="o">.</span><span class="nv">$not</span><span class="o">.</span><span class="s">&quot;&lt;phase&gt; $1 data</span>
<span class="s">	    &quot;</span><span class="o">.</span><span class="nv">$not</span><span class="o">.</span><span class="s">&quot;ATN $1 data</span>
<span class="s">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$other</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
	<span class="nb">die</span> <span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	Illegal use of $conjunction.  Valid syntaxes are </span>
<span class="s">		NOT &lt;phase&gt;|ATN OR data</span>
<span class="s">		&lt;phase&gt;|ATN AND data</span>
<span class="s">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$conjunction</span> <span class="o">!~</span> <span class="sr">/\s*$other\s*/i</span><span class="p">);</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$0 : parsed $1\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$need_data</span><span class="p">)</span> <span class="p">{</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;looking for data in $conditional\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$conditional</span><span class="o">=~</span><span class="sr"> /^($value)\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x00_04_00_00</span><span class="p">;</span>
	    <span class="nv">$conditional</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span><span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$0 : parsed data\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nb">die</span> <span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected &lt;data&gt;.</span>
<span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">=~</span><span class="sr"> /^\s*,\s*(.*)/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$conditional</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">=~</span><span class="sr"> /^AND\s\s*MASK\s\s*($value)\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span> <span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$0 parsed AND MASK $1\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	    <span class="nb">die</span> <span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected end of line, not \&quot;$2\&quot;</span>
<span class="s">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$2</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span> <span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected \&quot;,AND MASK &lt;data&gt;\&quot;, not \&quot;$2\&quot;</span>
<span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">!~</span> <span class="sr">/^\s*$/</span><span class="p">)</span> <span class="p">{</span> 
	<span class="nb">die</span> <span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected end of line&quot;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">$need_data</span><span class="p">)</span> <span class="p">?</span> <span class="s">&quot; or \&quot;AND MASK &lt;data&gt;\&quot;&quot;</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;</span>
<span class="s">	not \&quot;$conditional\&quot;</span>
<span class="s">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Parse command line</p></td><td class="code"><div class="highlight"><pre><span class="nv">$output</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
<span class="nv">$outputu</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>

    </pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Main loop</p></td><td class="code"><div class="highlight"><pre><span class="k">while</span> <span class="p">(</span><span class="sr">&lt;STDIN&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$lineno</span> <span class="o">=</span> <span class="nv">$lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$list</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$list</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span><span class="o">.</span><span class="nv">$_</span><span class="p">;</span>
    <span class="sr">s/;.*$//</span><span class="p">;</span>				<span class="c1"># Strip comments</span>


    <span class="nb">chop</span><span class="p">;</span>				<span class="c1"># Leave new line out of error messages</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Handle symbol definitions of the form label:</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="sr">/^\s*($identifier)\s*:(.*)/</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$1</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$1</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$address</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>	<span class="c1"># Address is an index into</span>
	    <span class="nb">delete</span> <span class="nv">$forward</span><span class="p">{</span><span class="nv">$1</span><span class="p">};</span>		<span class="c1"># an array of longs</span>
	    <span class="nb">push</span> <span class="p">(</span><span class="nv">@label</span><span class="p">,</span> <span class="nv">$1</span><span class="p">);</span>
	    <span class="nv">$_</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span> <span class="s">&quot;$0 : redefinition of symbol $1 in line $lineno : $_\n&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Handle symbol definitions of the form ABSOLUTE or RELATIVE identifier = 
value</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="sr">/^\s*(ABSOLUTE|RELATIVE)\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$is_absolute</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="nv">$rest</span> <span class="p">(</span><span class="nb">split</span> <span class="p">(</span><span class="sr">/\s*,\s*/</span><span class="p">,</span> <span class="nv">$rest</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^($identifier)\s*=\s*($constant)\s*$/</span><span class="p">)</span> <span class="p">{</span>
	        <span class="nb">local</span> <span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$cnst</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$1</span><span class="p">,</span> <span class="nv">$2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$id</span><span class="p">}</span> <span class="ow">eq</span> <span class="nb">undef</span><span class="p">)</span> <span class="p">{</span>
		    <span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$id</span><span class="p">}</span> <span class="o">=</span> <span class="nb">eval</span> <span class="nv">$cnst</span><span class="p">;</span>
		    <span class="nb">delete</span> <span class="nv">$forward</span><span class="p">{</span><span class="nv">$id</span><span class="p">};</span>
		    <span class="k">if</span> <span class="p">(</span><span class="nv">$is_absolute</span> <span class="o">=~</span><span class="sr"> /ABSOLUTE/i</span><span class="p">)</span> <span class="p">{</span>
			<span class="nb">push</span> <span class="p">(</span><span class="nv">@absolute</span> <span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>
		    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nb">push</span> <span class="p">(</span><span class="nv">@relative</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>
		    <span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="nb">die</span> <span class="s">&quot;$0 : redefinition of symbol $id in line $lineno : $_\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">die</span> 
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	    expected &lt;identifier&gt; = &lt;value&gt;</span>
<span class="s">&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*EXTERNAL\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$externals</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="nv">$external</span> <span class="p">(</span><span class="nb">split</span> <span class="p">(</span><span class="sr">/,/</span><span class="p">,</span><span class="nv">$externals</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$external</span> <span class="o">=~</span><span class="sr"> /\s*($identifier)\s*$/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$external</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nb">push</span> <span class="p">(</span><span class="nv">@external</span><span class="p">,</span> <span class="nv">$external</span><span class="p">);</span>
		<span class="nb">delete</span> <span class="nv">$forward</span><span class="p">{</span><span class="nv">$external</span><span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$external</span><span class="p">}))</span> <span class="p">{</span>
			<span class="nb">die</span> <span class="s">&quot;$0 : redefinition of symbol $1 in line $lineno : $_\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$external</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$external</span><span class="p">;</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;defined external $1 to $external\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug_external</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">die</span> 
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected &lt;identifier&gt;, got $external</span>
<span class="s">&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Process ENTRY identifier declarations</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*ENTRY\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$1</span> <span class="o">=~</span><span class="sr"> /^($identifier)\s*$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nb">push</span> <span class="p">(</span><span class="nv">@entry</span><span class="p">,</span> <span class="nv">$1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span>
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected ENTRY &lt;identifier&gt;</span>
<span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Process MOVE length, address, WITH|WHEN phase instruction</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*MOVE\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^FROM\s+($value)\s*,\s*(WITH|WHEN)\s+($phase)\s*$/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$transfer_addr</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$with_when</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="nv">$scsi_phase</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Parsing MOVE FROM $transfer_addr, $with_when $3\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x18_00_00_00</span> <span class="o">|</span> <span class="p">((</span><span class="nv">$with_when</span> <span class="o">=~</span><span class="sr"> /WITH/i</span><span class="p">)</span> <span class="p">?</span> 
		<span class="mh">0x00_00_00_00</span> <span class="p">:</span> <span class="mh">0x08_00_00_00</span><span class="p">)</span> <span class="o">|</span> <span class="nv">$scsi_phases</span><span class="p">{</span><span class="nv">$scsi_phase</span><span class="p">};</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span> <span class="p">(</span><span class="nv">$transfer_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	    <span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^($value)\s*,\s*(PTR\s+|)($value)\s*,\s*(WITH|WHEN)\s+($phase)\s*$/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$transfer_len</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$ptr</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="nv">$transfer_addr</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	    <span class="nv">$with_when</span> <span class="o">=</span> <span class="nv">$4</span><span class="p">;</span>
	    <span class="nv">$scsi_phase</span> <span class="o">=</span> <span class="nv">$5</span><span class="p">;</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nv">$with_when</span> <span class="o">=~</span><span class="sr"> /WITH/i</span><span class="p">)</span> <span class="p">?</span> <span class="mh">0x00_00_00_00</span> <span class="p">:</span> 
		<span class="mh">0x08_00_00_00</span><span class="p">)</span>  <span class="o">|</span> <span class="p">((</span><span class="nv">$ptr</span> <span class="o">=~</span><span class="sr"> /PTR/i</span><span class="p">)</span> <span class="p">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">)</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> 
		<span class="nv">$scsi_phases</span><span class="p">{</span><span class="nv">$scsi_phase</span><span class="p">};</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span> <span class="p">(</span><span class="nv">$transfer_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span> <span class="p">(</span><span class="nv">$transfer_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	    <span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^MEMORY\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc0_00_00_00</span><span class="p">;</span> 
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^($value)\s*,\s*($value)\s*,\s*($value)\s*$/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$count</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="nv">$source</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
		<span class="nv">$dest</span> <span class="o">=</span>  <span class="nv">$3</span><span class="p">;</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Parsing MOVE MEMORY $count, $source, $dest\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
		<span class="o">&amp;</span><span class="n">parse_value</span> <span class="p">(</span><span class="nv">$count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="o">&amp;</span><span class="n">parse_value</span> <span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="o">&amp;</span><span class="n">parse_value</span> <span class="p">(</span><span class="nv">$dest</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="nb">printf</span> <span class="bp">STDERR</span> <span class="s">&quot;Move memory instruction = %08x,%08x,%08x\n&quot;</span><span class="p">,</span> 
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">],</span> <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span>
		<span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
		<span class="nv">$address</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">die</span> 
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected &lt;count&gt;, &lt;source&gt;, &lt;destination&gt;</span>
<span class="s">&quot;</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$1</span> <span class="o">=~</span><span class="sr"> /^(.*)\s+(TO|SHL|SHR)\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Parsing register to register move\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	    <span class="nv">$src</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$op</span> <span class="o">=</span> <span class="s">&quot;\U$2\E&quot;</span><span class="p">;</span>
	    <span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>

	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40_00_00_00</span><span class="p">;</span>
	
	    <span class="nv">$force</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$op</span> <span class="o">!~</span> <span class="sr">/TO/i</span><span class="p">);</span> 


<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Forcing register source \n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$force</span> <span class="o">&amp;&amp;</span> <span class="nv">$debug</span><span class="p">);</span>

	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$force</span> <span class="o">&amp;&amp;</span> <span class="nv">$src</span> <span class="o">=~</span><span class="sr"> </span>
<span class="sr">		/^($register)\s+(-|$operator)\s+($value)\s*$/i</span><span class="p">)</span> <span class="p">{</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;register operand  data8 source\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
		<span class="nv">$src_reg</span> <span class="o">=</span> <span class="s">&quot;\U$1\E&quot;</span><span class="p">;</span>
		<span class="nv">$op</span> <span class="o">=</span> <span class="s">&quot;\U$2\E&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">ne</span> <span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
		    <span class="nv">$data8</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="nb">die</span> <span class="s">&quot;- is not implemented yet.\n&quot;</span>
		<span class="p">}</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$src</span> <span class="o">=~</span><span class="sr"> /^($register)\s*$/i</span><span class="p">)</span> <span class="p">{</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;register source\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
		<span class="nv">$src_reg</span> <span class="o">=</span> <span class="s">&quot;\U$1\E&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Encode register to register move as a register | 0 
move to register.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$force</span><span class="p">)</span> <span class="p">{</span>
		    <span class="nv">$op</span> <span class="o">=</span> <span class="s">&#39;|&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$data8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="o">!</span><span class="nv">$force</span> <span class="o">&amp;&amp;</span> <span class="nv">$src</span> <span class="o">=~</span><span class="sr"> /^($value)\s*$/i</span><span class="p">)</span> <span class="p">{</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;data8 source\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
		<span class="nv">$src_reg</span> <span class="o">=</span> <span class="nb">undef</span><span class="p">;</span>
		<span class="nv">$op</span> <span class="o">=</span> <span class="s">&#39;NONE&#39;</span><span class="p">;</span>
		<span class="nv">$data8</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$force</span><span class="p">)</span> <span class="p">{</span>
		    <span class="nb">die</span> 
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected &lt;register&gt;</span>
<span class="s">		&lt;data8&gt;</span>
<span class="s">		&lt;register&gt; &lt;operand&gt; &lt;data8&gt;</span>
<span class="s">&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="nb">die</span>
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected &lt;register&gt;</span>
<span class="s">&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^($register)\s*(.*)$/i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$dst_reg</span> <span class="o">=</span> <span class="s">&quot;\U$1\E&quot;</span><span class="p">;</span>
		<span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span> 
<span class="s">&quot;$0 : syntax error in $lineno : $_</span>
<span class="s">	expected &lt;register&gt;, got $rest</span>
<span class="s">&quot;</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^WITH\s+CARRY\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$op</span> <span class="ow">eq</span> <span class="s">&#39;+&#39;</span><span class="p">)</span> <span class="p">{</span>
		    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01_00_00_00</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="nb">die</span>
<span class="s">&quot;$0 : syntax error in $lineno : $_</span>
<span class="s">	WITH CARRY option is incompatible with the $op operator.</span>
<span class="s">&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">!~</span> <span class="sr">/^\s*$/</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">die</span>
<span class="s">&quot;$0 : syntax error in $lineno : $_</span>
<span class="s">	Expected end of line, got $rest</span>
<span class="s">&quot;</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;source = $src_reg, data = $data8 , destination = $dst_reg\n&quot;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Note that Move data8 to reg is encoded as a read-modify-write
instruction.</p></td><td class="code"><div class="highlight"><pre>	    <span class="k">if</span> <span class="p">((</span><span class="nv">$src_reg</span> <span class="ow">eq</span> <span class="nb">undef</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$src_reg</span> <span class="ow">eq</span> <span class="nv">$dst_reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x38_00_00_00</span> <span class="o">|</span> 
		    <span class="p">(</span><span class="nv">$registers</span><span class="p">{</span><span class="nv">$dst_reg</span><span class="p">}</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$dst_reg</span> <span class="o">=~</span><span class="sr"> /SFBR/i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x30_00_00_00</span> <span class="o">|</span>
		    <span class="p">(</span><span class="nv">$registers</span><span class="p">{</span><span class="nv">$src_reg</span><span class="p">}</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$src_reg</span> <span class="o">=~</span><span class="sr"> /SFBR/i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x28_00_00_00</span> <span class="o">|</span>
		    <span class="p">(</span><span class="nv">$registers</span><span class="p">{</span><span class="nv">$dst_reg</span><span class="p">}</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">die</span>
<span class="s">&quot;$0 : Illegal combination of registers in line $lineno : $_</span>
<span class="s">	Either source and destination registers must be the same,</span>
<span class="s">	or either source or destination register must be SFBR.</span>
<span class="s">&quot;</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="nv">$operators</span><span class="p">{</span><span class="nv">$op</span><span class="p">};</span>
	    
	    <span class="o">&amp;</span><span class="n">parse_value</span> <span class="p">(</span><span class="nv">$data8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="nv">$operators</span><span class="p">{</span><span class="nv">$op</span><span class="p">};</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00_00_00_00</span><span class="p">;</span><span class="c1"># Reserved</span>
	    <span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span> 
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected (initiator) &lt;length&gt;, &lt;address&gt;, WHEN &lt;phase&gt;</span>
<span class="s">		 (target) &lt;length&gt;, &lt;address&gt;, WITH &lt;phase&gt;</span>
<span class="s">		 MEMORY &lt;length&gt;, &lt;source&gt;, &lt;destination&gt;</span>
<span class="s">		 &lt;expression&gt; TO &lt;register&gt;</span>
<span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Process SELECT {ATN|} id, fail_address</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*(SELECT|RESELECT)\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^(ATN|)\s*($value)\s*,\s*($identifier)\s*$/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$atn</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="nv">$alt_addr</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40_00_00_00</span> <span class="o">|</span> 
		<span class="p">((</span><span class="nv">$atn</span> <span class="o">=~</span><span class="sr"> /ATN/i</span><span class="p">)</span> <span class="p">?</span> <span class="mh">0x01_00_00_00</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00_00_00_00</span><span class="p">;</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span><span class="p">(</span><span class="nv">$alt_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	    <span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^(ATN|)\s*FROM\s+($value)\s*,\s*($identifier)\s*$/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$atn</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="nv">$alt_addr</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x42_00_00_00</span> <span class="o">|</span> 
		<span class="p">((</span><span class="nv">$atn</span> <span class="o">=~</span><span class="sr"> /ATN/i</span><span class="p">)</span> <span class="p">?</span> <span class="mh">0x01_00_00_00</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00_00_00_00</span><span class="p">;</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span><span class="p">(</span><span class="nv">$alt_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	    <span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span> 
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected SELECT id, alternate_address or </span>
<span class="s">		SELECT FROM address, alternate_address or </span>
<span class="s">		RESELECT id, alternate_address or</span>
<span class="s">		RESELECT FROM address, alternate_address</span>
<span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*WAIT\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Parsing WAIT $rest\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^DISCONNECT\s*$/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x48_00_00_00</span><span class="p">;</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00_00_00_00</span><span class="p">;</span>
	    <span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^(RESELECT|SELECT)\s+($identifier)\s*$/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$alt_addr</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50_00_00_00</span><span class="p">;</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span> <span class="p">(</span><span class="nv">$alt_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	    <span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span>
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected (initiator) WAIT DISCONNECT or </span>
<span class="s">		 (initiator) WAIT RESELECT alternate_address or</span>
<span class="s">		 (target) WAIT SELECT alternate_address</span>
<span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Handle SET and CLEAR instructions.  Note that we should also do something
with this syntax to set target mode.</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*(SET|CLEAR)\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$set</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$list</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$set</span> <span class="o">=~</span><span class="sr"> /SET/i</span><span class="p">)</span> <span class="p">?</span>  <span class="mh">0x58_00_00_00</span> <span class="p">:</span> 
	    <span class="mh">0x60_00_00_00</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="nv">$arg</span> <span class="p">(</span><span class="nb">split</span> <span class="p">(</span><span class="sr">/\s+AND\s+/i</span><span class="p">,</span><span class="nv">$list</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$arg</span> <span class="o">=~</span><span class="sr"> /ATN/i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x00_00_00_08</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arg</span> <span class="o">=~</span><span class="sr"> /ACK/i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x00_00_00_40</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arg</span> <span class="o">=~</span><span class="sr"> /TARGET/i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x00_00_02_00</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$arg</span> <span class="o">=~</span><span class="sr"> /CARRY/i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x00_00_04_00</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">die</span> 
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected $set followed by a AND delimited list of one or </span>
<span class="s">	more strings from the list ACK, ATN, CARRY, TARGET.</span>
<span class="s">&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00_00_00_00</span><span class="p">;</span>
	<span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*(JUMP|CALL|INT)\s+(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$instruction</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$instruction</span> <span class="o">=~</span><span class="sr"> /JUMP/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80_00_00_00</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$instruction</span> <span class="o">=~</span><span class="sr"> /CALL/i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88_00_00_00</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x98_00_00_00</span><span class="p">;</span>
	<span class="p">}</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;parsing JUMP, rest = $rest\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Relative jump. </p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^(REL\s*\(\s*$identifier\s*\))\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span> 
	    <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;parsing JUMP REL, addr = $addr, rest = $rest\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span>  <span class="o">|=</span> <span class="mh">0x00_80_00_00</span><span class="p">;</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Absolute jump, requires no more gunk</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^($value)\s*(.*)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$addr</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$rest</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="o">&amp;</span><span class="n">parse_value</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span>
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected &lt;address&gt; or REL (address)</span>
<span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^,\s*(.*)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="o">&amp;</span><span class="n">parse_conditional</span><span class="p">(</span><span class="nv">$1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$rest</span> <span class="o">=~</span><span class="sr"> /^\s*$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">die</span>
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected , &lt;conditional&gt; or end of line, got $1</span>
<span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*(RETURN|INTFLY)\s*(.*)/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$instruction</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$conditional</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span> 
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Parsing $instruction\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$instruction</span> <span class="o">=~</span><span class="sr"> /RETURN/i</span><span class="p">)</span> <span class="p">?</span> <span class="mh">0x90_00_00_00</span> <span class="p">:</span>
	    <span class="mh">0x98_10_00_00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">=~</span><span class="sr"> /^,\s*(.*)/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$conditional</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="o">&amp;</span><span class="n">parse_conditional</span> <span class="p">(</span><span class="nv">$conditional</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$conditional</span> <span class="o">!~</span> <span class="sr">/^\s*$/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nb">die</span>
<span class="s">&quot;$0 : syntax error in line $lineno : $_</span>
<span class="s">	expected , &lt;conditional&gt; </span>
<span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x00_08_00_00</span><span class="p">;</span>
	<span class="p">}</span>
	   
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00_00_00_00</span><span class="p">;</span>
	<span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*DISCONNECT\s*$/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x48_00_00_00</span><span class="p">;</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00_00_00_00</span><span class="p">;</span>
	<span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>I'm not sure that I should be including this extension, but 
what the hell?</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*NOP\s*$/i</span><span class="p">)</span> <span class="p">{</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80_88_00_00</span><span class="p">;</span>
	<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00_00_00_00</span><span class="p">;</span>
	<span class="nv">$address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Ignore lines consisting entirely of white space</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="sr">/^\s*$/</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nb">die</span> 
<span class="s">&quot;$0 : syntax error in line $lineno: $_</span>
<span class="s">	expected label:, ABSOLUTE, CLEAR, DISCONNECT, EXTERNAL, MOVE, RESELECT,</span>
<span class="s">	    SELECT SET, or WAIT</span>
<span class="s">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Fill in label references</p></td><td class="code"><div class="highlight"><pre><span class="nv">@undefined</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%forward</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$#undefined</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Undefined symbols : \n&quot;</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="nv">$undef</span> <span class="p">(</span><span class="nv">@undefined</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;$undef in $forward{$undef}\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">exit</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">@label_patches</span> <span class="o">=</span> <span class="p">();</span>

<span class="nv">@external_patches</span> <span class="o">=</span> <span class="p">();</span>

<span class="nv">@absolute</span> <span class="o">=</span> <span class="nb">sort</span> <span class="nv">@absolute</span><span class="p">;</span>

<span class="k">foreach</span> <span class="nv">$i</span> <span class="p">(</span><span class="nv">@absolute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="nv">$j</span> <span class="p">(</span><span class="nb">split</span> <span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span><span class="nv">$symbol_references</span><span class="p">{</span><span class="nv">$i</span><span class="p">}))</span> <span class="p">{</span>
	<span class="nv">$j</span> <span class="o">=~</span><span class="sr"> /(REL|ABS),(.*),(.*)/</span><span class="p">;</span>
	<span class="nv">$type</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="nv">$address</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	<span class="nv">$length</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	<span class="nb">die</span> 
<span class="s">&quot;$0 : $symbol $i has invalid relative reference at address $address,</span>
<span class="s">    size $length\n&quot;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;REL&#39;</span><span class="p">);</span>
	    
	<span class="o">&amp;</span><span class="n">patch</span> <span class="p">(</span><span class="nv">$address</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="nv">$address</span> <span class="nv">%</span> <span class="nv">4</span><span class="p">,</span> <span class="nv">$length</span><span class="p">,</span> <span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$i</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">foreach</span> <span class="nv">$external</span> <span class="p">(</span><span class="nv">@external</span><span class="p">)</span> <span class="p">{</span>
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;checking external $external \n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug_external</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$symbol_references</span><span class="p">{</span><span class="nv">$external</span><span class="p">}</span> <span class="ow">ne</span> <span class="nb">undef</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nv">$reference</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span><span class="nv">$symbol_references</span><span class="p">{</span><span class="nv">$external</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="nv">$reference</span> <span class="o">=~</span><span class="sr"> /(REL|ABS),(.*),(.*)/</span><span class="p">;</span>
	    <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$address</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="nv">$length</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	    
	    <span class="nb">die</span> 
<span class="s">&quot;$0 : symbol $label is external, has invalid relative reference at $address,</span>
<span class="s">    size $length\n&quot;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;REL&#39;</span><span class="p">);</span>

	    <span class="nb">die</span> 
<span class="s">&quot;$0 : symbol $label has invalid reference at $address, size $length\n&quot;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="nv">$address</span> <span class="nv">%</span> <span class="nv">4</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$length</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">));</span>

	    <span class="nv">$symbol</span> <span class="o">=</span> <span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$external</span><span class="p">};</span>
	    <span class="nv">$add</span> <span class="o">=</span> <span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nv">$add</span> <span class="ow">eq</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$symbol</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nv">$add</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="p">(</span><span class="s">&quot;0x%08x&quot;</span><span class="p">,</span> <span class="nv">$add</span><span class="p">);</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;$symbol + $add&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
		
<span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;referenced external $external at $1\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug_external</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">foreach</span> <span class="nv">$label</span> <span class="p">(</span><span class="nv">@label</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$symbol_references</span><span class="p">{</span><span class="nv">$label</span><span class="p">}</span> <span class="ow">ne</span> <span class="nb">undef</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nv">$reference</span> <span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span><span class="nv">$symbol_references</span><span class="p">{</span><span class="nv">$label</span><span class="p">}))</span> <span class="p">{</span>
	    <span class="nv">$reference</span> <span class="o">=~</span><span class="sr"> /(REL|ABS),(.*),(.*)/</span><span class="p">;</span>
	    <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	    <span class="nv">$address</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="nv">$length</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(((</span><span class="nv">$address</span> <span class="nv">%</span> <span class="nv">4</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$length</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="nb">die</span> <span class="s">&quot;$0 : symbol $label has invalid reference at $1, size $2\n&quot;</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="ow">eq</span> <span class="s">&#39;ABS&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$label</span><span class="p">};</span>
		<span class="nb">push</span> <span class="p">(</span><span class="nv">@label_patches</span><span class="p">,</span> <span class="nv">$address</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><ul>
<li>The address of the reference should be in the second and last word
of an instruction</li>
<li>Relative jumps, etc. are relative to the DSP of the <em>next</em> instruction</li>
</ul>

<p>So, we need to add four to the address of the reference, to get 
the address of the next instruction, when computing the reference.</p></td><td class="code"><div class="highlight"><pre>  
		<span class="nv">$tmp</span> <span class="o">=</span> <span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$label</span><span class="p">}</span> <span class="o">-</span> 
		    <span class="p">(</span><span class="nv">$address</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="nb">die</span> </pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Relative addressing is limited to 24 bits.</p></td><td class="code"><div class="highlight"><pre><span class="s">&quot;$0 : symbol $label is too far ($tmp) from $address to reference as </span>
<span class="s">    relative/\n&quot;</span> <span class="k">if</span> <span class="p">((</span><span class="nv">$tmp</span> <span class="o">&gt;=</span> <span class="mh">0x80_00_00</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$tmp</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mh">0x80_00_00</span><span class="p">));</span>
		<span class="nv">$code</span><span class="p">[</span><span class="nv">$address</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tmp</span> <span class="o">&amp;</span> <span class="mh">0x00_ff_ff_ff</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Output SCRIPT[] array, one instruction per line.  Optionally 
print the original code too.</p></td><td class="code"><div class="highlight"><pre><span class="nb">open</span> <span class="p">(</span><span class="n">OUTPUT</span><span class="p">,</span> <span class="s">&quot;&gt;$output&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;$0 : can&#39;t open $output for writing\n&quot;</span><span class="p">;</span>
<span class="nb">open</span> <span class="p">(</span><span class="n">OUTPUTU</span><span class="p">,</span> <span class="s">&quot;&gt;$outputu&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;$0 : can&#39;t open $outputu for writing\n&quot;</span><span class="p">;</span>

<span class="p">(</span><span class="nv">$_</span> <span class="o">=</span> <span class="nv">$0</span><span class="p">)</span> <span class="o">=~</span> <span class="n">s:</span><span class="o">.*/::</span><span class="p">;</span>
<span class="k">print</span> <span class="n">OUTPUT</span> <span class="s">&quot;/* DO NOT EDIT - Generated automatically by &quot;</span><span class="o">.</span><span class="nv">$_</span><span class="o">.</span><span class="s">&quot; */\n&quot;</span><span class="p">;</span>
<span class="k">print</span> <span class="n">OUTPUT</span> <span class="s">&quot;static u32 &quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="o">.</span><span class="s">&quot;SCRIPT[] = {\n&quot;</span><span class="p">;</span>
<span class="nv">$instructions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$#code</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$list_in_array</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;/*\n$list[$i]\nat 0x%08x : */&quot;</span><span class="p">,</span> <span class="nv">$i</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;\t0x%08x,&quot;</span><span class="p">,</span> <span class="nv">$code</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
    <span class="nb">printf</span> <span class="bp">STDERR</span> <span class="s">&quot;Address $i = %x\n&quot;</span><span class="p">,</span> <span class="nv">$code</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$code</span><span class="p">[</span><span class="nv">$i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /\s*($identifier)(.*)$/</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">push</span> <span class="p">(</span><span class="nv">@external_patches</span><span class="p">,</span> <span class="nv">$i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$1</span><span class="p">);</span>
	<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;0%s,&quot;</span><span class="p">,</span> <span class="nv">$2</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;0x%08x,&quot;</span><span class="p">,</span><span class="nv">$code</span><span class="p">[</span><span class="nv">$i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="nv">$code</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff_00_00_00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc0_00_00_00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$code</span><span class="p">[</span><span class="nv">$i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /$identifier/</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nb">push</span> <span class="p">(</span><span class="nv">@external_patches</span><span class="p">,</span> <span class="nv">$i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="nv">$code</span><span class="p">[</span><span class="nv">$i</span><span class="o">+</span><span class="mi">2</span><span class="p">]);</span>
	    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;0,\n&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;0x%08x,\n&quot;</span><span class="p">,</span><span class="nv">$code</span><span class="p">[</span><span class="nv">$i</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="nv">$i</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
	<span class="nv">$i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$instructions</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">print</span> <span class="n">OUTPUT</span> <span class="s">&quot;};\n\n&quot;</span><span class="p">;</span>

<span class="k">foreach</span> <span class="nv">$i</span> <span class="p">(</span><span class="nv">@absolute</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;#define A_$i\t0x%08x\n&quot;</span><span class="p">,</span> <span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$i</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$prefix</span> <span class="ow">ne</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;#define A_&quot;</span><span class="o">.</span><span class="nv">$i</span><span class="o">.</span><span class="s">&quot;_used &quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="o">.</span><span class="s">&quot;A_&quot;</span><span class="o">.</span><span class="nv">$i</span><span class="o">.</span><span class="s">&quot;_used\n&quot;</span><span class="p">;</span>
	<span class="nb">printf</span> <span class="n">OUTPUTU</span> <span class="s">&quot;#undef A_&quot;</span><span class="o">.</span><span class="nv">$i</span><span class="o">.</span><span class="s">&quot;_used\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">printf</span> <span class="n">OUTPUTU</span> <span class="s">&quot;#undef A_$i\n&quot;</span><span class="p">;</span>

    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;static u32 A_&quot;</span><span class="o">.</span><span class="nv">$i</span><span class="o">.</span><span class="s">&quot;_used\[\] __attribute((unused)) = {\n&quot;</span><span class="p">;</span>
<span class="nb">printf</span> <span class="bp">STDERR</span> <span class="s">&quot;$i is used $symbol_references{$i}\n&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="nv">$j</span> <span class="p">(</span><span class="nb">split</span> <span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span><span class="nv">$symbol_references</span><span class="p">{</span><span class="nv">$i</span><span class="p">}))</span> <span class="p">{</span>
	<span class="nv">$j</span> <span class="o">=~</span><span class="sr"> /(ABS|REL),(.*),(.*)/</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$1</span> <span class="ow">eq</span> <span class="s">&#39;ABS&#39;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nv">$address</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
	    <span class="nv">$length</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
	    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;\t0x%08x,\n&quot;</span><span class="p">,</span> <span class="nv">$address</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;};\n\n&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">foreach</span> <span class="nv">$i</span> <span class="p">(</span><span class="nb">sort</span> <span class="nv">@entry</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;#define Ent_$i\t0x%08x\n&quot;</span><span class="p">,</span> <span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$i</span><span class="p">};</span>
    <span class="nb">printf</span> <span class="n">OUTPUTU</span> <span class="s">&quot;#undef Ent_$i\n&quot;</span><span class="p">,</span> <span class="nv">$symbol_values</span><span class="p">{</span><span class="nv">$i</span><span class="p">};</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>NCR assembler outputs label patches in the form of indices into 
the code.</p></td><td class="code"><div class="highlight"><pre><span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;static u32 &quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="o">.</span><span class="s">&quot;LABELPATCHES[] __attribute((unused)) = {\n&quot;</span><span class="p">;</span>
<span class="k">for</span> <span class="nv">$patch</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">{</span><span class="nv">$a</span> <span class="sr">&lt;=&gt;</span> <span class="nv">$b</span><span class="p">}</span> <span class="nv">@label_patches</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;\t0x%08x,\n&quot;</span><span class="p">,</span> <span class="nv">$patch</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;};\n\n&quot;</span><span class="p">;</span>

<span class="nv">$num_external_patches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;static struct {\n\tu32\toffset;\n\tvoid\t\t*address;\n&quot;</span><span class="o">.</span>
    <span class="s">&quot;} &quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="o">.</span><span class="s">&quot;EXTERNAL_PATCHES[] __attribute((unused)) = {\n&quot;</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$ident</span> <span class="o">=</span> <span class="nb">pop</span><span class="p">(</span><span class="nv">@external_patches</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$off</span> <span class="o">=</span> <span class="nb">pop</span><span class="p">(</span><span class="nv">@external_patches</span><span class="p">);</span>
    <span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;\t{0x%08x, &amp;%s},\n&quot;</span><span class="p">,</span> <span class="nv">$off</span><span class="p">,</span> <span class="nv">$ident</span><span class="p">;</span>
    <span class="o">++</span><span class="nv">$num_external_patches</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;};\n\n&quot;</span><span class="p">;</span>

<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;static u32 &quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="o">.</span><span class="s">&quot;INSTRUCTIONS __attribute((unused))\t= %d;\n&quot;</span><span class="p">,</span> 
    <span class="nv">$instructions</span><span class="p">;</span>
<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;static u32 &quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="o">.</span><span class="s">&quot;PATCHES __attribute((unused))\t= %d;\n&quot;</span><span class="p">,</span> 
    <span class="nv">$#label_patches</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="nb">printf</span> <span class="n">OUTPUT</span> <span class="s">&quot;static u32 &quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="o">.</span><span class="s">&quot;EXTERNAL_PATCHES_LEN __attribute((unused))\t= %d;\n&quot;</span><span class="p">,</span>
    <span class="nv">$num_external_patches</span><span class="p">;</span>
<span class="nb">close</span> <span class="n">OUTPUT</span><span class="p">;</span>
<span class="nb">close</span> <span class="n">OUTPUTU</span><span class="p">;</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
