<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › g_NCR5380.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>g_NCR5380.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Generic Generic NCR5380 driver</span>
<span class="cm"> *	</span>
<span class="cm"> * Copyright 1993, Drew Eckhardt</span>
<span class="cm"> *	Visionary Computing</span>
<span class="cm"> *	(Unix and Linux consulting and custom programming)</span>
<span class="cm"> *	drew@colorado.edu</span>
<span class="cm"> *      +1 (303) 440-4894</span>
<span class="cm"> *</span>
<span class="cm"> * NCR53C400 extensions (c) 1994,1995,1996, Kevin Lentin</span>
<span class="cm"> *    K.Lentin@cs.monash.edu.au</span>
<span class="cm"> *</span>
<span class="cm"> * NCR53C400A extensions (c) 1996, Ingmar Baumgart</span>
<span class="cm"> *    ingmar@gonzo.schwaben.de</span>
<span class="cm"> *</span>
<span class="cm"> * DTC3181E extensions (c) 1997, Ronald van Cuijlenborg</span>
<span class="cm"> * ronald.van.cuijlenborg@tip.nl or nutty@dds.nl</span>
<span class="cm"> *</span>
<span class="cm"> * Added ISAPNP support for DTC436 adapters,</span>
<span class="cm"> * Thomas Sailer, sailer@ife.ee.ethz.ch</span>
<span class="cm"> *</span>
<span class="cm"> * ALPHA RELEASE 1. </span>
<span class="cm"> *</span>
<span class="cm"> * For more information, please consult </span>
<span class="cm"> *</span>
<span class="cm"> * NCR 5380 Family</span>
<span class="cm"> * SCSI Protocol Controller</span>
<span class="cm"> * Databook</span>
<span class="cm"> *</span>
<span class="cm"> * NCR Microelectronics</span>
<span class="cm"> * 1635 Aeroplaza Drive</span>
<span class="cm"> * Colorado Springs, CO 80916</span>
<span class="cm"> * 1+ (719) 578-3400</span>
<span class="cm"> * 1+ (800) 334-5454</span>
<span class="cm"> */</span>

<span class="cm">/* </span>
<span class="cm"> * TODO : flesh out DMA support, find some one actually using this (I have</span>
<span class="cm"> * 	a memory mapped Trantor board that works fine)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Options :</span>
<span class="cm"> *</span>
<span class="cm"> * PARITY - enable parity checking.  Not supported.</span>
<span class="cm"> *</span>
<span class="cm"> * SCSI2 - enable support for SCSI-II tagged queueing.  Untested.</span>
<span class="cm"> *</span>
<span class="cm"> * USLEEP - enable support for devices that don&#39;t disconnect.  Untested.</span>
<span class="cm"> *</span>
<span class="cm"> * The card is detected and initialized in one of several ways : </span>
<span class="cm"> * 1.  With command line overrides - NCR5380=port,irq may be </span>
<span class="cm"> *     used on the LILO command line to override the defaults.</span>
<span class="cm"> *</span>
<span class="cm"> * 2.  With the GENERIC_NCR5380_OVERRIDE compile time define.  This is </span>
<span class="cm"> *     specified as an array of address, irq, dma, board tuples.  Ie, for</span>
<span class="cm"> *     one board at 0x350, IRQ5, no dma, I could say  </span>
<span class="cm"> *     -DGENERIC_NCR5380_OVERRIDE={{0xcc000, 5, DMA_NONE, BOARD_NCR5380}}</span>
<span class="cm"> * </span>
<span class="cm"> * -1 should be specified for no or DMA interrupt, -2 to autoprobe for an </span>
<span class="cm"> * 	IRQ line if overridden on the command line.</span>
<span class="cm"> *</span>
<span class="cm"> * 3.  When included as a module, with arguments passed on the command line:</span>
<span class="cm"> *         ncr_irq=xx	the interrupt</span>
<span class="cm"> *         ncr_addr=xx  the port or base address (for port or memory</span>
<span class="cm"> *              	mapped, resp.)</span>
<span class="cm"> *         ncr_dma=xx	the DMA</span>
<span class="cm"> *         ncr_5380=1	to set up for a NCR5380 board</span>
<span class="cm"> *         ncr_53c400=1	to set up for a NCR53C400 board</span>
<span class="cm"> *     e.g.</span>
<span class="cm"> *     modprobe g_NCR5380 ncr_irq=5 ncr_addr=0x350 ncr_5380=1</span>
<span class="cm"> *       for a port mapped NCR5380 board or</span>
<span class="cm"> *     modprobe g_NCR5380 ncr_irq=255 ncr_addr=0xc8000 ncr_53c400=1</span>
<span class="cm"> *       for a memory mapped NCR53C400 board with interrupts disabled.</span>
<span class="cm"> * </span>
<span class="cm"> * 255 should be specified for no or DMA interrupt, 254 to autoprobe for an </span>
<span class="cm"> * 	IRQ line if overridden on the command line.</span>
<span class="cm"> *     </span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * $Log: generic_NCR5380.c,v $</span>
<span class="cm"> */</span>

<span class="cm">/* settings for DTC3181E card with only Mustek scanner attached */</span>
<span class="cp">#define USLEEP</span>
<span class="cp">#define USLEEP_POLL	1</span>
<span class="cp">#define USLEEP_SLEEP	20</span>
<span class="cp">#define USLEEP_WAITLONG	500</span>

<span class="cp">#define AUTOPROBE_IRQ</span>
<span class="cp">#define AUTOSENSE</span>


<span class="cp">#ifdef CONFIG_SCSI_GENERIC_NCR53C400</span>
<span class="cp">#define NCR53C400_PSEUDO_DMA 1</span>
<span class="cp">#define PSEUDO_DMA</span>
<span class="cp">#define NCR53C400</span>
<span class="cp">#define NCR5380_STATS</span>
<span class="cp">#undef NCR5380_STAT_LIMIT</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &quot;scsi.h&quot;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &quot;g_NCR5380.h&quot;</span>
<span class="cp">#include &quot;NCR5380.h&quot;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/isapnp.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#define NCR_NOT_SET 0</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ncr_irq</span> <span class="o">=</span> <span class="n">NCR_NOT_SET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ncr_dma</span> <span class="o">=</span> <span class="n">NCR_NOT_SET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ncr_addr</span> <span class="o">=</span> <span class="n">NCR_NOT_SET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ncr_5380</span> <span class="o">=</span> <span class="n">NCR_NOT_SET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ncr_53c400</span> <span class="o">=</span> <span class="n">NCR_NOT_SET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ncr_53c400a</span> <span class="o">=</span> <span class="n">NCR_NOT_SET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtc_3181e</span> <span class="o">=</span> <span class="n">NCR_NOT_SET</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">override</span> <span class="p">{</span>
	<span class="n">NCR5380_map_type</span> <span class="n">NCR5380_map_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">board</span><span class="p">;</span>		<span class="cm">/* Use NCR53c400, Ricoh, etc. extensions ? */</span>
<span class="p">}</span> <span class="n">overrides</span>
<span class="cp">#ifdef GENERIC_NCR5380_OVERRIDE</span>
<span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">GENERIC_NCR5380_OVERRIDE</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,},};</span>
<span class="cp">#endif</span>

<span class="cp">#define NO_OVERRIDES ARRAY_SIZE(overrides)</span>

<span class="cp">#ifndef MODULE</span>

<span class="cm">/**</span>
<span class="cm"> *	internal_setup		-	handle lilo command string override</span>
<span class="cm"> *	@board:	BOARD_* identifier for the board</span>
<span class="cm"> *	@str: unused</span>
<span class="cm"> *	@ints: numeric parameters</span>
<span class="cm"> *</span>
<span class="cm"> * 	Do LILO command line initialization of the overrides array. Display</span>
<span class="cm"> *	errors when needed</span>
<span class="cm"> *</span>
<span class="cm"> *	Locks: none</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">internal_setup</span><span class="p">(</span><span class="kt">int</span> <span class="n">board</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">commandline_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BOARD_NCR5380</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;generic_NCR5380_setup : usage ncr5380=&quot;</span> <span class="n">STRVAL</span><span class="p">(</span><span class="n">NCR5380_map_name</span><span class="p">)</span> <span class="s">&quot;,irq,dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOARD_NCR53C400</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;generic_NCR53C400_setup : usage ncr53c400=&quot;</span> <span class="n">STRVAL</span><span class="p">(</span><span class="n">NCR5380_map_name</span><span class="p">)</span> <span class="s">&quot;,irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOARD_NCR53C400A</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;generic_NCR53C400A_setup : usage ncr53c400a=&quot;</span> <span class="n">STRVAL</span><span class="p">(</span><span class="n">NCR5380_map_name</span><span class="p">)</span> <span class="s">&quot;,irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOARD_DTC3181E</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;generic_DTC3181E_setup : usage dtc3181e=&quot;</span> <span class="n">STRVAL</span><span class="p">(</span><span class="n">NCR5380_map_name</span><span class="p">)</span> <span class="s">&quot;,irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">commandline_current</span> <span class="o">&lt;</span> <span class="n">NO_OVERRIDES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">overrides</span><span class="p">[</span><span class="n">commandline_current</span><span class="p">].</span><span class="n">NCR5380_map_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">NCR5380_map_type</span><span class="p">)</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">overrides</span><span class="p">[</span><span class="n">commandline_current</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">overrides</span><span class="p">[</span><span class="n">commandline_current</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">overrides</span><span class="p">[</span><span class="n">commandline_current</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_NONE</span><span class="p">;</span>
		<span class="n">overrides</span><span class="p">[</span><span class="n">commandline_current</span><span class="p">].</span><span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="p">;</span>
		<span class="o">++</span><span class="n">commandline_current</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * 	do_NCR53C80_setup		-	set up entry point</span>
<span class="cm"> *	@str: unused</span>
<span class="cm"> *</span>
<span class="cm"> *	Setup function invoked at boot to parse the ncr5380= command</span>
<span class="cm"> *	line.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">do_NCR5380_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>
	<span class="n">internal_setup</span><span class="p">(</span><span class="n">BOARD_NCR5380</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 	do_NCR53C400_setup		-	set up entry point</span>
<span class="cm"> *	@str: unused</span>
<span class="cm"> *	@ints: integer parameters from kernel setup code</span>
<span class="cm"> *</span>
<span class="cm"> *	Setup function invoked at boot to parse the ncr53c400= command</span>
<span class="cm"> *	line.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">do_NCR53C400_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>
	<span class="n">internal_setup</span><span class="p">(</span><span class="n">BOARD_NCR53C400</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 	do_NCR53C400A_setup	-	set up entry point</span>
<span class="cm"> *	@str: unused</span>
<span class="cm"> *	@ints: integer parameters from kernel setup code</span>
<span class="cm"> *</span>
<span class="cm"> *	Setup function invoked at boot to parse the ncr53c400a= command</span>
<span class="cm"> *	line.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">do_NCR53C400A_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>
	<span class="n">internal_setup</span><span class="p">(</span><span class="n">BOARD_NCR53C400A</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 	do_DTC3181E_setup	-	set up entry point</span>
<span class="cm"> *	@str: unused</span>
<span class="cm"> *	@ints: integer parameters from kernel setup code</span>
<span class="cm"> *</span>
<span class="cm"> *	Setup function invoked at boot to parse the dtc3181e= command</span>
<span class="cm"> *	line.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">do_DTC3181E_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>
	<span class="n">internal_setup</span><span class="p">(</span><span class="n">BOARD_DTC3181E</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * 	generic_NCR5380_detect	-	look for NCR5380 controllers</span>
<span class="cm"> *	@tpnt: the scsi template</span>
<span class="cm"> *</span>
<span class="cm"> *	Scan for the present of NCR5380, NCR53C400, NCR53C400A, DTC3181E</span>
<span class="cm"> *	and DTC436(ISAPnP) controllers. If overrides have been set we use</span>
<span class="cm"> *	them.</span>
<span class="cm"> *</span>
<span class="cm"> *	The caller supplied NCR5380_init function is invoked from here, before</span>
<span class="cm"> *	the interrupt line is taken.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locks: none</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">generic_NCR5380_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span> <span class="n">tpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">current_override</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ports</span><span class="p">;</span>
<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">region_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">ncr_53c400a_ports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x290</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x310</span><span class="p">,</span> <span class="mh">0x330</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mh">0x348</span><span class="p">,</span> <span class="mh">0x350</span><span class="p">,</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">dtc_3181e_ports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x220</span><span class="p">,</span> <span class="mh">0x240</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2a0</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">;</span>
<span class="cp">#ifdef SCSI_G_NCR5380_MEM</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iomem</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ncr_irq</span> <span class="o">!=</span> <span class="n">NCR_NOT_SET</span><span class="p">)</span>
		<span class="n">overrides</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ncr_irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncr_dma</span> <span class="o">!=</span> <span class="n">NCR_NOT_SET</span><span class="p">)</span>
		<span class="n">overrides</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="n">ncr_dma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncr_addr</span> <span class="o">!=</span> <span class="n">NCR_NOT_SET</span><span class="p">)</span>
		<span class="n">overrides</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">NCR5380_map_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">NCR5380_map_type</span><span class="p">)</span> <span class="n">ncr_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncr_5380</span> <span class="o">!=</span> <span class="n">NCR_NOT_SET</span><span class="p">)</span>
		<span class="n">overrides</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">board</span> <span class="o">=</span> <span class="n">BOARD_NCR5380</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ncr_53c400</span> <span class="o">!=</span> <span class="n">NCR_NOT_SET</span><span class="p">)</span>
		<span class="n">overrides</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">board</span> <span class="o">=</span> <span class="n">BOARD_NCR53C400</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ncr_53c400a</span> <span class="o">!=</span> <span class="n">NCR_NOT_SET</span><span class="p">)</span>
		<span class="n">overrides</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">board</span> <span class="o">=</span> <span class="n">BOARD_NCR53C400A</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dtc_3181e</span> <span class="o">!=</span> <span class="n">NCR_NOT_SET</span><span class="p">)</span>
		<span class="n">overrides</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">board</span> <span class="o">=</span> <span class="n">BOARD_DTC3181E</span><span class="p">;</span>
<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_override</span> <span class="o">&amp;&amp;</span> <span class="n">isapnp_present</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pnp_find_dev</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x436e</span><span class="p">),</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">NO_OVERRIDES</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pnp_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dtc436e probe: activate failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dtc436e probe: no valid port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pnp_irq_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">overrides</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">overrides</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pnp_dma_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">overrides</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">overrides</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_NONE</span><span class="p">;</span>
			<span class="n">overrides</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">NCR5380_map_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">NCR5380_map_type</span><span class="p">)</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">overrides</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">board</span> <span class="o">=</span> <span class="n">BOARD_DTC3181E</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">tpnt</span><span class="o">-&gt;</span><span class="n">proc_name</span> <span class="o">=</span> <span class="s">&quot;g_NCR5380&quot;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">current_override</span> <span class="o">&lt;</span> <span class="n">NO_OVERRIDES</span><span class="p">;</span> <span class="o">++</span><span class="n">current_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">NCR5380_map_name</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ports</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BOARD_NCR5380</span>:
			<span class="n">flags</span> <span class="o">=</span> <span class="n">FLAG_NO_PSEUDO_DMA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BOARD_NCR53C400</span>:
			<span class="n">flags</span> <span class="o">=</span> <span class="n">FLAG_NCR53C400</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BOARD_NCR53C400A</span>:
			<span class="n">flags</span> <span class="o">=</span> <span class="n">FLAG_NO_PSEUDO_DMA</span><span class="p">;</span>
			<span class="n">ports</span> <span class="o">=</span> <span class="n">ncr_53c400a_ports</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BOARD_DTC3181E</span>:
			<span class="n">flags</span> <span class="o">=</span> <span class="n">FLAG_NO_PSEUDO_DMA</span> <span class="o">|</span> <span class="n">FLAG_DTC3181E</span><span class="p">;</span>
			<span class="n">ports</span> <span class="o">=</span> <span class="n">dtc_3181e_ports</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ports</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wakeup sequence for the NCR53C400A and DTC3181E */</span>

			<span class="cm">/* Disable the adapter and look for a free io port */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x779</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">NCR5380_map_name</span> <span class="o">!=</span> <span class="n">PORT_AUTO</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;ncr53c80&quot;</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">NCR5380_map_name</span> <span class="o">==</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">release_region</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;ncr53c80&quot;</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">release_region</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* At this point we have our region reserved */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x779</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x379</span><span class="p">);</span>	<span class="cm">/* set io port to be used */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">,</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">NCR5380_map_name</span> <span class="o">=</span> <span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="cm">/* Not a 53C400A style setup - just grab */</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">NCR5380_map_name</span><span class="p">,</span> <span class="n">NCR5380_region_size</span><span class="p">,</span> <span class="s">&quot;ncr5380&quot;</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">region_size</span> <span class="o">=</span> <span class="n">NCR5380_region_size</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">NCR5380_map_name</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">NCR5380_region_size</span><span class="p">,</span> <span class="s">&quot;ncr5380&quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">iomem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">NCR5380_region_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iomem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">NCR5380_region_size</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">instance</span> <span class="o">=</span> <span class="n">scsi_register</span><span class="p">(</span><span class="n">tpnt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">NCR5380_hostdata</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">NCR5380_map_name</span><span class="p">,</span> <span class="n">region_size</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">iomem</span><span class="p">);</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">NCR5380_region_size</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">NCR5380_instance_name</span> <span class="o">=</span> <span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">NCR5380_map_name</span><span class="p">;</span>
<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="n">region_size</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">NCR5380_hostdata</span> <span class="o">*</span><span class="p">)</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iomem</span> <span class="o">=</span> <span class="n">iomem</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">NCR5380_init</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">IRQ_AUTO</span><span class="p">)</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">overrides</span><span class="p">[</span><span class="n">current_override</span><span class="p">].</span><span class="n">irq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">NCR5380_probe_irq</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">generic_NCR5380_intr</span><span class="p">,</span>
					<span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;NCR5380&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi%d : IRQ%d not free, interrupts disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
				<span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%d : interrupts not enabled. for better interactive performance,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%d : please jumper the board for a free IRQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%d : at &quot;</span> <span class="n">STRVAL</span><span class="p">(</span><span class="n">NCR5380_map_name</span><span class="p">)</span> <span class="s">&quot; 0x%x&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">NCR5380_instance_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; interrupts disabled&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; irq %d&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; options CAN_QUEUE=%d  CMD_PER_LUN=%d release=%d&quot;</span><span class="p">,</span> <span class="n">CAN_QUEUE</span><span class="p">,</span> <span class="n">CMD_PER_LUN</span><span class="p">,</span> <span class="n">GENERIC_NCR5380_PUBLIC_RELEASE</span><span class="p">);</span>
		<span class="n">NCR5380_print_options</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="o">++</span><span class="n">current_override</span><span class="p">;</span>
		<span class="o">++</span><span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	generic_NCR5380_info	-	reporting string</span>
<span class="cm"> *	@host: NCR5380 to report on</span>
<span class="cm"> *</span>
<span class="cm"> *	Report driver information for the NCR5380</span>
<span class="cm"> */</span>
 	
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">generic_NCR5380_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">string</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Generic NCR5380/53C400 Driver&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	generic_NCR5380_release_resources	-	free resources</span>
<span class="cm"> *	@instance: host adapter to clean up </span>
<span class="cm"> *</span>
<span class="cm"> *	Free the generic interface resources from this adapter.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locks: none</span>
<span class="cm"> */</span>
 
<span class="kt">int</span> <span class="nf">generic_NCR5380_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NCR5380_local_declare</span><span class="p">();</span>
	<span class="n">NCR5380_setup</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">instance</span><span class="p">);</span>
	<span class="n">NCR5380_exit</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">NCR5380_instance_name</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">n_io_port</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">iounmap</span><span class="p">(((</span><span class="k">struct</span> <span class="n">NCR5380_hostdata</span> <span class="o">*</span><span class="p">)</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">NCR5380_instance_name</span><span class="p">,</span> <span class="n">NCR5380_region_size</span><span class="p">);</span>
<span class="cp">#endif</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef BIOSPARAM</span>
<span class="cm">/**</span>
<span class="cm"> *	generic_NCR5380_biosparam</span>
<span class="cm"> *	@disk: disk to compute geometry for</span>
<span class="cm"> *	@dev: device identifier for this disk</span>
<span class="cm"> *	@ip: sizes to fill in</span>
<span class="cm"> *</span>
<span class="cm"> *	Generates a BIOS / DOS compatible H-C-S mapping for the specified </span>
<span class="cm"> *	device / size.</span>
<span class="cm"> * </span>
<span class="cm"> * 	XXX Most SCSI boards use this mapping, I could be incorrect.  Someone</span>
<span class="cm"> *	using hard disks on a trantor should verify that this mapping</span>
<span class="cm"> *	corresponds to that used by the BIOS / ASPI driver by running the linux</span>
<span class="cm"> *	fdisk program and matching the H_C_S coordinates to what DOS uses.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locks: none</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">generic_NCR5380_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
			  <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">ip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">capacity</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef NCR53C400_PSEUDO_DMA</span>

<span class="cm">/**</span>
<span class="cm"> *	NCR5380_pread		-	pseudo DMA read</span>
<span class="cm"> *	@instance: adapter to read from</span>
<span class="cm"> *	@dst: buffer to read into</span>
<span class="cm"> *	@len: buffer length</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform a pseudo DMA mode read from an NCR53C400 or equivalent</span>
<span class="cm"> *	controller</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">NCR5380_pread</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bl</span><span class="p">;</span>

	<span class="n">NCR5380_local_declare</span><span class="p">();</span>
	<span class="n">NCR5380_setup</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="n">NCR5380_write</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">,</span> <span class="n">CSR_BASE</span> <span class="o">|</span> <span class="n">CSR_TRANS_DIR</span><span class="p">);</span>
	<span class="n">NCR5380_write</span><span class="p">(</span><span class="n">C400_BLOCK_COUNTER_REG</span><span class="p">,</span> <span class="n">blocks</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bl</span> <span class="o">=</span> <span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_BLOCK_COUNTER_REG</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_GATED_53C80_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53C400r: Got 53C80_IRQ start=%d, blocks=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">blocks</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_HOST_BUF_NOT_RDY</span><span class="p">);</span>

<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">dst</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_HOST_BUFFER</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="cm">/* implies SCSI_G_NCR5380_MEM */</span>
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span> <span class="n">iomem</span> <span class="o">+</span> <span class="n">NCR53C400_host_buffer</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">blocks</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_HOST_BUF_NOT_RDY</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME - no timeout</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>

<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>	
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">dst</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_HOST_BUFFER</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="cm">/* implies SCSI_G_NCR5380_MEM */</span>
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span> <span class="n">iomem</span> <span class="o">+</span> <span class="n">NCR53C400_host_buffer</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">blocks</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_GATED_53C80_IRQ</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;53C400r: no 53C80 gated irq after transfer&quot;</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 *	DON&#39;T DO THIS - THEY NEVER ARRIVE!</span>
<span class="c">	 */</span>
<span class="c">	printk(&quot;53C400r: Waiting for 53C80 registers\n&quot;);</span>
<span class="c">	while (NCR5380_read(C400_CONTROL_STATUS_REG) &amp; CSR_53C80_REG)</span>
<span class="c">		;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">NCR5380_read</span><span class="p">(</span><span class="n">BUS_AND_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BASR_END_DMA_TRANSFER</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53C400r: no end dma signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		
	<span class="n">NCR5380_write</span><span class="p">(</span><span class="n">MODE_REG</span><span class="p">,</span> <span class="n">MR_BASE</span><span class="p">);</span>
	<span class="n">NCR5380_read</span><span class="p">(</span><span class="n">RESET_PARITY_INTERRUPT_REG</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	NCR5380_write		-	pseudo DMA write</span>
<span class="cm"> *	@instance: adapter to read from</span>
<span class="cm"> *	@dst: buffer to read into</span>
<span class="cm"> *	@len: buffer length</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform a pseudo DMA mode read from an NCR53C400 or equivalent</span>
<span class="cm"> *	controller</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">NCR5380_pwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">NCR5380_local_declare</span><span class="p">();</span>
	<span class="n">NCR5380_setup</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="n">NCR5380_write</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">,</span> <span class="n">CSR_BASE</span><span class="p">);</span>
	<span class="n">NCR5380_write</span><span class="p">(</span><span class="n">C400_BLOCK_COUNTER_REG</span><span class="p">,</span> <span class="n">blocks</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_GATED_53C80_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53C400w: Got 53C80_IRQ start=%d, blocks=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">blocks</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">bl</span> <span class="o">=</span> <span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_BLOCK_COUNTER_REG</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_HOST_BUF_NOT_RDY</span><span class="p">)</span>
			<span class="p">;</span> <span class="c1">// FIXME - timeout</span>
<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">NCR5380_write</span><span class="p">(</span><span class="n">C400_HOST_BUFFER</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="cm">/* implies SCSI_G_NCR5380_MEM */</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">iomem</span> <span class="o">+</span> <span class="n">NCR53C400_host_buffer</span><span class="p">,</span> <span class="n">src</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">blocks</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_HOST_BUF_NOT_RDY</span><span class="p">)</span>
			<span class="p">;</span> <span class="c1">// FIXME - no timeout</span>

<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">NCR5380_write</span><span class="p">(</span><span class="n">C400_HOST_BUFFER</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="cm">/* implies SCSI_G_NCR5380_MEM */</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">iomem</span> <span class="o">+</span> <span class="n">NCR53C400_host_buffer</span><span class="p">,</span> <span class="n">src</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">blocks</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(&quot;53C400w: waiting for registers to be available\n&quot;);</span>
<span class="c">	THEY NEVER DO ! while (NCR5380_read(C400_CONTROL_STATUS_REG) &amp; CSR_53C80_REG);</span>
<span class="c">	printk(&quot;53C400w: Got em\n&quot;);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Let&#39;s wait for this instead - could be ugly */</span>
	<span class="cm">/* All documentation says to check for this. Maybe my hardware is too</span>
<span class="cm">	 * fast. Waiting for it seems to work fine! KLL</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">NCR5380_read</span><span class="p">(</span><span class="n">C400_CONTROL_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_GATED_53C80_IRQ</span><span class="p">))</span>
		<span class="p">;</span>	<span class="c1">// FIXME - no timeout</span>

	<span class="cm">/*</span>
<span class="cm">	 * I know. i is certainly != 0 here but the loop is new. See previous</span>
<span class="cm">	 * comment.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">NCR5380_read</span><span class="p">(</span><span class="n">BUS_AND_STATUS_REG</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BASR_END_DMA_TRANSFER</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53C400w: No END OF DMA bit - WHOOPS! BASR=%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;53C400w: no 53C80 gated irq after transfer (last block)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (!(NCR5380_read(BUS_AND_STATUS_REG) &amp; BASR_END_DMA_TRANSFER)) {</span>
<span class="c">		printk(KERN_ERR &quot;53C400w: no end dma signal\n&quot;);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">NCR5380_read</span><span class="p">(</span><span class="n">TARGET_COMMAND_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TCR_LAST_BYTE_SENT</span><span class="p">))</span>
		<span class="p">;</span> 	<span class="c1">// TIMEOUT</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* PSEUDO_DMA */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *	Include the NCR5380 core code that we build our driver around	</span>
<span class="cm"> */</span>
 
<span class="cp">#include &quot;NCR5380.c&quot;</span>

<span class="cp">#define PRINTP(x) len += sprintf(buffer+len, x)</span>
<span class="cp">#define ANDP ,</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sprint_opcode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;0x%02x &quot;</span> <span class="n">ANDP</span> <span class="n">opcode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sprint_command</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprint_opcode</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span> <span class="n">ANDP</span> <span class="n">command</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sprintf_Scsi_Cmnd	-	print a scsi command</span>
<span class="cm"> *	@buffer: buffr to print into</span>
<span class="cm"> *	@len: buffer length</span>
<span class="cm"> *	@cmd: SCSI command block</span>
<span class="cm"> *	</span>
<span class="cm"> *	Print out the target and command data in hex</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sprint_Scsi_Cmnd</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">Scsi_Cmnd</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;host number %d destination target %d, lun %d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="n">ANDP</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span> <span class="n">ANDP</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="n">ANDP</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;        command = &quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprint_command</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	generic_NCR5380_proc_info	-	/proc for NCR5380 driver</span>
<span class="cm"> *	@buffer: buffer to print into</span>
<span class="cm"> *	@start: start position</span>
<span class="cm"> *	@offset: offset into buffer</span>
<span class="cm"> *	@len: length</span>
<span class="cm"> *	@hostno: instance to affect</span>
<span class="cm"> *	@inout: read/write</span>
<span class="cm"> *</span>
<span class="cm"> *	Provide the procfs information for the 5380 controller. We fill</span>
<span class="cm"> *	this with useful debugging information including the commands</span>
<span class="cm"> *	being executed, disconnected command queue and the statistical</span>
<span class="cm"> *	data</span>
<span class="cm"> *</span>
<span class="cm"> *	Locks: global cli/lock for queue walk</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">generic_NCR5380_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_ptr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">NCR5380_local_declare</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">NCR5380_hostdata</span> <span class="o">*</span><span class="n">hostdata</span><span class="p">;</span>
<span class="cp">#ifdef NCR5380_STATS</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">NCR5380_setup</span><span class="p">(</span><span class="n">scsi_ptr</span><span class="p">);</span>
	<span class="n">hostdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NCR5380_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_ptr</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">scsi_ptr</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;SCSI host number %d : %s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="n">ANDP</span> <span class="n">scsi_ptr</span><span class="o">-&gt;</span><span class="n">host_no</span> <span class="n">ANDP</span> <span class="n">scsi_ptr</span><span class="o">-&gt;</span><span class="n">hostt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;Generic NCR5380 driver version %d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="n">ANDP</span> <span class="n">GENERIC_NCR5380_PUBLIC_RELEASE</span><span class="p">);</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;NCR5380 core version %d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="n">ANDP</span> <span class="n">NCR5380_PUBLIC_RELEASE</span><span class="p">);</span>
<span class="cp">#ifdef NCR53C400</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;NCR53C400 extension version %d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="n">ANDP</span> <span class="n">NCR53C400_PUBLIC_RELEASE</span><span class="p">);</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;NCR53C400 card%s detected</span><span class="se">\n</span><span class="s">&quot;</span> <span class="n">ANDP</span><span class="p">(((</span><span class="k">struct</span> <span class="n">NCR5380_hostdata</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_ptr</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_NCR53C400</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; not&quot;</span><span class="p">);</span>
<span class="cp"># if NCR53C400_PSEUDO_DMA</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;NCR53C400 pseudo DMA used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;NO NCR53C400 driver extensions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;Using %s mapping at %s 0x%lx, &quot;</span> <span class="n">ANDP</span> <span class="n">STRVAL</span><span class="p">(</span><span class="n">NCR5380_map_config</span><span class="p">)</span> <span class="n">ANDP</span> <span class="n">STRVAL</span><span class="p">(</span><span class="n">NCR5380_map_name</span><span class="p">)</span> <span class="n">ANDP</span> <span class="n">scsi_ptr</span><span class="o">-&gt;</span><span class="n">NCR5380_instance_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_ptr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">SCSI_IRQ_NONE</span><span class="p">)</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;no interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;on interrupt %d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="n">ANDP</span> <span class="n">scsi_ptr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

<span class="cp">#ifdef NCR5380_STATS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">||</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">issue_queue</span> <span class="o">||</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_queue</span><span class="p">)</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;There are commands pending, transfer rates may be crud</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pendingr</span><span class="p">)</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;  %d pending reads&quot;</span> <span class="n">ANDP</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pendingr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pendingw</span><span class="p">)</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;  %d pending writes&quot;</span> <span class="n">ANDP</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pendingw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pendingr</span> <span class="o">||</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">pendingw</span><span class="p">)</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">scsi_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">br</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">bytes_read</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">bytes_write</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
		<span class="kt">long</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">time_read</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">tw</span> <span class="o">=</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">time_write</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>

		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;  T:%d %s &quot;</span> <span class="n">ANDP</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="n">ANDP</span> <span class="n">scsi_device_type</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span><span class="o">++</span><span class="p">))</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span><span class="o">++</span><span class="p">))</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span><span class="o">++</span><span class="p">))</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span><span class="o">++</span><span class="p">))</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span><span class="o">++</span><span class="p">))</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span><span class="o">++</span><span class="p">))</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>

		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%10ld kb read    in %5ld secs&quot;</span> <span class="n">ANDP</span> <span class="n">br</span> <span class="o">/</span> <span class="mi">1024</span> <span class="n">ANDP</span> <span class="n">tr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="p">)</span>
			<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot; @ %5ld bps&quot;</span> <span class="n">ANDP</span> <span class="n">br</span> <span class="o">/</span> <span class="n">tr</span><span class="p">);</span>

		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%10ld kb written in %5ld secs&quot;</span> <span class="n">ANDP</span> <span class="n">bw</span> <span class="o">/</span> <span class="mi">1024</span> <span class="n">ANDP</span> <span class="n">tw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw</span><span class="p">)</span>
			<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot; @ %5ld bps&quot;</span> <span class="n">ANDP</span> <span class="n">bw</span> <span class="o">/</span> <span class="n">tw</span><span class="p">);</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">NCR5380_read</span><span class="p">(</span><span class="n">STATUS_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SR_REQ</span><span class="p">))</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;REQ not asserted, phase unknown.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">PHASE_UNKNOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PHASE_MASK</span><span class="p">));</span> <span class="o">++</span><span class="n">i</span><span class="p">);</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;Phase %s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="n">ANDP</span> <span class="n">phases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;No currently connected command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprint_Scsi_Cmnd</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;issue_queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">issue_queue</span><span class="p">;</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprint_Scsi_Cmnd</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

	<span class="n">PRINTP</span><span class="p">(</span><span class="s">&quot;disconnected_queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">hostdata</span><span class="o">-&gt;</span><span class="n">disconnected_queue</span><span class="p">;</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Scsi_Cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprint_Scsi_Cmnd</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">scsi_ptr</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef PRINTP</span>
<span class="cp">#undef ANDP</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">proc_info</span>      	<span class="o">=</span> <span class="n">generic_NCR5380_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>           	<span class="o">=</span> <span class="s">&quot;Generic NCR5380/NCR53C400 Scsi Driver&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span>         	<span class="o">=</span> <span class="n">generic_NCR5380_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>        	<span class="o">=</span> <span class="n">generic_NCR5380_release_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>           	<span class="o">=</span> <span class="n">generic_NCR5380_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>   	<span class="o">=</span> <span class="n">generic_NCR5380_queue_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">generic_NCR5380_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>	<span class="o">=</span> <span class="n">generic_NCR5380_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>     	<span class="o">=</span> <span class="n">NCR5380_BIOSPARAM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>      	<span class="o">=</span> <span class="n">CAN_QUEUE</span><span class="p">,</span>
        <span class="p">.</span><span class="n">this_id</span>        	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sg_tablesize</span>   	<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>    	<span class="o">=</span> <span class="n">CMD_PER_LUN</span><span class="p">,</span>
        <span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;scsi_module.c&quot;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">ncr_irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ncr_dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ncr_addr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ncr_5380</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ncr_53c400</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ncr_53c400a</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dtc_3181e</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#ifndef SCSI_G_NCR5380_MEM</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>
	 <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x436e</span><span class="p">),</span>
	 <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">isapnp</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;ncr5380=&quot;</span><span class="p">,</span> <span class="n">do_NCR5380_setup</span><span class="p">);</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;ncr53c400=&quot;</span><span class="p">,</span> <span class="n">do_NCR53C400_setup</span><span class="p">);</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;ncr53c400a=&quot;</span><span class="p">,</span> <span class="n">do_NCR53C400A_setup</span><span class="p">);</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;dtc3181e=&quot;</span><span class="p">,</span> <span class="n">do_DTC3181E_setup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
