<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › BusLogic.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>BusLogic.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">  Linux Driver for BusLogic MultiMaster and FlashPoint SCSI Host Adapters</span>

<span class="cm">  Copyright 1995-1998 by Leonard N. Zubkoff &lt;lnz@dandelion.com&gt;</span>

<span class="cm">  This program is free software; you may redistribute and/or modify it under</span>
<span class="cm">  the terms of the GNU General Public License Version 2 as published by the</span>
<span class="cm">  Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but</span>
<span class="cm">  WITHOUT ANY WARRANTY, without even the implied warranty of MERCHANTABILITY</span>
<span class="cm">  or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm">  for complete details.</span>

<span class="cm">  The author respectfully requests that any modifications to this software be</span>
<span class="cm">  sent directly to him for evaluation and testing.</span>

<span class="cm">  Special thanks to Wayne Yen, Jin-Lon Hon, and Alex Win of BusLogic, whose</span>
<span class="cm">  advice has been invaluable, to David Gentzel, for writing the original Linux</span>
<span class="cm">  BusLogic driver, and to Paul Gortmaker, for being such a dedicated test site.</span>

<span class="cm">  Finally, special thanks to Mylex/BusLogic for making the FlashPoint SCCB</span>
<span class="cm">  Manager available as freely redistributable source code.</span>

<span class="cm">*/</span>

<span class="cp">#define BusLogic_DriverVersion		&quot;2.1.16&quot;</span>
<span class="cp">#define BusLogic_DriverDate		&quot;18 July 2002&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &quot;BusLogic.h&quot;</span>
<span class="cp">#include &quot;FlashPoint.c&quot;</span>

<span class="cp">#ifndef FAILURE</span>
<span class="cp">#define FAILURE (-1)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">Bus_Logic_template</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_DriverOptionsCount is a count of the number of BusLogic Driver</span>
<span class="cm">  Options specifications provided via the Linux Kernel Command Line or via</span>
<span class="cm">  the Loadable Kernel Module Installation Facility.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">BusLogic_DriverOptionsCount</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_DriverOptions is an array of Driver Options structures representing</span>
<span class="cm">  BusLogic Driver Options specifications provided via the Linux Kernel Command</span>
<span class="cm">  Line or via the Loadable Kernel Module Installation Facility.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">BusLogic_DriverOptions</span> <span class="n">BusLogic_DriverOptions</span><span class="p">[</span><span class="n">BusLogic_MaxHostAdapters</span><span class="p">];</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic can be assigned a string by insmod.</span>
<span class="cm">*/</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">BusLogic</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">BusLogic</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ProbeOptions is a set of Probe Options to be applied across</span>
<span class="cm">  all BusLogic Host Adapters.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">BusLogic_ProbeOptions</span> <span class="n">BusLogic_ProbeOptions</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_GlobalOptions is a set of Global Options to be applied across</span>
<span class="cm">  all BusLogic Host Adapters.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">BusLogic_GlobalOptions</span> <span class="n">BusLogic_GlobalOptions</span><span class="p">;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">BusLogic_host_list</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_ProbeInfoCount is the number of entries in BusLogic_ProbeInfoList.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">BusLogic_ProbeInfoCount</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ProbeInfoList is the list of I/O Addresses and Bus Probe Information</span>
<span class="cm">  to be checked for potential BusLogic Host Adapters.  It is initialized by</span>
<span class="cm">  interrogating the PCI Configuration Space on PCI machines as well as from the</span>
<span class="cm">  list of standard BusLogic I/O Addresses.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_CommandFailureReason holds a string identifying the reason why a</span>
<span class="cm">  call to BusLogic_Command failed.  It is only non-NULL when BusLogic_Command</span>
<span class="cm">  returns a failure code.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">BusLogic_CommandFailureReason</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_AnnounceDriver announces the Driver Version and Date, Author&#39;s</span>
<span class="cm">  Name, Copyright Notice, and Electronic Mail Address.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_AnnounceDriver</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BusLogic_Announce</span><span class="p">(</span><span class="s">&quot;***** BusLogic SCSI Driver Version &quot;</span> <span class="n">BusLogic_DriverVersion</span> <span class="s">&quot; of &quot;</span> <span class="n">BusLogic_DriverDate</span> <span class="s">&quot; *****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="n">BusLogic_Announce</span><span class="p">(</span><span class="s">&quot;Copyright 1995-1998 by Leonard N. Zubkoff &quot;</span> <span class="s">&quot;&lt;lnz@dandelion.com&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_DriverInfo returns the Host Adapter Name to identify this SCSI</span>
<span class="cm">  Driver and Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">BusLogic_DriverInfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">Host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_InitializeCCBs initializes a group of Command Control Blocks (CCBs)</span>
<span class="cm">  for Host Adapter from the BlockSize bytes located at BlockPointer.  The newly</span>
<span class="cm">  created CCBs are added to Host Adapter&#39;s free list.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_InitializeCCBs</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">BlockPointer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">BlockSize</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">BlockPointerHandle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="p">)</span> <span class="n">BlockPointer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">BlockPointer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BlockSize</span><span class="p">);</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">AllocationGroupHead</span> <span class="o">=</span> <span class="n">BlockPointerHandle</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">AllocationGroupSize</span> <span class="o">=</span> <span class="n">BlockSize</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">BlockSize</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_CCB</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">BusLogic_CCB_Free</span><span class="p">;</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="p">;</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DMA_Handle</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">BlockPointerHandle</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_FlashPointHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">CallbackFunction</span> <span class="o">=</span> <span class="n">BusLogic_QueueCompletedCCB</span><span class="p">;</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">BaseAddress</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FlashPointInfo</span><span class="p">.</span><span class="n">BaseAddress</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span><span class="p">;</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">NextAll</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">All_CCBs</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span> <span class="o">=</span> <span class="n">CCB</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">All_CCBs</span> <span class="o">=</span> <span class="n">CCB</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">CCB</span><span class="o">++</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_CCB</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_CreateInitialCCBs allocates the initial CCBs for Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">BusLogic_CreateInitialCCBs</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">BlockSize</span> <span class="o">=</span> <span class="n">BusLogic_CCB_AllocationGroupSize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_CCB</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">BlockPointer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">BlockPointerHandle</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">InitialCCBs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BlockPointer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">BlockSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BlockPointerHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BlockPointer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;UNABLE TO ALLOCATE CCB GROUP - DETACHING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BusLogic_InitializeCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BlockPointer</span><span class="p">,</span> <span class="n">BlockSize</span><span class="p">,</span> <span class="n">BlockPointerHandle</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_DestroyCCBs deallocates the CCBs for Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_DestroyCCBs</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">NextCCB</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">All_CCBs</span><span class="p">,</span> <span class="o">*</span><span class="n">CCB</span><span class="p">,</span> <span class="o">*</span><span class="n">Last_CCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">All_CCBs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">CCB</span> <span class="o">=</span> <span class="n">NextCCB</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NextCCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">NextAll</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">AllocationGroupHead</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Last_CCB</span><span class="p">)</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">Last_CCB</span><span class="o">-&gt;</span><span class="n">AllocationGroupSize</span><span class="p">,</span> <span class="n">Last_CCB</span><span class="p">,</span> <span class="n">Last_CCB</span><span class="o">-&gt;</span><span class="n">AllocationGroupHead</span><span class="p">);</span>
			<span class="n">Last_CCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Last_CCB</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">Last_CCB</span><span class="o">-&gt;</span><span class="n">AllocationGroupSize</span><span class="p">,</span> <span class="n">Last_CCB</span><span class="p">,</span> <span class="n">Last_CCB</span><span class="o">-&gt;</span><span class="n">AllocationGroupHead</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_CreateAdditionalCCBs allocates Additional CCBs for Host Adapter.  If</span>
<span class="cm">  allocation fails and there are no remaining CCBs available, the Driver Queue</span>
<span class="cm">  Depth is decreased to a known safe value to avoid potential deadlocks when</span>
<span class="cm">  multiple host adapters share the same IRQ Channel.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_CreateAdditionalCCBs</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">AdditionalCCBs</span><span class="p">,</span> <span class="n">bool</span> <span class="n">SuccessMessageP</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">BlockSize</span> <span class="o">=</span> <span class="n">BusLogic_CCB_AllocationGroupSize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_CCB</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">PreviouslyAllocated</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">BlockPointer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">BlockPointerHandle</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AdditionalCCBs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span> <span class="o">-</span> <span class="n">PreviouslyAllocated</span> <span class="o">&lt;</span> <span class="n">AdditionalCCBs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BlockPointer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">BlockSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BlockPointerHandle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BlockPointer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">BusLogic_InitializeCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BlockPointer</span><span class="p">,</span> <span class="n">BlockSize</span><span class="p">,</span> <span class="n">BlockPointerHandle</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span> <span class="o">&gt;</span> <span class="n">PreviouslyAllocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SuccessMessageP</span><span class="p">)</span>
			<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;Allocated %d additional CCBs (total now %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span> <span class="o">-</span> <span class="n">PreviouslyAllocated</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;Failed to allocate additional CCBs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">&gt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span> <span class="o">-</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetDeviceCount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span> <span class="o">-</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetDeviceCount</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_AllocateCCB allocates a CCB from Host Adapter&#39;s free list,</span>
<span class="cm">  allocating more memory from the Kernel if necessary.  The Host Adapter&#39;s</span>
<span class="cm">  Lock should already have been acquired by the caller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="nf">BusLogic_AllocateCCB</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
						 <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SerialNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span><span class="p">;</span>
	<span class="n">CCB</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span> <span class="o">=</span> <span class="o">++</span><span class="n">SerialNumber</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">;</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">BusLogic_CreateAdditionalCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IncrementalCCBs</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">CCB</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BusLogic_CreateAdditionalCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IncrementalCCBs</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">CCB</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span> <span class="o">=</span> <span class="o">++</span><span class="n">SerialNumber</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">CCB</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_DeallocateCCB deallocates a CCB, returning it to the Host Adapter&#39;s</span>
<span class="cm">  free list.  The Host Adapter&#39;s Lock should already have been acquired by the</span>
<span class="cm">  caller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_DeallocateCCB</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">HostAdapter</span><span class="p">;</span>

	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SenseDataPointer</span><span class="p">,</span>
			 <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SenseDataLength</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Command</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">BusLogic_CCB_Free</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Free_CCBs</span> <span class="o">=</span> <span class="n">CCB</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_Command sends the command OperationCode to HostAdapter, optionally</span>
<span class="cm">  providing ParameterLength bytes of ParameterData and receiving at most</span>
<span class="cm">  ReplyLength bytes of ReplyData; any excess reply data is received but</span>
<span class="cm">  discarded.</span>

<span class="cm">  On success, this function returns the number of reply bytes read from</span>
<span class="cm">  the Host Adapter (including any discarded data); on failure, it returns</span>
<span class="cm">  -1 if the command was invalid, or -2 if a timeout occurred.</span>

<span class="cm">  BusLogic_Command is called exclusively during host adapter detection and</span>
<span class="cm">  initialization, so performance and latency are not critical, and exclusive</span>
<span class="cm">  access to the Host Adapter hardware is assumed.  Once the host adapter and</span>
<span class="cm">  driver are initialized, the only Host Adapter command that is issued is the</span>
<span class="cm">  single byte Execute Mailbox Command operation code, which does not require</span>
<span class="cm">  waiting for the Host Adapter Ready bit to be set in the Status Register.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BusLogic_Command</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="k">enum</span> <span class="n">BusLogic_OperationCode</span> <span class="n">OperationCode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ParameterData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ParameterLength</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ReplyData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ReplyLength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ParameterPointer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ParameterData</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ReplyPointer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ReplyData</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">BusLogic_StatusRegister</span> <span class="n">StatusRegister</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">BusLogic_InterruptRegister</span> <span class="n">InterruptRegister</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ProcessorFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ReplyBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Result</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">TimeoutCounter</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Clear out the Reply Data if provided.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ReplyLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ReplyData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ReplyLength</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   If the IRQ Channel has not yet been acquired, then interrupts must be</span>
<span class="cm">	   disabled while issuing host adapter commands since a Command Complete</span>
<span class="cm">	   interrupt could occur if the IRQ Channel was previously enabled by another</span>
<span class="cm">	   BusLogic Host Adapter or another driver sharing the same IRQ Channel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_ChannelAcquired</span><span class="p">)</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">ProcessorFlags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Wait for the Host Adapter Ready bit to be set and the Command/Parameter</span>
<span class="cm">	   Register Busy bit to be reset in the Status Register.</span>
<span class="cm">	 */</span>
	<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadStatusRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">HostAdapterReady</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">CommandParameterRegisterBusy</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_CommandFailureReason</span> <span class="o">=</span> <span class="s">&quot;Timeout waiting for Host Adapter Ready&quot;</span><span class="p">;</span>
		<span class="n">Result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Write the OperationCode to the Command/Parameter Register.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterCommandCompleted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">BusLogic_WriteCommandParameterRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">OperationCode</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Write any additional Parameter Bytes.</span>
<span class="cm">	 */</span>
	<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ParameterLength</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   Wait 100 microseconds to give the Host Adapter enough time to determine</span>
<span class="cm">		   whether the last value written to the Command/Parameter Register was</span>
<span class="cm">		   valid or not.  If the Command Complete bit is set in the Interrupt</span>
<span class="cm">		   Register, then the Command Invalid bit in the Status Register will be</span>
<span class="cm">		   reset if the Operation Code or Parameter was valid and the command</span>
<span class="cm">		   has completed, or set if the Operation Code or Parameter was invalid.</span>
<span class="cm">		   If the Data In Register Ready bit is set in the Status Register, then</span>
<span class="cm">		   the Operation Code was valid, and data is waiting to be read back</span>
<span class="cm">		   from the Host Adapter.  Otherwise, wait for the Command/Parameter</span>
<span class="cm">		   Register Busy bit in the Status Register to be reset.</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">InterruptRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadInterruptRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadStatusRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">InterruptRegister</span><span class="p">.</span><span class="n">ir</span><span class="p">.</span><span class="n">CommandComplete</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterCommandCompleted</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DataInRegisterReady</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">CommandParameterRegisterBusy</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">BusLogic_WriteCommandParameterRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="o">*</span><span class="n">ParameterPointer</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ParameterLength</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_CommandFailureReason</span> <span class="o">=</span> <span class="s">&quot;Timeout waiting for Parameter Acceptance&quot;</span><span class="p">;</span>
		<span class="n">Result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   The Modify I/O Address command does not cause a Command Complete Interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">BusLogic_ModifyIOAddress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadStatusRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">CommandInvalid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_CommandFailureReason</span> <span class="o">=</span> <span class="s">&quot;Modify I/O Address Invalid&quot;</span><span class="p">;</span>
			<span class="n">Result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceConfiguration</span><span class="p">)</span>
			<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic_Command(%02X) Status = %02X: &quot;</span> <span class="s">&quot;(Modify I/O Address)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">OperationCode</span><span class="p">,</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span><span class="p">);</span>
		<span class="n">Result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Select an appropriate timeout value for awaiting command completion.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">OperationCode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BusLogic_InquireInstalledDevicesID0to7</span>:
	<span class="k">case</span> <span class="n">BusLogic_InquireInstalledDevicesID8to15</span>:
	<span class="k">case</span> <span class="n">BusLogic_InquireTargetDevices</span>:
		<span class="cm">/* Approximately 60 seconds. */</span>
		<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Approximately 1 second. */</span>
		<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Receive any Reply Bytes, waiting for either the Command Complete bit to</span>
<span class="cm">	   be set in the Interrupt Register, or for the Interrupt Handler to set the</span>
<span class="cm">	   Host Adapter Command Completed bit in the Host Adapter structure.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">InterruptRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadInterruptRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadStatusRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">InterruptRegister</span><span class="p">.</span><span class="n">ir</span><span class="p">.</span><span class="n">CommandComplete</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterCommandCompleted</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DataInRegisterReady</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ReplyBytes</span> <span class="o">&lt;=</span> <span class="n">ReplyLength</span><span class="p">)</span>
				<span class="o">*</span><span class="n">ReplyPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">BusLogic_ReadDataInRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">BusLogic_ReadDataInRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">BusLogic_FetchHostAdapterLocalRAM</span> <span class="o">&amp;&amp;</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">HostAdapterReady</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_CommandFailureReason</span> <span class="o">=</span> <span class="s">&quot;Timeout waiting for Command Complete&quot;</span><span class="p">;</span>
		<span class="n">Result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Clear any pending Command Complete Interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">BusLogic_InterruptReset</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Provide tracing information if requested.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceConfiguration</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic_Command(%02X) Status = %02X: %2d ==&gt; %2d:&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">OperationCode</span><span class="p">,</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span><span class="p">,</span> <span class="n">ReplyLength</span><span class="p">,</span> <span class="n">ReplyBytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ReplyLength</span> <span class="o">&gt;</span> <span class="n">ReplyBytes</span><span class="p">)</span>
			<span class="n">ReplyLength</span> <span class="o">=</span> <span class="n">ReplyBytes</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ReplyLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot; %02X&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ReplyData</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Process Command Invalid conditions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">CommandInvalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   Some early BusLogic Host Adapters may not recover properly from</span>
<span class="cm">		   a Command Invalid condition, so if this appears to be the case,</span>
<span class="cm">		   a Soft Reset is issued to the Host Adapter.  Potentially invalid</span>
<span class="cm">		   commands are never attempted after Mailbox Initialization is</span>
<span class="cm">		   performed, so there should be no Host Adapter state lost by a</span>
<span class="cm">		   Soft Reset in response to a Command Invalid condition.</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadStatusRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">CommandInvalid</span> <span class="o">||</span>
		    <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">||</span>
		    <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DataInRegisterReady</span> <span class="o">||</span>
		    <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">CommandParameterRegisterBusy</span> <span class="o">||</span> <span class="o">!</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">HostAdapterReady</span> <span class="o">||</span> <span class="o">!</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">InitializationRequired</span> <span class="o">||</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DiagnosticActive</span> <span class="o">||</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DiagnosticFailure</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_SoftReset</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">BusLogic_CommandFailureReason</span> <span class="o">=</span> <span class="s">&quot;Command Invalid&quot;</span><span class="p">;</span>
		<span class="n">Result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Handle Excess Parameters Supplied conditions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ParameterLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_CommandFailureReason</span> <span class="o">=</span> <span class="s">&quot;Excess Parameters Supplied&quot;</span><span class="p">;</span>
		<span class="n">Result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Indicate the command completed successfully.</span>
<span class="cm">	 */</span>
	<span class="n">BusLogic_CommandFailureReason</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">Result</span> <span class="o">=</span> <span class="n">ReplyBytes</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Restore the interrupt status if necessary and return.</span>
<span class="cm">	 */</span>
      <span class="nl">Done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_ChannelAcquired</span><span class="p">)</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">ProcessorFlags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">Result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_AppendProbeAddressISA appends a single ISA I/O Address to the list</span>
<span class="cm">  of I/O Address and Bus Probe Information to be checked for potential BusLogic</span>
<span class="cm">  Host Adapters.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">IO_Address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">ProbeInfo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ProbeInfoCount</span> <span class="o">&gt;=</span> <span class="n">BusLogic_MaxHostAdapters</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ProbeInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">BusLogic_ProbeInfoCount</span><span class="o">++</span><span class="p">];</span>
	<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterType</span> <span class="o">=</span> <span class="n">BusLogic_MultiMaster</span><span class="p">;</span>
	<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">=</span> <span class="n">BusLogic_ISA_Bus</span><span class="p">;</span>
	<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="n">IO_Address</span><span class="p">;</span>
	<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_InitializeProbeInfoListISA initializes the list of I/O Address and</span>
<span class="cm">  Bus Probe Information to be checked for potential BusLogic SCSI Host Adapters</span>
<span class="cm">  only from the list of standard BusLogic MultiMaster ISA I/O Addresses.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">BusLogic_InitializeProbeInfoListISA</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
						       <span class="o">*</span><span class="n">PrototypeHostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	   If BusLogic Driver Options specifications requested that ISA Bus Probes</span>
<span class="cm">	   be inhibited, do not proceed further.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">NoProbeISA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Append the list of standard BusLogic MultiMaster ISA I/O Addresses.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span> <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe330</span><span class="p">)</span>
		<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x330</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span> <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe334</span><span class="p">)</span>
		<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x334</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span> <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe230</span><span class="p">)</span>
		<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x230</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span> <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe234</span><span class="p">)</span>
		<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x234</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span> <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe130</span><span class="p">)</span>
		<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x130</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span> <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe134</span><span class="p">)</span>
		<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x134</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PCI</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_SortProbeInfo sorts a section of BusLogic_ProbeInfoList in order</span>
<span class="cm">  of increasing PCI Bus and Device Number.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">BusLogic_SortProbeInfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">ProbeInfoList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ProbeInfoCount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">LastInterchange</span> <span class="o">=</span> <span class="n">ProbeInfoCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Bound</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">LastInterchange</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Bound</span> <span class="o">=</span> <span class="n">LastInterchange</span><span class="p">;</span>
		<span class="n">LastInterchange</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">Bound</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">ProbeInfo1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ProbeInfoList</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">ProbeInfo2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ProbeInfoList</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ProbeInfo1</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">&gt;</span> <span class="n">ProbeInfo2</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">||</span> <span class="p">(</span><span class="n">ProbeInfo1</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">==</span> <span class="n">ProbeInfo2</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ProbeInfo1</span><span class="o">-&gt;</span><span class="n">Device</span> <span class="o">&gt;</span> <span class="n">ProbeInfo2</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="n">TempProbeInfo</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TempProbeInfo</span><span class="p">,</span> <span class="n">ProbeInfo1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span><span class="p">));</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ProbeInfo1</span><span class="p">,</span> <span class="n">ProbeInfo2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span><span class="p">));</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ProbeInfo2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TempProbeInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span><span class="p">));</span>
				<span class="n">LastInterchange</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_InitializeMultiMasterProbeInfo initializes the list of I/O Address</span>
<span class="cm">  and Bus Probe Information to be checked for potential BusLogic MultiMaster</span>
<span class="cm">  SCSI Host Adapters by interrogating the PCI Configuration Space on PCI</span>
<span class="cm">  machines as well as from the list of standard BusLogic MultiMaster ISA</span>
<span class="cm">  I/O Addresses.  It returns the number of PCI MultiMaster Host Adapters found.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">BusLogic_InitializeMultiMasterProbeInfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
							  <span class="o">*</span><span class="n">PrototypeHostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">PrimaryProbeInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">BusLogic_ProbeInfoCount</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">NonPrimaryPCIMultiMasterIndex</span> <span class="o">=</span> <span class="n">BusLogic_ProbeInfoCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">NonPrimaryPCIMultiMasterCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCIMultiMasterCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ForceBusDeviceScanningOrder</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ForceBusDeviceScanningOrderChecked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">StandardAddressSeen</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ProbeInfoCount</span> <span class="o">&gt;=</span> <span class="n">BusLogic_MaxHostAdapters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BusLogic_ProbeInfoCount</span><span class="o">++</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">StandardAddressSeen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Iterate over the MultiMaster PCI Host Adapters.  For each enumerated host</span>
<span class="cm">	   adapter, determine whether its ISA Compatible I/O Port is enabled and if</span>
<span class="cm">	   so, whether it is assigned the Primary I/O Address.  A host adapter that is</span>
<span class="cm">	   assigned the Primary I/O Address will always be the preferred boot device.</span>
<span class="cm">	   The MultiMaster BIOS will first recognize a host adapter at the Primary I/O</span>
<span class="cm">	   Address, then any other PCI host adapters, and finally any host adapters</span>
<span class="cm">	   located at the remaining standard ISA I/O Addresses.  When a PCI host</span>
<span class="cm">	   adapter is found with its ISA Compatible I/O Port enabled, a command is</span>
<span class="cm">	   issued to disable the ISA Compatible I/O Port, and it is noted that the</span>
<span class="cm">	   particular standard ISA I/O Address need not be probed.</span>
<span class="cm">	 */</span>
	<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BUSLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BUSLOGIC_MULTIMASTER</span><span class="p">,</span> <span class="n">PCI_Device</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="n">PrototypeHostAdapter</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">BusLogic_PCIHostAdapterInformation</span> <span class="n">PCIHostAdapterInformation</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">BusLogic_ISACompatibleIOPort</span> <span class="n">ModifyIOAddressRequest</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Bus</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Device</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BaseAddress0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BaseAddress1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">IO_Address</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PCI_Address</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">Bus</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">Device</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">IO_Address</span> <span class="o">=</span> <span class="n">BaseAddress0</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">BaseAddress1</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Base Address0 0x%X not I/O for &quot;</span> <span class="s">&quot;MultiMaster Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BaseAddress0</span><span class="p">);</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;at PCI Bus %d Device %d I/O Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">Device</span><span class="p">,</span> <span class="n">IO_Address</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Base Address1 0x%X not Memory for &quot;</span> <span class="s">&quot;MultiMaster Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BaseAddress1</span><span class="p">);</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;at PCI Bus %d Device %d PCI Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">Device</span><span class="p">,</span> <span class="n">PCI_Address</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IRQ_Channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: IRQ Channel %d invalid for &quot;</span> <span class="s">&quot;MultiMaster Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">IRQ_Channel</span><span class="p">);</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;at PCI Bus %d Device %d I/O Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">Device</span><span class="p">,</span> <span class="n">IO_Address</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceProbe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic: PCI MultiMaster Host Adapter &quot;</span> <span class="s">&quot;detected at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic: PCI Bus %d Device %d I/O Address &quot;</span> <span class="s">&quot;0x%X PCI Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">Device</span><span class="p">,</span> <span class="n">IO_Address</span><span class="p">,</span> <span class="n">PCI_Address</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		   Issue the Inquire PCI Host Adapter Information command to determine</span>
<span class="cm">		   the ISA Compatible I/O Port.  If the ISA Compatible I/O Port is</span>
<span class="cm">		   known and enabled, note that the particular Standard ISA I/O</span>
<span class="cm">		   Address should not be probed.</span>
<span class="cm">		 */</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="n">IO_Address</span><span class="p">;</span>
		<span class="n">BusLogic_InterruptReset</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquirePCIHostAdapterInformation</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PCIHostAdapterInformation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PCIHostAdapterInformation</span><span class="p">))</span>
		    <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PCIHostAdapterInformation</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PCIHostAdapterInformation</span><span class="p">.</span><span class="n">ISACompatibleIOPort</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">StandardAddressSeen</span><span class="p">[</span><span class="n">PCIHostAdapterInformation</span><span class="p">.</span><span class="n">ISACompatibleIOPort</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">PCIHostAdapterInformation</span><span class="p">.</span><span class="n">ISACompatibleIOPort</span> <span class="o">=</span> <span class="n">BusLogic_IO_Disable</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Issue the Modify I/O Address command to disable the ISA Compatible</span>
<span class="cm">		 * I/O Port.  On PCI Host Adapters, the Modify I/O Address command</span>
<span class="cm">		 * allows modification of the ISA compatible I/O Address that the Host</span>
<span class="cm">		 * Adapter responds to; it does not affect the PCI compliant I/O Address</span>
<span class="cm">		 * assigned at system initialization.</span>
<span class="cm">		 */</span>
		<span class="n">ModifyIOAddressRequest</span> <span class="o">=</span> <span class="n">BusLogic_IO_Disable</span><span class="p">;</span>
		<span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_ModifyIOAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ModifyIOAddressRequest</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ModifyIOAddressRequest</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		   For the first MultiMaster Host Adapter enumerated, issue the Fetch</span>
<span class="cm">		   Host Adapter Local RAM command to read byte 45 of the AutoSCSI area,</span>
<span class="cm">		   for the setting of the &quot;Use Bus And Device # For PCI Scanning Seq.&quot;</span>
<span class="cm">		   option.  Issue the Inquire Board ID command since this option is</span>
<span class="cm">		   only valid for the BT-948/958/958D.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ForceBusDeviceScanningOrderChecked</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">BusLogic_FetchHostAdapterLocalRAMRequest</span> <span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">BusLogic_AutoSCSIByte45</span> <span class="n">AutoSCSIByte45</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">BusLogic_BoardID</span> <span class="n">BoardID</span><span class="p">;</span>
			<span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">.</span><span class="n">ByteOffset</span> <span class="o">=</span> <span class="n">BusLogic_AutoSCSI_BaseOffset</span> <span class="o">+</span> <span class="mi">45</span><span class="p">;</span>
			<span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">.</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AutoSCSIByte45</span><span class="p">);</span>
			<span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_FetchHostAdapterLocalRAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">AutoSCSIByte45</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AutoSCSIByte45</span><span class="p">));</span>
			<span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireBoardID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BoardID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BoardID</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BoardID</span><span class="p">.</span><span class="n">FirmwareVersion1stDigit</span> <span class="o">==</span> <span class="sc">&#39;5&#39;</span><span class="p">)</span>
				<span class="n">ForceBusDeviceScanningOrder</span> <span class="o">=</span> <span class="n">AutoSCSIByte45</span><span class="p">.</span><span class="n">ForceBusDeviceScanningOrder</span><span class="p">;</span>
			<span class="n">ForceBusDeviceScanningOrderChecked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		   Determine whether this MultiMaster Host Adapter has its ISA</span>
<span class="cm">		   Compatible I/O Port enabled and is assigned the Primary I/O Address.</span>
<span class="cm">		   If it does, then it is the Primary MultiMaster Host Adapter and must</span>
<span class="cm">		   be recognized first.  If it does not, then it is added to the list</span>
<span class="cm">		   for probing after any Primary MultiMaster Host Adapter is probed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCIHostAdapterInformation</span><span class="p">.</span><span class="n">ISACompatibleIOPort</span> <span class="o">==</span> <span class="n">BusLogic_IO_330</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterType</span> <span class="o">=</span> <span class="n">BusLogic_MultiMaster</span><span class="p">;</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">=</span> <span class="n">BusLogic_PCI_Bus</span><span class="p">;</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="n">IO_Address</span><span class="p">;</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">PCI_Address</span><span class="p">;</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">Bus</span><span class="p">;</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">Device</span> <span class="o">=</span> <span class="n">Device</span><span class="p">;</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">IRQ_Channel</span><span class="p">;</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">pci_dev_get</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">);</span>
			<span class="n">PCIMultiMasterCount</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ProbeInfoCount</span> <span class="o">&lt;</span> <span class="n">BusLogic_MaxHostAdapters</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">ProbeInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">BusLogic_ProbeInfoCount</span><span class="o">++</span><span class="p">];</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterType</span> <span class="o">=</span> <span class="n">BusLogic_MultiMaster</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">=</span> <span class="n">BusLogic_PCI_Bus</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="n">IO_Address</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">PCI_Address</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">Bus</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">Device</span> <span class="o">=</span> <span class="n">Device</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">IRQ_Channel</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">pci_dev_get</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">);</span>
			<span class="n">NonPrimaryPCIMultiMasterCount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">PCIMultiMasterCount</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;BusLogic: Too many Host Adapters &quot;</span> <span class="s">&quot;detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   If the AutoSCSI &quot;Use Bus And Device # For PCI Scanning Seq.&quot; option is ON</span>
<span class="cm">	   for the first enumerated MultiMaster Host Adapter, and if that host adapter</span>
<span class="cm">	   is a BT-948/958/958D, then the MultiMaster BIOS will recognize MultiMaster</span>
<span class="cm">	   Host Adapters in the order of increasing PCI Bus and Device Number.  In</span>
<span class="cm">	   that case, sort the probe information into the same order the BIOS uses.</span>
<span class="cm">	   If this option is OFF, then the MultiMaster BIOS will recognize MultiMaster</span>
<span class="cm">	   Host Adapters in the order they are enumerated by the PCI BIOS, and hence</span>
<span class="cm">	   no sorting is necessary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ForceBusDeviceScanningOrder</span><span class="p">)</span>
		<span class="n">BusLogic_SortProbeInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">NonPrimaryPCIMultiMasterIndex</span><span class="p">],</span> <span class="n">NonPrimaryPCIMultiMasterCount</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   If no PCI MultiMaster Host Adapter is assigned the Primary I/O Address,</span>
<span class="cm">	   then the Primary I/O Address must be probed explicitly before any PCI</span>
<span class="cm">	   host adapters are probed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">NoProbeISA</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span>
				 <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe330</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterType</span> <span class="o">=</span> <span class="n">BusLogic_MultiMaster</span><span class="p">;</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">=</span> <span class="n">BusLogic_ISA_Bus</span><span class="p">;</span>
			<span class="n">PrimaryProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="mh">0x330</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Append the list of standard BusLogic MultiMaster ISA I/O Addresses,</span>
<span class="cm">	   omitting the Primary I/O Address which has already been handled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">NoProbeISA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StandardAddressSeen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span>
				 <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe334</span><span class="p">))</span>
			<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x334</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StandardAddressSeen</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span>
				 <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe230</span><span class="p">))</span>
			<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x230</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StandardAddressSeen</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span>
				 <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe234</span><span class="p">))</span>
			<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x234</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StandardAddressSeen</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span>
				 <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe130</span><span class="p">))</span>
			<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x130</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StandardAddressSeen</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">||</span>
				 <span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe134</span><span class="p">))</span>
			<span class="n">BusLogic_AppendProbeAddressISA</span><span class="p">(</span><span class="mh">0x134</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Iterate over the older non-compliant MultiMaster PCI Host Adapters,</span>
<span class="cm">	   noting the PCI bus location and assigned IRQ Channel.</span>
<span class="cm">	 */</span>
	<span class="n">PCI_Device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BUSLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BUSLOGIC_MULTIMASTER_NC</span><span class="p">,</span> <span class="n">PCI_Device</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Bus</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Device</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">IO_Address</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">Bus</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">Device</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">IO_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IO_Address</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">IRQ_Channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BusLogic_ProbeInfoCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">ProbeInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">==</span> <span class="n">IO_Address</span> <span class="o">&amp;&amp;</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterType</span> <span class="o">==</span> <span class="n">BusLogic_MultiMaster</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">=</span> <span class="n">BusLogic_PCI_Bus</span><span class="p">;</span>
				<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">Bus</span><span class="p">;</span>
				<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">Device</span> <span class="o">=</span> <span class="n">Device</span><span class="p">;</span>
				<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">IRQ_Channel</span><span class="p">;</span>
				<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">pci_dev_get</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PCIMultiMasterCount</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_InitializeFlashPointProbeInfo initializes the list of I/O Address</span>
<span class="cm">  and Bus Probe Information to be checked for potential BusLogic FlashPoint</span>
<span class="cm">  Host Adapters by interrogating the PCI Configuration Space.  It returns the</span>
<span class="cm">  number of FlashPoint Host Adapters found.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">BusLogic_InitializeFlashPointProbeInfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
							 <span class="o">*</span><span class="n">PrototypeHostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">FlashPointIndex</span> <span class="o">=</span> <span class="n">BusLogic_ProbeInfoCount</span><span class="p">,</span> <span class="n">FlashPointCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Interrogate PCI Configuration Space for any FlashPoint Host Adapters.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BUSLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BUSLOGIC_FLASHPOINT</span><span class="p">,</span> <span class="n">PCI_Device</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Bus</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Device</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BaseAddress0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BaseAddress1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">IO_Address</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PCI_Address</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">Bus</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">Device</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">IO_Address</span> <span class="o">=</span> <span class="n">BaseAddress0</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">BaseAddress1</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SCSI_FLASHPOINT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Base Address0 0x%X not I/O for &quot;</span> <span class="s">&quot;FlashPoint Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BaseAddress0</span><span class="p">);</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;at PCI Bus %d Device %d I/O Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">Device</span><span class="p">,</span> <span class="n">IO_Address</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Base Address1 0x%X not Memory for &quot;</span> <span class="s">&quot;FlashPoint Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BaseAddress1</span><span class="p">);</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;at PCI Bus %d Device %d PCI Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">Device</span><span class="p">,</span> <span class="n">PCI_Address</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IRQ_Channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: IRQ Channel %d invalid for &quot;</span> <span class="s">&quot;FlashPoint Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">IRQ_Channel</span><span class="p">);</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;at PCI Bus %d Device %d I/O Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">Device</span><span class="p">,</span> <span class="n">IO_Address</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceProbe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic: FlashPoint Host Adapter &quot;</span> <span class="s">&quot;detected at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic: PCI Bus %d Device %d I/O Address &quot;</span> <span class="s">&quot;0x%X PCI Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">Device</span><span class="p">,</span> <span class="n">IO_Address</span><span class="p">,</span> <span class="n">PCI_Address</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ProbeInfoCount</span> <span class="o">&lt;</span> <span class="n">BusLogic_MaxHostAdapters</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">ProbeInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">BusLogic_ProbeInfoCount</span><span class="o">++</span><span class="p">];</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterType</span> <span class="o">=</span> <span class="n">BusLogic_FlashPoint</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">=</span> <span class="n">BusLogic_PCI_Bus</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="n">IO_Address</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">PCI_Address</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">Bus</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">Device</span> <span class="o">=</span> <span class="n">Device</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">IRQ_Channel</span><span class="p">;</span>
			<span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">pci_dev_get</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">);</span>
			<span class="n">FlashPointCount</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;BusLogic: Too many Host Adapters &quot;</span> <span class="s">&quot;detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: FlashPoint Host Adapter detected at &quot;</span> <span class="s">&quot;PCI Bus %d Device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">Device</span><span class="p">);</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: I/O Address 0x%X PCI Address 0x%X, irq %d, &quot;</span> <span class="s">&quot;but FlashPoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">IO_Address</span><span class="p">,</span> <span class="n">PCI_Address</span><span class="p">,</span> <span class="n">IRQ_Channel</span><span class="p">);</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: support was omitted in this kernel &quot;</span> <span class="s">&quot;configuration.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   The FlashPoint BIOS will scan for FlashPoint Host Adapters in the order of</span>
<span class="cm">	   increasing PCI Bus and Device Number, so sort the probe information into</span>
<span class="cm">	   the same order the BIOS uses.</span>
<span class="cm">	 */</span>
	<span class="n">BusLogic_SortProbeInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">FlashPointIndex</span><span class="p">],</span> <span class="n">FlashPointCount</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FlashPointCount</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_InitializeProbeInfoList initializes the list of I/O Address and Bus</span>
<span class="cm">  Probe Information to be checked for potential BusLogic SCSI Host Adapters by</span>
<span class="cm">  interrogating the PCI Configuration Space on PCI machines as well as from the</span>
<span class="cm">  list of standard BusLogic MultiMaster ISA I/O Addresses.  By default, if both</span>
<span class="cm">  FlashPoint and PCI MultiMaster Host Adapters are present, this driver will</span>
<span class="cm">  probe for FlashPoint Host Adapters first unless the BIOS primary disk is</span>
<span class="cm">  controlled by the first PCI MultiMaster Host Adapter, in which case</span>
<span class="cm">  MultiMaster Host Adapters will be probed first.  The BusLogic Driver Options</span>
<span class="cm">  specifications &quot;MultiMasterFirst&quot; and &quot;FlashPointFirst&quot; can be used to force</span>
<span class="cm">  a particular probe order.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">BusLogic_InitializeProbeInfoList</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
						    <span class="o">*</span><span class="n">PrototypeHostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	   If a PCI BIOS is present, interrogate it for MultiMaster and FlashPoint</span>
<span class="cm">	   Host Adapters; otherwise, default to the standard ISA MultiMaster probe.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">NoProbePCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">MultiMasterFirst</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_InitializeMultiMasterProbeInfo</span><span class="p">(</span><span class="n">PrototypeHostAdapter</span><span class="p">);</span>
			<span class="n">BusLogic_InitializeFlashPointProbeInfo</span><span class="p">(</span><span class="n">PrototypeHostAdapter</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">FlashPointFirst</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_InitializeFlashPointProbeInfo</span><span class="p">(</span><span class="n">PrototypeHostAdapter</span><span class="p">);</span>
			<span class="n">BusLogic_InitializeMultiMasterProbeInfo</span><span class="p">(</span><span class="n">PrototypeHostAdapter</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">FlashPointCount</span> <span class="o">=</span> <span class="n">BusLogic_InitializeFlashPointProbeInfo</span><span class="p">(</span><span class="n">PrototypeHostAdapter</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">PCIMultiMasterCount</span> <span class="o">=</span> <span class="n">BusLogic_InitializeMultiMasterProbeInfo</span><span class="p">(</span><span class="n">PrototypeHostAdapter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FlashPointCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">PCIMultiMasterCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">ProbeInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">FlashPointCount</span><span class="p">];</span>
				<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="n">PrototypeHostAdapter</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">BusLogic_FetchHostAdapterLocalRAMRequest</span> <span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">BusLogic_BIOSDriveMapByte</span> <span class="n">Drive0MapByte</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">!=</span> <span class="n">BusLogic_PCI_Bus</span><span class="p">)</span>
					<span class="n">ProbeInfo</span><span class="o">++</span><span class="p">;</span>
				<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">;</span>
				<span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">.</span><span class="n">ByteOffset</span> <span class="o">=</span> <span class="n">BusLogic_BIOS_BaseOffset</span> <span class="o">+</span> <span class="n">BusLogic_BIOS_DriveMapOffset</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">.</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Drive0MapByte</span><span class="p">);</span>
				<span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_FetchHostAdapterLocalRAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">Drive0MapByte</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Drive0MapByte</span><span class="p">));</span>
				<span class="cm">/*</span>
<span class="cm">				   If the Map Byte for BIOS Drive 0 indicates that BIOS Drive 0</span>
<span class="cm">				   is controlled by this PCI MultiMaster Host Adapter, then</span>
<span class="cm">				   reverse the probe order so that MultiMaster Host Adapters are</span>
<span class="cm">				   probed before FlashPoint Host Adapters.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Drive0MapByte</span><span class="p">.</span><span class="n">DiskGeometry</span> <span class="o">!=</span> <span class="n">BusLogic_BIOS_Disk_Not_Installed</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="n">SavedProbeInfo</span><span class="p">[</span><span class="n">BusLogic_MaxHostAdapters</span><span class="p">];</span>
					<span class="kt">int</span> <span class="n">MultiMasterCount</span> <span class="o">=</span> <span class="n">BusLogic_ProbeInfoCount</span> <span class="o">-</span> <span class="n">FlashPointCount</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">SavedProbeInfo</span><span class="p">,</span> <span class="n">BusLogic_ProbeInfoList</span><span class="p">,</span> <span class="n">BusLogic_ProbeInfoCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span><span class="p">));</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SavedProbeInfo</span><span class="p">[</span><span class="n">FlashPointCount</span><span class="p">],</span> <span class="n">MultiMasterCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span><span class="p">));</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">MultiMasterCount</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SavedProbeInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">FlashPointCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BusLogic_InitializeProbeInfoListISA</span><span class="p">(</span><span class="n">PrototypeHostAdapter</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#else</span>
<span class="cp">#define BusLogic_InitializeProbeInfoList(adapter) \</span>
<span class="cp">		BusLogic_InitializeProbeInfoListISA(adapter)</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_Failure prints a standardized error message, and then returns false.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">BusLogic_Failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ErrorMessage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BusLogic_AnnounceDriver</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">==</span> <span class="n">BusLogic_PCI_Bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;While configuring BusLogic PCI Host Adapter at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;Bus %d Device %d I/O Address 0x%X PCI Address 0x%X:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;While configuring BusLogic Host Adapter at &quot;</span> <span class="s">&quot;I/O Address 0x%X:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">);</span>
	<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;%s FAILED - DETACHING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">ErrorMessage</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_CommandFailureReason</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;ADDITIONAL FAILURE INFO - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_CommandFailureReason</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ProbeHostAdapter probes for a BusLogic Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">BusLogic_ProbeHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">BusLogic_StatusRegister</span> <span class="n">StatusRegister</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">BusLogic_InterruptRegister</span> <span class="n">InterruptRegister</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">BusLogic_GeometryRegister</span> <span class="n">GeometryRegister</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   FlashPoint Host Adapters are Probed by the FlashPoint SCCB Manager.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_FlashPointHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">FlashPoint_Info</span> <span class="o">*</span><span class="n">FlashPointInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FlashPointInfo</span><span class="p">;</span>
		<span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">BaseAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">;</span>
		<span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">;</span>
		<span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">Present</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FlashPoint_ProbeHostAdapter</span><span class="p">(</span><span class="n">FlashPointInfo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">Present</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: FlashPoint Host Adapter detected at &quot;</span> <span class="s">&quot;PCI Bus %d Device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">);</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: I/O Address 0x%X PCI Address 0x%X, &quot;</span> <span class="s">&quot;but FlashPoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">);</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Probe Function failed to validate it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceProbe</span><span class="p">)</span>
			<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic_Probe(0x%X): FlashPoint Found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		   Indicate the Host Adapter Probe completed successfully.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Read the Status, Interrupt, and Geometry Registers to test if there are I/O</span>
<span class="cm">	   ports that respond, and to check the values to determine if they are from a</span>
<span class="cm">	   BusLogic Host Adapter.  A nonexistent I/O port will return 0xFF, in which</span>
<span class="cm">	   case there is definitely no BusLogic Host Adapter at this base I/O Address.</span>
<span class="cm">	   The test here is a subset of that used by the BusLogic Host Adapter BIOS.</span>
<span class="cm">	 */</span>
	<span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadStatusRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="n">InterruptRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadInterruptRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="n">GeometryRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadGeometryRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceProbe</span><span class="p">)</span>
		<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic_Probe(0x%X): Status 0x%02X, Interrupt 0x%02X, &quot;</span> <span class="s">&quot;Geometry 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span><span class="p">,</span> <span class="n">InterruptRegister</span><span class="p">.</span><span class="n">All</span><span class="p">,</span> <span class="n">GeometryRegister</span><span class="p">.</span><span class="n">All</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DiagnosticActive</span> <span class="o">||</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">CommandParameterRegisterBusy</span> <span class="o">||</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">||</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">CommandInvalid</span> <span class="o">||</span> <span class="n">InterruptRegister</span><span class="p">.</span><span class="n">ir</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Check the undocumented Geometry Register to test if there is an I/O port</span>
<span class="cm">	   that responded.  Adaptec Host Adapters do not implement the Geometry</span>
<span class="cm">	   Register, so this test helps serve to avoid incorrectly recognizing an</span>
<span class="cm">	   Adaptec 1542A or 1542B as a BusLogic.  Unfortunately, the Adaptec 1542C</span>
<span class="cm">	   series does respond to the Geometry Register I/O port, but it will be</span>
<span class="cm">	   rejected later when the Inquire Extended Setup Information command is</span>
<span class="cm">	   issued in BusLogic_CheckHostAdapter.  The AMI FastDisk Host Adapter is a</span>
<span class="cm">	   BusLogic clone that implements the same interface as earlier BusLogic</span>
<span class="cm">	   Host Adapters, including the undocumented commands, and is therefore</span>
<span class="cm">	   supported by this driver.  However, the AMI FastDisk always returns 0x00</span>
<span class="cm">	   upon reading the Geometry Register, so the extended translation option</span>
<span class="cm">	   should always be left disabled on the AMI FastDisk.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GeometryRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Indicate the Host Adapter Probe completed successfully.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_HardwareResetHostAdapter issues a Hardware Reset to the Host Adapter</span>
<span class="cm">  and waits for Host Adapter Diagnostics to complete.  If HardReset is true, a</span>
<span class="cm">  Hard Reset is performed which also initiates a SCSI Bus Reset.  Otherwise, a</span>
<span class="cm">  Soft Reset is performed which only resets the Host Adapter without forcing a</span>
<span class="cm">  SCSI Bus Reset.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">BusLogic_HardwareResetHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
						 <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">HardReset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">BusLogic_StatusRegister</span> <span class="n">StatusRegister</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TimeoutCounter</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   FlashPoint Host Adapters are Hard Reset by the FlashPoint SCCB Manager.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_FlashPointHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">FlashPoint_Info</span> <span class="o">*</span><span class="n">FlashPointInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FlashPointInfo</span><span class="p">;</span>
		<span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">HostSoftReset</span> <span class="o">=</span> <span class="o">!</span><span class="n">HardReset</span><span class="p">;</span>
		<span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">ReportDataUnderrun</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CardHandle</span> <span class="o">=</span> <span class="n">FlashPoint_HardwareResetHostAdapter</span><span class="p">(</span><span class="n">FlashPointInfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CardHandle</span> <span class="o">==</span> <span class="n">FlashPoint_BadCardHandle</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		   Indicate the Host Adapter Hard Reset completed successfully.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue a Hard Reset or Soft Reset Command to the Host Adapter.  The Host</span>
<span class="cm">	   Adapter should respond by setting Diagnostic Active in the Status Register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HardReset</span><span class="p">)</span>
		<span class="n">BusLogic_HardReset</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">BusLogic_SoftReset</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Wait until Diagnostic Active is set in the Status Register.</span>
<span class="cm">	 */</span>
	<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadStatusRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DiagnosticActive</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceHardwareReset</span><span class="p">)</span>
		<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic_HardwareReset(0x%X): Diagnostic Active, &quot;</span> <span class="s">&quot;Status 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Wait 100 microseconds to allow completion of any initial diagnostic</span>
<span class="cm">	   activity which might leave the contents of the Status Register</span>
<span class="cm">	   unpredictable.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Wait until Diagnostic Active is reset in the Status Register.</span>
<span class="cm">	 */</span>
	<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadStatusRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DiagnosticActive</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceHardwareReset</span><span class="p">)</span>
		<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic_HardwareReset(0x%X): Diagnostic Completed, &quot;</span> <span class="s">&quot;Status 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Wait until at least one of the Diagnostic Failure, Host Adapter Ready,</span>
<span class="cm">	   or Data In Register Ready bits is set in the Status Register.</span>
<span class="cm">	 */</span>
	<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadStatusRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DiagnosticFailure</span> <span class="o">||</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">HostAdapterReady</span> <span class="o">||</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DataInRegisterReady</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceHardwareReset</span><span class="p">)</span>
		<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic_HardwareReset(0x%X): Host Adapter Ready, &quot;</span> <span class="s">&quot;Status 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   If Diagnostic Failure is set or Host Adapter Ready is reset, then an</span>
<span class="cm">	   error occurred during the Host Adapter diagnostics.  If Data In Register</span>
<span class="cm">	   Ready is set, then there is an Error Code available.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DiagnosticFailure</span> <span class="o">||</span> <span class="o">!</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">HostAdapterReady</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_CommandFailureReason</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;HARD RESET DIAGNOSTICS&quot;</span><span class="p">);</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;HOST ADAPTER STATUS REGISTER = %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">StatusRegister</span><span class="p">.</span><span class="n">All</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StatusRegister</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">DataInRegisterReady</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ErrorCode</span> <span class="o">=</span> <span class="n">BusLogic_ReadDataInRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;HOST ADAPTER ERROR CODE = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">ErrorCode</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Indicate the Host Adapter Hard Reset completed successfully.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_CheckHostAdapter checks to be sure this really is a BusLogic</span>
<span class="cm">  Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">BusLogic_CheckHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_ExtendedSetupInformation</span> <span class="n">ExtendedSetupInformation</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RequestedReplyLength</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">Result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   FlashPoint Host Adapters do not require this protection.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_FlashPointHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Extended Setup Information command.  Only genuine</span>
<span class="cm">	   BusLogic Host Adapters and true clones support this command.  Adaptec 1542C</span>
<span class="cm">	   series Host Adapters that respond to the Geometry Register I/O port will</span>
<span class="cm">	   fail this command.</span>
<span class="cm">	 */</span>
	<span class="n">RequestedReplyLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireExtendedSetupInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequestedReplyLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RequestedReplyLength</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ExtendedSetupInformation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">))</span>
	    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">))</span>
		<span class="n">Result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Provide tracing information if requested and return.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceProbe</span><span class="p">)</span>
		<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;BusLogic_Check(0x%X): MultiMaster %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="p">(</span><span class="n">Result</span> <span class="o">?</span> <span class="s">&quot;Found&quot;</span> <span class="o">:</span> <span class="s">&quot;Not Found&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">Result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ReadHostAdapterConfiguration reads the Configuration Information</span>
<span class="cm">  from Host Adapter and initializes the Host Adapter structure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">BusLogic_ReadHostAdapterConfiguration</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
							    <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_BoardID</span> <span class="n">BoardID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_Configuration</span> <span class="n">Configuration</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_SetupInformation</span> <span class="n">SetupInformation</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_ExtendedSetupInformation</span> <span class="n">ExtendedSetupInformation</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">HostAdapterModelNumber</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FirmwareVersion3rdDigit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FirmwareVersionLetter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_PCIHostAdapterInformation</span> <span class="n">PCIHostAdapterInformation</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_FetchHostAdapterLocalRAMRequest</span> <span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_AutoSCSIData</span> <span class="n">AutoSCSIData</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">BusLogic_GeometryRegister</span> <span class="n">GeometryRegister</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RequestedReplyLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">TargetPointer</span><span class="p">,</span> <span class="n">Character</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Configuration Information for FlashPoint Host Adapters is provided in the</span>
<span class="cm">	   FlashPoint_Info structure by the FlashPoint SCCB Manager&#39;s Probe Function.</span>
<span class="cm">	   Initialize fields in the Host Adapter structure from the FlashPoint_Info</span>
<span class="cm">	   structure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_FlashPointHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">FlashPoint_Info</span> <span class="o">*</span><span class="n">FlashPointInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FlashPointInfo</span><span class="p">;</span>
		<span class="n">TargetPointer</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">;</span>
		<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;T&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">ModelNumber</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">ModelNumber</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="n">FlashPoint_FirmwareVersion</span><span class="p">);</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExtendedTranslationEnabled</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">ExtendedTranslationEnabled</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ParityCheckingEnabled</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">ParityCheckingEnabled</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BusResetEnabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">HostSoftReset</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LevelSensitiveInterrupt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostWideSCSI</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">HostWideSCSI</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostDifferentialSCSI</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostSupportsSCAM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostUltraSCSI</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExtendedLUNSupport</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TerminationInfoValid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LowByteTerminated</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">LowByteTerminated</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HighByteTerminated</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">HighByteTerminated</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCAM_Enabled</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">SCAM_Enabled</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCAM_Level2</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">SCAM_Level2</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span> <span class="o">=</span> <span class="n">BusLogic_ScatterGatherLimit</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span> <span class="o">=</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostWideSCSI</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxLogicalUnits</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">InitialCCBs</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">BusLogic_CCB_AllocationGroupSize</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IncrementalCCBs</span> <span class="o">=</span> <span class="n">BusLogic_CCB_AllocationGroupSize</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterQueueDepth</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SynchronousPermitted</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">SynchronousPermitted</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FastPermitted</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">FastPermitted</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UltraPermitted</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">UltraPermitted</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">WidePermitted</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">WidePermitted</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DisconnectPermitted</span> <span class="o">=</span> <span class="n">FlashPointInfo</span><span class="o">-&gt;</span><span class="n">DisconnectPermitted</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Common</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Board ID command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireBoardID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BoardID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BoardID</span><span class="p">))</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BoardID</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE BOARD ID&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Configuration command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireConfiguration</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Configuration</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Configuration</span><span class="p">))</span>
	    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Configuration</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE CONFIGURATION&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Setup Information command.</span>
<span class="cm">	 */</span>
	<span class="n">RequestedReplyLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SetupInformation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireSetupInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequestedReplyLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RequestedReplyLength</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">SetupInformation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SetupInformation</span><span class="p">))</span>
	    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SetupInformation</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE SETUP INFORMATION&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Extended Setup Information command.</span>
<span class="cm">	 */</span>
	<span class="n">RequestedReplyLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireExtendedSetupInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequestedReplyLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RequestedReplyLength</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ExtendedSetupInformation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">))</span>
	    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE EXTENDED SETUP INFORMATION&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Firmware Version 3rd Digit command.</span>
<span class="cm">	 */</span>
	<span class="n">FirmwareVersion3rdDigit</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BoardID</span><span class="p">.</span><span class="n">FirmwareVersion1stDigit</span> <span class="o">&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireFirmwareVersion3rdDigit</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FirmwareVersion3rdDigit</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FirmwareVersion3rdDigit</span><span class="p">))</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FirmwareVersion3rdDigit</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE FIRMWARE 3RD DIGIT&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Host Adapter Model Number command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">BusType</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">BoardID</span><span class="p">.</span><span class="n">FirmwareVersion1stDigit</span> <span class="o">==</span> <span class="sc">&#39;2&#39;</span><span class="p">)</span>
		<span class="cm">/* BusLogic BT-542B ISA 2.xx */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">HostAdapterModelNumber</span><span class="p">,</span> <span class="s">&quot;542B&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">BusType</span> <span class="o">==</span> <span class="sc">&#39;E&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">BoardID</span><span class="p">.</span><span class="n">FirmwareVersion1stDigit</span> <span class="o">==</span> <span class="sc">&#39;2&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">BoardID</span><span class="p">.</span><span class="n">FirmwareVersion2ndDigit</span> <span class="o">&lt;=</span> <span class="sc">&#39;1&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="n">BoardID</span><span class="p">.</span><span class="n">FirmwareVersion2ndDigit</span> <span class="o">==</span> <span class="sc">&#39;2&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">FirmwareVersion3rdDigit</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)))</span>
		<span class="cm">/* BusLogic BT-742A EISA 2.1x or 2.20 */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">HostAdapterModelNumber</span><span class="p">,</span> <span class="s">&quot;742A&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">BusType</span> <span class="o">==</span> <span class="sc">&#39;E&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">BoardID</span><span class="p">.</span><span class="n">FirmwareVersion1stDigit</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
		<span class="cm">/* AMI FastDisk EISA Series 441 0.x */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">HostAdapterModelNumber</span><span class="p">,</span> <span class="s">&quot;747A&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">RequestedReplyLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HostAdapterModelNumber</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireHostAdapterModelNumber</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequestedReplyLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RequestedReplyLength</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">HostAdapterModelNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HostAdapterModelNumber</span><span class="p">))</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HostAdapterModelNumber</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE HOST ADAPTER MODEL NUMBER&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   BusLogic MultiMaster Host Adapters can be identified by their model number</span>
<span class="cm">	   and the major version number of their firmware as follows:</span>

<span class="cm">	   5.xx       BusLogic &quot;W&quot; Series Host Adapters:</span>
<span class="cm">	   BT-948/958/958D</span>
<span class="cm">	   4.xx       BusLogic &quot;C&quot; Series Host Adapters:</span>
<span class="cm">	   BT-946C/956C/956CD/747C/757C/757CD/445C/545C/540CF</span>
<span class="cm">	   3.xx       BusLogic &quot;S&quot; Series Host Adapters:</span>
<span class="cm">	   BT-747S/747D/757S/757D/445S/545S/542D</span>
<span class="cm">	   BT-542B/742A (revision H)</span>
<span class="cm">	   2.xx       BusLogic &quot;A&quot; Series Host Adapters:</span>
<span class="cm">	   BT-542B/742A (revision G and below)</span>
<span class="cm">	   0.xx       AMI FastDisk VLB/EISA BusLogic Clone Host Adapter</span>
<span class="cm">	 */</span>
	<span class="cm">/*</span>
<span class="cm">	   Save the Model Name and Host Adapter Name in the Host Adapter structure.</span>
<span class="cm">	 */</span>
	<span class="n">TargetPointer</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">;</span>
	<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;T&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HostAdapterModelNumber</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Character</span> <span class="o">=</span> <span class="n">HostAdapterModelNumber</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Character</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">Character</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">Character</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Save the Firmware Version in the Host Adapter structure.</span>
<span class="cm">	 */</span>
	<span class="n">TargetPointer</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">;</span>
	<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">BoardID</span><span class="p">.</span><span class="n">FirmwareVersion1stDigit</span><span class="p">;</span>
	<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">BoardID</span><span class="p">.</span><span class="n">FirmwareVersion2ndDigit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FirmwareVersion3rdDigit</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">FirmwareVersion3rdDigit</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">FirmwareVersion3rdDigit</span><span class="p">;</span>
	<span class="o">*</span><span class="n">TargetPointer</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Firmware Version Letter command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;3.3&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireFirmwareVersionLetter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FirmwareVersionLetter</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FirmwareVersionLetter</span><span class="p">))</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FirmwareVersionLetter</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE FIRMWARE VERSION LETTER&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FirmwareVersionLetter</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">FirmwareVersionLetter</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="o">*</span><span class="n">TargetPointer</span><span class="o">++</span> <span class="o">=</span> <span class="n">FirmwareVersionLetter</span><span class="p">;</span>
		<span class="o">*</span><span class="n">TargetPointer</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Save the Host Adapter SCSI ID in the Host Adapter structure.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">.</span><span class="n">HostAdapterID</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Determine the Bus Type and save it in the Host Adapter structure, determine</span>
<span class="cm">	   and save the IRQ Channel if necessary, and determine and save the DMA</span>
<span class="cm">	   Channel for ISA Host Adapters.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">=</span> <span class="n">BusLogic_HostAdapterBusTypes</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;4&#39;</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">IRQ_Channel9</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">IRQ_Channel10</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">IRQ_Channel11</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">IRQ_Channel12</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">IRQ_Channel14</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">IRQ_Channel15</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">==</span> <span class="n">BusLogic_ISA_Bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DMA_Channel5</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DMA_Channel6</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DMA_Channel7</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Determine whether Extended Translation is enabled and save it in</span>
<span class="cm">	   the Host Adapter structure.</span>
<span class="cm">	 */</span>
	<span class="n">GeometryRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadGeometryRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExtendedTranslationEnabled</span> <span class="o">=</span> <span class="n">GeometryRegister</span><span class="p">.</span><span class="n">gr</span><span class="p">.</span><span class="n">ExtendedTranslationEnabled</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Save the Scatter Gather Limits, Level Sensitive Interrupt flag, Wide</span>
<span class="cm">	   SCSI flag, Differential SCSI flag, SCAM Supported flag, and</span>
<span class="cm">	   Ultra SCSI flag in the Host Adapter structure.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterScatterGatherLimit</span> <span class="o">=</span> <span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">ScatterGatherLimit</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterScatterGatherLimit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterScatterGatherLimit</span> <span class="o">&gt;</span> <span class="n">BusLogic_ScatterGatherLimit</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span> <span class="o">=</span> <span class="n">BusLogic_ScatterGatherLimit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">Misc</span><span class="p">.</span><span class="n">LevelSensitiveInterrupt</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LevelSensitiveInterrupt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostWideSCSI</span> <span class="o">=</span> <span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">HostWideSCSI</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostDifferentialSCSI</span> <span class="o">=</span> <span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">HostDifferentialSCSI</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostSupportsSCAM</span> <span class="o">=</span> <span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">HostSupportsSCAM</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostUltraSCSI</span> <span class="o">=</span> <span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">HostUltraSCSI</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Determine whether Extended LUN Format CCBs are supported and save the</span>
<span class="cm">	   information in the Host Adapter structure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;5&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;4&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostWideSCSI</span><span class="p">))</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExtendedLUNSupport</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire PCI Host Adapter Information command to read the</span>
<span class="cm">	   Termination Information from &quot;W&quot; series MultiMaster Host Adapters.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;5&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquirePCIHostAdapterInformation</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PCIHostAdapterInformation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PCIHostAdapterInformation</span><span class="p">))</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PCIHostAdapterInformation</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE PCI HOST ADAPTER INFORMATION&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		   Save the Termination Information in the Host Adapter structure.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCIHostAdapterInformation</span><span class="p">.</span><span class="n">GenericInfoValid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TerminationInfoValid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LowByteTerminated</span> <span class="o">=</span> <span class="n">PCIHostAdapterInformation</span><span class="p">.</span><span class="n">LowByteTerminated</span><span class="p">;</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HighByteTerminated</span> <span class="o">=</span> <span class="n">PCIHostAdapterInformation</span><span class="p">.</span><span class="n">HighByteTerminated</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Fetch Host Adapter Local RAM command to read the AutoSCSI data</span>
<span class="cm">	   from &quot;W&quot; and &quot;C&quot; series MultiMaster Host Adapters.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;4&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">.</span><span class="n">ByteOffset</span> <span class="o">=</span> <span class="n">BusLogic_AutoSCSI_BaseOffset</span><span class="p">;</span>
		<span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">.</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AutoSCSIData</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_FetchHostAdapterLocalRAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FetchHostAdapterLocalRAMRequest</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">AutoSCSIData</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AutoSCSIData</span><span class="p">))</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AutoSCSIData</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;FETCH HOST ADAPTER LOCAL RAM&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		   Save the Parity Checking Enabled, Bus Reset Enabled, and Termination</span>
<span class="cm">		   Information in the Host Adapter structure.</span>
<span class="cm">		 */</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ParityCheckingEnabled</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">ParityCheckingEnabled</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BusResetEnabled</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">BusResetEnabled</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;4&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TerminationInfoValid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LowByteTerminated</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">LowByteTerminated</span><span class="p">;</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HighByteTerminated</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">HighByteTerminated</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		   Save the Wide Permitted, Fast Permitted, Synchronous Permitted,</span>
<span class="cm">		   Disconnect Permitted, Ultra Permitted, and SCAM Information in the</span>
<span class="cm">		   Host Adapter structure.</span>
<span class="cm">		 */</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">WidePermitted</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">WidePermitted</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FastPermitted</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">FastPermitted</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SynchronousPermitted</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">SynchronousPermitted</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DisconnectPermitted</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">DisconnectPermitted</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostUltraSCSI</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UltraPermitted</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">UltraPermitted</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostSupportsSCAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCAM_Enabled</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">SCAM_Enabled</span><span class="p">;</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCAM_Level2</span> <span class="o">=</span> <span class="n">AutoSCSIData</span><span class="p">.</span><span class="n">SCAM_Level2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Initialize fields in the Host Adapter structure for &quot;S&quot; and &quot;A&quot; series</span>
<span class="cm">	   MultiMaster Host Adapters.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="sc">&#39;4&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SetupInformation</span><span class="p">.</span><span class="n">SynchronousInitiationEnabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SynchronousPermitted</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">==</span> <span class="n">BusLogic_EISA_Bus</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">Misc</span><span class="p">.</span><span class="n">FastOnEISA</span><span class="p">)</span>
					<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FastPermitted</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;BT-757&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">WidePermitted</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DisconnectPermitted</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ParityCheckingEnabled</span> <span class="o">=</span> <span class="n">SetupInformation</span><span class="p">.</span><span class="n">ParityCheckingEnabled</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BusResetEnabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Determine the maximum number of Target IDs and Logical Units supported by</span>
<span class="cm">	   this driver for Wide and Narrow Host Adapters.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span> <span class="o">=</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostWideSCSI</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxLogicalUnits</span> <span class="o">=</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExtendedLUNSupport</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Select appropriate values for the Mailbox Count, Driver Queue Depth,</span>
<span class="cm">	   Initial CCBs, and Incremental CCBs variables based on whether or not Strict</span>
<span class="cm">	   Round Robin Mode is supported.  If Strict Round Robin Mode is supported,</span>
<span class="cm">	   then there is no performance degradation in using the maximum possible</span>
<span class="cm">	   number of Outgoing and Incoming Mailboxes and allowing the Tagged and</span>
<span class="cm">	   Untagged Queue Depths to determine the actual utilization.  If Strict Round</span>
<span class="cm">	   Robin Mode is not supported, then the Host Adapter must scan all the</span>
<span class="cm">	   Outgoing Mailboxes whenever an Outgoing Mailbox entry is made, which can</span>
<span class="cm">	   cause a substantial performance penalty.  The host adapters actually have</span>
<span class="cm">	   room to store the following number of CCBs internally; that is, they can</span>
<span class="cm">	   internally queue and manage this many active commands on the SCSI bus</span>
<span class="cm">	   simultaneously.  Performance measurements demonstrate that the Driver Queue</span>
<span class="cm">	   Depth should be set to the Mailbox Count, rather than the Host Adapter</span>
<span class="cm">	   Queue Depth (internal CCB capacity), as it is more efficient to have the</span>
<span class="cm">	   queued commands waiting in Outgoing Mailboxes if necessary than to block</span>
<span class="cm">	   the process in the higher levels of the SCSI Subsystem.</span>

<span class="cm">	   192          BT-948/958/958D</span>
<span class="cm">	   100          BT-946C/956C/956CD/747C/757C/757CD/445C</span>
<span class="cm">	   50   BT-545C/540CF</span>
<span class="cm">	   30   BT-747S/747D/757S/757D/445S/545S/542D/542B/742A</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;5&#39;</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterQueueDepth</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;4&#39;</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterQueueDepth</span> <span class="o">=</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">!=</span> <span class="n">BusLogic_ISA_Bus</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">50</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterQueueDepth</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;3.31&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">StrictRoundRobinModeSupport</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span> <span class="o">=</span> <span class="n">BusLogic_MaxMailboxes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">StrictRoundRobinModeSupport</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">InitialCCBs</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">BusLogic_CCB_AllocationGroupSize</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IncrementalCCBs</span> <span class="o">=</span> <span class="n">BusLogic_CCB_AllocationGroupSize</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Tagged Queuing support is available and operates properly on all &quot;W&quot; series</span>
<span class="cm">	   MultiMaster Host Adapters, on &quot;C&quot; series MultiMaster Host Adapters with</span>
<span class="cm">	   firmware version 4.22 and above, and on &quot;S&quot; series MultiMaster Host</span>
<span class="cm">	   Adapters with firmware version 3.35 and above.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;5&#39;</span>:
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;4&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;4.22&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;3&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;3.35&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Determine the Host Adapter BIOS Address if the BIOS is enabled and</span>
<span class="cm">	   save it in the Host Adapter structure.  The BIOS is disabled if the</span>
<span class="cm">	   BIOS_Address is 0.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BIOS_Address</span> <span class="o">=</span> <span class="n">ExtendedSetupInformation</span><span class="p">.</span><span class="n">BIOS_Address</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   ISA Host Adapters require Bounce Buffers if there is more than 16MB memory.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">==</span> <span class="n">BusLogic_ISA_Bus</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">high_memory</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">MAX_DMA_ADDRESS</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BounceBuffersRequired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   BusLogic BT-445S Host Adapters prior to board revision E have a hardware</span>
<span class="cm">	   bug whereby when the BIOS is enabled, transfers to/from the same address</span>
<span class="cm">	   range the BIOS occupies modulo 16MB are handled incorrectly.  Only properly</span>
<span class="cm">	   functioning BT-445S Host Adapters have firmware version 3.37, so require</span>
<span class="cm">	   that ISA Bounce Buffers be used for the buggy BT-445S models if there is</span>
<span class="cm">	   more than 16MB memory.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BIOS_Address</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;BT-445S&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;3.37&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">high_memory</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">MAX_DMA_ADDRESS</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BounceBuffersRequired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Initialize parameters common to MultiMaster and FlashPoint Host Adapters.</span>
<span class="cm">	 */</span>
      <span class="nl">Common:</span>
	<span class="cm">/*</span>
<span class="cm">	   Initialize the Host Adapter Full Model Name from the Model Name.</span>
<span class="cm">	 */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">,</span> <span class="s">&quot;BusLogic &quot;</span><span class="p">);</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Select an appropriate value for the Tagged Queue Depth either from a</span>
<span class="cm">	   BusLogic Driver Options specification, or based on whether this Host</span>
<span class="cm">	   Adapter requires that ISA Bounce Buffers be used.  The Tagged Queue Depth</span>
<span class="cm">	   is left at 0 for automatic determination in BusLogic_SelectQueueDepths.</span>
<span class="cm">	   Initialize the Untagged Queue Depth.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">BusLogic_MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">QueueDepth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">QueueDepth</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BounceBuffersRequired</span><span class="p">)</span>
			<span class="n">QueueDepth</span> <span class="o">=</span> <span class="n">BusLogic_TaggedQueueDepthBB</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueueDepth</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BounceBuffersRequired</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UntaggedQueueDepth</span> <span class="o">=</span> <span class="n">BusLogic_UntaggedQueueDepthBB</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UntaggedQueueDepth</span> <span class="o">=</span> <span class="n">BusLogic_UntaggedQueueDepth</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CommonQueueDepth</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">CommonQueueDepth</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CommonQueueDepth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CommonQueueDepth</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UntaggedQueueDepth</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UntaggedQueueDepth</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CommonQueueDepth</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Tagged Queuing is only allowed if Disconnect/Reconnect is permitted.</span>
<span class="cm">	   Therefore, mask the Tagged Queuing Permitted Default bits with the</span>
<span class="cm">	   Disconnect/Reconnect Permitted bits.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DisconnectPermitted</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Combine the default Tagged Queuing Permitted bits with any BusLogic Driver</span>
<span class="cm">	   Options Tagged Queuing specification.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermittedMask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermittedMask</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	   Select an appropriate value for Bus Settle Time either from a BusLogic</span>
<span class="cm">	   Driver Options specification, or from BusLogic_DefaultBusSettleTime.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">BusSettleTime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BusSettleTime</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">BusSettleTime</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BusSettleTime</span> <span class="o">=</span> <span class="n">BusLogic_DefaultBusSettleTime</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Indicate reading the Host Adapter Configuration completed successfully.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ReportHostAdapterConfiguration reports the configuration of</span>
<span class="cm">  Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">BusLogic_ReportHostAdapterConfiguration</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
							      <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">AllTargetsMask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">SynchronousPermitted</span><span class="p">,</span> <span class="n">FastPermitted</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">UltraPermitted</span><span class="p">,</span> <span class="n">WidePermitted</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">DisconnectPermitted</span><span class="p">,</span> <span class="n">TaggedQueuingPermitted</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">CommonSynchronousNegotiation</span><span class="p">,</span> <span class="n">CommonTaggedQueueDepth</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">SynchronousString</span><span class="p">[</span><span class="n">BusLogic_MaxTargetDevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">WideString</span><span class="p">[</span><span class="n">BusLogic_MaxTargetDevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">DisconnectString</span><span class="p">[</span><span class="n">BusLogic_MaxTargetDevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">TaggedQueuingString</span><span class="p">[</span><span class="n">BusLogic_MaxTargetDevices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">SynchronousMessage</span> <span class="o">=</span> <span class="n">SynchronousString</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">WideMessage</span> <span class="o">=</span> <span class="n">WideString</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">DisconnectMessage</span> <span class="o">=</span> <span class="n">DisconnectString</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">TaggedQueuingMessage</span> <span class="o">=</span> <span class="n">TaggedQueuingString</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TargetID</span><span class="p">;</span>
	<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;Configuring BusLogic Model %s %s%s%s%s SCSI Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span>
		      <span class="n">BusLogic_HostAdapterBusNames</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span><span class="p">],</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostWideSCSI</span> <span class="o">?</span> <span class="s">&quot; Wide&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostDifferentialSCSI</span> <span class="o">?</span> <span class="s">&quot; Differential&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostUltraSCSI</span> <span class="o">?</span> <span class="s">&quot; Ultra&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
	<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  Firmware Version: %s, I/O Address: 0x%X, &quot;</span> <span class="s">&quot;IRQ Channel: %d/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">,</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LevelSensitiveInterrupt</span> <span class="o">?</span> <span class="s">&quot;Level&quot;</span> <span class="o">:</span> <span class="s">&quot;Edge&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">!=</span> <span class="n">BusLogic_PCI_Bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  DMA Channel: &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;%d, &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;None, &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BIOS_Address</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;BIOS Address: 0x%X, &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BIOS_Address</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;BIOS Address: None, &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  PCI Bus: %d, Device: %d, Address: &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;0x%X, &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;Unassigned, &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;Host Adapter SCSI ID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span><span class="p">);</span>
	<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  Parity Checking: %s, Extended Translation: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ParityCheckingEnabled</span> <span class="o">?</span> <span class="s">&quot;Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExtendedTranslationEnabled</span> <span class="o">?</span> <span class="s">&quot;Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p">));</span>
	<span class="n">AllTargetsMask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span><span class="p">);</span>
	<span class="n">SynchronousPermitted</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SynchronousPermitted</span> <span class="o">&amp;</span> <span class="n">AllTargetsMask</span><span class="p">;</span>
	<span class="n">FastPermitted</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FastPermitted</span> <span class="o">&amp;</span> <span class="n">AllTargetsMask</span><span class="p">;</span>
	<span class="n">UltraPermitted</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UltraPermitted</span> <span class="o">&amp;</span> <span class="n">AllTargetsMask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">BusLogic_MultiMasterHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;4&#39;</span> <span class="o">||</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">==</span> <span class="n">BusLogic_EISA_Bus</span><span class="p">))</span> <span class="o">||</span> <span class="n">BusLogic_FlashPointHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CommonSynchronousNegotiation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SynchronousPermitted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SynchronousMessage</span> <span class="o">=</span> <span class="s">&quot;Disabled&quot;</span><span class="p">;</span>
			<span class="n">CommonSynchronousNegotiation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SynchronousPermitted</span> <span class="o">==</span> <span class="n">AllTargetsMask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FastPermitted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SynchronousMessage</span> <span class="o">=</span> <span class="s">&quot;Slow&quot;</span><span class="p">;</span>
				<span class="n">CommonSynchronousNegotiation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">FastPermitted</span> <span class="o">==</span> <span class="n">AllTargetsMask</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">UltraPermitted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SynchronousMessage</span> <span class="o">=</span> <span class="s">&quot;Fast&quot;</span><span class="p">;</span>
					<span class="n">CommonSynchronousNegotiation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">UltraPermitted</span> <span class="o">==</span> <span class="n">AllTargetsMask</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SynchronousMessage</span> <span class="o">=</span> <span class="s">&quot;Ultra&quot;</span><span class="p">;</span>
					<span class="n">CommonSynchronousNegotiation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CommonSynchronousNegotiation</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
				<span class="n">SynchronousString</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">SynchronousPermitted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">)))</span> <span class="o">?</span> <span class="sc">&#39;N&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FastPermitted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">UltraPermitted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;F&#39;</span> <span class="o">:</span> <span class="sc">&#39;U&#39;</span><span class="p">)));</span>
			<span class="n">SynchronousString</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;#&#39;</span><span class="p">;</span>
			<span class="n">SynchronousString</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">SynchronousMessage</span> <span class="o">=</span> <span class="p">(</span><span class="n">SynchronousPermitted</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;Disabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Enabled&quot;</span><span class="p">);</span>
	<span class="n">WidePermitted</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">WidePermitted</span> <span class="o">&amp;</span> <span class="n">AllTargetsMask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WidePermitted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">WideMessage</span> <span class="o">=</span> <span class="s">&quot;Disabled&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">WidePermitted</span> <span class="o">==</span> <span class="n">AllTargetsMask</span><span class="p">)</span>
		<span class="n">WideMessage</span> <span class="o">=</span> <span class="s">&quot;Enabled&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
			<span class="n">WideString</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">WidePermitted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>
		<span class="n">WideString</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;#&#39;</span><span class="p">;</span>
		<span class="n">WideString</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DisconnectPermitted</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DisconnectPermitted</span> <span class="o">&amp;</span> <span class="n">AllTargetsMask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DisconnectPermitted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">DisconnectMessage</span> <span class="o">=</span> <span class="s">&quot;Disabled&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">DisconnectPermitted</span> <span class="o">==</span> <span class="n">AllTargetsMask</span><span class="p">)</span>
		<span class="n">DisconnectMessage</span> <span class="o">=</span> <span class="s">&quot;Enabled&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
			<span class="n">DisconnectString</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">DisconnectPermitted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>
		<span class="n">DisconnectString</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;#&#39;</span><span class="p">;</span>
		<span class="n">DisconnectString</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">TaggedQueuingPermitted</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;</span> <span class="n">AllTargetsMask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TaggedQueuingPermitted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">TaggedQueuingMessage</span> <span class="o">=</span> <span class="s">&quot;Disabled&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TaggedQueuingPermitted</span> <span class="o">==</span> <span class="n">AllTargetsMask</span><span class="p">)</span>
		<span class="n">TaggedQueuingMessage</span> <span class="o">=</span> <span class="s">&quot;Enabled&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
			<span class="n">TaggedQueuingString</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>
		<span class="n">TaggedQueuingString</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;#&#39;</span><span class="p">;</span>
		<span class="n">TaggedQueuingString</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  Synchronous Negotiation: %s, Wide Negotiation: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">SynchronousMessage</span><span class="p">,</span> <span class="n">WideMessage</span><span class="p">);</span>
	<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  Disconnect/Reconnect: %s, Tagged Queuing: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">DisconnectMessage</span><span class="p">,</span> <span class="n">TaggedQueuingMessage</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_MultiMasterHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  Scatter/Gather Limit: %d of %d segments, &quot;</span> <span class="s">&quot;Mailboxes: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterScatterGatherLimit</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span><span class="p">);</span>
		<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  Driver Queue Depth: %d, &quot;</span> <span class="s">&quot;Host Adapter Queue Depth: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterQueueDepth</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  Driver Queue Depth: %d, &quot;</span> <span class="s">&quot;Scatter/Gather Limit: %d segments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span><span class="p">);</span>
	<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  Tagged Queue Depth: &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="n">CommonTaggedQueueDepth</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">!=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">CommonTaggedQueueDepth</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CommonTaggedQueueDepth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;Automatic&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;Individual&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;, Untagged Queue Depth: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UntaggedQueueDepth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TerminationInfoValid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostWideSCSI</span><span class="p">)</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  SCSI Bus Termination: %s&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LowByteTerminated</span> <span class="o">?</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HighByteTerminated</span> <span class="o">?</span> <span class="s">&quot;Both Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Low Enabled&quot;</span><span class="p">)</span>
										  <span class="o">:</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HighByteTerminated</span> <span class="o">?</span> <span class="s">&quot;High Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Both Disabled&quot;</span><span class="p">)));</span>
		<span class="k">else</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;  SCSI Bus Termination: %s&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LowByteTerminated</span> <span class="o">?</span> <span class="s">&quot;Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostSupportsSCAM</span><span class="p">)</span>
			<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;, SCAM: %s&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCAM_Enabled</span> <span class="o">?</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCAM_Level2</span> <span class="o">?</span> <span class="s">&quot;Enabled, Level 2&quot;</span> <span class="o">:</span> <span class="s">&quot;Enabled, Level 1&quot;</span><span class="p">)</span>
								  <span class="o">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p">));</span>
		<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Indicate reporting the Host Adapter configuration completed successfully.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_AcquireResources acquires the system resources necessary to use</span>
<span class="cm">  Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">BusLogic_AcquireResources</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;NO LEGAL INTERRUPT CHANNEL ASSIGNED - DETACHING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Acquire shared access to the IRQ Channel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">,</span> <span class="n">BusLogic_InterruptHandler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;UNABLE TO ACQUIRE IRQ CHANNEL %d - DETACHING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_ChannelAcquired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Acquire exclusive access to the DMA Channel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;UNABLE TO ACQUIRE DMA CHANNEL %d - DETACHING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span><span class="p">,</span> <span class="n">DMA_MODE_CASCADE</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span><span class="p">);</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_ChannelAcquired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Indicate the System Resource Acquisition completed successfully,</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ReleaseResources releases any system resources previously acquired</span>
<span class="cm">  by BusLogic_AcquireResources.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_ReleaseResources</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	   Release shared access to the IRQ Channel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_ChannelAcquired</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Release exclusive access to the DMA Channel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_ChannelAcquired</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DMA_Channel</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Release any allocated memory structs not released elsewhere</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpace</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSize</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpace</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpaceHandle</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">);</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpace</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpaceHandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_InitializeHostAdapter initializes Host Adapter.  This is the only</span>
<span class="cm">  function called during SCSI Host Adapter detection which modifies the state</span>
<span class="cm">  of the Host Adapter from its initial power on or hard reset state.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">BusLogic_InitializeHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
					      <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_ExtendedMailboxRequest</span> <span class="n">ExtendedMailboxRequest</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BusLogic_RoundRobinModeRequest</span> <span class="n">RoundRobinModeRequest</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BusLogic_SetCCBFormatRequest</span> <span class="n">SetCCBFormatRequest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TargetID</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Initialize the pointers to the first and last CCBs that are queued for</span>
<span class="cm">	   completion processing.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstCompletedCCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastCompletedCCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Initialize the Bus Device Reset Pending CCB, Tagged Queuing Active,</span>
<span class="cm">	   Command Successful Flag, Active Commands, and Commands Since Reset</span>
<span class="cm">	   for each Target Device.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BusDeviceResetPendingCCB</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TaggedQueuingActive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandSuccessfulFlag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ActiveCommands</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CommandsSinceReset</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   FlashPoint Host Adapters do not use Outgoing and Incoming Mailboxes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_FlashPointHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Done</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Initialize the Outgoing and Incoming Mailbox pointers.</span>
<span class="cm">	 */</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSize</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_OutgoingMailbox</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_IncomingMailbox</span><span class="p">));</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpace</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpaceHandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpace</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;MAILBOX ALLOCATION&quot;</span><span class="p">);</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstOutgoingMailbox</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_OutgoingMailbox</span> <span class="o">*</span><span class="p">)</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpace</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastOutgoingMailbox</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstOutgoingMailbox</span> <span class="o">+</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">NextOutgoingMailbox</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstOutgoingMailbox</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstIncomingMailbox</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_IncomingMailbox</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastOutgoingMailbox</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastIncomingMailbox</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstIncomingMailbox</span> <span class="o">+</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">NextIncomingMailbox</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstIncomingMailbox</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	   Initialize the Outgoing and Incoming Mailbox structures.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstOutgoingMailbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_OutgoingMailbox</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstIncomingMailbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_IncomingMailbox</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	   Initialize the Host Adapter&#39;s Pointer to the Outgoing/Incoming Mailboxes.</span>
<span class="cm">	 */</span>
	<span class="n">ExtendedMailboxRequest</span><span class="p">.</span><span class="n">MailboxCount</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxCount</span><span class="p">;</span>
	<span class="n">ExtendedMailboxRequest</span><span class="p">.</span><span class="n">BaseMailboxAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MailboxSpaceHandle</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InitializeExtendedMailbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ExtendedMailboxRequest</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ExtendedMailboxRequest</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;MAILBOX INITIALIZATION&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Enable Strict Round Robin Mode if supported by the Host Adapter.  In</span>
<span class="cm">	   Strict Round Robin Mode, the Host Adapter only looks at the next Outgoing</span>
<span class="cm">	   Mailbox for each new command, rather than scanning through all the</span>
<span class="cm">	   Outgoing Mailboxes to find any that have new commands in them.  Strict</span>
<span class="cm">	   Round Robin Mode is significantly more efficient.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">StrictRoundRobinModeSupport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RoundRobinModeRequest</span> <span class="o">=</span> <span class="n">BusLogic_StrictRoundRobinMode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_EnableStrictRoundRobinMode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RoundRobinModeRequest</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RoundRobinModeRequest</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;ENABLE STRICT ROUND ROBIN MODE&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   For Host Adapters that support Extended LUN Format CCBs, issue the Set CCB</span>
<span class="cm">	   Format command to allow 32 Logical Units per Target Device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExtendedLUNSupport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SetCCBFormatRequest</span> <span class="o">=</span> <span class="n">BusLogic_ExtendedLUNFormatCCB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_SetCCBFormat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SetCCBFormatRequest</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SetCCBFormatRequest</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;SET CCB FORMAT&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Announce Successful Initialization.</span>
<span class="cm">	 */</span>
      <span class="nl">Done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterInitialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;*** %s Initialized Successfully ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">);</span>
		<span class="n">BusLogic_Info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;*** %s Initialized Successfully ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">);</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterInitialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Indicate the Host Adapter Initialization completed successfully.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_TargetDeviceInquiry inquires about the Target Devices accessible</span>
<span class="cm">  through Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">BusLogic_TargetDeviceInquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
						   <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">InstalledDevices</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">InstalledDevicesID0to7</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">BusLogic_SetupInformation</span> <span class="n">SetupInformation</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">SynchronousPeriod</span><span class="p">[</span><span class="n">BusLogic_MaxTargetDevices</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RequestedReplyLength</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TargetID</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Wait a few seconds between the Host Adapter Hard Reset which initiates</span>
<span class="cm">	   a SCSI Bus Reset and issuing any SCSI Commands.  Some SCSI devices get</span>
<span class="cm">	   confused if they receive SCSI Commands too soon after a SCSI Bus Reset.</span>
<span class="cm">	 */</span>
	<span class="n">BusLogic_Delay</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BusSettleTime</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   FlashPoint Host Adapters do not provide for Target Device Inquiry.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_FlashPointHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Inhibit the Target Device Inquiry if requested.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">LocalOptions</span><span class="p">.</span><span class="n">InhibitTargetInquiry</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Target Devices command for host adapters with firmware</span>
<span class="cm">	   version 4.25 or later, or the Inquire Installed Devices ID 0 to 7 command</span>
<span class="cm">	   for older host adapters.  This is necessary to force Synchronous Transfer</span>
<span class="cm">	   Negotiation so that the Inquire Setup Information and Inquire Synchronous</span>
<span class="cm">	   Period commands will return valid data.  The Inquire Target Devices command</span>
<span class="cm">	   is preferable to Inquire Installed Devices ID 0 to 7 since it only probes</span>
<span class="cm">	   Logical Unit 0 of each Target Device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;4.25&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Issue a Inquire Target Devices command.  Inquire Target Devices only</span>
<span class="cm">		 * tests Logical Unit 0 of each Target Device unlike the Inquire Installed</span>
<span class="cm">		 * Devices commands which test Logical Units 0 - 7.  Two bytes are</span>
<span class="cm">		 * returned, where byte 0 bit 0 set indicates that Target Device 0 exists,</span>
<span class="cm">		 * and so on.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireTargetDevices</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">InstalledDevices</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InstalledDevices</span><span class="p">))</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InstalledDevices</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE TARGET DEVICES&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TargetExists</span> <span class="o">=</span> <span class="p">(</span><span class="n">InstalledDevices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Issue an Inquire Installed Devices command.  For each Target Device,</span>
<span class="cm">		 * a byte is returned where bit 0 set indicates that Logical Unit 0</span>
<span class="cm">		 * exists, bit 1 set indicates that Logical Unit 1 exists, and so on.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireInstalledDevicesID0to7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">InstalledDevicesID0to7</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InstalledDevicesID0to7</span><span class="p">))</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InstalledDevicesID0to7</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE INSTALLED DEVICES ID 0 TO 7&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TargetExists</span> <span class="o">=</span> <span class="p">(</span><span class="n">InstalledDevicesID0to7</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Setup Information command.</span>
<span class="cm">	 */</span>
	<span class="n">RequestedReplyLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SetupInformation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireSetupInformation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequestedReplyLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RequestedReplyLength</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">SetupInformation</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SetupInformation</span><span class="p">))</span>
	    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SetupInformation</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE SETUP INFORMATION&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SynchronousOffset</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">SetupInformation</span><span class="p">.</span><span class="n">SynchronousValuesID0to7</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">Offset</span> <span class="o">:</span> <span class="n">SetupInformation</span><span class="p">.</span><span class="n">SynchronousValuesID8to15</span><span class="p">[</span><span class="n">TargetID</span> <span class="o">-</span> <span class="mi">8</span><span class="p">].</span><span class="n">Offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;5.06L&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WideTransfersActive</span> <span class="o">=</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="p">(</span><span class="n">SetupInformation</span><span class="p">.</span><span class="n">WideTransfersActiveID0to7</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">)</span>
												  <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">)</span>
										  <span class="o">:</span> <span class="p">(</span><span class="n">SetupInformation</span><span class="p">.</span><span class="n">WideTransfersActiveID8to15</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">-</span> <span class="mi">8</span><span class="p">))</span>
										     <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	   Issue the Inquire Synchronous Period command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;3&#39;</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Issue a Inquire Synchronous Period command.  For each Target Device,</span>
<span class="cm">		 * a byte is returned which represents the Synchronous Transfer Period</span>
<span class="cm">		 * in units of 10 nanoseconds.</span>
<span class="cm">		 */</span>

		<span class="n">RequestedReplyLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SynchronousPeriod</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_Command</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_InquireSynchronousPeriod</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequestedReplyLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RequestedReplyLength</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">SynchronousPeriod</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SynchronousPeriod</span><span class="p">))</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SynchronousPeriod</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">BusLogic_Failure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="s">&quot;INQUIRE SYNCHRONOUS PERIOD&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SynchronousPeriod</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">SynchronousPeriod</span><span class="p">[</span><span class="n">TargetID</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SetupInformation</span><span class="p">.</span><span class="n">SynchronousValuesID0to7</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">Offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SynchronousPeriod</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">SetupInformation</span><span class="p">.</span><span class="n">SynchronousValuesID0to7</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span>
				    <span class="p">.</span><span class="n">TransferPeriod</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Indicate the Target Device Inquiry completed successfully.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_InitializeHostStructure initializes the fields in the SCSI Host</span>
<span class="cm">  structure.  The base, io_port, n_io_ports, irq, and dma_channel fields in the</span>
<span class="cm">  SCSI Host structure are intentionally left uninitialized, as this driver</span>
<span class="cm">  handles acquisition and release of these resources explicitly, as well as</span>
<span class="cm">  ensuring exclusive access to the Host Adapter hardware and data structures</span>
<span class="cm">  through explicit acquisition and release of the Host Adapter&#39;s Lock.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">BusLogic_InitializeHostStructure</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
						    <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">Host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span>
	<span class="n">Host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxLogicalUnits</span><span class="p">;</span>
	<span class="n">Host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Host</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">;</span>
	<span class="n">Host</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_ID</span><span class="p">;</span>
	<span class="n">Host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span><span class="p">;</span>
	<span class="n">Host</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span><span class="p">;</span>
	<span class="n">Host</span><span class="o">-&gt;</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BounceBuffersRequired</span><span class="p">;</span>
	<span class="n">Host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UntaggedQueueDepth</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_SlaveConfigure will actually set the queue depth on individual</span>
<span class="cm">  scsi devices as they are permanently added to the device chain.  We</span>
<span class="cm">  shamelessly rip off the SelectQueueDepths code to make this work mostly</span>
<span class="cm">  like it used to.  Since we don&#39;t get called once at the end of the scan</span>
<span class="cm">  but instead get called for each device, we have to do things a bit</span>
<span class="cm">  differently.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">BusLogic_SlaveConfigure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">Device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TargetID</span> <span class="o">=</span> <span class="n">Device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">QueueDepth</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TaggedQueuingSupported</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">QueueDepth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">QueueDepth</span> <span class="o">=</span> <span class="n">BusLogic_MaxAutomaticTaggedQueueDepth</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueueDepth</span><span class="p">;</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">Device</span><span class="p">,</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">,</span> <span class="n">QueueDepth</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">);</span>
		<span class="n">QueueDepth</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">UntaggedQueueDepth</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueueDepth</span><span class="p">;</span>
		<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QueueDepth</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">QueueDepth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TargetExists</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QueueDepth</span> <span class="o">+=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">QueueDepth</span> <span class="o">&gt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span><span class="p">)</span>
		<span class="n">BusLogic_CreateAdditionalCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">QueueDepth</span> <span class="o">-</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_DetectHostAdapter probes for BusLogic Host Adapters at the standard</span>
<span class="cm">  I/O Addresses where they may be located, initializing, registering, and</span>
<span class="cm">  reporting the configuration of each BusLogic Host Adapter it finds.  It</span>
<span class="cm">  returns the number of BusLogic Host Adapters successfully initialized and</span>
<span class="cm">  registered.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">BusLogic_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">BusLogicHostAdapterCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DriverOptionsIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ProbeIndex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">PrototypeHostAdapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic</span><span class="p">)</span>
		<span class="n">BusLogic_Setup</span><span class="p">(</span><span class="n">BusLogic</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">NoProbe</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">BusLogic_ProbeInfoList</span> <span class="o">=</span>
	    <span class="n">kzalloc</span><span class="p">(</span><span class="n">BusLogic_MaxHostAdapters</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ProbeInfoList</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Unable to allocate Probe Info List</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PrototypeHostAdapter</span> <span class="o">=</span>
	    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PrototypeHostAdapter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">);</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Unable to allocate Prototype &quot;</span> <span class="s">&quot;Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">BusLogic_Setup</span><span class="p">(</span><span class="n">BusLogic</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">BusLogic_InitializeProbeInfoList</span><span class="p">(</span><span class="n">PrototypeHostAdapter</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ProbeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ProbeIndex</span> <span class="o">&lt;</span> <span class="n">BusLogic_ProbeInfoCount</span><span class="p">;</span> <span class="n">ProbeIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BusLogic_ProbeInfo</span> <span class="o">*</span><span class="n">ProbeInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">[</span><span class="n">ProbeIndex</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="n">PrototypeHostAdapter</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">Host</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span><span class="p">));</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterType</span> <span class="o">=</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterType</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span> <span class="o">=</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">HostAdapterBusType</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">Device</span> <span class="o">=</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">ProbeInfo</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AddressCount</span> <span class="o">=</span> <span class="n">BusLogic_HostAdapterAddressCount</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterType</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		   Make sure region is free prior to probing.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AddressCount</span><span class="p">,</span>
					<span class="s">&quot;BusLogic&quot;</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		   Probe the Host Adapter.  If unsuccessful, abort further initialization.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_ProbeHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AddressCount</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		   Hard Reset the Host Adapter.  If unsuccessful, abort further</span>
<span class="cm">		   initialization.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_HardwareResetHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AddressCount</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		   Check the Host Adapter.  If unsuccessful, abort further initialization.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_CheckHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AddressCount</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		   Initialize the Driver Options field if provided.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DriverOptionsIndex</span> <span class="o">&lt;</span> <span class="n">BusLogic_DriverOptionsCount</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverOptions</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BusLogic_DriverOptions</span><span class="p">[</span><span class="n">DriverOptionsIndex</span><span class="o">++</span><span class="p">];</span>
		<span class="cm">/*</span>
<span class="cm">		   Announce the Driver Version and Date, Author&#39;s Name, Copyright Notice,</span>
<span class="cm">		   and Electronic Mail Address.</span>
<span class="cm">		 */</span>
		<span class="n">BusLogic_AnnounceDriver</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		   Register the SCSI Host structure.</span>
<span class="cm">		 */</span>

		<span class="n">Host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Bus_Logic_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AddressCount</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">HostAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">PrototypeHostAdapter</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span><span class="p">));</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span> <span class="o">=</span> <span class="n">Host</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostNumber</span> <span class="o">=</span> <span class="n">Host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		   Add Host Adapter to the end of the list of registered BusLogic</span>
<span class="cm">		   Host Adapters.</span>
<span class="cm">		 */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BusLogic_host_list</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		   Read the Host Adapter Configuration, Configure the Host Adapter,</span>
<span class="cm">		   Acquire the System Resources necessary to use the Host Adapter, then</span>
<span class="cm">		   Create the Initial CCBs, Initialize the Host Adapter, and finally</span>
<span class="cm">		   perform Target Device Inquiry.</span>

<span class="cm">		   From this point onward, any failure will be assumed to be due to a</span>
<span class="cm">		   problem with the Host Adapter, rather than due to having mistakenly</span>
<span class="cm">		   identified this port as belonging to a BusLogic Host Adapter.  The</span>
<span class="cm">		   I/O Address range will not be released, thereby preventing it from</span>
<span class="cm">		   being incorrectly identified as any other type of Host Adapter.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ReadHostAdapterConfiguration</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">BusLogic_ReportHostAdapterConfiguration</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">BusLogic_AcquireResources</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">BusLogic_CreateInitialCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">BusLogic_InitializeHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">BusLogic_TargetDeviceInquiry</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			   Initialization has been completed successfully.  Release and</span>
<span class="cm">			   re-register usage of the I/O Address range so that the Model</span>
<span class="cm">			   Name of the Host Adapter will appear, and initialize the SCSI</span>
<span class="cm">			   Host structure.</span>
<span class="cm">			 */</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span>
				       <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AddressCount</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span>
					    <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AddressCount</span><span class="p">,</span>
					    <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					<span class="s">&quot;BusLogic: Release and re-register of &quot;</span>
					<span class="s">&quot;port 0x%04lx failed </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">);</span>
				<span class="n">BusLogic_DestroyCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
				<span class="n">BusLogic_ReleaseResources</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">);</span>
				<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">Host</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BusLogic_InitializeHostStructure</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span>
								 <span class="n">Host</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scsi_add_host</span><span class="p">(</span><span class="n">Host</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span>
						<span class="o">?</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">dev</span>
						  <span class="o">:</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					       <span class="s">&quot;BusLogic: scsi_add_host()&quot;</span>
					       <span class="s">&quot;failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">BusLogic_DestroyCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
					<span class="n">BusLogic_ReleaseResources</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
					<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">);</span>
					<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">Host</span><span class="p">);</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">Host</span><span class="p">);</span>
					<span class="n">BusLogicHostAdapterCount</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			   An error occurred during Host Adapter Configuration Querying, Host</span>
<span class="cm">			   Adapter Configuration, Resource Acquisition, CCB Creation, Host</span>
<span class="cm">			   Adapter Initialization, or Target Device Inquiry, so remove Host</span>
<span class="cm">			   Adapter from the list of registered BusLogic Host Adapters, destroy</span>
<span class="cm">			   the CCBs, Release the System Resources, and Unregister the SCSI</span>
<span class="cm">			   Host.</span>
<span class="cm">			 */</span>
			<span class="n">BusLogic_DestroyCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
			<span class="n">BusLogic_ReleaseResources</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">);</span>
			<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">Host</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">PrototypeHostAdapter</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">BusLogic_ProbeInfoList</span><span class="p">);</span>
	<span class="n">BusLogic_ProbeInfoList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ReleaseHostAdapter releases all resources previously acquired to</span>
<span class="cm">  support a specific Host Adapter, including the I/O Address range, and</span>
<span class="cm">  unregisters the BusLogic Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">BusLogic_ReleaseHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">Host</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="p">;</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">Host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	   FlashPoint Host Adapters must first be released by the FlashPoint</span>
<span class="cm">	   SCCB Manager.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_FlashPointHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span>
		<span class="n">FlashPoint_ReleaseHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CardHandle</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Destroy the CCBs and release any system resources acquired to</span>
<span class="cm">	   support Host Adapter.</span>
<span class="cm">	 */</span>
	<span class="n">BusLogic_DestroyCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="n">BusLogic_ReleaseResources</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Release usage of the I/O Address range.</span>
<span class="cm">	 */</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AddressCount</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Remove Host Adapter from the list of registered BusLogic Host Adapters.</span>
<span class="cm">	 */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">host_list</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">Host</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_QueueCompletedCCB queues CCB for completion processing.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_QueueCompletedCCB</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">HostAdapter</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">BusLogic_CCB_Completed</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstCompletedCCB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstCompletedCCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastCompletedCCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastCompletedCCB</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="n">CCB</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastCompletedCCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ActiveCommands</span><span class="p">[</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ComputeResultCode computes a SCSI Subsystem Result Code from</span>
<span class="cm">  the Host Adapter Status and Target Device Status.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BusLogic_ComputeResultCode</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="k">enum</span> <span class="n">BusLogic_HostAdapterStatus</span> <span class="n">HostAdapterStatus</span><span class="p">,</span> <span class="k">enum</span> <span class="n">BusLogic_TargetDeviceStatus</span> <span class="n">TargetDeviceStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">HostStatus</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">HostAdapterStatus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BusLogic_CommandCompletedNormally</span>:
	<span class="k">case</span> <span class="n">BusLogic_LinkedCommandCompleted</span>:
	<span class="k">case</span> <span class="n">BusLogic_LinkedCommandCompletedWithFlag</span>:
		<span class="n">HostStatus</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BusLogic_SCSISelectionTimeout</span>:
		<span class="n">HostStatus</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BusLogic_InvalidOutgoingMailboxActionCode</span>:
	<span class="k">case</span> <span class="n">BusLogic_InvalidCommandOperationCode</span>:
	<span class="k">case</span> <span class="n">BusLogic_InvalidCommandParameter</span>:
		<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;BusLogic Driver Protocol Error 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapterStatus</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BusLogic_DataUnderRun</span>:
	<span class="k">case</span> <span class="n">BusLogic_DataOverRun</span>:
	<span class="k">case</span> <span class="n">BusLogic_UnexpectedBusFree</span>:
	<span class="k">case</span> <span class="n">BusLogic_LinkedCCBhasInvalidLUN</span>:
	<span class="k">case</span> <span class="n">BusLogic_AutoRequestSenseFailed</span>:
	<span class="k">case</span> <span class="n">BusLogic_TaggedQueuingMessageRejected</span>:
	<span class="k">case</span> <span class="n">BusLogic_UnsupportedMessageReceived</span>:
	<span class="k">case</span> <span class="n">BusLogic_HostAdapterHardwareFailed</span>:
	<span class="k">case</span> <span class="n">BusLogic_TargetDeviceReconnectedImproperly</span>:
	<span class="k">case</span> <span class="n">BusLogic_AbortQueueGenerated</span>:
	<span class="k">case</span> <span class="n">BusLogic_HostAdapterSoftwareError</span>:
	<span class="k">case</span> <span class="n">BusLogic_HostAdapterHardwareTimeoutError</span>:
	<span class="k">case</span> <span class="n">BusLogic_SCSIParityErrorDetected</span>:
		<span class="n">HostStatus</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BusLogic_InvalidBusPhaseRequested</span>:
	<span class="k">case</span> <span class="n">BusLogic_TargetFailedResponseToATN</span>:
	<span class="k">case</span> <span class="n">BusLogic_HostAdapterAssertedRST</span>:
	<span class="k">case</span> <span class="n">BusLogic_OtherDeviceAssertedRST</span>:
	<span class="k">case</span> <span class="n">BusLogic_HostAdapterAssertedBusDeviceReset</span>:
		<span class="n">HostStatus</span> <span class="o">=</span> <span class="n">DID_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Unknown Host Adapter Status 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapterStatus</span><span class="p">);</span>
		<span class="n">HostStatus</span> <span class="o">=</span> <span class="n">DID_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">HostStatus</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">TargetDeviceStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ScanIncomingMailboxes scans the Incoming Mailboxes saving any</span>
<span class="cm">  Incoming Mailbox entries for completion processing.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_ScanIncomingMailboxes</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	   Scan through the Incoming Mailboxes in Strict Round Robin fashion, saving</span>
<span class="cm">	   any completed CCBs for further processing.  It is essential that for each</span>
<span class="cm">	   CCB and SCSI Command issued, command completion processing is performed</span>
<span class="cm">	   exactly once.  Therefore, only Incoming Mailboxes with completion code</span>
<span class="cm">	   Command Completed Without Error, Command Completed With Error, or Command</span>
<span class="cm">	   Aborted At Host Request are saved for completion processing.  When an</span>
<span class="cm">	   Incoming Mailbox has a completion code of Aborted Command Not Found, the</span>
<span class="cm">	   CCB had already completed or been aborted before the current Abort request</span>
<span class="cm">	   was processed, and so completion processing has already occurred and no</span>
<span class="cm">	   further action should be taken.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">BusLogic_IncomingMailbox</span> <span class="o">*</span><span class="n">NextIncomingMailbox</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">NextIncomingMailbox</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BusLogic_CompletionCode</span> <span class="n">CompletionCode</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">CompletionCode</span> <span class="o">=</span> <span class="n">NextIncomingMailbox</span><span class="o">-&gt;</span><span class="n">CompletionCode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BusLogic_IncomingMailboxFree</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   We are only allowed to do this because we limit our architectures we</span>
<span class="cm">		   run on to machines where bus_to_virt() actually works.  There *needs*</span>
<span class="cm">		   to be a dma_addr_to_virt() in the new PCI DMA mapping interface to</span>
<span class="cm">		   replace bus_to_virt() or else this code is going to become very</span>
<span class="cm">		   innefficient.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="p">)</span> <span class="n">Bus_to_Virtual</span><span class="p">(</span><span class="n">NextIncomingMailbox</span><span class="o">-&gt;</span><span class="n">CCB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CompletionCode</span> <span class="o">!=</span> <span class="n">BusLogic_AbortedCommandNotFound</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">BusLogic_CCB_Active</span> <span class="o">||</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">BusLogic_CCB_Reset</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				   Save the Completion Code for this CCB and queue the CCB</span>
<span class="cm">				   for completion processing.</span>
<span class="cm">				 */</span>
				<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">CompletionCode</span> <span class="o">=</span> <span class="n">CompletionCode</span><span class="p">;</span>
				<span class="n">BusLogic_QueueCompletedCCB</span><span class="p">(</span><span class="n">CCB</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				   If a CCB ever appears in an Incoming Mailbox and is not marked</span>
<span class="cm">				   as status Active or Reset, then there is most likely a bug in</span>
<span class="cm">				   the Host Adapter firmware.</span>
<span class="cm">				 */</span>
				<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Illegal CCB #%ld status %d in &quot;</span> <span class="s">&quot;Incoming Mailbox</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">NextIncomingMailbox</span><span class="o">-&gt;</span><span class="n">CompletionCode</span> <span class="o">=</span> <span class="n">BusLogic_IncomingMailboxFree</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextIncomingMailbox</span> <span class="o">&gt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastIncomingMailbox</span><span class="p">)</span>
			<span class="n">NextIncomingMailbox</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstIncomingMailbox</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">NextIncomingMailbox</span> <span class="o">=</span> <span class="n">NextIncomingMailbox</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ProcessCompletedCCBs iterates over the completed CCBs for Host</span>
<span class="cm">  Adapter setting the SCSI Command Result Codes, deallocating the CCBs, and</span>
<span class="cm">  calling the SCSI Subsystem Completion Routines.  The Host Adapter&#39;s Lock</span>
<span class="cm">  should already have been acquired by the caller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_ProcessCompletedCCBs</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ProcessCompletedCCBsActive</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ProcessCompletedCCBsActive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstCompletedCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstCompletedCCB</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstCompletedCCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstCompletedCCB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastCompletedCCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		   Process the Completed CCB.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Opcode</span> <span class="o">==</span> <span class="n">BusLogic_BusDeviceReset</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">TargetID</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
			<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Bus Device Reset CCB #%ld to Target &quot;</span> <span class="s">&quot;%d Completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
			<span class="n">BusLogic_IncrementErrorCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">BusDeviceResetsCompleted</span><span class="p">);</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TaggedQueuingActive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CommandsSinceReset</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastResetCompleted</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			   Place CCB back on the Host Adapter&#39;s free list.</span>
<span class="cm">			 */</span>
			<span class="n">BusLogic_DeallocateCCB</span><span class="p">(</span><span class="n">CCB</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c">				/* this needs to be redone different for new EH */</span>
<span class="c">			/*</span>
<span class="c">			   Bus Device Reset CCBs have the Command field non-NULL only when a</span>
<span class="c">			   Bus Device Reset was requested for a Command that did not have a</span>
<span class="c">			   currently active CCB in the Host Adapter (i.e., a Synchronous</span>
<span class="c">			   Bus Device Reset), and hence would not have its Completion Routine</span>
<span class="c">			   called otherwise.</span>
<span class="c">			 */</span>
<span class="c">			while (Command != NULL) {</span>
<span class="c">				struct scsi_cmnd *NextCommand = Command-&gt;reset_chain;</span>
<span class="c">				Command-&gt;reset_chain = NULL;</span>
<span class="c">				Command-&gt;result = DID_RESET &lt;&lt; 16;</span>
<span class="c">				Command-&gt;scsi_done(Command);</span>
<span class="c">				Command = NextCommand;</span>
<span class="c">			}</span>
<span class="cp">#endif</span>
			<span class="cm">/*</span>
<span class="cm">			   Iterate over the CCBs for this Host Adapter performing completion</span>
<span class="cm">			   processing for any CCBs marked as Reset for this Target.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">CCB</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">All_CCBs</span><span class="p">;</span> <span class="n">CCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">CCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">NextAll</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">BusLogic_CCB_Reset</span> <span class="o">&amp;&amp;</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">==</span> <span class="n">TargetID</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">Command</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">;</span>
					<span class="n">BusLogic_DeallocateCCB</span><span class="p">(</span><span class="n">CCB</span><span class="p">);</span>
					<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ActiveCommands</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
					<span class="n">Command</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">Command</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BusDeviceResetPendingCCB</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			   Translate the Completion Code, Host Adapter Status, and Target</span>
<span class="cm">			   Device Status into a SCSI Subsystem Result Code.</span>
<span class="cm">			 */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">CompletionCode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">BusLogic_IncomingMailboxFree</span>:
			<span class="k">case</span> <span class="n">BusLogic_AbortedCommandNotFound</span>:
			<span class="k">case</span> <span class="n">BusLogic_InvalidCCB</span>:
				<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;CCB #%ld to Target %d Impossible State</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BusLogic_CommandCompletedWithoutError</span>:
				<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span>
				    <span class="p">.</span><span class="n">CommandsCompleted</span><span class="o">++</span><span class="p">;</span>
				<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span>
				    <span class="p">.</span><span class="n">CommandSuccessfulFlag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">Command</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BusLogic_CommandAbortedAtHostRequest</span>:
				<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;CCB #%ld to Target %d Aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">);</span>
				<span class="n">BusLogic_IncrementErrorCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span>
							       <span class="p">.</span><span class="n">CommandAbortsCompleted</span><span class="p">);</span>
				<span class="n">Command</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BusLogic_CommandCompletedWithError</span>:
				<span class="n">Command</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">BusLogic_ComputeResultCode</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">HostAdapterStatus</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetDeviceStatus</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">HostAdapterStatus</span> <span class="o">!=</span> <span class="n">BusLogic_SCSISelectionTimeout</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span>
					    <span class="p">.</span><span class="n">CommandsCompleted</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceErrors</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
						<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;CCB #%ld Target %d: Result %X Host &quot;</span>
								<span class="s">&quot;Adapter Status %02X &quot;</span> <span class="s">&quot;Target Status %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">HostAdapterStatus</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetDeviceStatus</span><span class="p">);</span>
						<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;CDB   &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">CDB_Length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
							<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot; %02X&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
						<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
						<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;Sense &quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SenseDataLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
							<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot; %02X&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
						<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			   When an INQUIRY command completes normally, save the</span>
<span class="cm">			   CmdQue (Tagged Queuing Supported) and WBus16 (16 Bit</span>
<span class="cm">			   Wide Data Transfers Supported) bits.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span> <span class="o">&amp;&amp;</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">HostAdapterStatus</span> <span class="o">==</span> <span class="n">BusLogic_CommandCompletedNormally</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">BusLogic_TargetFlags</span> <span class="o">*</span><span class="n">TargetFlags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">];</span>
				<span class="k">struct</span> <span class="n">SCSI_Inquiry</span> <span class="o">*</span><span class="n">InquiryResult</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">SCSI_Inquiry</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
				<span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TargetExists</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TaggedQueuingSupported</span> <span class="o">=</span> <span class="n">InquiryResult</span><span class="o">-&gt;</span><span class="n">CmdQue</span><span class="p">;</span>
				<span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">WideTransfersSupported</span> <span class="o">=</span> <span class="n">InquiryResult</span><span class="o">-&gt;</span><span class="n">WBus16</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			   Place CCB back on the Host Adapter&#39;s free list.</span>
<span class="cm">			 */</span>
			<span class="n">BusLogic_DeallocateCCB</span><span class="p">(</span><span class="n">CCB</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			   Call the SCSI Command Completion Routine.</span>
<span class="cm">			 */</span>
			<span class="n">Command</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ProcessCompletedCCBsActive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_InterruptHandler handles hardware interrupts from BusLogic Host</span>
<span class="cm">  Adapters.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">BusLogic_InterruptHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">DeviceIdentifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">DeviceIdentifier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ProcessorFlags</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   Acquire exclusive access to Host Adapter.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">ProcessorFlags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Handle Interrupts appropriately for each Host Adapter type.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_MultiMasterHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">BusLogic_InterruptRegister</span> <span class="n">InterruptRegister</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		   Read the Host Adapter Interrupt Register.</span>
<span class="cm">		 */</span>
		<span class="n">InterruptRegister</span><span class="p">.</span><span class="n">All</span> <span class="o">=</span> <span class="n">BusLogic_ReadInterruptRegister</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">InterruptRegister</span><span class="p">.</span><span class="n">ir</span><span class="p">.</span><span class="n">InterruptValid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			   Acknowledge the interrupt and reset the Host Adapter</span>
<span class="cm">			   Interrupt Register.</span>
<span class="cm">			 */</span>
			<span class="n">BusLogic_InterruptReset</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			   Process valid External SCSI Bus Reset and Incoming Mailbox</span>
<span class="cm">			   Loaded Interrupts.  Command Complete Interrupts are noted,</span>
<span class="cm">			   and Outgoing Mailbox Available Interrupts are ignored, as</span>
<span class="cm">			   they are never enabled.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">InterruptRegister</span><span class="p">.</span><span class="n">ir</span><span class="p">.</span><span class="n">ExternalBusReset</span><span class="p">)</span>
				<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterExternalReset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">InterruptRegister</span><span class="p">.</span><span class="n">ir</span><span class="p">.</span><span class="n">IncomingMailboxLoaded</span><span class="p">)</span>
				<span class="n">BusLogic_ScanIncomingMailboxes</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">InterruptRegister</span><span class="p">.</span><span class="n">ir</span><span class="p">.</span><span class="n">CommandComplete</span><span class="p">)</span>
				<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterCommandCompleted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   Check if there is a pending interrupt for this Host Adapter.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FlashPoint_InterruptPending</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CardHandle</span><span class="p">))</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">FlashPoint_HandleInterrupt</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CardHandle</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FlashPoint_NormalInterrupt</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FlashPoint_ExternalBusReset</span>:
				<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterExternalReset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FlashPoint_InternalError</span>:
				<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Internal FlashPoint Error detected&quot;</span> <span class="s">&quot; - Resetting Host Adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
				<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterInternalError</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Process any completed CCBs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstCompletedCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">BusLogic_ProcessCompletedCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Reset the Host Adapter if requested.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterExternalReset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Resetting %s due to External SCSI Bus Reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">);</span>
		<span class="n">BusLogic_IncrementErrorCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExternalHostAdapterResets</span><span class="p">);</span>
		<span class="n">BusLogic_ResetHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterExternalReset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterInternalError</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Resetting %s due to Host Adapter Internal Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">);</span>
		<span class="n">BusLogic_IncrementErrorCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterInternalErrors</span><span class="p">);</span>
		<span class="n">BusLogic_ResetHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterInternalError</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Release exclusive access to Host Adapter.</span>
<span class="cm">	 */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">ProcessorFlags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_WriteOutgoingMailbox places CCB and Action Code into an Outgoing</span>
<span class="cm">  Mailbox for execution by Host Adapter.  The Host Adapter&#39;s Lock should</span>
<span class="cm">  already have been acquired by the caller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">BusLogic_WriteOutgoingMailbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span>
					     <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="k">enum</span> <span class="n">BusLogic_ActionCode</span> <span class="n">ActionCode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_OutgoingMailbox</span> <span class="o">*</span><span class="n">NextOutgoingMailbox</span><span class="p">;</span>
	<span class="n">NextOutgoingMailbox</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">NextOutgoingMailbox</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NextOutgoingMailbox</span><span class="o">-&gt;</span><span class="n">ActionCode</span> <span class="o">==</span> <span class="n">BusLogic_OutgoingMailboxFree</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">BusLogic_CCB_Active</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		   The CCB field must be written before the Action Code field since</span>
<span class="cm">		   the Host Adapter is operating asynchronously and the locking code</span>
<span class="cm">		   does not protect against simultaneous access by the Host Adapter.</span>
<span class="cm">		 */</span>
		<span class="n">NextOutgoingMailbox</span><span class="o">-&gt;</span><span class="n">CCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DMA_Handle</span><span class="p">;</span>
		<span class="n">NextOutgoingMailbox</span><span class="o">-&gt;</span><span class="n">ActionCode</span> <span class="o">=</span> <span class="n">ActionCode</span><span class="p">;</span>
		<span class="n">BusLogic_StartMailboxCommand</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextOutgoingMailbox</span> <span class="o">&gt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastOutgoingMailbox</span><span class="p">)</span>
			<span class="n">NextOutgoingMailbox</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirstOutgoingMailbox</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">NextOutgoingMailbox</span> <span class="o">=</span> <span class="n">NextOutgoingMailbox</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ActionCode</span> <span class="o">==</span> <span class="n">BusLogic_MailboxStartCommand</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ActiveCommands</span><span class="p">[</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Opcode</span> <span class="o">!=</span> <span class="n">BusLogic_BusDeviceReset</span><span class="p">)</span>
				<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandsAttempted</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Error Handling (EH) support */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BusLogic_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_TargetStatistics</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="n">BusLogic_IncrementErrorCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">HostAdapterResetsRequested</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">BusLogic_ResetHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_QueueCommand creates a CCB for Command and places it into an</span>
<span class="cm">  Outgoing Mailbox for execution by the associated Host Adapter.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BusLogic_QueueCommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">Command</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">CompletionRoutine</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_TargetFlags</span> <span class="o">*</span><span class="n">TargetFlags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">BusLogic_TargetStatistics</span> <span class="o">*</span><span class="n">TargetStatistics</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">CDB</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">CDB_Length</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TargetID</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">LogicalUnit</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">BufferLength</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">Count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   SCSI REQUEST_SENSE commands will be executed automatically by the Host</span>
<span class="cm">	   Adapter for any errors, so they should not be executed explicitly unless</span>
<span class="cm">	   the Sense Data is zero indicating that no error occurred.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span> <span class="o">&amp;&amp;</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Command</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">CompletionRoutine</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   Allocate a CCB from the Host Adapter&#39;s free list.  In the unlikely event</span>
<span class="cm">	   that there are none available and memory allocation fails, wait 1 second</span>
<span class="cm">	   and try again.  If that fails, the Host Adapter is probably hung so signal</span>
<span class="cm">	   an error as a Host Adapter Hard Reset should be initiated soon.</span>
<span class="cm">	 */</span>
	<span class="n">CCB</span> <span class="o">=</span> <span class="n">BusLogic_AllocateCCB</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">BusLogic_Delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">CCB</span> <span class="o">=</span> <span class="n">BusLogic_AllocateCCB</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Command</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">CompletionRoutine</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   Initialize the fields in the BusLogic Command Control Block (CCB).</span>
<span class="cm">	 */</span>
	<span class="n">Count</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">Count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Opcode</span> <span class="o">=</span> <span class="n">BusLogic_InitiatorCCB_ScatterGather</span><span class="p">;</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">Count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_ScatterGatherSegment</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_MultiMasterHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DMA_Handle</span> <span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">ScatterGatherList</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">CCB</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span> <span class="o">=</span> <span class="n">Virtual_to_32Bit_Virtual</span><span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">ScatterGatherList</span><span class="p">);</span>

		<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">Count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">ScatterGatherList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
				<span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">ScatterGatherList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
				<span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Opcode</span> <span class="o">=</span> <span class="n">BusLogic_InitiatorCCB</span><span class="p">;</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">BufferLength</span><span class="p">;</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">READ_6</span>:
	<span class="k">case</span> <span class="n">READ_10</span>:
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DataDirection</span> <span class="o">=</span> <span class="n">BusLogic_DataInLengthChecked</span><span class="p">;</span>
		<span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommands</span><span class="o">++</span><span class="p">;</span>
		<span class="n">BusLogic_IncrementByteCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesRead</span><span class="p">,</span> <span class="n">BufferLength</span><span class="p">);</span>
		<span class="n">BusLogic_IncrementSizeBucket</span><span class="p">(</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">,</span> <span class="n">BufferLength</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_6</span>:
	<span class="k">case</span> <span class="n">WRITE_10</span>:
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DataDirection</span> <span class="o">=</span> <span class="n">BusLogic_DataOutLengthChecked</span><span class="p">;</span>
		<span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommands</span><span class="o">++</span><span class="p">;</span>
		<span class="n">BusLogic_IncrementByteCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesWritten</span><span class="p">,</span> <span class="n">BufferLength</span><span class="p">);</span>
		<span class="n">BusLogic_IncrementSizeBucket</span><span class="p">(</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">,</span> <span class="n">BufferLength</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">DataDirection</span> <span class="o">=</span> <span class="n">BusLogic_UncheckedDataTransfer</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">CDB_Length</span> <span class="o">=</span> <span class="n">CDB_Length</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">HostAdapterStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetDeviceStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">TargetID</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span> <span class="o">=</span> <span class="n">LogicalUnit</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TagEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">LegacyTagEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   BusLogic recommends that after a Reset the first couple of commands that</span>
<span class="cm">	   are sent to a Target Device be sent in a non Tagged Queue fashion so that</span>
<span class="cm">	   the Host Adapter and Target Device can establish Synchronous and Wide</span>
<span class="cm">	   Transfer before Queue Tag messages can interfere with the Synchronous and</span>
<span class="cm">	   Wide Negotiation messages.  By waiting to enable Tagged Queuing until after</span>
<span class="cm">	   the first BusLogic_MaxTaggedQueueDepth commands have been queued, it is</span>
<span class="cm">	   assured that after a Reset any pending commands are requeued before Tagged</span>
<span class="cm">	   Queuing is enabled and that the Tagged Queuing message will not occur while</span>
<span class="cm">	   the partition table is being printed.  In addition, some devices do not</span>
<span class="cm">	   properly handle the transition from non-tagged to tagged commands, so it is</span>
<span class="cm">	   necessary to wait until there are no pending commands for a target device</span>
<span class="cm">	   before queuing tagged commands.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CommandsSinceReset</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span><span class="o">++</span> <span class="o">&gt;=</span>
	    <span class="n">BusLogic_MaxTaggedQueueDepth</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TaggedQueuingActive</span> <span class="o">&amp;&amp;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ActiveCommands</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TaggedQueuingSupported</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TaggedQueuingActive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">BusLogic_Notice</span><span class="p">(</span><span class="s">&quot;Tagged Queuing now active for Target %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TaggedQueuingActive</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">BusLogic_QueueTag</span> <span class="n">QueueTag</span> <span class="o">=</span> <span class="n">BusLogic_SimpleQueueTag</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		   When using Tagged Queuing with Simple Queue Tags, it appears that disk</span>
<span class="cm">		   drive controllers do not guarantee that a queued command will not</span>
<span class="cm">		   remain in a disconnected state indefinitely if commands that read or</span>
<span class="cm">		   write nearer the head position continue to arrive without interruption.</span>
<span class="cm">		   Therefore, for each Target Device this driver keeps track of the last</span>
<span class="cm">		   time either the queue was empty or an Ordered Queue Tag was issued.  If</span>
<span class="cm">		   more than 4 seconds (one fifth of the 20 second disk timeout) have</span>
<span class="cm">		   elapsed since this last sequence point, this command will be issued</span>
<span class="cm">		   with an Ordered Queue Tag rather than a Simple Queue Tag, which forces</span>
<span class="cm">		   the Target Device to complete all previously queued commands before</span>
<span class="cm">		   this command may be executed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ActiveCommands</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastSequencePoint</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastSequencePoint</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastSequencePoint</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">QueueTag</span> <span class="o">=</span> <span class="n">BusLogic_OrderedQueueTag</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExtendedLUNSupport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">TagEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">QueueTag</span> <span class="o">=</span> <span class="n">QueueTag</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">LegacyTagEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">LegacyQueueTag</span> <span class="o">=</span> <span class="n">QueueTag</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">,</span> <span class="n">CDB</span><span class="p">,</span> <span class="n">CDB_Length</span><span class="p">);</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SenseDataLength</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SenseDataPointer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SenseDataLength</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Command</span><span class="p">;</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">CompletionRoutine</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_MultiMasterHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   Place the CCB in an Outgoing Mailbox.  The higher levels of the SCSI</span>
<span class="cm">		   Subsystem should not attempt to queue more commands than can be placed</span>
<span class="cm">		   in Outgoing Mailboxes, so there should always be one free.  In the</span>
<span class="cm">		   unlikely event that there are none available, wait 1 second and try</span>
<span class="cm">		   again.  If that fails, the Host Adapter is probably hung so signal an</span>
<span class="cm">		   error as a Host Adapter Hard Reset should be initiated soon.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_WriteOutgoingMailbox</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_MailboxStartCommand</span><span class="p">,</span> <span class="n">CCB</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Unable to write Outgoing Mailbox - &quot;</span> <span class="s">&quot;Pausing for 1 second</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
			<span class="n">BusLogic_Delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BusLogic_WriteOutgoingMailbox</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_MailboxStartCommand</span><span class="p">,</span> <span class="n">CCB</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Still unable to write Outgoing Mailbox - &quot;</span> <span class="s">&quot;Host Adapter Dead?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
				<span class="n">BusLogic_DeallocateCCB</span><span class="p">(</span><span class="n">CCB</span><span class="p">);</span>
				<span class="n">Command</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">Command</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   Call the FlashPoint SCCB Manager to start execution of the CCB.</span>
<span class="cm">		 */</span>
		<span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span> <span class="n">BusLogic_CCB_Active</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ActiveCommands</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandsAttempted</span><span class="o">++</span><span class="p">;</span>
		<span class="n">FlashPoint_StartCCB</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CardHandle</span><span class="p">,</span> <span class="n">CCB</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		   The Command may have already completed and BusLogic_QueueCompletedCCB</span>
<span class="cm">		   been called, or it may still be pending.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">BusLogic_CCB_Completed</span><span class="p">)</span>
			<span class="n">BusLogic_ProcessCompletedCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">BusLogic_QueueCommand</span><span class="p">)</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c">  BusLogic_AbortCommand aborts Command if possible.</span>
<span class="c">*/</span>

<span class="err">static int BusLogic_AbortCommand(struct scsi_cmnd *Command)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">TargetID</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span><span class="p">;</span>
	<span class="n">BusLogic_IncrementErrorCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandAbortsRequested</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   Attempt to find an Active CCB for this Command.  If no Active CCB for this</span>
<span class="cm">	   Command is found, then no Abort is necessary.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">CCB</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">All_CCBs</span><span class="p">;</span> <span class="n">CCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">CCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">NextAll</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Command</span> <span class="o">==</span> <span class="n">Command</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Unable to Abort Command to Target %d - &quot;</span> <span class="s">&quot;No CCB Found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">BusLogic_CCB_Completed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Unable to Abort Command to Target %d - &quot;</span> <span class="s">&quot;CCB Completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">BusLogic_CCB_Reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Unable to Abort Command to Target %d - &quot;</span> <span class="s">&quot;CCB Reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_MultiMasterHostAdapterP</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   Attempt to Abort this CCB.  MultiMaster Firmware versions prior to 5.xx</span>
<span class="cm">		   do not generate Abort Tag messages, but only generate the non-tagged</span>
<span class="cm">		   Abort message.  Since non-tagged commands are not sent by the Host</span>
<span class="cm">		   Adapter until the queue of outstanding tagged commands has completed,</span>
<span class="cm">		   and the Abort message is treated as a non-tagged command, it is</span>
<span class="cm">		   effectively impossible to abort commands when Tagged Queuing is active.</span>
<span class="cm">		   Firmware version 5.xx does generate Abort Tag messages, so it is</span>
<span class="cm">		   possible to abort commands when Tagged Queuing is active.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TaggedQueuingActive</span> <span class="o">&amp;&amp;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="sc">&#39;5&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Unable to Abort CCB #%ld to Target %d - &quot;</span> <span class="s">&quot;Abort Tag Not Supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_WriteOutgoingMailbox</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">BusLogic_MailboxAbortCommand</span><span class="p">,</span> <span class="n">CCB</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Aborting CCB #%ld to Target %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
			<span class="n">BusLogic_IncrementErrorCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandAbortsAttempted</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Unable to Abort CCB #%ld to Target %d - &quot;</span> <span class="s">&quot;No Outgoing Mailboxes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   Call the FlashPoint SCCB Manager to abort execution of the CCB.</span>
<span class="cm">		 */</span>
		<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Aborting CCB #%ld to Target %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
		<span class="n">BusLogic_IncrementErrorCounter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandAbortsAttempted</span><span class="p">);</span>
		<span class="n">FlashPoint_AbortCCB</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">CardHandle</span><span class="p">,</span> <span class="n">CCB</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		   The Abort may have already been completed and</span>
<span class="cm">		   BusLogic_QueueCompletedCCB been called, or it</span>
<span class="cm">		   may still be pending.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">BusLogic_CCB_Completed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_ProcessCompletedCCBs</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm">  BusLogic_ResetHostAdapter resets Host Adapter if possible, marking all</span>
<span class="cm">  currently executing SCSI Commands as having been Reset.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BusLogic_ResetHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">HardReset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TargetID</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Attempt to Reset and Reinitialize the Host Adapter.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">BusLogic_HardwareResetHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HardReset</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">BusLogic_InitializeHostAdapter</span><span class="p">(</span><span class="n">HostAdapter</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;Resetting %s Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Deallocate all currently executing CCBs.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">CCB</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">All_CCBs</span><span class="p">;</span> <span class="n">CCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">CCB</span> <span class="o">=</span> <span class="n">CCB</span><span class="o">-&gt;</span><span class="n">NextAll</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CCB</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">BusLogic_CCB_Active</span><span class="p">)</span>
			<span class="n">BusLogic_DeallocateCCB</span><span class="p">(</span><span class="n">CCB</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait a few seconds between the Host Adapter Hard Reset which</span>
<span class="cm">	 * initiates a SCSI Bus Reset and issuing any SCSI Commands.  Some</span>
<span class="cm">	 * SCSI devices get confused if they receive SCSI Commands too soon</span>
<span class="cm">	 * after a SCSI Bus Reset.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HardReset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
		<span class="n">BusLogic_Delay</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">BusSettleTime</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">SCSI_Host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastResetAttempted</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">LastResetCompleted</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_BIOSDiskParameters returns the Heads/Sectors/Cylinders BIOS Disk</span>
<span class="cm">  Parameters for Disk.  The default disk geometry is 64 heads, 32 sectors, and</span>
<span class="cm">  the appropriate number of cylinders so as not to exceed drive capacity.  In</span>
<span class="cm">  order for disks equal to or larger than 1 GB to be addressable by the BIOS</span>
<span class="cm">  without exceeding the BIOS limitation of 1024 cylinders, Extended Translation</span>
<span class="cm">  may be enabled in AutoSCSI on FlashPoint Host Adapters and on &quot;W&quot; and &quot;C&quot;</span>
<span class="cm">  series MultiMaster Host Adapters, or by a dip switch setting on &quot;S&quot; and &quot;A&quot;</span>
<span class="cm">  series MultiMaster Host Adapters.  With Extended Translation enabled, drives</span>
<span class="cm">  between 1 GB inclusive and 2 GB exclusive are given a disk geometry of 128</span>
<span class="cm">  heads and 32 sectors, and drives above 2 GB inclusive are given a disk</span>
<span class="cm">  geometry of 255 heads and 63 sectors.  However, if the BIOS detects that the</span>
<span class="cm">  Extended Translation setting does not match the geometry in the partition</span>
<span class="cm">  table, then the translation inferred from the partition table will be used by</span>
<span class="cm">  the BIOS, and a warning may be displayed.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BusLogic_BIOSDiskParameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">Device</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">Parameters</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BIOS_DiskParameters</span> <span class="o">*</span><span class="n">DiskParameters</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BIOS_DiskParameters</span> <span class="o">*</span><span class="p">)</span> <span class="n">Parameters</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExtendedTranslationEnabled</span> <span class="o">&amp;&amp;</span> <span class="n">capacity</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="cm">/* 1 GB in 512 byte sectors */</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="cm">/* 2 GB in 512 byte sectors */</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">capacity</span> <span class="o">/</span> <span class="p">(</span><span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span> <span class="o">*</span> <span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">scsi_bios_ptable</span><span class="p">(</span><span class="n">Device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   If the boot sector partition table flag is valid, search for a partition</span>
<span class="cm">	   table entry whose end_head matches one of the standard BusLogic geometry</span>
<span class="cm">	   translations (64/32, 128/32, or 255/63).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">64</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xAA55</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">partition</span> <span class="o">*</span><span class="n">FirstPartitionEntry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">partition</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">partition</span> <span class="o">*</span><span class="n">PartitionEntry</span> <span class="o">=</span> <span class="n">FirstPartitionEntry</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">SavedCylinders</span> <span class="o">=</span> <span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Cylinders</span><span class="p">,</span> <span class="n">PartitionNumber</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">PartitionEntryEndHead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PartitionEntryEndSector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">PartitionNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">PartitionNumber</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">PartitionNumber</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PartitionEntryEndHead</span> <span class="o">=</span> <span class="n">PartitionEntry</span><span class="o">-&gt;</span><span class="n">end_head</span><span class="p">;</span>
			<span class="n">PartitionEntryEndSector</span> <span class="o">=</span> <span class="n">PartitionEntry</span><span class="o">-&gt;</span><span class="n">end_sector</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PartitionEntryEndHead</span> <span class="o">==</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
				<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PartitionEntryEndHead</span> <span class="o">==</span> <span class="mi">128</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
				<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PartitionEntryEndHead</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
				<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">PartitionEntry</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PartitionNumber</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PartitionEntryEndHead</span> <span class="o">=</span> <span class="n">FirstPartitionEntry</span><span class="o">-&gt;</span><span class="n">end_head</span><span class="p">;</span>
			<span class="n">PartitionEntryEndSector</span> <span class="o">=</span> <span class="n">FirstPartitionEntry</span><span class="o">-&gt;</span><span class="n">end_sector</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">capacity</span> <span class="o">/</span> <span class="p">(</span><span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span> <span class="o">*</span> <span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PartitionNumber</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">PartitionEntryEndSector</span> <span class="o">==</span> <span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Cylinders</span> <span class="o">!=</span> <span class="n">SavedCylinders</span><span class="p">)</span>
				<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Adopting Geometry %d/%d from Partition Table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span><span class="p">,</span> <span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PartitionEntryEndHead</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">PartitionEntryEndSector</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;Warning: Partition Table appears to &quot;</span> <span class="s">&quot;have Geometry %d/%d which is</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">PartitionEntryEndHead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PartitionEntryEndSector</span><span class="p">);</span>
			<span class="n">BusLogic_Warning</span><span class="p">(</span><span class="s">&quot;not compatible with current BusLogic &quot;</span> <span class="s">&quot;Host Adapter Geometry %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Heads</span><span class="p">,</span> <span class="n">DiskParameters</span><span class="o">-&gt;</span><span class="n">Sectors</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BugLogic_ProcDirectoryInfo implements /proc/scsi/BusLogic/&lt;N&gt;.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">BusLogic_ProcDirectoryInfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ProcBuffer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">StartPointer</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">Offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">BytesAvailable</span><span class="p">,</span> <span class="kt">int</span> <span class="n">WriteFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BusLogic_TargetStatistics</span> <span class="o">*</span><span class="n">TargetStatistics</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">Length</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">Buffer</span><span class="p">;</span>

	<span class="n">TargetStatistics</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetStatistics</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WriteFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExternalHostAdapterResets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterInternalErrors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">TargetStatistics</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BusLogic_MaxTargetDevices</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_TargetStatistics</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Buffer</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MessageBuffer</span><span class="p">;</span>
	<span class="n">Length</span> <span class="o">=</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MessageBufferLength</span><span class="p">;</span>
	<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">\</span>
<span class="s">Current Driver Queue Depth:	%d</span><span class="se">\n</span><span class="s">\</span>
<span class="s">Currently Allocated CCBs:	%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">AllocatedCCBs</span><span class="p">);</span>
	<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">\</span>
<span class="s">			   DATA TRANSFER STATISTICS</span><span class="se">\n</span><span class="s">\</span>
<span class="se">\n</span><span class="s">\</span>
<span class="s">Target	Tagged Queuing	Queue Depth  Active  Attempted	Completed</span><span class="se">\n</span><span class="s">\</span>
<span class="s">======	==============	===========  ======  =========	=========</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BusLogic_TargetFlags</span> <span class="o">*</span><span class="n">TargetFlags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TargetExists</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;  %2d	%s&quot;</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="p">(</span><span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TaggedQueuingSupported</span> <span class="o">?</span> <span class="p">(</span><span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TaggedQueuingActive</span> <span class="o">?</span> <span class="s">&quot;    Active&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">)</span>
																				    <span class="o">?</span> <span class="s">&quot;  Permitted&quot;</span> <span class="o">:</span> <span class="s">&quot;   Disabled&quot;</span><span class="p">))</span>
									  <span class="o">:</span> <span class="s">&quot;Not Supported&quot;</span><span class="p">));</span>
		<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span>
				  <span class="s">&quot;	    %3d       %3u    %9u	%9u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">],</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ActiveCommands</span><span class="p">[</span><span class="n">TargetID</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandsAttempted</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandsCompleted</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">\</span>
<span class="s">Target  Read Commands  Write Commands   Total Bytes Read    Total Bytes Written</span><span class="se">\n</span><span class="s">\</span>
<span class="s">======  =============  ==============  ===================  ===================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BusLogic_TargetFlags</span> <span class="o">*</span><span class="n">TargetFlags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TargetExists</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;  %2d	  %9u	 %9u&quot;</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommands</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommands</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesRead</span><span class="p">.</span><span class="n">Billions</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;     %9u%09u&quot;</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesRead</span><span class="p">.</span><span class="n">Billions</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesRead</span><span class="p">.</span><span class="n">Units</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;		%9u&quot;</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesRead</span><span class="p">.</span><span class="n">Units</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesWritten</span><span class="p">.</span><span class="n">Billions</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;   %9u%09u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesWritten</span><span class="p">.</span><span class="n">Billions</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesWritten</span><span class="p">.</span><span class="n">Units</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;	     %9u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">TotalBytesWritten</span><span class="p">.</span><span class="n">Units</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">\</span>
<span class="s">Target  Command    0-1KB      1-2KB      2-4KB      4-8KB     8-16KB</span><span class="se">\n</span><span class="s">\</span>
<span class="s">======  =======  =========  =========  =========  =========  =========</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BusLogic_TargetFlags</span> <span class="o">*</span><span class="n">TargetFlags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TargetExists</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">Length</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span>
			    <span class="s">&quot;  %2d	 Read	 %9u  %9u  %9u  %9u  %9u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			    <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			    <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">Length</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span>
			    <span class="s">&quot;  %2d	 Write	 %9u  %9u  %9u  %9u  %9u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			    <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			    <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">\</span>
<span class="s">Target  Command   16-32KB    32-64KB   64-128KB   128-256KB   256KB+</span><span class="se">\n</span><span class="s">\</span>
<span class="s">======  =======  =========  =========  =========  =========  =========</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BusLogic_TargetFlags</span> <span class="o">*</span><span class="n">TargetFlags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TargetExists</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">Length</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span>
			    <span class="s">&quot;  %2d	 Read	 %9u  %9u  %9u  %9u  %9u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			    <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			    <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">ReadCommandSizeBuckets</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
		<span class="n">Length</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span>
			    <span class="s">&quot;  %2d	 Write	 %9u  %9u  %9u  %9u  %9u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			    <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			    <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">WriteCommandSizeBuckets</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">\</span>
<span class="s">			   ERROR RECOVERY STATISTICS</span><span class="se">\n</span><span class="s">\</span>
<span class="se">\n</span><span class="s">\</span>
<span class="s">	  Command Aborts      Bus Device Resets	  Host Adapter Resets</span><span class="se">\n</span><span class="s">\</span>
<span class="s">Target	Requested Completed  Requested Completed  Requested Completed</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  ID	</span><span class="se">\\\\\\\\</span><span class="s"> Attempted ////  </span><span class="se">\\\\\\\\</span><span class="s"> Attempted ////  </span><span class="se">\\\\\\\\</span><span class="s"> Attempted ////</span><span class="se">\n</span><span class="s">\</span>
<span class="s">======	 ===== ===== =====    ===== ===== =====	   ===== ===== =====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BusLogic_TargetFlags</span> <span class="o">*</span><span class="n">TargetFlags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">TargetFlags</span><span class="p">[</span><span class="n">TargetID</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TargetFlags</span><span class="o">-&gt;</span><span class="n">TargetExists</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;\</span>
<span class="s">  %2d	 %5d %5d %5d    %5d %5d %5d	   %5d %5d %5d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandAbortsRequested</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandAbortsAttempted</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">CommandAbortsCompleted</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">BusDeviceResetsRequested</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">BusDeviceResetsAttempted</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">BusDeviceResetsCompleted</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">HostAdapterResetsRequested</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">HostAdapterResetsAttempted</span><span class="p">,</span> <span class="n">TargetStatistics</span><span class="p">[</span><span class="n">TargetID</span><span class="p">].</span><span class="n">HostAdapterResetsCompleted</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">External Host Adapter Resets: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">ExternalHostAdapterResets</span><span class="p">);</span>
	<span class="n">Length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="p">],</span> <span class="s">&quot;Host Adapter Internal Errors: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterInternalErrors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Length</span> <span class="o">&gt;=</span> <span class="n">BusLogic_MessageBufferSize</span><span class="p">)</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;Message Buffer length %d exceeds size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">,</span> <span class="n">Length</span><span class="p">,</span> <span class="n">BusLogic_MessageBufferSize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">Length</span> <span class="o">-=</span> <span class="n">Offset</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Length</span> <span class="o">&gt;=</span> <span class="n">BytesAvailable</span><span class="p">)</span>
		<span class="n">Length</span> <span class="o">=</span> <span class="n">BytesAvailable</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ProcBuffer</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MessageBuffer</span> <span class="o">+</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">Length</span><span class="p">);</span>
	<span class="o">*</span><span class="n">StartPointer</span> <span class="o">=</span> <span class="n">ProcBuffer</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">Length</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_Message prints Driver Messages.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">BusLogic_Message</span><span class="p">(</span><span class="k">enum</span> <span class="n">BusLogic_MessageLevel</span> <span class="n">MessageLevel</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Format</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">HostAdapter</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">Buffer</span><span class="p">[</span><span class="n">BusLogic_LineBufferSize</span><span class="p">];</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">BeginningOfLine</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">Arguments</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">HostAdapter</span><span class="p">);</span>
	<span class="n">Length</span> <span class="o">=</span> <span class="n">vsprintf</span><span class="p">(</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">Format</span><span class="p">,</span> <span class="n">Arguments</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">Arguments</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MessageLevel</span> <span class="o">==</span> <span class="n">BusLogic_AnnounceLevel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">AnnouncementLines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MessageBuffer</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MessageBufferLength</span><span class="p">],</span> <span class="n">Buffer</span><span class="p">);</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MessageBufferLength</span> <span class="o">+=</span> <span class="n">Length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">AnnouncementLines</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sscsi: %s&quot;</span><span class="p">,</span> <span class="n">BusLogic_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span> <span class="n">Buffer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MessageLevel</span> <span class="o">==</span> <span class="n">BusLogic_InfoLevel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MessageBuffer</span><span class="p">[</span><span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MessageBufferLength</span><span class="p">],</span> <span class="n">Buffer</span><span class="p">);</span>
		<span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">MessageBufferLength</span> <span class="o">+=</span> <span class="n">Length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BeginningOfLine</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">Length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sscsi%d: %s&quot;</span><span class="p">,</span> <span class="n">BusLogic_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostNumber</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BeginningOfLine</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">HostAdapter</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostAdapterInitialized</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sscsi%d: %s&quot;</span><span class="p">,</span> <span class="n">BusLogic_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span> <span class="n">HostAdapter</span><span class="o">-&gt;</span><span class="n">HostNumber</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">BusLogic_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span> <span class="n">Buffer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BeginningOfLine</span> <span class="o">=</span> <span class="p">(</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ParseKeyword parses an individual option keyword.  It returns true</span>
<span class="cm">  and updates the pointer if the keyword is recognized and false otherwise.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">BusLogic_ParseKeyword</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">StringPointer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Keyword</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">Pointer</span> <span class="o">=</span> <span class="o">*</span><span class="n">StringPointer</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">Keyword</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">StringChar</span> <span class="o">=</span> <span class="o">*</span><span class="n">Pointer</span><span class="o">++</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">KeywordChar</span> <span class="o">=</span> <span class="o">*</span><span class="n">Keyword</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StringChar</span> <span class="o">&gt;=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">StringChar</span> <span class="o">&lt;=</span> <span class="sc">&#39;Z&#39;</span><span class="p">)</span>
			<span class="n">StringChar</span> <span class="o">+=</span> <span class="sc">&#39;a&#39;</span> <span class="o">-</span> <span class="sc">&#39;Z&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">KeywordChar</span> <span class="o">&gt;=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">KeywordChar</span> <span class="o">&lt;=</span> <span class="sc">&#39;Z&#39;</span><span class="p">)</span>
			<span class="n">KeywordChar</span> <span class="o">+=</span> <span class="sc">&#39;a&#39;</span> <span class="o">-</span> <span class="sc">&#39;Z&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StringChar</span> <span class="o">!=</span> <span class="n">KeywordChar</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">StringPointer</span> <span class="o">=</span> <span class="n">Pointer</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  BusLogic_ParseDriverOptions handles processing of BusLogic Driver Options</span>
<span class="cm">  specifications.</span>

<span class="cm">  BusLogic Driver Options may be specified either via the Linux Kernel Command</span>
<span class="cm">  Line or via the Loadable Kernel Module Installation Facility.  Driver Options</span>
<span class="cm">  for multiple host adapters may be specified either by separating the option</span>
<span class="cm">  strings by a semicolon, or by specifying multiple &quot;BusLogic=&quot; strings on the</span>
<span class="cm">  command line.  Individual option specifications for a single host adapter are</span>
<span class="cm">  separated by commas.  The Probing and Debugging Options apply to all host</span>
<span class="cm">  adapters whereas the remaining options apply individually only to the</span>
<span class="cm">  selected host adapter.</span>

<span class="cm">  The BusLogic Driver Probing Options are described in</span>
<span class="cm">  &lt;file:Documentation/scsi/BusLogic.txt&gt;.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">BusLogic_ParseDriverOptions</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">OptionsString</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BusLogic_DriverOptions</span> <span class="o">*</span><span class="n">DriverOptions</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BusLogic_DriverOptions</span><span class="p">[</span><span class="n">BusLogic_DriverOptionsCount</span><span class="o">++</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">TargetID</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">DriverOptions</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BusLogic_DriverOptions</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">OptionsString</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">OptionsString</span> <span class="o">!=</span> <span class="sc">&#39;;&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Probing Options. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;IO:&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">IO_Address</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">OptionsString</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">LimitedProbeISA</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">IO_Address</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x330</span>:
					<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe330</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x334</span>:
					<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe334</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x230</span>:
					<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe230</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x234</span>:
					<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe234</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x130</span>:
					<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe130</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x134</span>:
					<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">Probe134</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Invalid Driver Options &quot;</span> <span class="s">&quot;(invalid I/O Address 0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">IO_Address</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;NoProbeISA&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">NoProbeISA</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;NoProbePCI&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">NoProbePCI</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;NoProbe&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">NoProbe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;NoSortPCI&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">NoSortPCI</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;MultiMasterFirst&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">MultiMasterFirst</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;FlashPointFirst&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_ProbeOptions</span><span class="p">.</span><span class="n">FlashPointFirst</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* Tagged Queuing Options. */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;QueueDepth:[&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;QD:[&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">BusLogic_MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">QueueDepth</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">OptionsString</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">QueueDepth</span> <span class="o">&gt;</span> <span class="n">BusLogic_MaxTaggedQueueDepth</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Invalid Driver Options &quot;</span> <span class="s">&quot;(invalid Queue Depth %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">QueueDepth</span><span class="p">);</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueueDepth</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">OptionsString</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
						<span class="n">OptionsString</span><span class="o">++</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">OptionsString</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Invalid Driver Options &quot;</span> <span class="s">&quot;(&#39;,&#39; or &#39;]&#39; expected at &#39;%s&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OptionsString</span><span class="p">);</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">OptionsString</span> <span class="o">!=</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Invalid Driver Options &quot;</span> <span class="s">&quot;(&#39;]&#39; expected at &#39;%s&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OptionsString</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">OptionsString</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;QueueDepth:&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;QD:&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">QueueDepth</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">OptionsString</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">QueueDepth</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">QueueDepth</span> <span class="o">&gt;</span> <span class="n">BusLogic_MaxTaggedQueueDepth</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Invalid Driver Options &quot;</span> <span class="s">&quot;(invalid Queue Depth %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">QueueDepth</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">CommonQueueDepth</span> <span class="o">=</span> <span class="n">QueueDepth</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">BusLogic_MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
					<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueueDepth</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;TaggedQueuing:&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;TQ:&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;Default&quot;</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
					<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermittedMask</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;Enable&quot;</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
					<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermittedMask</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;Disable&quot;</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
					<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermittedMask</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">TargetBit</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TargetBit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">BusLogic_MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">,</span> <span class="n">TargetBit</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
						<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">OptionsString</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="sc">&#39;Y&#39;</span>:
							<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">|=</span> <span class="n">TargetBit</span><span class="p">;</span>
							<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermittedMask</span> <span class="o">|=</span> <span class="n">TargetBit</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="k">case</span> <span class="sc">&#39;N&#39;</span>:
							<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TargetBit</span><span class="p">;</span>
							<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermittedMask</span> <span class="o">|=</span> <span class="n">TargetBit</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="k">case</span> <span class="sc">&#39;X&#39;</span>:
							<span class="k">break</span><span class="p">;</span>
						<span class="nl">default:</span>
							<span class="n">OptionsString</span><span class="o">--</span><span class="p">;</span>
							<span class="n">TargetID</span> <span class="o">=</span> <span class="n">BusLogic_MaxTargetDevices</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* Miscellaneous Options. */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;BusSettleTime:&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;BST:&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">BusSettleTime</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">OptionsString</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">BusSettleTime</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Invalid Driver Options &quot;</span> <span class="s">&quot;(invalid Bus Settle Time %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">BusSettleTime</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">BusSettleTime</span> <span class="o">=</span> <span class="n">BusSettleTime</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;InhibitTargetInquiry&quot;</span><span class="p">))</span>
				<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">LocalOptions</span><span class="p">.</span><span class="n">InhibitTargetInquiry</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* Debugging Options. */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;TraceProbe&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceProbe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;TraceHardwareReset&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceHardwareReset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;TraceConfiguration&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceConfiguration</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;TraceErrors&quot;</span><span class="p">))</span>
				<span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceErrors</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BusLogic_ParseKeyword</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsString</span><span class="p">,</span> <span class="s">&quot;Debug&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceProbe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceHardwareReset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceConfiguration</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">BusLogic_GlobalOptions</span><span class="p">.</span><span class="n">TraceErrors</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">OptionsString</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
				<span class="n">OptionsString</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">OptionsString</span> <span class="o">!=</span> <span class="sc">&#39;;&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">OptionsString</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Unexpected Driver Option &#39;%s&#39; &quot;</span> <span class="s">&quot;ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OptionsString</span><span class="p">);</span>
				<span class="o">*</span><span class="n">OptionsString</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">BusLogic_DriverOptionsCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">BusLogic_ProbeInfoCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">BusLogic_DriverOptionsCount</span> <span class="o">==</span> <span class="n">BusLogic_ProbeInfoCount</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Invalid Driver Options &quot;</span> <span class="s">&quot;(all or no I/O Addresses must be specified)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		   Tagged Queuing is disabled when the Queue Depth is 1 since queuing</span>
<span class="cm">		   multiple commands is not possible.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">BusLogic_MaxTargetDevices</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">QueueDepth</span><span class="p">[</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">TargetBit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TargetID</span><span class="p">;</span>
				<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermitted</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TargetBit</span><span class="p">;</span>
				<span class="n">DriverOptions</span><span class="o">-&gt;</span><span class="n">TaggedQueuingPermittedMask</span> <span class="o">|=</span> <span class="n">TargetBit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">OptionsString</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span><span class="p">)</span>
			<span class="n">OptionsString</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">OptionsString</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Get it all started</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">Bus_Logic_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span> <span class="o">=</span> <span class="s">&quot;BusLogic&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span> <span class="o">=</span> <span class="n">BusLogic_ProcDirectoryInfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BusLogic&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">BusLogic_DriverInfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span> <span class="o">=</span> <span class="n">BusLogic_QueueCommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span> <span class="o">=</span> <span class="n">BusLogic_SlaveConfigure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span> <span class="o">=</span> <span class="n">BusLogic_BIOSDiskParameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span> <span class="o">=</span> <span class="n">BusLogic_host_reset</span><span class="p">,</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	.eh_abort_handler = BusLogic_AbortCommand,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">unchecked_isa_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">  BusLogic_Setup handles processing of Kernel Command Line Arguments.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">BusLogic_Setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BusLogic_Error</span><span class="p">(</span><span class="s">&quot;BusLogic: Obsolete Command Line Entry &quot;</span> <span class="s">&quot;Format Ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BusLogic_ParseDriverOptions</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Exit function.  Deletes all hosts associated with this driver.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">BusLogic_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BusLogic_HostAdapter</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BusLogic_host_list</span><span class="p">,</span> <span class="n">host_list</span><span class="p">)</span>
		<span class="n">BusLogic_ReleaseHostAdapter</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;BusLogic=&quot;</span><span class="p">,</span> <span class="n">BusLogic_Setup</span><span class="p">);</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">BusLogic_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_BUSLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BUSLOGIC_MULTIMASTER</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_BUSLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BUSLOGIC_MULTIMASTER_NC</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_BUSLOGIC</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BUSLOGIC_FLASHPOINT</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">BusLogic_pci_tbl</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">BusLogic_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">BusLogic_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
